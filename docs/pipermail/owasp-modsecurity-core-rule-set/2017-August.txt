From christian.folini at netnea.com  Fri Aug  4 12:30:51 2017
From: christian.folini at netnea.com (Christian Folini)
Date: Fri, 4 Aug 2017 14:30:51 +0200
Subject: [Owasp-modsecurity-core-rule-set] Up next Monday: Monthly Project
	Chat
Message-ID: <20170804123051.jauictew2vofucvr@leander>

Hi there,

Next Monday, August 7, we'll do our regular Core Rule Set project chat.
20:30 CET (14:30 EDT, 18:30 GMT)
on Freenode IRC, channel #modsecurity

It's holiday season (I'm currently in Finland), but we'll see who
will have time. There are quite a few PRs we need to cover and then
the launch of the new website... Work is not running out.

Cheers,

Christian

-- 
https://www.feistyduck.com/books/modsecurity-handbook/
mailto:christian.folini at netnea.com
twitter: @ChrFolini

From christian.folini at netnea.com  Sun Aug 13 20:22:56 2017
From: christian.folini at netnea.com (Christian Folini)
Date: Sun, 13 Aug 2017 22:22:56 +0200
Subject: [Owasp-modsecurity-core-rule-set] News from the Core Rule Set
	(2017-08-13)
Message-ID: <20170813202256.vk6jcheijcevbuyw@leander>

Dear all,

This is the CRS newsletter covering the period from July until today.

What has happened during the last few weeks:

- We held our community chat last Monday. We have been eight people
  including Manuel Spartan who participated on the development
  of the paranoia mode.
  The big topic was disassembly of the optimized regular expressions
  that are very hard to read. See below for details.
  The next community chats will be held on the following dates:
  - Sep 4, 2017, 20:30 CEST (14:30 EST, 19:30 GMT)
  - Oct 2, 2017, 20:30 CEST
  - Nov 6, 2017, 20:30 CET
  - Dec 4, 2017, 20:30 CET

- The OWASP ModSecurity Core Rule Set 3.0.2 is still the latest stable
  version. We talked about an eventual 3.1 version in the chat, but we
  agreed that we are far from that and that we want to add a substantial
  set of new features to make transition worthwhile for users.

- ModSecurity 2.9.2 came out on July 19. Among several bugfixes, it
  brings an updated libinjection support that helped CRS close a
  few holes. See this CRS issue for an example:
  https://github.com/SpiderLabs/owasp-modsecurity-crs/issues/797
  We recommend all users to update to 2.9.2. AFAICS there are no
  backported packages for the major distros yet, so this is only 
  viable for those users compiling themselves.

- Summer holidays are taking their toll and we are quite behind with the
  inclusion of pull requests. This brings us to a very high number
  of 10 open pull requests. Most of them have been reviewed, but
  they have not yet been incorporated.

- A PR that is still in preparation, but almost done is a big disassembly 
  of over 2 dozens of the  complex regular expressions that are so hard 
  to read in the CRS.
  Look at this beauty for example:
  https://github.com/SpiderLabs/owasp-modsecurity-crs/blob/v3.0/master/rules/REQUEST-942-APPLICATION-ATTACK-SQLI.conf#L589
  The point is these rules are very old, they are machine generated
  with the help of an ancient perl module optimizing regular expressions
  for performance and the sources / original regular expressions are
  long gone. To add to the problem, some of the rules have been
  edited by hand afterwards so there is just no telling what they
  really do. It takes a rule archaeologist to reconstruct the original
  sources. Franziska B?hler took over this task and it seems she got 
  to the  bottom of all the complex SQLi regexes within a couple of 
  weeks.
  The idea is now a PR to add the sources to util/regexp-assemble.
  This would then allow us to consolidate / optimize the regular
  expressions.

- Believe it or not: We got the new logo for the project. As we kind
  of expected it took longer than expected, but it's done now and
  it sure looks cool. Expect a separate announcement very soon.
  This also holds true for the website which is ready and only waits
  for the logo for the real announcement.

- OWASP London invited me to present my CRS3 intro presentation that
  I held in Belfast for AppSecEU. This took place on July 27 and
  according to the audience it was a big success. Here are a few
  photos taken after the presentation when I signed the new 
  ModSecurity Handbook and then in the pub nearby:

  https://twitter.com/ChrFolini/status/892686195133739009
  https://twitter.com/OWASPLondon/status/890693408683163648

Upcoming Stuff

- OWASP Switzerland is also hosting CRS introduction talk.
  This is happening on Wednesday, August 16 in Zurich at 6pm.
  Here are the details:
  https://www.meetup.com/de-DE/OWASPSwitzerland/events/241771446/

- There are still a few seats available for the Apache / ModSecurity / CRS
  courses in October. One in London, one in Zurich.
  https://www.feistyduck.com/training/modsecurity-training-course

- There is now a plan to run a real poll where CRS users can vote on
  feature requests. There are a ton of feature requests recorded on
  github, but we really are a bit at a loss on what people are really
  interested in. Stay tuned to learn more about this.

I have been on a holiday for two weeks and it is likely, I overlooked
things on the mailinglists and on github. Feel free to speak up and
respond to this message highlighting the omissions.

Cheers,

Christian


-- 
The ability to quote is a serviceable substitute for wit.
-- W. Somerset Maugham 

From kirk at pageofwords.com  Sun Aug 13 22:03:15 2017
From: kirk at pageofwords.com (Kirk Jackson)
Date: Mon, 14 Aug 2017 10:03:15 +1200
Subject: [Owasp-modsecurity-core-rule-set] Run core rule set on just one
	page / parameter
Message-ID: <CAAO0q_Gv+TXfX=V-FFTCkJ+m3TndoRPNGOFA=wRfVQXs3JLVuA@mail.gmail.com>

Hi,

I'd like to run the SQLi checks on only the one parameter on my site that
is vulnerable to those attacks.

I was wondering if there's a pattern to do this, or if I need to copy the
rules from REQUEST-942-APPLICATION-ATTACK-SQLI.conf into my own file, and
change the variables to my ARGS:ParamName?

I tried doing this, to disable the rules, and then re-enable for just my
param, but that didn't work:

SecRuleUpdateTargetByID 942000-942999 "!REQUEST_COOKIES"
SecRuleUpdateTargetByID 942000-942999 "!REQUEST_COOKIES_NAMES"
SecRuleUpdateTargetByID 942000-942999 "!ARGS_NAMES"
SecRuleUpdateTargetByID 942000-942999 "!ARGS"
SecRuleUpdateTargetByID 942000-942999 "!XML"

SecRuleUpdateTargetByID 942000-942999 "ARGS:SearchTerm"

Many thanks!

Kirk
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20170814/2e2017d5/attachment.html>

From arthurjohnston at verizon.net  Mon Aug 14 01:25:44 2017
From: arthurjohnston at verizon.net (Arthur E. Johnston)
Date: Sun, 13 Aug 2017 18:25:44 -0700
Subject: [Owasp-modsecurity-core-rule-set] Typo in
	"REQUEST-910-IP-REPUTATION.CONF"
Message-ID: <000001d3149c$40e77280$c2b65780$@verizon.net>

Excuse the interruption.  I am just reviewing the rules to better understand
their functions.  Honestly, I am lost, but learning.

 

While browsing rule "REQUEST-910-IP-REPUTATION.CON", I discovered a hashtag
'#' on line 92, effectively commenting out the beginning of the rule and
causing it to be ineffective.  

 

Or am I mistaken?

 

 

#SecRule TX:REAL_IP "@ipMatchFromFile ip_blacklist.data" \

  "msg:'Client IP in Trustwave SpiderLabs IP Reputation Blacklist.',\

 

Arthur Johnston

 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20170813/6d198bb8/attachment.html>

From oelnaggar04 at gmail.com  Mon Aug 14 01:34:14 2017
From: oelnaggar04 at gmail.com (Osama Elnaggar)
Date: Mon, 14 Aug 2017 03:34:14 +0200
Subject: [Owasp-modsecurity-core-rule-set] Typo in
	"REQUEST-910-IP-REPUTATION.CONF"
In-Reply-To: <000001d3149c$40e77280$c2b65780$@verizon.net>
References: <000001d3149c$40e77280$c2b65780$@verizon.net>
Message-ID: <CACva_gEOSTmQb=sQp+_Fm3Bn2_9bmtvSgxnC1Pd_USzDB2MrjQ@mail.gmail.com>

Yes.  The rule is commented out because the blacklist mentioned is not
provided / is commercial.  It is part of TrustWave?s commercial ruleset -
https://www.modsecurity.org/commercial-rules.html

-- 
Osama Elnaggar

On August 14, 2017 at 11:27:28 AM, Arthur E. Johnston (
arthurjohnston at verizon.net) wrote:

Excuse the interruption.  I am just reviewing the rules to better
understand their functions.  Honestly, I am lost, but learning.



While browsing rule ?REQUEST-910-IP-REPUTATION.CON?, I discovered a hashtag
?#? on line 92, effectively commenting out the beginning of the rule and
causing it to be ineffective.



Or am I mistaken?





#SecRule TX:REAL_IP "@ipMatchFromFile ip_blacklist.data" \

  "msg:'Client IP in Trustwave SpiderLabs IP Reputation Blacklist.',\



Arthur Johnston


_______________________________________________
Owasp-modsecurity-core-rule-set mailing list
Owasp-modsecurity-core-rule-set at lists.owasp.org
https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20170814/86d18dd5/attachment.html>

From arthurjohnston at verizon.net  Mon Aug 14 02:46:26 2017
From: arthurjohnston at verizon.net (Arthur E. Johnston)
Date: Sun, 13 Aug 2017 19:46:26 -0700
Subject: [Owasp-modsecurity-core-rule-set] Typo in
	"REQUEST-910-IP-REPUTATION.CONF"
In-Reply-To: <CACva_gEOSTmQb=sQp+_Fm3Bn2_9bmtvSgxnC1Pd_USzDB2MrjQ@mail.gmail.com>
References: <000001d3149c$40e77280$c2b65780$@verizon.net>
	<CACva_gEOSTmQb=sQp+_Fm3Bn2_9bmtvSgxnC1Pd_USzDB2MrjQ@mail.gmail.com>
Message-ID: <000701d314a7$8784fd10$968ef730$@verizon.net>

Because the commercial rule set is not available, is the  ?Blocking Based on IP Reputation? effective?

---

 

Arthur Johnston

 

From: Osama Elnaggar [mailto:oelnaggar04 at gmail.com] 
Sent: Sunday, August 13, 2017 6:34 PM
To: Arthur E. Johnston <arthurjohnston at verizon.net>; owasp-modsecurity-core-rule-set at lists.owasp.org
Subject: Re: [Owasp-modsecurity-core-rule-set] Typo in "REQUEST-910-IP-REPUTATION.CONF"

 

Yes.  The rule is commented out because the blacklist mentioned is not provided / is commercial.  It is part of TrustWave?s commercial ruleset - https://www.modsecurity.org/commercial-rules.html 

 

-- 
Osama Elnaggar

 

On August 14, 2017 at 11:27:28 AM, Arthur E. Johnston (arthurjohnston at verizon.net <mailto:arthurjohnston at verizon.net> ) wrote:

Excuse the interruption.  I am just reviewing the rules to better understand their functions.  Honestly, I am lost, but learning.

 

While browsing rule ?REQUEST-910-IP-REPUTATION.CON?, I discovered a hashtag ?#? on line 92, effectively commenting out the beginning of the rule and causing it to be ineffective.  

 

Or am I mistaken?

 

 

#SecRule TX:REAL_IP "@ipMatchFromFile ip_blacklist.data" \

  "msg:'Client IP in Trustwave SpiderLabs IP Reputation Blacklist.',\

 

Arthur Johnston

 

_______________________________________________ 
Owasp-modsecurity-core-rule-set mailing list 
Owasp-modsecurity-core-rule-set at lists.owasp.org <mailto:Owasp-modsecurity-core-rule-set at lists.owasp.org>  
https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20170813/194f09ae/attachment-0001.html>

From christian.folini at netnea.com  Mon Aug 14 04:11:48 2017
From: christian.folini at netnea.com (Christian Folini)
Date: Mon, 14 Aug 2017 06:11:48 +0200
Subject: [Owasp-modsecurity-core-rule-set] Typo in
 "REQUEST-910-IP-REPUTATION.CONF"
In-Reply-To: <000701d314a7$8784fd10$968ef730$@verizon.net>
References: <000001d3149c$40e77280$c2b65780$@verizon.net>
	<CACva_gEOSTmQb=sQp+_Fm3Bn2_9bmtvSgxnC1Pd_USzDB2MrjQ@mail.gmail.com>
	<000701d314a7$8784fd10$968ef730$@verizon.net>
Message-ID: <20170814041148.plbsl363m3l6ggz6@leander>

Arthur,

The IP Reputation rules of CRS is not the strongest part of the rule
set. However, the group consists of several different rules with the
IP Blacklisting based on Spiderlabs Honeypot recommendation being
disabled by default.

So there is some use in this group of rules, but it is limited.

Ahoj,

Christian


On Sun, Aug 13, 2017 at 07:46:26PM -0700, Arthur E. Johnston wrote:
> Because the commercial rule set is not available, is the  ?Blocking Based on IP Reputation? effective?
> 
> ---
> 
>  
> 
> Arthur Johnston
> 
>  
> 
> From: Osama Elnaggar [mailto:oelnaggar04 at gmail.com] 
> Sent: Sunday, August 13, 2017 6:34 PM
> To: Arthur E. Johnston <arthurjohnston at verizon.net>; owasp-modsecurity-core-rule-set at lists.owasp.org
> Subject: Re: [Owasp-modsecurity-core-rule-set] Typo in "REQUEST-910-IP-REPUTATION.CONF"
> 
>  
> 
> Yes.  The rule is commented out because the blacklist mentioned is not provided / is commercial.  It is part of TrustWave?s commercial ruleset - https://www.modsecurity.org/commercial-rules.html 
> 
>  
> 
> -- 
> Osama Elnaggar
> 
>  
> 
> On August 14, 2017 at 11:27:28 AM, Arthur E. Johnston (arthurjohnston at verizon.net <mailto:arthurjohnston at verizon.net> ) wrote:
> 
> Excuse the interruption.  I am just reviewing the rules to better understand their functions.  Honestly, I am lost, but learning.
> 
>  
> 
> While browsing rule ?REQUEST-910-IP-REPUTATION.CON?, I discovered a hashtag ?#? on line 92, effectively commenting out the beginning of the rule and causing it to be ineffective.  
> 
>  
> 
> Or am I mistaken?
> 
>  
> 
>  
> 
> #SecRule TX:REAL_IP "@ipMatchFromFile ip_blacklist.data" \
> 
>   "msg:'Client IP in Trustwave SpiderLabs IP Reputation Blacklist.',\
> 
>  
> 
> Arthur Johnston
> 
>  
> 
> _______________________________________________ 
> Owasp-modsecurity-core-rule-set mailing list 
> Owasp-modsecurity-core-rule-set at lists.owasp.org <mailto:Owasp-modsecurity-core-rule-set at lists.owasp.org>  
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set 
> 

> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set


-- 
https://www.feistyduck.com/books/modsecurity-handbook/
mailto:christian.folini at netnea.com
twitter: @ChrFolini

From georgi at serversolution.info  Mon Aug 14 12:29:39 2017
From: georgi at serversolution.info (Georgi Georgiev)
Date: Mon, 14 Aug 2017 15:29:39 +0300
Subject: [Owasp-modsecurity-core-rule-set] What is the right process of
	dealing with the false postivies
Message-ID: <A4DFF44F-FE36-46BE-BD21-F7DA2AA25660@serversolution.info>

Hello,
I am deploying mod security with nginx in shared hosting environment and most of the websites are Wordpress, Joomla and drupal. I don?t want to rewrite all the rules of owasp to minimize the false positives. Also, I searched for specific for Wordpress or Joomla ruleset but couldn?t find such thing (it would be very resourceful to research for every Wordpress and Joomla hack, even the most famouse one and to write rules about it, also to read how to write rules :)). Even, if I put mod security initially in a mode that does not block , only to log it would be very hard to see very queer if it?s false positive or whether it come from evil sources.

I read that right practice is to change the score of the anomaly but didn?t understand it at all.

So, I would like to ask you how you deal with this? I know that false positives will be there all the time, but how you minimize them? Write your own ruleset? Is there any paid ruleset that you can recommend (it think that I found only one paid and many people cry from it). Just I want to explain me the process you follow with the rules :)

Thank you in advance!

From christian.folini at netnea.com  Tue Aug 15 06:52:50 2017
From: christian.folini at netnea.com (Christian Folini)
Date: Tue, 15 Aug 2017 08:52:50 +0200
Subject: [Owasp-modsecurity-core-rule-set] What is the right process of
 dealing with the false postivies
In-Reply-To: <A4DFF44F-FE36-46BE-BD21-F7DA2AA25660@serversolution.info>
References: <A4DFF44F-FE36-46BE-BD21-F7DA2AA25660@serversolution.info>
Message-ID: <20170815065250.tjfcwjp36gkrmdh2@leander>

Hello Georgi,

CRS3 comes with default rule exclusions for WP and Drupal that solve
many of the base installations FPs. Collaborating with the project on
a set of Joomla rule exclusions would be most helpful.

Starting with a higher anomaly threshold while you weed out the false
positives is a method that I advocate in my documentation.

Making sure that you do not base your tuning efforts on attack traffic
is an obvious problems. There are multiple approaches to this, and none
of them is hard science. I usually try to start off with tuning based on
known IP ranges.

This is all discussed in great detail in the series of ModSecurity
tutorials at https://www.netnea.com/cms/apache-tutorials/

Besides, I am also running two public ModSec courses in October.

Good luck!

Christian


On Mon, Aug 14, 2017 at 03:29:39PM +0300, Georgi Georgiev wrote:
> Hello,
> I am deploying mod security with nginx in shared hosting environment and most of the websites are Wordpress, Joomla and drupal. I don?t want to rewrite all the rules of owasp to minimize the false positives. Also, I searched for specific for Wordpress or Joomla ruleset but couldn?t find such thing (it would be very resourceful to research for every Wordpress and Joomla hack, even the most famouse one and to write rules about it, also to read how to write rules :)). Even, if I put mod security initially in a mode that does not block , only to log it would be very hard to see very queer if it?s false positive or whether it come from evil sources.
> 
> I read that right practice is to change the score of the anomaly but didn?t understand it at all.
> 
> So, I would like to ask you how you deal with this? I know that false positives will be there all the time, but how you minimize them? Write your own ruleset? Is there any paid ruleset that you can recommend (it think that I found only one paid and many people cry from it). Just I want to explain me the process you follow with the rules :)
> 
> Thank you in advance!
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set

-- 
https://www.feistyduck.com/books/modsecurity-handbook/
mailto:christian.folini at netnea.com
twitter: @ChrFolini

From christian.folini at netnea.com  Tue Aug 15 07:10:58 2017
From: christian.folini at netnea.com (Christian Folini)
Date: Tue, 15 Aug 2017 09:10:58 +0200
Subject: [Owasp-modsecurity-core-rule-set] Run core rule set on just one
 page / parameter
In-Reply-To: <CAAO0q_Gv+TXfX=V-FFTCkJ+m3TndoRPNGOFA=wRfVQXs3JLVuA@mail.gmail.com>
References: <CAAO0q_Gv+TXfX=V-FFTCkJ+m3TndoRPNGOFA=wRfVQXs3JLVuA@mail.gmail.com>
Message-ID: <20170815071058.c4ssrkv7gzjsmzmw@leander>

Kirk,

This is a tricky one. Actually your recipe should work. But then it does
not. I dug a bit deeper and found out an issue.

SecRuleUpdateTargetByID 942000-942999 "ARGS:SearchTerm"

adds the arg SearchTerm to all rules including steering commando rules
used for Paranoia Levels. And this seems to f**k them up. At least this
is my first impression.

Could you try and apply the Update only to those rules that really
apply and report back?

There might be a deeper issue here, so let's try and work together
to find a good recipe to solve your use case - which is actually a very
useful one.

Ahoj,

Christian


On Mon, Aug 14, 2017 at 10:03:15AM +1200, Kirk Jackson wrote:
> Hi,
> 
> I'd like to run the SQLi checks on only the one parameter on my site that
> is vulnerable to those attacks.
> 
> I was wondering if there's a pattern to do this, or if I need to copy the
> rules from REQUEST-942-APPLICATION-ATTACK-SQLI.conf into my own file, and
> change the variables to my ARGS:ParamName?
> 
> I tried doing this, to disable the rules, and then re-enable for just my
> param, but that didn't work:
> 
> SecRuleUpdateTargetByID 942000-942999 "!REQUEST_COOKIES"
> SecRuleUpdateTargetByID 942000-942999 "!REQUEST_COOKIES_NAMES"
> SecRuleUpdateTargetByID 942000-942999 "!ARGS_NAMES"
> SecRuleUpdateTargetByID 942000-942999 "!ARGS"
> SecRuleUpdateTargetByID 942000-942999 "!XML"
> 
> SecRuleUpdateTargetByID 942000-942999 "ARGS:SearchTerm"
> 
> Many thanks!
> 
> Kirk

> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set


-- 
https://www.feistyduck.com/books/modsecurity-handbook/
mailto:christian.folini at netnea.com
twitter: @ChrFolini

From christian.folini at netnea.com  Tue Aug 15 07:39:06 2017
From: christian.folini at netnea.com (Christian Folini)
Date: Tue, 15 Aug 2017 09:39:06 +0200
Subject: [Owasp-modsecurity-core-rule-set] What is the right process of
 dealing with the false postivies
In-Reply-To: <9226C3FB-8FC9-4366-A620-4B59357C22B0@serversolution.info>
References: <A4DFF44F-FE36-46BE-BD21-F7DA2AA25660@serversolution.info>
	<20170815065250.tjfcwjp36gkrmdh2@leander>
	<9226C3FB-8FC9-4366-A620-4B59357C22B0@serversolution.info>
Message-ID: <20170815073906.r2oivpnhtbu3472j@leander>

Hey, hey,

On Tue, Aug 15, 2017 at 10:31:34AM +0300, Georgi Georgiev wrote:
> Thank you about your reply. I know about the exclusion, but I don?t
> think this is the perfect solution, because if I exclude all the false
> positive rules there will be 2-3 maybe working rules at all :) 

That is not greatly exaggerated. We have about 150 rules in the default
install. Multiply this with the application's parameter. And then look
at the few dozens of rule/parameter exclusions we provide you with.
It's the minimal set of bricks broken out of the defense wall.

> Maybe they should be tunned?

Or WordPress / Drupal could be fixed to make sure they do not submit any
suspicious payloads. :)

> What is going on when the anomaly score is
> higher - this I couldn?t understand - users are not blocked or what?

The anomaly score is linked to an individual request.
The anomaly threshold is the anomaly limit where you start to block
requests.

If the threshold is at 25 and a request sets of 4 critical rules, you
get 4 error entries, a score of 20 and the request passes.

Got it?

If it is still not clear, could you read the explanations in
crs-config.conf again. If you are unable to understand that, please
point it out exactly for this would be a sign or documentation is not
good enough.

Ahoj,

Christian


> If I understand right I can start with high anomaly score for all rule
> with equal score until I tune them perfectly.
> 
> In the nginx I have ratelimits and I prefer to start with most common
> Wordpress / Joomla hacks rule that can stop some part of the hacks,
> because this is the biggest problem
> 
> Best regards, Georgi Georgiev .
> > On Aug 15, 2017, at 9:52 AM, Christian Folini
> > <christian.folini at netnea.com> wrote:
> > 
> > Hello Georgi,
> > 
> > CRS3 comes with default rule exclusions for WP and Drupal that solve
> > many of the base installations FPs. Collaborating with the project
> > on a set of Joomla rule exclusions would be most helpful.
> > 
> > Starting with a higher anomaly threshold while you weed out the
> > false positives is a method that I advocate in my documentation.
> > 
> > Making sure that you do not base your tuning efforts on attack
> > traffic is an obvious problems. There are multiple approaches to
> > this, and none of them is hard science. I usually try to start off
> > with tuning based on known IP ranges.
> > 
> > This is all discussed in great detail in the series of ModSecurity
> > tutorials at https://www.netnea.com/cms/apache-tutorials/
> > 
> > Besides, I am also running two public ModSec courses in October.
> > 
> > Good luck!
> > 
> > Christian
> > 
> > 
> > On Mon, Aug 14, 2017 at 03:29:39PM +0300, Georgi Georgiev wrote:
> >> Hello, I am deploying mod security with nginx in shared hosting
> >> environment and most of the websites are Wordpress, Joomla and
> >> drupal. I don?t want to rewrite all the rules of owasp to minimize
> >> the false positives. Also, I searched for specific for Wordpress or
> >> Joomla ruleset but couldn?t find such thing (it would be very
> >> resourceful to research for every Wordpress and Joomla hack, even
> >> the most famouse one and to write rules about it, also to read how
> >> to write rules :)). Even, if I put mod security initially in a mode
> >> that does not block , only to log it would be very hard to see very
> >> queer if it?s false positive or whether it come from evil sources.
> >> 
> >> I read that right practice is to change the score of the anomaly
> >> but didn?t understand it at all.
> >> 
> >> So, I would like to ask you how you deal with this? I know that
> >> false positives will be there all the time, but how you minimize
> >> them? Write your own ruleset? Is there any paid ruleset that you
> >> can recommend (it think that I found only one paid and many people
> >> cry from it). Just I want to explain me the process you follow with
> >> the rules :)
> >> 
> >> Thank you in advance!
> >> _______________________________________________
> >> Owasp-modsecurity-core-rule-set mailing list
> >> Owasp-modsecurity-core-rule-set at lists.owasp.org
> >> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
> > 
> > -- https://www.feistyduck.com/books/modsecurity-handbook/
> > mailto:christian.folini at netnea.com twitter: @ChrFolini

-- 
https://www.feistyduck.com/books/modsecurity-handbook/
mailto:christian.folini at netnea.com
twitter: @ChrFolini

From georgi at serversolution.info  Tue Aug 15 07:31:34 2017
From: georgi at serversolution.info (Georgi Georgiev)
Date: Tue, 15 Aug 2017 10:31:34 +0300
Subject: [Owasp-modsecurity-core-rule-set] What is the right process of
 dealing with the false postivies
In-Reply-To: <20170815065250.tjfcwjp36gkrmdh2@leander>
References: <A4DFF44F-FE36-46BE-BD21-F7DA2AA25660@serversolution.info>
	<20170815065250.tjfcwjp36gkrmdh2@leander>
Message-ID: <9226C3FB-8FC9-4366-A620-4B59357C22B0@serversolution.info>

Thank you about your reply. I know about the exclusion, but I don?t think this is the perfect solution, because if I exclude all the false positive rules there will be 2-3 maybe working rules at all :) Maybe they should be tunned? What is going on when the anomaly score is higher - this I couldn?t understand - users are not blocked or what? If I understand right I can start with high anomaly score for all rule with equal score until I tune them perfectly.

In the nginx I have ratelimits and I prefer to start with most common Wordpress / Joomla hacks rule that can stop some part of the hacks, because this is the biggest problem

Best regards,
Georgi Georgiev
.
> On Aug 15, 2017, at 9:52 AM, Christian Folini <christian.folini at netnea.com> wrote:
> 
> Hello Georgi,
> 
> CRS3 comes with default rule exclusions for WP and Drupal that solve
> many of the base installations FPs. Collaborating with the project on
> a set of Joomla rule exclusions would be most helpful.
> 
> Starting with a higher anomaly threshold while you weed out the false
> positives is a method that I advocate in my documentation.
> 
> Making sure that you do not base your tuning efforts on attack traffic
> is an obvious problems. There are multiple approaches to this, and none
> of them is hard science. I usually try to start off with tuning based on
> known IP ranges.
> 
> This is all discussed in great detail in the series of ModSecurity
> tutorials at https://www.netnea.com/cms/apache-tutorials/
> 
> Besides, I am also running two public ModSec courses in October.
> 
> Good luck!
> 
> Christian
> 
> 
> On Mon, Aug 14, 2017 at 03:29:39PM +0300, Georgi Georgiev wrote:
>> Hello,
>> I am deploying mod security with nginx in shared hosting environment and most of the websites are Wordpress, Joomla and drupal. I don?t want to rewrite all the rules of owasp to minimize the false positives. Also, I searched for specific for Wordpress or Joomla ruleset but couldn?t find such thing (it would be very resourceful to research for every Wordpress and Joomla hack, even the most famouse one and to write rules about it, also to read how to write rules :)). Even, if I put mod security initially in a mode that does not block , only to log it would be very hard to see very queer if it?s false positive or whether it come from evil sources.
>> 
>> I read that right practice is to change the score of the anomaly but didn?t understand it at all.
>> 
>> So, I would like to ask you how you deal with this? I know that false positives will be there all the time, but how you minimize them? Write your own ruleset? Is there any paid ruleset that you can recommend (it think that I found only one paid and many people cry from it). Just I want to explain me the process you follow with the rules :)
>> 
>> Thank you in advance!
>> _______________________________________________
>> Owasp-modsecurity-core-rule-set mailing list
>> Owasp-modsecurity-core-rule-set at lists.owasp.org
>> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
> 
> -- 
> https://www.feistyduck.com/books/modsecurity-handbook/
> mailto:christian.folini at netnea.com
> twitter: @ChrFolini


From kirk at pageofwords.com  Tue Aug 15 09:12:37 2017
From: kirk at pageofwords.com (Kirk Jackson)
Date: Tue, 15 Aug 2017 21:12:37 +1200
Subject: [Owasp-modsecurity-core-rule-set] Run core rule set on just one
 page / parameter
In-Reply-To: <20170815071058.c4ssrkv7gzjsmzmw@leander>
References: <CAAO0q_Gv+TXfX=V-FFTCkJ+m3TndoRPNGOFA=wRfVQXs3JLVuA@mail.gmail.com>
	<20170815071058.c4ssrkv7gzjsmzmw@leander>
Message-ID: <CAAO0q_FADMiL-iNHYCDAmE7wMyuGv3Tc=w4jKADB=SEyCKG3BQ@mail.gmail.com>

Great! Thanks Christian!

I did try and figure out what was going on with the higher debug log
levels, but didn't realise that was what was happening.

I think by "steering commando rules" you mean the rules that check which
paranoia level is set, and then jump to the marker at the end of the file?

e.g. SecRule TX:PARANOIA_LEVEL "@lt 1"
"phase:1,id:942011,nolog,pass,skipAfter:END-REQUEST-942-APPLICATION-ATTACK-SQLI"



In the SQLi include file, these rules are all numbered 942011-18, so I
changed the rules to only alter the rules from 942100-942999.

The following config then works!

Include modsecurity/crs-setup.conf
Include crs/*.conf

# Disable CRS's SQLi rules:
SecRuleUpdateTargetByID 942100-942999 "!REQUEST_COOKIES"
SecRuleUpdateTargetByID 942100-942999 "!REQUEST_COOKIES_NAMES"
SecRuleUpdateTargetByID 942100-942999 "!ARGS_NAMES"
SecRuleUpdateTargetByID 942100-942999 "!ARGS"
SecRuleUpdateTargetByID 942100-942999 "!XML"

# Only test SQLi for the SearchTerm parameter
SecRuleUpdateTargetByID 942100-942999 "ARGS:SearchTerm"

After this, the SQLi rules are disabled for all cookies, arguments and XML,
and then only re-enabled for my one parameter name.


Next, I attempted to do this at runtime, so I could apply the rules to only
my particular page:

SecRule REQUEST_FILENAME "@beginsWith /product/search" \
    "id:2011,phase:2,\
        pass,nolog,\
        t:none,t:lowercase,t:normalisePath,\
        ctl:ruleUpdateTargetById=942100-942999;ARGS:SearchTerm"



However, the ctl:ruleUpdateTargetById action doesn't work - I was lead
astray by the Mod Security Handbook, which is a bit out of date (at this
url:
https://www.feistyduck.com/library/modsecurity-handbook-2ed/online/xx1-directives.html#N15992).
It looks like that got removed:

Note : There was a ctl:ruleUpdateTargetById introduced in 2.6.0 and removed
from the code in 2.7.0. JSON was added as part of v2.8.0-rc1
(from https://github.com/SpiderLabs/ModSecurity/wiki/Reference-Manual#ctl)


If you have any ideas on how to further restrict it so I can rule the SQLi
rules for only one page + parameter combo, I'm interested to know!

Thanks,

Kirk


On Tue, Aug 15, 2017 at 7:10 PM, Christian Folini <
christian.folini at netnea.com> wrote:

> Kirk,
>
> This is a tricky one. Actually your recipe should work. But then it does
> not. I dug a bit deeper and found out an issue.
>
> SecRuleUpdateTargetByID 942000-942999 "ARGS:SearchTerm"
>
> adds the arg SearchTerm to all rules including steering commando rules
> used for Paranoia Levels. And this seems to f**k them up. At least this
> is my first impression.
>
> Could you try and apply the Update only to those rules that really
> apply and report back?
>
> There might be a deeper issue here, so let's try and work together
> to find a good recipe to solve your use case - which is actually a very
> useful one.
>
> Ahoj,
>
> Christian
>
>
> On Mon, Aug 14, 2017 at 10:03:15AM +1200, Kirk Jackson wrote:
> > Hi,
> >
> > I'd like to run the SQLi checks on only the one parameter on my site that
> > is vulnerable to those attacks.
> >
> > I was wondering if there's a pattern to do this, or if I need to copy the
> > rules from REQUEST-942-APPLICATION-ATTACK-SQLI.conf into my own file,
> and
> > change the variables to my ARGS:ParamName?
> >
> > I tried doing this, to disable the rules, and then re-enable for just my
> > param, but that didn't work:
> >
> > SecRuleUpdateTargetByID 942000-942999 "!REQUEST_COOKIES"
> > SecRuleUpdateTargetByID 942000-942999 "!REQUEST_COOKIES_NAMES"
> > SecRuleUpdateTargetByID 942000-942999 "!ARGS_NAMES"
> > SecRuleUpdateTargetByID 942000-942999 "!ARGS"
> > SecRuleUpdateTargetByID 942000-942999 "!XML"
> >
> > SecRuleUpdateTargetByID 942000-942999 "ARGS:SearchTerm"
> >
> > Many thanks!
> >
> > Kirk
>
> > _______________________________________________
> > Owasp-modsecurity-core-rule-set mailing list
> > Owasp-modsecurity-core-rule-set at lists.owasp.org
> > https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>
>
> --
> https://www.feistyduck.com/books/modsecurity-handbook/
> mailto:christian.folini at netnea.com
> twitter: @ChrFolini
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20170815/6f8d1896/attachment-0001.html>

From georgi at serversolution.info  Tue Aug 15 12:42:08 2017
From: georgi at serversolution.info (Georgi Georgiev)
Date: Tue, 15 Aug 2017 15:42:08 +0300
Subject: [Owasp-modsecurity-core-rule-set] What is the right process of
 dealing with the false postivies
In-Reply-To: <20170815065250.tjfcwjp36gkrmdh2@leander>
References: <A4DFF44F-FE36-46BE-BD21-F7DA2AA25660@serversolution.info>
	<20170815065250.tjfcwjp36gkrmdh2@leander>
Message-ID: <CC9D96A5-6F02-4E32-B923-12C52CA1BA20@serversolution.info>

Thank you about your reply again, it was useful. First of all I would like to apologize for the stupid for you questions. Currently I see that I have the following in the config which means from what I read that I am not in anomaly mode, but in traditional:

SecDefaultAction "log,deny,phase:1"

So, by your recommendation I understand that I should remove this lines to start using anomaly mode. Then, on every rule I can/ should add with setvar:tx.anomaly_score=5(for example) so I can control it?s score?

Also to decrease the false positives as a second step from the setup should I increase the threshold value here - or I am wrong?

# Default Inbound Anomaly Threshold Level (rule 900110 in setup.conf)
SecRule &TX:inbound_anomaly_score_threshold "@eq 0" \
    "id:901100,\
    phase:1,\
    pass,\
    nolog,\
    setvar:tx.inbound_anomaly_score_threshold=5"



> On Aug 15, 2017, at 9:52 AM, Christian Folini <christian.folini at netnea.com> wrote:
> 
> Hello Georgi,
> 
> CRS3 comes with default rule exclusions for WP and Drupal that solve
> many of the base installations FPs. Collaborating with the project on
> a set of Joomla rule exclusions would be most helpful.
> 
> Starting with a higher anomaly threshold while you weed out the false
> positives is a method that I advocate in my documentation.
> 
> Making sure that you do not base your tuning efforts on attack traffic
> is an obvious problems. There are multiple approaches to this, and none
> of them is hard science. I usually try to start off with tuning based on
> known IP ranges.
> 
> This is all discussed in great detail in the series of ModSecurity
> tutorials at https://www.netnea.com/cms/apache-tutorials/
> 
> Besides, I am also running two public ModSec courses in October.
> 
> Good luck!
> 
> Christian
> 
> 
> On Mon, Aug 14, 2017 at 03:29:39PM +0300, Georgi Georgiev wrote:
>> Hello,
>> I am deploying mod security with nginx in shared hosting environment and most of the websites are Wordpress, Joomla and drupal. I don?t want to rewrite all the rules of owasp to minimize the false positives. Also, I searched for specific for Wordpress or Joomla ruleset but couldn?t find such thing (it would be very resourceful to research for every Wordpress and Joomla hack, even the most famouse one and to write rules about it, also to read how to write rules :)). Even, if I put mod security initially in a mode that does not block , only to log it would be very hard to see very queer if it?s false positive or whether it come from evil sources.
>> 
>> I read that right practice is to change the score of the anomaly but didn?t understand it at all.
>> 
>> So, I would like to ask you how you deal with this? I know that false positives will be there all the time, but how you minimize them? Write your own ruleset? Is there any paid ruleset that you can recommend (it think that I found only one paid and many people cry from it). Just I want to explain me the process you follow with the rules :)
>> 
>> Thank you in advance!
>> _______________________________________________
>> Owasp-modsecurity-core-rule-set mailing list
>> Owasp-modsecurity-core-rule-set at lists.owasp.org
>> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
> 
> -- 
> https://www.feistyduck.com/books/modsecurity-handbook/
> mailto:christian.folini at netnea.com
> twitter: @ChrFolini

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20170815/257e6c06/attachment.html>

From christian.folini at netnea.com  Tue Aug 15 12:46:20 2017
From: christian.folini at netnea.com (Christian Folini)
Date: Tue, 15 Aug 2017 14:46:20 +0200
Subject: [Owasp-modsecurity-core-rule-set] Run core rule set on just one
 page / parameter
In-Reply-To: <CAAO0q_FADMiL-iNHYCDAmE7wMyuGv3Tc=w4jKADB=SEyCKG3BQ@mail.gmail.com>
References: <CAAO0q_Gv+TXfX=V-FFTCkJ+m3TndoRPNGOFA=wRfVQXs3JLVuA@mail.gmail.com>
	<20170815071058.c4ssrkv7gzjsmzmw@leander>
	<CAAO0q_FADMiL-iNHYCDAmE7wMyuGv3Tc=w4jKADB=SEyCKG3BQ@mail.gmail.com>
Message-ID: <20170815124620.3n3i7a265d3cmasg@leander>

Hey Kirk,

Thank you for trying this out so quickly. This is very helpful.

On Tue, Aug 15, 2017 at 09:12:37PM +1200, Kirk Jackson wrote:
> I think by "steering commando rules" you mean the rules that check which
> paranoia level is set, and then jump to the marker at the end of the file?

Exactly.

> The following config then works!
> 
> Include modsecurity/crs-setup.conf
> Include crs/*.conf
> 
> # Disable CRS's SQLi rules:
> SecRuleUpdateTargetByID 942100-942999 "!REQUEST_COOKIES"
> SecRuleUpdateTargetByID 942100-942999 "!REQUEST_COOKIES_NAMES"
> SecRuleUpdateTargetByID 942100-942999 "!ARGS_NAMES"
> SecRuleUpdateTargetByID 942100-942999 "!ARGS"
> SecRuleUpdateTargetByID 942100-942999 "!XML"
> 
> # Only test SQLi for the SearchTerm parameter
> SecRuleUpdateTargetByID 942100-942999 "ARGS:SearchTerm"

Sweet. Glad it works.

> However, the ctl:ruleUpdateTargetById action doesn't work - I was lead
> astray by the Mod Security Handbook, which is a bit out of date (at this
> url:
> https://www.feistyduck.com/library/modsecurity-handbook-2ed/online/xx1-directives.html#N15992).
> It looks like that got removed:
> 
> Note : There was a ctl:ruleUpdateTargetById introduced in 2.6.0 and removed
> from the code in 2.7.0. JSON was added as part of v2.8.0-rc1
> (from https://github.com/SpiderLabs/ModSecurity/wiki/Reference-Manual#ctl)

Oops. That's a clear factual mistake in the book.
I think I need to talk to the author.

But on a more serious note: This is the first real technical bug in the
book. We had a bug report before but it was more a missing comment. Your
discovery points to a factual error I should have noticed. Sorry.

Do you have a paper copy of the book? If not, then please give me your
address and I will have a copy be sent your way. Ironically, it will
come with the bug, but I really appreciate people submitting errors the
encounter in the book.

> If you have any ideas on how to further restrict it so I can rule the SQLi
> rules for only one page + parameter combo, I'm interested to know!

With ctl:ruleUpdateTargetById being no longer an option, we need a
different approach. This is turning more and more into a wild hack, but
let's try out the following:

- Remove all the ARGS at startup time
- Add ARGS:SearchTerm at startup time
- Remove SearchTerm from all paths but /product/search at runtime
  -> "!@beginsWith /product/search"

Good luck and please report back!

Christian

-- 
ModSecurity courses Oct 2017 in London and Zurich
https://www.feistyduck.com/training/modsecurity-training-course
https://www.feistyduck.com/books/modsecurity-handbook/
mailto:christian.folini at netnea.com
twitter: @ChrFolini

From christian.folini at netnea.com  Tue Aug 15 12:55:27 2017
From: christian.folini at netnea.com (Christian Folini)
Date: Tue, 15 Aug 2017 14:55:27 +0200
Subject: [Owasp-modsecurity-core-rule-set] What is the right process of
 dealing with the false postivies
In-Reply-To: <CC9D96A5-6F02-4E32-B923-12C52CA1BA20@serversolution.info>
References: <A4DFF44F-FE36-46BE-BD21-F7DA2AA25660@serversolution.info>
	<20170815065250.tjfcwjp36gkrmdh2@leander>
	<CC9D96A5-6F02-4E32-B923-12C52CA1BA20@serversolution.info>
Message-ID: <20170815125527.fvixwduthihq2obp@leander>

Georgi,

Yes, this is all correct.

Glad to help (just not always with enough time at my hands...)

Cheers,

Christian

On Tue, Aug 15, 2017 at 03:42:08PM +0300, Georgi Georgiev wrote:
> Thank you about your reply again, it was useful. First of all I would like to apologize for the stupid for you questions. Currently I see that I have the following in the config which means from what I read that I am not in anomaly mode, but in traditional:
> 
> SecDefaultAction "log,deny,phase:1"
> 
> So, by your recommendation I understand that I should remove this lines to start using anomaly mode. Then, on every rule I can/ should add with setvar:tx.anomaly_score=5(for example) so I can control it?s score?
> 
> Also to decrease the false positives as a second step from the setup should I increase the threshold value here - or I am wrong?
> 
> # Default Inbound Anomaly Threshold Level (rule 900110 in setup.conf)
> SecRule &TX:inbound_anomaly_score_threshold "@eq 0" \
>     "id:901100,\
>     phase:1,\
>     pass,\
>     nolog,\
>     setvar:tx.inbound_anomaly_score_threshold=5"
> 
> 
> 
> > On Aug 15, 2017, at 9:52 AM, Christian Folini <christian.folini at netnea.com> wrote:
> > 
> > Hello Georgi,
> > 
> > CRS3 comes with default rule exclusions for WP and Drupal that solve
> > many of the base installations FPs. Collaborating with the project on
> > a set of Joomla rule exclusions would be most helpful.
> > 
> > Starting with a higher anomaly threshold while you weed out the false
> > positives is a method that I advocate in my documentation.
> > 
> > Making sure that you do not base your tuning efforts on attack traffic
> > is an obvious problems. There are multiple approaches to this, and none
> > of them is hard science. I usually try to start off with tuning based on
> > known IP ranges.
> > 
> > This is all discussed in great detail in the series of ModSecurity
> > tutorials at https://www.netnea.com/cms/apache-tutorials/
> > 
> > Besides, I am also running two public ModSec courses in October.
> > 
> > Good luck!
> > 
> > Christian
> > 
> > 
> > On Mon, Aug 14, 2017 at 03:29:39PM +0300, Georgi Georgiev wrote:
> >> Hello,
> >> I am deploying mod security with nginx in shared hosting environment and most of the websites are Wordpress, Joomla and drupal. I don?t want to rewrite all the rules of owasp to minimize the false positives. Also, I searched for specific for Wordpress or Joomla ruleset but couldn?t find such thing (it would be very resourceful to research for every Wordpress and Joomla hack, even the most famouse one and to write rules about it, also to read how to write rules :)). Even, if I put mod security initially in a mode that does not block , only to log it would be very hard to see very queer if it?s false positive or whether it come from evil sources.
> >> 
> >> I read that right practice is to change the score of the anomaly but didn?t understand it at all.
> >> 
> >> So, I would like to ask you how you deal with this? I know that false positives will be there all the time, but how you minimize them? Write your own ruleset? Is there any paid ruleset that you can recommend (it think that I found only one paid and many people cry from it). Just I want to explain me the process you follow with the rules :)
> >> 
> >> Thank you in advance!
> >> _______________________________________________
> >> Owasp-modsecurity-core-rule-set mailing list
> >> Owasp-modsecurity-core-rule-set at lists.owasp.org
> >> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
> > 
> > -- 
> > https://www.feistyduck.com/books/modsecurity-handbook/
> > mailto:christian.folini at netnea.com
> > twitter: @ChrFolini
> 

-- 
ModSecurity courses Oct 2017 in London and Zurich
https://www.feistyduck.com/training/modsecurity-training-course
https://www.feistyduck.com/books/modsecurity-handbook/
mailto:christian.folini at netnea.com
twitter: @ChrFolini

From georgi at serversolution.info  Tue Aug 15 15:10:29 2017
From: georgi at serversolution.info (Georgi Georgiev)
Date: Tue, 15 Aug 2017 18:10:29 +0300
Subject: [Owasp-modsecurity-core-rule-set] What is the right process of
 dealing with the false postivies
In-Reply-To: <20170815125527.fvixwduthihq2obp@leander>
References: <A4DFF44F-FE36-46BE-BD21-F7DA2AA25660@serversolution.info>
	<20170815065250.tjfcwjp36gkrmdh2@leander>
	<CC9D96A5-6F02-4E32-B923-12C52CA1BA20@serversolution.info>
	<20170815125527.fvixwduthihq2obp@leander>
Message-ID: <22553B46-BD02-493D-9DB2-92D28E858532@serversolution.info>

Ok, I removed the line SecDefaultAction "log,deny,phase:1? so now I am in anomaly mode as a first step.

Later, I changed the threshold to 40 and xss stack test no longer been blocked.

SecRule &TX:inbound_anomaly_score_threshold "@eq 0" \
    "id:901100,\
    phase:1,\
    pass,\
    nolog,\
    setvar:tx.inbound_anomaly_score_threshold=40?

Last, but not least I added tx score to the following rule which is a custom one from me as I experimented with the valued, but I am always blocked. Is the problem in the rule (40 scores shouldn?t be reached from one rule)?

SecRule ARGS|REQUEST_URI "c99"  "phase:3,log,id:153,setvar:tx.anomaly_score=0?

Should I do something other or now I should play only with this score? Are there any best practices or something other to suggest me? 

Best regards,
Georgi Georgiev

> On Aug 15, 2017, at 3:55 PM, Christian Folini <christian.folini at netnea.com> wrote:
> 
> Georgi,
> 
> Yes, this is all correct.
> 
> Glad to help (just not always with enough time at my hands...)
> 
> Cheers,
> 
> Christian
> 
> On Tue, Aug 15, 2017 at 03:42:08PM +0300, Georgi Georgiev wrote:
>> Thank you about your reply again, it was useful. First of all I would like to apologize for the stupid for you questions. Currently I see that I have the following in the config which means from what I read that I am not in anomaly mode, but in traditional:
>> 
>> SecDefaultAction "log,deny,phase:1"
>> 
>> So, by your recommendation I understand that I should remove this lines to start using anomaly mode. Then, on every rule I can/ should add with setvar:tx.anomaly_score=5(for example) so I can control it?s score?
>> 
>> Also to decrease the false positives as a second step from the setup should I increase the threshold value here - or I am wrong?
>> 
>> # Default Inbound Anomaly Threshold Level (rule 900110 in setup.conf)
>> SecRule &TX:inbound_anomaly_score_threshold "@eq 0" \
>>    "id:901100,\
>>    phase:1,\
>>    pass,\
>>    nolog,\
>>    setvar:tx.inbound_anomaly_score_threshold=5"
>> 
>> 
>> 
>>> On Aug 15, 2017, at 9:52 AM, Christian Folini <christian.folini at netnea.com> wrote:
>>> 
>>> Hello Georgi,
>>> 
>>> CRS3 comes with default rule exclusions for WP and Drupal that solve
>>> many of the base installations FPs. Collaborating with the project on
>>> a set of Joomla rule exclusions would be most helpful.
>>> 
>>> Starting with a higher anomaly threshold while you weed out the false
>>> positives is a method that I advocate in my documentation.
>>> 
>>> Making sure that you do not base your tuning efforts on attack traffic
>>> is an obvious problems. There are multiple approaches to this, and none
>>> of them is hard science. I usually try to start off with tuning based on
>>> known IP ranges.
>>> 
>>> This is all discussed in great detail in the series of ModSecurity
>>> tutorials at https://www.netnea.com/cms/apache-tutorials/
>>> 
>>> Besides, I am also running two public ModSec courses in October.
>>> 
>>> Good luck!
>>> 
>>> Christian
>>> 
>>> 
>>> On Mon, Aug 14, 2017 at 03:29:39PM +0300, Georgi Georgiev wrote:
>>>> Hello,
>>>> I am deploying mod security with nginx in shared hosting environment and most of the websites are Wordpress, Joomla and drupal. I don?t want to rewrite all the rules of owasp to minimize the false positives. Also, I searched for specific for Wordpress or Joomla ruleset but couldn?t find such thing (it would be very resourceful to research for every Wordpress and Joomla hack, even the most famouse one and to write rules about it, also to read how to write rules :)). Even, if I put mod security initially in a mode that does not block , only to log it would be very hard to see very queer if it?s false positive or whether it come from evil sources.
>>>> 
>>>> I read that right practice is to change the score of the anomaly but didn?t understand it at all.
>>>> 
>>>> So, I would like to ask you how you deal with this? I know that false positives will be there all the time, but how you minimize them? Write your own ruleset? Is there any paid ruleset that you can recommend (it think that I found only one paid and many people cry from it). Just I want to explain me the process you follow with the rules :)
>>>> 
>>>> Thank you in advance!
>>>> _______________________________________________
>>>> Owasp-modsecurity-core-rule-set mailing list
>>>> Owasp-modsecurity-core-rule-set at lists.owasp.org
>>>> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>>> 
>>> -- 
>>> https://www.feistyduck.com/books/modsecurity-handbook/
>>> mailto:christian.folini at netnea.com
>>> twitter: @ChrFolini
>> 
> 
> -- 
> ModSecurity courses Oct 2017 in London and Zurich
> https://www.feistyduck.com/training/modsecurity-training-course
> https://www.feistyduck.com/books/modsecurity-handbook/
> mailto:christian.folini at netnea.com
> twitter: @ChrFolini

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20170815/df60d307/attachment-0001.html>

From kirk at pageofwords.com  Tue Aug 15 23:09:45 2017
From: kirk at pageofwords.com (Kirk Jackson)
Date: Wed, 16 Aug 2017 11:09:45 +1200
Subject: [Owasp-modsecurity-core-rule-set] Run core rule set on just one
 page / parameter
In-Reply-To: <20170815124620.3n3i7a265d3cmasg@leander>
References: <CAAO0q_Gv+TXfX=V-FFTCkJ+m3TndoRPNGOFA=wRfVQXs3JLVuA@mail.gmail.com>
	<20170815071058.c4ssrkv7gzjsmzmw@leander>
	<CAAO0q_FADMiL-iNHYCDAmE7wMyuGv3Tc=w4jKADB=SEyCKG3BQ@mail.gmail.com>
	<20170815124620.3n3i7a265d3cmasg@leander>
Message-ID: <CAAO0q_GyF=LnuLKdxjyE6PLu6aw7ri-U8SJwUweJVYoEa==4Gg@mail.gmail.com>

Thanks Christian, I appreciate your help!

On Wed, Aug 16, 2017 at 12:46 AM, Christian Folini <
christian.folini at netnea.com> wrote:

> Do you have a paper copy of the book? If not, then please give me your
> address and I will have a copy be sent your way. Ironically, it will
> come with the bug, but I really appreciate people submitting errors the
> encounter in the book.
>

That's not necessary, thanks for the offer. I've already got the electronic
version, and the paper copy is shipping as we speak :)


> > If you have any ideas on how to further restrict it so I can rule the
> SQLi
> > rules for only one page + parameter combo, I'm interested to know!
>
> With ctl:ruleUpdateTargetById being no longer an option, we need a
> different approach. This is turning more and more into a wild hack, but
> let's try out the following:
>
> - Remove all the ARGS at startup time
> - Add ARGS:SearchTerm at startup time
> - Remove SearchTerm from all paths but /product/search at runtime
>   -> "!@beginsWith /product/search"
>
> Good luck and please report back!
>

That works well.

Here's my canonical "How you run the Core Rule Set's SQLi rules only on
vulnerable pages and parameters" for historical / archival reference:

These rules disable the SQL injection rules in the Core Rule Set v3, except
for two parameters: "SearchTerm" and "foo". This is done at configuration
time, so the SecRuleUpdateTargetByID statements have to go after the Core
Rule Set is included.

Then at runtime, we narrow down the list of pages that the SQLi rules are
run against, by removing the two parameters "SearchTerm" and "foo"
depending on which URL is being requested. As this is at runtime, these two
rules need to go before the Core Rule Set rules are included, so that the
change to their Target is done before they run.

# Rutime: Only run the SQLi rules against SearchTerm if on the Product
Search page
SecRule REQUEST_FILENAME "!@beginsWith /product/search" \
    "id:2011,phase:2,\
        pass,nolog,\
        t:none,t:lowercase,t:normalisePath,\
        ctl:ruleRemoveTargetById=942100-942999;ARGS:SearchTerm"

# Runtime: Only run the SQLi rules against argument foo if on the About page

SecRule REQUEST_FILENAME "!@beginsWith /home/about" \
    "id:2012,phase:2,\
        pass,nolog,\
        t:none,t:lowercase,t:normalisePath,\
        ctl:ruleRemoveTargetById=942100-942999;ARGS:foo"

Include modsecurity/crs-setup.conf
Include crs/*.conf

# Configure-Time: Disable CRS's SQLi rules:
SecRuleUpdateTargetByID 942100-942999 "!REQUEST_COOKIES"
SecRuleUpdateTargetByID 942100-942999 "!REQUEST_COOKIES_NAMES"
SecRuleUpdateTargetByID 942100-942999 "!ARGS_NAMES"
SecRuleUpdateTargetByID 942100-942999 "!ARGS"
SecRuleUpdateTargetByID 942100-942999 "!XML"

# Configure-Time: Only test SQLi for the SearchTerm & foo parameters
SecRuleUpdateTargetByID 942100-942999 "ARGS:SearchTerm"
SecRuleUpdateTargetByID 942100-942999 "ARGS:foo"

# (Jump back up to ID 2011 and 2012 above the include for CRS, to see the
rest of the rules)


I appreciate your help getting this working.

Cheers,

Kirk
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20170816/6abd4e35/attachment.html>

From christian.folini at netnea.com  Wed Aug 16 04:23:32 2017
From: christian.folini at netnea.com (Christian Folini)
Date: Wed, 16 Aug 2017 06:23:32 +0200
Subject: [Owasp-modsecurity-core-rule-set] Run core rule set on just one
 page / parameter
In-Reply-To: <CAAO0q_GyF=LnuLKdxjyE6PLu6aw7ri-U8SJwUweJVYoEa==4Gg@mail.gmail.com>
References: <CAAO0q_Gv+TXfX=V-FFTCkJ+m3TndoRPNGOFA=wRfVQXs3JLVuA@mail.gmail.com>
	<20170815071058.c4ssrkv7gzjsmzmw@leander>
	<CAAO0q_FADMiL-iNHYCDAmE7wMyuGv3Tc=w4jKADB=SEyCKG3BQ@mail.gmail.com>
	<20170815124620.3n3i7a265d3cmasg@leander>
	<CAAO0q_GyF=LnuLKdxjyE6PLu6aw7ri-U8SJwUweJVYoEa==4Gg@mail.gmail.com>
Message-ID: <20170816042332.65h6gidotaoax5ni@leander>

Hey Kirk,

Thank you for your fully documented recipe. Glad it works.
This is almost ready for a complete blogpost on the subject:

- Step 1: Running rules only on certain parameters
- Step 2: Running rules only on certain parameters on certain paths

Interested to write that?

Ahoj,

Christian

On Wed, Aug 16, 2017 at 11:09:45AM +1200, Kirk Jackson wrote:
> > - Remove SearchTerm from all paths but /product/search at runtime
> >   -> "!@beginsWith /product/search"
> >
> > Good luck and please report back!
> >
> 
> That works well.
> 
> Here's my canonical "How you run the Core Rule Set's SQLi rules only on
> vulnerable pages and parameters" for historical / archival reference:
> 
> These rules disable the SQL injection rules in the Core Rule Set v3, except
> for two parameters: "SearchTerm" and "foo". This is done at configuration
> time, so the SecRuleUpdateTargetByID statements have to go after the Core
> Rule Set is included.
> 
> Then at runtime, we narrow down the list of pages that the SQLi rules are
> run against, by removing the two parameters "SearchTerm" and "foo"
> depending on which URL is being requested. As this is at runtime, these two
> rules need to go before the Core Rule Set rules are included, so that the
> change to their Target is done before they run.
> 
> # Rutime: Only run the SQLi rules against SearchTerm if on the Product
> Search page
> SecRule REQUEST_FILENAME "!@beginsWith /product/search" \
>     "id:2011,phase:2,\
>         pass,nolog,\
>         t:none,t:lowercase,t:normalisePath,\
>         ctl:ruleRemoveTargetById=942100-942999;ARGS:SearchTerm"
> 
> # Runtime: Only run the SQLi rules against argument foo if on the About page
> 
> SecRule REQUEST_FILENAME "!@beginsWith /home/about" \
>     "id:2012,phase:2,\
>         pass,nolog,\
>         t:none,t:lowercase,t:normalisePath,\
>         ctl:ruleRemoveTargetById=942100-942999;ARGS:foo"
> 
> Include modsecurity/crs-setup.conf
> Include crs/*.conf
> 
> # Configure-Time: Disable CRS's SQLi rules:
> SecRuleUpdateTargetByID 942100-942999 "!REQUEST_COOKIES"
> SecRuleUpdateTargetByID 942100-942999 "!REQUEST_COOKIES_NAMES"
> SecRuleUpdateTargetByID 942100-942999 "!ARGS_NAMES"
> SecRuleUpdateTargetByID 942100-942999 "!ARGS"
> SecRuleUpdateTargetByID 942100-942999 "!XML"
> 
> # Configure-Time: Only test SQLi for the SearchTerm & foo parameters
> SecRuleUpdateTargetByID 942100-942999 "ARGS:SearchTerm"
> SecRuleUpdateTargetByID 942100-942999 "ARGS:foo"
> 
> # (Jump back up to ID 2011 and 2012 above the include for CRS, to see the
> rest of the rules)
> 
> 
> I appreciate your help getting this working.
> 
> Cheers,
> 
> Kirk

-- 
ModSecurity courses Oct 2017 in London and Zurich
https://www.feistyduck.com/training/modsecurity-training-course
https://www.feistyduck.com/books/modsecurity-handbook/
mailto:christian.folini at netnea.com
twitter: @ChrFolini

From edg at greenberg.org  Wed Aug 16 13:32:53 2017
From: edg at greenberg.org (Ed Greenberg)
Date: Wed, 16 Aug 2017 09:32:53 -0400
Subject: [Owasp-modsecurity-core-rule-set] Run core rule set on just one
 page / parameter
In-Reply-To: <20170816042332.65h6gidotaoax5ni@leander>
References: <CAAO0q_Gv+TXfX=V-FFTCkJ+m3TndoRPNGOFA=wRfVQXs3JLVuA@mail.gmail.com>
	<20170815071058.c4ssrkv7gzjsmzmw@leander>
	<CAAO0q_FADMiL-iNHYCDAmE7wMyuGv3Tc=w4jKADB=SEyCKG3BQ@mail.gmail.com>
	<20170815124620.3n3i7a265d3cmasg@leander>
	<CAAO0q_GyF=LnuLKdxjyE6PLu6aw7ri-U8SJwUweJVYoEa==4Gg@mail.gmail.com>
	<20170816042332.65h6gidotaoax5ni@leander>
Message-ID: <e5712d50-a578-3ad1-6a14-ce4416780d12@greenberg.org>

On 08/16/2017 12:23 AM, Christian Folini wrote:
> Hey Kirk,
>
> Thank you for your fully documented recipe. Glad it works.
> This is almost ready for a complete blogpost on the subject:
>
> - Step 1: Running rules only on certain parameters
> - Step 2: Running rules only on certain parameters on certain paths
>
> Interested to write that?
>
> Ahoj,
>
> Christian


This sounds like just what I was going to ask.

If I have

SecRule  ARGS  "@rx whatever" "actions"

and I want to run it on ARGS except one particular ARG

is there a way to do this?

Thanks,

Ed

From chaim at chaimsanders.com  Wed Aug 16 15:45:30 2017
From: chaim at chaimsanders.com (Chaim Sanders)
Date: Wed, 16 Aug 2017 11:45:30 -0400
Subject: [Owasp-modsecurity-core-rule-set] Run core rule set on just one
 page / parameter
In-Reply-To: <e5712d50-a578-3ad1-6a14-ce4416780d12@greenberg.org>
References: <CAAO0q_Gv+TXfX=V-FFTCkJ+m3TndoRPNGOFA=wRfVQXs3JLVuA@mail.gmail.com>
	<20170815071058.c4ssrkv7gzjsmzmw@leander>
	<CAAO0q_FADMiL-iNHYCDAmE7wMyuGv3Tc=w4jKADB=SEyCKG3BQ@mail.gmail.com>
	<20170815124620.3n3i7a265d3cmasg@leander>
	<CAAO0q_GyF=LnuLKdxjyE6PLu6aw7ri-U8SJwUweJVYoEa==4Gg@mail.gmail.com>
	<20170816042332.65h6gidotaoax5ni@leander>
	<e5712d50-a578-3ad1-6a14-ce4416780d12@greenberg.org>
Message-ID: <CAE8hE=oB-+P1ipyksFhhjC0FDuJSAykjyeokAtzTyOJPFzokUQ@mail.gmail.com>

Ed, you are looking for SecRuleUpdateTargetByID (
https://github.com/SpiderLabs/ModSecurity/wiki/Reference-Manual#SecRuleUpdateTargetById
).

It has the format such as SecRuleUpdateTargetById 12345 "!ARGS:foo". This
would remove ONLY ARGS:foo from being processed in a rule that has ARGS
specified.

Do remember that these need to be placed AFTER your traditional rules. In
CRS this would be in RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf.

More examples are also available in the example version of that file (
https://github.com/SpiderLabs/owasp-modsecurity-crs/blob/v3.0/master/rules/RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf.example
).


On Wed, Aug 16, 2017 at 9:32 AM, Ed Greenberg <edg at greenberg.org> wrote:

> On 08/16/2017 12:23 AM, Christian Folini wrote:
>
>> Hey Kirk,
>>
>> Thank you for your fully documented recipe. Glad it works.
>> This is almost ready for a complete blogpost on the subject:
>>
>> - Step 1: Running rules only on certain parameters
>> - Step 2: Running rules only on certain parameters on certain paths
>>
>> Interested to write that?
>>
>> Ahoj,
>>
>> Christian
>>
>
>
> This sounds like just what I was going to ask.
>
> If I have
>
> SecRule  ARGS  "@rx whatever" "actions"
>
> and I want to run it on ARGS except one particular ARG
>
> is there a way to do this?
>
> Thanks,
>
> Ed
>
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>



-- 
-- 
Chaim Sanders
http://www.ChaimSanders.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20170816/e5b39092/attachment.html>

From georgi at serversolution.info  Thu Aug 17 16:27:49 2017
From: georgi at serversolution.info (Georgi Georgiev)
Date: Thu, 17 Aug 2017 19:27:49 +0300
Subject: [Owasp-modsecurity-core-rule-set] What is the right process of
 dealing with the false postivies
In-Reply-To: <22553B46-BD02-493D-9DB2-92D28E858532@serversolution.info>
References: <A4DFF44F-FE36-46BE-BD21-F7DA2AA25660@serversolution.info>
	<20170815065250.tjfcwjp36gkrmdh2@leander>
	<CC9D96A5-6F02-4E32-B923-12C52CA1BA20@serversolution.info>
	<20170815125527.fvixwduthihq2obp@leander>
	<22553B46-BD02-493D-9DB2-92D28E858532@serversolution.info>
Message-ID: <B2B6B510-33B9-4F8F-B01B-F1B34BB572B6@serversolution.info>

I am getting started :) I would like to finally ask you these questions. I would be very thankful if you answer me.

 1. Is really paranoia level 1 less false postitive for a shared hosting environment and in such time enough for protection? Does it protect from sql injection and xss as I read that they are included in paranoia level2? What is the best practice - initially start with paranoia level 1, tune it and then switch to 2?

2. What is your anomaly inbound score set? Have you changed it to something other than 5 or you leaved it to 5 and changed the score of the rules?

3. I am not sure how to tune the tx.score for every rule in the OWASP as they are with variables such as follow:

  SecRule IP:REPUT_BLOCK_FLAG "@eq 1" \
    "setvar:tx.anomaly_score=+%{tx.critical_anomaly_score},\
    setvar:tx.%{rule.id}-AUTOMATION/MALICIOUS-%{matched_var_name}=%{matched_var}"


Is this the correct default scores for the specific rulesets and attacks that I should tune?

# All _score variables start at 0, and are incremented by the various rules
# upon detection of a possible attack.
# sql_error_match is used for shortcutting rules for performance reasons.

SecAction \
 "id:901200,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.anomaly_score=0,\
  setvar:tx.sql_injection_score=0,\
  setvar:tx.xss_score=0,\
  setvar:tx.rfi_score=0,\
  setvar:tx.lfi_score=0,\
  setvar:tx.rce_score=0,\
  setvar:tx.php_injection_score=0,\
  setvar:tx.http_violation_score=0,\
  setvar:tx.session_fixation_score=0,\
  setvar:tx.inbound_anomaly_score=0,\
  setvar:tx.outbound_anomaly_score=0,\
  setvar:tx.sql_error_match=0


4. Should I adjust the percentage of requests that are funnelled into the Core Rules below 100 as it?s recommended on some pages? Does this affect the false positives or only the performance?

Best regards,
Georgi Georgiev

> On Aug 15, 2017, at 6:10 PM, Georgi Georgiev <georgi at serversolution.info> wrote:
> 
> Ok, I removed the line SecDefaultAction "log,deny,phase:1? so now I am in anomaly mode as a first step.
> 
> Later, I changed the threshold to 40 and xss stack test no longer been blocked.
> 
> SecRule &TX:inbound_anomaly_score_threshold "@eq 0" \
>     "id:901100,\
>     phase:1,\
>     pass,\
>     nolog,\
>     setvar:tx.inbound_anomaly_score_threshold=40?
> 
> Last, but not least I added tx score to the following rule which is a custom one from me as I experimented with the valued, but I am always blocked. Is the problem in the rule (40 scores shouldn?t be reached from one rule)?
> 
> SecRule ARGS|REQUEST_URI "c99"  "phase:3,log,id:153,setvar:tx.anomaly_score=0?
> 
> Should I do something other or now I should play only with this score? Are there any best practices or something other to suggest me? 
> 
> Best regards,
> Georgi Georgiev
> 
>> On Aug 15, 2017, at 3:55 PM, Christian Folini <christian.folini at netnea.com <mailto:christian.folini at netnea.com>> wrote:
>> 
>> Georgi,
>> 
>> Yes, this is all correct.
>> 
>> Glad to help (just not always with enough time at my hands...)
>> 
>> Cheers,
>> 
>> Christian
>> 
>> On Tue, Aug 15, 2017 at 03:42:08PM +0300, Georgi Georgiev wrote:
>>> Thank you about your reply again, it was useful. First of all I would like to apologize for the stupid for you questions. Currently I see that I have the following in the config which means from what I read that I am not in anomaly mode, but in traditional:
>>> 
>>> SecDefaultAction "log,deny,phase:1"
>>> 
>>> So, by your recommendation I understand that I should remove this lines to start using anomaly mode. Then, on every rule I can/ should add with setvar:tx.anomaly_score=5(for example) so I can control it?s score?
>>> 
>>> Also to decrease the false positives as a second step from the setup should I increase the threshold value here - or I am wrong?
>>> 
>>> # Default Inbound Anomaly Threshold Level (rule 900110 in setup.conf)
>>> SecRule &TX:inbound_anomaly_score_threshold "@eq 0" \
>>>    "id:901100,\
>>>    phase:1,\
>>>    pass,\
>>>    nolog,\
>>>    setvar:tx.inbound_anomaly_score_threshold=5"
>>> 
>>> 
>>> 
>>>> On Aug 15, 2017, at 9:52 AM, Christian Folini <christian.folini at netnea.com <mailto:christian.folini at netnea.com>> wrote:
>>>> 
>>>> Hello Georgi,
>>>> 
>>>> CRS3 comes with default rule exclusions for WP and Drupal that solve
>>>> many of the base installations FPs. Collaborating with the project on
>>>> a set of Joomla rule exclusions would be most helpful.
>>>> 
>>>> Starting with a higher anomaly threshold while you weed out the false
>>>> positives is a method that I advocate in my documentation.
>>>> 
>>>> Making sure that you do not base your tuning efforts on attack traffic
>>>> is an obvious problems. There are multiple approaches to this, and none
>>>> of them is hard science. I usually try to start off with tuning based on
>>>> known IP ranges.
>>>> 
>>>> This is all discussed in great detail in the series of ModSecurity
>>>> tutorials at https://www.netnea.com/cms/apache-tutorials/ <https://www.netnea.com/cms/apache-tutorials/>
>>>> 
>>>> Besides, I am also running two public ModSec courses in October.
>>>> 
>>>> Good luck!
>>>> 
>>>> Christian
>>>> 
>>>> 
>>>> On Mon, Aug 14, 2017 at 03:29:39PM +0300, Georgi Georgiev wrote:
>>>>> Hello,
>>>>> I am deploying mod security with nginx in shared hosting environment and most of the websites are Wordpress, Joomla and drupal. I don?t want to rewrite all the rules of owasp to minimize the false positives. Also, I searched for specific for Wordpress or Joomla ruleset but couldn?t find such thing (it would be very resourceful to research for every Wordpress and Joomla hack, even the most famouse one and to write rules about it, also to read how to write rules :)). Even, if I put mod security initially in a mode that does not block , only to log it would be very hard to see very queer if it?s false positive or whether it come from evil sources.
>>>>> 
>>>>> I read that right practice is to change the score of the anomaly but didn?t understand it at all.
>>>>> 
>>>>> So, I would like to ask you how you deal with this? I know that false positives will be there all the time, but how you minimize them? Write your own ruleset? Is there any paid ruleset that you can recommend (it think that I found only one paid and many people cry from it). Just I want to explain me the process you follow with the rules :)
>>>>> 
>>>>> Thank you in advance!
>>>>> _______________________________________________
>>>>> Owasp-modsecurity-core-rule-set mailing list
>>>>> Owasp-modsecurity-core-rule-set at lists.owasp.org <mailto:Owasp-modsecurity-core-rule-set at lists.owasp.org>
>>>>> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>>>> 
>>>> -- 
>>>> https://www.feistyduck.com/books/modsecurity-handbook/ <https://www.feistyduck.com/books/modsecurity-handbook/>
>>>> mailto:christian.folini at netnea.com
>>>> twitter: @ChrFolini
>>> 
>> 
>> -- 
>> ModSecurity courses Oct 2017 in London and Zurich
>> https://www.feistyduck.com/training/modsecurity-training-course <https://www.feistyduck.com/training/modsecurity-training-course>
>> https://www.feistyduck.com/books/modsecurity-handbook/
>> mailto:christian.folini at netnea.com
>> twitter: @ChrFolini
> 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20170817/49550723/attachment.html>

From christian.folini at netnea.com  Fri Aug 18 08:29:53 2017
From: christian.folini at netnea.com (Christian Folini)
Date: Fri, 18 Aug 2017 10:29:53 +0200
Subject: [Owasp-modsecurity-core-rule-set] What is the right process of
 dealing with the false postivies
In-Reply-To: <B2B6B510-33B9-4F8F-B01B-F1B34BB572B6@serversolution.info>
References: <A4DFF44F-FE36-46BE-BD21-F7DA2AA25660@serversolution.info>
	<20170815065250.tjfcwjp36gkrmdh2@leander>
	<CC9D96A5-6F02-4E32-B923-12C52CA1BA20@serversolution.info>
	<20170815125527.fvixwduthihq2obp@leander>
	<22553B46-BD02-493D-9DB2-92D28E858532@serversolution.info>
	<B2B6B510-33B9-4F8F-B01B-F1B34BB572B6@serversolution.info>
Message-ID: <20170818082953.f3kccas5yt3l7r35@leander>

Hey Georgi,

On Thu, Aug 17, 2017 at 07:27:49PM +0300, Georgi Georgiev wrote:
>     1. Is really paranoia level 1 less false postitive for a shared hosting
>    environment and in such time enough for protection? 

That depends on your assessment of your data, its value and the threat
model.

I think PL1 is base level of security, PL2 is security for data with
some value, PL3 is online banking, PL4 is nuclear power plant. Just as a
rough guidance. ;)


> Does it protect from
>    sql injection and xss as I read that they are included in paranoia level2?

Yes, the biggest part of the SQLi protection is the use of the
libinjection library that is included in PL1.

>    What is the best practice - initially start with paranoia level 1, tune it
>    and then switch to 2?

That is a very good question. In fact if you aim to run in PL2, it is
far easier to start in PL2 immediately and then tune down. The problem
is that if you run in PL1 and have tuned the service to a hard blocking
setting, the enabling of PL2 will bring you new rules, new false
positives and legitimate users being blocked.

>    2. What is your anomaly inbound score set? Have you changed it to
>    something other than 5 or you leaved it to 5 and changed the score of the
>    rules?

For a productive system it should be 5. After the tuning.

>    3. I am not sure how to tune the tx.score for every rule in the OWASP as
>    they are with variables such as follow:
>      SecRule IP:REPUT_BLOCK_FLAG "@eq 1" \
>        "setvar:tx.anomaly_score=+%{tx.critical_anomaly_score},\
>       
>    setvar:tx.%{rule.id}-AUTOMATION/MALICIOUS-%{matched_var_name}=%{matched_var}"
>    Is this the correct default scores for the specific rulesets and attacks
>    that I should tune?

Don't touch the rules. You only want to change the anomaly score limit
in the crs-setup.conf file - and then create your rule exclusions as
documented in the tutorials.

>    4. Should I adjust the percentage of requests that are funnelled into the
>    Core Rules below 100 as it?**s recommended on some pages? Does this affect
>    the false positives or only the performance?

This is a feature that is only useful when gauging the performance
impact of ModSec / CRS. You definitely need to have this at 100 or an
attacker can submit an exploit n times and eventually he will bypasss
the rule set based on your sampling rate being below 100%.

Ahoj,

Christian


-- 
History teaches us that men and nations behave wisely once they have
exhausted all other alternatives.
-- Abba Eban

From christian.folini at netnea.com  Tue Aug 22 14:49:33 2017
From: christian.folini at netnea.com (Christian Folini)
Date: Tue, 22 Aug 2017 16:49:33 +0200
Subject: [Owasp-modsecurity-core-rule-set] Announcing www.coreruleset.org
	and new project logo
Message-ID: <20170822144933.6zvxtzqtp7p7bk75@leander>

Dear all,

The OWASP ModSecurity Core Rule Set project is proud to present
its own website:

https://www.coreruleset.org

The information about CRS has been scattered over almost half a dozen
sites (OWASP wiki, Spiderlabs blog, github, modsecurity.org, netnea.com
website, etc.) during the years and new users have a hard time finding
the documentation they need. The idea of the project is to establish
coreruleset.org website as the go-to place for all things CRS. We thank
Walter Hop for the work he invested into this site on behalf of our
project.

An open source project needs a logo and following the success of the
CRS3 release poster, we decided that it's time to come up with a
professional logo for CRS. Hugo Costa, who also designed the release
poster, has created our new logo.

The logo comes with several different variants. The full blown version
is this:

https://coreruleset.org/assets/uploads/2017/08/CRS-logo-full__size-820x350.png

A simpler version is this one with only the symbol plus CRS:

https://coreruleset.org/assets/uploads/2017/08/CRS-logo-CRS__size-512x710.png

So what's the idea of the logo? We have the OWASP wasp in the center.
The wasp is protecting itself, but there is an outer ring made up from
three sectors. This is the 1st line of defense, the Core Rule Set.
Three sectors because of CRS3.

"The 1st Line of Defense" is also our claim. "Claim" is a marketing
term that tries to transport the core message of a product. Our idea
is that CRS should be be installed on every webserver as a simple yet
effective security measure that takes out 80% of the attacks with 
minimal hassle - like a "1st Line of Defense".

But back to the website. The information you will find so far is very 
limited. But it is meant to grow fast as there are many sources we
can pull from and a lot of knowledge in the team. We have the plan to
publish blog posts regularly and we welcome interested community members
to share their knowledge, tricks, success stories or newsworthy items
on our blog.

Kirk Jackson makes a start with a summary of his solution to apply
CRS only to an individual parameter on a single path:

https://coreruleset.org/20170821/running-crs-rules-only-on-certain-parameters/

Project lead Chaim Sanders explains the idea behind the new FTW project,
a Framework for Testing WAFs that we started to use as a base for our
CRS unit tests:

https://coreruleset.org/20170810/testing-wafs-ftw-version-1-0-released/

Please help us spread the word about our new website and about CRS in
general. Feel free to use our logo in your presentations or on your
website. There is a zip file with all variants in multiple sizes at

https://www.owasp.org/index.php/ModSecurity_CRS_Logo                                                          

We will put this on the new site too as soon as we receive the SVG
version of the logo.

Best regards,

Christian Folini, for the CRS team

-- 
ModSecurity courses Oct 2017 in London and Zurich
https://www.feistyduck.com/training/modsecurity-training-course
https://www.feistyduck.com/books/modsecurity-handbook/
mailto:christian.folini at netnea.com
twitter: @ChrFolini










-- 
ModSecurity courses Oct 2017 in London and Zurich
https://www.feistyduck.com/training/modsecurity-training-course
https://www.feistyduck.com/books/modsecurity-handbook/
mailto:christian.folini at netnea.com
twitter: @ChrFolini

From georgi at serversolution.info  Tue Aug 22 15:16:50 2017
From: georgi at serversolution.info (Georgi Georgiev)
Date: Tue, 22 Aug 2017 18:16:50 +0300
Subject: [Owasp-modsecurity-core-rule-set] 400 bad request when owasp is
	enabled in detection only mode - why?
Message-ID: <89B1338F-2D6D-4322-9B99-2EE1F07193F2@serversolution.info>

Hello,
If I enable crs for this domain on the Joomla search of the site it returns 400 bad request, but the modsec is in detection only mode. No rule is matched as I see. If I turn off the modsec everything is ok. This is the audit log if it helps: 

[22/Aug/2017:17:08:15 +0300] IcAcAcVcAcccAcAcAAxcAcAc 77.70.108.119 53428 127.0.0.1 80
--bc7c6349-B--
POST /index.php HTTP/2.0
host: www.plevensport.eu
content-length: 86
cache-control: max-age=0
origin: https://www.plevensport.eu
upgrade-insecure-requests: 1
user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.101 Safari/537.36
content-type: application/x-www-form-urlencoded
accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8
referer: https://www.plevensport.eu/index.php
accept-encoding: gzip, deflate, br
accept-language: en-US,en;q=0.8
cookie: 53f8f9fad3d3789bffbdbce160246b7e=3b72edc95ab809ce6dc6b3755305adf1; __utmt=1; _c=y; __utma=155943930.1578748701.1503409083.1503409083.1503409083.1; __utmb=155943930.9.10.1503409083; __utmc=155943930; __utmz=155943930.1503409083.1.1.utmcsr=(direct)|utmccn=(direct)|utmcmd=(none)

--bc7c6349-C--
searchword=%D0%BF%D0%BB%D0%B5%D0%B2%D0%B5%D0%BD&task=search&option=com_search&Itemid=1
--bc7c6349-F--
HTTP/1.1 400
Server: ws-httpd
Content-Type: text/html
Content-Length: 568
Connection: close

--bc7c6349-E--
<html>
<head><title>400 Bad Request</title></head>
<body bgcolor="white">
<center><h1>400 Bad Request</h1></center>
<hr><center>nginx</center>
</body>
</html>
<!-- a padding to disable MSIE and Chrome friendly error page -->
<!-- a padding to disable MSIE and Chrome friendly error page -->
<!-- a padding to disable MSIE and Chrome friendly error page -->
<!-- a padding to disable MSIE and Chrome friendly error page -->
<!-- a padding to disable MSIE and Chrome friendly error page -->
<!-- a padding to disable MSIE and Chrome friendly error page -->

--bc7c6349-H--
Message: Audit log: Failed to lock global mutex: Permission denied
Apache-Handler: IIS
Stopwatch: 1503410895000281 417063 (- - -)
Stopwatch2: 1503410895000281 417063; combined=44304, p1=732, p2=42473, p3=47, p4=723, p5=229, sr=148, sw=100, l=0, gc=0
Response-Body-Transformed: Dechunked
Producer: ModSecurity for nginx (STABLE)/2.9.1 (http://www.modsecurity.org/); OWASP_CRS/3.0.2.
Server: ModSecurity Standalone
Engine-Mode: "ENABLED"

--bc7c6349-Z--

As it?s not exactly error which can occur because of modsec but it?s obviously the problem what can be the reason? Some directive?
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20170822/f7df9c03/attachment.html>

From georgi at serversolution.info  Tue Aug 22 16:27:11 2017
From: georgi at serversolution.info (Georgi Georgiev)
Date: Tue, 22 Aug 2017 19:27:11 +0300
Subject: [Owasp-modsecurity-core-rule-set] 400 bad request when owasp is
 enabled in detection only mode - why?
In-Reply-To: <89B1338F-2D6D-4322-9B99-2EE1F07193F2@serversolution.info>
References: <89B1338F-2D6D-4322-9B99-2EE1F07193F2@serversolution.info>
Message-ID: <D71DEB58-75BD-433A-8E96-639F28777182@serversolution.info>

If I comment this line everything works:

SecRequestBodyAccess On


But this should be enabled. Any suggestions?

> On Aug 22, 2017, at 6:16 PM, Georgi Georgiev <georgi at serversolution.info> wrote:
> 
> Hello,
> If I enable crs for this domain on the Joomla search of the site it returns 400 bad request, but the modsec is in detection only mode. No rule is matched as I see. If I turn off the modsec everything is ok. This is the audit log if it helps: 
> 
> [22/Aug/2017:17:08:15 +0300] IcAcAcVcAcccAcAcAAxcAcAc 77.70.108.119 53428 127.0.0.1 80
> --bc7c6349-B--
> POST /index.php HTTP/2.0
> host: www.plevensport.eu <http://www.plevensport.eu/>
> content-length: 86
> cache-control: max-age=0
> origin: https://www.plevensport.eu <https://www.plevensport.eu/>
> upgrade-insecure-requests: 1
> user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.101 Safari/537.36
> content-type: application/x-www-form-urlencoded
> accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8
> referer: https://www.plevensport.eu/index.php <https://www.plevensport.eu/index.php>
> accept-encoding: gzip, deflate, br
> accept-language: en-US,en;q=0.8
> cookie: 53f8f9fad3d3789bffbdbce160246b7e=3b72edc95ab809ce6dc6b3755305adf1; __utmt=1; _c=y; __utma=155943930.1578748701.1503409083.1503409083.1503409083.1; __utmb=155943930.9.10.1503409083; __utmc=155943930; __utmz=155943930.1503409083.1.1.utmcsr=(direct)|utmccn=(direct)|utmcmd=(none)
> 
> --bc7c6349-C--
> searchword=%D0%BF%D0%BB%D0%B5%D0%B2%D0%B5%D0%BD&task=search&option=com_search&Itemid=1
> --bc7c6349-F--
> HTTP/1.1 400
> Server: ws-httpd
> Content-Type: text/html
> Content-Length: 568
> Connection: close
> 
> --bc7c6349-E--
> <html>
> <head><title>400 Bad Request</title></head>
> <body bgcolor="white">
> <center><h1>400 Bad Request</h1></center>
> <hr><center>nginx</center>
> </body>
> </html>
> <!-- a padding to disable MSIE and Chrome friendly error page -->
> <!-- a padding to disable MSIE and Chrome friendly error page -->
> <!-- a padding to disable MSIE and Chrome friendly error page -->
> <!-- a padding to disable MSIE and Chrome friendly error page -->
> <!-- a padding to disable MSIE and Chrome friendly error page -->
> <!-- a padding to disable MSIE and Chrome friendly error page -->
> 
> --bc7c6349-H--
> Message: Audit log: Failed to lock global mutex: Permission denied
> Apache-Handler: IIS
> Stopwatch: 1503410895000281 417063 (- - -)
> Stopwatch2: 1503410895000281 417063; combined=44304, p1=732, p2=42473, p3=47, p4=723, p5=229, sr=148, sw=100, l=0, gc=0
> Response-Body-Transformed: Dechunked
> Producer: ModSecurity for nginx (STABLE)/2.9.1 (http://www.modsecurity.org/ <http://www.modsecurity.org/>); OWASP_CRS/3.0.2.
> Server: ModSecurity Standalone
> Engine-Mode: "ENABLED"
> 
> --bc7c6349-Z--
> 
> As it?s not exactly error which can occur because of modsec but it?s obviously the problem what can be the reason? Some directive?
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20170822/a0ec1bc2/attachment-0001.html>

From christian.folini at netnea.com  Tue Aug 22 16:53:40 2017
From: christian.folini at netnea.com (Christian Folini)
Date: Tue, 22 Aug 2017 18:53:40 +0200
Subject: [Owasp-modsecurity-core-rule-set] 400 bad request when owasp is
 enabled in detection only mode - why?
In-Reply-To: <D71DEB58-75BD-433A-8E96-639F28777182@serversolution.info>
References: <89B1338F-2D6D-4322-9B99-2EE1F07193F2@serversolution.info>
	<D71DEB58-75BD-433A-8E96-639F28777182@serversolution.info>
Message-ID: <20170822165340.xc7hjedaakdrawzh@leander>

Hey Georgi,

The

"Message: Audit log: Failed to lock global mutex: Permission denied"

in combination with the SecRequestBodyAccess is a bad sign.

You should try and solve that permission problem. I would not be
surprised if it would be linked.

Ahoj,

Christian


On Tue, Aug 22, 2017 at 07:27:11PM +0300, Georgi Georgiev wrote:
>    If I comment this line everything works:
>    SecRequestBodyAccess On
>    But this should be enabled. Any suggestions?
> 
>      On Aug 22, 2017, at 6:16 PM, Georgi Georgiev
>      <georgi at serversolution.info> wrote:
>      Hello,
>      If I enable crs for this domain on the Joomla search of the site it
>      returns 400 bad request, but the modsec is in detection only mode. No
>      rule is matched as I see. If I turn off the modsec everything is ok.
>      This is the audit log if it helps: 
>      [22/Aug/2017:17:08:15 +0300] IcAcAcVcAcccAcAcAAxcAcAc 77.70.108.119
>      53428 127.0.0.1 80
>      --bc7c6349-B--
>      POST /index.php HTTP/2.0
>      host: www.plevensport.eu
>      content-length: 86
>      cache-control: max-age=0
>      origin: https://www.plevensport.eu
>      upgrade-insecure-requests: 1
>      user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5)
>      AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.101
>      Safari/537.36
>      content-type: application/x-www-form-urlencoded
>      accept:
>      text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8
>      referer: https://www.plevensport.eu/index.php
>      accept-encoding: gzip, deflate, br
>      accept-language: en-US,en;q=0.8
>      cookie:
>      53f8f9fad3d3789bffbdbce160246b7e=3b72edc95ab809ce6dc6b3755305adf1;
>      __utmt=1; _c=y;
>      __utma=155943930.1578748701.1503409083.1503409083.1503409083.1;
>      __utmb=155943930.9.10.1503409083; __utmc=155943930;
>      __utmz=155943930.1503409083.1.1.utmcsr=(direct)|utmccn=(direct)|utmcmd=(none)
>      --bc7c6349-C--
>      searchword=%D0%BF%D0%BB%D0%B5%D0%B2%D0%B5%D0%BD&task=search&option=com_search&Itemid=1
>      --bc7c6349-F--
>      HTTP/1.1 400
>      Server: ws-httpd
>      Content-Type: text/html
>      Content-Length: 568
>      Connection: close
>      --bc7c6349-E--
>      <html>
>      <head><title>400 Bad Request</title></head>
>      <body bgcolor="white">
>      <center><h1>400 Bad Request</h1></center>
>      <hr><center>nginx</center>
>      </body>
>      </html>
>      <!-- a padding to disable MSIE and Chrome friendly error page -->
>      <!-- a padding to disable MSIE and Chrome friendly error page -->
>      <!-- a padding to disable MSIE and Chrome friendly error page -->
>      <!-- a padding to disable MSIE and Chrome friendly error page -->
>      <!-- a padding to disable MSIE and Chrome friendly error page -->
>      <!-- a padding to disable MSIE and Chrome friendly error page -->
>      --bc7c6349-H--
>      Message: Audit log: Failed to lock global mutex: Permission denied
>      Apache-Handler: IIS
>      Stopwatch: 1503410895000281 417063 (- - -)
>      Stopwatch2: 1503410895000281 417063; combined=44304, p1=732, p2=42473,
>      p3=47, p4=723, p5=229, sr=148, sw=100, l=0, gc=0
>      Response-Body-Transformed: Dechunked
>      Producer: ModSecurity for nginx (STABLE)/2.9.1
>      (http://www.modsecurity.org/); OWASP_CRS/3.0.2.
>      Server: ModSecurity Standalone
>      Engine-Mode: "ENABLED"
>      --bc7c6349-Z--
>      As it?**s not exactly error which can occur because of modsec but it?**s
>      obviously the problem what can be the reason? Some directive?
>      _______________________________________________
>      Owasp-modsecurity-core-rule-set mailing list
>      Owasp-modsecurity-core-rule-set at lists.owasp.org
>      https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set

> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set


-- 
ModSecurity courses Oct 2017 in London and Zurich
https://www.feistyduck.com/training/modsecurity-training-course
https://www.feistyduck.com/books/modsecurity-handbook/
mailto:christian.folini at netnea.com
twitter: @ChrFolini

From georgi at serversolution.info  Tue Aug 22 16:55:17 2017
From: georgi at serversolution.info (Georgi Georgiev)
Date: Tue, 22 Aug 2017 19:55:17 +0300
Subject: [Owasp-modsecurity-core-rule-set] 400 bad request when owasp is
 enabled in detection only mode - why?
In-Reply-To: <20170822165340.xc7hjedaakdrawzh@leander>
References: <89B1338F-2D6D-4322-9B99-2EE1F07193F2@serversolution.info>
	<D71DEB58-75BD-433A-8E96-639F28777182@serversolution.info>
	<20170822165340.xc7hjedaakdrawzh@leander>
Message-ID: <3FFB7423-8411-4BF3-9FFB-38F54559A384@serversolution.info>

As I read I think the problem is related to this. Don?t you think so?

https://www.bountysource.com/issues/1573623-nginx-with-modsecurity-post-request-gives-500-error <https://www.bountysource.com/issues/1573623-nginx-with-modsecurity-post-request-gives-500-error>

> On Aug 22, 2017, at 7:53 PM, Christian Folini <christian.folini at netnea.com> wrote:
> 
> Hey Georgi,
> 
> The
> 
> "Message: Audit log: Failed to lock global mutex: Permission denied"
> 
> in combination with the SecRequestBodyAccess is a bad sign.
> 
> You should try and solve that permission problem. I would not be
> surprised if it would be linked.
> 
> Ahoj,
> 
> Christian
> 
> 
> On Tue, Aug 22, 2017 at 07:27:11PM +0300, Georgi Georgiev wrote:
>>   If I comment this line everything works:
>>   SecRequestBodyAccess On
>>   But this should be enabled. Any suggestions?
>> 
>>     On Aug 22, 2017, at 6:16 PM, Georgi Georgiev
>>     <georgi at serversolution.info> wrote:
>>     Hello,
>>     If I enable crs for this domain on the Joomla search of the site it
>>     returns 400 bad request, but the modsec is in detection only mode. No
>>     rule is matched as I see. If I turn off the modsec everything is ok.
>>     This is the audit log if it helps: 
>>     [22/Aug/2017:17:08:15 +0300] IcAcAcVcAcccAcAcAAxcAcAc 77.70.108.119
>>     53428 127.0.0.1 80
>>     --bc7c6349-B--
>>     POST /index.php HTTP/2.0
>>     host: www.plevensport.eu
>>     content-length: 86
>>     cache-control: max-age=0
>>     origin: https://www.plevensport.eu
>>     upgrade-insecure-requests: 1
>>     user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5)
>>     AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.101
>>     Safari/537.36
>>     content-type: application/x-www-form-urlencoded
>>     accept:
>>     text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8
>>     referer: https://www.plevensport.eu/index.php
>>     accept-encoding: gzip, deflate, br
>>     accept-language: en-US,en;q=0.8
>>     cookie:
>>     53f8f9fad3d3789bffbdbce160246b7e=3b72edc95ab809ce6dc6b3755305adf1;
>>     __utmt=1; _c=y;
>>     __utma=155943930.1578748701.1503409083.1503409083.1503409083.1;
>>     __utmb=155943930.9.10.1503409083; __utmc=155943930;
>>     __utmz=155943930.1503409083.1.1.utmcsr=(direct)|utmccn=(direct)|utmcmd=(none)
>>     --bc7c6349-C--
>>     searchword=%D0%BF%D0%BB%D0%B5%D0%B2%D0%B5%D0%BD&task=search&option=com_search&Itemid=1
>>     --bc7c6349-F--
>>     HTTP/1.1 400
>>     Server: ws-httpd
>>     Content-Type: text/html
>>     Content-Length: 568
>>     Connection: close
>>     --bc7c6349-E--
>>     <html>
>>     <head><title>400 Bad Request</title></head>
>>     <body bgcolor="white">
>>     <center><h1>400 Bad Request</h1></center>
>>     <hr><center>nginx</center>
>>     </body>
>>     </html>
>>     <!-- a padding to disable MSIE and Chrome friendly error page -->
>>     <!-- a padding to disable MSIE and Chrome friendly error page -->
>>     <!-- a padding to disable MSIE and Chrome friendly error page -->
>>     <!-- a padding to disable MSIE and Chrome friendly error page -->
>>     <!-- a padding to disable MSIE and Chrome friendly error page -->
>>     <!-- a padding to disable MSIE and Chrome friendly error page -->
>>     --bc7c6349-H--
>>     Message: Audit log: Failed to lock global mutex: Permission denied
>>     Apache-Handler: IIS
>>     Stopwatch: 1503410895000281 417063 (- - -)
>>     Stopwatch2: 1503410895000281 417063; combined=44304, p1=732, p2=42473,
>>     p3=47, p4=723, p5=229, sr=148, sw=100, l=0, gc=0
>>     Response-Body-Transformed: Dechunked
>>     Producer: ModSecurity for nginx (STABLE)/2.9.1
>>     (http://www.modsecurity.org/); OWASP_CRS/3.0.2.
>>     Server: ModSecurity Standalone
>>     Engine-Mode: "ENABLED"
>>     --bc7c6349-Z--
>>     As it?**s not exactly error which can occur because of modsec but it?**s
>>     obviously the problem what can be the reason? Some directive?
>>     _______________________________________________
>>     Owasp-modsecurity-core-rule-set mailing list
>>     Owasp-modsecurity-core-rule-set at lists.owasp.org
>>     https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
> 
>> _______________________________________________
>> Owasp-modsecurity-core-rule-set mailing list
>> Owasp-modsecurity-core-rule-set at lists.owasp.org
>> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
> 
> 
> -- 
> ModSecurity courses Oct 2017 in London and Zurich
> https://www.feistyduck.com/training/modsecurity-training-course
> https://www.feistyduck.com/books/modsecurity-handbook/
> mailto:christian.folini at netnea.com
> twitter: @ChrFolini

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20170822/e53acc8d/attachment.html>

From chaim at chaimsanders.com  Tue Aug 22 17:06:00 2017
From: chaim at chaimsanders.com (Chaim Sanders)
Date: Tue, 22 Aug 2017 13:06:00 -0400
Subject: [Owasp-modsecurity-core-rule-set] 400 bad request when owasp is
 enabled in detection only mode - why?
In-Reply-To: <3FFB7423-8411-4BF3-9FFB-38F54559A384@serversolution.info>
References: <89B1338F-2D6D-4322-9B99-2EE1F07193F2@serversolution.info>
	<D71DEB58-75BD-433A-8E96-639F28777182@serversolution.info>
	<20170822165340.xc7hjedaakdrawzh@leander>
	<3FFB7423-8411-4BF3-9FFB-38F54559A384@serversolution.info>
Message-ID: <CAE8hE=o+oD7PUvuLTFsoTemTqmP1e9kwc_t-k772NnLG-b7Kdw@mail.gmail.com>

If you are using ModSecurity 2.x on Nginx there are known issues with
request body processing in many situations, make sure to try 2.9.2.
ModSecurity 3.x is being developed to solve these issues.

On Tue, Aug 22, 2017 at 12:55 PM, Georgi Georgiev <
georgi at serversolution.info> wrote:

> As I read I think the problem is related to this. Don?t you think so?
>
> https://www.bountysource.com/issues/1573623-nginx-with-
> modsecurity-post-request-gives-500-error
>
> On Aug 22, 2017, at 7:53 PM, Christian Folini <christian.folini at netnea.com>
> wrote:
>
> Hey Georgi,
>
> The
>
> "Message: Audit log: Failed to lock global mutex: Permission denied"
>
> in combination with the SecRequestBodyAccess is a bad sign.
>
> You should try and solve that permission problem. I would not be
> surprised if it would be linked.
>
> Ahoj,
>
> Christian
>
>
> On Tue, Aug 22, 2017 at 07:27:11PM +0300, Georgi Georgiev wrote:
>
>   If I comment this line everything works:
>   SecRequestBodyAccess On
>   But this should be enabled. Any suggestions?
>
>     On Aug 22, 2017, at 6:16 PM, Georgi Georgiev
>     <georgi at serversolution.info> wrote:
>     Hello,
>     If I enable crs for this domain on the Joomla search of the site it
>     returns 400 bad request, but the modsec is in detection only mode. No
>     rule is matched as I see. If I turn off the modsec everything is ok.
>     This is the audit log if it helps:
>     [22/Aug/2017:17:08:15 +0300] IcAcAcVcAcccAcAcAAxcAcAc 77.70.108.119
>     53428 127.0.0.1 80
>     --bc7c6349-B--
>     POST /index.php HTTP/2.0
>     host: www.plevensport.eu
>     content-length: 86
>     cache-control: max-age=0
>     origin: https://www.plevensport.eu
>     upgrade-insecure-requests: 1
>     user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5)
>     AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.101
>     Safari/537.36
>     content-type: application/x-www-form-urlencoded
>     accept:
>     text/html,application/xhtml+xml,application/xml;q=0.
> 9,image/webp,image/apng,*/*;q=0.8
>     referer: https://www.plevensport.eu/index.php
>     accept-encoding: gzip, deflate, br
>     accept-language: en-US,en;q=0.8
>     cookie:
>     53f8f9fad3d3789bffbdbce160246b7e=3b72edc95ab809ce6dc6b3755305adf1;
>     __utmt=1; _c=y;
>     __utma=155943930.1578748701.1503409083.1503409083.1503409083.1;
>     __utmb=155943930.9.10.1503409083; __utmc=155943930;
>     __utmz=155943930.1503409083.1.1.utmcsr=(direct)
> |utmccn=(direct)|utmcmd=(none)
>     --bc7c6349-C--
>     searchword=%D0%BF%D0%BB%D0%B5%D0%B2%D0%B5%D0%BD&task=
> search&option=com_search&Itemid=1
>     --bc7c6349-F--
>     HTTP/1.1 400
>     Server: ws-httpd
>     Content-Type: text/html
>     Content-Length: 568
>     Connection: close
>     --bc7c6349-E--
>     <html>
>     <head><title>400 Bad Request</title></head>
>     <body bgcolor="white">
>     <center><h1>400 Bad Request</h1></center>
>     <hr><center>nginx</center>
>     </body>
>     </html>
>     <!-- a padding to disable MSIE and Chrome friendly error page -->
>     <!-- a padding to disable MSIE and Chrome friendly error page -->
>     <!-- a padding to disable MSIE and Chrome friendly error page -->
>     <!-- a padding to disable MSIE and Chrome friendly error page -->
>     <!-- a padding to disable MSIE and Chrome friendly error page -->
>     <!-- a padding to disable MSIE and Chrome friendly error page -->
>     --bc7c6349-H--
>     Message: Audit log: Failed to lock global mutex: Permission denied
>     Apache-Handler: IIS
>     Stopwatch: 1503410895000281 417063 (- - -)
>     Stopwatch2: 1503410895000281 417063; combined=44304, p1=732, p2=42473,
>     p3=47, p4=723, p5=229, sr=148, sw=100, l=0, gc=0
>     Response-Body-Transformed: Dechunked
>     Producer: ModSecurity for nginx (STABLE)/2.9.1
>     (http://www.modsecurity.org/); OWASP_CRS/3.0.2.
>     Server: ModSecurity Standalone
>     Engine-Mode: "ENABLED"
>     --bc7c6349-Z--
>     As it?**s not exactly error which can occur because of modsec but
> it?**s
>     obviously the problem what can be the reason? Some directive?
>     _______________________________________________
>     Owasp-modsecurity-core-rule-set mailing list
>     Owasp-modsecurity-core-rule-set at lists.owasp.org
>     https://lists.owasp.org/mailman/listinfo/owasp-
> modsecurity-core-rule-set
>
>
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>
>
>
> --
> ModSecurity courses Oct 2017 in London and Zurich
> https://www.feistyduck.com/training/modsecurity-training-course
> https://www.feistyduck.com/books/modsecurity-handbook/
> mailto:christian.folini at netnea.com
> twitter: @ChrFolini
>
>
>
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>
>


-- 
-- 
Chaim Sanders
http://www.ChaimSanders.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20170822/36fa43c5/attachment-0001.html>

From georgi at serversolution.info  Tue Aug 22 19:28:56 2017
From: georgi at serversolution.info (Georgi Georgiev)
Date: Tue, 22 Aug 2017 22:28:56 +0300
Subject: [Owasp-modsecurity-core-rule-set] 400 bad request when owasp is
 enabled in detection only mode - why?
In-Reply-To: <CAE8hE=o+oD7PUvuLTFsoTemTqmP1e9kwc_t-k772NnLG-b7Kdw@mail.gmail.com>
References: <89B1338F-2D6D-4322-9B99-2EE1F07193F2@serversolution.info>
	<D71DEB58-75BD-433A-8E96-639F28777182@serversolution.info>
	<20170822165340.xc7hjedaakdrawzh@leander>
	<3FFB7423-8411-4BF3-9FFB-38F54559A384@serversolution.info>
	<CAE8hE=o+oD7PUvuLTFsoTemTqmP1e9kwc_t-k772NnLG-b7Kdw@mail.gmail.com>
Message-ID: <66B57675-C76B-4215-AB00-B516F0B3632D@serversolution.info>

I fixed the mutex error by changing the log type to concurrent, but it does not solved the problem with 400 bad request, also then there is another error in nginx (maybe not related to the bad request but not sure):

2017/08/22 22:17:49 [alert] 29957#0: *1 zero size buf in writer t:1 r:0 f:0 00000000039898E0 00000000039898E9-00000000039898E9 0000000000000000 0-0 while sending to client, client: 1.1.1.1, server: plevensport.elektrostil.com, request: "GET /favicon.ico HTTP/2.0", upstream: "https://2.2.2.2:8443/favicon.ico", host: "www.domain.eu", referrer: "https://www.domain.eu/index.php?


I am not sure 2.X version of mod security, but 3 and the problem still appear here.


> On Aug 22, 2017, at 8:06 PM, Chaim Sanders <chaim at chaimsanders.com> wrote:
> 
> If you are using ModSecurity 2.x on Nginx there are known issues with request body processing in many situations, make sure to try 2.9.2. ModSecurity 3.x is being developed to solve these issues. 
> 
> On Tue, Aug 22, 2017 at 12:55 PM, Georgi Georgiev <georgi at serversolution.info <mailto:georgi at serversolution.info>> wrote:
> As I read I think the problem is related to this. Don?t you think so?
> 
> https://www.bountysource.com/issues/1573623-nginx-with-modsecurity-post-request-gives-500-error <https://www.bountysource.com/issues/1573623-nginx-with-modsecurity-post-request-gives-500-error>
> 
>> On Aug 22, 2017, at 7:53 PM, Christian Folini <christian.folini at netnea.com <mailto:christian.folini at netnea.com>> wrote:
>> 
>> Hey Georgi,
>> 
>> The
>> 
>> "Message: Audit log: Failed to lock global mutex: Permission denied"
>> 
>> in combination with the SecRequestBodyAccess is a bad sign.
>> 
>> You should try and solve that permission problem. I would not be
>> surprised if it would be linked.
>> 
>> Ahoj,
>> 
>> Christian
>> 
>> 
>> On Tue, Aug 22, 2017 at 07:27:11PM +0300, Georgi Georgiev wrote:
>>>   If I comment this line everything works:
>>>   SecRequestBodyAccess On
>>>   But this should be enabled. Any suggestions?
>>> 
>>>     On Aug 22, 2017, at 6:16 PM, Georgi Georgiev
>>>     <georgi at serversolution.info <mailto:georgi at serversolution.info>> wrote:
>>>     Hello,
>>>     If I enable crs for this domain on the Joomla search of the site it
>>>     returns 400 bad request, but the modsec is in detection only mode. No
>>>     rule is matched as I see. If I turn off the modsec everything is ok.
>>>     This is the audit log if it helps: 
>>>     [22/Aug/2017:17:08:15 +0300] IcAcAcVcAcccAcAcAAxcAcAc 77.70.108.119
>>>     53428 127.0.0.1 80
>>>     --bc7c6349-B--
>>>     POST /index.php HTTP/2.0
>>>     host: www.plevensport.eu <http://www.plevensport.eu/>
>>>     content-length: 86
>>>     cache-control: max-age=0
>>>     origin: https://www.plevensport.eu <https://www.plevensport.eu/>
>>>     upgrade-insecure-requests: 1
>>>     user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5)
>>>     AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.101
>>>     Safari/537.36
>>>     content-type: application/x-www-form-urlencoded
>>>     accept:
>>>     text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8
>>>     referer: https://www.plevensport.eu/index.php <https://www.plevensport.eu/index.php>
>>>     accept-encoding: gzip, deflate, br
>>>     accept-language: en-US,en;q=0.8
>>>     cookie:
>>>     53f8f9fad3d3789bffbdbce160246b7e=3b72edc95ab809ce6dc6b3755305adf1;
>>>     __utmt=1; _c=y;
>>>     __utma=155943930.1578748701.1503409083.1503409083.1503409083.1;
>>>     __utmb=155943930.9.10.1503409083; __utmc=155943930;
>>>     __utmz=155943930.1503409083.1.1.utmcsr=(direct)|utmccn=(direct)|utmcmd=(none)
>>>     --bc7c6349-C--
>>>     searchword=%D0%BF%D0%BB%D0%B5%D0%B2%D0%B5%D0%BD&task=search&option=com_search&Itemid=1
>>>     --bc7c6349-F--
>>>     HTTP/1.1 400
>>>     Server: ws-httpd
>>>     Content-Type: text/html
>>>     Content-Length: 568
>>>     Connection: close
>>>     --bc7c6349-E--
>>>     <html>
>>>     <head><title>400 Bad Request</title></head>
>>>     <body bgcolor="white">
>>>     <center><h1>400 Bad Request</h1></center>
>>>     <hr><center>nginx</center>
>>>     </body>
>>>     </html>
>>>     <!-- a padding to disable MSIE and Chrome friendly error page -->
>>>     <!-- a padding to disable MSIE and Chrome friendly error page -->
>>>     <!-- a padding to disable MSIE and Chrome friendly error page -->
>>>     <!-- a padding to disable MSIE and Chrome friendly error page -->
>>>     <!-- a padding to disable MSIE and Chrome friendly error page -->
>>>     <!-- a padding to disable MSIE and Chrome friendly error page -->
>>>     --bc7c6349-H--
>>>     Message: Audit log: Failed to lock global mutex: Permission denied
>>>     Apache-Handler: IIS
>>>     Stopwatch: 1503410895000281 417063 (- - -)
>>>     Stopwatch2: 1503410895000281 417063; combined=44304, p1=732, p2=42473,
>>>     p3=47, p4=723, p5=229, sr=148, sw=100, l=0, gc=0
>>>     Response-Body-Transformed: Dechunked
>>>     Producer: ModSecurity for nginx (STABLE)/2.9.1
>>>     (http://www.modsecurity.org/ <http://www.modsecurity.org/>); OWASP_CRS/3.0.2. <http://3.0.0.2/>
>>>     Server: ModSecurity Standalone
>>>     Engine-Mode: "ENABLED"
>>>     --bc7c6349-Z--
>>>     As it?**s not exactly error which can occur because of modsec but it?**s
>>>     obviously the problem what can be the reason? Some directive?
>>>     _______________________________________________
>>>     Owasp-modsecurity-core-rule-set mailing list
>>>     Owasp-modsecurity-core-rule-set at lists.owasp.org <mailto:Owasp-modsecurity-core-rule-set at lists.owasp.org>
>>>     https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set <https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set>
>> 
>>> _______________________________________________
>>> Owasp-modsecurity-core-rule-set mailing list
>>> Owasp-modsecurity-core-rule-set at lists.owasp.org <mailto:Owasp-modsecurity-core-rule-set at lists.owasp.org>
>>> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set <https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set>
>> 
>> 
>> -- 
>> ModSecurity courses Oct 2017 in London and Zurich
>> https://www.feistyduck.com/training/modsecurity-training-course <https://www.feistyduck.com/training/modsecurity-training-course>
>> https://www.feistyduck.com/books/modsecurity-handbook/ <https://www.feistyduck.com/books/modsecurity-handbook/>
>> mailto:christian.folini at netnea.com <mailto:christian.folini at netnea.com>
>> twitter: @ChrFolini
> 
> 
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org <mailto:Owasp-modsecurity-core-rule-set at lists.owasp.org>
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set <https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set>
> 
> 
> 
> 
> -- 
> -- 
> Chaim Sanders
> http://www.ChaimSanders.com <http://www.chaimsanders.com/>

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20170822/40e2ab0e/attachment.html>

From airween at gmail.com  Wed Aug 23 07:30:30 2017
From: airween at gmail.com (Ervin =?utf-8?Q?Heged=C3=BCs?=)
Date: Wed, 23 Aug 2017 09:30:30 +0200
Subject: [Owasp-modsecurity-core-rule-set] File upload problem
Message-ID: <20170823073030.GA21794@arxnet.hu>

Hi folks,

here is a new problem with CRS 3.0(.2). There is an nGinx with
Modsecurity 3.0, and CRS 3.0.2, and an Apache backend, which
serves a webmail (Roundcube).

When I try to import my GPG key through the upload, I got 403
Forbidden answer.

Here are the details:

HTTP req:

POST https://webmail.mydomain.com/?_task=settings&_action=plugin.enigmakeys&_a=import&_unlock=loading1503472197200
...
Content-Length	4443
Content-Type	multipart/form-data; boundary=---------------------------186567636118947579521451609378


HTTP resp:

403 Forbidden

Content of audit.log:

---3U4kCbBk---A--
[23/Aug/2017:09:10:32 +0200] 15034722321.000000 client.ip.addr 51048 client.ip.addr 443
---3U4kCbBk---B--
POST /?_task=settings&_action=plugin.enigmakeys&_a=import&_unlock=loading1503472197200
HTTP/1.1
Connection: keep-alive
Referer: https://webmail.mydomain.com/?_task=settings&_framed=1&_action=plugin.enigmakeys&_a=import
Content-Type: multipart/form-data; boundary=---------------------------186567636118947579521451609378
Accept-Encoding: gzip, deflate, br
Cookie: language=hu; _ga=GA1.2.817NNNNNN.14NNNNNNNN; roundcube_sessid=sessionidtoken; roundcube_sessauth=sessauthidtoken
Content-Length: 4443
Accept-Language: hu-HU,hu;q=0.8,en-US;q=0.5,en;q=0.3
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:55.0) Gecko/20100101 Firefox/55.0
Host: webmail.mydomain.com
Upgrade-Insecure-Requests: 1

---3U4kCbBk---D--

---3U4kCbBk---E--
??(??????HML??)?,?I?310Vp?/J?LII?
...
...
---3U4kCbBk---F--
Server: nginx/1.6.2
Date: Wed, 23 Aug 2017 07:10:32 GMT
Content-Type: text/html
Connection: keep-alive
Content-Encoding: gzip

---3U4kCbBk---H--
ModSecurity: Warning. Matched "Operator `Eq' with parameter `0' against variable `MULTIPART_UNMATCHED_BOUNDARY' (Value: `1' ) [file "/etc/nginx/modsecurity.conf"] [line "66"] [id "200004"] [rev ""] [msg "Multipart parser detected a possible unmatched boundary."] [data ""] [severity "0"] [ver ""] [maturity "0"] [accuracy "0"] [ref "v810,1"]

---3U4kCbBk---I--

---3U4kCbBk---J--

---3U4kCbBk---Z--


Here is the detail of POST request:

-----------------------------186567636118947579521451609378
Content-Disposition: form-data; name="_token"

nEWGe3VUF9R1K7d0SSx4rZRYkYeN849B
-----------------------------186567636118947579521451609378
Content-Disposition: form-data; name="_framed"

1
-----------------------------186567636118947579521451609378
Content-Disposition: form-data; name="_file"; filename="airween_at_gmail.com.asc"
Content-Type: text/plain

-----BEGIN PGP PUBLIC KEY BLOCK-----
Version: GnuPG v1

mQINBFhwuigBEAC+gnmOXXTEtedn5hqcjLirPM6phHGLdeqVUsD0sRDWFjgcoh7b
...
=G+Dl
-----END PGP PUBLIC KEY BLOCK-----

-----------------------------186567636118947579521451609378
Content-Disposition: form-data; name="_search"


-----------------------------186567636118947579521451609378--




This error occures when I upload the .asc file above, when I try
to upload a "simple" csv, or png, everything works as well.



What should I do? How can I fix this error?



Thanks,


a.




From christian.folini at netnea.com  Wed Aug 23 07:54:32 2017
From: christian.folini at netnea.com (Christian Folini)
Date: Wed, 23 Aug 2017 09:54:32 +0200
Subject: [Owasp-modsecurity-core-rule-set] File upload problem
In-Reply-To: <20170823073030.GA21794@arxnet.hu>
References: <20170823073030.GA21794@arxnet.hu>
Message-ID: <20170823075432.obfagmgd6m3ds574@leander>

Hi there,

Is this the full "H" part of the Audit Log?

Are you sure it's not an extension filter defined on the application
itself?

Did you try this without CRS? Without ModSec?

Just questions that mean to guide you...

Ahoj,

Christian

On Wed, Aug 23, 2017 at 09:30:30AM +0200, Ervin Heged?s wrote:
> Hi folks,
> 
> here is a new problem with CRS 3.0(.2). There is an nGinx with
> Modsecurity 3.0, and CRS 3.0.2, and an Apache backend, which
> serves a webmail (Roundcube).
> 
> When I try to import my GPG key through the upload, I got 403
> Forbidden answer.
> 
> Here are the details:
> 
> HTTP req:
> 
> POST https://webmail.mydomain.com/?_task=settings&_action=plugin.enigmakeys&_a=import&_unlock=loading1503472197200
> ...
> Content-Length	4443
> Content-Type	multipart/form-data; boundary=---------------------------186567636118947579521451609378
> 
> 
> HTTP resp:
> 
> 403 Forbidden
> 
> Content of audit.log:
> 
> ---3U4kCbBk---A--
> [23/Aug/2017:09:10:32 +0200] 15034722321.000000 client.ip.addr 51048 client.ip.addr 443
> ---3U4kCbBk---B--
> POST /?_task=settings&_action=plugin.enigmakeys&_a=import&_unlock=loading1503472197200
> HTTP/1.1
> Connection: keep-alive
> Referer: https://webmail.mydomain.com/?_task=settings&_framed=1&_action=plugin.enigmakeys&_a=import
> Content-Type: multipart/form-data; boundary=---------------------------186567636118947579521451609378
> Accept-Encoding: gzip, deflate, br
> Cookie: language=hu; _ga=GA1.2.817NNNNNN.14NNNNNNNN; roundcube_sessid=sessionidtoken; roundcube_sessauth=sessauthidtoken
> Content-Length: 4443
> Accept-Language: hu-HU,hu;q=0.8,en-US;q=0.5,en;q=0.3
> Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
> User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:55.0) Gecko/20100101 Firefox/55.0
> Host: webmail.mydomain.com
> Upgrade-Insecure-Requests: 1
> 
> ---3U4kCbBk---D--
> 
> ---3U4kCbBk---E--
> ??(??????HML??)?,?I?310Vp?/J?LII?
> ...
> ...
> ---3U4kCbBk---F--
> Server: nginx/1.6.2
> Date: Wed, 23 Aug 2017 07:10:32 GMT
> Content-Type: text/html
> Connection: keep-alive
> Content-Encoding: gzip
> 
> ---3U4kCbBk---H--
> ModSecurity: Warning. Matched "Operator `Eq' with parameter `0' against variable `MULTIPART_UNMATCHED_BOUNDARY' (Value: `1' ) [file "/etc/nginx/modsecurity.conf"] [line "66"] [id "200004"] [rev ""] [msg "Multipart parser detected a possible unmatched boundary."] [data ""] [severity "0"] [ver ""] [maturity "0"] [accuracy "0"] [ref "v810,1"]
> 
> ---3U4kCbBk---I--
> 
> ---3U4kCbBk---J--
> 
> ---3U4kCbBk---Z--
> 
> 
> Here is the detail of POST request:
> 
> -----------------------------186567636118947579521451609378
> Content-Disposition: form-data; name="_token"
> 
> nEWGe3VUF9R1K7d0SSx4rZRYkYeN849B
> -----------------------------186567636118947579521451609378
> Content-Disposition: form-data; name="_framed"
> 
> 1
> -----------------------------186567636118947579521451609378
> Content-Disposition: form-data; name="_file"; filename="airween_at_gmail.com.asc"
> Content-Type: text/plain
> 
> -----BEGIN PGP PUBLIC KEY BLOCK-----
> Version: GnuPG v1
> 
> mQINBFhwuigBEAC+gnmOXXTEtedn5hqcjLirPM6phHGLdeqVUsD0sRDWFjgcoh7b
> ...
> =G+Dl
> -----END PGP PUBLIC KEY BLOCK-----
> 
> -----------------------------186567636118947579521451609378
> Content-Disposition: form-data; name="_search"
> 
> 
> -----------------------------186567636118947579521451609378--
> 
> 
> 
> 
> This error occures when I upload the .asc file above, when I try
> to upload a "simple" csv, or png, everything works as well.
> 
> 
> 
> What should I do? How can I fix this error?
> 
> 
> 
> Thanks,
> 
> 
> a.
> 
> 
> 
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set

-- 
ModSecurity courses Oct 2017 in London and Zurich
https://www.feistyduck.com/training/modsecurity-training-course
https://www.feistyduck.com/books/modsecurity-handbook/
mailto:christian.folini at netnea.com
twitter: @ChrFolini

From airween at gmail.com  Wed Aug 23 15:13:41 2017
From: airween at gmail.com (Ervin =?utf-8?Q?Heged=C3=BCs?=)
Date: Wed, 23 Aug 2017 17:13:41 +0200
Subject: [Owasp-modsecurity-core-rule-set] File upload problem
In-Reply-To: <20170823075432.obfagmgd6m3ds574@leander>
References: <20170823073030.GA21794@arxnet.hu>
	<20170823075432.obfagmgd6m3ds574@leander>
Message-ID: <20170823151341.GA1234@arxnet.hu>

Hi Christian,

On Wed, Aug 23, 2017 at 09:54:32AM +0200, Christian Folini wrote:
> Hi there,
> 
> Is this the full "H" part of the Audit Log?

yes,

> Are you sure it's not an extension filter defined on the application
> itself?

yes, I am sure.
 
> Did you try this without CRS? Without ModSec?

without CRS _and_ with ModSec it occures, without ModSec it
doesn't occure.

> Just questions that mean to guide you...

I have an idea, but may be I'm wrong...

audit.log shows this line:
ModSecurity: Warning. Matched "Operator `Eq' with parameter `0' against variable `MULTIPART_UNMATCHED_BOUNDARY' (Value: `1' ) [file "/etc/nginx/modsecurity.conf"] [line "66"] [id "200004"] [rev ""] [msg "Multipart parser detected a possible unmatched boundary."] [data ""] [severity "0"] [ver ""] [maturity "0"] [accuracy "0"] [ref "v810,1"]

The id:200004 looks like this:
SecRule MULTIPART_UNMATCHED_BOUNDARY "!@eq 0" \
"id:'200004',phase:2,t:none,log,deny,msg:'Multipart parser detected a possible unmatched boundary.'"

(but this isn't in line 66 in that file).

I think the MULTIPART_UNMATCHED_BOUNDARY is a hard-coded rule,
which exists in libmodsecurity/ code. And may be, that function
parses the GPG key header (and footer) as boundary...?


Regards,


a.


 
> Ahoj,
> 
> Christian
> 
> On Wed, Aug 23, 2017 at 09:30:30AM +0200, Ervin Heged?s wrote:
> > Hi folks,
> > 
> > here is a new problem with CRS 3.0(.2). There is an nGinx with
> > Modsecurity 3.0, and CRS 3.0.2, and an Apache backend, which
> > serves a webmail (Roundcube).
> > 
> > When I try to import my GPG key through the upload, I got 403
> > Forbidden answer.
> > 
> > Here are the details:
> > 
> > HTTP req:
> > 
> > POST https://webmail.mydomain.com/?_task=settings&_action=plugin.enigmakeys&_a=import&_unlock=loading1503472197200
> > ...
> > Content-Length	4443
> > Content-Type	multipart/form-data; boundary=---------------------------186567636118947579521451609378
> > 
> > 
> > HTTP resp:
> > 
> > 403 Forbidden
> > 
> > Content of audit.log:
> > 
> > ---3U4kCbBk---A--
> > [23/Aug/2017:09:10:32 +0200] 15034722321.000000 client.ip.addr 51048 client.ip.addr 443
> > ---3U4kCbBk---B--
> > POST /?_task=settings&_action=plugin.enigmakeys&_a=import&_unlock=loading1503472197200
> > HTTP/1.1
> > Connection: keep-alive
> > Referer: https://webmail.mydomain.com/?_task=settings&_framed=1&_action=plugin.enigmakeys&_a=import
> > Content-Type: multipart/form-data; boundary=---------------------------186567636118947579521451609378
> > Accept-Encoding: gzip, deflate, br
> > Cookie: language=hu; _ga=GA1.2.817NNNNNN.14NNNNNNNN; roundcube_sessid=sessionidtoken; roundcube_sessauth=sessauthidtoken
> > Content-Length: 4443
> > Accept-Language: hu-HU,hu;q=0.8,en-US;q=0.5,en;q=0.3
> > Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
> > User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:55.0) Gecko/20100101 Firefox/55.0
> > Host: webmail.mydomain.com
> > Upgrade-Insecure-Requests: 1
> > 
> > ---3U4kCbBk---D--
> > 
> > ---3U4kCbBk---E--
> > ??(??????HML??)?,?I?310Vp?/J?LII?
> > ...
> > ...
> > ---3U4kCbBk---F--
> > Server: nginx/1.6.2
> > Date: Wed, 23 Aug 2017 07:10:32 GMT
> > Content-Type: text/html
> > Connection: keep-alive
> > Content-Encoding: gzip
> > 
> > ---3U4kCbBk---H--
> > ModSecurity: Warning. Matched "Operator `Eq' with parameter `0' against variable `MULTIPART_UNMATCHED_BOUNDARY' (Value: `1' ) [file "/etc/nginx/modsecurity.conf"] [line "66"] [id "200004"] [rev ""] [msg "Multipart parser detected a possible unmatched boundary."] [data ""] [severity "0"] [ver ""] [maturity "0"] [accuracy "0"] [ref "v810,1"]
> > 
> > ---3U4kCbBk---I--
> > 
> > ---3U4kCbBk---J--
> > 
> > ---3U4kCbBk---Z--
> > 
> > 
> > Here is the detail of POST request:
> > 
> > -----------------------------186567636118947579521451609378
> > Content-Disposition: form-data; name="_token"
> > 
> > nEWGe3VUF9R1K7d0SSx4rZRYkYeN849B
> > -----------------------------186567636118947579521451609378
> > Content-Disposition: form-data; name="_framed"
> > 
> > 1
> > -----------------------------186567636118947579521451609378
> > Content-Disposition: form-data; name="_file"; filename="airween_at_gmail.com.asc"
> > Content-Type: text/plain
> > 
> > -----BEGIN PGP PUBLIC KEY BLOCK-----
> > Version: GnuPG v1
> > 
> > mQINBFhwuigBEAC+gnmOXXTEtedn5hqcjLirPM6phHGLdeqVUsD0sRDWFjgcoh7b
> > ...
> > =G+Dl
> > -----END PGP PUBLIC KEY BLOCK-----
> > 
> > -----------------------------186567636118947579521451609378
> > Content-Disposition: form-data; name="_search"
> > 
> > 
> > -----------------------------186567636118947579521451609378--
> > 
> > 
> > 
> > 
> > This error occures when I upload the .asc file above, when I try
> > to upload a "simple" csv, or png, everything works as well.
> > 
> > 
> > 
> > What should I do? How can I fix this error?
> > 
> > 
> > 
> > Thanks,
> > 
> > 
> > a.
> > 
> > 
> > 
> > _______________________________________________
> > Owasp-modsecurity-core-rule-set mailing list
> > Owasp-modsecurity-core-rule-set at lists.owasp.org
> > https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
> 
> -- 
> ModSecurity courses Oct 2017 in London and Zurich
> https://www.feistyduck.com/training/modsecurity-training-course
> https://www.feistyduck.com/books/modsecurity-handbook/
> mailto:christian.folini at netnea.com
> twitter: @ChrFolini

From chaim at chaimsanders.com  Wed Aug 23 15:27:54 2017
From: chaim at chaimsanders.com (Chaim Sanders)
Date: Wed, 23 Aug 2017 11:27:54 -0400
Subject: [Owasp-modsecurity-core-rule-set] File upload problem
In-Reply-To: <20170823151341.GA1234@arxnet.hu>
References: <20170823073030.GA21794@arxnet.hu>
	<20170823075432.obfagmgd6m3ds574@leander>
	<20170823151341.GA1234@arxnet.hu>
Message-ID: <CAE8hE=q0x169ev1T3dpNd7jYnL7EcbtN=RSoDPYB2eTkfNZWNA@mail.gmail.com>

Rule '200004' is provided by ModSecurity's recommended configuration file:
https://github.com/SpiderLabs/ModSecurity/blob/v2/master/modsecurity.conf-recommended#L86

In some cases it may trigger FPs, when non standard multipart uploads are
being used. It is possible this is a bug in libmodsecurity (this would need
testing to verify). However if this rule is triggering, it is due to the
ModSecurity supplied configuration, not CRS itself. That being said, It is
simple enough to make an exception for, I can walk you through it if you'd
like. Let me know!

On Wed, Aug 23, 2017 at 11:13 AM, Ervin Heged?s <airween at gmail.com> wrote:

> Hi Christian,
>
> On Wed, Aug 23, 2017 at 09:54:32AM +0200, Christian Folini wrote:
> > Hi there,
> >
> > Is this the full "H" part of the Audit Log?
>
> yes,
>
> > Are you sure it's not an extension filter defined on the application
> > itself?
>
> yes, I am sure.
>
> > Did you try this without CRS? Without ModSec?
>
> without CRS _and_ with ModSec it occures, without ModSec it
> doesn't occure.
>
> > Just questions that mean to guide you...
>
> I have an idea, but may be I'm wrong...
>
> audit.log shows this line:
> ModSecurity: Warning. Matched "Operator `Eq' with parameter `0' against
> variable `MULTIPART_UNMATCHED_BOUNDARY' (Value: `1' ) [file
> "/etc/nginx/modsecurity.conf"] [line "66"] [id "200004"] [rev ""] [msg
> "Multipart parser detected a possible unmatched boundary."] [data ""]
> [severity "0"] [ver ""] [maturity "0"] [accuracy "0"] [ref "v810,1"]
>
> The id:200004 looks like this:
> SecRule MULTIPART_UNMATCHED_BOUNDARY "!@eq 0" \
> "id:'200004',phase:2,t:none,log,deny,msg:'Multipart parser detected a
> possible unmatched boundary.'"
>
> (but this isn't in line 66 in that file).
>
> I think the MULTIPART_UNMATCHED_BOUNDARY is a hard-coded rule,
> which exists in libmodsecurity/ code. And may be, that function
> parses the GPG key header (and footer) as boundary...?
>
>
> Regards,
>
>
> a.
>
>
>
> > Ahoj,
> >
> > Christian
> >
> > On Wed, Aug 23, 2017 at 09:30:30AM +0200, Ervin Heged?s wrote:
> > > Hi folks,
> > >
> > > here is a new problem with CRS 3.0(.2). There is an nGinx with
> > > Modsecurity 3.0, and CRS 3.0.2, and an Apache backend, which
> > > serves a webmail (Roundcube).
> > >
> > > When I try to import my GPG key through the upload, I got 403
> > > Forbidden answer.
> > >
> > > Here are the details:
> > >
> > > HTTP req:
> > >
> > > POST https://webmail.mydomain.com/?_task=settings&_action=plugin.
> enigmakeys&_a=import&_unlock=loading1503472197200
> > > ...
> > > Content-Length      4443
> > > Content-Type        multipart/form-data; boundary=---------------------
> ------186567636118947579521451609378
> > >
> > >
> > > HTTP resp:
> > >
> > > 403 Forbidden
> > >
> > > Content of audit.log:
> > >
> > > ---3U4kCbBk---A--
> > > [23/Aug/2017:09:10:32 +0200] 15034722321.000000 client.ip.addr 51048
> client.ip.addr 443
> > > ---3U4kCbBk---B--
> > > POST /?_task=settings&_action=plugin.enigmakeys&_a=import&_
> unlock=loading1503472197200
> > > HTTP/1.1
> > > Connection: keep-alive
> > > Referer: https://webmail.mydomain.com/?_task=settings&_framed=1&_
> action=plugin.enigmakeys&_a=import
> > > Content-Type: multipart/form-data; boundary=---------------------
> ------186567636118947579521451609378
> > > Accept-Encoding: gzip, deflate, br
> > > Cookie: language=hu; _ga=GA1.2.817NNNNNN.14NNNNNNNN; roundcube_sessid=sessionidtoken;
> roundcube_sessauth=sessauthidtoken
> > > Content-Length: 4443
> > > Accept-Language: hu-HU,hu;q=0.8,en-US;q=0.5,en;q=0.3
> > > Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;
> q=0.8
> > > User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:55.0)
> Gecko/20100101 Firefox/55.0
> > > Host: webmail.mydomain.com
> > > Upgrade-Insecure-Requests: 1
> > >
> > > ---3U4kCbBk---D--
> > >
> > > ---3U4kCbBk---E--
> > > ??(??????HML??)?,?I?310Vp?/J?LII?
> > > ...
> > > ...
> > > ---3U4kCbBk---F--
> > > Server: nginx/1.6.2
> > > Date: Wed, 23 Aug 2017 07:10:32 GMT
> > > Content-Type: text/html
> > > Connection: keep-alive
> > > Content-Encoding: gzip
> > >
> > > ---3U4kCbBk---H--
> > > ModSecurity: Warning. Matched "Operator `Eq' with parameter `0'
> against variable `MULTIPART_UNMATCHED_BOUNDARY' (Value: `1' ) [file
> "/etc/nginx/modsecurity.conf"] [line "66"] [id "200004"] [rev ""] [msg
> "Multipart parser detected a possible unmatched boundary."] [data ""]
> [severity "0"] [ver ""] [maturity "0"] [accuracy "0"] [ref "v810,1"]
> > >
> > > ---3U4kCbBk---I--
> > >
> > > ---3U4kCbBk---J--
> > >
> > > ---3U4kCbBk---Z--
> > >
> > >
> > > Here is the detail of POST request:
> > >
> > > -----------------------------186567636118947579521451609378
> > > Content-Disposition: form-data; name="_token"
> > >
> > > nEWGe3VUF9R1K7d0SSx4rZRYkYeN849B
> > > -----------------------------186567636118947579521451609378
> > > Content-Disposition: form-data; name="_framed"
> > >
> > > 1
> > > -----------------------------186567636118947579521451609378
> > > Content-Disposition: form-data; name="_file";
> filename="airween_at_gmail.com.asc"
> > > Content-Type: text/plain
> > >
> > > -----BEGIN PGP PUBLIC KEY BLOCK-----
> > > Version: GnuPG v1
> > >
> > > mQINBFhwuigBEAC+gnmOXXTEtedn5hqcjLirPM6phHGLdeqVUsD0sRDWFjgcoh7b
> > > ...
> > > =G+Dl
> > > -----END PGP PUBLIC KEY BLOCK-----
> > >
> > > -----------------------------186567636118947579521451609378
> > > Content-Disposition: form-data; name="_search"
> > >
> > >
> > > -----------------------------186567636118947579521451609378--
> > >
> > >
> > >
> > >
> > > This error occures when I upload the .asc file above, when I try
> > > to upload a "simple" csv, or png, everything works as well.
> > >
> > >
> > >
> > > What should I do? How can I fix this error?
> > >
> > >
> > >
> > > Thanks,
> > >
> > >
> > > a.
> > >
> > >
> > >
> > > _______________________________________________
> > > Owasp-modsecurity-core-rule-set mailing list
> > > Owasp-modsecurity-core-rule-set at lists.owasp.org
> > > https://lists.owasp.org/mailman/listinfo/owasp-
> modsecurity-core-rule-set
> >
> > --
> > ModSecurity courses Oct 2017 in London and Zurich
> > https://www.feistyduck.com/training/modsecurity-training-course
> > https://www.feistyduck.com/books/modsecurity-handbook/
> > mailto:christian.folini at netnea.com
> > twitter: @ChrFolini
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>



-- 
-- 
Chaim Sanders
http://www.ChaimSanders.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20170823/4e3db655/attachment-0001.html>

From airween at gmail.com  Wed Aug 23 15:55:12 2017
From: airween at gmail.com (Ervin =?utf-8?Q?Heged=C3=BCs?=)
Date: Wed, 23 Aug 2017 17:55:12 +0200
Subject: [Owasp-modsecurity-core-rule-set] File upload problem
In-Reply-To: <CAE8hE=q0x169ev1T3dpNd7jYnL7EcbtN=RSoDPYB2eTkfNZWNA@mail.gmail.com>
References: <20170823073030.GA21794@arxnet.hu>
	<20170823075432.obfagmgd6m3ds574@leander>
	<20170823151341.GA1234@arxnet.hu>
	<CAE8hE=q0x169ev1T3dpNd7jYnL7EcbtN=RSoDPYB2eTkfNZWNA@mail.gmail.com>
Message-ID: <20170823155512.GA2734@arxnet.hu>

Hi Chaim, and folks,

thanks for the fast reply,


On Wed, Aug 23, 2017 at 11:27:54AM -0400, Chaim Sanders wrote:
> Rule '200004' is provided by ModSecurity's recommended configuration file:
> https://github.com/SpiderLabs/ModSecurity/blob/v2/master/modsecurity.conf-recommended#L86

yes, I'm using that :) (as recommended config),
 
> In some cases it may trigger FPs, when non standard multipart uploads are

sorry for my 2c's, but what does it mean "FP", and what do you
mean about the "standard multipart"?

> being used. It is possible this is a bug in libmodsecurity (this would need
> testing to verify). However if this rule is triggering, it is due to the
> ModSecurity supplied configuration, not CRS itself. That being said, It is
> simple enough to make an exception for, I can walk you through it if you'd
> like. Let me know!

yes, it would be good to solve this problem. We're using
Roundcube, and it supports the GPG keys. Looks like more users
would like to use that feature (in Roundcube), but only the
keys upload doesn't work.

How can I help you to test it?

And you're right, it is due the ModSec, not CRS - I've turned
_off_ the CRS, and this still occured with "native" ModSec.

Sorry for that I posted it for wrong list.


Regards,


a.

> On Wed, Aug 23, 2017 at 11:13 AM, Ervin Heged?s <airween at gmail.com> wrote:
> 
> > Hi Christian,
> >
> > On Wed, Aug 23, 2017 at 09:54:32AM +0200, Christian Folini wrote:
> > > Hi there,
> > >
> > > Is this the full "H" part of the Audit Log?
> >
> > yes,
> >
> > > Are you sure it's not an extension filter defined on the application
> > > itself?
> >
> > yes, I am sure.
> >
> > > Did you try this without CRS? Without ModSec?
> >
> > without CRS _and_ with ModSec it occures, without ModSec it
> > doesn't occure.
> >
> > > Just questions that mean to guide you...
> >
> > I have an idea, but may be I'm wrong...
> >
> > audit.log shows this line:
> > ModSecurity: Warning. Matched "Operator `Eq' with parameter `0' against
> > variable `MULTIPART_UNMATCHED_BOUNDARY' (Value: `1' ) [file
> > "/etc/nginx/modsecurity.conf"] [line "66"] [id "200004"] [rev ""] [msg
> > "Multipart parser detected a possible unmatched boundary."] [data ""]
> > [severity "0"] [ver ""] [maturity "0"] [accuracy "0"] [ref "v810,1"]
> >
> > The id:200004 looks like this:
> > SecRule MULTIPART_UNMATCHED_BOUNDARY "!@eq 0" \
> > "id:'200004',phase:2,t:none,log,deny,msg:'Multipart parser detected a
> > possible unmatched boundary.'"
> >
> > (but this isn't in line 66 in that file).
> >
> > I think the MULTIPART_UNMATCHED_BOUNDARY is a hard-coded rule,
> > which exists in libmodsecurity/ code. And may be, that function
> > parses the GPG key header (and footer) as boundary...?
> >
> >
> > Regards,
> >
> >
> > a.
> >
> >
> >
> > > Ahoj,
> > >
> > > Christian
> > >
> > > On Wed, Aug 23, 2017 at 09:30:30AM +0200, Ervin Heged?s wrote:
> > > > Hi folks,
> > > >
> > > > here is a new problem with CRS 3.0(.2). There is an nGinx with
> > > > Modsecurity 3.0, and CRS 3.0.2, and an Apache backend, which
> > > > serves a webmail (Roundcube).
> > > >
> > > > When I try to import my GPG key through the upload, I got 403
> > > > Forbidden answer.
> > > >
> > > > Here are the details:
> > > >
> > > > HTTP req:
> > > >
> > > > POST https://webmail.mydomain.com/?_task=settings&_action=plugin.
> > enigmakeys&_a=import&_unlock=loading1503472197200
> > > > ...
> > > > Content-Length      4443
> > > > Content-Type        multipart/form-data; boundary=---------------------
> > ------186567636118947579521451609378
> > > >
> > > >
> > > > HTTP resp:
> > > >
> > > > 403 Forbidden
> > > >
> > > > Content of audit.log:
> > > >
> > > > ---3U4kCbBk---A--
> > > > [23/Aug/2017:09:10:32 +0200] 15034722321.000000 client.ip.addr 51048
> > client.ip.addr 443
> > > > ---3U4kCbBk---B--
> > > > POST /?_task=settings&_action=plugin.enigmakeys&_a=import&_
> > unlock=loading1503472197200
> > > > HTTP/1.1
> > > > Connection: keep-alive
> > > > Referer: https://webmail.mydomain.com/?_task=settings&_framed=1&_
> > action=plugin.enigmakeys&_a=import
> > > > Content-Type: multipart/form-data; boundary=---------------------
> > ------186567636118947579521451609378
> > > > Accept-Encoding: gzip, deflate, br
> > > > Cookie: language=hu; _ga=GA1.2.817NNNNNN.14NNNNNNNN; roundcube_sessid=sessionidtoken;
> > roundcube_sessauth=sessauthidtoken
> > > > Content-Length: 4443
> > > > Accept-Language: hu-HU,hu;q=0.8,en-US;q=0.5,en;q=0.3
> > > > Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;
> > q=0.8
> > > > User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:55.0)
> > Gecko/20100101 Firefox/55.0
> > > > Host: webmail.mydomain.com
> > > > Upgrade-Insecure-Requests: 1
> > > >
> > > > ---3U4kCbBk---D--
> > > >
> > > > ---3U4kCbBk---E--
> > > > ??(??????HML??)?,?I?310Vp?/J?LII?
> > > > ...
> > > > ...
> > > > ---3U4kCbBk---F--
> > > > Server: nginx/1.6.2
> > > > Date: Wed, 23 Aug 2017 07:10:32 GMT
> > > > Content-Type: text/html
> > > > Connection: keep-alive
> > > > Content-Encoding: gzip
> > > >
> > > > ---3U4kCbBk---H--
> > > > ModSecurity: Warning. Matched "Operator `Eq' with parameter `0'
> > against variable `MULTIPART_UNMATCHED_BOUNDARY' (Value: `1' ) [file
> > "/etc/nginx/modsecurity.conf"] [line "66"] [id "200004"] [rev ""] [msg
> > "Multipart parser detected a possible unmatched boundary."] [data ""]
> > [severity "0"] [ver ""] [maturity "0"] [accuracy "0"] [ref "v810,1"]
> > > >
> > > > ---3U4kCbBk---I--
> > > >
> > > > ---3U4kCbBk---J--
> > > >
> > > > ---3U4kCbBk---Z--
> > > >
> > > >
> > > > Here is the detail of POST request:
> > > >
> > > > -----------------------------186567636118947579521451609378
> > > > Content-Disposition: form-data; name="_token"
> > > >
> > > > nEWGe3VUF9R1K7d0SSx4rZRYkYeN849B
> > > > -----------------------------186567636118947579521451609378
> > > > Content-Disposition: form-data; name="_framed"
> > > >
> > > > 1
> > > > -----------------------------186567636118947579521451609378
> > > > Content-Disposition: form-data; name="_file";
> > filename="airween_at_gmail.com.asc"
> > > > Content-Type: text/plain
> > > >
> > > > -----BEGIN PGP PUBLIC KEY BLOCK-----
> > > > Version: GnuPG v1
> > > >
> > > > mQINBFhwuigBEAC+gnmOXXTEtedn5hqcjLirPM6phHGLdeqVUsD0sRDWFjgcoh7b
> > > > ...
> > > > =G+Dl
> > > > -----END PGP PUBLIC KEY BLOCK-----
> > > >
> > > > -----------------------------186567636118947579521451609378
> > > > Content-Disposition: form-data; name="_search"
> > > >
> > > >
> > > > -----------------------------186567636118947579521451609378--
> > > >
> > > >
> > > >
> > > >
> > > > This error occures when I upload the .asc file above, when I try
> > > > to upload a "simple" csv, or png, everything works as well.
> > > >
> > > >
> > > >
> > > > What should I do? How can I fix this error?
> > > >
> > > >
> > > >
> > > > Thanks,
> > > >
> > > >
> > > > a.
> > > >
> > > >
> > > >
> > > > _______________________________________________
> > > > Owasp-modsecurity-core-rule-set mailing list
> > > > Owasp-modsecurity-core-rule-set at lists.owasp.org
> > > > https://lists.owasp.org/mailman/listinfo/owasp-
> > modsecurity-core-rule-set
> > >
> > > --
> > > ModSecurity courses Oct 2017 in London and Zurich
> > > https://www.feistyduck.com/training/modsecurity-training-course
> > > https://www.feistyduck.com/books/modsecurity-handbook/
> > > mailto:christian.folini at netnea.com
> > > twitter: @ChrFolini
> > _______________________________________________
> > Owasp-modsecurity-core-rule-set mailing list
> > Owasp-modsecurity-core-rule-set at lists.owasp.org
> > https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
> >
> 
> 
> 
> -- 
> -- 
> Chaim Sanders
> http://www.ChaimSanders.com

From spartantri at gmail.com  Wed Aug 23 16:36:48 2017
From: spartantri at gmail.com (spartantri at gmail.com)
Date: Wed, 23 Aug 2017 18:36:48 +0200
Subject: [Owasp-modsecurity-core-rule-set] File upload problem
In-Reply-To: <20170823151341.GA1234@arxnet.hu>
References: <20170823073030.GA21794@arxnet.hu>
	<20170823075432.obfagmgd6m3ds574@leander>
	<20170823151341.GA1234@arxnet.hu>
Message-ID: <CA1F8776-72DC-4AA6-A35B-E82FCA5A5C10@gmail.com>

Hi Ervin,

Maybe the modsec engine multipart body processor is not rfc compliant and confuses the CRLF-- with a boundary delimiter instead of doing a full check as described in rfcs 7578 and 2046, try removing the dashes from the beginning and end of the gpg content and if it passes that may be the reason behind this.

To fix it you may add a rule to disable 200004 for that particular URL.

But read the warnings at the documentation.

File uploads are usually risky so it maybe good if you do a full check with @inspectFile for malware viruses etc

Something like
SecRule FILES_TMPNAMES "@inspectFile path/inspectscript" deny..

Cheers!

Enviado desde mi iPhone

> El 23 ago 2017, a las 17:13, Ervin Heged?s <airween at gmail.com> escribi?:
> 
> MULTIPART_UNMATCHED_BOUNDARY

From airween at gmail.com  Wed Aug 23 19:33:06 2017
From: airween at gmail.com (Ervin =?utf-8?Q?Heged=C3=BCs?=)
Date: Wed, 23 Aug 2017 21:33:06 +0200
Subject: [Owasp-modsecurity-core-rule-set] File upload problem
In-Reply-To: <CA1F8776-72DC-4AA6-A35B-E82FCA5A5C10@gmail.com>
References: <20170823073030.GA21794@arxnet.hu>
	<20170823075432.obfagmgd6m3ds574@leander>
	<20170823151341.GA1234@arxnet.hu>
	<CA1F8776-72DC-4AA6-A35B-E82FCA5A5C10@gmail.com>
Message-ID: <20170823193306.GA23031@arxnet.hu>

Hi Spartantri,

On Wed, Aug 23, 2017 at 06:36:48PM +0200, spartantri at gmail.com wrote:
> Hi Ervin,
> 
> Maybe the modsec engine multipart body processor is not rfc compliant and confuses the CRLF-- with a boundary delimiter instead of doing a full check as described in rfcs 7578 and 2046, try removing the dashes from the beginning and end of the gpg content and if it passes that may be the reason behind this.

in case of PGP there is no option to remove the lines from the
head (then the pgp app couldn't realise that is a pgp key).

I've try to upload a simple certificate (as attachment), which also
contains a header and footer lines:

-----BEGIN CERTIFICATE-----
MIIE3TCCA8WgAwIBAgIQX+iZdkBxaFky7vr2n2sS5zANBgkqhkiG9w0BAQsFADB4
...
jg==
-----END CERTIFICATE-----

I've got 403 Forbidden again. Then I removed the leader "-"
chars, and attachment had uploaded correctly.

I think there isn't a CRLF problem.

> To fix it you may add a rule to disable 200004 for that particular URL.

I don't want to disable this rule :)

> But read the warnings at the documentation.
> 
> File uploads are usually risky so it maybe good if you do a full check with @inspectFile for malware viruses etc
> 
> Something like
> SecRule FILES_TMPNAMES "@inspectFile path/inspectscript" deny..

thanks, but I'm afraid that's not option (I mean to disable this
rule)


Thanks for your help,


a.
 

-- 
I ? UTF-8

From cristiano.galdino at gmail.com  Wed Aug 23 20:18:30 2017
From: cristiano.galdino at gmail.com (Cristiano Galdino)
Date: Wed, 23 Aug 2017 17:18:30 -0300
Subject: [Owasp-modsecurity-core-rule-set] Remove rule 970901 - CRS 2.2.8
Message-ID: <CAP2OKe8Xuzy_pdqg=i=zo_7Rw4p_-8a=r=wmu-XFZ93vPGnP-Q@mail.gmail.com>

Hi!

I have an application
?returning status 500 and I can not fix it or take it out. I try disable
rule 970901 but
? ?
modsecurity keeps logging events
?.?

?
File:
*?modsecurity_crs_15_local_exceptions.conf*

SecRule REQUEST_FILENAME "@beginsWith /monitor/" \
"id:2500,phase:4,nolog,noauditlog,t:none,t:lowercase,msg:'Desativa regras
de para o contexto SIPAG-MONITOR-WEB',pass, \
ctl:ruleRemoveById=970901"

What can I do?

?Tks!?


-- 
Cristiano Galdino - cristiano at galdino.net
http://cristiano.galdino.net
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20170823/3828726b/attachment.html>

From oelnaggar04 at gmail.com  Wed Aug 23 20:31:17 2017
From: oelnaggar04 at gmail.com (Osama Elnaggar)
Date: Wed, 23 Aug 2017 22:31:17 +0200
Subject: [Owasp-modsecurity-core-rule-set] Remove rule 970901 - CRS 2.2.8
In-Reply-To: <CAP2OKe8Xuzy_pdqg=i=zo_7Rw4p_-8a=r=wmu-XFZ93vPGnP-Q@mail.gmail.com>
References: <CAP2OKe8Xuzy_pdqg=i=zo_7Rw4p_-8a=r=wmu-XFZ93vPGnP-Q@mail.gmail.com>
Message-ID: <CACva_gHXjUMzuJVV_j4_qz_iwF=K-RNsO3Y_WObfc7g3AO5=mg@mail.gmail.com>

Try changing the phase to phase 1 as phase 4 rules are for processing the
response body and the request has already reached your backend by phase 4.

-- 
Osama Elnaggar

On August 24, 2017 at 6:20:26 AM, Cristiano Galdino (
cristiano.galdino at gmail.com) wrote:

Hi!

I have an application
?returning status 500 and I can not fix it or take it out. I try disable
rule 970901 but
? ?
modsecurity keeps logging events
?.?

?
File:
*?modsecurity_crs_15_local_exceptions.conf*

SecRule REQUEST_FILENAME "@beginsWith /monitor/" \
"id:2500,phase:4,nolog,noauditlog,t:none,t:lowercase,msg:'Desativa regras
de para o contexto SIPAG-MONITOR-WEB',pass, \
ctl:ruleRemoveById=970901"

What can I do?

?Tks!?


--
Cristiano Galdino - cristiano at galdino.net
http://cristiano.galdino.net
_______________________________________________
Owasp-modsecurity-core-rule-set mailing list
Owasp-modsecurity-core-rule-set at lists.owasp.org
https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20170823/edc53612/attachment-0001.html>

From spartantri at gmail.com  Wed Aug 23 20:31:47 2017
From: spartantri at gmail.com (Manuel Spartan)
Date: Wed, 23 Aug 2017 22:31:47 +0200
Subject: [Owasp-modsecurity-core-rule-set] Remove rule 970901 - CRS 2.2.8
In-Reply-To: <CAP2OKe8Xuzy_pdqg=i=zo_7Rw4p_-8a=r=wmu-XFZ93vPGnP-Q@mail.gmail.com>
References: <CAP2OKe8Xuzy_pdqg=i=zo_7Rw4p_-8a=r=wmu-XFZ93vPGnP-Q@mail.gmail.com>
Message-ID: <CAN6xG9uPozGbyinYs-M+J=3T_zTKqW9Vs2_mqEa_AfMkps4EJQ@mail.gmail.com>

Hi Cristiano, your rule is using phase 4, which maybe too late, try using
phase 1 or 2 instead.

Cheers!


On Aug 23, 2017 22:19, "Cristiano Galdino" <cristiano.galdino at gmail.com>
wrote:

Hi!

I have an application
?returning status 500 and I can not fix it or take it out. I try disable
rule 970901 but
? ?
modsecurity keeps logging events
?.?

?
File:
*?modsecurity_crs_15_local_exceptions.conf*

SecRule REQUEST_FILENAME "@beginsWith /monitor/" \
"id:2500,phase:4,nolog,noauditlog,t:none,t:lowercase,msg:'Desativa regras
de para o contexto SIPAG-MONITOR-WEB',pass, \
ctl:ruleRemoveById=970901"

What can I do?

?Tks!?


-- 
Cristiano Galdino - cristiano at galdino.net
http://cristiano.galdino.net

_______________________________________________
Owasp-modsecurity-core-rule-set mailing list
Owasp-modsecurity-core-rule-set at lists.owasp.org
https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20170823/04c2977e/attachment.html>

From cristiano.galdino at gmail.com  Wed Aug 23 20:36:30 2017
From: cristiano.galdino at gmail.com (Cristiano Galdino)
Date: Wed, 23 Aug 2017 17:36:30 -0300
Subject: [Owasp-modsecurity-core-rule-set] Remove rule 970901 - CRS 2.2.8
In-Reply-To: <CAN6xG9uPozGbyinYs-M+J=3T_zTKqW9Vs2_mqEa_AfMkps4EJQ@mail.gmail.com>
References: <CAP2OKe8Xuzy_pdqg=i=zo_7Rw4p_-8a=r=wmu-XFZ93vPGnP-Q@mail.gmail.com>
	<CAN6xG9uPozGbyinYs-M+J=3T_zTKqW9Vs2_mqEa_AfMkps4EJQ@mail.gmail.com>
Message-ID: <CAP2OKe9fUzKJVi7rk+8UPZtO=KjX7+Z752u2uc=OC3GYHCTw0Q@mail.gmail.com>

Hi!

I tried withphase 1 and 2 but kept
? ?
logging events
?. I think it would be in phase 4 because rule 970901 (status 500) occurs
at this time.


Tks!!

On Wed, Aug 23, 2017 at 5:31 PM, Manuel Spartan <spartantri at gmail.com>
wrote:

> Hi Cristiano, your rule is using phase 4, which maybe too late, try using
> phase 1 or 2 instead.
>
> Cheers!
>
>
> On Aug 23, 2017 22:19, "Cristiano Galdino" <cristiano.galdino at gmail.com>
> wrote:
>
> Hi!
>
> I have an application
> ?returning status 500 and I can not fix it or take it out. I try disable
> rule 970901 but
> ? ?
> modsecurity keeps logging events
> ?.?
>
> ?
> File:
> *?modsecurity_crs_15_local_exceptions.conf*
>
> SecRule REQUEST_FILENAME "@beginsWith /monitor/" \
> "id:2500,phase:4,nolog,noauditlog,t:none,t:lowercase,msg:'Desativa regras
> de para o contexto SIPAG-MONITOR-WEB',pass, \
> ctl:ruleRemoveById=970901"
>
> What can I do?
>
> ?Tks!?
>
>
> --
> Cristiano Galdino - cristiano at galdino.net
> http://cristiano.galdino.net
>
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>
>
>


-- 
Cristiano Galdino - cristiano at galdino.net
http://cristiano.galdino.net
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20170823/c74934e0/attachment.html>

From christian.folini at netnea.com  Wed Aug 23 20:38:05 2017
From: christian.folini at netnea.com (Christian Folini)
Date: Wed, 23 Aug 2017 22:38:05 +0200
Subject: [Owasp-modsecurity-core-rule-set] Remove rule 970901 - CRS 2.2.8
In-Reply-To: <CACva_gHXjUMzuJVV_j4_qz_iwF=K-RNsO3Y_WObfc7g3AO5=mg@mail.gmail.com>
References: <CAP2OKe8Xuzy_pdqg=i=zo_7Rw4p_-8a=r=wmu-XFZ93vPGnP-Q@mail.gmail.com>
	<CACva_gHXjUMzuJVV_j4_qz_iwF=K-RNsO3Y_WObfc7g3AO5=mg@mail.gmail.com>
Message-ID: <20170823203805.44rlqv7b3rays3kp@leander>

On Wed, Aug 23, 2017 at 10:31:17PM +0200, Osama Elnaggar wrote:
>    Try changing the phase to phase 1 as phase 4 rules are for processing the
>    response body and the request has already reached your backend by phase 4.

Yeah, but the rule in question is also phase 4:

modsecurity_crs_50_outbound.conf:

SecRule RESPONSE_STATUS "^5\d{2}$"
"phase:4,rev:'2',ver:'OWASP_CRS/2.2.7',maturity:'9',accuracy:'9',t:none,capture,ctl:auditLogParts=+E,block,msg:'The
application is not available',logdata:'Matched Data: %{TX.0} found
within %{MATCHED_VAR_NAME}:
%{MATCHED_VAR}',id:'970901',tag:'WASCTC/WASC-13',tag:'OWASP_TOP_10/A6',tag:'PCI/6.5.6',severity:'3',setvar:'tx.msg=%{rule.msg}',setvar:tx.outbound_anomaly_score=+%{tx.error_anomaly_score},setvar:tx.anomaly_score=+%{tx.error_anomaly_score},setvar:tx.%{rule.id}-AVAILABILITY/APP_NOT_AVAIL-%{matched_var_name}=%{tx.0}"

Not sure where the problem is.

I'm tempted to say that an upgrade to CRS3 is likely to solve the
problem, though.

Ahoj,

Christian


>    --??
>    Osama Elnaggar
> 
>    On August 24, 2017 at 6:20:26 AM, Cristiano Galdino
>    (cristiano.galdino at gmail.com) wrote:
> 
>      Hi!
>      I have an application
>      ?**returning status 500 and I can not fix it or take it out. I try
>      disable rule 970901 but
>      ?** ?**
>      modsecurity keeps logging events
>      ?**.?**
>      ?**
>      File:
>      ?**modsecurity_crs_15_local_exceptions.conf
>      SecRule REQUEST_FILENAME "@beginsWith /monitor/" \
>      "id:2500,phase:4,nolog,noauditlog,t:none,t:lowercase,msg:'Desativa
>      regras de para o contexto SIPAG-MONITOR-WEB',pass, \
>      ctl:ruleRemoveById=970901"
>      What can I do?
> 
>      ?**Tks!?**
> 
>      --
>      Cristiano Galdino - cristiano at galdino.net
>      http://cristiano.galdino.net
>      _______________________________________________
>      Owasp-modsecurity-core-rule-set mailing list
>      Owasp-modsecurity-core-rule-set at lists.owasp.org
>      https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set

> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set


-- 
ModSecurity courses Oct 2017 in London and Zurich
https://www.feistyduck.com/training/modsecurity-training-course
https://www.feistyduck.com/books/modsecurity-handbook/
mailto:christian.folini at netnea.com
twitter: @ChrFolini

From kirk at pageofwords.com  Wed Aug 23 22:48:26 2017
From: kirk at pageofwords.com (Kirk Jackson)
Date: Thu, 24 Aug 2017 10:48:26 +1200
Subject: [Owasp-modsecurity-core-rule-set] Fwd: Multiple matches with @rsub
	and @rx over STREAM_OUTPUT_BODY
In-Reply-To: <CAAO0q_HkbA8w63qo743gFpk7tWk4UVRH1NBnA_dfA_ZY7vOdqg@mail.gmail.com>
References: <CAAO0q_HkbA8w63qo743gFpk7tWk4UVRH1NBnA_dfA_ZY7vOdqg@mail.gmail.com>
Message-ID: <CAAO0q_GGLfdp5a5SvHJeOEk1BpyX1_ViAVorpuWEvfb13d70Ow@mail.gmail.com>

Hi,

Apologies for cross-posting this message here, but I think this CRS list
might get more traffic than the mod-security-users one.

To summarise my message. Is it possible to have @rsub replace all
occurrences of a string, or does it just match and replace the first
occurrence?

Cheers,

Kirk

---------- Forwarded message ----------
From: Kirk Jackson <kirk at pageofwords.com>
Date: Mon, Aug 21, 2017 at 3:39 PM
Subject: Multiple matches with @rsub and @rx over STREAM_OUTPUT_BODY
To: mod-security-users at lists.sourceforge.net


Hi,

I've written some rules that act across RESPONSE_BODY and
STREAM_OUTPUT_BODY, using @rx and @rsub.

Would you expect these rules to fire multiple times, once per match in the
response text, or just once when the first match is found?

>From what I can tell, the @rsub only replaces the first occurrence of the
regular expression match, and both @rx and @rsub only trigger the rule once
per request.

I was hoping that if my output had the same string in multiple places that
@rsub would replace all occurrences of that string.

Please let me know whether just seeing one replacement is the correct
behaviour.

Thanks,

Kirk
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20170824/ade8ad47/attachment-0001.html>

From chaim at chaimsanders.com  Thu Aug 24 15:51:33 2017
From: chaim at chaimsanders.com (Chaim Sanders)
Date: Thu, 24 Aug 2017 11:51:33 -0400
Subject: [Owasp-modsecurity-core-rule-set] Fwd: Multiple matches with
 @rsub and @rx over STREAM_OUTPUT_BODY
In-Reply-To: <CAAO0q_GGLfdp5a5SvHJeOEk1BpyX1_ViAVorpuWEvfb13d70Ow@mail.gmail.com>
References: <CAAO0q_HkbA8w63qo743gFpk7tWk4UVRH1NBnA_dfA_ZY7vOdqg@mail.gmail.com>
	<CAAO0q_GGLfdp5a5SvHJeOEk1BpyX1_ViAVorpuWEvfb13d70Ow@mail.gmail.com>
Message-ID: <CAE8hE=rDXpW-jJ8-zMOkvtDy2NF0eWFHM_OTow7ov1vA7p2Axg@mail.gmail.com>

Hey Kirk,
I don't think this is possible. depending on the internal state, you may be
able to run multiple rules against the content or store it to a var, but it
will be expensive.

On Wed, Aug 23, 2017 at 6:48 PM, Kirk Jackson <kirk at pageofwords.com> wrote:

> Hi,
>
> Apologies for cross-posting this message here, but I think this CRS list
> might get more traffic than the mod-security-users one.
>
> To summarise my message. Is it possible to have @rsub replace all
> occurrences of a string, or does it just match and replace the first
> occurrence?
>
> Cheers,
>
> Kirk
>
> ---------- Forwarded message ----------
> From: Kirk Jackson <kirk at pageofwords.com>
> Date: Mon, Aug 21, 2017 at 3:39 PM
> Subject: Multiple matches with @rsub and @rx over STREAM_OUTPUT_BODY
> To: mod-security-users at lists.sourceforge.net
>
>
> Hi,
>
> I've written some rules that act across RESPONSE_BODY and
> STREAM_OUTPUT_BODY, using @rx and @rsub.
>
> Would you expect these rules to fire multiple times, once per match in the
> response text, or just once when the first match is found?
>
> From what I can tell, the @rsub only replaces the first occurrence of the
> regular expression match, and both @rx and @rsub only trigger the rule once
> per request.
>
> I was hoping that if my output had the same string in multiple places that
> @rsub would replace all occurrences of that string.
>
> Please let me know whether just seeing one replacement is the correct
> behaviour.
>
> Thanks,
>
> Kirk
>
>
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>
>


-- 
-- 
Chaim Sanders
http://www.ChaimSanders.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20170824/99493d47/attachment.html>

From spartantri at gmail.com  Thu Aug 24 16:37:34 2017
From: spartantri at gmail.com (Manuel Spartan)
Date: Thu, 24 Aug 2017 18:37:34 +0200
Subject: [Owasp-modsecurity-core-rule-set] Fwd: Multiple matches with
 @rsub and @rx over STREAM_OUTPUT_BODY
In-Reply-To: <CAAO0q_GGLfdp5a5SvHJeOEk1BpyX1_ViAVorpuWEvfb13d70Ow@mail.gmail.com>
References: <CAAO0q_HkbA8w63qo743gFpk7tWk4UVRH1NBnA_dfA_ZY7vOdqg@mail.gmail.com>
	<CAAO0q_GGLfdp5a5SvHJeOEk1BpyX1_ViAVorpuWEvfb13d70Ow@mail.gmail.com>
Message-ID: <CAN6xG9vNyEStMA6+AJ_4A_mNSEvqeUojC8kXU=-PqOK+GAUy+Q@mail.gmail.com>

Hi Kirk,

You can use an apache external filter or mod substitute to do the
substitutions, for example, to fix hardcoded urls in html pages.

Cheers!

On Aug 24, 2017 00:49, "Kirk Jackson" <kirk at pageofwords.com> wrote:

> Hi,
>
> Apologies for cross-posting this message here, but I think this CRS list
> might get more traffic than the mod-security-users one.
>
> To summarise my message. Is it possible to have @rsub replace all
> occurrences of a string, or does it just match and replace the first
> occurrence?
>
> Cheers,
>
> Kirk
>
> ---------- Forwarded message ----------
> From: Kirk Jackson <kirk at pageofwords.com>
> Date: Mon, Aug 21, 2017 at 3:39 PM
> Subject: Multiple matches with @rsub and @rx over STREAM_OUTPUT_BODY
> To: mod-security-users at lists.sourceforge.net
>
>
> Hi,
>
> I've written some rules that act across RESPONSE_BODY and
> STREAM_OUTPUT_BODY, using @rx and @rsub.
>
> Would you expect these rules to fire multiple times, once per match in the
> response text, or just once when the first match is found?
>
> From what I can tell, the @rsub only replaces the first occurrence of the
> regular expression match, and both @rx and @rsub only trigger the rule once
> per request.
>
> I was hoping that if my output had the same string in multiple places that
> @rsub would replace all occurrences of that string.
>
> Please let me know whether just seeing one replacement is the correct
> behaviour.
>
> Thanks,
>
> Kirk
>
>
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20170824/f8480c69/attachment.html>

From kirk at pageofwords.com  Thu Aug 24 19:43:14 2017
From: kirk at pageofwords.com (Kirk Jackson)
Date: Thu, 24 Aug 2017 19:43:14 +0000
Subject: [Owasp-modsecurity-core-rule-set] Fwd: Multiple matches with
 @rsub and @rx over STREAM_OUTPUT_BODY
In-Reply-To: <CAN6xG9vNyEStMA6+AJ_4A_mNSEvqeUojC8kXU=-PqOK+GAUy+Q@mail.gmail.com>
References: <CAAO0q_HkbA8w63qo743gFpk7tWk4UVRH1NBnA_dfA_ZY7vOdqg@mail.gmail.com>
	<CAAO0q_GGLfdp5a5SvHJeOEk1BpyX1_ViAVorpuWEvfb13d70Ow@mail.gmail.com>
	<CAN6xG9vNyEStMA6+AJ_4A_mNSEvqeUojC8kXU=-PqOK+GAUy+Q@mail.gmail.com>
Message-ID: <CAAO0q_HH+3L4dQghaKaXncb2t5yA5YnnqOv3sAmux_ARRgeanw@mail.gmail.com>

Thanks Manuel and Chaim,

I appreciate your replies!

Kirk


On Fri, 25 Aug 2017 at 4:37 AM, Manuel Spartan <spartantri at gmail.com> wrote:

> Hi Kirk,
>
> You can use an apache external filter or mod substitute to do the
> substitutions, for example, to fix  hardcoded urls in html pages.
>
> Cheers!
>
> On Aug 24, 2017 00:49, "Kirk Jackson" <kirk at pageofwords.com> wrote:
>
>> Hi,
>>
>> Apologies for cross-posting this message here, but I think this CRS list
>> might get more traffic than the mod-security-users one.
>>
>> To summarise my message. Is it possible to have @rsub replace all
>> occurrences of a string, or does it just match and replace the first
>> occurrence?
>>
>> Cheers,
>>
>> Kirk
>>
>> ---------- Forwarded message ----------
>> From: Kirk Jackson <kirk at pageofwords.com>
>> Date: Mon, Aug 21, 2017 at 3:39 PM
>> Subject: Multiple matches with @rsub and @rx over STREAM_OUTPUT_BODY
>> To: mod-security-users at lists.sourceforge.net
>>
>>
>> Hi,
>>
>> I've written some rules that act across RESPONSE_BODY and
>> STREAM_OUTPUT_BODY, using @rx and @rsub.
>>
>> Would you expect these rules to fire multiple times, once per match in
>> the response text, or just once when the first match is found?
>>
>> From what I can tell, the @rsub only replaces the first occurrence of the
>> regular expression match, and both @rx and @rsub only trigger the rule once
>> per request.
>>
>> I was hoping that if my output had the same string in multiple places
>> that @rsub would replace all occurrences of that string.
>>
>> Please let me know whether just seeing one replacement is the correct
>> behaviour.
>>
>> Thanks,
>>
>> Kirk
>>
>>
>> _______________________________________________
>> Owasp-modsecurity-core-rule-set mailing list
>> Owasp-modsecurity-core-rule-set at lists.owasp.org
>> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>>
>>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20170824/268390b0/attachment.html>

