<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Woe with 920270 (Null Byte...) (was: Re: Matched rule modification)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Woe%20with%20920270%20%28Null%0A%20Byte...%29%20%28was%3A%20Re%3A%20Matched%20rule%20modification%29&In-Reply-To=%3C20170601064903.mwgxlv5dxq6ccrp6%40leander%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="002376.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Woe with 920270 (Null Byte...) (was: Re: Matched rule modification)</H1>
    <B>Christian Folini</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Woe%20with%20920270%20%28Null%0A%20Byte...%29%20%28was%3A%20Re%3A%20Matched%20rule%20modification%29&In-Reply-To=%3C20170601064903.mwgxlv5dxq6ccrp6%40leander%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] Woe with 920270 (Null Byte...) (was: Re: Matched rule modification)">christian.folini at netnea.com
       </A><BR>
    <I>Thu Jun  1 06:49:03 UTC 2017</I>
    <P><UL>
        
        <LI>Next message: <A HREF="002376.html">[Owasp-modsecurity-core-rule-set] Woe with 920270 (Null Byte...) (was: Re: Matched rule modification)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2372">[ date ]</a>
              <a href="thread.html#2372">[ thread ]</a>
              <a href="subject.html#2372">[ subject ]</a>
              <a href="author.html#2372">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Ervin,

You are touching multiple issues in your latest message. I would like
to dig on the bottom of this one:

On Wed, May 31, 2017 at 08:32:03AM +0200, Ervin Heged&#252;s wrote:
&gt;<i> And there is an another issue with 3.0.2 (but may be that affects
</I>&gt;<i> another versions too).
</I>&gt;<i> 
</I>&gt;<i> The request is similar that I detailed in my first post. The
</I>&gt;<i> &quot;extraParams&quot; value (JSON field) is this:
</I>&gt;<i> 
</I>&gt;<i> extraParams {&quot;node&quot;:&quot;3&quot;,&quot;text&quot;:&quot;v&#233;gs&#337; fejezet&quot;}
</I>&gt;<i> 
</I>&gt;<i> As you can see, this is a UTF8 text, and client sends it as UTF8:
</I>&gt;<i> 
</I>&gt;<i> Content-Type: application/x-www-form-urlencoded; charset=UTF-8
</I>&gt;<i> X-Requested-With: XMLHttpRequest
</I>&gt;<i> Accept-Encoding: gzip, deflate
</I>&gt;<i> 
</I>&gt;<i> The encoded URI will be:
</I>&gt;<i> 
</I>&gt;<i> extraParams=%7B%22node%22%3A%223%22%2C%22text%22%3A%22v%C3%A9gs%C5%91%20fejezet%22
</I>&gt;<i> 
</I>&gt;<i> The characters &quot;&#233;&quot; and &quot;&#337;&quot; are two bytes utf8 characters:
</I>&gt;<i> \xC3\xA9 and \xC5\x91.
</I>&gt;<i> 
</I>&gt;<i> But in audit log I get:
</I>&gt;<i> 
</I>&gt;<i> ModSecurity: Warning. Matched &quot;Operator `ValidadeByteRange' with parameter `1-255' against variable `ARGS:extraParams' (Value: `{&quot;node&quot;:&quot;3&quot;,&quot;text&quot;:&quot;v\xffffffc3\xffffffa9gs\xffffffc5\xffffff91 fejezet&quot;,&quot;parentNode&quot;:&quot;0&quot;,&quot;tid&quot;:&quot;144 (3 characters omitted)' ) [file &quot;/etc/nginx/owasp-modsecurity-crs/rules/REQUEST-920-PROTOCOL-ENFORCEMENT.conf&quot;] [line &quot;488&quot;] [id &quot;920270&quot;] [rev &quot;2&quot;] [msg &quot;Invalid character in request (null character)&quot;] [data &quot;&quot;] [severity &quot;2&quot;] [ver &quot;OWASP_CRS/3.0.0&quot;] [maturity &quot;9&quot;] [accuracy &quot;9&quot;] [tag &quot;application-multi&quot;] [tag &quot;language-multi&quot;] [tag &quot;platform-multi&quot;] [tag &quot;attack-protocol&quot;] [tag &quot;OWASP_CRS/PROTOCOL_VIOLATION/EVASION&quot;] [ref &quot;o21,1o22,1o25,1o26,1v921,67t:urlDecodeUni&quot;]
</I>
I was kind of expecting problems with 920270, but probably not as
deep rooted ones as this. But first, I need to be able to reproduce
this, and I can't.

Here is my curl call taking up your example:

curl 'localhost/index.html' -d 'extraParams=%7B%22node%22%3A%223%22%2C%22text%22%3A%22v%C3%A9gs%C5%91%20fejezet%22' --trace-ascii -
== Info:   Trying 127.0.0.1...
== Info: Connected to localhost (127.0.0.1) port 80 (#0)
=&gt; Send header, 153 bytes (0x99)
0000: POST /index.html HTTP/1.1
001b: Host: localhost
002c: User-Agent: curl/7.50.1
0045: Accept: */*
0052: Content-Length: 82
0066: Content-Type: application/x-www-form-urlencoded
0097: 
=&gt; Send data, 82 bytes (0x52)
0000: extraParams=%7B%22node%22%3A%223%22%2C%22text%22%3A%22v%C3%A9gs%
0040: C5%91%20fejezet%22
== Info: upload completely sent off: 82 out of 82 bytes

So the payload is exactly as your payload, but the said rule is not
being triggered.

Can you help me out here. Ideally with a curl call that triggers
920270 in the way you described.

Validating the byte range in combination with UTF8 and friends is
something we might have to drop for PL1. We let ASCII 0 stay in the
default install, but maybe it has to go in light of this false positive
which I think is generic to many languages not using the standard latin
ascii set.

Ahoj,

Christian


-- 
It is not useful for liberty that we abolish it in order to protect it.
--- Wolfgang Thierse, President of the German Parliament 
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message: <A HREF="002376.html">[Owasp-modsecurity-core-rule-set] Woe with 920270 (Null Byte...) (was: Re: Matched rule modification)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2372">[ date ]</a>
              <a href="thread.html#2372">[ thread ]</a>
              <a href="subject.html#2372">[ subject ]</a>
              <a href="author.html#2372">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
