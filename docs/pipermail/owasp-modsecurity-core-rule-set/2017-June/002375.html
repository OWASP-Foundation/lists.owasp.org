<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] SecRuleUpdateActionById and chained rules
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20SecRuleUpdateActionById%20and%0A%20chained%20rules&In-Reply-To=%3C20170601083509.setzaahf27myfmzs%40leander%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002374.html">
   <LINK REL="Next"  HREF="002381.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] SecRuleUpdateActionById and chained rules</H1>
    <B>Christian Folini</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20SecRuleUpdateActionById%20and%0A%20chained%20rules&In-Reply-To=%3C20170601083509.setzaahf27myfmzs%40leander%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] SecRuleUpdateActionById and chained rules">christian.folini at netnea.com
       </A><BR>
    <I>Thu Jun  1 08:35:09 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="002374.html">[Owasp-modsecurity-core-rule-set] SecRuleUpdateActionById and chained rules
</A></li>
        <LI>Next message: <A HREF="002381.html">[Owasp-modsecurity-core-rule-set]  Up next Monday: CRS chat
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2375">[ date ]</a>
              <a href="thread.html#2375">[ thread ]</a>
              <a href="subject.html#2375">[ subject ]</a>
              <a href="author.html#2375">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Great. Thanks for the confirmation. 

I feared there was something wrong with ModSec as it is a rarely used
feature and I only tried it out the first time when I covered 
SecRuleUpdateActionById for the 2nd edition of the handbook.

Ahoj,

Christian

On Thu, Jun 01, 2017 at 08:31:17AM +0000, Brian Bird wrote:
&gt;<i> Thanks! I've just tried it again as per your example and it seems to work (so I can only assume I had the rules in the wrong order when I first tried it).
</I>&gt;<i> 
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: Christian Folini [mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">christian.folini at netnea.com</A>] 
</I>&gt;<i> Sent: 01 June 2017 08:08
</I>&gt;<i> To: Brian Bird &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Brian.Bird at securetrading.com</A>&gt;
</I>&gt;<i> Cc: <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>
</I>&gt;<i> Subject: Re: [Owasp-modsecurity-core-rule-set] SecRuleUpdateActionById and chained rules
</I>&gt;<i> 
</I>&gt;<i> Brian,
</I>&gt;<i> 
</I>&gt;<i> I think you are doing it wrong. It works like out of the box for me:
</I>&gt;<i> 
</I>&gt;<i> Here is part of my config:
</I>&gt;<i> 
</I>&gt;<i> Include                 crs-rules/*.conf
</I>&gt;<i> SecRuleUpdateActionById 920440:1 &quot;setvar:tx.anomaly_score=+100&quot;
</I>&gt;<i> 
</I>&gt;<i> Then I made the following call, which triggers the rule 920440.
</I>&gt;<i> 
</I>&gt;<i> $&gt; curl localhost/index.asa
</I>&gt;<i> 
</I>&gt;<i> And here is the debug log:
</I>&gt;<i> 
</I>&gt;<i> [01/Jun/2017:09:02:51 +0200] [localhost/sid#55c6741331d8][rid#7fe120002970][/index.asa][5] Rule 55c6732d66f0: SecRule &quot;REQUEST_BASENAME&quot; &quot;@rx \\.(.*)$&quot; &quot;phase:request,log,auditlog,chain,capture,t:none,t:urlDecodeUni,t:lowercase,block,msg:'URL file extension is restricted by policy',severity:CRITICAL,rev:2,ver:OWASP_CRS/3.0.0,maturity:9,accuracy:9,id:920440,logdata:%{TX.0},tag:application-multi,tag:language-multi,tag:platform-multi,tag:attack-protocol,tag:OWASP_CRS/POLICY/EXT_RESTRICTED,tag:WASCTC/WASC-15,tag:OWASP_TOP_10/A7,tag:PCI/6.5.10,setvar:tx.extension=.%{tx.1}/&quot;
</I>&gt;<i> [01/Jun/2017:09:02:51 +0200] [localhost/sid#55c6741331d8][rid#7fe120002970][/index.asa][9] T (0) urlDecodeUni: &quot;index.asa&quot;
</I>&gt;<i> [01/Jun/2017:09:02:51 +0200] [localhost/sid#55c6741331d8][rid#7fe120002970][/index.asa][9] T (0) lowercase: &quot;index.asa&quot;
</I>&gt;<i> [01/Jun/2017:09:02:51 +0200] [localhost/sid#55c6741331d8][rid#7fe120002970][/index.asa][4] Transformation completed in 4 usec.
</I>&gt;<i> [01/Jun/2017:09:02:51 +0200] [localhost/sid#55c6741331d8][rid#7fe120002970][/index.asa][4] Executing operator &quot;rx&quot; with param &quot;\\.(.*)$&quot; against REQUEST_BASENAME.
</I>&gt;<i> [01/Jun/2017:09:02:51 +0200] [localhost/sid#55c6741331d8][rid#7fe120002970][/index.asa][9] Target value: &quot;index.asa&quot;
</I>&gt;<i> [01/Jun/2017:09:02:51 +0200] [localhost/sid#55c6741331d8][rid#7fe120002970][/index.asa][9] Added regex subexpression to TX.0: .asa
</I>&gt;<i> [01/Jun/2017:09:02:51 +0200] [localhost/sid#55c6741331d8][rid#7fe120002970][/index.asa][9] Added regex subexpression to TX.1: asa
</I>&gt;<i> [01/Jun/2017:09:02:51 +0200] [localhost/sid#55c6741331d8][rid#7fe120002970][/index.asa][4] Operator completed in 7 usec.
</I>&gt;<i> [01/Jun/2017:09:02:51 +0200] [localhost/sid#55c6741331d8][rid#7fe120002970][/index.asa][9] Setting variable: tx.extension=.%{tx.1}/
</I>&gt;<i> [01/Jun/2017:09:02:51 +0200] [localhost/sid#55c6741331d8][rid#7fe120002970][/index.asa][9] Resolved macro %{tx.1} to: asa
</I>&gt;<i> [01/Jun/2017:09:02:51 +0200] [localhost/sid#55c6741331d8][rid#7fe120002970][/index.asa][9] Set variable &quot;tx.extension&quot; to &quot;.asa/&quot;.
</I>&gt;<i> [01/Jun/2017:09:02:51 +0200] [localhost/sid#55c6741331d8][rid#7fe120002970][/index.asa][4] Rule returned 1.
</I>&gt;<i> [01/Jun/2017:09:02:51 +0200] [localhost/sid#55c6741331d8][rid#7fe120002970][/index.asa][9] Match -&gt; mode NEXT_RULE.
</I>&gt;<i> [01/Jun/2017:09:02:51 +0200] [localhost/sid#55c6741331d8][rid#7fe120002970][/index.asa][4] Recipe: Invoking rule 55c6732de088; [file &quot;/home/dune73/data/git/crs-official/rules/REQUEST-920-PROTOCOL-ENFORCEMENT.conf&quot;] [line &quot;1075&quot;].
</I>&gt;<i> [01/Jun/2017:09:02:51 +0200] [localhost/sid#55c6741331d8][rid#7fe120002970][/index.asa][5] Rule 55c6732de088: SecRule &quot;TX:EXTENSION&quot; &quot;@within %{tx.restricted_extensions}&quot; &quot;t:none,setvar:tx.msg=%{rule.msg},setvar:tx.anomaly_score=+%{tx.critical_anomaly_score},setvar:tx.%{rule.id}-OWASP_CRS/POLICY/EXT_RESTRICTED-%{matched_var_name}=%{matched_var},setvar:tx.anomaly_score=+100&quot;
</I>&gt;<i> [01/Jun/2017:09:02:51 +0200] [localhost/sid#55c6741331d8][rid#7fe120002970][/index.asa][4] Transformation completed in 0 usec.
</I>&gt;<i> [01/Jun/2017:09:02:51 +0200] [localhost/sid#55c6741331d8][rid#7fe120002970][/index.asa][4] Executing operator &quot;within&quot; with param &quot;%{tx.restricted_extensions}&quot; against TX:extension.
</I>&gt;<i> [01/Jun/2017:09:02:51 +0200] [localhost/sid#55c6741331d8][rid#7fe120002970][/index.asa][9] Target value: &quot;.asa/&quot;
</I>&gt;<i> [01/Jun/2017:09:02:51 +0200] [localhost/sid#55c6741331d8][rid#7fe120002970][/index.asa][9] Resolved macro %{tx.restricted_extensions} to: .asa/ .asax/ .ascx/ .axd/ .backup/ .bak/ .bat/ .cdx/ .cer/ .cfg/ .cmd/ .com/ .config/ .conf/ .cs/ .csproj/ .csr/ .dat/ .db/ .dbf/ .dll/ .dos/ .htr/ .htw/ .ida/ .idc/ .idq/ .inc/ .ini/ .key/ .licx/ .lnk/ .log/ .mdb/ .old/ .pass/ .pdb/ .pol/ .printer/ .pwd/ .resources/ .resx/ .sql/ .sys/ .vb/ .vbs/ .vbproj/ .vsdisco/ .webinfo/ .xsd/ .xsx/
</I>&gt;<i> [01/Jun/2017:09:02:51 +0200] [localhost/sid#55c6741331d8][rid#7fe120002970][/index.asa][4] Operator completed in 9 usec.
</I>&gt;<i> --
</I>&gt;<i> [01/Jun/2017:09:02:51 +0200] [localhost/sid#55c6741331d8][rid#7fe120002970][/index.asa][9] Resolved macro %{rule.id} to: 920440
</I>&gt;<i> [01/Jun/2017:09:02:51 +0200] [localhost/sid#55c6741331d8][rid#7fe120002970][/index.asa][9] Resolved macro %{matched_var_name} to: TX:extension
</I>&gt;<i> [01/Jun/2017:09:02:51 +0200] [localhost/sid#55c6741331d8][rid#7fe120002970][/index.asa][9] Resolved macro %{matched_var} to: .asa/
</I>&gt;<i> [01/Jun/2017:09:02:51 +0200] [localhost/sid#55c6741331d8][rid#7fe120002970][/index.asa][9] Set variable &quot;tx.920440-OWASP_CRS/POLICY/EXT_RESTRICTED-TX:extension&quot; to &quot;.asa/&quot;.
</I>&gt;<i> [01/Jun/2017:09:02:51 +0200] [localhost/sid#55c6741331d8][rid#7fe120002970][/index.asa][9] Setting variable: tx.anomaly_score=+100
</I>&gt;<i> [01/Jun/2017:09:02:51 +0200] [localhost/sid#55c6741331d8][rid#7fe120002970][/index.asa][9] Original collection variable: tx.anomaly_score = &quot;5&quot;
</I>&gt;<i> [01/Jun/2017:09:02:51 +0200] [localhost/sid#55c6741331d8][rid#7fe120002970][/index.asa][9] Relative change: anomaly_score=5+100
</I>&gt;<i> [01/Jun/2017:09:02:51 +0200] [localhost/sid#55c6741331d8][rid#7fe120002970][/index.asa][9] Set variable &quot;tx.anomaly_score&quot; to &quot;105&quot;.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Maybe you have your Update statement before the rule include. Other than that I do not know what's wrong.
</I>&gt;<i> 
</I>&gt;<i> Cheers,
</I>&gt;<i> 
</I>&gt;<i> Christian
</I>&gt;<i> 
</I>&gt;<i> On Tue, May 30, 2017 at 09:45:26AM +0000, Brian Bird wrote:
</I>&gt;<i> &gt; I'm deploying modsecurity 2.9.1 with the OWASP CRS 3.0.2 rules.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; I'd like to update a few rules to have different anomaly scores. This is quite easy for a normal rule: eg.
</I>&gt;<i> &gt; SecRuleUpdateActionById 920350 &quot;setvar:tx.anomaly_score=+100&quot;
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; However, for chained rules this type of update will only update the first rule in the chain. Eg.
</I>&gt;<i> &gt; SecRuleUpdateActionById 920440 &quot;setvar:tx.anomaly_score=+100,chain&quot;
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Since the action is non-disruptive the score addition takes place whenever the first rule in the chain matches (as referenced <A HREF="http://blog.modsecurity.org/2008/07/modsecurity-tri.html">http://blog.modsecurity.org/2008/07/modsecurity-tri.html</A>).
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Has anything been done to allow SecRuleUpdateActionById to specify offsets (eg. as suggested at <A HREF="https://github.com/SpiderLabs/ModSecurity/issues/190">https://github.com/SpiderLabs/ModSecurity/issues/190</A>)?
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; I tried this:
</I>&gt;<i> &gt; SecRuleUpdateActionById 920440:1 &quot;setvar:tx.anomaly_score=+100,chain&quot;
</I>&gt;<i> &gt; and there is no error about the Rule Id not existing, but it doesn't seem like the update has taken place. I'm assuming this feature suggestion hasn't been implemented yet and the update action is ignored because there is no rule id &quot;920440:1&quot;?
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; So my question is: Is it possible to change the anomaly score for a specified chained rule in the CRS without editing the CRS files directly?
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Thanks
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Brian
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; 
</I>&gt;<i> 
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; Owasp-modsecurity-core-rule-set mailing list 
</I>&gt;<i> &gt; <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>
</I>&gt;<i> &gt; <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-s">https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-s</A>
</I>&gt;<i> &gt; et
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> --
</I>&gt;<i> <A HREF="https://www.feistyduck.com/training/modsecurity-training-course">https://www.feistyduck.com/training/modsecurity-training-course</A>
</I>&gt;<i> mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">christian.folini at netnea.com</A>
</I>&gt;<i> twitter: @ChrFolini
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Owasp-modsecurity-core-rule-set mailing list
</I>&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>
</I>&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set</A>
</I>
-- 
<A HREF="https://www.feistyduck.com/training/modsecurity-training-course">https://www.feistyduck.com/training/modsecurity-training-course</A>
mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">christian.folini at netnea.com</A>
twitter: @ChrFolini
</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002374.html">[Owasp-modsecurity-core-rule-set] SecRuleUpdateActionById and chained rules
</A></li>
	<LI>Next message: <A HREF="002381.html">[Owasp-modsecurity-core-rule-set]  Up next Monday: CRS chat
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2375">[ date ]</a>
              <a href="thread.html#2375">[ thread ]</a>
              <a href="subject.html#2375">[ subject ]</a>
              <a href="author.html#2375">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
