<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] @within in crs_30 and similar (restricted extensions)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20%40within%20in%20crs_30%20and%20similar%0A%20%28restricted%20extensions%29&In-Reply-To=201005251820.12804.ryan.barnett%40breach.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000390.html">
   <LINK REL="Next"  HREF="000392.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] @within in crs_30 and similar (restricted extensions)</H1>
    <B>Brian Rectanus</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20%40within%20in%20crs_30%20and%20similar%0A%20%28restricted%20extensions%29&In-Reply-To=201005251820.12804.ryan.barnett%40breach.com"
       TITLE="[Owasp-modsecurity-core-rule-set] @within in crs_30 and similar (restricted extensions)">Brian.Rectanus at breach.com
       </A><BR>
    <I>Tue May 25 22:21:13 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="000390.html">[Owasp-modsecurity-core-rule-set] @within in crs_30 and similar	(restricted extensions)
</A></li>
        <LI>Next message: <A HREF="000392.html">[Owasp-modsecurity-core-rule-set] Is there any other type of	inspecting upload fie?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#391">[ date ]</a>
              <a href="thread.html#391">[ thread ]</a>
              <a href="subject.html#391">[ subject ]</a>
              <a href="author.html#391">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>[Apologies if anyone gets this &gt;1x -- email server problems today]

On 05/25/2010 03:20 PM, Ryan Barnett wrote:
&gt;<i> On Tuesday 25 May 2010 17:41:55 <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">modsec at enosis.com</A> wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> James:
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;&gt;<i> I suspect your problem is related to the earlier-reported
</I>&gt;<i> 
</I>&gt;&gt;<i> REQUEST_HEADERS_NAMES problem in
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;<i> &lt;<A HREF="https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/2010-Apr">https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/2010-Apr</A>
</I>&gt;<i> 
</I>&gt;&gt;<i> il/000357.html&gt;
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;&gt;<i> The @within operator is misnamed for modsec's semantics.
</I>&gt;<i> 
</I>&gt;&gt;<i> Or the documentation could be clearer. Or both.
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;&gt;<i> @within is (essentially) a simple linear string search:
</I>&gt;<i> 
</I>&gt;&gt;<i> your argument &quot;.do&quot; was found in &quot;foo .dos bar&quot; IOW, the
</I>&gt;<i> 
</I>&gt;&gt;<i> operation is what is more usually called &quot;string match&quot;.
</I>&gt;<i> 
</I>&gt;&gt;<i> Perhaps it should be called &quot;@sm&quot;.
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> Yeah, we had some internal debates about naming operators. The thought
</I>&gt;<i> was that the average Mod user was not necessarily a developer/programmer
</I>&gt;<i> so they might not understand some of these terms. That is why we tried
</I>&gt;<i> to name them in an easier (albeit not quite as accurate as you have
</I>&gt;<i> pointed out) name.
</I>
Not &quot;string match&quot; as that is what @streq is.  This is a &quot;substring
match&quot;, which @contains and @within are.  @within is similar to
@contains, but one major difference in that the matching operands are
reversed:

SecRule ARGS:foo &quot;@contains bar&quot; is &quot;evaluate true if the foo argument
value contains 'bar' string&quot;.  So if foo=foobar, then bar would match as
it is a substring of &quot;foobar&quot;.

SecRule ARGS:foo &quot;@within bar&quot; is &quot;evaluate true if the foo argument
value is found within the string 'bar'&quot;.  So, if foo=foobar then there
is no match as there is no &quot;foobar&quot; substring in &quot;bar&quot;.


&gt;<i> 
</I>&gt;&gt;<i> Because modsec provides &quot;set&quot; semantics (&quot;Collections&quot;) and
</I>&gt;<i> 
</I>&gt;&gt;<i> the appearance of tokenized input (such as your space-delimited
</I>&gt;<i> 
</I>&gt;&gt;<i> %{tx.restricted.extensions} it's sensible for you (and by
</I>&gt;<i> 
</I>&gt;&gt;<i> the evidence, the crs authors) to believe that @within will
</I>&gt;<i> 
</I>&gt;&gt;<i> understand the context and magically switch between strings
</I>&gt;<i> 
</I>&gt;&gt;<i> and tokens. Maybe it c/should in some cases.
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;&gt;<i> An operator like @containsWord does match on locale alphanum_
</I>&gt;<i> 
</I>&gt;&gt;<i> tokens, but on the reverse of match and target for the rule
</I>&gt;<i> 
</I>&gt;&gt;<i> variable and operator argument.
</I>
Eventually there will be a similar operator with boundaries.  But what
are those boundaries (whitespace, what localle, etc)?  That makes things
complex for configuration.

&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;&gt;<i> @within is not, however, token based. So crs_30 rules like
</I>&gt;<i> 
</I>&gt;&gt;<i> 960035 and 960038 will unexpectedly match even when the
</I>&gt;<i> 
</I>&gt;&gt;<i> operation appears 'obviously' token-based. (e.g., on 960038,
</I>&gt;<i> 
</I>&gt;&gt;<i> the ordinary and acceptable &quot;Connection&quot; header will be found
</I>&gt;<i> 
</I>&gt;&gt;<i> @within &quot;Proxy-Connection ...&quot;).
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;&gt;<i> One might think @pm would be a workable substitute for the
</I>&gt;<i> 
</I>&gt;&gt;<i> rule 960038 case, but @pm apparently doesn't perform %{macro}
</I>&gt;<i> 
</I>&gt;&gt;<i> substitution for its entire argument (@2.5.12). In the case
</I>&gt;<i> 
</I>&gt;&gt;<i> of this rule, tho, the simple workaround is to use @pm and
</I>&gt;<i> 
</I>&gt;&gt;<i> just put the restricted headers list directly into the rule.
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;&gt;<i> But in your case, with the longer list for rule 960035, @pm is
</I>&gt;<i> 
</I>&gt;&gt;<i> out. As a workaround, perhaps use @pmFromFile. Just move the
</I>&gt;<i> 
</I>&gt;&gt;<i> list to a one-per-line file of your making.
</I>
@pm and @pmFromFile are identical from a matching point of view.
@pmFromFile just accepts longer lists and also preserves whitespace
instead of tokenizing on whitespace.


&gt;<i> 
</I>&gt;<i> I just updated the source templates for v2.0.7 and I opted to use
</I>&gt;<i> boundary characters (/.../) when specifying the TX variables and then
</I>&gt;<i> including them when we do the checks later. It is a similar concept to
</I>&gt;<i> what Brian documented for @pmFromFile and IP addresses where you want to
</I>&gt;<i> avoid partial matches -
</I>&gt;<i> <A HREF="http://www.modsecurity.org/documentation/modsecurity-apache/2.5.12/modsecurity2-apache-reference.html#N11D9B">http://www.modsecurity.org/documentation/modsecurity-apache/2.5.12/modsecurity2-apache-reference.html#N11D9B</A>
</I>

Yep, that is unfortunatly how it has to be done right now.

You could also do it like this:

SecAction &quot;pass,nolog,setvar:tx.restricted_extensions='.dos|.foo|.bar|.baz'&quot;
...
SecRule REQUEST_FILENAME &quot;(\.[^\.]{1,10})$&quot; \
  &quot;capture,pass,setvar:TX.EXTENSION='tx.1|',...&quot;
...
SecRule TX:EXTENSION &quot;@within %{tx.restricted_extensions}|&quot; \
  &quot;deny,...&quot;

Essentially, that grabs out the extension (1 to 10 chars), prefixes it
with a &quot;.&quot;, appends a &quot;|&quot; (so you have &quot;.do|&quot; in TX:EXTENSION for
example), then matches this within &quot;.do|.foo|.bar|.baz|&quot; properly.

This looks nicer for extensions, but you could also do:

SecAction &quot;pass,nolog,setvar:tx.restricted_extensions='dos|foo|bar|baz'&quot;
...
SecRule REQUEST_FILENAME &quot;\.([^\.]{1,10})$&quot; \
  &quot;capture,pass,setvar:TX.EXTENSION='|tx.1|',...&quot;
...
SecRule TX:EXTENSION &quot;@within |%{tx.restricted_extensions}|&quot; \
  &quot;deny,...&quot;

Which looks better (more consistent) for other forms of data as well.
Or maybe use &quot;,&quot; instead of &quot;|&quot;?  Non-regex geeks may like that better :)

-B

-- 
Brian Rectanus
Breach Security
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000390.html">[Owasp-modsecurity-core-rule-set] @within in crs_30 and similar	(restricted extensions)
</A></li>
	<LI>Next message: <A HREF="000392.html">[Owasp-modsecurity-core-rule-set] Is there any other type of	inspecting upload fie?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#391">[ date ]</a>
              <a href="thread.html#391">[ thread ]</a>
              <a href="subject.html#391">[ subject ]</a>
              <a href="author.html#391">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
