<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] varible in dos rule exipired	earlier then expected
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20varible%20in%20dos%20rule%20exipired%0A%09earlier%20then%20expected&In-Reply-To=%3CCA%2Byt8%2B%3DXyJ1-urHL%2BEEp1sbNjR5DoqCDvdoeJzkrjOGZDywKSg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001063.html">
   <LINK REL="Next"  HREF="001068.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] varible in dos rule exipired	earlier then expected</H1>
    <B>leon xu</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20varible%20in%20dos%20rule%20exipired%0A%09earlier%20then%20expected&In-Reply-To=%3CCA%2Byt8%2B%3DXyJ1-urHL%2BEEp1sbNjR5DoqCDvdoeJzkrjOGZDywKSg%40mail.gmail.com%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] varible in dos rule exipired	earlier then expected">xcmffl at gmail.com
       </A><BR>
    <I>Wed Jun  6 00:58:08 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="001063.html">[Owasp-modsecurity-core-rule-set] error 403 with CRS 2.2.4 &amp;	modsecurity 2.6.5
</A></li>
        <LI>Next message: <A HREF="001068.html">[Owasp-modsecurity-core-rule-set] Dynamic DAST/WAF Integration
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1062">[ date ]</a>
              <a href="thread.html#1062">[ thread ]</a>
              <a href="subject.html#1062">[ subject ]</a>
              <a href="author.html#1062">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello, everyone

    I use modsecurity 2.6 protect against dos attack for some specific
pages.
This is the  rule. I test it in my box, it works. But when in some
product *environment(large
number of  *concurrent connections in worker MPM)*, it failed.*
*In the early time I use expiredvar:dos_block every 1800 seconds, as the
modsecurity docs suggests. I found the var &quot;dos_block&quot; expired within 1-10
second(**I dump the resource db),n**ot 1800. So I changed it with
*deprecatevar. But
it does not works too.
Does it because of the concurrent problem?

Thanks.


----------------------------------------------------------------

SecRule REQUEST_URI &quot;^/login.php&quot; \

&quot;phase:1,capture,t:lowercase,t:urlDecodeUni,pass,nolog,setvar:tx.dos_uri=%{TX.1},skip:1&quot;
SecAction &quot;phase:1,pass,nolog,skipAfter:Dos_Marker&quot;





SecAction &quot;phase:1,pass,nolog,t:none,setvar:tx.real_ip=%{REMOTE_ADDR}&quot;
SecAction &quot;phase:1,nolog,initcol:resource='%{tx.real_ip}/'&quot;



SecRule RESOURCE:SHOULD_LOG &quot;@eq 1&quot;
&quot;phase:1,pass,nolog,setvar:resource.should_log=0,skip:2&quot;

#already blocked, nolog here
SecRule RESOURCE:DOS_BLOCKED &quot;@eq 1&quot; \

&quot;phase:1,deny,nolog,severity:'2',status:403,deprecatevar:resource.dos_blocked=1/1800,skipAfter:Dos_Marker&quot;

SecAction &quot;phase:1,pass,nolog,skip:1&quot;

#log version, logdata is real client ip
SecRule RESOURCE:DOS_BLOCKED &quot;@eq 1&quot; \

 &quot;phase:1,deny,log,auditlog,severity:'2',msg:'99010',id:'99010001',tag:'9901',status:403,deprecatevar:resource.dos_blocked=1/1800,logdata:%{tx.real_ip},skipAfter:Dos_Marker&quot;

#counter++
SecAction
&quot;phase:1,nolog,setvar:resource.dos_request_counter=+1,deprecatevar:resource.dos_request_counter=10/60&quot;


# if counter == max then block
SecRule RESOURCE:DOS_REQUEST_COUNTER &quot;@ge 10&quot; \

&quot;phase:5,nolog,setvar:resource.dos_request_counter=0,setvar:resource.dos_blocked=1,setvar:resource.should_log=1&quot;

SecMarker Dos_Marker
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120606/1dbe15ad/attachment.html">http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120606/1dbe15ad/attachment.html</A>&gt;
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001063.html">[Owasp-modsecurity-core-rule-set] error 403 with CRS 2.2.4 &amp;	modsecurity 2.6.5
</A></li>
	<LI>Next message: <A HREF="001068.html">[Owasp-modsecurity-core-rule-set] Dynamic DAST/WAF Integration
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1062">[ date ]</a>
              <a href="thread.html#1062">[ thread ]</a>
              <a href="subject.html#1062">[ subject ]</a>
              <a href="author.html#1062">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
