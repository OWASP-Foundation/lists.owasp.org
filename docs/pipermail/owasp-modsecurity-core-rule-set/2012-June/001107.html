<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Question on optional_rules/modsecurity_crs_25_cc_known.conf
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Question%20on%0A%20optional_rules/modsecurity_crs_25_cc_known.conf&In-Reply-To=%3CCC093079.53050%25ryan.barnett%40owasp.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001106.html">
   <LINK REL="Next"  HREF="001108.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Question on optional_rules/modsecurity_crs_25_cc_known.conf</H1>
    <B>Ryan Barnett</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Question%20on%0A%20optional_rules/modsecurity_crs_25_cc_known.conf&In-Reply-To=%3CCC093079.53050%25ryan.barnett%40owasp.org%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] Question on optional_rules/modsecurity_crs_25_cc_known.conf">RBarnett at trustwave.com
       </A><BR>
    <I>Fri Jun 22 00:13:46 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="001106.html">[Owasp-modsecurity-core-rule-set] Question on	optional_rules/modsecurity_crs_25_cc_known.conf
</A></li>
        <LI>Next message: <A HREF="001108.html">[Owasp-modsecurity-core-rule-set] [Rule Update - Discussion Thread]	Documenting rules with Markdown
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1107">[ date ]</a>
              <a href="thread.html#1107">[ thread ]</a>
              <a href="subject.html#1107">[ subject ]</a>
              <a href="author.html#1107">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On 6/21/12 5:25 PM, &quot;Jeremy Brown&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">jeremy.b at infosend.com</A>&gt; wrote:

&gt;<i>Hello All,
</I>&gt;<i>
</I>&gt;<i>I am admitedly a novice at mod_security, and am currently trying to get
</I>&gt;<i>myself up to speed by tuning it in a test environment to my needs.
</I>&gt;<i>
</I>&gt;<i>I have been testing the rules in
</I>&gt;<i>optional_rules/modsecurity_crs_25_cc_known.conf (2.2.5), and am having
</I>&gt;<i>problems getting the RESPONSE_BODY rules near the bottom to work
</I>&gt;<i>properly.  FYI: The REQUEST rules near the top work fine.
</I>&gt;<i>
</I>&gt;<i>Using a fake Visa number that matches MOD10 validation, what I have found
</I>&gt;<i>through debug is that rule 920008 is matching properly.  However, it
</I>&gt;<i>moves on to the next rule in the chain, line 75 (SecRule TX:1....), which
</I>&gt;<i>is returning &quot;Rule returned 0.&quot;   This seems to terminate the chain and
</I>&gt;<i>nullify the effect of the parent rule, 920008.
</I>&gt;<i>
</I>&gt;<i>What I found through Ivan's book is that TX:# variables will apparently
</I>&gt;<i>not be set if the &quot;capture&quot; action is not set.  When I add &quot;capture&quot; to
</I>&gt;<i>920008, everything works as expected.
</I>&gt;<i>
</I>&gt;<i>Am I misunderstanding this problem?  Should capture not be a required
</I>&gt;<i>action in the parent of the chain?  Thank you for your assistance.
</I>

Hey Jeremy,
Looks like a legit error of omission.  This was tested in a previous
version and worked so I guess the capture action got dropped along the way
somewhere... Good catch.  We will add it back into these rules.

By the way, this further re-enforces the need for a full regression
testing update.  I will include this as part of our planning CRS update.

Thanks

--
Ryan Barnett
Trustwave SpiderLabs
ModSecurity Project Leader
OWASP ModSecurity CRS Project Leader



&gt;<i>
</I>&gt;<i>****************
</I>&gt;<i>* ORIGINAL RULES *
</I>&gt;<i>****************
</I>&gt;<i>
</I>&gt;<i># Visa
</I>&gt;<i>SecRule RESPONSE_BODY|RESPONSE_HEADERS:Location &quot;@verifyCC
</I>&gt;<i>(?:^|[^\d])(?&lt;!google_ad_client =
</I>&gt;<i>\&quot;pub-)(4\d{3}\-?\d{4}\-?\d{2}\-?\d{2}\-?\d(?:\d{3})??)(?:[^\d]|$)&quot; \
</I>&gt;<i>  &quot;chain,logdata:'Start of CC #:
</I>&gt;<i>%{tx.ccdata_begin}***...',phase:4,t:none,ctl:auditLogParts=-E,block,msg:'V
</I>&gt;<i>isa Credit Card Number sent from site to
</I>&gt;<i>user',id:'920008',tag:'WASCTC/5.2',t
</I>&gt;<i>        SecRule TX:1 &quot;(\d{4}\-?\d{4}\-?\d{2}\-?\d{2}\-?\d{1,4})&quot;
</I>&gt;<i>&quot;chain,capture,setvar:tx.ccdata=%{tx.1}&quot;
</I>&gt;<i>                SecRule TX:CCDATA &quot;^(\d{4}\-?)&quot;
</I>&gt;<i>&quot;capture,setvar:tx.ccdata_begin=%{tx.1},setvar:tx.anomaly_score=+%{tx.crit
</I>&gt;<i>ical_anomaly_score},setvar:tx.%{rule.id}-LEAKAGE/CC-%{matched_var_name
</I>&gt;<i>
</I>&gt;<i>**************
</I>&gt;<i>* LEVEL 9 DEBUG *
</I>&gt;<i>**************
</I>&gt;<i>
</I>&gt;<i>[21/Jun/2012:13:55:25 --0700]
</I>&gt;<i>[test.xyz.com/sid#2b6ce015c0a8][rid#2b6ce12fd590][/~test/waftest.html][4]
</I>&gt;<i>Recipe: Invoking rule 2b6ce0495118; [file &quot;/etc/httpd/conf/modsec
</I>&gt;<i>urity.d/activated_rules/modsecurity_crs_25_cc_known.conf&quot;] [line &quot;74&quot;]
</I>&gt;<i>[id &quot;920008&quot;].
</I>&gt;<i>[21/Jun/2012:13:55:25 --0700]
</I>&gt;<i>[test.xyz.com/sid#2b6ce015c0a8][rid#2b6ce12fd590][/~test/waftest.html][5]
</I>&gt;<i>Rule 2b6ce0495118: SecRule &quot;RESPONSE_BODY|RESPONSE_HEADERS:Locati
</I>&gt;<i>on&quot; &quot;@verifyCC (?:^|[^\\d])(?&lt;!google_ad_client =
</I>&gt;<i>\&quot;pub-)(4\\d{3}\\-?\\d{4}\\-?\\d{2}\\-?\\d{2}\\-?\\d(?:\\d{3})??)(?:[^\\d]
</I>&gt;|<i>$)&quot; &quot;phase:4,log,chain,logdata:'Start of CC #: %{tx.ccdata_begin}**
</I>&gt;<i>*...',t:none,ctl:auditLogParts=-E,block,msg:'Visa Credit Card Number sent
</I>&gt;<i>from site to user',id:920008,tag:WASCTC/5.2,tag:PCI/3.3,severity:1&quot;
</I>&gt;<i>[21/Jun/2012:13:55:25 --0700]
</I>&gt;<i>[test.xyz.com/sid#2b6ce015c0a8][rid#2b6ce12fd590][/~test/waftest.html][4]
</I>&gt;<i>Transformation completed in 0 usec.
</I>&gt;<i>[21/Jun/2012:13:55:25 --0700]
</I>&gt;<i>[test.xyz.com/sid#2b6ce015c0a8][rid#2b6ce12fd590][/~test/waftest.html][4]
</I>&gt;<i>Executing operator &quot;verifyCC&quot; with param &quot;(?:^|[^\\d])(?&lt;!google_
</I>&gt;<i>ad_client =
</I>&gt;<i>\&quot;pub-)(4\\d{3}\\-?\\d{4}\\-?\\d{2}\\-?\\d{2}\\-?\\d(?:\\d{3})??)(?:[^\\d]
</I>&gt;|<i>$)&quot; against RESPONSE_BODY.
</I>&gt;<i>[21/Jun/2012:13:55:25 --0700]
</I>&gt;<i>[test.xyz.com/sid#2b6ce015c0a8][rid#2b6ce12fd590][/~test/waftest.html][9]
</I>&gt;<i>Target value: &quot;&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n  &lt;head&gt;\n    &lt;title&gt;Page
</I>&gt;<i> To Test WAF Output Blocking&lt;/title&gt;\n  &lt;/head&gt;\n\n  &lt;body&gt;\n    &lt;p&gt;Here
</I>&gt;<i>is a credit card number.  Should block: 4111111111111111&lt;/p&gt;\n
</I>&gt;<i>&lt;/body&gt;\n&lt;/html&gt;\n&quot;
</I>&gt;<i>[21/Jun/2012:13:55:25 --0700]
</I>&gt;<i>[test.xyz.com/sid#2b6ce015c0a8][rid#2b6ce12fd590][/~test/waftest.html][4]
</I>&gt;<i>Operator completed in 33 usec.
</I>&gt;<i>[21/Jun/2012:13:55:25 --0700]
</I>&gt;<i>[test.xyz.com/sid#2b6ce015c0a8][rid#2b6ce12fd590][/~test/waftest.html][4]
</I>&gt;<i>Ctl: Set auditLogParts to ABIJDFHZ.
</I>&gt;<i>[21/Jun/2012:13:55:25 --0700]
</I>&gt;<i>[test.xyz.com/sid#2b6ce015c0a8][rid#2b6ce12fd590][/~test/waftest.html][4]
</I>&gt;<i>Rule returned 1.
</I>&gt;<i>[21/Jun/2012:13:55:25 --0700]
</I>&gt;<i>[test.xyz.com/sid#2b6ce015c0a8][rid#2b6ce12fd590][/~test/waftest.html][9]
</I>&gt;<i>Match -&gt; mode NEXT_RULE.
</I>&gt;<i>[21/Jun/2012:13:55:25 --0700]
</I>&gt;<i>[test.xyz.com/sid#2b6ce015c0a8][rid#2b6ce12fd590][/~test/waftest.html][4]
</I>&gt;<i>Recipe: Invoking rule 2b6ce049cff8; [file &quot;/etc/httpd/conf/modsec
</I>&gt;<i>urity.d/activated_rules/modsecurity_crs_25_cc_known.conf&quot;] [line &quot;75&quot;].
</I>&gt;<i>[21/Jun/2012:13:55:25 --0700]
</I>&gt;<i>[test.xyz.com/sid#2b6ce015c0a8][rid#2b6ce12fd590][/~test/waftest.html][5]
</I>&gt;<i>Rule 2b6ce049cff8: SecRule &quot;TX:0&quot; &quot;@rx (\\d{4}\\-?\\d{4}\\-?\\d{2
</I>&gt;<i>}\\-?\\d{2}\\-?\\d{1,4})&quot; &quot;chain,capture,setvar:tx.ccdata=%{tx.1}&quot;
</I>&gt;<i>[21/Jun/2012:13:55:25 --0700]
</I>&gt;<i>[test.xyz.com/sid#2b6ce015c0a8][rid#2b6ce12fd590][/~test/waftest.html][4]
</I>&gt;<i>Rule returned 0.
</I>&gt;<i>[21/Jun/2012:13:55:25 --0700]
</I>&gt;<i>[test.xyz.com/sid#2b6ce015c0a8][rid#2b6ce12fd590][/~test/waftest.html][9]
</I>&gt;<i>No match, chained -&gt; mode NEXT_CHAIN.
</I>&gt;<i>_______________________________________________
</I>&gt;<i>Owasp-modsecurity-core-rule-set mailing list
</I>&gt;<i><A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>
</I>&gt;<i><A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set</A>
</I>

This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001106.html">[Owasp-modsecurity-core-rule-set] Question on	optional_rules/modsecurity_crs_25_cc_known.conf
</A></li>
	<LI>Next message: <A HREF="001108.html">[Owasp-modsecurity-core-rule-set] [Rule Update - Discussion Thread]	Documenting rules with Markdown
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1107">[ date ]</a>
              <a href="thread.html#1107">[ thread ]</a>
              <a href="subject.html#1107">[ subject ]</a>
              <a href="author.html#1107">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
