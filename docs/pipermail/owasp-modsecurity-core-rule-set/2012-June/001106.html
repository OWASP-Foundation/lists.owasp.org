<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Question on	optional_rules/modsecurity_crs_25_cc_known.conf
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Question%20on%0A%09optional_rules/modsecurity_crs_25_cc_known.conf&In-Reply-To=%3C4A12944D9F6AB24BB3423EEB6AED8860CEE1274A%40FUL-INF-MAIL-01.infosendmail.local%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001105.html">
   <LINK REL="Next"  HREF="001107.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Question on	optional_rules/modsecurity_crs_25_cc_known.conf</H1>
    <B>Jeremy Brown</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Question%20on%0A%09optional_rules/modsecurity_crs_25_cc_known.conf&In-Reply-To=%3C4A12944D9F6AB24BB3423EEB6AED8860CEE1274A%40FUL-INF-MAIL-01.infosendmail.local%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] Question on	optional_rules/modsecurity_crs_25_cc_known.conf">jeremy.b at infosend.com
       </A><BR>
    <I>Thu Jun 21 21:25:34 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="001105.html">[Owasp-modsecurity-core-rule-set] Rule 950901 optimization
</A></li>
        <LI>Next message: <A HREF="001107.html">[Owasp-modsecurity-core-rule-set] Question on optional_rules/modsecurity_crs_25_cc_known.conf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1106">[ date ]</a>
              <a href="thread.html#1106">[ thread ]</a>
              <a href="subject.html#1106">[ subject ]</a>
              <a href="author.html#1106">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello All,

I am admitedly a novice at mod_security, and am currently trying to get myself up to speed by tuning it in a test environment to my needs.

I have been testing the rules in optional_rules/modsecurity_crs_25_cc_known.conf (2.2.5), and am having problems getting the RESPONSE_BODY rules near the bottom to work properly.  FYI: The REQUEST rules near the top work fine.

Using a fake Visa number that matches MOD10 validation, what I have found through debug is that rule 920008 is matching properly.  However, it moves on to the next rule in the chain, line 75 (SecRule TX:1....), which is returning &quot;Rule returned 0.&quot;   This seems to terminate the chain and nullify the effect of the parent rule, 920008.

What I found through Ivan's book is that TX:# variables will apparently not be set if the &quot;capture&quot; action is not set.  When I add &quot;capture&quot; to 920008, everything works as expected.

Am I misunderstanding this problem?  Should capture not be a required action in the parent of the chain?  Thank you for your assistance.

****************
* ORIGINAL RULES *
****************

# Visa
SecRule RESPONSE_BODY|RESPONSE_HEADERS:Location &quot;@verifyCC (?:^|[^\d])(?&lt;!google_ad_client = \&quot;pub-)(4\d{3}\-?\d{4}\-?\d{2}\-?\d{2}\-?\d(?:\d{3})??)(?:[^\d]|$)&quot; \
  &quot;chain,logdata:'Start of CC #: %{tx.ccdata_begin}***...',phase:4,t:none,ctl:auditLogParts=-E,block,msg:'Visa Credit Card Number sent from site to user',id:'920008',tag:'WASCTC/5.2',t
        SecRule TX:1 &quot;(\d{4}\-?\d{4}\-?\d{2}\-?\d{2}\-?\d{1,4})&quot; &quot;chain,capture,setvar:tx.ccdata=%{tx.1}&quot;
                SecRule TX:CCDATA &quot;^(\d{4}\-?)&quot; &quot;capture,setvar:tx.ccdata_begin=%{tx.1},setvar:tx.anomaly_score=+%{tx.critical_anomaly_score},setvar:tx.%{rule.id}-LEAKAGE/CC-%{matched_var_name

**************
* LEVEL 9 DEBUG *
**************

[21/Jun/2012:13:55:25 --0700] [test.xyz.com/sid#2b6ce015c0a8][rid#2b6ce12fd590][/~test/waftest.html][4] Recipe: Invoking rule 2b6ce0495118; [file &quot;/etc/httpd/conf/modsec
urity.d/activated_rules/modsecurity_crs_25_cc_known.conf&quot;] [line &quot;74&quot;] [id &quot;920008&quot;].
[21/Jun/2012:13:55:25 --0700] [test.xyz.com/sid#2b6ce015c0a8][rid#2b6ce12fd590][/~test/waftest.html][5] Rule 2b6ce0495118: SecRule &quot;RESPONSE_BODY|RESPONSE_HEADERS:Locati
on&quot; &quot;@verifyCC (?:^|[^\\d])(?&lt;!google_ad_client = \&quot;pub-)(4\\d{3}\\-?\\d{4}\\-?\\d{2}\\-?\\d{2}\\-?\\d(?:\\d{3})??)(?:[^\\d]|$)&quot; &quot;phase:4,log,chain,logdata:'Start of CC #: %{tx.ccdata_begin}**
*...',t:none,ctl:auditLogParts=-E,block,msg:'Visa Credit Card Number sent from site to user',id:920008,tag:WASCTC/5.2,tag:PCI/3.3,severity:1&quot;
[21/Jun/2012:13:55:25 --0700] [test.xyz.com/sid#2b6ce015c0a8][rid#2b6ce12fd590][/~test/waftest.html][4] Transformation completed in 0 usec.
[21/Jun/2012:13:55:25 --0700] [test.xyz.com/sid#2b6ce015c0a8][rid#2b6ce12fd590][/~test/waftest.html][4] Executing operator &quot;verifyCC&quot; with param &quot;(?:^|[^\\d])(?&lt;!google_
ad_client = \&quot;pub-)(4\\d{3}\\-?\\d{4}\\-?\\d{2}\\-?\\d{2}\\-?\\d(?:\\d{3})??)(?:[^\\d]|$)&quot; against RESPONSE_BODY.
[21/Jun/2012:13:55:25 --0700] [test.xyz.com/sid#2b6ce015c0a8][rid#2b6ce12fd590][/~test/waftest.html][9] Target value: &quot;&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n  &lt;head&gt;\n    &lt;title&gt;Page
 To Test WAF Output Blocking&lt;/title&gt;\n  &lt;/head&gt;\n\n  &lt;body&gt;\n    &lt;p&gt;Here is a credit card number.  Should block: 4111111111111111&lt;/p&gt;\n  &lt;/body&gt;\n&lt;/html&gt;\n&quot;
[21/Jun/2012:13:55:25 --0700] [test.xyz.com/sid#2b6ce015c0a8][rid#2b6ce12fd590][/~test/waftest.html][4] Operator completed in 33 usec.
[21/Jun/2012:13:55:25 --0700] [test.xyz.com/sid#2b6ce015c0a8][rid#2b6ce12fd590][/~test/waftest.html][4] Ctl: Set auditLogParts to ABIJDFHZ.
[21/Jun/2012:13:55:25 --0700] [test.xyz.com/sid#2b6ce015c0a8][rid#2b6ce12fd590][/~test/waftest.html][4] Rule returned 1.
[21/Jun/2012:13:55:25 --0700] [test.xyz.com/sid#2b6ce015c0a8][rid#2b6ce12fd590][/~test/waftest.html][9] Match -&gt; mode NEXT_RULE.
[21/Jun/2012:13:55:25 --0700] [test.xyz.com/sid#2b6ce015c0a8][rid#2b6ce12fd590][/~test/waftest.html][4] Recipe: Invoking rule 2b6ce049cff8; [file &quot;/etc/httpd/conf/modsec
urity.d/activated_rules/modsecurity_crs_25_cc_known.conf&quot;] [line &quot;75&quot;].
[21/Jun/2012:13:55:25 --0700] [test.xyz.com/sid#2b6ce015c0a8][rid#2b6ce12fd590][/~test/waftest.html][5] Rule 2b6ce049cff8: SecRule &quot;TX:0&quot; &quot;@rx (\\d{4}\\-?\\d{4}\\-?\\d{2
}\\-?\\d{2}\\-?\\d{1,4})&quot; &quot;chain,capture,setvar:tx.ccdata=%{tx.1}&quot;
[21/Jun/2012:13:55:25 --0700] [test.xyz.com/sid#2b6ce015c0a8][rid#2b6ce12fd590][/~test/waftest.html][4] Rule returned 0.
[21/Jun/2012:13:55:25 --0700] [test.xyz.com/sid#2b6ce015c0a8][rid#2b6ce12fd590][/~test/waftest.html][9] No match, chained -&gt; mode NEXT_CHAIN.
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001105.html">[Owasp-modsecurity-core-rule-set] Rule 950901 optimization
</A></li>
	<LI>Next message: <A HREF="001107.html">[Owasp-modsecurity-core-rule-set] Question on optional_rules/modsecurity_crs_25_cc_known.conf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1106">[ date ]</a>
              <a href="thread.html#1106">[ thread ]</a>
              <a href="subject.html#1106">[ subject ]</a>
              <a href="author.html#1106">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
