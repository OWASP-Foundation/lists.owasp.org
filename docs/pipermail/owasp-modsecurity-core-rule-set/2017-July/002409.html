<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Woe with 920270 (Null Byte...) (was: Re: Matched rule modification)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Woe%20with%20920270%20%28Null%0A%20Byte...%29%20%28was%3A%20Re%3A%20Matched%20rule%20modification%29&In-Reply-To=%3C20170707122435.GA16567%40arxnet.hu%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002408.html">
   <LINK REL="Next"  HREF="002410.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Woe with 920270 (Null Byte...) (was: Re: Matched rule modification)</H1>
    <B>Ervin Heged&#252;s</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Woe%20with%20920270%20%28Null%0A%20Byte...%29%20%28was%3A%20Re%3A%20Matched%20rule%20modification%29&In-Reply-To=%3C20170707122435.GA16567%40arxnet.hu%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] Woe with 920270 (Null Byte...) (was: Re: Matched rule modification)">airween at gmail.com
       </A><BR>
    <I>Fri Jul  7 12:24:35 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="002408.html">[Owasp-modsecurity-core-rule-set] News from the Core Rule Set	(2017-07-07)
</A></li>
        <LI>Next message: <A HREF="002410.html">[Owasp-modsecurity-core-rule-set] Woe with 920270 (Null Byte...) (was: Re: Matched rule modification)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2409">[ date ]</a>
              <a href="thread.html#2409">[ thread ]</a>
              <a href="subject.html#2409">[ subject ]</a>
              <a href="author.html#2409">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Christian and Chaim,
other CRS users,


here is my previous e-mail with an issue (with more issues
exactly, but this one whis is interesting now)

On Thu, Jun 01, 2017 at 08:49:03AM +0200, Christian Folini wrote:
&gt;<i> 
</I>&gt;<i> On Wed, May 31, 2017 at 08:32:03AM +0200, Ervin Heged&#252;s wrote:
</I>&gt;<i> &gt; And there is an another issue with 3.0.2 (but may be that affects
</I>&gt;<i> &gt; another versions too).
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; The request is similar that I detailed in my first post. The
</I>&gt;<i> &gt; &quot;extraParams&quot; value (JSON field) is this:
</I>...

and you sent me your test:

&gt;<i> I was kind of expecting problems with 920270, but probably not as
</I>&gt;<i> deep rooted ones as this. But first, I need to be able to reproduce
</I>&gt;<i> this, and I can't.
</I>&gt;<i> 
</I>&gt;<i> Here is my curl call taking up your example:
</I>&gt;<i> 
</I>&gt;<i> curl 'localhost/index.html' -d 'extraParams=%7B%22node%22%3A%223%22%2C%22text%22%3A%22v%C3%A9gs%C5%91%20fejezet%22' --trace-ascii -
</I>&gt;<i> == Info:   Trying 127.0.0.1...
</I>&gt;<i> == Info: Connected to localhost (127.0.0.1) port 80 (#0)
</I>&gt;<i> =&gt; Send header, 153 bytes (0x99)
</I>
...


now the situation is totally same like above, but the server is
another, and the web application is an up-to-date RoundCube
webmail.

The issue is when I'ld like to compose a new mail and I'm using
special hungarian characters, Modsecurity denies the request.

Here is the curl test:

curl &quot;<A HREF="https://roundcube.mydomain.hu/">https://roundcube.mydomain.hu/</A>&quot; -d &quot;_token=0uuYa9sHayQF7AU6s5Kb4XtJeKt6PZak&amp;_task=mail&amp;_action=send&amp;_id=1466771890595f68c41f875&amp;_attachments=&amp;_from=5&amp;_to=airween%40gmail.com&amp;_cc=&amp;_bcc=&amp;_replyto=&amp;_followupto=&amp;_subject=Pr%C3%B3ba+0707+1256&amp;editorSelector=plain&amp;_priority=0&amp;_store_target=Sent&amp;_draft_saveid=&amp;_draft=&amp;_is_html=0&amp;_framed=1&amp;_message=Pr%C3%B3ba+%C3%BCzenet.&quot; --trace-ascii -
== Info: Hostname was NOT found in DNS cache
== Info:   Trying 1.2.3.4...
== Info: Connected to roundcube.mydomain.hu (1.2.3.4) port 443 (#0)
== Info: successfully set certificate verify locations:
== Info:   CAfile: none
  CApath: /etc/ssl/certs
== Info: SSLv3, TLS handshake, Client hello (1):
=&gt; Send SSL data, 512 bytes (0x200)
0000: ........rJK..M`4Qg9.)..........r7.....v.0.,.(.$.........k.j.9.
...
== Info: 	 SSL certificate verify ok.
=&gt; Send header, 159 bytes (0x9f)
0000: POST / HTTP/1.1
0011: User-Agent: curl/7.38.0
002a: Host: roundcube.mydomain.hu
004a: Accept: */*
0057: Content-Length: 330
006c: Content-Type: application/x-www-form-urlencoded
009d: 
=&gt; Send data, 330 bytes (0x14a)
0000: _token=0uuYa9sHayQF7AU6s5Kb4XtJeKt6PZak&amp;_task=mail&amp;_action=send&amp;
0040: _id=1466771890595f68c41f875&amp;_attachments=&amp;_from=5&amp;_to=airween%40
0080: gmail.com&amp;_cc=&amp;_bcc=&amp;_replyto=&amp;_followupto=&amp;_subject=Pr%C3%B3ba+
00c0: 0707+1256&amp;editorSelector=plain&amp;_priority=0&amp;_store_target=Sent&amp;_d
0100: raft_saveid=&amp;_draft=&amp;_is_html=0&amp;_framed=1&amp;_message=Pr%C3%B3ba+%C
0140: 3%BCzenet.
== Info: upload completely sent off: 330 out of 330 bytes
&lt;= Recv header, 24 bytes (0x18)
0000: HTTP/1.1 403 Forbidden
== Info: Server nginx/1.6.2 is not blacklisted
&lt;= Recv header, 21 bytes (0x15)
0000: Server: nginx/1.6.2
&lt;= Recv header, 37 bytes (0x25)
0000: Date: Fri, 07 Jul 2017 11:57:13 GMT
&lt;= Recv header, 25 bytes (0x19)
0000: Content-Type: text/html
&lt;= Recv header, 21 bytes (0x15)
0000: Content-Length: 168
&lt;= Recv header, 24 bytes (0x18)
0000: Connection: keep-alive
&lt;= Recv header, 2 bytes (0x2)
0000: 
&lt;= Recv data, 168 bytes (0xa8)
0000: &lt;html&gt;
0008: &lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;
0033: &lt;body bgcolor=&quot;white&quot;&gt;
004b: &lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;
0074: &lt;hr&gt;&lt;center&gt;nginx/1.6.2&lt;/center&gt;
0096: &lt;/body&gt;
009f: &lt;/html&gt;


The audit log contains these lines for that request?

ModSecurity: Warning. Matched &quot;Operator `ValidadeByteRange' with parameter `1-255' against variable `ARGS:_message' (Value: `Pr\xffffffc3\xffffffb3ba \xffffffc3\xffffffbczenet.' ) [file &quot;/etc/nginx/owasp-modsecurity-crs/rules/REQUEST-920-PROTOCOL-ENFORCEMENT.conf&quot;] [line &quot;488&quot;] [id &quot;920270&quot;] [rev &quot;2&quot;] [msg &quot;Invalid character in request (null character)&quot;] [data &quot;&quot;] [severity &quot;2&quot;] [ver &quot;OWASP_CRS/3.0.0&quot;] [maturity &quot;9&quot;] [accuracy &quot;9&quot;] [tag &quot;application-multi&quot;] [tag &quot;language-multi&quot;] [tag &quot;platform-multi&quot;] [tag &quot;attack-protocol&quot;] [tag &quot;OWASP_CRS/PROTOCOL_VIOLATION/EVASION&quot;] [ref &quot;o2,1o3,1v333,16t:urlDecodeUnio2,1o3,1o7,1o8,1v459,15t:urlDecodeUni&quot;]
ModSecurity: Warning. Matched &quot;Operator `Ge' with parameter `%{tx.inbound_anomaly_score_threshold}' against variable `TX:ANOMALY_SCORE' (Value: `8' ) [file &quot;/etc/nginx/owasp-modsecurity-crs/rules/REQUEST-949-BLOCKING-EVALUATION.conf&quot;] [line &quot;36&quot;] [id &quot;949110&quot;] [rev &quot;&quot;] [msg &quot;Inbound Anomaly Score Exceeded (Total Score: 8)&quot;] [data &quot;&quot;] [severity &quot;2&quot;] [ver &quot;&quot;] [maturity &quot;0&quot;] [accuracy &quot;0&quot;] [tag &quot;application-multi&quot;] [tag &quot;language-multi&quot;] [tag &quot;platform-multi&quot;] [tag &quot;attack-generic&quot;] [ref &quot;&quot;]
ModSecurity: Warning. Matched &quot;Operator `Ge' with parameter `%{tx.inbound_anomaly_score_threshold}' against variable `TX:INBOUND_ANOMALY_SCORE' (Value: `8' ) [file &quot;/etc/nginx/owasp-modsecurity-crs/rules/RESPONSE-980-CORRELATION.conf&quot;] [line &quot;61&quot;] [id &quot;980130&quot;] [rev &quot;&quot;] [msg &quot;Inbound Anomaly Score Exceeded (Total Inbound Score: 8 - SQLI=0,XSS=0,RFI=0,LFI=0,RCE=0,PHPI=0,HTTP=0,SESS=0): Invalid character in request (null character)'&quot;] [data &quot;&quot;] [severity &quot;0&quot;] [ver &quot;&quot;] [maturity &quot;0&quot;] [accuracy &quot;0&quot;] [tag &quot;event-correlation&quot;] [ref &quot;&quot;]

Note, that when I put the special characters to subject of mail,
and the body contains only ascii chars, the rule doesn't
triggered:

_token=0uuYa9sHayQF7AU6s5Kb4XtJeKt6PZak&amp;_task=mail&amp;_action=send&amp;_id=1061864000595f7c3bc5c2e&amp;_attachments =&amp;_from=5&amp;_to=airween%40gmail.com&amp;_cc=&amp;_bcc=&amp;_replyto=&amp;_followupto=&amp;_subject=Pr%C3%B3ba+mail+0707+1419 &amp;editorSelector=plain&amp;_priority=0&amp;_store_target=Sent&amp;_draft_saveid=&amp;_draft=&amp;_is_html=0&amp;_framed=1&amp;_message=Teszt+uzenet.

but the audit log contains a line:

ModSecurity: Warning. Matched &quot;Operator `ValidadeByteRange' with parameter `1-255' against variable `ARGS:_subject' (Value: `Pr\xffffffc3\xffffffb3ba mail 0707 1419' ) [file &quot;/etc/nginx/owasp-modsecurity-crs/rules/REQUEST-920-PROTOCOL-ENFORCEMENT.conf&quot;] [line &quot;488&quot;] [id &quot;920270&quot;] [rev &quot;2&quot;] [msg &quot;Invalid character in request (null character)&quot;] [data &quot;&quot;] [severity &quot;2&quot;] [ver &quot;OWASP_CRS/3.0.0&quot;] [maturity &quot;9&quot;] [accuracy &quot;9&quot;] [tag &quot;application-multi&quot;] [tag &quot;language-multi&quot;] [tag &quot;platform-multi&quot;] [tag &quot;attack-protocol&quot;] [tag &quot;OWASP_CRS/PROTOCOL_VIOLATION/EVASION&quot;] [ref &quot;o2,1o3,1v857,21t:urlDecodeUni&quot;]


What em I missing?


Thanks,


a.


</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002408.html">[Owasp-modsecurity-core-rule-set] News from the Core Rule Set	(2017-07-07)
</A></li>
	<LI>Next message: <A HREF="002410.html">[Owasp-modsecurity-core-rule-set] Woe with 920270 (Null Byte...) (was: Re: Matched rule modification)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2409">[ date ]</a>
              <a href="thread.html#2409">[ thread ]</a>
              <a href="subject.html#2409">[ subject ]</a>
              <a href="author.html#2409">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
