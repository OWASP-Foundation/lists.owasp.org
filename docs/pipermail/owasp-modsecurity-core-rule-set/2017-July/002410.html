<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Woe with 920270 (Null Byte...) (was: Re: Matched rule modification)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Woe%20with%20920270%20%28Null%0A%20Byte...%29%20%28was%3A%20Re%3A%20Matched%20rule%20modification%29&In-Reply-To=%3C20170707184410.GB24713%40arxnet.hu%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002409.html">
   <LINK REL="Next"  HREF="002411.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Woe with 920270 (Null Byte...) (was: Re: Matched rule modification)</H1>
    <B>Ervin Heged&#252;s</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Woe%20with%20920270%20%28Null%0A%20Byte...%29%20%28was%3A%20Re%3A%20Matched%20rule%20modification%29&In-Reply-To=%3C20170707184410.GB24713%40arxnet.hu%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] Woe with 920270 (Null Byte...) (was: Re: Matched rule modification)">airween at gmail.com
       </A><BR>
    <I>Fri Jul  7 18:44:10 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="002409.html">[Owasp-modsecurity-core-rule-set] Woe with 920270 (Null Byte...) (was: Re: Matched rule modification)
</A></li>
        <LI>Next message: <A HREF="002411.html">[Owasp-modsecurity-core-rule-set] Woe with 920270 (Null Byte...) (was: Re: Matched rule modification)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2410">[ date ]</a>
              <a href="thread.html#2410">[ thread ]</a>
              <a href="subject.html#2410">[ subject ]</a>
              <a href="author.html#2410">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Chaim,

On Fri, Jul 07, 2017 at 10:46:22AM -0400, Chaim Sanders wrote:
&gt;<i> Taking a quick look here, it appears that the problem is probably with
</I>&gt;<i> urldecodeuni but it also might not be solvable. Let me explain, If I recall
</I>&gt;<i> correctly the reason that we added request_uri and ARGS as a parameter is
</I>&gt;<i> that they require provided elements to be ASCII. The alternative is that in
</I>&gt;<i> PL1 we thought that only ASCII should be submitted as args, which seems
</I>&gt;<i> wrong.
</I>&gt;<i> However we see that there is the use of urldecodeuni, which will decode
</I>&gt;<i> even unicode chars into the base char points. Stepping aside from the other
</I>&gt;<i> Unicode problems we've been seeing as a result of some ModSec issues
</I>&gt;<i> (purportedly), the use of this transformation will defeat the purpose of
</I>&gt;<i> this rule, as it will fire whenever a unicode element has been received.
</I>&gt;<i> The real question/possible problem, is that as we learned before
</I>&gt;<i> Apache/Nginx will provide us with automatically urldecoded arguments (and
</I>&gt;<i> url's maybe). This in turn might mean that it is never possible to ensure
</I>&gt;<i> that URL's and Args were all ASCII as is required by spec.
</I>&gt;<i> Requires a little bit more testing and verification of the purpose of the
</I>&gt;<i> rule, but i'd guess this is the cause of your issue.
</I> 
thanks for your detailed anwser, I think I understand most of it :).

Probably I can't do anything till you can't find the final
solution.

What can I help you? I mean, may be I can build the old
Modsecurity version with Apache, or Nginx, and can try with old
CRS...


Thanks,


a.

&gt;<i> On Fri, Jul 7, 2017 at 8:24 AM, Ervin Heged&#252;s &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">airween at gmail.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> &gt; Hi Christian and Chaim,
</I>&gt;<i> &gt; other CRS users,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; here is my previous e-mail with an issue (with more issues
</I>&gt;<i> &gt; exactly, but this one whis is interesting now)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On Thu, Jun 01, 2017 at 08:49:03AM +0200, Christian Folini wrote:
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; On Wed, May 31, 2017 at 08:32:03AM +0200, Ervin Heged&#252;s wrote:
</I>&gt;<i> &gt; &gt; &gt; And there is an another issue with 3.0.2 (but may be that affects
</I>&gt;<i> &gt; &gt; &gt; another versions too).
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; The request is similar that I detailed in my first post. The
</I>&gt;<i> &gt; &gt; &gt; &quot;extraParams&quot; value (JSON field) is this:
</I>&gt;<i> &gt; ...
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; and you sent me your test:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; I was kind of expecting problems with 920270, but probably not as
</I>&gt;<i> &gt; &gt; deep rooted ones as this. But first, I need to be able to reproduce
</I>&gt;<i> &gt; &gt; this, and I can't.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Here is my curl call taking up your example:
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; curl 'localhost/index.html' -d 'extraParams=%7B%22node%22%3A%
</I>&gt;<i> &gt; 223%22%2C%22text%22%3A%22v%C3%A9gs%C5%91%20fejezet%22' --trace-ascii -
</I>&gt;<i> &gt; &gt; == Info:   Trying 127.0.0.1...
</I>&gt;<i> &gt; &gt; == Info: Connected to localhost (127.0.0.1) port 80 (#0)
</I>&gt;<i> &gt; &gt; =&gt; Send header, 153 bytes (0x99)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ...
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; now the situation is totally same like above, but the server is
</I>&gt;<i> &gt; another, and the web application is an up-to-date RoundCube
</I>&gt;<i> &gt; webmail.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The issue is when I'ld like to compose a new mail and I'm using
</I>&gt;<i> &gt; special hungarian characters, Modsecurity denies the request.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Here is the curl test:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; curl &quot;<A HREF="https://roundcube.mydomain.hu/">https://roundcube.mydomain.hu/</A>&quot; -d &quot;_token=
</I>&gt;<i> &gt; 0uuYa9sHayQF7AU6s5Kb4XtJeKt6PZak&amp;_task=mail&amp;_action=send&amp;_
</I>&gt;<i> &gt; id=1466771890595f68c41f875&amp;_attachments=&amp;_from=5&amp;_to=airween%40gmail.com
</I>&gt;<i> &gt; &amp;_cc=&amp;_bcc=&amp;_replyto=&amp;_followupto=&amp;_subject=Pr%C3%B3ba+0707+1256&amp;
</I>&gt;<i> &gt; editorSelector=plain&amp;_priority=0&amp;_store_target=Sent&amp;
</I>&gt;<i> &gt; _draft_saveid=&amp;_draft=&amp;_is_html=0&amp;_framed=1&amp;_message=Pr%C3%B3ba+%C3%BCzenet.&quot;
</I>&gt;<i> &gt; --trace-ascii -
</I>&gt;<i> &gt; == Info: Hostname was NOT found in DNS cache
</I>&gt;<i> &gt; == Info:   Trying 1.2.3.4...
</I>&gt;<i> &gt; == Info: Connected to roundcube.mydomain.hu (1.2.3.4) port 443 (#0)
</I>&gt;<i> &gt; == Info: successfully set certificate verify locations:
</I>&gt;<i> &gt; == Info:   CAfile: none
</I>&gt;<i> &gt;   CApath: /etc/ssl/certs
</I>&gt;<i> &gt; == Info: SSLv3, TLS handshake, Client hello (1):
</I>&gt;<i> &gt; =&gt; Send SSL data, 512 bytes (0x200)
</I>&gt;<i> &gt; 0000: ........rJK..M`4Qg9.)..........r7.....v.0.,.(.$.........k.j.9.
</I>&gt;<i> &gt; ...
</I>&gt;<i> &gt; == Info:         SSL certificate verify ok.
</I>&gt;<i> &gt; =&gt; Send header, 159 bytes (0x9f)
</I>&gt;<i> &gt; 0000: POST / HTTP/1.1
</I>&gt;<i> &gt; 0011: User-Agent: curl/7.38.0
</I>&gt;<i> &gt; 002a: Host: roundcube.mydomain.hu
</I>&gt;<i> &gt; 004a: Accept: */*
</I>&gt;<i> &gt; 0057: Content-Length: 330
</I>&gt;<i> &gt; 006c: Content-Type: application/x-www-form-urlencoded
</I>&gt;<i> &gt; 009d:
</I>&gt;<i> &gt; =&gt; Send data, 330 bytes (0x14a)
</I>&gt;<i> &gt; 0000: _token=0uuYa9sHayQF7AU6s5Kb4XtJeKt6PZak&amp;_task=mail&amp;_action=send&amp;
</I>&gt;<i> &gt; 0040: _id=1466771890595f68c41f875&amp;_attachments=&amp;_from=5&amp;_to=airween%40
</I>&gt;<i> &gt; 0080: gmail.com&amp;_cc=&amp;_bcc=&amp;_replyto=&amp;_followupto=&amp;_subject=Pr%C3%B3ba+
</I>&gt;<i> &gt; 00c0: 0707+1256&amp;editorSelector=plain&amp;_priority=0&amp;_store_target=Sent&amp;_d
</I>&gt;<i> &gt; 0100: raft_saveid=&amp;_draft=&amp;_is_html=0&amp;_framed=1&amp;_message=Pr%C3%B3ba+%C
</I>&gt;<i> &gt; 0140: 3%BCzenet.
</I>&gt;<i> &gt; == Info: upload completely sent off: 330 out of 330 bytes
</I>&gt;<i> &gt; &lt;= Recv header, 24 bytes (0x18)
</I>&gt;<i> &gt; 0000: HTTP/1.1 403 Forbidden
</I>&gt;<i> &gt; == Info: Server nginx/1.6.2 is not blacklisted
</I>&gt;<i> &gt; &lt;= Recv header, 21 bytes (0x15)
</I>&gt;<i> &gt; 0000: Server: nginx/1.6.2
</I>&gt;<i> &gt; &lt;= Recv header, 37 bytes (0x25)
</I>&gt;<i> &gt; 0000: Date: Fri, 07 Jul 2017 11:57:13 GMT
</I>&gt;<i> &gt; &lt;= Recv header, 25 bytes (0x19)
</I>&gt;<i> &gt; 0000: Content-Type: text/html
</I>&gt;<i> &gt; &lt;= Recv header, 21 bytes (0x15)
</I>&gt;<i> &gt; 0000: Content-Length: 168
</I>&gt;<i> &gt; &lt;= Recv header, 24 bytes (0x18)
</I>&gt;<i> &gt; 0000: Connection: keep-alive
</I>&gt;<i> &gt; &lt;= Recv header, 2 bytes (0x2)
</I>&gt;<i> &gt; 0000:
</I>&gt;<i> &gt; &lt;= Recv data, 168 bytes (0xa8)
</I>&gt;<i> &gt; 0000: &lt;html&gt;
</I>&gt;<i> &gt; 0008: &lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;
</I>&gt;<i> &gt; 0033: &lt;body bgcolor=&quot;white&quot;&gt;
</I>&gt;<i> &gt; 004b: &lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;
</I>&gt;<i> &gt; 0074: &lt;hr&gt;&lt;center&gt;nginx/1.6.2&lt;/center&gt;
</I>&gt;<i> &gt; 0096: &lt;/body&gt;
</I>&gt;<i> &gt; 009f: &lt;/html&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The audit log contains these lines for that request?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ModSecurity: Warning. Matched &quot;Operator `ValidadeByteRange' with parameter
</I>&gt;<i> &gt; `1-255' against variable `ARGS:_message' (Value: `Pr\xffffffc3\xffffffb3ba
</I>&gt;<i> &gt; \xffffffc3\xffffffbczenet.' ) [file &quot;/etc/nginx/owasp-modsecurity-
</I>&gt;<i> &gt; crs/rules/REQUEST-920-PROTOCOL-ENFORCEMENT.conf&quot;] [line &quot;488&quot;] [id
</I>&gt;<i> &gt; &quot;920270&quot;] [rev &quot;2&quot;] [msg &quot;Invalid character in request (null character)&quot;]
</I>&gt;<i> &gt; [data &quot;&quot;] [severity &quot;2&quot;] [ver &quot;OWASP_CRS/3.0.0&quot;] [maturity &quot;9&quot;] [accuracy
</I>&gt;<i> &gt; &quot;9&quot;] [tag &quot;application-multi&quot;] [tag &quot;language-multi&quot;] [tag
</I>&gt;<i> &gt; &quot;platform-multi&quot;] [tag &quot;attack-protocol&quot;] [tag
</I>&gt;<i> &gt; &quot;OWASP_CRS/PROTOCOL_VIOLATION/EVASION&quot;] [ref &quot;o2,1o3,1v333,16t:
</I>&gt;<i> &gt; urlDecodeUnio2,1o3,1o7,1o8,1v459,15t:urlDecodeUni&quot;]
</I>&gt;<i> &gt; ModSecurity: Warning. Matched &quot;Operator `Ge' with parameter
</I>&gt;<i> &gt; `%{tx.inbound_anomaly_score_threshold}' against variable
</I>&gt;<i> &gt; `TX:ANOMALY_SCORE' (Value: `8' ) [file &quot;/etc/nginx/owasp-modsecurity-
</I>&gt;<i> &gt; crs/rules/REQUEST-949-BLOCKING-EVALUATION.conf&quot;] [line &quot;36&quot;] [id
</I>&gt;<i> &gt; &quot;949110&quot;] [rev &quot;&quot;] [msg &quot;Inbound Anomaly Score Exceeded (Total Score: 8)&quot;]
</I>&gt;<i> &gt; [data &quot;&quot;] [severity &quot;2&quot;] [ver &quot;&quot;] [maturity &quot;0&quot;] [accuracy &quot;0&quot;] [tag
</I>&gt;<i> &gt; &quot;application-multi&quot;] [tag &quot;language-multi&quot;] [tag &quot;platform-multi&quot;] [tag
</I>&gt;<i> &gt; &quot;attack-generic&quot;] [ref &quot;&quot;]
</I>&gt;<i> &gt; ModSecurity: Warning. Matched &quot;Operator `Ge' with parameter
</I>&gt;<i> &gt; `%{tx.inbound_anomaly_score_threshold}' against variable
</I>&gt;<i> &gt; `TX:INBOUND_ANOMALY_SCORE' (Value: `8' ) [file
</I>&gt;<i> &gt; &quot;/etc/nginx/owasp-modsecurity-crs/rules/RESPONSE-980-CORRELATION.conf&quot;]
</I>&gt;<i> &gt; [line &quot;61&quot;] [id &quot;980130&quot;] [rev &quot;&quot;] [msg &quot;Inbound Anomaly Score Exceeded
</I>&gt;<i> &gt; (Total Inbound Score: 8 - SQLI=0,XSS=0,RFI=0,LFI=0,RCE=0,PHPI=0,HTTP=0,SESS=0):
</I>&gt;<i> &gt; Invalid character in request (null character)'&quot;] [data &quot;&quot;] [severity &quot;0&quot;]
</I>&gt;<i> &gt; [ver &quot;&quot;] [maturity &quot;0&quot;] [accuracy &quot;0&quot;] [tag &quot;event-correlation&quot;] [ref &quot;&quot;]
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Note, that when I put the special characters to subject of mail,
</I>&gt;<i> &gt; and the body contains only ascii chars, the rule doesn't
</I>&gt;<i> &gt; triggered:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; _token=0uuYa9sHayQF7AU6s5Kb4XtJeKt6PZak&amp;_task=mail&amp;_action=send&amp;_
</I>&gt;<i> &gt; id=1061864000595f7c3bc5c2e&amp;_attachments =&amp;_from=5&amp;_to=airween%40gmail.com
</I>&gt;<i> &gt; &amp;_cc=&amp;_bcc=&amp;_replyto=&amp;_followupto=&amp;_subject=Pr%C3%B3ba+mail+0707+1419
</I>&gt;<i> &gt; &amp;editorSelector=plain&amp;_priority=0&amp;_store_target=Sent&amp;
</I>&gt;<i> &gt; _draft_saveid=&amp;_draft=&amp;_is_html=0&amp;_framed=1&amp;_message=Teszt+uzenet.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; but the audit log contains a line:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ModSecurity: Warning. Matched &quot;Operator `ValidadeByteRange' with parameter
</I>&gt;<i> &gt; `1-255' against variable `ARGS:_subject' (Value: `Pr\xffffffc3\xffffffb3ba
</I>&gt;<i> &gt; mail 0707 1419' ) [file &quot;/etc/nginx/owasp-modsecurity-
</I>&gt;<i> &gt; crs/rules/REQUEST-920-PROTOCOL-ENFORCEMENT.conf&quot;] [line &quot;488&quot;] [id
</I>&gt;<i> &gt; &quot;920270&quot;] [rev &quot;2&quot;] [msg &quot;Invalid character in request (null character)&quot;]
</I>&gt;<i> &gt; [data &quot;&quot;] [severity &quot;2&quot;] [ver &quot;OWASP_CRS/3.0.0&quot;] [maturity &quot;9&quot;] [accuracy
</I>&gt;<i> &gt; &quot;9&quot;] [tag &quot;application-multi&quot;] [tag &quot;language-multi&quot;] [tag
</I>&gt;<i> &gt; &quot;platform-multi&quot;] [tag &quot;attack-protocol&quot;] [tag
</I>&gt;<i> &gt; &quot;OWASP_CRS/PROTOCOL_VIOLATION/EVASION&quot;] [ref &quot;o2,1o3,1v857,21t:
</I>&gt;<i> &gt; urlDecodeUni&quot;]
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; What em I missing?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Thanks,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; a.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> -- 
</I>&gt;<i> -- 
</I>&gt;<i> Chaim Sanders
</I>&gt;<i> <A HREF="http://www.ChaimSanders.com">http://www.ChaimSanders.com</A>
</I></PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002409.html">[Owasp-modsecurity-core-rule-set] Woe with 920270 (Null Byte...) (was: Re: Matched rule modification)
</A></li>
	<LI>Next message: <A HREF="002411.html">[Owasp-modsecurity-core-rule-set] Woe with 920270 (Null Byte...) (was: Re: Matched rule modification)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2410">[ date ]</a>
              <a href="thread.html#2410">[ thread ]</a>
              <a href="subject.html#2410">[ subject ]</a>
              <a href="author.html#2410">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
