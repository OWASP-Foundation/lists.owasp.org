From jamuse at gmail.com  Sun Jul  1 08:28:43 2012
From: jamuse at gmail.com (Josh Amishav-Zlatin)
Date: Sun, 1 Jul 2012 11:28:43 +0300
Subject: [Owasp-modsecurity-core-rule-set] CRS 2.2.5 setup help needed
In-Reply-To: <CADsXbD5OVVhu5gkWz_P5LycmEvZ_MJyrbvt6PdnzMzzFt-uu5A@mail.gmail.com>
References: <CADsXbD4O8t+w-HBqEKjGJ3DJ5otz25h8rm4=qfZTSJ==Bdn_cg@mail.gmail.com>
	<CAOXGsbK7JEkhEmKtMf0e8jUsWLdSiQQ2EXy4XehH+wzhv1_s6A@mail.gmail.com>
	<CADsXbD5OVVhu5gkWz_P5LycmEvZ_MJyrbvt6PdnzMzzFt-uu5A@mail.gmail.com>
Message-ID: <CANnPkim6n4iR+E9r9Fdcu76b=TfVBowS93KjLM-5fMwUPM+t0w@mail.gmail.com>

On Fri, Jun 29, 2012 at 10:04 PM, Enigma Support <support at enigma.ie> wrote:

>  How do I configure settings,  from one site use a config file like the
> one below, and point httpd.conf at it but this give as a page fault when i
> start Apache ????
>
> The OWASp web site is very poor they dont explain how to configure
> mod_security infact its was here i got the link that downloaded everything
>
> http://mod-security.svn.sourceforge.net/viewvc/mod-security/m2/trunk/modsecurity.conf-recommended
>
>
Hi,

Ivan Ristic's ModSecurity Handbook should help you get up to speed quickly.
The first four chapters (covering installation and configuration)
are available for free:

https://www.feistyduck.com/books/modsecurity-handbook/gettingStarted.html

I highly recommend reading the rest of the book if you intend on using
ModSecurity seriously.

--
 - Josh


>
> On 29 June 2012 17:32, Matt Thomas <matt at betweenbrain.com> wrote:
>
>> Hello,
>>
>> It sounds like you have downloaded the entire SVN repository. You might
>> want to look at
>> https://www.owasp.org/index.php/Category:OWASP_ModSecurity_Core_Rule_Set_Project,
>> specifically the download and installation tabs, for more details than I
>> can provide.
>>
>> The latest CRS version can be manually downloaded from
>> http://sourceforge.net/projects/mod-security/files/modsecurity-crs/0-CURRENT/
>>
>>
>> The quick setup is to copy the rules, and rule directories, that you want
>> to use to a directory like /etc/apache2/modsecurity-crs/slr_rules/ and
>> then add the following to httpd.conf, or as a new file like
>> /etc/apache2/conf.d/modsecurity
>>
>> <IfModule security2_module>
>>
>>
>>     Include modsecurity-crs/modsecurity_crs_10_config.conf
>>
>>
>>     Include modsecurity-crs/base_rules/*.conf
>>     Include modsecurity-crs/activated_rules/*.conf
>>
>>
>> </IfModule>
>>
>>
>> There are a few ways retrieve the files, so you might want to check out
>> that first page and see which would work best for you.
>>
>> Hope that helps.
>>
>> Best,
>>
>> Matt Thomas
>> Founder betweenbrain <http://betweenbrain.com/>?
>> Lead Developer Construct Template Development Framework<http://construct-framework.com/>
>> Phone: 203.632.9322
>> Twitter: @betweenbrain
>> Github: https://github.com/betweenbrain
>>
>>
>>
>> On Fri, Jun 29, 2012 at 7:42 AM, Enigma Support <support at enigma.ie>wrote:
>>
>>> I have setup modsecurity 2.6.5 and downloaded the crs when I untar it I
>>> have a folder in my temp folder called crs inside this I have various files
>>> namely branches, tags and trunks.   What do i need to do to get the basics
>>> up and running ?
>>>
>>> Note please provide lots of details as I have never used this before.  I
>>> have seen different report on adding sections to <if module mod_security2.c
>>> and Include but dint know what ones are right for the crs 2.2.5
>>>
>>>  I am using Apache 2 and it is installed in /usr/local/apache2
>>>
>>> Also what is a good test to check functionality
>>>
>>> Thanks
>>>
>>>
>>> _______________________________________________
>>> Owasp-modsecurity-core-rule-set mailing list
>>> Owasp-modsecurity-core-rule-set at lists.owasp.org
>>> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>>>
>>>
>>
>
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120701/0023fbee/attachment.html>

From fragger at altervista.org  Mon Jul  9 08:09:28 2012
From: fragger at altervista.org (Francesco)
Date: Mon, 9 Jul 2012 10:09:28 +0200
Subject: [Owasp-modsecurity-core-rule-set] (no subject)
Message-ID: <CAB4D8U8YbyhWyZ4SjNxRSjhaQNdYL++pTET7j3d8hniR7O8z-Q@mail.gmail.com>

hi

some few days ago I've installed the module mod_security in my Bitnami Lamp
Stack.In modsecurity.conf I've something like this:

<ifmodule mod_security2.c>

...

SecRuleEngine On

...

Include /etc/apache2/modsecurity-crs/modsecurity_crs_10_config.conf

Include /etc/apache2/modsecurity-crs/base_rules/*.conf

Include /etc/apache2/modsecurity-crs/activated_rules/*.conf

</ifmodule>

this configuration is such that Apache hangs during restart, so I've tried
to include the rules one by one, but I've some collateral effect with
almost any rule...
https://docs.google.com/spreadsheet/ccc?key=0Apq7Xsr6Pp7BdEpiS1JOSFdWQWdiVHdKTE5jY1B5RVE

At the moment I'm trying to figure out what's wrong, but I would like to
know if there are any known interactions between the base rule set and the
software installed in the stack.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120709/f054f862/attachment.html>

From ivakili at yahoo.com  Thu Jul 12 08:10:52 2012
From: ivakili at yahoo.com (Iman Vakili)
Date: Thu, 12 Jul 2012 01:10:52 -0700 (PDT)
Subject: [Owasp-modsecurity-core-rule-set] exclusion
Message-ID: <1342080652.29737.YahooMailNeo@web141203.mail.bf1.yahoo.com>

Hello

Suppose there are some various web applications and each one have different parts, I want to know what is the best solution to exclude some rules from some parts, I know we can Include related rules in the Location directive based on our requisites but what about excluding just some part of a site, like we have a comment part and we don't want so many rules checked for that part?
maybe the solution is using skipafter for the related rules? is there any other solution?
?
Thanks & Best regards

~Iman Vakili
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120712/d8c00d7d/attachment.html>

From powster at gmail.com  Fri Jul 13 14:01:11 2012
From: powster at gmail.com (JPow (powster))
Date: Fri, 13 Jul 2012 22:01:11 +0800
Subject: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could not
 set variable "ip.dos_counter" as the collection does not exist.
Message-ID: <CC264B27.A995%powster@gmail.com>

Hi there,

I am facing a problem where I get "Could not set variable "ip.dos_counter"
as the collection does not exist." debug output when using the
dos_protection rule set ( "modsecurity_crs_11_dos_protection.conf").
* DOS_Protection works as it should, so no issues with that (I have
uncommented the relevant lines in the crs_10_setup.conf, as well as properly
linked up the crs_11_dos_protection.conf
* However, I find that the debug is littered with "Could not set variable
"ip.dos_counter" as the collection does not exist."
* I've realized that this is NOT a problem with INITCOL:IP not being called
in the setup conf file --> This works properly (I am using the default
crs_10_setup.conf)
* The issue ONLY occurs with Apache (internal dummy connection) (see below
debug / audit output)
> * If you see below Audit Output, it is not a standard "GET" request.
> * From my understanding, Apache's internal dummy connections are just done by
> Apache to wake up its child processes.
* I am puzzled why this happens, because I thought there already is an
exception for Apache internal dummy connections in 47
common_exceptions.conf?
Any reason why these dummy connections are still causing the error messages
in the debug? And if so, how to solve this issue?

Thanks!

My system:
-Ubuntu 12.04 on Amazon EC2
-Apache 2.6.3 Mod_Security
-OWASP_CRS/2.2.5.

Debug output:
[13/Jul/2012:13:29:46 +0000]
[ip-XX-XXX-XX-XX.ap-southeast-1.compute.internal/sid#7f40d4a48370][rid#7f40d
64c60a0][*][3] Could not set variable "ip.dos_counter" as the collection
does not exist.

Audit Output:
--695eef13-A--
[13/Jul/2012:13:29:46 +0000] UAAiygqAUUgAABqMEm0AAAAE 127.0.0.1 34716
127.0.0.1 80
--695eef13-B--
OPTIONS * HTTP/1.0
User-Agent: Apache (internal dummy connection)

--695eef13-F--
HTTP/1.1 200 OK
Content-Length: 0
Connection: close

--695eef13-H--
Message: Could not set variable "ip.dos_counter" as the collection does not
exist.
Stopwatch: 1342186186315250 284 (- - -)
Stopwatch2: 1342186186315250 284; combined=119, p1=0, p2=0, p3=0, p4=0,
p5=118, sr=0, sw=1, l=0, gc=0
Producer: ModSecurity for Apache/2.6.3 (http://www.modsecurity.org/);
OWASP_CRS/2.2.5; OWASP_CRS/2.2.5.
Server: Apache

--695eef13-Z--


-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120713/4ed2d36b/attachment.html>

From RBarnett at trustwave.com  Fri Jul 13 14:11:43 2012
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Fri, 13 Jul 2012 09:11:43 -0500
Subject: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could
 not set variable "ip.dos_counter" as the collection does not exist.
In-Reply-To: <CC264B27.A995%powster@gmail.com>
Message-ID: <CC25A44E.5624C%rbarnett@trustwave.com>

The rules in the 47 common exceptions file will only adjust the anomaly scores.  You could take these rules and place them into local 15 files and add the "alllow" action to them.

--
Ryan Barnett
Trustwave SpiderLabs
ModSecurity Project Leader
OWASP ModSecurity CRS Project Leader

From: "JPow (powster)" <powster at gmail.com<mailto:powster at gmail.com>>
Date: Fri, 13 Jul 2012 09:01:11 -0500
To: "owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>" <owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>>
Subject: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could not set variable "ip.dos_counter" as the collection does not exist.

Hi there,

I am facing a problem where I get "Could not set variable "ip.dos_counter" as the collection does not exist." debug output when using the dos_protection rule set ( "modsecurity_crs_11_dos_protection.conf").

 *   DOS_Protection works as it should, so no issues with that (I have uncommented the relevant lines in the crs_10_setup.conf, as well as properly linked up the crs_11_dos_protection.conf
 *   However, I find that the debug is littered with "Could not set variable "ip.dos_counter" as the collection does not exist."
 *   I've realized that this is NOT a problem with INITCOL:IP not being called in the setup conf file --> This works properly (I am using the default crs_10_setup.conf)
 *   The issue ONLY occurs with Apache (internal dummy connection) (see below debug / audit output)
    *   If you see below Audit Output, it is not a standard "GET" request.
    *   From my understanding, Apache's internal dummy connections are just done by Apache to wake up its child processes.
 *   I am puzzled why this happens, because I thought there already is an exception for Apache internal dummy connections in 47 common_exceptions.conf?

Any reason why these dummy connections are still causing the error messages in the debug? And if so, how to solve this issue?

Thanks!

My system:
-Ubuntu 12.04 on Amazon EC2
-Apache 2.6.3 Mod_Security
-OWASP_CRS/2.2.5.

Debug output:
[13/Jul/2012:13:29:46 +0000] [ip-XX-XXX-XX-XX.ap-southeast-1.compute.internal/sid#7f40d4a48370][rid#7f40d64c60a0][*][3] Could not set variable "ip.dos_counter" as the collection does not exist.

Audit Output:
--695eef13-A--
[13/Jul/2012:13:29:46 +0000] UAAiygqAUUgAABqMEm0AAAAE 127.0.0.1 34716 127.0.0.1 80
--695eef13-B--
OPTIONS * HTTP/1.0
User-Agent: Apache (internal dummy connection)

--695eef13-F--
HTTP/1.1 200 OK
Content-Length: 0
Connection: close

--695eef13-H--
Message: Could not set variable "ip.dos_counter" as the collection does not exist.
Stopwatch: 1342186186315250 284 (- - -)
Stopwatch2: 1342186186315250 284; combined=119, p1=0, p2=0, p3=0, p4=0, p5=118, sr=0, sw=1, l=0, gc=0
Producer: ModSecurity for Apache/2.6.3 (http://www.modsecurity.org/); OWASP_CRS/2.2.5; OWASP_CRS/2.2.5.
Server: Apache

--695eef13-Z--

________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120713/0d355b9e/attachment.html>

From powster at gmail.com  Fri Jul 13 15:39:21 2012
From: powster at gmail.com (JPow (powster))
Date: Fri, 13 Jul 2012 23:39:21 +0800
Subject: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could
 not set variable "ip.dos_counter" as the collection does not exist.
In-Reply-To: <CC25A44E.5624C%rbarnett@trustwave.com>
Message-ID: <CC266099.A9A7%powster@gmail.com>

Hi Ryan,

Thanks for the tip. I tried adding this to the end of the 10_setup.conf:

SecRule REQUEST_LINE "^(GET /|OPTIONS \*) HTTP/1.0$"
"phase:1,allow,nolog,chain,t:none"
        SecRule REMOTE_ADDR "^(127\.0\.0\.|\:\:)1$" "chain, t:none"
                SecRule REQUEST_HEADERS:User-Agent "^Apache.*\(internal
dummy connection\)$"

Restarted apache and still kept getting:
DEBUG: [13/Jul/2012:15:34:13 +0000]
[ip-10-128-81-72.ap-southeast-1.compute.internal/sid#7f5fdc6a0370][rid#7f5fd
f6310a0][*][3] Could not set variable "ip.dos_counter" as the collection
does not exist.
AUDIT:
--fe256340-A--
[13/Jul/2012:15:34:14 +0000] UAA-9gqAUUgAAB9cIOwAAAAH 127.0.0.1 34888
127.0.0.1 80
--fe256340-B--
OPTIONS * HTTP/1.0
User-Agent: Apache (internal dummy connection)

--fe256340-F--
HTTP/1.1 200 OK
Content-Length: 0
Connection: close

--fe256340-H--
Message: Could not set variable "ip.dos_counter" as the collection does not
exist.
Stopwatch: 1342193654146888 832 (- - -)
Stopwatch2: 1342193654146888 832; combined=275, p1=0, p2=0, p3=0, p4=0,
p5=274, sr=0, sw=1, l=0, gc=0
Producer: ModSecurity for Apache/2.6.3 (http://www.modsecurity.org/);
OWASP_CRS/2.2.5; OWASP_CRS/2.2.5.
Server: Apache

--fe256340-Z--

Thinking that maybe the "chaining" of the rules was preventing a match, I
tried the following rules, all UNCHAINED (again, appended at the end of
10_setup.conf)
SecRule REQUEST_LINE "^(GET /|OPTIONS \*) HTTP/1.0$" "phase:1,allow,nolog"
        SecRule REMOTE_ADDR "^(127\.0\.0\.|\:\:)1$" "phase:1,allow,nolog"
                SecRule REQUEST_HEADERS:User-Agent "^Apache.*\(internal
dummy connection\)$" "phase:1,allow,nolog"

Result: Still kept getting the same errors.


Am I doing something wrongly? Is appending the rules to 10_setup.conf wrong?
Is there something wrong with the rules, which inadvertently allows the
apache internal dummy connection through?

Thank you so much.

JPow
From:  Ryan Barnett <RBarnett at trustwave.com>
Date:  Friday, July 13, 2012 10:11 PM
To:  Jingxun Pow <powster at gmail.com>,
"owasp-modsecurity-core-rule-set at lists.owasp.org"
<owasp-modsecurity-core-rule-set at lists.owasp.org>
Subject:  Re: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem:
Could not set variable "ip.dos_counter" as the collection does not exist.

The rules in the 47 common exceptions file will only adjust the anomaly
scores.  You could take these rules and place them into local 15 files and
add the "alllow" action to them.

-- 
Ryan Barnett
Trustwave SpiderLabs
ModSecurity Project Leader
OWASP ModSecurity CRS Project Leader

From: "JPow (powster)" <powster at gmail.com>
Date: Fri, 13 Jul 2012 09:01:11 -0500
To: "owasp-modsecurity-core-rule-set at lists.owasp.org"
<owasp-modsecurity-core-rule-set at lists.owasp.org>
Subject: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could not
set variable "ip.dos_counter" as the collection does not exist.

> Hi there,
> 
> I am facing a problem where I get "Could not set variable "ip.dos_counter" as
> the collection does not exist." debug output when using the dos_protection
> rule set ( "modsecurity_crs_11_dos_protection.conf").
> * DOS_Protection works as it should, so no issues with that (I have
> uncommented the relevant lines in the crs_10_setup.conf, as well as properly
> linked up the crs_11_dos_protection.conf
> * However, I find that the debug is littered with "Could not set variable
> "ip.dos_counter" as the collection does not exist."
> * I've realized that this is NOT a problem with INITCOL:IP not being called in
> the setup conf file --> This works properly (I am using the default
> crs_10_setup.conf)
> * The issue ONLY occurs with Apache (internal dummy connection) (see below
> debug / audit output)
>> * If you see below Audit Output, it is not a standard "GET" request.
>> * From my understanding, Apache's internal dummy connections are just done by
>> Apache to wake up its child processes.
> * I am puzzled why this happens, because I thought there already is an
> exception for Apache internal dummy connections in 47 common_exceptions.conf?
> Any reason why these dummy connections are still causing the error messages in
> the debug? And if so, how to solve this issue?
> 
> Thanks!
> 
> My system:
> -Ubuntu 12.04 on Amazon EC2
> -Apache 2.6.3 Mod_Security
> -OWASP_CRS/2.2.5.
> 
> Debug output:
> [13/Jul/2012:13:29:46 +0000]
> [ip-XX-XXX-XX-XX.ap-southeast-1.compute.internal/sid#7f40d4a48370][rid#7f40d64
> c60a0][*][3] Could not set variable "ip.dos_counter" as the collection does
> not exist.
> 
> Audit Output:
> --695eef13-A--
> [13/Jul/2012:13:29:46 +0000] UAAiygqAUUgAABqMEm0AAAAE 127.0.0.1 34716
> 127.0.0.1 80
> --695eef13-B--
> OPTIONS * HTTP/1.0
> User-Agent: Apache (internal dummy connection)
> 
> --695eef13-F--
> HTTP/1.1 200 OK
> Content-Length: 0
> Connection: close
> 
> --695eef13-H--
> Message: Could not set variable "ip.dos_counter" as the collection does not
> exist.
> Stopwatch: 1342186186315250 284 (- - -)
> Stopwatch2: 1342186186315250 284; combined=119, p1=0, p2=0, p3=0, p4=0,
> p5=118, sr=0, sw=1, l=0, gc=0
> Producer: ModSecurity for Apache/2.6.3 (http://www.modsecurity.org/);
> OWASP_CRS/2.2.5; OWASP_CRS/2.2.5.
> Server: Apache
> 
> --695eef13-Z--


This transmission may contain information that is privileged, confidential,
and/or exempt from disclosure under applicable law. If you are not the
intended recipient, you are hereby notified that any disclosure, copying,
distribution, or use of the information contained herein (including any
reliance thereon) is STRICTLY PROHIBITED. If you received this transmission
in error, please immediately contact the sender and destroy the material in
its entirety, whether in electronic or hard copy format.


-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120713/44248054/attachment-0001.html>

From RBarnett at trustwave.com  Fri Jul 13 15:44:26 2012
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Fri, 13 Jul 2012 10:44:26 -0500
Subject: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could
 not set variable "ip.dos_counter" as the collection does not exist.
In-Reply-To: <CC266099.A9A7%powster@gmail.com>
Message-ID: <CC25B9C5.56282%rbarnett@trustwave.com>



From: "JPow (powster)" <powster at gmail.com<mailto:powster at gmail.com>>
Date: Fri, 13 Jul 2012 10:39:21 -0500
To: Ryan Barnett <rbarnett at trustwave.com<mailto:rbarnett at trustwave.com>>, "owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>" <owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>>
Subject: Re: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could not set variable "ip.dos_counter" as the collection does not exist.

Hi Ryan,

Thanks for the tip. I tried adding this to the end of the 10_setup.conf:

SecRule REQUEST_LINE "^(GET /|OPTIONS \*) HTTP/1.0$" "phase:1,allow,nolog,chain,t:none"
        SecRule REMOTE_ADDR "^(127\.0\.0\.|\:\:)1$" "chain, t:none"
                SecRule REQUEST_HEADERS:User-Agent "^Apache.*\(internal dummy connection\)$"

I would add this before the [[ Global and IP Collections ]] rules.

Also ? is your SecRuleEngine set to On?  It needs to be to use the allow action.

-Ryan



Restarted apache and still kept getting:
DEBUG: [13/Jul/2012:15:34:13 +0000] [ip-10-128-81-72.ap-southeast-1.compute.internal/sid#7f5fdc6a0370][rid#7f5fdf6310a0][*][3] Could not set variable "ip.dos_counter" as the collection does not exist.
AUDIT:
--fe256340-A--
[13/Jul/2012:15:34:14 +0000] UAA-9gqAUUgAAB9cIOwAAAAH 127.0.0.1 34888 127.0.0.1 80
--fe256340-B--
OPTIONS * HTTP/1.0
User-Agent: Apache (internal dummy connection)

--fe256340-F--
HTTP/1.1 200 OK
Content-Length: 0
Connection: close

--fe256340-H--
Message: Could not set variable "ip.dos_counter" as the collection does not exist.
Stopwatch: 1342193654146888 832 (- - -)
Stopwatch2: 1342193654146888 832; combined=275, p1=0, p2=0, p3=0, p4=0, p5=274, sr=0, sw=1, l=0, gc=0
Producer: ModSecurity for Apache/2.6.3 (http://www.modsecurity.org/); OWASP_CRS/2.2.5; OWASP_CRS/2.2.5.
Server: Apache

--fe256340-Z--

Thinking that maybe the "chaining" of the rules was preventing a match, I tried the following rules, all UNCHAINED (again, appended at the end of 10_setup.conf)
SecRule REQUEST_LINE "^(GET /|OPTIONS \*) HTTP/1.0$" "phase:1,allow,nolog"
        SecRule REMOTE_ADDR "^(127\.0\.0\.|\:\:)1$" "phase:1,allow,nolog"
                SecRule REQUEST_HEADERS:User-Agent "^Apache.*\(internal dummy connection\)$" "phase:1,allow,nolog"

Result: Still kept getting the same errors.


Am I doing something wrongly? Is appending the rules to 10_setup.conf wrong?
Is there something wrong with the rules, which inadvertently allows the apache internal dummy connection through?

Thank you so much.

JPow
From: Ryan Barnett <RBarnett at trustwave.com<mailto:RBarnett at trustwave.com>>
Date: Friday, July 13, 2012 10:11 PM
To: Jingxun Pow <powster at gmail.com<mailto:powster at gmail.com>>, "owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>" <owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>>
Subject: Re: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could not set variable "ip.dos_counter" as the collection does not exist.

The rules in the 47 common exceptions file will only adjust the anomaly scores.  You could take these rules and place them into local 15 files and add the "alllow" action to them.

--
Ryan Barnett
Trustwave SpiderLabs
ModSecurity Project Leader
OWASP ModSecurity CRS Project Leader

From: "JPow (powster)" <powster at gmail.com<mailto:powster at gmail.com>>
Date: Fri, 13 Jul 2012 09:01:11 -0500
To: "owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>" <owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>>
Subject: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could not set variable "ip.dos_counter" as the collection does not exist.

Hi there,

I am facing a problem where I get "Could not set variable "ip.dos_counter" as the collection does not exist." debug output when using the dos_protection rule set ( "modsecurity_crs_11_dos_protection.conf").

 *   DOS_Protection works as it should, so no issues with that (I have uncommented the relevant lines in the crs_10_setup.conf, as well as properly linked up the crs_11_dos_protection.conf
 *   However, I find that the debug is littered with "Could not set variable "ip.dos_counter" as the collection does not exist."
 *   I've realized that this is NOT a problem with INITCOL:IP not being called in the setup conf file --> This works properly (I am using the default crs_10_setup.conf)
 *   The issue ONLY occurs with Apache (internal dummy connection) (see below debug / audit output)
    *   If you see below Audit Output, it is not a standard "GET" request.
    *   From my understanding, Apache's internal dummy connections are just done by Apache to wake up its child processes.
 *   I am puzzled why this happens, because I thought there already is an exception for Apache internal dummy connections in 47 common_exceptions.conf?

Any reason why these dummy connections are still causing the error messages in the debug? And if so, how to solve this issue?

Thanks!

My system:
-Ubuntu 12.04 on Amazon EC2
-Apache 2.6.3 Mod_Security
-OWASP_CRS/2.2.5.

Debug output:
[13/Jul/2012:13:29:46 +0000] [ip-XX-XXX-XX-XX.ap-southeast-1.compute.internal/sid#7f40d4a48370][rid#7f40d64c60a0][*][3] Could not set variable "ip.dos_counter" as the collection does not exist.

Audit Output:
--695eef13-A--
[13/Jul/2012:13:29:46 +0000] UAAiygqAUUgAABqMEm0AAAAE 127.0.0.1 34716 127.0.0.1 80
--695eef13-B--
OPTIONS * HTTP/1.0
User-Agent: Apache (internal dummy connection)

--695eef13-F--
HTTP/1.1 200 OK
Content-Length: 0
Connection: close

--695eef13-H--
Message: Could not set variable "ip.dos_counter" as the collection does not exist.
Stopwatch: 1342186186315250 284 (- - -)
Stopwatch2: 1342186186315250 284; combined=119, p1=0, p2=0, p3=0, p4=0, p5=118, sr=0, sw=1, l=0, gc=0
Producer: ModSecurity for Apache/2.6.3 (http://www.modsecurity.org/); OWASP_CRS/2.2.5; OWASP_CRS/2.2.5.
Server: Apache

--695eef13-Z--

________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.

________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120713/75705b88/attachment.html>

From powster at gmail.com  Fri Jul 13 16:04:14 2012
From: powster at gmail.com (JPow (powster))
Date: Sat, 14 Jul 2012 00:04:14 +0800
Subject: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could
 not set variable "ip.dos_counter" as the collection does not exist.
In-Reply-To: <CC25B9C5.56282%rbarnett@trustwave.com>
Message-ID: <CC2666FD.A9C5%powster@gmail.com>

Hi Ryan,

A million thanks! Putting the rules before [[Global and IP Collections]] did
the trick...

I just started with Modsecurity and the CRS today, and your tips have helped
me learn a lot. Great job on the entire CRS initiative!

Regards,
JPow

From:  Ryan Barnett <RBarnett at trustwave.com>
Date:  Friday, July 13, 2012 11:44 PM
To:  Jingxun Pow <powster at gmail.com>,
"owasp-modsecurity-core-rule-set at lists.owasp.org"
<owasp-modsecurity-core-rule-set at lists.owasp.org>
Subject:  Re: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem:
Could not set variable "ip.dos_counter" as the collection does not exist.



From: "JPow (powster)" <powster at gmail.com>
Date: Fri, 13 Jul 2012 10:39:21 -0500
To: Ryan Barnett <rbarnett at trustwave.com>,
"owasp-modsecurity-core-rule-set at lists.owasp.org"
<owasp-modsecurity-core-rule-set at lists.owasp.org>
Subject: Re: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could
not set variable "ip.dos_counter" as the collection does not exist.

> Hi Ryan,
> 
> Thanks for the tip. I tried adding this to the end of the 10_setup.conf:
> 
> SecRule REQUEST_LINE "^(GET /|OPTIONS \*) HTTP/1.0$"
> "phase:1,allow,nolog,chain,t:none"
>         SecRule REMOTE_ADDR "^(127\.0\.0\.|\:\:)1$" "chain, t:none"
>                 SecRule REQUEST_HEADERS:User-Agent "^Apache.*\(internal dummy
> connection\)$"

I would add this before the [[ Global and IP Collections ]] rules.

Also ? is your SecRuleEngine set to On?  It needs to be to use the allow
action.

-Ryan


> 
> Restarted apache and still kept getting:
> DEBUG: [13/Jul/2012:15:34:13 +0000]
> [ip-10-128-81-72.ap-southeast-1.compute.internal/sid#7f5fdc6a0370][rid#7f5fdf6
> 310a0][*][3] Could not set variable "ip.dos_counter" as the collection does
> not exist.
> AUDIT:
> --fe256340-A--
> [13/Jul/2012:15:34:14 +0000] UAA-9gqAUUgAAB9cIOwAAAAH 127.0.0.1 34888
> 127.0.0.1 80
> --fe256340-B--
> OPTIONS * HTTP/1.0
> User-Agent: Apache (internal dummy connection)
> 
> --fe256340-F--
> HTTP/1.1 200 OK
> Content-Length: 0
> Connection: close
> 
> --fe256340-H--
> Message: Could not set variable "ip.dos_counter" as the collection does not
> exist.
> Stopwatch: 1342193654146888 832 (- - -)
> Stopwatch2: 1342193654146888 832; combined=275, p1=0, p2=0, p3=0, p4=0,
> p5=274, sr=0, sw=1, l=0, gc=0
> Producer: ModSecurity for Apache/2.6.3 (http://www.modsecurity.org/);
> OWASP_CRS/2.2.5; OWASP_CRS/2.2.5.
> Server: Apache
> 
> --fe256340-Z--
> 
> Thinking that maybe the "chaining" of the rules was preventing a match, I
> tried the following rules, all UNCHAINED (again, appended at the end of
> 10_setup.conf)
> SecRule REQUEST_LINE "^(GET /|OPTIONS \*) HTTP/1.0$" "phase:1,allow,nolog"
>         SecRule REMOTE_ADDR "^(127\.0\.0\.|\:\:)1$" "phase:1,allow,nolog"
>                 SecRule REQUEST_HEADERS:User-Agent "^Apache.*\(internal dummy
> connection\)$" "phase:1,allow,nolog"
> 
> Result: Still kept getting the same errors.
> 
> 
> Am I doing something wrongly? Is appending the rules to 10_setup.conf wrong?
> Is there something wrong with the rules, which inadvertently allows the apache
> internal dummy connection through?
> 
> Thank you so much.
> 
> JPow
> From: Ryan Barnett <RBarnett at trustwave.com>
> Date: Friday, July 13, 2012 10:11 PM
> To: Jingxun Pow <powster at gmail.com>,
> "owasp-modsecurity-core-rule-set at lists.owasp.org"
> <owasp-modsecurity-core-rule-set at lists.owasp.org>
> Subject: Re: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could
> not set variable "ip.dos_counter" as the collection does not exist.
> 
> The rules in the 47 common exceptions file will only adjust the anomaly
> scores.  You could take these rules and place them into local 15 files and add
> the "alllow" action to them.
> 
> -- 
> Ryan Barnett
> Trustwave SpiderLabs
> ModSecurity Project Leader
> OWASP ModSecurity CRS Project Leader
> 
> From: "JPow (powster)" <powster at gmail.com>
> Date: Fri, 13 Jul 2012 09:01:11 -0500
> To: "owasp-modsecurity-core-rule-set at lists.owasp.org"
> <owasp-modsecurity-core-rule-set at lists.owasp.org>
> Subject: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could not
> set variable "ip.dos_counter" as the collection does not exist.
> 
>> Hi there,
>> 
>> I am facing a problem where I get "Could not set variable "ip.dos_counter" as
>> the collection does not exist." debug output when using the dos_protection
>> rule set ( "modsecurity_crs_11_dos_protection.conf").
>> * DOS_Protection works as it should, so no issues with that (I have
>> uncommented the relevant lines in the crs_10_setup.conf, as well as properly
>> linked up the crs_11_dos_protection.conf
>> * However, I find that the debug is littered with "Could not set variable
>> "ip.dos_counter" as the collection does not exist."
>> * I've realized that this is NOT a problem with INITCOL:IP not being called
>> in the setup conf file --> This works properly (I am using the default
>> crs_10_setup.conf)
>> * The issue ONLY occurs with Apache (internal dummy connection) (see below
>> debug / audit output)
>>> * If you see below Audit Output, it is not a standard "GET" request.
>>> * From my understanding, Apache's internal dummy connections are just done
>>> by Apache to wake up its child processes.
>> * I am puzzled why this happens, because I thought there already is an
>> exception for Apache internal dummy connections in 47 common_exceptions.conf?
>> Any reason why these dummy connections are still causing the error messages
>> in the debug? And if so, how to solve this issue?
>> 
>> Thanks!
>> 
>> My system:
>> -Ubuntu 12.04 on Amazon EC2
>> -Apache 2.6.3 Mod_Security
>> -OWASP_CRS/2.2.5.
>> 
>> Debug output:
>> [13/Jul/2012:13:29:46 +0000]
>> [ip-XX-XXX-XX-XX.ap-southeast-1.compute.internal/sid#7f40d4a48370][rid#7f40d6
>> 4c60a0][*][3] Could not set variable "ip.dos_counter" as the collection does
>> not exist.
>> 
>> Audit Output:
>> --695eef13-A--
>> [13/Jul/2012:13:29:46 +0000] UAAiygqAUUgAABqMEm0AAAAE 127.0.0.1 34716
>> 127.0.0.1 80
>> --695eef13-B--
>> OPTIONS * HTTP/1.0
>> User-Agent: Apache (internal dummy connection)
>> 
>> --695eef13-F--
>> HTTP/1.1 200 OK
>> Content-Length: 0
>> Connection: close
>> 
>> --695eef13-H--
>> Message: Could not set variable "ip.dos_counter" as the collection does not
>> exist.
>> Stopwatch: 1342186186315250 284 (- - -)
>> Stopwatch2: 1342186186315250 284; combined=119, p1=0, p2=0, p3=0, p4=0,
>> p5=118, sr=0, sw=1, l=0, gc=0
>> Producer: ModSecurity for Apache/2.6.3 (http://www.modsecurity.org/);
>> OWASP_CRS/2.2.5; OWASP_CRS/2.2.5.
>> Server: Apache
>> 
>> --695eef13-Z--
> 
> 
> This transmission may contain information that is privileged, confidential,
> and/or exempt from disclosure under applicable law. If you are not the
> intended recipient, you are hereby notified that any disclosure, copying,
> distribution, or use of the information contained herein (including any
> reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in
> error, please immediately contact the sender and destroy the material in its
> entirety, whether in electronic or hard copy format.


This transmission may contain information that is privileged, confidential,
and/or exempt from disclosure under applicable law. If you are not the
intended recipient, you are hereby notified that any disclosure, copying,
distribution, or use of the information contained herein (including any
reliance thereon) is STRICTLY PROHIBITED. If you received this transmission
in error, please immediately contact the sender and destroy the material in
its entirety, whether in electronic or hard copy format.


-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120714/69949226/attachment-0001.html>

From powster at gmail.com  Fri Jul 13 17:17:03 2012
From: powster at gmail.com (JPow (powster))
Date: Sat, 14 Jul 2012 01:17:03 +0800
Subject: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could
 not set variable "ip.dos_counter" as the collection does not exist.
In-Reply-To: <CC25B9C5.56282%rbarnett@trustwave.com>
Message-ID: <CC26782A.A9D8%powster@gmail.com>

Hi Ryan,

Sorry to bother again. After leaving the server running for awhile, I
realized I was facing the same problem even after incorporating suggestions
below.

I realized the problem after looking through debug level 9 logs:

modsecurity_crs_11_dos_protection.conf has rules that are in PHASE:5. These
Phase 5 rules are the ones that increase the ip.dos counters.

Since these rules are in Phase 5, they will be run regardless of whether the
ALLOW action is provided for apache internal relay transactions.

Since the "allow" method doesn't work for Phase 5, is there anyway to
provide exceptions for these cases?

Thanks,
JPow

From:  Ryan Barnett <RBarnett at trustwave.com>
Date:  Friday, July 13, 2012 11:44 PM
To:  Jingxun Pow <powster at gmail.com>,
"owasp-modsecurity-core-rule-set at lists.owasp.org"
<owasp-modsecurity-core-rule-set at lists.owasp.org>
Subject:  Re: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem:
Could not set variable "ip.dos_counter" as the collection does not exist.



From: "JPow (powster)" <powster at gmail.com>
Date: Fri, 13 Jul 2012 10:39:21 -0500
To: Ryan Barnett <rbarnett at trustwave.com>,
"owasp-modsecurity-core-rule-set at lists.owasp.org"
<owasp-modsecurity-core-rule-set at lists.owasp.org>
Subject: Re: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could
not set variable "ip.dos_counter" as the collection does not exist.

> Hi Ryan,
> 
> Thanks for the tip. I tried adding this to the end of the 10_setup.conf:
> 
> SecRule REQUEST_LINE "^(GET /|OPTIONS \*) HTTP/1.0$"
> "phase:1,allow,nolog,chain,t:none"
>         SecRule REMOTE_ADDR "^(127\.0\.0\.|\:\:)1$" "chain, t:none"
>                 SecRule REQUEST_HEADERS:User-Agent "^Apache.*\(internal dummy
> connection\)$"

I would add this before the [[ Global and IP Collections ]] rules.

Also ? is your SecRuleEngine set to On?  It needs to be to use the allow
action.

-Ryan


> 
> Restarted apache and still kept getting:
> DEBUG: [13/Jul/2012:15:34:13 +0000]
> [ip-10-128-81-72.ap-southeast-1.compute.internal/sid#7f5fdc6a0370][rid#7f5fdf6
> 310a0][*][3] Could not set variable "ip.dos_counter" as the collection does
> not exist.
> AUDIT:
> --fe256340-A--
> [13/Jul/2012:15:34:14 +0000] UAA-9gqAUUgAAB9cIOwAAAAH 127.0.0.1 34888
> 127.0.0.1 80
> --fe256340-B--
> OPTIONS * HTTP/1.0
> User-Agent: Apache (internal dummy connection)
> 
> --fe256340-F--
> HTTP/1.1 200 OK
> Content-Length: 0
> Connection: close
> 
> --fe256340-H--
> Message: Could not set variable "ip.dos_counter" as the collection does not
> exist.
> Stopwatch: 1342193654146888 832 (- - -)
> Stopwatch2: 1342193654146888 832; combined=275, p1=0, p2=0, p3=0, p4=0,
> p5=274, sr=0, sw=1, l=0, gc=0
> Producer: ModSecurity for Apache/2.6.3 (http://www.modsecurity.org/);
> OWASP_CRS/2.2.5; OWASP_CRS/2.2.5.
> Server: Apache
> 
> --fe256340-Z--
> 
> Thinking that maybe the "chaining" of the rules was preventing a match, I
> tried the following rules, all UNCHAINED (again, appended at the end of
> 10_setup.conf)
> SecRule REQUEST_LINE "^(GET /|OPTIONS \*) HTTP/1.0$" "phase:1,allow,nolog"
>         SecRule REMOTE_ADDR "^(127\.0\.0\.|\:\:)1$" "phase:1,allow,nolog"
>                 SecRule REQUEST_HEADERS:User-Agent "^Apache.*\(internal dummy
> connection\)$" "phase:1,allow,nolog"
> 
> Result: Still kept getting the same errors.
> 
> 
> Am I doing something wrongly? Is appending the rules to 10_setup.conf wrong?
> Is there something wrong with the rules, which inadvertently allows the apache
> internal dummy connection through?
> 
> Thank you so much.
> 
> JPow
> From: Ryan Barnett <RBarnett at trustwave.com>
> Date: Friday, July 13, 2012 10:11 PM
> To: Jingxun Pow <powster at gmail.com>,
> "owasp-modsecurity-core-rule-set at lists.owasp.org"
> <owasp-modsecurity-core-rule-set at lists.owasp.org>
> Subject: Re: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could
> not set variable "ip.dos_counter" as the collection does not exist.
> 
> The rules in the 47 common exceptions file will only adjust the anomaly
> scores.  You could take these rules and place them into local 15 files and add
> the "alllow" action to them.
> 
> -- 
> Ryan Barnett
> Trustwave SpiderLabs
> ModSecurity Project Leader
> OWASP ModSecurity CRS Project Leader
> 
> From: "JPow (powster)" <powster at gmail.com>
> Date: Fri, 13 Jul 2012 09:01:11 -0500
> To: "owasp-modsecurity-core-rule-set at lists.owasp.org"
> <owasp-modsecurity-core-rule-set at lists.owasp.org>
> Subject: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could not
> set variable "ip.dos_counter" as the collection does not exist.
> 
>> Hi there,
>> 
>> I am facing a problem where I get "Could not set variable "ip.dos_counter" as
>> the collection does not exist." debug output when using the dos_protection
>> rule set ( "modsecurity_crs_11_dos_protection.conf").
>> * DOS_Protection works as it should, so no issues with that (I have
>> uncommented the relevant lines in the crs_10_setup.conf, as well as properly
>> linked up the crs_11_dos_protection.conf
>> * However, I find that the debug is littered with "Could not set variable
>> "ip.dos_counter" as the collection does not exist."
>> * I've realized that this is NOT a problem with INITCOL:IP not being called
>> in the setup conf file --> This works properly (I am using the default
>> crs_10_setup.conf)
>> * The issue ONLY occurs with Apache (internal dummy connection) (see below
>> debug / audit output)
>>> * If you see below Audit Output, it is not a standard "GET" request.
>>> * From my understanding, Apache's internal dummy connections are just done
>>> by Apache to wake up its child processes.
>> * I am puzzled why this happens, because I thought there already is an
>> exception for Apache internal dummy connections in 47 common_exceptions.conf?
>> Any reason why these dummy connections are still causing the error messages
>> in the debug? And if so, how to solve this issue?
>> 
>> Thanks!
>> 
>> My system:
>> -Ubuntu 12.04 on Amazon EC2
>> -Apache 2.6.3 Mod_Security
>> -OWASP_CRS/2.2.5.
>> 
>> Debug output:
>> [13/Jul/2012:13:29:46 +0000]
>> [ip-XX-XXX-XX-XX.ap-southeast-1.compute.internal/sid#7f40d4a48370][rid#7f40d6
>> 4c60a0][*][3] Could not set variable "ip.dos_counter" as the collection does
>> not exist.
>> 
>> Audit Output:
>> --695eef13-A--
>> [13/Jul/2012:13:29:46 +0000] UAAiygqAUUgAABqMEm0AAAAE 127.0.0.1 34716
>> 127.0.0.1 80
>> --695eef13-B--
>> OPTIONS * HTTP/1.0
>> User-Agent: Apache (internal dummy connection)
>> 
>> --695eef13-F--
>> HTTP/1.1 200 OK
>> Content-Length: 0
>> Connection: close
>> 
>> --695eef13-H--
>> Message: Could not set variable "ip.dos_counter" as the collection does not
>> exist.
>> Stopwatch: 1342186186315250 284 (- - -)
>> Stopwatch2: 1342186186315250 284; combined=119, p1=0, p2=0, p3=0, p4=0,
>> p5=118, sr=0, sw=1, l=0, gc=0
>> Producer: ModSecurity for Apache/2.6.3 (http://www.modsecurity.org/);
>> OWASP_CRS/2.2.5; OWASP_CRS/2.2.5.
>> Server: Apache
>> 
>> --695eef13-Z--
> 
> 
> This transmission may contain information that is privileged, confidential,
> and/or exempt from disclosure under applicable law. If you are not the
> intended recipient, you are hereby notified that any disclosure, copying,
> distribution, or use of the information contained herein (including any
> reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in
> error, please immediately contact the sender and destroy the material in its
> entirety, whether in electronic or hard copy format.


This transmission may contain information that is privileged, confidential,
and/or exempt from disclosure under applicable law. If you are not the
intended recipient, you are hereby notified that any disclosure, copying,
distribution, or use of the information contained herein (including any
reliance thereon) is STRICTLY PROHIBITED. If you received this transmission
in error, please immediately contact the sender and destroy the material in
its entirety, whether in electronic or hard copy format.


-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120714/2700e5b9/attachment.html>

From RBarnett at trustwave.com  Fri Jul 13 17:19:21 2012
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Fri, 13 Jul 2012 12:19:21 -0500
Subject: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could
 not set variable "ip.dos_counter" as the collection does not exist.
In-Reply-To: <CC26782A.A9D8%powster@gmail.com>
Message-ID: <CC25D098.562B1%rbarnett@trustwave.com>

Update the rules to use the ctl action to disable the SecRuleEngine -


SecRule REQUEST_LINE "^(GET /|OPTIONS \*) HTTP/1.0$" "phase:1,allow,nolog,chain,t:none"
        SecRule REMOTE_ADDR "^(127\.0\.0\.|\:\:)1$" "chain, t:none"
                SecRule REQUEST_HEADERS:User-Agent "^Apache.*\(internal dummy connection\)$" "ctl:ruleEngine=Off"


-Ryan

From: "JPow (powster)" <powster at gmail.com<mailto:powster at gmail.com>>
Date: Fri, 13 Jul 2012 12:17:03 -0500
To: Ryan Barnett <rbarnett at trustwave.com<mailto:rbarnett at trustwave.com>>, "owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>" <owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>>
Subject: Re: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could not set variable "ip.dos_counter" as the collection does not exist.

Hi Ryan,

Sorry to bother again. After leaving the server running for awhile, I realized I was facing the same problem even after incorporating suggestions below.

I realized the problem after looking through debug level 9 logs:

modsecurity_crs_11_dos_protection.conf has rules that are in PHASE:5. These Phase 5 rules are the ones that increase the ip.dos counters.

Since these rules are in Phase 5, they will be run regardless of whether the ALLOW action is provided for apache internal relay transactions.

Since the "allow" method doesn't work for Phase 5, is there anyway to provide exceptions for these cases?

Thanks,
JPow

From: Ryan Barnett <RBarnett at trustwave.com<mailto:RBarnett at trustwave.com>>
Date: Friday, July 13, 2012 11:44 PM
To: Jingxun Pow <powster at gmail.com<mailto:powster at gmail.com>>, "owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>" <owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>>
Subject: Re: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could not set variable "ip.dos_counter" as the collection does not exist.



From: "JPow (powster)" <powster at gmail.com<mailto:powster at gmail.com>>
Date: Fri, 13 Jul 2012 10:39:21 -0500
To: Ryan Barnett <rbarnett at trustwave.com<mailto:rbarnett at trustwave.com>>, "owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>" <owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>>
Subject: Re: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could not set variable "ip.dos_counter" as the collection does not exist.

Hi Ryan,

Thanks for the tip. I tried adding this to the end of the 10_setup.conf:

SecRule REQUEST_LINE "^(GET /|OPTIONS \*) HTTP/1.0$" "phase:1,allow,nolog,chain,t:none"
        SecRule REMOTE_ADDR "^(127\.0\.0\.|\:\:)1$" "chain, t:none"
                SecRule REQUEST_HEADERS:User-Agent "^Apache.*\(internal dummy connection\)$"

I would add this before the [[ Global and IP Collections ]] rules.

Also ? is your SecRuleEngine set to On?  It needs to be to use the allow action.

-Ryan



Restarted apache and still kept getting:
DEBUG: [13/Jul/2012:15:34:13 +0000] [ip-10-128-81-72.ap-southeast-1.compute.internal/sid#7f5fdc6a0370][rid#7f5fdf6310a0][*][3] Could not set variable "ip.dos_counter" as the collection does not exist.
AUDIT:
--fe256340-A--
[13/Jul/2012:15:34:14 +0000] UAA-9gqAUUgAAB9cIOwAAAAH 127.0.0.1 34888 127.0.0.1 80
--fe256340-B--
OPTIONS * HTTP/1.0
User-Agent: Apache (internal dummy connection)

--fe256340-F--
HTTP/1.1 200 OK
Content-Length: 0
Connection: close

--fe256340-H--
Message: Could not set variable "ip.dos_counter" as the collection does not exist.
Stopwatch: 1342193654146888 832 (- - -)
Stopwatch2: 1342193654146888 832; combined=275, p1=0, p2=0, p3=0, p4=0, p5=274, sr=0, sw=1, l=0, gc=0
Producer: ModSecurity for Apache/2.6.3 (http://www.modsecurity.org/); OWASP_CRS/2.2.5; OWASP_CRS/2.2.5.
Server: Apache

--fe256340-Z--

Thinking that maybe the "chaining" of the rules was preventing a match, I tried the following rules, all UNCHAINED (again, appended at the end of 10_setup.conf)
SecRule REQUEST_LINE "^(GET /|OPTIONS \*) HTTP/1.0$" "phase:1,allow,nolog"
        SecRule REMOTE_ADDR "^(127\.0\.0\.|\:\:)1$" "phase:1,allow,nolog"
                SecRule REQUEST_HEADERS:User-Agent "^Apache.*\(internal dummy connection\)$" "phase:1,allow,nolog"

Result: Still kept getting the same errors.


Am I doing something wrongly? Is appending the rules to 10_setup.conf wrong?
Is there something wrong with the rules, which inadvertently allows the apache internal dummy connection through?

Thank you so much.

JPow
From: Ryan Barnett <RBarnett at trustwave.com<mailto:RBarnett at trustwave.com>>
Date: Friday, July 13, 2012 10:11 PM
To: Jingxun Pow <powster at gmail.com<mailto:powster at gmail.com>>, "owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>" <owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>>
Subject: Re: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could not set variable "ip.dos_counter" as the collection does not exist.

The rules in the 47 common exceptions file will only adjust the anomaly scores.  You could take these rules and place them into local 15 files and add the "alllow" action to them.

--
Ryan Barnett
Trustwave SpiderLabs
ModSecurity Project Leader
OWASP ModSecurity CRS Project Leader

From: "JPow (powster)" <powster at gmail.com<mailto:powster at gmail.com>>
Date: Fri, 13 Jul 2012 09:01:11 -0500
To: "owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>" <owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>>
Subject: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could not set variable "ip.dos_counter" as the collection does not exist.

Hi there,

I am facing a problem where I get "Could not set variable "ip.dos_counter" as the collection does not exist." debug output when using the dos_protection rule set ( "modsecurity_crs_11_dos_protection.conf").

 *   DOS_Protection works as it should, so no issues with that (I have uncommented the relevant lines in the crs_10_setup.conf, as well as properly linked up the crs_11_dos_protection.conf
 *   However, I find that the debug is littered with "Could not set variable "ip.dos_counter" as the collection does not exist."
 *   I've realized that this is NOT a problem with INITCOL:IP not being called in the setup conf file --> This works properly (I am using the default crs_10_setup.conf)
 *   The issue ONLY occurs with Apache (internal dummy connection) (see below debug / audit output)
    *   If you see below Audit Output, it is not a standard "GET" request.
    *   From my understanding, Apache's internal dummy connections are just done by Apache to wake up its child processes.
 *   I am puzzled why this happens, because I thought there already is an exception for Apache internal dummy connections in 47 common_exceptions.conf?

Any reason why these dummy connections are still causing the error messages in the debug? And if so, how to solve this issue?

Thanks!

My system:
-Ubuntu 12.04 on Amazon EC2
-Apache 2.6.3 Mod_Security
-OWASP_CRS/2.2.5.

Debug output:
[13/Jul/2012:13:29:46 +0000] [ip-XX-XXX-XX-XX.ap-southeast-1.compute.internal/sid#7f40d4a48370][rid#7f40d64c60a0][*][3] Could not set variable "ip.dos_counter" as the collection does not exist.

Audit Output:
--695eef13-A--
[13/Jul/2012:13:29:46 +0000] UAAiygqAUUgAABqMEm0AAAAE 127.0.0.1 34716 127.0.0.1 80
--695eef13-B--
OPTIONS * HTTP/1.0
User-Agent: Apache (internal dummy connection)

--695eef13-F--
HTTP/1.1 200 OK
Content-Length: 0
Connection: close

--695eef13-H--
Message: Could not set variable "ip.dos_counter" as the collection does not exist.
Stopwatch: 1342186186315250 284 (- - -)
Stopwatch2: 1342186186315250 284; combined=119, p1=0, p2=0, p3=0, p4=0, p5=118, sr=0, sw=1, l=0, gc=0
Producer: ModSecurity for Apache/2.6.3 (http://www.modsecurity.org/); OWASP_CRS/2.2.5; OWASP_CRS/2.2.5.
Server: Apache

--695eef13-Z--

________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.

________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.

________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120713/80df6b2d/attachment-0001.html>

From powster at gmail.com  Sat Jul 14 07:19:15 2012
From: powster at gmail.com (JPow (powster))
Date: Sat, 14 Jul 2012 15:19:15 +0800
Subject: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could
 not set variable "ip.dos_counter" as the collection does not exist.
In-Reply-To: <CC25D098.562B1%rbarnett@trustwave.com>
Message-ID: <CC273D29.AA19%powster@gmail.com>

Hi Ryan,

Tried that and still getting the same error.
I tried another approach where I changed all the PHASE 5 DOS PROTECTION
rules to PHASE 4.  So far, that seems to work! Any potential drawbacks of
shifting from Phase 5 to Phase 4?

Separately, I understand that BLOCK actions are typically deny + status:XXX,
or redirects.

I am using AJAX quite extensively in my site, and trying to figure out a way
for the AJAX request to error-out (assuming it is blocked by mod security)
gracefully via a prompt on the user's screen.

Currently, the ajax loading indicator will just load forever if the request
is blocked my mod security.

I tried setting the block action to "Redirect" to a "throwexception.php"
file which throws an exception, but the function calling the ajax request
doesn't receive the exception (I don't think exception information can get
passed through via a redirect).

Appreciate the guidance!

Thanks,
JPow



From:  Ryan Barnett <RBarnett at trustwave.com>
Date:  Saturday, July 14, 2012 1:19 AM
To:  Jingxun Pow <powster at gmail.com>,
"owasp-modsecurity-core-rule-set at lists.owasp.org"
<owasp-modsecurity-core-rule-set at lists.owasp.org>
Subject:  Re: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem:
Could not set variable "ip.dos_counter" as the collection does not exist.

Update the rules to use the ctl action to disable the SecRuleEngine -


SecRule REQUEST_LINE "^(GET /|OPTIONS \*) HTTP/1.0$"
"phase:1,allow,nolog,chain,t:none"
        SecRule REMOTE_ADDR "^(127\.0\.0\.|\:\:)1$" "chain, t:none"
                SecRule REQUEST_HEADERS:User-Agent "^Apache.*\(internal
dummy connection\)$" "ctl:ruleEngine=Off"


-Ryan

From: "JPow (powster)" <powster at gmail.com>
Date: Fri, 13 Jul 2012 12:17:03 -0500
To: Ryan Barnett <rbarnett at trustwave.com>,
"owasp-modsecurity-core-rule-set at lists.owasp.org"
<owasp-modsecurity-core-rule-set at lists.owasp.org>
Subject: Re: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could
not set variable "ip.dos_counter" as the collection does not exist.

> Hi Ryan,
> 
> Sorry to bother again. After leaving the server running for awhile, I realized
> I was facing the same problem even after incorporating suggestions below.
> 
> I realized the problem after looking through debug level 9 logs:
> 
> modsecurity_crs_11_dos_protection.conf has rules that are in PHASE:5. These
> Phase 5 rules are the ones that increase the ip.dos counters.
> 
> Since these rules are in Phase 5, they will be run regardless of whether the
> ALLOW action is provided for apache internal relay transactions.
> 
> Since the "allow" method doesn't work for Phase 5, is there anyway to provide
> exceptions for these cases?
> 
> Thanks,
> JPow
> 
> From: Ryan Barnett <RBarnett at trustwave.com>
> Date: Friday, July 13, 2012 11:44 PM
> To: Jingxun Pow <powster at gmail.com>,
> "owasp-modsecurity-core-rule-set at lists.owasp.org"
> <owasp-modsecurity-core-rule-set at lists.owasp.org>
> Subject: Re: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could
> not set variable "ip.dos_counter" as the collection does not exist.
> 
> 
> 
> From: "JPow (powster)" <powster at gmail.com>
> Date: Fri, 13 Jul 2012 10:39:21 -0500
> To: Ryan Barnett <rbarnett at trustwave.com>,
> "owasp-modsecurity-core-rule-set at lists.owasp.org"
> <owasp-modsecurity-core-rule-set at lists.owasp.org>
> Subject: Re: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could
> not set variable "ip.dos_counter" as the collection does not exist.
> 
>> Hi Ryan,
>> 
>> Thanks for the tip. I tried adding this to the end of the 10_setup.conf:
>> 
>> SecRule REQUEST_LINE "^(GET /|OPTIONS \*) HTTP/1.0$"
>> "phase:1,allow,nolog,chain,t:none"
>>         SecRule REMOTE_ADDR "^(127\.0\.0\.|\:\:)1$" "chain, t:none"
>>                 SecRule REQUEST_HEADERS:User-Agent "^Apache.*\(internal dummy
>> connection\)$"
> 
> I would add this before the [[ Global and IP Collections ]] rules.
> 
> Also ? is your SecRuleEngine set to On?  It needs to be to use the allow
> action.
> 
> -Ryan
> 
> 
>> 
>> Restarted apache and still kept getting:
>> DEBUG: [13/Jul/2012:15:34:13 +0000]
>> [ip-10-128-81-72.ap-southeast-1.compute.internal/sid#7f5fdc6a0370][rid#7f5fdf
>> 6310a0][*][3] Could not set variable "ip.dos_counter" as the collection does
>> not exist.
>> AUDIT:
>> --fe256340-A--
>> [13/Jul/2012:15:34:14 +0000] UAA-9gqAUUgAAB9cIOwAAAAH 127.0.0.1 34888
>> 127.0.0.1 80
>> --fe256340-B--
>> OPTIONS * HTTP/1.0
>> User-Agent: Apache (internal dummy connection)
>> 
>> --fe256340-F--
>> HTTP/1.1 200 OK
>> Content-Length: 0
>> Connection: close
>> 
>> --fe256340-H--
>> Message: Could not set variable "ip.dos_counter" as the collection does not
>> exist.
>> Stopwatch: 1342193654146888 832 (- - -)
>> Stopwatch2: 1342193654146888 832; combined=275, p1=0, p2=0, p3=0, p4=0,
>> p5=274, sr=0, sw=1, l=0, gc=0
>> Producer: ModSecurity for Apache/2.6.3 (http://www.modsecurity.org/);
>> OWASP_CRS/2.2.5; OWASP_CRS/2.2.5.
>> Server: Apache
>> 
>> --fe256340-Z--
>> 
>> Thinking that maybe the "chaining" of the rules was preventing a match, I
>> tried the following rules, all UNCHAINED (again, appended at the end of
>> 10_setup.conf)
>> SecRule REQUEST_LINE "^(GET /|OPTIONS \*) HTTP/1.0$" "phase:1,allow,nolog"
>>         SecRule REMOTE_ADDR "^(127\.0\.0\.|\:\:)1$" "phase:1,allow,nolog"
>>                 SecRule REQUEST_HEADERS:User-Agent "^Apache.*\(internal dummy
>> connection\)$" "phase:1,allow,nolog"
>> 
>> Result: Still kept getting the same errors.
>> 
>> 
>> Am I doing something wrongly? Is appending the rules to 10_setup.conf wrong?
>> Is there something wrong with the rules, which inadvertently allows the
>> apache internal dummy connection through?
>> 
>> Thank you so much.
>> 
>> JPow
>> From: Ryan Barnett <RBarnett at trustwave.com>
>> Date: Friday, July 13, 2012 10:11 PM
>> To: Jingxun Pow <powster at gmail.com>,
>> "owasp-modsecurity-core-rule-set at lists.owasp.org"
>> <owasp-modsecurity-core-rule-set at lists.owasp.org>
>> Subject: Re: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could
>> not set variable "ip.dos_counter" as the collection does not exist.
>> 
>> The rules in the 47 common exceptions file will only adjust the anomaly
>> scores.  You could take these rules and place them into local 15 files and
>> add the "alllow" action to them.
>> 
>> -- 
>> Ryan Barnett
>> Trustwave SpiderLabs
>> ModSecurity Project Leader
>> OWASP ModSecurity CRS Project Leader
>> 
>> From: "JPow (powster)" <powster at gmail.com>
>> Date: Fri, 13 Jul 2012 09:01:11 -0500
>> To: "owasp-modsecurity-core-rule-set at lists.owasp.org"
>> <owasp-modsecurity-core-rule-set at lists.owasp.org>
>> Subject: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could not
>> set variable "ip.dos_counter" as the collection does not exist.
>> 
>>> Hi there,
>>> 
>>> I am facing a problem where I get "Could not set variable "ip.dos_counter"
>>> as the collection does not exist." debug output when using the
>>> dos_protection rule set ( "modsecurity_crs_11_dos_protection.conf").
>>> * DOS_Protection works as it should, so no issues with that (I have
>>> uncommented the relevant lines in the crs_10_setup.conf, as well as properly
>>> linked up the crs_11_dos_protection.conf
>>> * However, I find that the debug is littered with "Could not set variable
>>> "ip.dos_counter" as the collection does not exist."
>>> * I've realized that this is NOT a problem with INITCOL:IP not being called
>>> in the setup conf file --> This works properly (I am using the default
>>> crs_10_setup.conf)
>>> * The issue ONLY occurs with Apache (internal dummy connection) (see below
>>> debug / audit output)
>>>> * If you see below Audit Output, it is not a standard "GET" request.
>>>> * From my understanding, Apache's internal dummy connections are just done
>>>> by Apache to wake up its child processes.
>>> * I am puzzled why this happens, because I thought there already is an
>>> exception for Apache internal dummy connections in 47
>>> common_exceptions.conf?
>>> Any reason why these dummy connections are still causing the error messages
>>> in the debug? And if so, how to solve this issue?
>>> 
>>> Thanks!
>>> 
>>> My system:
>>> -Ubuntu 12.04 on Amazon EC2
>>> -Apache 2.6.3 Mod_Security
>>> -OWASP_CRS/2.2.5.
>>> 
>>> Debug output:
>>> [13/Jul/2012:13:29:46 +0000]
>>> [ip-XX-XXX-XX-XX.ap-southeast-1.compute.internal/sid#7f40d4a48370][rid#7f40d
>>> 64c60a0][*][3] Could not set variable "ip.dos_counter" as the collection
>>> does not exist.
>>> 
>>> Audit Output:
>>> --695eef13-A--
>>> [13/Jul/2012:13:29:46 +0000] UAAiygqAUUgAABqMEm0AAAAE 127.0.0.1 34716
>>> 127.0.0.1 80
>>> --695eef13-B--
>>> OPTIONS * HTTP/1.0
>>> User-Agent: Apache (internal dummy connection)
>>> 
>>> --695eef13-F--
>>> HTTP/1.1 200 OK
>>> Content-Length: 0
>>> Connection: close
>>> 
>>> --695eef13-H--
>>> Message: Could not set variable "ip.dos_counter" as the collection does not
>>> exist.
>>> Stopwatch: 1342186186315250 284 (- - -)
>>> Stopwatch2: 1342186186315250 284; combined=119, p1=0, p2=0, p3=0, p4=0,
>>> p5=118, sr=0, sw=1, l=0, gc=0
>>> Producer: ModSecurity for Apache/2.6.3 (http://www.modsecurity.org/);
>>> OWASP_CRS/2.2.5; OWASP_CRS/2.2.5.
>>> Server: Apache
>>> 
>>> --695eef13-Z--
>> 
>> 
>> This transmission may contain information that is privileged, confidential,
>> and/or exempt from disclosure under applicable law. If you are not the
>> intended recipient, you are hereby notified that any disclosure, copying,
>> distribution, or use of the information contained herein (including any
>> reliance thereon) is STRICTLY PROHIBITED. If you received this transmission
>> in error, please immediately contact the sender and destroy the material in
>> its entirety, whether in electronic or hard copy format.
> 
> 
> This transmission may contain information that is privileged, confidential,
> and/or exempt from disclosure under applicable law. If you are not the
> intended recipient, you are hereby notified that any disclosure, copying,
> distribution, or use of the information contained herein (including any
> reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in
> error, please immediately contact the sender and destroy the material in its
> entirety, whether in electronic or hard copy format.


This transmission may contain information that is privileged, confidential,
and/or exempt from disclosure under applicable law. If you are not the
intended recipient, you are hereby notified that any disclosure, copying,
distribution, or use of the information contained herein (including any
reliance thereon) is STRICTLY PROHIBITED. If you received this transmission
in error, please immediately contact the sender and destroy the material in
its entirety, whether in electronic or hard copy format.


-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120714/8183992b/attachment-0001.html>

From powster at gmail.com  Sat Jul 14 07:46:40 2012
From: powster at gmail.com (JPow (powster))
Date: Sat, 14 Jul 2012 15:46:40 +0800
Subject: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could
 not set variable "ip.dos_counter" as the collection does not exist.
In-Reply-To: <CC273D29.AA19%powster@gmail.com>
Message-ID: <CC27427F.AA29%powster@gmail.com>

Apologies, regarding the second question of ajax error handling of a
Modsecurity block, the redirect method actually DOES work.

For those interested in having a custom ajax error msg appear if it the ajax
request is blocked by ModSecurity:

NOTE: I am using jquery.ajax setup to expects JSON responses from server:

1. Create "testerrormessage.php"
//Return Custom Error
$jsonajaxoutput['successflag'] = 0; //FAILURE
$jsonajaxoutput['modsecurityblockflag'] = 1; //FAILURE VIA MODSECURITY
$jsonajaxoutput['modsecurityerrormsg'] = "Modsecurity Error!"
$jsonajaxoutput['datafield1'] = "Whatever data you want returned to your
script"
$jsonajaxoutput['datafield2'] = "Whatever data you want returned to your
script"
$jsonajaxoutput['message'] = "SUCCESS: Successful save of field order.";
header('Content-type: application:json');
echo json_encode($jsonajaxoutput);
exit();

2. Set default block action for mod security to redirect to the above script
SecDefaultAction 
"redirect:http://yourserver.com/testerrormessage.php,log,auditlog, phase:2"

3. Adjust your jquery ajax function to alert mod security error message if
the request fails.
jQuery.ajax({
type: "POST",
url: "yourajaxprocessingscript.php",
data: "allyourpostdata="+ postdata,
dataType: "json",
    success: function(returndata, textStatus, xhr){
if (returndata.successflag == 1) {
//do whatever success action
} else if (returndata.modsecurityblockflag ==1) {
Alert(returndata.modsecurityerrormsg);
>>> }
    } 
}
});



From:  Jingxun Pow <powster at gmail.com>
Date:  Saturday, July 14, 2012 3:19 PM
To:  Ryan Barnett <RBarnett at trustwave.com>,
"owasp-modsecurity-core-rule-set at lists.owasp.org"
<owasp-modsecurity-core-rule-set at lists.owasp.org>
Subject:  Re: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem:
Could not set variable "ip.dos_counter" as the collection does not exist.

Hi Ryan,

Tried that and still getting the same error.
I tried another approach where I changed all the PHASE 5 DOS PROTECTION
rules to PHASE 4.  So far, that seems to work! Any potential drawbacks of
shifting from Phase 5 to Phase 4?

Separately, I understand that BLOCK actions are typically deny + status:XXX,
or redirects.

I am using AJAX quite extensively in my site, and trying to figure out a way
for the AJAX request to error-out (assuming it is blocked by mod security)
gracefully via a prompt on the user's screen.

Currently, the ajax loading indicator will just load forever if the request
is blocked my mod security.

I tried setting the block action to "Redirect" to a "throwexception.php"
file which throws an exception, but the function calling the ajax request
doesn't receive the exception (I don't think exception information can get
passed through via a redirect).

Appreciate the guidance!

Thanks,
JPow



From:  Ryan Barnett <RBarnett at trustwave.com>
Date:  Saturday, July 14, 2012 1:19 AM
To:  Jingxun Pow <powster at gmail.com>,
"owasp-modsecurity-core-rule-set at lists.owasp.org"
<owasp-modsecurity-core-rule-set at lists.owasp.org>
Subject:  Re: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem:
Could not set variable "ip.dos_counter" as the collection does not exist.

Update the rules to use the ctl action to disable the SecRuleEngine -


SecRule REQUEST_LINE "^(GET /|OPTIONS \*) HTTP/1.0$"
"phase:1,allow,nolog,chain,t:none"
        SecRule REMOTE_ADDR "^(127\.0\.0\.|\:\:)1$" "chain, t:none"
                SecRule REQUEST_HEADERS:User-Agent "^Apache.*\(internal
dummy connection\)$" "ctl:ruleEngine=Off"


-Ryan

From: "JPow (powster)" <powster at gmail.com>
Date: Fri, 13 Jul 2012 12:17:03 -0500
To: Ryan Barnett <rbarnett at trustwave.com>,
"owasp-modsecurity-core-rule-set at lists.owasp.org"
<owasp-modsecurity-core-rule-set at lists.owasp.org>
Subject: Re: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could
not set variable "ip.dos_counter" as the collection does not exist.

> Hi Ryan,
> 
> Sorry to bother again. After leaving the server running for awhile, I realized
> I was facing the same problem even after incorporating suggestions below.
> 
> I realized the problem after looking through debug level 9 logs:
> 
> modsecurity_crs_11_dos_protection.conf has rules that are in PHASE:5. These
> Phase 5 rules are the ones that increase the ip.dos counters.
> 
> Since these rules are in Phase 5, they will be run regardless of whether the
> ALLOW action is provided for apache internal relay transactions.
> 
> Since the "allow" method doesn't work for Phase 5, is there anyway to provide
> exceptions for these cases?
> 
> Thanks,
> JPow
> 
> From: Ryan Barnett <RBarnett at trustwave.com>
> Date: Friday, July 13, 2012 11:44 PM
> To: Jingxun Pow <powster at gmail.com>,
> "owasp-modsecurity-core-rule-set at lists.owasp.org"
> <owasp-modsecurity-core-rule-set at lists.owasp.org>
> Subject: Re: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could
> not set variable "ip.dos_counter" as the collection does not exist.
> 
> 
> 
> From: "JPow (powster)" <powster at gmail.com>
> Date: Fri, 13 Jul 2012 10:39:21 -0500
> To: Ryan Barnett <rbarnett at trustwave.com>,
> "owasp-modsecurity-core-rule-set at lists.owasp.org"
> <owasp-modsecurity-core-rule-set at lists.owasp.org>
> Subject: Re: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could
> not set variable "ip.dos_counter" as the collection does not exist.
> 
>> Hi Ryan,
>> 
>> Thanks for the tip. I tried adding this to the end of the 10_setup.conf:
>> 
>> SecRule REQUEST_LINE "^(GET /|OPTIONS \*) HTTP/1.0$"
>> "phase:1,allow,nolog,chain,t:none"
>>         SecRule REMOTE_ADDR "^(127\.0\.0\.|\:\:)1$" "chain, t:none"
>>                 SecRule REQUEST_HEADERS:User-Agent "^Apache.*\(internal dummy
>> connection\)$"
> 
> I would add this before the [[ Global and IP Collections ]] rules.
> 
> Also ? is your SecRuleEngine set to On?  It needs to be to use the allow
> action.
> 
> -Ryan
> 
> 
>> 
>> Restarted apache and still kept getting:
>> DEBUG: [13/Jul/2012:15:34:13 +0000]
>> [ip-10-128-81-72.ap-southeast-1.compute.internal/sid#7f5fdc6a0370][rid#7f5fdf
>> 6310a0][*][3] Could not set variable "ip.dos_counter" as the collection does
>> not exist.
>> AUDIT:
>> --fe256340-A--
>> [13/Jul/2012:15:34:14 +0000] UAA-9gqAUUgAAB9cIOwAAAAH 127.0.0.1 34888
>> 127.0.0.1 80
>> --fe256340-B--
>> OPTIONS * HTTP/1.0
>> User-Agent: Apache (internal dummy connection)
>> 
>> --fe256340-F--
>> HTTP/1.1 200 OK
>> Content-Length: 0
>> Connection: close
>> 
>> --fe256340-H--
>> Message: Could not set variable "ip.dos_counter" as the collection does not
>> exist.
>> Stopwatch: 1342193654146888 832 (- - -)
>> Stopwatch2: 1342193654146888 832; combined=275, p1=0, p2=0, p3=0, p4=0,
>> p5=274, sr=0, sw=1, l=0, gc=0
>> Producer: ModSecurity for Apache/2.6.3 (http://www.modsecurity.org/);
>> OWASP_CRS/2.2.5; OWASP_CRS/2.2.5.
>> Server: Apache
>> 
>> --fe256340-Z--
>> 
>> Thinking that maybe the "chaining" of the rules was preventing a match, I
>> tried the following rules, all UNCHAINED (again, appended at the end of
>> 10_setup.conf)
>> SecRule REQUEST_LINE "^(GET /|OPTIONS \*) HTTP/1.0$" "phase:1,allow,nolog"
>>         SecRule REMOTE_ADDR "^(127\.0\.0\.|\:\:)1$" "phase:1,allow,nolog"
>>                 SecRule REQUEST_HEADERS:User-Agent "^Apache.*\(internal dummy
>> connection\)$" "phase:1,allow,nolog"
>> 
>> Result: Still kept getting the same errors.
>> 
>> 
>> Am I doing something wrongly? Is appending the rules to 10_setup.conf wrong?
>> Is there something wrong with the rules, which inadvertently allows the
>> apache internal dummy connection through?
>> 
>> Thank you so much.
>> 
>> JPow
>> From: Ryan Barnett <RBarnett at trustwave.com>
>> Date: Friday, July 13, 2012 10:11 PM
>> To: Jingxun Pow <powster at gmail.com>,
>> "owasp-modsecurity-core-rule-set at lists.owasp.org"
>> <owasp-modsecurity-core-rule-set at lists.owasp.org>
>> Subject: Re: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could
>> not set variable "ip.dos_counter" as the collection does not exist.
>> 
>> The rules in the 47 common exceptions file will only adjust the anomaly
>> scores.  You could take these rules and place them into local 15 files and
>> add the "alllow" action to them.
>> 
>> -- 
>> Ryan Barnett
>> Trustwave SpiderLabs
>> ModSecurity Project Leader
>> OWASP ModSecurity CRS Project Leader
>> 
>> From: "JPow (powster)" <powster at gmail.com>
>> Date: Fri, 13 Jul 2012 09:01:11 -0500
>> To: "owasp-modsecurity-core-rule-set at lists.owasp.org"
>> <owasp-modsecurity-core-rule-set at lists.owasp.org>
>> Subject: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could not
>> set variable "ip.dos_counter" as the collection does not exist.
>> 
>>> Hi there,
>>> 
>>> I am facing a problem where I get "Could not set variable "ip.dos_counter"
>>> as the collection does not exist." debug output when using the
>>> dos_protection rule set ( "modsecurity_crs_11_dos_protection.conf").
>>> * DOS_Protection works as it should, so no issues with that (I have
>>> uncommented the relevant lines in the crs_10_setup.conf, as well as properly
>>> linked up the crs_11_dos_protection.conf
>>> * However, I find that the debug is littered with "Could not set variable
>>> "ip.dos_counter" as the collection does not exist."
>>> * I've realized that this is NOT a problem with INITCOL:IP not being called
>>> in the setup conf file --> This works properly (I am using the default
>>> crs_10_setup.conf)
>>> * The issue ONLY occurs with Apache (internal dummy connection) (see below
>>> debug / audit output)
>>>> * If you see below Audit Output, it is not a standard "GET" request.
>>>> * From my understanding, Apache's internal dummy connections are just done
>>>> by Apache to wake up its child processes.
>>> * I am puzzled why this happens, because I thought there already is an
>>> exception for Apache internal dummy connections in 47
>>> common_exceptions.conf?
>>> Any reason why these dummy connections are still causing the error messages
>>> in the debug? And if so, how to solve this issue?
>>> 
>>> Thanks!
>>> 
>>> My system:
>>> -Ubuntu 12.04 on Amazon EC2
>>> -Apache 2.6.3 Mod_Security
>>> -OWASP_CRS/2.2.5.
>>> 
>>> Debug output:
>>> [13/Jul/2012:13:29:46 +0000]
>>> [ip-XX-XXX-XX-XX.ap-southeast-1.compute.internal/sid#7f40d4a48370][rid#7f40d
>>> 64c60a0][*][3] Could not set variable "ip.dos_counter" as the collection
>>> does not exist.
>>> 
>>> Audit Output:
>>> --695eef13-A--
>>> [13/Jul/2012:13:29:46 +0000] UAAiygqAUUgAABqMEm0AAAAE 127.0.0.1 34716
>>> 127.0.0.1 80
>>> --695eef13-B--
>>> OPTIONS * HTTP/1.0
>>> User-Agent: Apache (internal dummy connection)
>>> 
>>> --695eef13-F--
>>> HTTP/1.1 200 OK
>>> Content-Length: 0
>>> Connection: close
>>> 
>>> --695eef13-H--
>>> Message: Could not set variable "ip.dos_counter" as the collection does not
>>> exist.
>>> Stopwatch: 1342186186315250 284 (- - -)
>>> Stopwatch2: 1342186186315250 284; combined=119, p1=0, p2=0, p3=0, p4=0,
>>> p5=118, sr=0, sw=1, l=0, gc=0
>>> Producer: ModSecurity for Apache/2.6.3 (http://www.modsecurity.org/);
>>> OWASP_CRS/2.2.5; OWASP_CRS/2.2.5.
>>> Server: Apache
>>> 
>>> --695eef13-Z--
>> 
>> 
>> This transmission may contain information that is privileged, confidential,
>> and/or exempt from disclosure under applicable law. If you are not the
>> intended recipient, you are hereby notified that any disclosure, copying,
>> distribution, or use of the information contained herein (including any
>> reliance thereon) is STRICTLY PROHIBITED. If you received this transmission
>> in error, please immediately contact the sender and destroy the material in
>> its entirety, whether in electronic or hard copy format.
> 
> 
> This transmission may contain information that is privileged, confidential,
> and/or exempt from disclosure under applicable law. If you are not the
> intended recipient, you are hereby notified that any disclosure, copying,
> distribution, or use of the information contained herein (including any
> reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in
> error, please immediately contact the sender and destroy the material in its
> entirety, whether in electronic or hard copy format.


This transmission may contain information that is privileged, confidential,
and/or exempt from disclosure under applicable law. If you are not the
intended recipient, you are hereby notified that any disclosure, copying,
distribution, or use of the information contained herein (including any
reliance thereon) is STRICTLY PROHIBITED. If you received this transmission
in error, please immediately contact the sender and destroy the material in
its entirety, whether in electronic or hard copy format.


-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120714/fb647425/attachment-0001.html>

From stephen.e.canell at jpl.nasa.gov  Fri Jul 20 17:13:22 2012
From: stephen.e.canell at jpl.nasa.gov (Canell, Stephen E (2240))
Date: Fri, 20 Jul 2012 17:13:22 +0000
Subject: [Owasp-modsecurity-core-rule-set] SQL Keyword Anomaly Scoring
In-Reply-To: <CC2EDAFE.3FAC9%scanell@jpl.nasa.gov>
Message-ID: <CC2EDFA7.3FAEA%scanell@jpl.nasa.gov>

#
# SQL Keyword Anomaly Scoring:

I am having issues fine tuning all SQL rules for a COTS product.  This relates to the ID 981301 - 981316 with 981317.
I get a 403 from 918317 related to the previous SecRules because of the keyword count trigger.
Would the keyword in 301-316 be triggered by variables names having SQL keywords in the var name, such as:
 "search.selectedJobFamily.value" (981301 - select)

Also,
 I have two variables where users can enter an entire resume, so most, if not all of the SQL keywords in the SQL rules 301-316 will get hit!

I have seen the use SecRuleUpdateById in conjunction of !ARGS:<var> used, but 301-316 uses TX:SQLI?.. How do I use the SecRuleUpdateById with TX vs ARGS, and or
what is the best way to allow all words for these two variables and not set off the SQL triggers.

Thank you
Steve

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120720/b631ea8d/attachment.html>

From RBarnett at trustwave.com  Fri Jul 20 17:40:36 2012
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Fri, 20 Jul 2012 12:40:36 -0500
Subject: [Owasp-modsecurity-core-rule-set] Beyond Apache: ModSecurity for
	IIS/Nginx is Coming
Message-ID: <CC2F1054.56BB1%rbarnett@trustwave.com>

Big news ? ModSecurity for IIS and Nginx platforms!  We are releasing these next week during Blackhat USA.

http://blog.spiderlabs.com/2012/07/beyond-apache-modsecurity-for-iisnginx.html

If you would like to help with Beta testing, please let me know.

--
Ryan Barnett
Trustwave SpiderLabs
ModSecurity Project Leader
OWASP ModSecurity CRS Project Leader

________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120720/ee4a8796/attachment.html>

From RBarnett at trustwave.com  Fri Jul 20 17:48:24 2012
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Fri, 20 Jul 2012 12:48:24 -0500
Subject: [Owasp-modsecurity-core-rule-set] SQL Keyword Anomaly Scoring
In-Reply-To: <CC2EDFA7.3FAEA%scanell@jpl.nasa.gov>
Message-ID: <CC2F115A.56BDE%rbarnett@trustwave.com>


From: "Canell, Stephen E (2240)" <stephen.e.canell at jpl.nasa.gov<mailto:stephen.e.canell at jpl.nasa.gov>>
Date: Fri, 20 Jul 2012 12:13:22 -0500
To: "owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>" <owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>>
Subject: [Owasp-modsecurity-core-rule-set] SQL Keyword Anomaly Scoring


#
# SQL Keyword Anomaly Scoring:

I am having issues fine tuning all SQL rules for a COTS product.  This relates to the ID 981301 - 981316 with 981317.
I get a 403 from 918317 related to the previous SecRules because of the keyword count trigger.
Would the keyword in 301-316 be triggered by variables names having SQL keywords in the var name, such as:
 "search.selectedJobFamily.value" (981301 - select)

Also,
 I have two variables where users can enter an entire resume, so most, if not all of the SQL keywords in the SQL rules 301-316 will get hit!

I have seen the use SecRuleUpdateById in conjunction of !ARGS:<var> used, but 301-316 uses TX:SQLI?.. How do I use the SecRuleUpdateById with TX vs ARGS, and or
what is the best way to allow all words for these two variables and not set off the SQL triggers.

Thank you
Steve

Steve,
If you don't want these SQL keyword checks to search ARGS_NAMES collection at all, you can use this -

SecRuleUpdateTargetsById 981300 "!ARGS_NAMES"

Optionally, you can specify the individual ARGS_NAMES variables that are causing false positives -

SecRuleUpdateTargetsById 981300 "!ARGS_NAMES:search.selectedJobFamily.value"

-Ryan

________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120720/1752bcb3/attachment.html>

From stephen.e.canell at jpl.nasa.gov  Fri Jul 20 18:02:16 2012
From: stephen.e.canell at jpl.nasa.gov (Canell, Stephen E (2240))
Date: Fri, 20 Jul 2012 18:02:16 +0000
Subject: [Owasp-modsecurity-core-rule-set] SQL Keyword Anomaly Scoring
In-Reply-To: <CC2F115A.56BDE%rbarnett@trustwave.com>
Message-ID: <CC2EEADE.3FB06%scanell@jpl.nasa.gov>

Ryan,
So what you are saying is that the var names will trigger these rules.

I'll give that a whirl!

Thank you for the response.

-=Steve
From: Ryan Barnett <RBarnett at trustwave.com<mailto:RBarnett at trustwave.com>>
Date: Friday, July 20, 2012 10:48 AM
To: Stephen Canell <Stephen.E.Canell at jpl.nasa.gov<mailto:Stephen.E.Canell at jpl.nasa.gov>>, "owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>" <owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>>
Subject: Re: [Owasp-modsecurity-core-rule-set] SQL Keyword Anomaly Scoring


From: "Canell, Stephen E (2240)" <stephen.e.canell at jpl.nasa.gov<mailto:stephen.e.canell at jpl.nasa.gov>>
Date: Fri, 20 Jul 2012 12:13:22 -0500
To: "owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>" <owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>>
Subject: [Owasp-modsecurity-core-rule-set] SQL Keyword Anomaly Scoring


#
# SQL Keyword Anomaly Scoring:

I am having issues fine tuning all SQL rules for a COTS product.  This relates to the ID 981301 - 981316 with 981317.
I get a 403 from 918317 related to the previous SecRules because of the keyword count trigger.
Would the keyword in 301-316 be triggered by variables names having SQL keywords in the var name, such as:
 "search.selectedJobFamily.value" (981301 - select)

Also,
 I have two variables where users can enter an entire resume, so most, if not all of the SQL keywords in the SQL rules 301-316 will get hit!

I have seen the use SecRuleUpdateById in conjunction of !ARGS:<var> used, but 301-316 uses TX:SQLI?.. How do I use the SecRuleUpdateById with TX vs ARGS, and or
what is the best way to allow all words for these two variables and not set off the SQL triggers.

Thank you
Steve

Steve,
If you don't want these SQL keyword checks to search ARGS_NAMES collection at all, you can use this -

SecRuleUpdateTargetsById 981300 "!ARGS_NAMES"

Optionally, you can specify the individual ARGS_NAMES variables that are causing false positives -

SecRuleUpdateTargetsById 981300 "!ARGS_NAMES:search.selectedJobFamily.value"

-Ryan

________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120720/c4812ae9/attachment-0001.html>

From dyioulos at onpointfc.com  Fri Jul 20 18:04:25 2012
From: dyioulos at onpointfc.com (Dimitri Yioulos)
Date: Fri, 20 Jul 2012 14:04:25 -0400
Subject: [Owasp-modsecurity-core-rule-set] IIS version
Message-ID: <201207201404.26232.dyioulos@onpointfc.com>

Recently, we had to switch Web servers from Apache on Linux to Internet 
Information Server (not a popular decision, but a necessary one).  On the 
Apache system, we'd been running mod_sec successfully for a long time.  I note 
that a version for IIS is planned.  Any idea when that might see the light of 
day?

Dimitri

-- 
This message has been scanned for viruses and
dangerous content by MailScanner, and is
believed to be clean.


From RBarnett at trustwave.com  Fri Jul 20 18:06:34 2012
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Fri, 20 Jul 2012 13:06:34 -0500
Subject: [Owasp-modsecurity-core-rule-set] SQL Keyword Anomaly Scoring
In-Reply-To: <CC2EEADE.3FB06%scanell@jpl.nasa.gov>
Message-ID: <CC2F15B8.56BEE%rbarnett@trustwave.com>



From: "Canell, Stephen E (2240)" <stephen.e.canell at jpl.nasa.gov<mailto:stephen.e.canell at jpl.nasa.gov>>
Date: Fri, 20 Jul 2012 13:02:16 -0500
To: Ryan Barnett <rbarnett at trustwave.com<mailto:rbarnett at trustwave.com>>, "Canell, Stephen E (2240)" <stephen.e.canell at jpl.nasa.gov<mailto:stephen.e.canell at jpl.nasa.gov>>, "owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>" <owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>>
Subject: Re: [Owasp-modsecurity-core-rule-set] SQL Keyword Anomaly Scoring

Ryan,
So what you are saying is that the var names will trigger these rules.

I'll give that a whirl!

Thank you for the response.

Yes, these rule work by first checking various TARGETS for possible SQLi keywords (ARGS_NAMES is one of the var collections checked)-

SecRule REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_FILENAME|ARGS_NAMES|ARGS|XML:/* "@pm select show top distinct from dual where group by order having limit offset union rownum as (case" "phase:2,id:'981300',t:none,t:urlDecodeUni,t:lowercase,nolog,pass,nolog,setvar:'tx.sqli_select_statement=%{tx.sqli_select_statement} %{matched_var}'"

If there is a match, that data is appended to the TX.SQLI_SELECT_STATEMENT value which is then checked against the other individual rules and anomaly scores are then increases.

The final rule in this group simply checks to see if there are 3 or more SQLi keyword matches within the TX value.

-Ryan



-=Steve
From: Ryan Barnett <RBarnett at trustwave.com<mailto:RBarnett at trustwave.com>>
Date: Friday, July 20, 2012 10:48 AM
To: Stephen Canell <Stephen.E.Canell at jpl.nasa.gov<mailto:Stephen.E.Canell at jpl.nasa.gov>>, "owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>" <owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>>
Subject: Re: [Owasp-modsecurity-core-rule-set] SQL Keyword Anomaly Scoring


From: "Canell, Stephen E (2240)" <stephen.e.canell at jpl.nasa.gov<mailto:stephen.e.canell at jpl.nasa.gov>>
Date: Fri, 20 Jul 2012 12:13:22 -0500
To: "owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>" <owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>>
Subject: [Owasp-modsecurity-core-rule-set] SQL Keyword Anomaly Scoring


#
# SQL Keyword Anomaly Scoring:

I am having issues fine tuning all SQL rules for a COTS product.  This relates to the ID 981301 - 981316 with 981317.
I get a 403 from 918317 related to the previous SecRules because of the keyword count trigger.
Would the keyword in 301-316 be triggered by variables names having SQL keywords in the var name, such as:
 "search.selectedJobFamily.value" (981301 - select)

Also,
 I have two variables where users can enter an entire resume, so most, if not all of the SQL keywords in the SQL rules 301-316 will get hit!

I have seen the use SecRuleUpdateById in conjunction of !ARGS:<var> used, but 301-316 uses TX:SQLI?.. How do I use the SecRuleUpdateById with TX vs ARGS, and or
what is the best way to allow all words for these two variables and not set off the SQL triggers.

Thank you
Steve

Steve,
If you don't want these SQL keyword checks to search ARGS_NAMES collection at all, you can use this -

SecRuleUpdateTargetsById 981300 "!ARGS_NAMES"

Optionally, you can specify the individual ARGS_NAMES variables that are causing false positives -

SecRuleUpdateTargetsById 981300 "!ARGS_NAMES:search.selectedJobFamily.value"

-Ryan

________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.

________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120720/8b38955b/attachment.html>

From RBarnett at trustwave.com  Fri Jul 20 18:11:16 2012
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Fri, 20 Jul 2012 13:11:16 -0500
Subject: [Owasp-modsecurity-core-rule-set] IIS version
In-Reply-To: <201207201404.26232.dyioulos@onpointfc.com>
Message-ID: <CC2F170D.56BF9%rbarnett@trustwave.com>

We are releasing it next week on Wednesday, July 25th as part of our talk
at Blackhat USA -
https://www.blackhat.com/html/bh-us-12/bh-us-12-briefings.html#Wroblewski

The code will be open source licensed and available in the SourceForge
code repo.  ModSecurity of IIS will also have a standard MSI installer
package.

-Ryan





On 7/20/12 2:04 PM, "Dimitri Yioulos" <dyioulos at onpointfc.com> wrote:

>Recently, we had to switch Web servers from Apache on Linux to Internet
>Information Server (not a popular decision, but a necessary one).  On the
>Apache system, we'd been running mod_sec successfully for a long time.  I
>note
>that a version for IIS is planned.  Any idea when that might see the
>light of
>day?
>
>Dimitri
>
>--
>This message has been scanned for viruses and
>dangerous content by MailScanner, and is
>believed to be clean.
>
>_______________________________________________
>Owasp-modsecurity-core-rule-set mailing list
>Owasp-modsecurity-core-rule-set at lists.owasp.org
>https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>


This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.


From dyioulos at onpointfc.com  Fri Jul 20 18:15:02 2012
From: dyioulos at onpointfc.com (Dimitri Yioulos)
Date: Fri, 20 Jul 2012 14:15:02 -0400
Subject: [Owasp-modsecurity-core-rule-set] IIS version
In-Reply-To: <CC2F170D.56BF9%rbarnett@trustwave.com>
References: <CC2F170D.56BF9%rbarnett@trustwave.com>
Message-ID: <201207201415.02496.dyioulos@onpointfc.com>

Great news!  Thanks, Ryan.

Dimitri


On Friday 20 July 2012 2:11:16 pm Ryan Barnett wrote:
> We are releasing it next week on Wednesday, July 25th as part of our talk
> at Blackhat USA -
> https://www.blackhat.com/html/bh-us-12/bh-us-12-briefings.html#Wroblewski
>
> The code will be open source licensed and available in the SourceForge
> code repo.  ModSecurity of IIS will also have a standard MSI installer
> package.
>
> -Ryan
>
> On 7/20/12 2:04 PM, "Dimitri Yioulos" <dyioulos at onpointfc.com> wrote:
> >Recently, we had to switch Web servers from Apache on Linux to Internet
> >Information Server (not a popular decision, but a necessary one).  On the
> >Apache system, we'd been running mod_sec successfully for a long time.  I
> >note
> >that a version for IIS is planned.  Any idea when that might see the
> >light of
> >day?
> >
> >Dimitri
> >
> >--
> >This message has been scanned for viruses and
> >dangerous content by MailScanner, and is
> >believed to be clean.
> >
> >_______________________________________________
> >Owasp-modsecurity-core-rule-set mailing list
> >Owasp-modsecurity-core-rule-set at lists.owasp.org
> >https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>
> This transmission may contain information that is privileged, confidential,
> and/or exempt from disclosure under applicable law. If you are not the
> intended recipient, you are hereby notified that any disclosure, copying,
> distribution, or use of the information contained herein (including any
> reliance thereon) is STRICTLY PROHIBITED. If you received this transmission
> in error, please immediately contact the sender and destroy the material in
> its entirety, whether in electronic or hard copy format.



-- 
This message has been scanned for viruses and
dangerous content by MailScanner, and is
believed to be clean.


From stephen.e.canell at jpl.nasa.gov  Fri Jul 20 18:16:13 2012
From: stephen.e.canell at jpl.nasa.gov (Canell, Stephen E (2240))
Date: Fri, 20 Jul 2012 18:16:13 +0000
Subject: [Owasp-modsecurity-core-rule-set] SQL Keyword Anomaly Scoring
In-Reply-To: <CC2F15B8.56BEE%rbarnett@trustwave.com>
Message-ID: <CC2EEE4E.3FB0F%scanell@jpl.nasa.gov>

Beautiful Ryan,
That worked perfectly for the individual var names.

-=Steve

From: Ryan Barnett <RBarnett at trustwave.com<mailto:RBarnett at trustwave.com>>
Date: Friday, July 20, 2012 11:06 AM
To: Stephen Canell <Stephen.E.Canell at jpl.nasa.gov<mailto:Stephen.E.Canell at jpl.nasa.gov>>, "owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>" <owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>>
Subject: Re: [Owasp-modsecurity-core-rule-set] SQL Keyword Anomaly Scoring



From: "Canell, Stephen E (2240)" <stephen.e.canell at jpl.nasa.gov<mailto:stephen.e.canell at jpl.nasa.gov>>
Date: Fri, 20 Jul 2012 13:02:16 -0500
To: Ryan Barnett <rbarnett at trustwave.com<mailto:rbarnett at trustwave.com>>, "Canell, Stephen E (2240)" <stephen.e.canell at jpl.nasa.gov<mailto:stephen.e.canell at jpl.nasa.gov>>, "owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>" <owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>>
Subject: Re: [Owasp-modsecurity-core-rule-set] SQL Keyword Anomaly Scoring

Ryan,
So what you are saying is that the var names will trigger these rules.

I'll give that a whirl!

Thank you for the response.

Yes, these rule work by first checking various TARGETS for possible SQLi keywords (ARGS_NAMES is one of the var collections checked)-

SecRule REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_FILENAME|ARGS_NAMES|ARGS|XML:/* "@pm select show top distinct from dual where group by order having limit offset union rownum as (case" "phase:2,id:'981300',t:none,t:urlDecodeUni,t:lowercase,nolog,pass,nolog,setvar:'tx.sqli_select_statement=%{tx.sqli_select_statement} %{matched_var}'"

If there is a match, that data is appended to the TX.SQLI_SELECT_STATEMENT value which is then checked against the other individual rules and anomaly scores are then increases.

The final rule in this group simply checks to see if there are 3 or more SQLi keyword matches within the TX value.

-Ryan



-=Steve
From: Ryan Barnett <RBarnett at trustwave.com<mailto:RBarnett at trustwave.com>>
Date: Friday, July 20, 2012 10:48 AM
To: Stephen Canell <Stephen.E.Canell at jpl.nasa.gov<mailto:Stephen.E.Canell at jpl.nasa.gov>>, "owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>" <owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>>
Subject: Re: [Owasp-modsecurity-core-rule-set] SQL Keyword Anomaly Scoring


From: "Canell, Stephen E (2240)" <stephen.e.canell at jpl.nasa.gov<mailto:stephen.e.canell at jpl.nasa.gov>>
Date: Fri, 20 Jul 2012 12:13:22 -0500
To: "owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>" <owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>>
Subject: [Owasp-modsecurity-core-rule-set] SQL Keyword Anomaly Scoring


#
# SQL Keyword Anomaly Scoring:

I am having issues fine tuning all SQL rules for a COTS product.  This relates to the ID 981301 - 981316 with 981317.
I get a 403 from 918317 related to the previous SecRules because of the keyword count trigger.
Would the keyword in 301-316 be triggered by variables names having SQL keywords in the var name, such as:
 "search.selectedJobFamily.value" (981301 - select)

Also,
 I have two variables where users can enter an entire resume, so most, if not all of the SQL keywords in the SQL rules 301-316 will get hit!

I have seen the use SecRuleUpdateById in conjunction of !ARGS:<var> used, but 301-316 uses TX:SQLI?.. How do I use the SecRuleUpdateById with TX vs ARGS, and or
what is the best way to allow all words for these two variables and not set off the SQL triggers.

Thank you
Steve

Steve,
If you don't want these SQL keyword checks to search ARGS_NAMES collection at all, you can use this -

SecRuleUpdateTargetsById 981300 "!ARGS_NAMES"

Optionally, you can specify the individual ARGS_NAMES variables that are causing false positives -

SecRuleUpdateTargetsById 981300 "!ARGS_NAMES:search.selectedJobFamily.value"

-Ryan

________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.

________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120720/9d36e3ac/attachment.html>

From ivakili at yahoo.com  Tue Jul 24 10:16:20 2012
From: ivakili at yahoo.com (Iman Vakili)
Date: Tue, 24 Jul 2012 03:16:20 -0700 (PDT)
Subject: [Owasp-modsecurity-core-rule-set] crs_50_outbound
Message-ID: <1343124980.53647.YahooMailNeo@web141202.mail.bf1.yahoo.com>

Hi,

I have false positive on rule id: 970902, from ?crs_50_outbound
The scenario is when someone is crawling in the websites, first can visit particular pages but after going to other links and then wants to come back to the same page, then the rule will activate,
it is information leakage rule, does anyone change the rule?
I wonder is there any document to explain the rule reason or the kind of attacks they can prevent?

Thanks,?
Best regards

~Iman Vakili
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120724/e2cace33/attachment.html>

From yersinia.spiros at gmail.com  Tue Jul 24 11:58:32 2012
From: yersinia.spiros at gmail.com (yersinia)
Date: Tue, 24 Jul 2012 13:58:32 +0200
Subject: [Owasp-modsecurity-core-rule-set] crs_50_outbound
In-Reply-To: <1343124980.53647.YahooMailNeo@web141202.mail.bf1.yahoo.com>
References: <1343124980.53647.YahooMailNeo@web141202.mail.bf1.yahoo.com>
Message-ID: <CAH5b-BX4haSmGYK7Su8DjxTUXz_+wq-jp0A02dNaz2BWcfRvtA@mail.gmail.com>

On Tue, Jul 24, 2012 at 12:16 PM, Iman Vakili <ivakili at yahoo.com> wrote:

> Hi,
>
> I have false positive on rule id: 970902, from  crs_50_outbound
> The scenario is when someone is crawling in the websites, first can visit
> particular pages but after going to other links and then wants to come back
> to the same page, then the rule will activate,
> it is information leakage rule, does anyone change the rule?
> I wonder is there any document to explain the rule reason or the kind of
> attacks they can prevent?
>
Difficult to help if you don't post some audit log.

>
> Thanks,
> Best regards
>
> ~Iman Vakili
>
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120724/279f0727/attachment.html>

From yersinia.spiros at gmail.com  Tue Jul 24 14:13:53 2012
From: yersinia.spiros at gmail.com (yersinia)
Date: Tue, 24 Jul 2012 16:13:53 +0200
Subject: [Owasp-modsecurity-core-rule-set] WAFSEC 1.0 evaluation matrix for
	mod_security
Message-ID: <CAH5b-BVUeURxyhJ=A0=fWK6STDQcQbGC4PaHB-yzVOQkK2JHtA@mail.gmail.com>

Hi

Some time ago i promised (thanks to christian folini for his request)

to publish on this list the WAFSEC 1.0 evaluation matrix for mod_security
that I had made some time ago. It is here:


https://docs.google.com/document/d/1X_A2G0TMB9IHoZnnpnFBHz_yZ5gkykfL6mtuWMdjzCo/edit




My evaluation work is based on using mod_security, together with the REMO
policy engine and the jwall audit console.


Comments are welcome. Moreover, if it might be worthwhile, I give right now to
mod_security developers the rights to publish this the document, all or in
part, on the project web site, eventually  integrated and corrected.



I hope this document could be useful to someone, and not so wrong in the
content.



Best Regards


Elia
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120724/de324861/attachment.html>

From ivakili at yahoo.com  Thu Jul 26 08:40:38 2012
From: ivakili at yahoo.com (Iman Vakili)
Date: Thu, 26 Jul 2012 01:40:38 -0700 (PDT)
Subject: [Owasp-modsecurity-core-rule-set] False Positive
Message-ID: <1343292038.97525.YahooMailNeo@web141201.mail.bf1.yahoo.com>

Hi,

There is a?high?false positive from phpids rules in SQL_injection section, especially rule id 981243, 981244, 981248
For example if we have a "div" expression almost everywhere in pahse 2, these rules will trigger,?
is there any change to these rules?

Thanks & Best regards

~IMAN
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120726/1cffce02/attachment.html>

From PNair at barclaycardus.com  Thu Jul 26 17:44:12 2012
From: PNair at barclaycardus.com (Nair, Praveen)
Date: Thu, 26 Jul 2012 17:44:12 +0000
Subject: [Owasp-modsecurity-core-rule-set] Please Help: ModSecurity: Failed
 to access DBM file "/cust/logs/audit/global": Permission denied
Message-ID: <2D8620FFA11CD047B8E51A5ECE45A77508388FB5@PMEXGMB01.juniper.com>

I would appreciate if you can provide some guidance to resolve this error in configuring Modsecurity. Appreciate if you can help

[Thu Jul 26 14:45:23 2012] [error] [client 10.0.150.226] ModSecurity: Failed to access DBM file "/cust/logs/audit/global": Permission denied [hostname "vdwb2165a"] [uri "/inservice.html"] [unique_id "UBFYAwp at ChYAAGq0HZkAAAAE"]

Our httpd.conf file looks like:

<IfModule mod_security2.c>
        Include /cust/apache2.2/crs/*.conf
        Include /cust/apache2.2/crs/base_rules/*.conf
        # mod_security audit logging use only one log file for the entrire apache server
        SecAuditEngine On
        SecAuditLogRelevantStatus "^(?:5|4(?!04))"
        SecAuditLogParts ABIFEHZ
        SecAuditLogType Serial
        # Rotate the audit logs every 6 hours
        SecAuditLog "|/cust/apache2.2/bin/rotatelogs /cust/logs/audit/cif_sec_log.%Y%m%d%H%M 21600"
        SecDataDir /cust/logs/audit
        SecTmpDir /cust/logs/audit
        SecPcreMatchLimit 1000000
        SecPcreMatchLimitRecursion 1000000
</IfModule>


With Best Regards,

Praveen Nair, CISSP, CISM, CRISC
IT Security Consultant
Security Risk & Engagement
Global Information Security
GISTR
125 S West Street
Wilmington, DE 19801, USA
Phone:  +1 302 255 7906
Mobile: +1 302 547 1742
Email: pnair at barclaycardus.com<mailto:pnair at barclaycardus.com>
Company Confidential



Barclaycard
www.barclaycardus.com 

This email and any files transmitted with it may contain confidential and/or proprietary information. It is intended solely for the use of the individual or entity who is the intended recipient. Unauthorized use of this information is prohibited. If you have received this in error, please contact the sender by replying to this message and delete this material from any system it may be on.

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120726/c04eeccf/attachment.html>

From yersinia.spiros at gmail.com  Thu Jul 26 18:22:26 2012
From: yersinia.spiros at gmail.com (yersinia)
Date: Thu, 26 Jul 2012 20:22:26 +0200
Subject: [Owasp-modsecurity-core-rule-set] Please Help: ModSecurity:
 Failed to access DBM file "/cust/logs/audit/global": Permission denied
In-Reply-To: <2D8620FFA11CD047B8E51A5ECE45A77508388FB5@PMEXGMB01.juniper.com>
References: <2D8620FFA11CD047B8E51A5ECE45A77508388FB5@PMEXGMB01.juniper.com>
Message-ID: <CAH5b-BX1xCp+uN6h8b9PU6-VEqJgfK8kej_n-KNGCrPYQ9-TZg@mail.gmail.com>

Could  be useful to know something more about your env - operating
system, mod security version and if apache is operating under some mac
system as apparmour or selinux for example.

Best regards

2012/7/26, Nair, Praveen <PNair at barclaycardus.com>:
> I would appreciate if you can provide some guidance to resolve this error in
> configuring Modsecurity. Appreciate if you can help
>
> [Thu Jul 26 14:45:23 2012] [error] [client 10.0.150.226] ModSecurity: Failed
> to access DBM file "/cust/logs/audit/global": Permission denied [hostname
> "vdwb2165a"] [uri "/inservice.html"] [unique_id "UBFYAwp at ChYAAGq0HZkAAAAE"]
>
> Our httpd.conf file looks like:
>
> <IfModule mod_security2.c>
>         Include /cust/apache2.2/crs/*.conf
>         Include /cust/apache2.2/crs/base_rules/*.conf
>         # mod_security audit logging use only one log file for the entrire
> apache server
>         SecAuditEngine On
>         SecAuditLogRelevantStatus "^(?:5|4(?!04))"
>         SecAuditLogParts ABIFEHZ
>         SecAuditLogType Serial
>         # Rotate the audit logs every 6 hours
>         SecAuditLog "|/cust/apache2.2/bin/rotatelogs
> /cust/logs/audit/cif_sec_log.%Y%m%d%H%M 21600"
>         SecDataDir /cust/logs/audit
>         SecTmpDir /cust/logs/audit
>         SecPcreMatchLimit 1000000
>         SecPcreMatchLimitRecursion 1000000
> </IfModule>
>
>
> With Best Regards,
>
> Praveen Nair, CISSP, CISM, CRISC
> IT Security Consultant
> Security Risk & Engagement
> Global Information Security
> GISTR
> 125 S West Street
> Wilmington, DE 19801, USA
> Phone:  +1 302 255 7906
> Mobile: +1 302 547 1742
> Email: pnair at barclaycardus.com<mailto:pnair at barclaycardus.com>
> Company Confidential
>
>
>
> Barclaycard
> www.barclaycardus.com
>
> This email and any files transmitted with it may contain confidential and/or
> proprietary information. It is intended solely for the use of the individual
> or entity who is the intended recipient. Unauthorized use of this
> information is prohibited. If you have received this in error, please
> contact the sender by replying to this message and delete this material from
> any system it may be on.
>
>

-- 
Inviato dal mio dispositivo mobile

From PNair at barclaycardus.com  Thu Jul 26 18:49:29 2012
From: PNair at barclaycardus.com (Nair, Praveen)
Date: Thu, 26 Jul 2012 18:49:29 +0000
Subject: [Owasp-modsecurity-core-rule-set] Please Help: ModSecurity:
 Failed to access DBM file "/cust/logs/audit/global": Permission denied
In-Reply-To: <CAH5b-BX1xCp+uN6h8b9PU6-VEqJgfK8kej_n-KNGCrPYQ9-TZg@mail.gmail.com>
References: <2D8620FFA11CD047B8E51A5ECE45A77508388FB5@PMEXGMB01.juniper.com>
	<CAH5b-BX1xCp+uN6h8b9PU6-VEqJgfK8kej_n-KNGCrPYQ9-TZg@mail.gmail.com>
Message-ID: <2D8620FFA11CD047B8E51A5ECE45A77508389063@PMEXGMB01.juniper.com>

Yersinia,

We are on Apache 2.2.22 and Modsecurity 2.6.3. 



-----Original Message-----
From: pinto.elia at gmail.com [mailto:pinto.elia at gmail.com] On Behalf Of yersinia
Sent: Thursday, July 26, 2012 2:22 PM
To: Nair, Praveen; owasp-modsecurity-core-rule-set at lists.owasp.org
Subject: Re: [Owasp-modsecurity-core-rule-set] Please Help: ModSecurity: Failed to access DBM file "/cust/logs/audit/global": Permission denied

Could  be useful to know something more about your env - operating system, mod security version and if apache is operating under some mac system as apparmour or selinux for example.

Best regards

2012/7/26, Nair, Praveen <PNair at barclaycardus.com>:
> I would appreciate if you can provide some guidance to resolve this 
> error in configuring Modsecurity. Appreciate if you can help
>
> [Thu Jul 26 14:45:23 2012] [error] [client 10.0.150.226] ModSecurity: 
> Failed to access DBM file "/cust/logs/audit/global": Permission denied 
> [hostname "vdwb2165a"] [uri "/inservice.html"] [unique_id 
> "UBFYAwp at ChYAAGq0HZkAAAAE"]
>
> Our httpd.conf file looks like:
>
> <IfModule mod_security2.c>
>         Include /cust/apache2.2/crs/*.conf
>         Include /cust/apache2.2/crs/base_rules/*.conf
>         # mod_security audit logging use only one log file for the 
> entrire apache server
>         SecAuditEngine On
>         SecAuditLogRelevantStatus "^(?:5|4(?!04))"
>         SecAuditLogParts ABIFEHZ
>         SecAuditLogType Serial
>         # Rotate the audit logs every 6 hours
>         SecAuditLog "|/cust/apache2.2/bin/rotatelogs 
> /cust/logs/audit/cif_sec_log.%Y%m%d%H%M 21600"
>         SecDataDir /cust/logs/audit
>         SecTmpDir /cust/logs/audit
>         SecPcreMatchLimit 1000000
>         SecPcreMatchLimitRecursion 1000000 </IfModule>
>
>
> With Best Regards,
>
> Praveen Nair, CISSP, CISM, CRISC
> IT Security Consultant
> Security Risk & Engagement
> Global Information Security
> GISTR
> 125 S West Street
> Wilmington, DE 19801, USA
> Phone:  +1 302 255 7906
> Mobile: +1 302 547 1742
> Email: pnair at barclaycardus.com<mailto:pnair at barclaycardus.com>
> Company Confidential
>
>
>
> Barclaycard
> www.barclaycardus.com
>
> This email and any files transmitted with it may contain confidential 
> and/or proprietary information. It is intended solely for the use of 
> the individual or entity who is the intended recipient. Unauthorized 
> use of this information is prohibited. If you have received this in 
> error, please contact the sender by replying to this message and 
> delete this material from any system it may be on.
>
>

--
Inviato dal mio dispositivo mobile



Barclaycard
www.barclaycardus.com 

This email and any files transmitted with it may contain confidential and/or proprietary information. It is intended solely for the use of the individual or entity who is the intended recipient. Unauthorized use of this information is prohibited. If you have received this in error, please contact the sender by replying to this message and delete this material from any system it may be on.



From PNair at barclaycardus.com  Mon Jul 30 13:17:20 2012
From: PNair at barclaycardus.com (Nair, Praveen)
Date: Mon, 30 Jul 2012 13:17:20 +0000
Subject: [Owasp-modsecurity-core-rule-set] Please Help: ModSecurity:
 Failed to access DBM file "/cust/logs/audit/global": Permission denied
In-Reply-To: <2D8620FFA11CD047B8E51A5ECE45A77508389063@PMEXGMB01.juniper.com>
References: <2D8620FFA11CD047B8E51A5ECE45A77508388FB5@PMEXGMB01.juniper.com>
	<CAH5b-BX1xCp+uN6h8b9PU6-VEqJgfK8kej_n-KNGCrPYQ9-TZg@mail.gmail.com>
	<2D8620FFA11CD047B8E51A5ECE45A77508389063@PMEXGMB01.juniper.com>
Message-ID: <2D8620FFA11CD047B8E51A5ECE45A775083968BD@PMEXGMB01.juniper.com>

All,

It turned out to be that the Group permission should have read and write access to /cust/logs/audit directory. The Apache was running with non-root and we added the group permission to this folder and now it is working.

With Best Regards,

Praveen Nair, CISSP, CISM, CRISC
IT Security Consultant 

-----Original Message-----
From: Nair, Praveen 
Sent: Thursday, July 26, 2012 2:49 PM
To: 'yersinia'; owasp-modsecurity-core-rule-set at lists.owasp.org
Subject: RE: [Owasp-modsecurity-core-rule-set] Please Help: ModSecurity: Failed to access DBM file "/cust/logs/audit/global": Permission denied

Yersinia,

We are on Apache 2.2.22 and Modsecurity 2.6.3. 




Barclaycard
www.barclaycardus.com 

This email and any files transmitted with it may contain confidential and/or proprietary information. It is intended solely for the use of the individual or entity who is the intended recipient. Unauthorized use of this information is prohibited. If you have received this in error, please contact the sender by replying to this message and delete this material from any system it may be on.



