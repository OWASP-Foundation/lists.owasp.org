<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Question about RBL Match for	SPAM Source Rule
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20Question%20about%20RBL%20Match%20for%0A%09SPAM%20Source%20Rule&In-Reply-To=869a38360912082357h5b5d43bdm20cafd448314efdc%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000190.html">
   <LINK REL="Next"  HREF="000192.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Question about RBL Match for	SPAM Source Rule</H1>
    <B>Ryan Barnett</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20Question%20about%20RBL%20Match%20for%0A%09SPAM%20Source%20Rule&In-Reply-To=869a38360912082357h5b5d43bdm20cafd448314efdc%40mail.gmail.com"
       TITLE="[Owasp-modsecurity-core-rule-set] Question about RBL Match for	SPAM Source Rule">ryan.barnett at breach.com
       </A><BR>
    <I>Wed Dec  9 10:46:09 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="000190.html">[Owasp-modsecurity-core-rule-set] Question about RBL Match for SPAM	Source Rule
</A></li>
        <LI>Next message: <A HREF="000192.html">[Owasp-modsecurity-core-rule-set] Question about RBL Match for SPAM	Source Rule
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#191">[ date ]</a>
              <a href="thread.html#191">[ thread ]</a>
              <a href="subject.html#191">[ subject ]</a>
              <a href="author.html#191">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wednesday 09 December 2009 02:57:15 am OSSEC junkie wrote:
&gt;<i> All:
</I>&gt;<i> 
</I>&gt;<i> I am testing out this rule in our environment and wondered if this
</I>&gt;<i> rule is a simple add into the /base_rules folder then restart Apache
</I>&gt;<i> for this rule to take affect?  
</I>
One option would be to simply include the modsecurity_42_comment_spam.conf file 
in you apache config and comment out the other rules in that file that you don't 
want to run.

&gt;<i> I removed the block action right now so
</I>&gt;<i> I can gauge the traffic going through and operate in a pass-through
</I>&gt;<i> type of configuration but have yet to see any sort of RBL action in
</I>&gt;<i> the logs.  Any ideas?  I know we get lots of activity from IP
</I>&gt;<i> Addresses that are known bad according to spamhaus.
</I>&gt;<i> 
</I>&gt;<i> SecRule &amp;IP:SPAMMER &quot;@eq 0&quot;
</I>&gt;<i> &quot;chain,phase:1,t:none,block,nolog,auditlog,msg:'RBL Match for SPAM
</I>&gt;<i> Source',tag:'AUTOMATION/MALICIOUS',severity:'2',skipAfter:END_RBL_CHECK&quot;
</I>&gt;<i> 	SecRule REMOTE_ADDR &quot;@rbl sbl-xbl.spamhaus.org&quot; \
</I>&gt;<i>        
</I>&gt;<i>  &quot;t:none,setvar:'tx.msg=%{rule.msg}',setvar:tx.automation_score=+1,setvar:t
</I>&gt;<i> x.anomaly_score=+20,setvar:'tx.%{rule.id}=%{matched_var_name}=%{matched_var
</I>&gt;<i> }',setvar:ip.spammer=1,expirevar:ip.spammer=86400&quot;
</I>&gt;<i> 
</I>&gt;<i> SecRule IP:SPAMMER &quot;@eq 1&quot;
</I>&gt;<i> &quot;phase:1,t:none,block,nolog,auditlog,msg:'RBL Match for SPAM
</I>&gt;<i> Source',tag:'AUTOMATION/MALICIOUS',severity:'2',setvar:'tx.msg=%{rule.msg}'
</I>&gt;<i> ,setvar:tx.automation_score=+1,setvar:tx.anomaly_score=+20,setvar:'tx.%{rul
</I>&gt;<i> e.id}=%{matched_var_name}=%{matched_var}'&quot;
</I>&gt;<i> 
</I>&gt;<i> SecMarker END_RBL_CHECK
</I>&gt;<i> 
</I>&gt;<i> Thanks
</I>
There were a few changes needed for these RBL rules to work as intended.  They 
are fixed in the v2.0.5 update which will be released shortly.

1) The first issue that you seemed to be running into was related to the use of 
the skipAfter action being in the 1st line of a chained rule.  This action 
needed to be moved to the *last* line of the rule so that it would skip to the 
end of this section only *after* performing the RBL check.  This is a similar 
type of gotcha as with the ctl actions as they trigger based on the individual 
rule match and not the entire rule chain.

2) We needed to update the logic of the rules.  The idea was to try and 
minimize the amount of actual RBL checks that are executed (as the majority of 
traffic will be from non-spam sources).  So, we want to run an RBL check once 
per source IP per/day and save the results.  Here is an update ruleset for you 
to test -

SecRule IP:PREVIOUS_RBL_CHECK &quot;@eq 1&quot; 
&quot;phase:1,t:none,pass,nolog,skipAfter:END_RBL_LOOKUP&quot;
  SecRule REMOTE_ADDR &quot;@rbl sbl-xbl.spamhaus.org&quot; 
&quot;phase:1,t:none,block,nolog,auditlog,msg:'RBL Match for SPAM 
Source',tag:'AUTOMATION/MALICIOUS',severity:'2',setvar:'tx.msg=%{rule.msg}',setvar:tx.automation_score=+1,setvar:tx.anomaly_score=+20,setvar:tx.
%{rule.id}-
AUTOMATION/MALICIOUS-%{rule.severity}-%{rule.msg}-%{matched_var_name}=%{matched_var},setvar:ip.spammer=1,expirevar:ip.spammer=86400,setvar:ip.previous_rbl_check=1,expirevar:ip.previous_rbl_check=86400,skipAfter:END_RBL_CHECK&quot;

  SecAction 
&quot;phase:1.t:none,nolog,pass,setvar:ip.previous_rbl_check=1,expirevar:ip.previous_rbl_check=86400&quot;
SecMarker END_RBL_LOOKUP

SecRule IP:SPAMMER &quot;@eq 1&quot; &quot;phase:1,t:none,block,nolog,auditlog,msg:'Request 
from Known SPAM Source (Previous RBL 
Match)',tag:'AUTOMATION/MALICIOUS',severity:'2',setvar:'tx.msg=%{rule.msg}',setvar:tx.automation_score=+1,setvar:tx.anomaly_score=+20,setvar:tx.
%{rule.id}-
AUTOMATION/MALICIOUS-%{rule.severity}-%{rule.msg}-%{matched_var_name}=%{matched_var}&quot;

SecMarker END_RBL_CHECK


</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000190.html">[Owasp-modsecurity-core-rule-set] Question about RBL Match for SPAM	Source Rule
</A></li>
	<LI>Next message: <A HREF="000192.html">[Owasp-modsecurity-core-rule-set] Question about RBL Match for SPAM	Source Rule
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#191">[ date ]</a>
              <a href="thread.html#191">[ thread ]</a>
              <a href="subject.html#191">[ subject ]</a>
              <a href="author.html#191">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
