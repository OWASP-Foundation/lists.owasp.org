<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] An &quot;X-Forwarded-For&quot; header	attack?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20An%20%22X-Forwarded-For%22%20header%0A%09attack%3F&In-Reply-To=%3Calpine.LSU.2.20.1608211435510.2219%40schiller.dip.t-dialin.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002206.html">
   <LINK REL="Next"  HREF="002212.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] An &quot;X-Forwarded-For&quot; header	attack?</H1>
    <B>Jens Schleusener</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20An%20%22X-Forwarded-For%22%20header%0A%09attack%3F&In-Reply-To=%3Calpine.LSU.2.20.1608211435510.2219%40schiller.dip.t-dialin.net%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] An &quot;X-Forwarded-For&quot; header	attack?">Jens.Schleusener at t-online.de
       </A><BR>
    <I>Sun Aug 21 13:28:44 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="002206.html">[Owasp-modsecurity-core-rule-set] Initial report
</A></li>
        <LI>Next message: <A HREF="002212.html">[Owasp-modsecurity-core-rule-set] Backport HTTP Parameter Pollution	rule for CRSv2 Users
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2208">[ date ]</a>
              <a href="thread.html#2208">[ thread ]</a>
              <a href="subject.html#2208">[ subject ]</a>
              <a href="author.html#2208">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

some days ago I changed for some hours the behavior of a proxy server in 
front of an Apache httpd server so that an optional existing 
&quot;X-Forwarded-For&quot; header are no longer removed from the incoming requests.

And expeditiously I found in that period some few alarming log entries in 
the Apache access_log (written principally in &quot;combined&quot; log format) like

}__test|O:21:\&quot;JDatabaseDriverMysqli\&quot;:3:{s:4:\&quot;\\0\\0\\0a\&quot;;O:17:\&quot;JSimplepieFactory\&quot;:0:{}s:21:\&quot;\\0\\0\\0disconnectHandlers\&quot;;a:1:{i:0;a:2:{i:0;O:9:\&quot;SimplePie\&quot;:5:{s:8:\&quot;sanitize\&quot;;O:20:\&quot;JDatabaseDriverMysql\&quot;:0:{}s:5:\&quot;cache\&quot;;b:1;s:19:\&quot;cache_name_function\&quot;;s:6:\&quot;assert\&quot;;s:10:\&quot;javascript\&quot;;i:9999;s:8:\&quot;feed_url\&quot;;s:126:\&quot;eval(base64_decode('ZWNobyBiYXNlNjRfZGVjb2RlKCdRM2hEZUdwSFFrRnViMjVRYkhWelIzUjBWa2hrUlE9PScpOw=='));JFactory::getConfig();exit\&quot;;}i:1;s:4:\&quot;init\&quot;;}}s:13:\&quot;\\0\\0\\0connection\&quot;;i:1;}\xc3\xb0\xc3\xbd\xc3\xbd\xc3\xbd, 
151.8.xxx.yyy - - [18/Aug/2016:18:18:32 +0200] &quot;GET /index.php/ HTTP/1.1&quot; 500 - &quot;-&quot; &quot;}__test|O:21:\&quot;JDatabaseDriverMysqli\&quot;:3:{s:4:\&quot;\\0\\0\\0a\&quot;;O:17:\&quot;JSimplepieFactory\&quot;:0:{}s:21:\&quot;\\0\\0\\0disconnectHandlers\&quot;;a:1:{i:0;a:2:{i:0;O:9:\&quot;SimplePie\&quot;:5:{s:8:\&quot;sanitize\&quot;;O:20:\&quot;JDatabaseDriverMysql\&quot;:0:{}s:5:\&quot;cache\&quot;;b:1;s:19:\&quot;cache_name_function\&quot;;s:6:\&quot;assert\&quot;;s:10:\&quot;javascript\&quot;;i:9999;s:8:\&quot;feed_url\&quot;;s:126:\&quot;eval(base64_decode('ZWNobyBiYXNlNjRfZGVjb2RlKCdRM2hEZUdwSFFrRnViMjVRYkhWelIzUjBWa2hrUlE9PScpOw=='));JFactory::getConfig();exit\&quot;;}i:1;s:4:\&quot;init\&quot;;}}s:13:\&quot;\\0\\0\\0connection\&quot;;i:1;}\xc3\xb0\xc3\xbd\xc3\xbd\xc3\xbd&quot;

The log entry unexpectedly doesn't start with an IP but with a string 
identical to the odd (misused) User-Agent string separated by a comma and 
followed by an IP (the last two octets above was anonymized). So its looks 
similar as if multiple IPs are logged for e.g. in case of involved proxies 
with one or more IPs found in an optional existing &quot;X-Forwarded-For&quot; 
header.

And yes if the internal upstream proxy is involved on this server the log 
format used has the &quot;%h&quot; (IP address) replaced by &quot;%{X-Forwarded-For}i&quot; 
in order to log the requesting IP and not the known IP of the proxy. So I 
assume either the original sender had misused the &quot;X-Forwarded-For&quot; header 
field or one of the involved local instances had misinterpreted some 
header variables.

At first I wonder that the CRS3 rules didn't catch that suspicious string 
but maybe that is related to the status code 500 (&quot;internal error&quot;) so 
modsecurity wasn't correctly involved.

Naturally bad clients can add arbitrary &quot;X-Forwarded-For&quot; headers but 
normally they will probably be ignored respectively not logged so that 
they potential danger may be limited.

In REQUEST-933-APPLICATION-ATTACK-PHP.conf I found a related pointer to 
<A HREF="https://www.exploit-db.com/exploits/39033/">https://www.exploit-db.com/exploits/39033/</A> (X-Forwarded-For header) and a 
similar attack directly accessing the Apache server was successfully 
blocked by rule 933170 (&quot;PHP Injection Attack: Serialized Object 
Injection&quot;).

To be on the safe side I have now nevertheless extended also some rules in 
REQUEST-941-APPLICATION-ATTACK-XSS.conf (CRS3) by 
&quot;REQUEST_HEADERS:X-Forwarded-For&quot;.

But probably better it may be to create a new specific rule that checks 
&quot;X-Forwarded-For&quot; headers for acceptable respectively valid values. Here 
is a first raw idea assuming only IPv4 and IPv6 addresses are allowed in 
that header (not really tested, especially the IP address pattern is 
improvable):

SecRule &amp;REQUEST_HEADERS:X-Forwarded-For &quot;@eq 0&quot; \
  &quot;id:941900,\
   nolog,\
   pass,\
   t:none,\
   skip:1&quot;

SecRule REQUEST_HEADERS:X-Forwarded-For &quot;!@rx ^([1-9][0-9]{0,2}(\.[0-9]{1,3}){3}|[0-9a-f]{1,4}(:[0-9a-f]{0,4}){3,6}:[0-9a-f]{1,4})( 
{0,2}, {0,2}([1-9][0-9]{0,2}(\.[0-9]{1,3}){3}|[0-9a-f]{1,4}(:[0-9a-f]{0,4}){3,6}:[0-9a-f]{1,4})){0,9}$&quot; \
  &quot;id:941910,\
   log,\
   t:none,\
   block,\
   msg:'Forwarded-For header sanity check failed (not a valid list of IP addresses): %{REQUEST_HEADERS.X-Forwarded-For}'&quot;

Regards

Jens
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002206.html">[Owasp-modsecurity-core-rule-set] Initial report
</A></li>
	<LI>Next message: <A HREF="002212.html">[Owasp-modsecurity-core-rule-set] Backport HTTP Parameter Pollution	rule for CRSv2 Users
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2208">[ date ]</a>
              <a href="thread.html#2208">[ thread ]</a>
              <a href="subject.html#2208">[ subject ]</a>
              <a href="author.html#2208">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
