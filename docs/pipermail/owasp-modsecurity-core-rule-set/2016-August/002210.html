<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] CRS3-RC1 not working on	Apache 2.2
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20CRS3-RC1%20not%20working%20on%0A%09Apache%202.2&In-Reply-To=%3Calpine.LSU.2.20.1608221025490.5093%40schiller.dip.t-dialin.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002209.html">
   <LINK REL="Next"  HREF="002211.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] CRS3-RC1 not working on	Apache 2.2</H1>
    <B>Jens Schleusener</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20CRS3-RC1%20not%20working%20on%0A%09Apache%202.2&In-Reply-To=%3Calpine.LSU.2.20.1608221025490.5093%40schiller.dip.t-dialin.net%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] CRS3-RC1 not working on	Apache 2.2">Jens.Schleusener at t-online.de
       </A><BR>
    <I>Mon Aug 22 09:39:59 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="002209.html">[Owasp-modsecurity-core-rule-set] CRS3-RC1 not working on	Apache 2.2
</A></li>
        <LI>Next message: <A HREF="002211.html">[Owasp-modsecurity-core-rule-set] CRS3-RC1 not working on	Apache 2.2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2210">[ date ]</a>
              <a href="thread.html#2210">[ thread ]</a>
              <a href="subject.html#2210">[ subject ]</a>
              <a href="author.html#2210">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Christian,

&gt;<i> Good morning Jens,
</I>&gt;<i>
</I>&gt;<i> On Sun, Aug 21, 2016 at 12:48:32PM +0200, Jens Schleusener wrote:
</I>&gt;&gt;<i> One reason for the &quot;silence&quot; may be also the very laborious log file
</I>&gt;&gt;<i> analysis.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> But to get just a first impression I found your script aliases collection at
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  <A HREF="https://github.com/Apache-Labor/labor/blob/master/bin/.apache-modsec.alias">https://github.com/Apache-Labor/labor/blob/master/bin/.apache-modsec.alias</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> very useful.
</I>&gt;<i>
</I>&gt;<i> Thanks. I should probably cover them in a blogpost. Right now they seem
</I>&gt;<i> to be a bit of a secret to those who have read my (German) tutorials.
</I>&gt;<i>
</I>&gt;&gt;<i> On the server that I manage (httpd 2.4.23, modsecurity 2.9.1)
</I>&gt;&gt;<i> CRS3-RC1 is now for nearly a month in use and it works very well
</I>&gt;&gt;<i> (big thanks to the CRS3 team!).
</I>&gt;<i>
</I>&gt;<i> Glad it works!
</I>&gt;<i>
</I>&gt;&gt;<i> Although the server may be not
</I>&gt;&gt;<i> &quot;typical&quot; since it uses itself neither PHP nor SQL but offers
</I>&gt;&gt;<i> amongst others soure code browsing of FOSS software that contains
</I>&gt;&gt;<i> for e.g. PHP, SQL and HTML files here an example output for 5 days
</I>&gt;&gt;<i> (with roughly 200.000 page requests in total) using the script alias
</I>&gt;&gt;<i> &quot;melidmsg&quot; (entries fom some special self-written rules are
</I>&gt;&gt;<i> removed):
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> cat modsec_audit.log.16081[5-9] | melidmsg | sort | uniq -c | sort -nr
</I>&gt;<i>
</I>&gt;<i> I guess you are aware of the alias 'sucs' and use the sort-uniq-c-sort
</I>&gt;<i> combination here to make it more comprehensive for the other readers.
</I>
A &quot;small&quot; yes (but I wanted to reverse the sort order for this post) and
there is for e.g. also a related alias &quot;melmsgs&quot; in your collection that
does it all with a single command.

&gt;&gt;<i>     347 921140 HTTP Header Injection Attack via headers
</I>&gt;&gt;<i>     308 910000 Request from Known Malicious Client
</I>&gt;&gt;<i>                (Based on previous traffic violations).
</I>&gt;&gt;<i>     186 920350 Host header is a numeric IP address
</I>&gt;&gt;<i>     105 932130 Remote Command Execution: Unix Shell Expression Found
</I>&gt;&gt;<i> ...
</I>&gt;<i>
</I>&gt;<i> All in all, this is quite a big collection of alerts for 200K requests.
</I>&gt;<i> Your site is special of course, but would this special content really
</I>&gt;<i> affect the requests that much. Would not that be more a problem with
</I>&gt;<i> the responses?
</I>
Sure, for e.g. if valued as meaningful the server tries to display a 
requested HTML member file of an available software package in rendered 
format but that leads sometimes to the mentioned errors like

  105 932130 Remote Command Execution: Unix Shell Expression Found

if for e.g. that file includes stylesheets like

  ...common.css?_=${version}

But that was the case only for one member file of one package that caused 
all that 105 matches.

&gt;<i> There are a rules which point to a  real positive. But with many others,
</I>&gt;<i> we might face false positives. Did you investigate further, or do you
</I>&gt;<i> think they point to malign requests?
</I>
As said that is very laborious if there hundred of entries. Often one had 
to analyze additionally the big Apache access log to find out the further 
behaviour of an suspicious IP and classify the according requests as 
&quot;good&quot; or &quot;bad&quot;.

Helpful would be a general program or script that can grep blocks of lines 
given a main target pattern and two further patterns specifying the begin 
and the end of the block. I just write a very primitive one that allows 
for e.g. via

  grep_blocks_by_sed -p 'id &quot;921140&quot;' \
    -b '^--[0-9a-f]*-A--' -e '^--[0-9a-f]*-Z--' modsec_audit.log

to extract all matching blocks related to a special rule ID (the number 
of matches can be restricted by an option &quot;-n N&quot;) and filter them
appropriately further.

So I found now that the 347 entries

  347 921140 HTTP Header Injection Attack via headers

belongs all to a single IP (probably a proxy) that adds to the end of the
User-Agent header field a &quot;\x0d&quot;.

Also all the 59 entries

  59 920430 HTTP protocol version is not allowed by policy

are caused by a single client/bot (User-Agent: Java/1.6.0_04) that seems 
to have misinterpreted responses of previously requested URLs and 
requested now invalid URLs that the CRS3 rule seems to assign to the HTTP 
protocol version.

&gt;&gt;<i> Found&quot;) in some cases seems to cause FPs (especially for the
</I>&gt;&gt;<i> User-Agent &quot;Go-http-client/1.1&quot; that sends erroneously a
</I>&gt;&gt;<i> &quot;Connection: close, close&quot; HTTP header).
</I>&gt;<i>
</I>&gt;<i> Would you please be so kind and open an issue on the github site for
</I>&gt;<i> this false positive? Ideally including a full audit log entry for the
</I>&gt;<i> request.
</I>
Ok (but a little bit later).

Jens
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002209.html">[Owasp-modsecurity-core-rule-set] CRS3-RC1 not working on	Apache 2.2
</A></li>
	<LI>Next message: <A HREF="002211.html">[Owasp-modsecurity-core-rule-set] CRS3-RC1 not working on	Apache 2.2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2210">[ date ]</a>
              <a href="thread.html#2210">[ thread ]</a>
              <a href="subject.html#2210">[ subject ]</a>
              <a href="author.html#2210">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
