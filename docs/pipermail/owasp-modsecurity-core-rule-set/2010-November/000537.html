<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] WHY Rule &quot;950109&quot; matches for ARG &quot;passed_id=81&quot; ?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20WHY%20Rule%20%22950109%22%20matches%20for%0A%20ARG%20%22passed_id%3D81%22%20%3F&In-Reply-To=20101102161410.17410ou0hv5w0n2q%40webmail.axiomasoft.pt">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000536.html">
   <LINK REL="Next"  HREF="000538.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] WHY Rule &quot;950109&quot; matches for ARG &quot;passed_id=81&quot; ?</H1>
    <B>Ryan Barnett</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20WHY%20Rule%20%22950109%22%20matches%20for%0A%20ARG%20%22passed_id%3D81%22%20%3F&In-Reply-To=20101102161410.17410ou0hv5w0n2q%40webmail.axiomasoft.pt"
       TITLE="[Owasp-modsecurity-core-rule-set] WHY Rule &quot;950109&quot; matches for ARG &quot;passed_id=81&quot; ?">RBarnett at trustwave.com
       </A><BR>
    <I>Tue Nov  2 14:22:47 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="000536.html">[Owasp-modsecurity-core-rule-set] WHY Rule &quot;950109&quot; matches	for	ARG &quot;passed_id=81&quot; ?
</A></li>
        <LI>Next message: <A HREF="000538.html">[Owasp-modsecurity-core-rule-set] Detection Malice with	ModSecurity: IP Forensics
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#537">[ date ]</a>
              <a href="thread.html#537">[ thread ]</a>
              <a href="subject.html#537">[ subject ]</a>
              <a href="author.html#537">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/2/10 12:14 PM, &quot;Lu&#237;s Miguel dos Reis Oliveira e Silva&quot;
&lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">luis.silva at axiomasoft.pt</A>&gt; wrote:

&gt;<i>    
</I>&gt;<i> 
</I>&gt;<i>  Hello,
</I>&gt;<i>  
</I>&gt;<i>  I'm sorry to bring this up again, but my questions didn't get an answer, so I
</I>&gt;<i> still thing these rules to be prone to false positives.
</I>&gt;<i>  
</I>&gt;<i>  As a new release of the rules is comming out soon, I though I should bring
</I>&gt;<i> this up for discussion again.
</I>&gt;<i>  
</I>&gt;<i>  Shouldn't rules 950107, 950109 and 950108 be rewriten to be something more
</I>&gt;<i> like this: &quot;\%[0-9a-fA-F]{2}(?![0-9a-fA-F])|\%u[0-9a-fA-F]{4}(?![0-9a-fA-F])&quot;?
</I>&gt;<i> Like they are now, &quot;%1&quot; would match and, unless I missed the point on what the
</I>&gt;<i> rules should do, this would be a false positive, am I right?
</I>&gt;<i>  
</I>&gt;<i>  Thanks and sorry for all the noise.
</I>&gt;<i>  Lu&#237;s Silva
</I>&gt;<i>  
</I>
Hey Luis,
OK, I had to think on this one a bit.  Keep in mind that this is a chained
rule.  The initial regex check is being used to try and determine if there
*might* be some URL encoded data in the request variable.  If there is, then
it will proceed to the @validateUrlEncoding operator check.

The way the regex is writter now, I agree that there can be some false
positives where the data is not actually encoded and thus would generate
errors when the URL encoding operation is run.  On the flip side, we don't
want to miss any encoded data.

I tried out this new regex and it seems to work -

\%([0-9a-zA-Z]{2}|u[0-9a-fA-F]{4})\%

This regex will look for the common encoding format and it also checks for a
trailing % as encoded data normally consists of multiple characters encoded
in sequence.

Please test this out and see if it works for you.  If anyone else can test
it and let me know if it works that would be great too.  After some more
tests, I will update the CRS.

-Ryan


&gt;<i>  Quoting &quot;Lu&#237;s Silva&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">luis.silva at axiomasoft.pt</A>&gt;:
</I>&gt;<i>  
</I>&gt;&gt;<i> Hello,
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> On Wed, 2010-09-08 at 10:16 -0500, Ryan Barnett wrote:
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> On 9/8/10 10:44 AM, &quot;Dirk Caspari&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">d.caspari at eurodata.de</A>&gt; wrote:
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> --411a3f76-B--
</I>&gt;&gt;&gt;&gt;<i> GET /src/read_body.php?mailbox=INBOX&amp;passed_id=81&amp;startMessage=1 HTTP/1.1
</I>&gt;&gt;&gt;&gt;<i> Host: xxx.xxxxxxxx.de
</I>&gt;&gt;&gt;&gt;<i> User-Agent: Mozilla/5.0 (X11; U; Linux i686; de-DE; rv:1.9.2.3)
</I>&gt;&gt;&gt;&gt;<i> Gecko/20100423 Ubuntu/10.04 (lucid) Firefox/3.6.3
</I>&gt;&gt;&gt;&gt;<i> Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
</I>&gt;&gt;&gt;&gt;<i> Accept-Language: de-DE,de;q=0.8,de-de;q=0.6,en-us;q=0.4,en;q=0.2
</I>&gt;&gt;&gt;&gt;<i> Accept-Encoding: gzip,deflate
</I>&gt;&gt;&gt;&gt;<i> Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7
</I>&gt;&gt;&gt;&gt;<i> Keep-Alive: 115
</I>&gt;&gt;&gt;&gt;<i> Connection: keep-alive
</I>&gt;&gt;&gt;&gt;<i> Referer:
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> <A HREF="https://xxx.xxxxxxxxx.de/src/right_main.php?PG_SHOWALL=0&amp;sort=0&amp;startMessage">https://xxx.xxxxxxxxx.de/src/right_main.php?PG_SHOWALL=0&amp;sort=0&amp;startMessage</A>
</I>&gt;&gt;&gt;<i> =1
</I>&gt;&gt;&gt;&gt;<i> &amp;mailbox=INBOX
</I>&gt;&gt;&gt;&gt;<i> Cookie: xxxxx
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> --411a3f76-H--
</I>&gt;&gt;&gt;&gt;<i> Message: Pattern match &quot;\%(?!$|\W)|[0-9a-fA-F]{2}|u[0-9a-fA-F]{4}&quot; at
</I>&gt;&gt;&gt;&gt;<i> ARGS:passed_id. [file
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> &quot;/etc/apache2/modsecurity/rules-enabled/modsecurity_crs_20_protocol_violatio
</I>&gt;&gt;&gt;<i> ns
</I>&gt;&gt;&gt;&gt;<i> .conf&quot;]
</I>&gt;&gt;&gt;&gt;<i> [line &quot;185&quot;] [id &quot;950109&quot;] [rev &quot;2.0.8&quot;] [msg &quot;Multiple URL Encoding
</I>&gt;&gt;&gt;&gt;<i> Detected&quot;] [severity &quot;NOTICE&quot;] [tag &quot;PROTOCOL_VIOLATION/EVASION&quot;]
</I>&gt;&gt;&gt;&gt;<i> Message: Warning. Operator LT matched 20 at TX:inbound_anomaly_score.
</I>&gt;&gt;&gt;&gt;<i> [file
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&quot;/etc/apache2/modsecurity/rules-enabled/modsecurity_crs_60_correlation.conf&quot;&gt;&gt;&gt;
]
&gt;&gt;&gt;&gt;<i> [line &quot;31&quot;] [msg &quot;Inbound Anomaly Score (Total Inbound Score: 5, SQLi=,
</I>&gt;&gt;&gt;&gt;<i> XSS=): Multiple URL Encoding Detected !
</I>&gt;&gt;&gt;&gt;<i> %{matched_var_name}=%{matched_var} !&quot;]
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> Thanks.
</I>&gt;&gt;&gt;&gt;<i> &#160; &#160;D I R K
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Hmm.. Looks like the previous version in SVN was missing the parentheses in
</I>&gt;&gt;&gt;<i> the RegEx.&#160; Use this latest version -
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> <A HREF="http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/base_r">http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/base_r</A>
</I>&gt;&gt;&gt;<i> ules/modsecurity_crs_20_protocol_violations.conf?revision=1535
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> The regular expression in rules 950107, 950109 and 950108 shouldn't
</I>&gt;&gt;<i> instead be something like &quot;\%[0-9a-fA-F]{2}(?![0-9a-fA-F])|\%
</I>&gt;&gt;<i> u[0-9a-fA-F]{4}(?![0-9a-fA-F])&quot;?
</I>&gt;&gt;<i> The expression provided will still match for example &quot;%1&quot; and, unless I
</I>&gt;&gt;<i> missed the point on what the rules should do, this would be a false
</I>&gt;&gt;<i> positive.
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> Owasp-modsecurity-core-rule-set mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set</A>
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Thanks,
</I>&gt;&gt;<i> Lu&#237;s
</I>&gt;&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i>  
</I>&gt;<i>  ----------------------------------------------------------------
</I>&gt;<i>  This message was sent using IMP, the Internet Messaging Program.
</I>&gt;<i>  
</I>

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000536.html">[Owasp-modsecurity-core-rule-set] WHY Rule &quot;950109&quot; matches	for	ARG &quot;passed_id=81&quot; ?
</A></li>
	<LI>Next message: <A HREF="000538.html">[Owasp-modsecurity-core-rule-set] Detection Malice with	ModSecurity: IP Forensics
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#537">[ date ]</a>
              <a href="thread.html#537">[ thread ]</a>
              <a href="subject.html#537">[ subject ]</a>
              <a href="author.html#537">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
