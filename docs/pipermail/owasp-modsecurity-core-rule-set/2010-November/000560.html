<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Error in optional_rules/modsecurity_crs_43_csrf_protection.conf
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20Error%20in%0A%20optional_rules/modsecurity_crs_43_csrf_protection.conf&In-Reply-To=AANLkTinPkqCKYXckMSYn68da96Y2qmtKKxTaRVJZAhCo%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000559.html">
   <LINK REL="Next"  HREF="000561.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Error in optional_rules/modsecurity_crs_43_csrf_protection.conf</H1>
    <B>Ryan Barnett</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20Error%20in%0A%20optional_rules/modsecurity_crs_43_csrf_protection.conf&In-Reply-To=AANLkTinPkqCKYXckMSYn68da96Y2qmtKKxTaRVJZAhCo%40mail.gmail.com"
       TITLE="[Owasp-modsecurity-core-rule-set] Error in optional_rules/modsecurity_crs_43_csrf_protection.conf">RBarnett at trustwave.com
       </A><BR>
    <I>Tue Nov 30 14:17:39 EST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="000559.html">[Owasp-modsecurity-core-rule-set] Error in	optional_rules/modsecurity_crs_43_csrf_protection.conf
</A></li>
        <LI>Next message: <A HREF="000561.html">[Owasp-modsecurity-core-rule-set] Error in	optional_rules/modsecurity_crs_43_csrf_protection.conf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#560">[ date ]</a>
              <a href="thread.html#560">[ thread ]</a>
              <a href="subject.html#560">[ subject ]</a>
              <a href="author.html#560">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/30/10 2:05 PM, &quot;Jeronimo Zucco&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">jczucco at gmail.com</A>&gt; wrote:

&gt;<i> I am upgrading my servers to the ModSecurity 2.5.13 and core
</I>&gt;<i> ruleset/2.0.10 and got this error in my config:
</I>&gt;<i> 
</I>&gt;<i>  ModSecurity: Could not set variable &quot;session.sessionid&quot; as the
</I>&gt;<i> collection does not exist.
</I>&gt;<i> 
</I>
This error is generated when a rule is using setvar:session.... However the
SESSION collection has not yet been initialized with the setsid action.


&gt;<i> 
</I>&gt;<i> In the default optional_rules/modsecurity_crs_43_csrf_protection.conf has:
</I>&gt;<i> 
</I>
Is this happening all the time or only when you initially started ModSec
with the new CRS 43 csrf rules?

&gt;<i> SecMarker BEGIN_SESSION_STARTUP
</I>&gt;<i> 
</I>&gt;<i> SecRule 
</I>&gt;<i> REQUEST_COOKIES:'/(j?sessionid|(php)?sessid|(asp|jserv|jw)?session[-_]?(id)?|c
</I>&gt;<i> f(id|token)|sid)/'
</I>&gt;<i> &quot;.*&quot; &quot;chain,phase:1,t:none,pass,nolog,auditlog,msg:'Invalid SessionID
</I>&gt;<i> Submitted.',setsid:%{matched_var},setvar:tx.sessionid=%{matched_var},skipAfter
</I>&gt;<i> :END_SESSION_STARTUP&quot;
</I>&gt;<i>        SecRule SESSION:VALID &quot;!@eq 1&quot; &quot;t:none&quot;
</I>&gt;<i> 
</I>&gt;<i> SecAction 
</I>&gt;<i> &quot;phase:1,t:none,nolog,pass,setuid:%{session.username},setvar:session.sessionid
</I>&gt;<i> =%{tx.sessionid}&quot;
</I>&gt;<i> 
</I>&gt;<i> SecMarker END_SESSION_STARTUP
</I>&gt;<i> 
</I>
This initial section is checking to see if the client is submitting a
SESSIONID cookie value.  If they are, then it is using setsid to initialize
the collection with the session id being submitted by the client as the key.
The 2nd part of the chained rule is then looking to see if the SESSION
collection has a variable set called VALID, which is previously set by
ModSecurity (in the rules below) when the application is initially handing
out the SESSIONID in a Set-Cookie response header.  If the VALID variable is
not present, then the client has submitted a bogus SESSIONID value.

If the SESSIONID submitted is VALID, then it proceeds as normal.

&gt;<i> 
</I>&gt;<i> SecRule RESPONSE_HEADERS:/Set-Cookie2?/
</I>&gt;<i> &quot;(?i:(j?sessionid|(php)?sessid|(asp|jserv|jw)?session[-_]?(id)?|cf(id|token)|s
</I>&gt;<i> id)=([^\s]+)\;\s?)&quot;
</I>&gt;<i> &quot;chain,phase:3,t:none,pass,nolog,capture,setsid:%{TX.6},setvar:session.session
</I>&gt;<i> id=%{TX.6},setvar:session.valid=1&quot;
</I>&gt;<i>        SecRule SESSION:SESSIONID &quot;(.*)&quot;
</I>&gt;<i> &quot;t:none,t:sha1,t:hexEncode,capture,setvar:session.csrf_token=%{TX.1}&quot;
</I>&gt;<i> 
</I>&gt;<i> 
</I>
This ruleset is inspecting the response headers looking for Set-Cookie
headers that are sending common SessionID names.  If this is found, then a
SESSION collection is initialized with the SessionID as the key and a
variable called VALID is created.  We know this SESSIONID is valid since the
application is handing it out.

Do you have an audit_log example of this transaction?  You can then look to
see if the transaction has a SessionID in it or not.

-Ryan


</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000559.html">[Owasp-modsecurity-core-rule-set] Error in	optional_rules/modsecurity_crs_43_csrf_protection.conf
</A></li>
	<LI>Next message: <A HREF="000561.html">[Owasp-modsecurity-core-rule-set] Error in	optional_rules/modsecurity_crs_43_csrf_protection.conf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#560">[ date ]</a>
              <a href="thread.html#560">[ thread ]</a>
              <a href="subject.html#560">[ subject ]</a>
              <a href="author.html#560">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
