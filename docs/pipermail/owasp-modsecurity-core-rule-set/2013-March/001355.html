<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Using SecHashKey, SecParam, SecHashMethodRx set  cookie token
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Using%20SecHashKey%2C%20SecParam%2C%0A%20SecHashMethodRx%20set%20%20cookie%20token&In-Reply-To=%3C01987910BF74B341B5890120BCCE77DF36EFA2%40SKYMB1.trustwave.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001353.html">
   <LINK REL="Next"  HREF="001354.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Using SecHashKey, SecParam, SecHashMethodRx set  cookie token</H1>
    <B>Ryan Barnett</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Using%20SecHashKey%2C%20SecParam%2C%0A%20SecHashMethodRx%20set%20%20cookie%20token&In-Reply-To=%3C01987910BF74B341B5890120BCCE77DF36EFA2%40SKYMB1.trustwave.com%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] Using SecHashKey, SecParam, SecHashMethodRx set  cookie token">RBarnett at trustwave.com
       </A><BR>
    <I>Mon Mar 18 12:57:30 UTC 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="001353.html">[Owasp-modsecurity-core-rule-set] Using SecHashKey, SecParam, SecHashMethodRx set cookie token
</A></li>
        <LI>Next message: <A HREF="001354.html">[Owasp-modsecurity-core-rule-set] Activating XML parsing on	multipart/related
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1355">[ date ]</a>
              <a href="thread.html#1355">[ thread ]</a>
              <a href="subject.html#1355">[ subject ]</a>
              <a href="author.html#1355">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
From: &quot;conn.zhang&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">conn.zhang at dbappsecurity.com.cn</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">conn.zhang at dbappsecurity.com.cn</A>&gt;&gt;
Reply-To: &quot;conn.zhang&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">conn.zhang at dbappsecurity.com.cn</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">conn.zhang at dbappsecurity.com.cn</A>&gt;&gt;
Date: Tuesday, March 12, 2013 9:37 PM
To: owasp-modsecurity-core-rule-set &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&gt;, owasp-modsecurity-core-rule-set &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&gt;, owasp-modsecurity-core-rule-set &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&gt;, owasp-modsecurity-core-rule-set &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&gt;, owasp-modsecurity-core-rule-set &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&gt;, owasp-modsecurity-core-rule-set &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&gt;
Subject: [Owasp-modsecurity-core-rule-set] Using SecHashKey, SecParam, SecHashMethodRx set cookie token

Hello,all!
Now, I'm using SecHashKey SecParam and SecHashMethodRx variables set the cookies token.
My rule looks like this:

SecHashEngine On
SecHashParam cookie_token
SecHashKey Rand SessionID
SecHashMethodRx HashLocation &quot;Set-Cookie2?&quot;
SecRule REQUEST_HEADERS &quot;@validate Hash Cookie&quot; \
&quot;phase:2,capture,t:none,block,ctl:HashEnforcement=On,log,auitlog,status:403,id:'999900'&quot;

I don't see the token was set in cookie header.

________________________________
DBAppSecurity

The SecHashEngine does not protect Cookies at this point.  We have plans to add this capability.  In the meantime, there are some options using SecRules.  In &quot;Chapter 8: Defending Session State: of my book - <A HREF="http://www.wiley.com/WileyCDA/WileyTitle/productCd-1118362187.html">http://www.wiley.com/WileyCDA/WileyTitle/productCd-1118362187.html</A> &#8211; I cover this in Recipe 82-: Detecting Cookie Tampering.

If you have already activated the OWASP CRS rules to create the Session Collection, you can use this rule to save the Set-Cookie data to the Session Collection -

#
# -=[ Save Set-Cookie Name/Value Pairs ]=-
#
SecRule RESPONSE_HEADERS:/Set-Cookie2?/ &quot;^(.*?)=(.*?);&quot; &quot;chain,phase:3,id:'981063',t:none,nolog,pass,capture,setvar:tx.cookie_name_counter=+1,setvar:tx.cookie_name_%{tx.cookie_name_counter}=/%{tx.1}/,setvar:'session.cookie_list=%{session.cookie_list} %{tx.0}'&quot;
SecRule SESSION:COOKIE_LIST &quot;.*&quot; &quot;t:trimLeft,setvar:session.cookie_list=%{matched_var}&quot;

You can then validate Request Cookies with this rule -

SecRule REQUEST_COOKIES &quot;.*&quot; &quot;chain,phase:1,id:'958233',t:none,block,msg:'Invalid Cookie Data Submitted.',logdata:'Cookie Data: %{matched_var}',tag:'OWASP_AppSensor/SE1',setvar:'tx.req_cookie_%{matched_var_name}=%{matched_var};'&quot;
SecRule TX:/REQ_COOKIE_/ &quot;!@within %{session.cookie_list}&quot; &quot;setvar:tx.cookie_name=%{tx.1},setvar:tx.anomaly_score=+%{tx.critical_anomaly_score},setvar:tx.%{rule.id}-WEB_ATTACK/INVALID_SESSIONID-%{matched_var_name}=%{tx.0}&quot;

Keep in mind that you may run into false positives if you site uses JS to create/modify Cookies.

-Ryan


________________________________

This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20130318/361565e9/attachment.html">http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20130318/361565e9/attachment.html</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001353.html">[Owasp-modsecurity-core-rule-set] Using SecHashKey, SecParam, SecHashMethodRx set cookie token
</A></li>
	<LI>Next message: <A HREF="001354.html">[Owasp-modsecurity-core-rule-set] Activating XML parsing on	multipart/related
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1355">[ date ]</a>
              <a href="thread.html#1355">[ thread ]</a>
              <a href="subject.html#1355">[ subject ]</a>
              <a href="author.html#1355">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
