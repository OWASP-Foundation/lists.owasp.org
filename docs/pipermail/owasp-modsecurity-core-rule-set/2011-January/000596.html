<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Anomoly Scoring Detection	Mode not working
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20Anomoly%20Scoring%20Detection%0A%09Mode%20not%20working&In-Reply-To=C94B99D9.171AD%25rbarnett%40trustwave.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000595.html">
   <LINK REL="Next"  HREF="000593.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Anomoly Scoring Detection	Mode not working</H1>
    <B>Dimitri Yioulos</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20Anomoly%20Scoring%20Detection%0A%09Mode%20not%20working&In-Reply-To=C94B99D9.171AD%25rbarnett%40trustwave.com"
       TITLE="[Owasp-modsecurity-core-rule-set] Anomoly Scoring Detection	Mode not working">dyioulos at firstbhph.com
       </A><BR>
    <I>Thu Jan  6 17:21:16 EST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="000595.html">[Owasp-modsecurity-core-rule-set] Anomoly Scoring Detection Mode not working
</A></li>
        <LI>Next message: <A HREF="000593.html">[Owasp-modsecurity-core-rule-set] SecRequestBodyLimit parameter
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#596">[ date ]</a>
              <a href="thread.html#596">[ thread ]</a>
              <a href="subject.html#596">[ subject ]</a>
              <a href="author.html#596">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Ah, so I still can't read :-) .  Ryan, so sorry 
for any unnecessary grief.

The only reason I haven't upgraded to a later 
version of modsecurity is that I run into lua 
problems on my  CentOS 4.8-based Web server if I 
do (lua-5.0.2 is the last RPM-based version that 
I can use the doesn't break stuff and, iirc, 
ModSecurity v2.5.12 and greater needs lua-5.1x).

That said, I edited 
modsecurity_crs_49_inbound_blocking.conf, as per 
Ryan's instructions, and we're all good.

If I might I one more question, having edited the 
file, what is the effect of not doing macro 
expansion?  How much does it &quot;weaken&quot; the rule?

My sincere thanks, once again, for your help Ryan.

Dimitri


On Thursday 06 January 2011 4:15:50 pm Ryan 
Barnett wrote:
&gt;<i> Ok, I think I found Dimitri's issue.  I am
</I>&gt;<i> sending this out the list so others are aware.
</I>&gt;<i>
</I>&gt;<i> Dimitri sent me an audit log file and it showed
</I>&gt;<i> that is using ModSecurity v2.5.9.  The macro
</I>&gt;<i> expansions used in the 49 inbound blocking file
</I>&gt;<i> use features of ModSecurity v2.5.12 and
</I>&gt;<i> greater.  This is listed in the
</I>&gt;<i> modsecurity_crs_10_config.conf.example file -
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> #
</I>&gt;<i> # -=[ Anomaly Scoring Threshold Levels ]=-
</I>&gt;<i> #
</I>&gt;<i> # These variables are used in macro expansion
</I>&gt;<i> in the 49 inbound blocking and 59
</I>&gt;<i> # outbound blocking files.
</I>&gt;<i> #
</I>&gt;<i> # **MUST HAVE** ModSecurity v2.5.12 or higher
</I>&gt;<i> to use macro expansion in numeric
</I>&gt;<i> # operators.  If you have an earlier version,
</I>&gt;<i> edit the 49/59 files directly to
</I>&gt;<i> # set the appropriate anomaly score levels.
</I>&gt;<i> #
</I>&gt;<i> # You should set the score to the proper
</I>&gt;<i> threshold you would prefer. If set to &quot;5&quot;
</I>&gt;<i> # it will work similarly to previous Mod CRS
</I>&gt;<i> rules and will create an event in the error_log
</I>&gt;<i> # file if there are any rules that match.  If
</I>&gt;<i> you would like to lessen the number of events
</I>&gt;<i> # generated in the error_log file, you should
</I>&gt;<i> increase the anomaly score threshold to
</I>&gt;<i> # something like &quot;20&quot;.  This would only
</I>&gt;<i> generate an event in the error_log file if
</I>&gt;<i> # there are multiple lower severity rule
</I>&gt;<i> matches or if any 1 higher severity item
</I>&gt;<i> matches.
</I>&gt;<i> #
</I>&gt;<i> SecAction
</I>&gt;<i> &quot;phase:1,t:none,nolog,pass,setvar:tx.inbound_an
</I>&gt;<i>omaly_score_level=5&quot; SecAction
</I>&gt;<i> &quot;phase:1,t:none,nolog,pass,setvar:tx.outbound_a
</I>&gt;<i>nomaly_score_level=4&quot;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> This means that for Dimitri's install, the
</I>&gt;<i> following part of the chained rule in the
</I>&gt;<i> modsecurity_crs_49_inbound_blocking.conf file
</I>&gt;<i> is not doing macro expansion to properly
</I>&gt;<i> evaluate the tx.inbound_anomaly_score_level
</I>&gt;<i> against the @ge operator -
</I>&gt;<i>
</I>&gt;<i> SecRule TX:ANOMALY_SCORE &quot;@ge
</I>&gt;<i> %{tx.inbound_anomaly_score_level}&quot;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> So, Dimitri - you have two options:
</I>&gt;<i>
</I>&gt;<i> 1) Upgrade ModSecurity to the latest version
</I>&gt;<i> (recommended), or 2) As the comments say above,
</I>&gt;<i> if you can't upgrade, you need to edit the 49
</I>&gt;<i> file and change the rule so that it doesn't use
</I>&gt;<i> macro expansion -
</I>&gt;<i>
</I>&gt;<i> SecRule TX:ANOMALY_SCORE &quot;@ge 5&quot;
</I>&gt;<i>
</I>&gt;<i> Hope this helps,
</I>&gt;<i> Ryan
</I>&gt;<i>
</I>&gt;<i> On 1/6/11 10:24 AM, &quot;Dimitri Yioulos&quot; 
</I>&lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">dyioulos at firstbhph.com</A>&gt; wrote:
&gt;<i> &gt;All,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;Anything more on this?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;Thanks.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;Dimitri
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;On Tuesday 04 January 2011 4:22:20 pm Dimitri
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;Yioulos wrote:
</I>&gt;<i> &gt;&gt; The value in the 10 config file is the
</I>&gt;<i> &gt;&gt; default:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; SecAction
</I>&gt;<i> &gt;&gt; &quot;phase:1,t:none,nolog,pass,setvar:tx.inbound
</I>&gt;<i> &gt;&gt;_an omaly_score_level=5&quot; SecAction
</I>&gt;<i> &gt;&gt; &quot;phase:1,t:none,nolog,pass,setvar:tx.outboun
</I>&gt;<i> &gt;&gt;d_a nomaly_score_level=4&quot;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Dimitri
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; On Tuesday 04 January 2011 4:03:31 pm Ryan
</I>&gt;<i> &gt;&gt; Barnett
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; wrote:
</I>&gt;<i> &gt;&gt; &gt; The alerts say that there was a user-agent
</I>&gt;<i> &gt;&gt; &gt; string match (mozilla 4.0( ) with the
</I>&gt;<i> &gt;&gt; &gt; comment spam rules.  This match raised the
</I>&gt;<i> &gt;&gt; &gt; tx.inbound_anomaly_score to 3. What do you
</I>&gt;<i> &gt;&gt; &gt; have this value set to in the 10 config
</I>&gt;<i> &gt;&gt; &gt; file? By default the blocking level is 5.
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; --
</I>&gt;<i> &gt;&gt; &gt; Ryan Barnett
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; On Jan 4, 2011, at 3:46 PM, Dimitri
</I>&gt;<i> &gt;&gt; &gt; Yioulos
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">dyioulos at firstbhph.com</A>&gt; wrote:
</I>&gt;<i> &gt;&gt; &gt; &gt; On Tuesday 04 January 2011 3:21:41 pm
</I>&gt;<i> &gt;&gt; &gt; &gt; you
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; wrote:
</I>&gt;<i> &gt;&gt; &gt; &gt;&gt; On Tue, Jan 4, 2011 at 10:01 PM,
</I>&gt;<i> &gt;&gt; &gt; &gt;&gt; Dimitri Yioulos
</I>&gt;<i> &gt;&gt; &gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; &gt; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">dyioulos at firstbhph.com</A>&gt; wrote:
</I>&gt;<i> &gt;&gt; &gt; &gt;&gt;&gt; Did I forget something in setting up
</I>&gt;<i> &gt;&gt; &gt; &gt;&gt;&gt; Anomoly Scoring Detection Mode, or
</I>&gt;<i> &gt;&gt; &gt; &gt;&gt;&gt; misconfigure something?
</I>&gt;<i> &gt;&gt; &gt; &gt;&gt;
</I>&gt;<i> &gt;&gt; &gt; &gt;&gt; Hi Dimitri,
</I>&gt;<i> &gt;&gt; &gt; &gt;&gt;
</I>&gt;<i> &gt;&gt; &gt; &gt;&gt; What do the logs say?
</I>&gt;<i> &gt;&gt; &gt; &gt;&gt;
</I>&gt;<i> &gt;&gt; &gt; &gt;&gt; --
</I>&gt;<i> &gt;&gt; &gt; &gt;&gt; - Josh
</I>&gt;<i> &gt;&gt; &gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; &gt; Josh,
</I>&gt;<i> &gt;&gt; &gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; &gt; I'm not great at deciphering the log
</I>&gt;<i> &gt;&gt; &gt; &gt; messages that modsec generates.  I think
</I>&gt;<i> &gt;&gt; &gt; &gt; I've captured some relevant data, and
</I>&gt;<i> &gt;&gt; &gt; &gt; put it here:
</I>&gt;<i> &gt;&gt; &gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; &gt; <A HREF="http://pastebin.com/kCQ9i8p4">http://pastebin.com/kCQ9i8p4</A>
</I>&gt;<i> &gt;&gt; &gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; &gt; Dimitri
</I>&gt;<i> &gt;&gt; &gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; &gt; --
</I>&gt;<i> &gt;&gt; &gt; &gt; This message has been scanned for
</I>&gt;<i> &gt;&gt; &gt; &gt; viruses and dangerous content by
</I>&gt;<i> &gt;&gt; &gt; &gt; MailScanner, and is believed to be
</I>&gt;<i> &gt;&gt; &gt; &gt; clean.
</I>&gt;<i> &gt;&gt; &gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; &gt; ________________________________________
</I>&gt;<i> &gt;&gt; &gt; &gt;___ __ __ Owasp-modsecurity-core-rule-set
</I>&gt;<i> &gt;&gt; &gt; &gt; mailing list
</I>&gt;<i> &gt;&gt; &gt; &gt; <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.ow</A>
</I>&gt;<i> &gt;&gt; &gt; &gt;asp .o rg
</I>&gt;<i> &gt;&gt; &gt; &gt; <A HREF="https://lists.owasp.org/mailman/listinfo">https://lists.owasp.org/mailman/listinfo</A>
</I>&gt;<i> &gt;&gt; &gt; &gt;/ow as p-modsecurity-core-rule-set
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;--
</I>&gt;<i> &gt;This message has been scanned for viruses and
</I>&gt;<i> &gt;dangerous content by MailScanner, and is
</I>&gt;<i> &gt;believed to be clean.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;______________________________________________
</I>&gt;<i> &gt;_ Owasp-modsecurity-core-rule-set mailing list
</I>&gt;<i> &gt; <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.o</A>
</I>&gt;<i> &gt;rg
</I>&gt;<i> &gt; <A HREF="https://lists.owasp.org/mailman/listinfo/owas">https://lists.owasp.org/mailman/listinfo/owas</A>
</I>&gt;<i> &gt;p-modsecurity-core-rule-set
</I>


-- 
This message has been scanned for viruses and
dangerous content by MailScanner, and is
believed to be clean.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000595.html">[Owasp-modsecurity-core-rule-set] Anomoly Scoring Detection Mode not working
</A></li>
	<LI>Next message: <A HREF="000593.html">[Owasp-modsecurity-core-rule-set] SecRequestBodyLimit parameter
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#596">[ date ]</a>
              <a href="thread.html#596">[ thread ]</a>
              <a href="subject.html#596">[ subject ]</a>
              <a href="author.html#596">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
