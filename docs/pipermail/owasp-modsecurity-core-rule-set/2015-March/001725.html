<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Questions about	modsecurity_crs_11_dos_protection.conf
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Questions%20about%0A%09modsecurity_crs_11_dos_protection.conf&In-Reply-To=%3CDUB406-EAS43213CB6E0F25BF25A84C1B82190%40phx.gbl%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001724.html">
   <LINK REL="Next"  HREF="001726.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Questions about	modsecurity_crs_11_dos_protection.conf</H1>
    <B>Barry Pollard</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Questions%20about%0A%09modsecurity_crs_11_dos_protection.conf&In-Reply-To=%3CDUB406-EAS43213CB6E0F25BF25A84C1B82190%40phx.gbl%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] Questions about	modsecurity_crs_11_dos_protection.conf">barry_pollard at hotmail.com
       </A><BR>
    <I>Wed Mar 11 07:49:05 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="001724.html">[Owasp-modsecurity-core-rule-set] Questions about modsecurity_crs_11_dos_protection.conf
</A></li>
        <LI>Next message: <A HREF="001726.html">[Owasp-modsecurity-core-rule-set] Questions about	modsecurity_crs_11_dos_protection.conf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1725">[ date ]</a>
              <a href="thread.html#1725">[ thread ]</a>
              <a href="subject.html#1725">[ subject ]</a>
              <a href="author.html#1725">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks for those answers Chaim. Make sense to me.

I do think the use of SDBM for storage for large scale tracking like for IP addresses is a problem (with ModSecurity rather than with the core rule set but not that that matters). Unfortunately it just doesn't work for even relatively small amounts of traffic.

Not sure how you could resolve it and I know nothing about ModSecurity is written, or about writing really high performing systems like this, but came up with below suggestions after a bit of a think. Not sure how feasible any of these are.

* Split out IP.pag into several files based on hashed IP address so bottle neck is not on one file. Would need to be hashed IP address in case your customer based is skewed towards certain IP ranges. Could also configure number of files to split across, so busier sites have larger number of IP.pag files, if the hashing algorithm could take that config number into account.

* Have a minimum update time e.g. If hit from IP in last 1 second then don't bother saving another hit as record is reasonably up to date. Again time could be configurable. Would obviously impact any DoS/Brute force rules since we'd be filtering out hits here.

* Make it easier to ignore the problem by ignoring certain alerts (e.g. deleting stale collections fails... etc.) unless in high log level, and add a safe way of ModSecurity clearing down the file and starting again at certain times (e.g. daily/weekly) or after it reaches a certain size. Massive fudge but could be short term solution.

* Use some other persistent storage. Though I'd imagine, given the potential rate of data updates for a busy site, this would also be a problem in whatever we move to.

* Use in-memory storage - though guess that would raise questions on memory requirements and how to share between different threads/processes.

* Have dedicated process/program to manage collections that all other threads/processes talk via. Could address some of the issues with in using in-memory storage raised above. Then again could bring in whole raft of other problems :-)

* Store less. Collections do seem to be quite large. Could you have a minimal set for things like IP address with just last access time/num hits? For rules that require more things tracked (e.g. Brute force attempts on a specific URL) they could be tracked in a separate &quot;full&quot; collection which would have a larger record set, but with less entries.

* Reduce blocking time in code making the SDBM update. Imagine the code is probably pretty tight here already but obviously any reduction here would have benefit. Had a quick look myself (more out of nosiness) but the C code scared me too much (been a while!).

* Look into how other modules (e.g. mod_evasive) handle this problem to see if can learn anything from them.

Am sure you've probably already considered these and better solutions but thought I'd suggest them anyway.

Thanks,
Barry

&gt;<i> On 11 Mar 2015, at 03:54, Chaim Sanders &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">CSanders at trustwave.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> we
</I></PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001724.html">[Owasp-modsecurity-core-rule-set] Questions about modsecurity_crs_11_dos_protection.conf
</A></li>
	<LI>Next message: <A HREF="001726.html">[Owasp-modsecurity-core-rule-set] Questions about	modsecurity_crs_11_dos_protection.conf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1725">[ date ]</a>
              <a href="thread.html#1725">[ thread ]</a>
              <a href="subject.html#1725">[ subject ]</a>
              <a href="author.html#1725">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
