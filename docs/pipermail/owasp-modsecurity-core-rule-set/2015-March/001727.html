<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Questions about modsecurity_crs_11_dos_protection.conf
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Questions%20about%0A%20modsecurity_crs_11_dos_protection.conf&In-Reply-To=%3CD125A95F.3866%25csanders%40trustwave.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001726.html">
   <LINK REL="Next"  HREF="001728.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Questions about modsecurity_crs_11_dos_protection.conf</H1>
    <B>Chaim Sanders</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Questions%20about%0A%20modsecurity_crs_11_dos_protection.conf&In-Reply-To=%3CD125A95F.3866%25csanders%40trustwave.com%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] Questions about modsecurity_crs_11_dos_protection.conf">CSanders at trustwave.com
       </A><BR>
    <I>Wed Mar 11 12:13:06 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="001726.html">[Owasp-modsecurity-core-rule-set] Questions about	modsecurity_crs_11_dos_protection.conf
</A></li>
        <LI>Next message: <A HREF="001728.html">[Owasp-modsecurity-core-rule-set] Questions about modsecurity_crs_11_dos_protection.conf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1727">[ date ]</a>
              <a href="thread.html#1727">[ thread ]</a>
              <a href="subject.html#1727">[ subject ]</a>
              <a href="author.html#1727">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>It should be noted for the purposes of this discussion that there is an experimental build of mod security with memcache support (<A HREF="https://github.com/SpiderLabs/ModSecurity/tree/memcache_collections">https://github.com/SpiderLabs/ModSecurity/tree/memcache_collections</A>).

From: Josh Amishav-Zlatin &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">jamuse at owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">jamuse at owasp.org</A>&gt;&gt;
Date: Wednesday, March 11, 2015 at 4:37 AM
To: Barry Pollard &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">barry_pollard at hotmail.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">barry_pollard at hotmail.com</A>&gt;&gt;
Cc: Chaim Sanders &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">csanders at trustwave.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">csanders at trustwave.com</A>&gt;&gt;, &quot;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&gt;
Subject: Re: [Owasp-modsecurity-core-rule-set] Questions about modsecurity_crs_11_dos_protection.conf

Hi Barry,

FWIW, we've run into similar issues and re-implemented some rules to use Redis for storage instead. This had to be implemented via Lua scripting though, which takes a slight performance hit. Having said that, there is an open ticket to implement an alternative shared persistent storage mechanism:

<A HREF="https://github.com/SpiderLabs/ModSecurity/issues/378&lt;http://scanmail.trustwave.com/?c=4062&amp;d=zP7_1EIfkGQmqzNdTgH9sZIg1Bsu-kZ-wPR_Yvt2BA&amp;s=5&amp;u=https%3a%2f%2fgithub%2ecom%2fSpiderLabs%2fModSecurity%2fissues%2f378">https://github.com/SpiderLabs/ModSecurity/issues/378&lt;http://scanmail.trustwave.com/?c=4062&amp;d=zP7_1EIfkGQmqzNdTgH9sZIg1Bsu-kZ-wPR_Yvt2BA&amp;s=5&amp;u=https%3a%2f%2fgithub%2ecom%2fSpiderLabs%2fModSecurity%2fissues%2f378</A>&gt;

--
 - Josh

On Wed, Mar 11, 2015 at 9:49 AM, Barry Pollard &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">barry_pollard at hotmail.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">barry_pollard at hotmail.com</A>&gt;&gt; wrote:
Thanks for those answers Chaim. Make sense to me.

I do think the use of SDBM for storage for large scale tracking like for IP addresses is a problem (with ModSecurity rather than with the core rule set but not that that matters). Unfortunately it just doesn't work for even relatively small amounts of traffic.

Not sure how you could resolve it and I know nothing about ModSecurity is written, or about writing really high performing systems like this, but came up with below suggestions after a bit of a think. Not sure how feasible any of these are.

* Split out IP.pag into several files based on hashed IP address so bottle neck is not on one file. Would need to be hashed IP address in case your customer based is skewed towards certain IP ranges. Could also configure number of files to split across, so busier sites have larger number of IP.pag files, if the hashing algorithm could take that config number into account.

* Have a minimum update time e.g. If hit from IP in last 1 second then don't bother saving another hit as record is reasonably up to date. Again time could be configurable. Would obviously impact any DoS/Brute force rules since we'd be filtering out hits here.

* Make it easier to ignore the problem by ignoring certain alerts (e.g. deleting stale collections fails... etc.) unless in high log level, and add a safe way of ModSecurity clearing down the file and starting again at certain times (e.g. daily/weekly) or after it reaches a certain size. Massive fudge but could be short term solution.

* Use some other persistent storage. Though I'd imagine, given the potential rate of data updates for a busy site, this would also be a problem in whatever we move to.

* Use in-memory storage - though guess that would raise questions on memory requirements and how to share between different threads/processes.

* Have dedicated process/program to manage collections that all other threads/processes talk via. Could address some of the issues with in using in-memory storage raised above. Then again could bring in whole raft of other problems :-)

* Store less. Collections do seem to be quite large. Could you have a minimal set for things like IP address with just last access time/num hits? For rules that require more things tracked (e.g. Brute force attempts on a specific URL) they could be tracked in a separate &quot;full&quot; collection which would have a larger record set, but with less entries.

* Reduce blocking time in code making the SDBM update. Imagine the code is probably pretty tight here already but obviously any reduction here would have benefit. Had a quick look myself (more out of nosiness) but the C code scared me too much (been a while!).

* Look into how other modules (e.g. mod_evasive) handle this problem to see if can learn anything from them.

Am sure you've probably already considered these and better solutions but thought I'd suggest them anyway.

Thanks,
Barry

&gt;<i> On 11 Mar 2015, at 03:54, Chaim Sanders &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">CSanders at trustwave.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">CSanders at trustwave.com</A>&gt;&gt; wrote:
</I>&gt;<i>
</I>&gt;<i> we
</I>_______________________________________________
Owasp-modsecurity-core-rule-set mailing list
<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;
<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set&lt;http://scanmail.trustwave.com/?c=4062&amp;d=zP7_1EIfkGQmqzNdTgH9sZIg1Bsu-kZ-wKcqY65yWQ&amp;s=5&amp;u=https%3a%2f%2flists%2eowasp%2eorg%2fmailman%2flistinfo%2fowasp-modsecurity-core-rule-set">https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set&lt;http://scanmail.trustwave.com/?c=4062&amp;d=zP7_1EIfkGQmqzNdTgH9sZIg1Bsu-kZ-wKcqY65yWQ&amp;s=5&amp;u=https%3a%2f%2flists%2eowasp%2eorg%2fmailman%2flistinfo%2fowasp-modsecurity-core-rule-set</A>&gt;


________________________________

This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is strictly prohibited. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20150311/16549c20/attachment.html">http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20150311/16549c20/attachment.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001726.html">[Owasp-modsecurity-core-rule-set] Questions about	modsecurity_crs_11_dos_protection.conf
</A></li>
	<LI>Next message: <A HREF="001728.html">[Owasp-modsecurity-core-rule-set] Questions about modsecurity_crs_11_dos_protection.conf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1727">[ date ]</a>
              <a href="thread.html#1727">[ thread ]</a>
              <a href="subject.html#1727">[ subject ]</a>
              <a href="author.html#1727">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
