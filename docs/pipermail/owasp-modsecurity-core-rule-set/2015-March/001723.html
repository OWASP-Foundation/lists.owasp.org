<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] block CONNECT
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20block%20CONNECT&In-Reply-To=%3CD1252396.370A%25csanders%40trustwave.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001728.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] block CONNECT</H1>
    <B>Chaim Sanders</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20block%20CONNECT&In-Reply-To=%3CD1252396.370A%25csanders%40trustwave.com%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] block CONNECT">CSanders at trustwave.com
       </A><BR>
    <I>Wed Mar 11 02:54:01 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="001728.html">[Owasp-modsecurity-core-rule-set] Questions about modsecurity_crs_11_dos_protection.conf
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1723">[ date ]</a>
              <a href="thread.html#1723">[ thread ]</a>
              <a href="subject.html#1723">[ subject ]</a>
              <a href="author.html#1723">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Sorry for the long lead time for this reply. This is actually a more
complicated problem then it ought to be. Currently ModSecurity does not
support easy methods of persisting data permanently. Compounding this
issue is that while ModSecurity is running, it uses SDBM which has a
somewhat low storage limit per variable (these would also be removed each
time you restart). What I would recommend would be modifying this rule (or
adding a custom one) to call a LUA script when triggered. This LUA script
should add/append to an IP blacklist file. Once in file format it is easy
enough to block these using ipmatchfromfile. The rule would probably start
similarly to 'SecRule REMOTE_ADDR &quot;@ipMatchFromFile blacklist.ip &#352;&#185;.
Hopefully this helps a bit.



On 2/9/15, 2:04 AM, &quot;Aniyan Rajan&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">aniyan.rajan6 at gmail.com</A>&gt; wrote:

&gt;<i>Hello,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>I am getting the following in the apache/error.log. There are plenty of
</I>&gt;<i>such errors coming in daily. So I would like to block them. They are
</I>&gt;<i>from different ips. So fail2ban is not a good option. They come from
</I>&gt;<i>&quot;<A HREF="http://scanmail.trustwave.com/?c=4062&amp;d=5uDY1ObqUZnGj7BGQHeiLo2p2q3I23ooY">http://scanmail.trustwave.com/?c=4062&amp;d=5uDY1ObqUZnGj7BGQHeiLo2p2q3I23ooY</A>
</I>&gt;<i>tUAWWYzeg&amp;s=5&amp;u=http%3a%2f%2fmail2000%2ecom%2etw&quot;. How can I block this
</I>&gt;<i>domain from trying to CONNECT ?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>[Sat Feb 07 09:52:21 2015] [error] [client 118.165.130.55] ModSecurity:
</I>&gt;<i>Access denied with code 403 (phase 1). Match of &quot;rx
</I>&gt;<i>^(?:(?:[a-z]{3,10}\\\\s+(?:\\\\w{3,7}?://[\\\\w\\\\-\\\\./]*(?::\\\\d+)?)?
</I>&gt;<i>/[^?#]*(?:\\\\?[^#\\\\s]*)?(?:#[\\\\S]*)?|connect
</I>&gt;<i>(?:\\\\d{1,3}\\\\.){3}\\\\d{1,3}\\\\.?(?::\\\\d+)?|options
</I>&gt;<i>\\\\*)\\\\s+[\\\\w\\\\./]+|get
</I>&gt;<i>/[^?#]*(?:\\\\?[^#\\\\s]*)?(?:#[\\\\S]*)?)$&quot; against &quot;REQUEST_LINE&quot;
</I>&gt;<i>required. [file
</I>&gt;<i>&quot;/usr/share/modsecurity-crs/activated_rules/modsecurity_crs_20_protocol_vi
</I>&gt;<i>olations.conf&quot;]
</I>&gt;<i>[line &quot;37&quot;] [id &quot;960911&quot;] [rev &quot;2.2.5&quot;] [msg &quot;Invalid HTTP Request
</I>&gt;<i>Line&quot;] [data &quot;CONNECT
</I>&gt;<i><A HREF="http://scanmail.trustwave.com/?c=4062&amp;d=5uDY1ObqUZnGj7BGQHeiLo2p2q3I23ooYo">http://scanmail.trustwave.com/?c=4062&amp;d=5uDY1ObqUZnGj7BGQHeiLo2p2q3I23ooYo</A>
</I>&gt;<i>BRCWUwLA&amp;s=5&amp;u=http%3a%2f%2fmx0%2email2000%2ecom%2etw%3a25 HTTP/1.0&quot;]
</I>&gt;<i>[severity
</I>&gt;<i>&quot;WARNING&quot;] [tag
</I>&gt;<i>&quot;<A HREF="http://scanmail.trustwave.com/?c=4062&amp;d=5uDY1ObqUZnGj7BGQHeiLo2p2q3I23ooY">http://scanmail.trustwave.com/?c=4062&amp;d=5uDY1ObqUZnGj7BGQHeiLo2p2q3I23ooY</A>
</I>&gt;<i>oBWDzBnfw&amp;s=5&amp;u=https%3a%2f%2fwww%2eowasp%2eorg%2findex%2ephp%2fModSecurit
</I>&gt;<i>y%5fCRS%5fRuleID-960911&quot;] [tag
</I>&gt;<i>&quot;<A HREF="http://scanmail.trustwave.com/?c=4062&amp;d=5uDY1ObqUZnGj7BGQHeiLo2p2q3I23ooY">http://scanmail.trustwave.com/?c=4062&amp;d=5uDY1ObqUZnGj7BGQHeiLo2p2q3I23ooY</A>
</I>&gt;<i>oNeUmIwLQ&amp;s=5&amp;u=http%3a%2f%2fwww%2ew3%2eorg%2fProtocols%2frfc2616%2frfc261
</I>&gt;<i>6-sec3%2ehtml%23sec3%2e2%2e1&quot;] [tag
</I>&gt;<i>&quot;RULE_MATURITY/8&quot;] [tag &quot;RULE_ACCURACY/8&quot;] [hostname
</I>&gt;<i>&quot;<A HREF="http://scanmail.trustwave.com/?c=4062&amp;d=5uDY1ObqUZnGj7BGQHeiLo2p2q3I23ooY">http://scanmail.trustwave.com/?c=4062&amp;d=5uDY1ObqUZnGj7BGQHeiLo2p2q3I23ooY</A>
</I>&gt;<i>t1XWGU8Kw&amp;s=5&amp;u=http%3a%2f%2fmx0%2email2000%2ecom%2etw&quot;] [uri &quot;/&quot;]
</I>&gt;<i>[unique_id &quot;VNXgVX8AAAEAAHqycsoAAAAC&quot;]
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>I tried the following in /etc/apache2/sites-available/default. Will this
</I>&gt;<i>work ?
</I>&gt;<i>&lt;VirtualHost *:80&gt;
</I>&gt;<i>.....
</I>&gt;<i>.....
</I>&gt;<i>&lt;/VirtualHost&gt;
</I>&gt;<i>
</I>&gt;<i>&lt;Files *&gt;
</I>&gt;<i>&lt;LimitExcept GET POST&gt;
</I>&gt;<i>deny from all
</I>&gt;<i>&lt;/LimitExcept&gt;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>Thanks.
</I>&gt;<i>_______________________________________________
</I>&gt;<i>Owasp-modsecurity-core-rule-set mailing list
</I>&gt;<i><A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>
</I>&gt;<i><A HREF="http://scanmail.trustwave.com/?c=4062&amp;d=5uDY1ObqUZnGj7BGQHeiLo2p2q3I23ooYt">http://scanmail.trustwave.com/?c=4062&amp;d=5uDY1ObqUZnGj7BGQHeiLo2p2q3I23ooYt</A>
</I>&gt;<i>BWUmVndg&amp;s=5&amp;u=https%3a%2f%2flists%2eowasp%2eorg%2fmailman%2flistinfo%2fow
</I>&gt;<i>asp-modsecurity-core-rule-set
</I>

________________________________

This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is strictly prohibited. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001728.html">[Owasp-modsecurity-core-rule-set] Questions about modsecurity_crs_11_dos_protection.conf
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1723">[ date ]</a>
              <a href="thread.html#1723">[ thread ]</a>
              <a href="subject.html#1723">[ subject ]</a>
              <a href="author.html#1723">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
