<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Questions about	modsecurity_crs_11_dos_protection.conf
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Questions%20about%0A%09modsecurity_crs_11_dos_protection.conf&In-Reply-To=%3CCAC%2BO4mFJM2b-rBLcU2EwQEt5nLnxAspOgwKimRmBTCYPu3SgPw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001725.html">
   <LINK REL="Next"  HREF="001727.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Questions about	modsecurity_crs_11_dos_protection.conf</H1>
    <B>Josh Amishav-Zlatin</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Questions%20about%0A%09modsecurity_crs_11_dos_protection.conf&In-Reply-To=%3CCAC%2BO4mFJM2b-rBLcU2EwQEt5nLnxAspOgwKimRmBTCYPu3SgPw%40mail.gmail.com%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] Questions about	modsecurity_crs_11_dos_protection.conf">jamuse at owasp.org
       </A><BR>
    <I>Wed Mar 11 08:37:30 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="001725.html">[Owasp-modsecurity-core-rule-set] Questions about	modsecurity_crs_11_dos_protection.conf
</A></li>
        <LI>Next message: <A HREF="001727.html">[Owasp-modsecurity-core-rule-set] Questions about modsecurity_crs_11_dos_protection.conf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1726">[ date ]</a>
              <a href="thread.html#1726">[ thread ]</a>
              <a href="subject.html#1726">[ subject ]</a>
              <a href="author.html#1726">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Barry,

FWIW, we've run into similar issues and re-implemented some rules to use
Redis for storage instead. This had to be implemented via Lua scripting
though, which takes a slight performance hit. Having said that, there is an
open ticket to implement an alternative shared persistent storage mechanism:

<A HREF="https://github.com/SpiderLabs/ModSecurity/issues/378">https://github.com/SpiderLabs/ModSecurity/issues/378</A>

--
 - Josh

On Wed, Mar 11, 2015 at 9:49 AM, Barry Pollard &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">barry_pollard at hotmail.com</A>&gt;
wrote:

&gt;<i> Thanks for those answers Chaim. Make sense to me.
</I>&gt;<i>
</I>&gt;<i> I do think the use of SDBM for storage for large scale tracking like for
</I>&gt;<i> IP addresses is a problem (with ModSecurity rather than with the core rule
</I>&gt;<i> set but not that that matters). Unfortunately it just doesn't work for even
</I>&gt;<i> relatively small amounts of traffic.
</I>&gt;<i>
</I>&gt;<i> Not sure how you could resolve it and I know nothing about ModSecurity is
</I>&gt;<i> written, or about writing really high performing systems like this, but
</I>&gt;<i> came up with below suggestions after a bit of a think. Not sure how
</I>&gt;<i> feasible any of these are.
</I>&gt;<i>
</I>&gt;<i> * Split out IP.pag into several files based on hashed IP address so bottle
</I>&gt;<i> neck is not on one file. Would need to be hashed IP address in case your
</I>&gt;<i> customer based is skewed towards certain IP ranges. Could also configure
</I>&gt;<i> number of files to split across, so busier sites have larger number of
</I>&gt;<i> IP.pag files, if the hashing algorithm could take that config number into
</I>&gt;<i> account.
</I>&gt;<i>
</I>&gt;<i> * Have a minimum update time e.g. If hit from IP in last 1 second then
</I>&gt;<i> don't bother saving another hit as record is reasonably up to date. Again
</I>&gt;<i> time could be configurable. Would obviously impact any DoS/Brute force
</I>&gt;<i> rules since we'd be filtering out hits here.
</I>&gt;<i>
</I>&gt;<i> * Make it easier to ignore the problem by ignoring certain alerts (e.g.
</I>&gt;<i> deleting stale collections fails... etc.) unless in high log level, and add
</I>&gt;<i> a safe way of ModSecurity clearing down the file and starting again at
</I>&gt;<i> certain times (e.g. daily/weekly) or after it reaches a certain size.
</I>&gt;<i> Massive fudge but could be short term solution.
</I>&gt;<i>
</I>&gt;<i> * Use some other persistent storage. Though I'd imagine, given the
</I>&gt;<i> potential rate of data updates for a busy site, this would also be a
</I>&gt;<i> problem in whatever we move to.
</I>&gt;<i>
</I>&gt;<i> * Use in-memory storage - though guess that would raise questions on
</I>&gt;<i> memory requirements and how to share between different threads/processes.
</I>&gt;<i>
</I>&gt;<i> * Have dedicated process/program to manage collections that all other
</I>&gt;<i> threads/processes talk via. Could address some of the issues with in using
</I>&gt;<i> in-memory storage raised above. Then again could bring in whole raft of
</I>&gt;<i> other problems :-)
</I>&gt;<i>
</I>&gt;<i> * Store less. Collections do seem to be quite large. Could you have a
</I>&gt;<i> minimal set for things like IP address with just last access time/num hits?
</I>&gt;<i> For rules that require more things tracked (e.g. Brute force attempts on a
</I>&gt;<i> specific URL) they could be tracked in a separate &quot;full&quot; collection which
</I>&gt;<i> would have a larger record set, but with less entries.
</I>&gt;<i>
</I>&gt;<i> * Reduce blocking time in code making the SDBM update. Imagine the code is
</I>&gt;<i> probably pretty tight here already but obviously any reduction here would
</I>&gt;<i> have benefit. Had a quick look myself (more out of nosiness) but the C code
</I>&gt;<i> scared me too much (been a while!).
</I>&gt;<i>
</I>&gt;<i> * Look into how other modules (e.g. mod_evasive) handle this problem to
</I>&gt;<i> see if can learn anything from them.
</I>&gt;<i>
</I>&gt;<i> Am sure you've probably already considered these and better solutions but
</I>&gt;<i> thought I'd suggest them anyway.
</I>&gt;<i>
</I>&gt;<i> Thanks,
</I>&gt;<i> Barry
</I>&gt;<i>
</I>&gt;<i> &gt; On 11 Mar 2015, at 03:54, Chaim Sanders &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">CSanders at trustwave.com</A>&gt; wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; we
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Owasp-modsecurity-core-rule-set mailing list
</I>&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>
</I>&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20150311/baca12a5/attachment-0001.html">http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20150311/baca12a5/attachment-0001.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001725.html">[Owasp-modsecurity-core-rule-set] Questions about	modsecurity_crs_11_dos_protection.conf
</A></li>
	<LI>Next message: <A HREF="001727.html">[Owasp-modsecurity-core-rule-set] Questions about modsecurity_crs_11_dos_protection.conf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1726">[ date ]</a>
              <a href="thread.html#1726">[ thread ]</a>
              <a href="subject.html#1726">[ subject ]</a>
              <a href="author.html#1726">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
