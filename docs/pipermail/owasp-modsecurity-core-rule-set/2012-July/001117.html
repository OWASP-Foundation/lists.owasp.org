<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could not set variable &quot;ip.dos_counter&quot; as the collection does not exist.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20DOS_Protection%20Problem%3A%20Could%0A%20not%20set%20variable%20%22ip.dos_counter%22%20as%20the%20collection%20does%20not%20exist.&In-Reply-To=%3CCC266099.A9A7%25powster%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001116.html">
   <LINK REL="Next"  HREF="001118.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could not set variable &quot;ip.dos_counter&quot; as the collection does not exist.</H1>
    <B>JPow (powster)</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20DOS_Protection%20Problem%3A%20Could%0A%20not%20set%20variable%20%22ip.dos_counter%22%20as%20the%20collection%20does%20not%20exist.&In-Reply-To=%3CCC266099.A9A7%25powster%40gmail.com%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could not set variable &quot;ip.dos_counter&quot; as the collection does not exist.">powster at gmail.com
       </A><BR>
    <I>Fri Jul 13 15:39:21 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="001116.html">[Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could not set variable &quot;ip.dos_counter&quot; as the collection does not exist.
</A></li>
        <LI>Next message: <A HREF="001118.html">[Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could not set variable &quot;ip.dos_counter&quot; as the collection does not exist.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1117">[ date ]</a>
              <a href="thread.html#1117">[ thread ]</a>
              <a href="subject.html#1117">[ subject ]</a>
              <a href="author.html#1117">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Ryan,

Thanks for the tip. I tried adding this to the end of the 10_setup.conf:

SecRule REQUEST_LINE &quot;^(GET /|OPTIONS \*) HTTP/1.0$&quot;
&quot;phase:1,allow,nolog,chain,t:none&quot;
        SecRule REMOTE_ADDR &quot;^(127\.0\.0\.|\:\:)1$&quot; &quot;chain, t:none&quot;
                SecRule REQUEST_HEADERS:User-Agent &quot;^Apache.*\(internal
dummy connection\)$&quot;

Restarted apache and still kept getting:
DEBUG: [13/Jul/2012:15:34:13 +0000]
[ip-10-128-81-72.ap-southeast-1.compute.internal/sid#7f5fdc6a0370][rid#7f5fd
f6310a0][*][3] Could not set variable &quot;ip.dos_counter&quot; as the collection
does not exist.
AUDIT:
--fe256340-A--
[13/Jul/2012:15:34:14 +0000] UAA-9gqAUUgAAB9cIOwAAAAH 127.0.0.1 34888
127.0.0.1 80
--fe256340-B--
OPTIONS * HTTP/1.0
User-Agent: Apache (internal dummy connection)

--fe256340-F--
HTTP/1.1 200 OK
Content-Length: 0
Connection: close

--fe256340-H--
Message: Could not set variable &quot;ip.dos_counter&quot; as the collection does not
exist.
Stopwatch: 1342193654146888 832 (- - -)
Stopwatch2: 1342193654146888 832; combined=275, p1=0, p2=0, p3=0, p4=0,
p5=274, sr=0, sw=1, l=0, gc=0
Producer: ModSecurity for Apache/2.6.3 (<A HREF="http://www.modsecurity.org/">http://www.modsecurity.org/</A>);
OWASP_CRS/2.2.5; OWASP_CRS/2.2.5.
Server: Apache

--fe256340-Z--

Thinking that maybe the &quot;chaining&quot; of the rules was preventing a match, I
tried the following rules, all UNCHAINED (again, appended at the end of
10_setup.conf)
SecRule REQUEST_LINE &quot;^(GET /|OPTIONS \*) HTTP/1.0$&quot; &quot;phase:1,allow,nolog&quot;
        SecRule REMOTE_ADDR &quot;^(127\.0\.0\.|\:\:)1$&quot; &quot;phase:1,allow,nolog&quot;
                SecRule REQUEST_HEADERS:User-Agent &quot;^Apache.*\(internal
dummy connection\)$&quot; &quot;phase:1,allow,nolog&quot;

Result: Still kept getting the same errors.


Am I doing something wrongly? Is appending the rules to 10_setup.conf wrong?
Is there something wrong with the rules, which inadvertently allows the
apache internal dummy connection through?

Thank you so much.

JPow
From:  Ryan Barnett &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">RBarnett at trustwave.com</A>&gt;
Date:  Friday, July 13, 2012 10:11 PM
To:  Jingxun Pow &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">powster at gmail.com</A>&gt;,
&quot;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&quot;
&lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;
Subject:  Re: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem:
Could not set variable &quot;ip.dos_counter&quot; as the collection does not exist.

The rules in the 47 common exceptions file will only adjust the anomaly
scores.  You could take these rules and place them into local 15 files and
add the &quot;alllow&quot; action to them.

-- 
Ryan Barnett
Trustwave SpiderLabs
ModSecurity Project Leader
OWASP ModSecurity CRS Project Leader

From: &quot;JPow (powster)&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">powster at gmail.com</A>&gt;
Date: Fri, 13 Jul 2012 09:01:11 -0500
To: &quot;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&quot;
&lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;
Subject: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could not
set variable &quot;ip.dos_counter&quot; as the collection does not exist.

&gt;<i> Hi there,
</I>&gt;<i> 
</I>&gt;<i> I am facing a problem where I get &quot;Could not set variable &quot;ip.dos_counter&quot; as
</I>&gt;<i> the collection does not exist.&quot; debug output when using the dos_protection
</I>&gt;<i> rule set ( &quot;modsecurity_crs_11_dos_protection.conf&quot;).
</I>&gt;<i> * DOS_Protection works as it should, so no issues with that (I have
</I>&gt;<i> uncommented the relevant lines in the crs_10_setup.conf, as well as properly
</I>&gt;<i> linked up the crs_11_dos_protection.conf
</I>&gt;<i> * However, I find that the debug is littered with &quot;Could not set variable
</I>&gt;<i> &quot;ip.dos_counter&quot; as the collection does not exist.&quot;
</I>&gt;<i> * I've realized that this is NOT a problem with INITCOL:IP not being called in
</I>&gt;<i> the setup conf file --&gt; This works properly (I am using the default
</I>&gt;<i> crs_10_setup.conf)
</I>&gt;<i> * The issue ONLY occurs with Apache (internal dummy connection) (see below
</I>&gt;<i> debug / audit output)
</I>&gt;&gt;<i> * If you see below Audit Output, it is not a standard &quot;GET&quot; request.
</I>&gt;&gt;<i> * From my understanding, Apache's internal dummy connections are just done by
</I>&gt;&gt;<i> Apache to wake up its child processes.
</I>&gt;<i> * I am puzzled why this happens, because I thought there already is an
</I>&gt;<i> exception for Apache internal dummy connections in 47 common_exceptions.conf?
</I>&gt;<i> Any reason why these dummy connections are still causing the error messages in
</I>&gt;<i> the debug? And if so, how to solve this issue?
</I>&gt;<i> 
</I>&gt;<i> Thanks!
</I>&gt;<i> 
</I>&gt;<i> My system:
</I>&gt;<i> -Ubuntu 12.04 on Amazon EC2
</I>&gt;<i> -Apache 2.6.3 Mod_Security
</I>&gt;<i> -OWASP_CRS/2.2.5.
</I>&gt;<i> 
</I>&gt;<i> Debug output:
</I>&gt;<i> [13/Jul/2012:13:29:46 +0000]
</I>&gt;<i> [ip-XX-XXX-XX-XX.ap-southeast-1.compute.internal/sid#7f40d4a48370][rid#7f40d64
</I>&gt;<i> c60a0][*][3] Could not set variable &quot;ip.dos_counter&quot; as the collection does
</I>&gt;<i> not exist.
</I>&gt;<i> 
</I>&gt;<i> Audit Output:
</I>&gt;<i> --695eef13-A--
</I>&gt;<i> [13/Jul/2012:13:29:46 +0000] UAAiygqAUUgAABqMEm0AAAAE 127.0.0.1 34716
</I>&gt;<i> 127.0.0.1 80
</I>&gt;<i> --695eef13-B--
</I>&gt;<i> OPTIONS * HTTP/1.0
</I>&gt;<i> User-Agent: Apache (internal dummy connection)
</I>&gt;<i> 
</I>&gt;<i> --695eef13-F--
</I>&gt;<i> HTTP/1.1 200 OK
</I>&gt;<i> Content-Length: 0
</I>&gt;<i> Connection: close
</I>&gt;<i> 
</I>&gt;<i> --695eef13-H--
</I>&gt;<i> Message: Could not set variable &quot;ip.dos_counter&quot; as the collection does not
</I>&gt;<i> exist.
</I>&gt;<i> Stopwatch: 1342186186315250 284 (- - -)
</I>&gt;<i> Stopwatch2: 1342186186315250 284; combined=119, p1=0, p2=0, p3=0, p4=0,
</I>&gt;<i> p5=118, sr=0, sw=1, l=0, gc=0
</I>&gt;<i> Producer: ModSecurity for Apache/2.6.3 (<A HREF="http://www.modsecurity.org/">http://www.modsecurity.org/</A>);
</I>&gt;<i> OWASP_CRS/2.2.5; OWASP_CRS/2.2.5.
</I>&gt;<i> Server: Apache
</I>&gt;<i> 
</I>&gt;<i> --695eef13-Z--
</I>

This transmission may contain information that is privileged, confidential,
and/or exempt from disclosure under applicable law. If you are not the
intended recipient, you are hereby notified that any disclosure, copying,
distribution, or use of the information contained herein (including any
reliance thereon) is STRICTLY PROHIBITED. If you received this transmission
in error, please immediately contact the sender and destroy the material in
its entirety, whether in electronic or hard copy format.


-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120713/44248054/attachment-0001.html">http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120713/44248054/attachment-0001.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001116.html">[Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could not set variable &quot;ip.dos_counter&quot; as the collection does not exist.
</A></li>
	<LI>Next message: <A HREF="001118.html">[Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could not set variable &quot;ip.dos_counter&quot; as the collection does not exist.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1117">[ date ]</a>
              <a href="thread.html#1117">[ thread ]</a>
              <a href="subject.html#1117">[ subject ]</a>
              <a href="author.html#1117">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
