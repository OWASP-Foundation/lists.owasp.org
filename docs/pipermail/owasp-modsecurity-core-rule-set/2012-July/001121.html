<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could not set variable &quot;ip.dos_counter&quot; as the collection does not exist.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20DOS_Protection%20Problem%3A%20Could%0A%20not%20set%20variable%20%22ip.dos_counter%22%20as%20the%20collection%20does%20not%20exist.&In-Reply-To=%3CCC25D098.562B1%25rbarnett%40trustwave.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001120.html">
   <LINK REL="Next"  HREF="001122.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could not set variable &quot;ip.dos_counter&quot; as the collection does not exist.</H1>
    <B>Ryan Barnett</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20DOS_Protection%20Problem%3A%20Could%0A%20not%20set%20variable%20%22ip.dos_counter%22%20as%20the%20collection%20does%20not%20exist.&In-Reply-To=%3CCC25D098.562B1%25rbarnett%40trustwave.com%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could not set variable &quot;ip.dos_counter&quot; as the collection does not exist.">RBarnett at trustwave.com
       </A><BR>
    <I>Fri Jul 13 17:19:21 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="001120.html">[Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could not set variable &quot;ip.dos_counter&quot; as the collection does not exist.
</A></li>
        <LI>Next message: <A HREF="001122.html">[Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could not set variable &quot;ip.dos_counter&quot; as the collection does not exist.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1121">[ date ]</a>
              <a href="thread.html#1121">[ thread ]</a>
              <a href="subject.html#1121">[ subject ]</a>
              <a href="author.html#1121">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Update the rules to use the ctl action to disable the SecRuleEngine -


SecRule REQUEST_LINE &quot;^(GET /|OPTIONS \*) HTTP/1.0$&quot; &quot;phase:1,allow,nolog,chain,t:none&quot;
        SecRule REMOTE_ADDR &quot;^(127\.0\.0\.|\:\:)1$&quot; &quot;chain, t:none&quot;
                SecRule REQUEST_HEADERS:User-Agent &quot;^Apache.*\(internal dummy connection\)$&quot; &quot;ctl:ruleEngine=Off&quot;


-Ryan

From: &quot;JPow (powster)&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">powster at gmail.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">powster at gmail.com</A>&gt;&gt;
Date: Fri, 13 Jul 2012 12:17:03 -0500
To: Ryan Barnett &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">rbarnett at trustwave.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">rbarnett at trustwave.com</A>&gt;&gt;, &quot;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&gt;
Subject: Re: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could not set variable &quot;ip.dos_counter&quot; as the collection does not exist.

Hi Ryan,

Sorry to bother again. After leaving the server running for awhile, I realized I was facing the same problem even after incorporating suggestions below.

I realized the problem after looking through debug level 9 logs:

modsecurity_crs_11_dos_protection.conf has rules that are in PHASE:5. These Phase 5 rules are the ones that increase the ip.dos counters.

Since these rules are in Phase 5, they will be run regardless of whether the ALLOW action is provided for apache internal relay transactions.

Since the &quot;allow&quot; method doesn't work for Phase 5, is there anyway to provide exceptions for these cases?

Thanks,
JPow

From: Ryan Barnett &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">RBarnett at trustwave.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">RBarnett at trustwave.com</A>&gt;&gt;
Date: Friday, July 13, 2012 11:44 PM
To: Jingxun Pow &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">powster at gmail.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">powster at gmail.com</A>&gt;&gt;, &quot;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&gt;
Subject: Re: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could not set variable &quot;ip.dos_counter&quot; as the collection does not exist.



From: &quot;JPow (powster)&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">powster at gmail.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">powster at gmail.com</A>&gt;&gt;
Date: Fri, 13 Jul 2012 10:39:21 -0500
To: Ryan Barnett &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">rbarnett at trustwave.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">rbarnett at trustwave.com</A>&gt;&gt;, &quot;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&gt;
Subject: Re: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could not set variable &quot;ip.dos_counter&quot; as the collection does not exist.

Hi Ryan,

Thanks for the tip. I tried adding this to the end of the 10_setup.conf:

SecRule REQUEST_LINE &quot;^(GET /|OPTIONS \*) HTTP/1.0$&quot; &quot;phase:1,allow,nolog,chain,t:none&quot;
        SecRule REMOTE_ADDR &quot;^(127\.0\.0\.|\:\:)1$&quot; &quot;chain, t:none&quot;
                SecRule REQUEST_HEADERS:User-Agent &quot;^Apache.*\(internal dummy connection\)$&quot;

I would add this before the [[ Global and IP Collections ]] rules.

Also &#8211; is your SecRuleEngine set to On?  It needs to be to use the allow action.

-Ryan



Restarted apache and still kept getting:
DEBUG: [13/Jul/2012:15:34:13 +0000] [ip-10-128-81-72.ap-southeast-1.compute.internal/sid#7f5fdc6a0370][rid#7f5fdf6310a0][*][3] Could not set variable &quot;ip.dos_counter&quot; as the collection does not exist.
AUDIT:
--fe256340-A--
[13/Jul/2012:15:34:14 +0000] UAA-9gqAUUgAAB9cIOwAAAAH 127.0.0.1 34888 127.0.0.1 80
--fe256340-B--
OPTIONS * HTTP/1.0
User-Agent: Apache (internal dummy connection)

--fe256340-F--
HTTP/1.1 200 OK
Content-Length: 0
Connection: close

--fe256340-H--
Message: Could not set variable &quot;ip.dos_counter&quot; as the collection does not exist.
Stopwatch: 1342193654146888 832 (- - -)
Stopwatch2: 1342193654146888 832; combined=275, p1=0, p2=0, p3=0, p4=0, p5=274, sr=0, sw=1, l=0, gc=0
Producer: ModSecurity for Apache/2.6.3 (<A HREF="http://www.modsecurity.org/">http://www.modsecurity.org/</A>); OWASP_CRS/2.2.5; OWASP_CRS/2.2.5.
Server: Apache

--fe256340-Z--

Thinking that maybe the &quot;chaining&quot; of the rules was preventing a match, I tried the following rules, all UNCHAINED (again, appended at the end of 10_setup.conf)
SecRule REQUEST_LINE &quot;^(GET /|OPTIONS \*) HTTP/1.0$&quot; &quot;phase:1,allow,nolog&quot;
        SecRule REMOTE_ADDR &quot;^(127\.0\.0\.|\:\:)1$&quot; &quot;phase:1,allow,nolog&quot;
                SecRule REQUEST_HEADERS:User-Agent &quot;^Apache.*\(internal dummy connection\)$&quot; &quot;phase:1,allow,nolog&quot;

Result: Still kept getting the same errors.


Am I doing something wrongly? Is appending the rules to 10_setup.conf wrong?
Is there something wrong with the rules, which inadvertently allows the apache internal dummy connection through?

Thank you so much.

JPow
From: Ryan Barnett &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">RBarnett at trustwave.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">RBarnett at trustwave.com</A>&gt;&gt;
Date: Friday, July 13, 2012 10:11 PM
To: Jingxun Pow &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">powster at gmail.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">powster at gmail.com</A>&gt;&gt;, &quot;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&gt;
Subject: Re: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could not set variable &quot;ip.dos_counter&quot; as the collection does not exist.

The rules in the 47 common exceptions file will only adjust the anomaly scores.  You could take these rules and place them into local 15 files and add the &quot;alllow&quot; action to them.

--
Ryan Barnett
Trustwave SpiderLabs
ModSecurity Project Leader
OWASP ModSecurity CRS Project Leader

From: &quot;JPow (powster)&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">powster at gmail.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">powster at gmail.com</A>&gt;&gt;
Date: Fri, 13 Jul 2012 09:01:11 -0500
To: &quot;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&gt;
Subject: [Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could not set variable &quot;ip.dos_counter&quot; as the collection does not exist.

Hi there,

I am facing a problem where I get &quot;Could not set variable &quot;ip.dos_counter&quot; as the collection does not exist.&quot; debug output when using the dos_protection rule set ( &quot;modsecurity_crs_11_dos_protection.conf&quot;).

 *   DOS_Protection works as it should, so no issues with that (I have uncommented the relevant lines in the crs_10_setup.conf, as well as properly linked up the crs_11_dos_protection.conf
 *   However, I find that the debug is littered with &quot;Could not set variable &quot;ip.dos_counter&quot; as the collection does not exist.&quot;
 *   I've realized that this is NOT a problem with INITCOL:IP not being called in the setup conf file --&gt; This works properly (I am using the default crs_10_setup.conf)
 *   The issue ONLY occurs with Apache (internal dummy connection) (see below debug / audit output)
    *   If you see below Audit Output, it is not a standard &quot;GET&quot; request.
    *   From my understanding, Apache's internal dummy connections are just done by Apache to wake up its child processes.
 *   I am puzzled why this happens, because I thought there already is an exception for Apache internal dummy connections in 47 common_exceptions.conf?

Any reason why these dummy connections are still causing the error messages in the debug? And if so, how to solve this issue?

Thanks!

My system:
-Ubuntu 12.04 on Amazon EC2
-Apache 2.6.3 Mod_Security
-OWASP_CRS/2.2.5.

Debug output:
[13/Jul/2012:13:29:46 +0000] [ip-XX-XXX-XX-XX.ap-southeast-1.compute.internal/sid#7f40d4a48370][rid#7f40d64c60a0][*][3] Could not set variable &quot;ip.dos_counter&quot; as the collection does not exist.

Audit Output:
--695eef13-A--
[13/Jul/2012:13:29:46 +0000] UAAiygqAUUgAABqMEm0AAAAE 127.0.0.1 34716 127.0.0.1 80
--695eef13-B--
OPTIONS * HTTP/1.0
User-Agent: Apache (internal dummy connection)

--695eef13-F--
HTTP/1.1 200 OK
Content-Length: 0
Connection: close

--695eef13-H--
Message: Could not set variable &quot;ip.dos_counter&quot; as the collection does not exist.
Stopwatch: 1342186186315250 284 (- - -)
Stopwatch2: 1342186186315250 284; combined=119, p1=0, p2=0, p3=0, p4=0, p5=118, sr=0, sw=1, l=0, gc=0
Producer: ModSecurity for Apache/2.6.3 (<A HREF="http://www.modsecurity.org/">http://www.modsecurity.org/</A>); OWASP_CRS/2.2.5; OWASP_CRS/2.2.5.
Server: Apache

--695eef13-Z--

________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.

________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.

________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120713/80df6b2d/attachment-0001.html">http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120713/80df6b2d/attachment-0001.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001120.html">[Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could not set variable &quot;ip.dos_counter&quot; as the collection does not exist.
</A></li>
	<LI>Next message: <A HREF="001122.html">[Owasp-modsecurity-core-rule-set] DOS_Protection Problem: Could not set variable &quot;ip.dos_counter&quot; as the collection does not exist.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1121">[ date ]</a>
              <a href="thread.html#1121">[ thread ]</a>
              <a href="subject.html#1121">[ subject ]</a>
              <a href="author.html#1121">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
