<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Session Highjacking Rules, Existence of Variable Collection
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Session%20Highjacking%20Rules%2C%0A%20Existence%20of%20Variable%20Collection&In-Reply-To=%3C53160E50.8070809%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001505.html">
   <LINK REL="Next"  HREF="001507.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Session Highjacking Rules, Existence of Variable Collection</H1>
    <B>Ramy Darwish</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Session%20Highjacking%20Rules%2C%0A%20Existence%20of%20Variable%20Collection&In-Reply-To=%3C53160E50.8070809%40gmail.com%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] Session Highjacking Rules, Existence of Variable Collection">jackbro.pluckah at gmail.com
       </A><BR>
    <I>Tue Mar  4 17:33:04 UTC 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="001505.html">[Owasp-modsecurity-core-rule-set] Session Highjacking Rules, Existence of Variable Collection
</A></li>
        <LI>Next message: <A HREF="001507.html">[Owasp-modsecurity-core-rule-set] Session Highjacking Rules, Existence of Variable Collection
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1506">[ date ]</a>
              <a href="thread.html#1506">[ thread ]</a>
              <a href="subject.html#1506">[ subject ]</a>
              <a href="author.html#1506">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Ryan, thank you very much for your answer.

Indeed, that line checks for an existing session cookie for all rules
until the END_SESSION_STARTUP marker, and it performs as expected.
I was referring to the last two rules (981063 and 981064, lines 47 and 49),
which will try to setvar even when the SESSION collection hasn't yet been
initialized (e.g. for session-less users, like bots or anonymous users).
This results in two &quot;collection does not exist&quot; errors per transaction.
Not very serious, but quite a bit of log noise :p

Another small issue:
I also noticed that because I run Modsecurity in embedded mode,
a lot of response headers aren't yet &quot;released&quot; by Apache on phase 3.
That includes the Set-Cookie header, which is vital for rule 981062.

But I managed to solve these issues by making the following
3 important modifications for my use case:

- Modify the regex to fit my Session Cookie name
   (that's to be expected, of course)

- Move execution of rules 981062 (Session creation),
   981063 and 981064 (IP and UA Hash creation) to phase 5:
   Since they are all non-disruptive, and because the Set-Cookie
   response headers are only available at the logging phase
   for embedded installs, this enables successful session
   initialization for all install modes!

- Execute rules 981063 and 981064 with a session existence test:
   . That way, IP and UA hashes are only created for an existing session,
     or one that was just created by the previous 981062 rule.
     No more errors for session-less navigation.
   . I came up with the following session existence test:
     SecRule &amp;SESSION:SESSIONID &quot;@eq 1&quot; &quot;chain...&quot;
   . Apparently, it's important that this test be the first in chain,
     so as to prevent the errors showing up (maybe the rule is parsed
     without being executed when further down the chain? I'm not sure...)

Anyways, this is how I re-wrote the 981062, 981063 and 981064 rules:
<A HREF="http://pastebin.com/raw.php?i=4X5eh2nJ">http://pastebin.com/raw.php?i=4X5eh2nJ</A>

Is it a smart and sound resolution of my problem?
Am I in the wrong regarding best practices?
So far (well, since yesterday), it has been working very well for me!

Thank you again for taking the time, much appreciated =)

-------------------------------------------------------------------------------------------------
On 04/03/2014 16:53, Ryan Barnett wrote:
&gt;<i> What CRS version are you running?  In the current verion (2.2.9) in GitHub
</I>&gt;<i> repo, there is this line -
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://github.com/SpiderLabs/owasp-modsecurity-crs/blob/master/optional_ru">https://github.com/SpiderLabs/owasp-modsecurity-crs/blob/master/optional_ru</A>
</I>&gt;<i> les/modsecurity_crs_16_session_hijacking.conf#L27
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> This checks the inbound request for the existence of popular SessionID
</I>&gt;<i> cookie names.  If they are NOT found, then it will skip the inbound
</I>&gt;<i> session hijacking checks.
</I>&gt;<i>
</I>&gt;<i> Ryan Barnett
</I>&gt;<i> Lead Security Researcher, SpiderLabs
</I>&gt;<i>
</I>&gt;<i> Trustwave | SMART SECURITY ON DEMAND
</I>&gt;<i> www.trustwave.com &lt;<A HREF="http://www.trustwave.com/">http://www.trustwave.com/</A>&gt;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On 3/3/14 1:18 PM, &quot;Ramy Darwish&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">jackbro.pluckah at gmail.com</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Reposting as plain text for formatting...
</I>&gt;&gt;<i> ------------------------------------------------------------
</I>&gt;&gt;<i> Hi everyone!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm trying to fit the Session Highjacking rules
</I>&gt;&gt;<i> (modsecurity_crs_16_session_hijacking.conf) to my web app.
</I>&gt;&gt;<i> My problem was described by someone else (but apparently never solved)
</I>&gt;&gt;<i> on that older post on the modsecurity-users list:
</I>&gt;&gt;<i> <A HREF="http://sourceforge.net/p/mod-security/mailman/message/30069414/">http://sourceforge.net/p/mod-security/mailman/message/30069414/</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The Session Highjacking rules look at request and response cookies to
</I>&gt;&gt;<i> find or create a new sessions.
</I>&gt;&gt;<i> That works perfectly.
</I>&gt;&gt;<i> However, the two rules after it will run in ANY case, even when no
</I>&gt;&gt;<i> sessions has been initialized:
</I>&gt;&gt;<i> -----------------------------------------
</I>&gt;&gt;<i> SecRule REMOTE_ADDR
</I>&gt;&gt;<i> &quot;^(\d{1,3}\.\d{1,3}\.\d{1,3}\.)&quot;&quot;chain,phase:3,id:'981063',capture,t:none,
</I>&gt;&gt;<i> nolog,pass&quot;
</I>&gt;&gt;<i>      SecRule TX:1
</I>&gt;&gt;<i> &quot;.*&quot;&quot;t:sha1,t:hexEncode,setvar:session.ip_hash=%{matched_var}&quot;
</I>&gt;&gt;<i> SecRule REQUEST_HEADERS:User-Agent
</I>&gt;&gt;<i> &quot;.*&quot;&quot;phase:3,id:'981064',t:none,t:sha1,t:hexEncode,nolog,pass,setvar:sessi
</I>&gt;&gt;<i> on.ua_hash=%{matched_var}&quot;
</I>&gt;&gt;<i> -----------------------------------------
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Because the session collection wasn't initialized (e.g. for anonymous
</I>&gt;&gt;<i> users or bots),
</I>&gt;&gt;<i> the setvars fail and the log is filled with errors like:
</I>&gt;&gt;<i> -----------------------------------------
</I>&gt;&gt;<i> [example.com/sid#7fc5067fe380][rid#7fc4f43380a0][/path/to/file][3] Could
</I>&gt;&gt;<i> not set variable &quot;session.ip_hash&quot; as the collection does not exist.
</I>&gt;&gt;<i> [example.com/sid#7fc5067fe380][rid#7fc4f43380a0][/path/to/file][3] Could
</I>&gt;&gt;<i> not set variable &quot;session.ua_hash&quot; as the collection does not exist.
</I>&gt;&gt;<i> -----------------------------------------
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> To avoid this problem, I would like to chain these rules with a
</I>&gt;&gt;<i> Collection existence check, to avoid non-existence errors.
</I>&gt;&gt;<i> My two questions:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    1/ I don't know how to test for the existence of the session
</I>&gt;&gt;<i> collection.
</I>&gt;&gt;<i>       I don't know if it makes a difference that the rule is parsed on
</I>&gt;&gt;<i> phase 3 (response headers).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    2/ More importantly, it seems like  even chaining it to an impossible
</I>&gt;&gt;<i> rule
</I>&gt;&gt;<i>       (e.g. SecRule &amp;ARGS:x58t4z5 &quot;@gt 128&quot;) will not stop it from
</I>&gt;&gt;<i> logging these errors!
</I>&gt;&gt;<i>       Maybe I misunderstood chaining or variable collections, but I
</I>&gt;&gt;<i> can't seem to comprehend this issue!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If anyone can enlighten me on either or both, I'd be delighted to hear
</I>&gt;&gt;<i> your advice. Thanks!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Ramy
</I></PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001505.html">[Owasp-modsecurity-core-rule-set] Session Highjacking Rules, Existence of Variable Collection
</A></li>
	<LI>Next message: <A HREF="001507.html">[Owasp-modsecurity-core-rule-set] Session Highjacking Rules, Existence of Variable Collection
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1506">[ date ]</a>
              <a href="thread.html#1506">[ thread ]</a>
              <a href="subject.html#1506">[ subject ]</a>
              <a href="author.html#1506">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
