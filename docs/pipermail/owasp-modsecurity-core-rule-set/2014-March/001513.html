<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Rule id:981318 SQL Injection problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Rule%20id%3A981318%20SQL%20Injection%0A%20problem&In-Reply-To=%3Calpine.LRH.2.11.1403171304220.15079%40gacek.intertele.pl%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001511.html">
   <LINK REL="Next"  HREF="001514.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Rule id:981318 SQL Injection problem</H1>
    <B>Piotr Gackiewicz</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Rule%20id%3A981318%20SQL%20Injection%0A%20problem&In-Reply-To=%3Calpine.LRH.2.11.1403171304220.15079%40gacek.intertele.pl%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] Rule id:981318 SQL Injection problem">p.gackiewicz at intertele.pl
       </A><BR>
    <I>Mon Mar 17 14:01:36 UTC 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="001511.html">[Owasp-modsecurity-core-rule-set] Rule id:981318 SQL Injection problem
</A></li>
        <LI>Next message: <A HREF="001514.html">[Owasp-modsecurity-core-rule-set] Rule id:981318 SQL Injection problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1513">[ date ]</a>
              <a href="thread.html#1513">[ thread ]</a>
              <a href="subject.html#1513">[ subject ]</a>
              <a href="author.html#1513">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, 17 Mar 2014, Ramy Darwish wrote:

&gt;<i> Hi Piotr,
</I>&gt;<i>
</I>&gt;<i> In my experience, you need to use a utf8toUnicode transformation to properly 
</I>&gt;<i> map UTF8 strings to Unicode before the rule processes the input as Unicode, 
</I>&gt;<i> as well as fine-tune the urlDecodeUni transformation to properly normalize 
</I>&gt;<i> Central European Unicode characters.
</I>&gt;<i>
</I>&gt;<i> Provide a code point declaration for the urlDecodeUni transformation,
</I>&gt;<i> in order to properly normalize Unicode strings (in modsecurity.conf)
</I>&gt;<i> ---------------------------------------------------
</I>&gt;<i> # With the 1250 code point for Central Europe:
</I>&gt;<i> SecUnicodeMapFile /etc/modsecurity/unicode.mapping
</I>&gt;<i> SecUnicodeCodePage 1250
</I>&gt;<i> ---------------------------------------------------
</I>&gt;<i>
</I>&gt;<i> See these resources for more info:
</I>&gt;<i> http: //blog.spiderlabs.com/2011/06/modsecurity-advanced-topic-of-the-week-unicode-mapping-support.html
</I>
Thanks for the response.
Unfortunately, both You and  Ryan Barnett in:
&gt;<i> http: //blog.spiderlabs.com/2012/08/waf-normalization-and-i18n.html
</I>are probably missing the point.

This is not the problem with URI normalization/Best-Fit Mapping. This is a
problem with UTF8 multibyte characters, put into rule regexp,
matched with UTF8-unaware PCRE code.

These three multi-byte characters are UTF-8, widely used in
modsecurity_crs_41_sql_injection_attacks.conf:
&#180;&#8217;&#8216;

They are used in regex character list: [&#180;&#8217;&#8216;], which in effect, is:
[\xc2\xb4\xe2\x80\x99\xe2\x80\x98].  What does it mean?  &quot;Match one of these
8 characters from this list&quot;.  This is documented in audit log entry:

&gt;&gt;<i>  Message: Access denied with code 403 (phase 2).
</I>&gt;&gt;<i>  Pattern match &quot;(^[\&quot;'`\xc2\xb4\xe2\x80\x99\xe2\x80\x98;]+|[\&quot;'`\xc2\xb4\xe2\x80\x99\xe2\x80\x98;]+$)&quot;
</I>&gt;&gt;<i>  at ARGS:removeins. [file &quot;/etc/httpd/modsecurity.d/activated_rules/modsecurity_crs_41_sql_injection_attacks.conf&quot;]
</I>&gt;&gt;<i>  [line &quot;64&quot;] [id &quot;981318&quot;] [rev &quot;2&quot;] [msg &quot;SQL Injection Attack: Common Injection Testing Detected&quot;]
</I>&gt;&gt;<i>  [data &quot;Matched Data: \x99 found within ARGS:removeins: Odinstaluj aplikacj\xc4\x99&quot;]
</I>&gt;&gt;<i>  [severity &quot;CRITICAL&quot;] [ver &quot;OWASP_CRS/2.2.6&quot;] [maturity &quot;9&quot;] [accuracy &quot;8&quot;]
</I>&gt;&gt;<i>  [tag &quot;OWASP_CRS/WEB_ATTACK/SQL_INJECTION&quot;] [tag &quot;WASCTC/WASC-19&quot;]
</I>&gt;&gt;<i>  [tag &quot;OWASP_TOP_10/A1&quot;] [tag &quot;OWASP_AppSensor/CIE1&quot;] [tag &quot;PCI/6.5.2&quot;]
</I>

Setting SecUnicodeCodePage, SecUnicodeMapFile does not change anything. 
Despite setting SecUnicodeCodePage 1250, the same rule hits, with the same
&quot;Pattern match&quot;.


I have no experience with PCRE in C, but in man pcre:

UTF-8 AND UNICODE PROPERTY SUPPORT
...
        In order process UTF-8 strings, you must build PCRE to include UTF-8
support in the code, and, in addition,  you  must
        call  pcre_compile()  with  the PCRE_UTF8 option flag. When you do
this, both the pattern and any subject strings that
        are matched against it are treated as UTF-8 strings instead of just
strings of bytes.


There is no sign of PCRE_UTF8 options usage in mod_security code. Bingo!



I wrote four Perl one-liners, to
demonstrate the problem with UTF8-unaware Perl regular expressions:


1. incorrect match as in mod_security/OWASP 981318 rule:
$ perl -e '$str=&quot;&#281;&quot;; print(($str=~/[&#8217;]$/ ? &quot;match&quot; : &quot;no match&quot;).&quot;\n&quot;);'
match

2. the same code, but made regex utf8-aware with 'utf8' module:
$ perl -Mutf8 -e '$str=&quot;&#281;&quot;; print(($str=~/[&#8217;]$/ ? &quot;match&quot; : &quot;no match&quot;).&quot;\n&quot;);'
no match

3. almost self-explaining:
$ perl -Mutf8 -e '$str=&quot;&#8217;&quot;; print(($str=~/^[&#8217;]$/ ? &quot;match&quot; : &quot;no match&quot;).&quot;\n&quot;);'
match

4. But wait, what if we disable utf8 module? :
$ perl -e '$str=&quot;&#8217;&quot;; print(($str=~/^[&#8217;]$/ ? &quot;match&quot; : &quot;no match&quot;).&quot;\n&quot;);'
no match



Conclusion: either enable PCRE_UTF8 in mod_security code or modify rules to
reflect PCRE UTF8 unawareness.

Regards,

-- 
Piotr Gackiewicz
Intertele S.A. - operator system&#243;w ITL.PL i DOMENY.ITL.PL
al. T. Rejtana 10, 35-310 Rzesz&#243;w
TEL: +48 17 8507580, FAX: +48 17 8520275

<A HREF="http://www.itl.pl">http://www.itl.pl</A>       - niezawodne us&#322;ugi hostingowe
<A HREF="http://domeny.itl.pl">http://domeny.itl.pl</A>    - tanie domeny internetowe
<A HREF="http://www.intertele.pl">http://www.intertele.pl</A>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001511.html">[Owasp-modsecurity-core-rule-set] Rule id:981318 SQL Injection problem
</A></li>
	<LI>Next message: <A HREF="001514.html">[Owasp-modsecurity-core-rule-set] Rule id:981318 SQL Injection problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1513">[ date ]</a>
              <a href="thread.html#1513">[ thread ]</a>
              <a href="subject.html#1513">[ subject ]</a>
              <a href="author.html#1513">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
