<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Rule id:981318 SQL Injection	problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Rule%20id%3A981318%20SQL%20Injection%0A%09problem&In-Reply-To=%3CCAPrE0SaFUH3oJHPAvqUPwKjO9G-1zbK0teWYPF4KqfpiceUMmQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001514.html">
   <LINK REL="Next"  HREF="001510.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Rule id:981318 SQL Injection	problem</H1>
    <B>Paul McGarry</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Rule%20id%3A981318%20SQL%20Injection%0A%09problem&In-Reply-To=%3CCAPrE0SaFUH3oJHPAvqUPwKjO9G-1zbK0teWYPF4KqfpiceUMmQ%40mail.gmail.com%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] Rule id:981318 SQL Injection	problem">paul at paulmcgarry.com
       </A><BR>
    <I>Thu Mar 27 05:38:18 UTC 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="001514.html">[Owasp-modsecurity-core-rule-set] Rule id:981318 SQL Injection problem
</A></li>
        <LI>Next message: <A HREF="001510.html">[Owasp-modsecurity-core-rule-set] Skip Static Content
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1528">[ date ]</a>
              <a href="thread.html#1528">[ thread ]</a>
              <a href="subject.html#1528">[ subject ]</a>
              <a href="author.html#1528">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Ryan, Piotr and all,

I'm just trying to get my head round this thread, so I'd appreciate it if
you'd see whether the following is a reasonable summary:

(Below I refer to the U+0084 character as an example, but the same is true
for the other non-ascii characters in the rule)

Rule 981318 checks for the U+0084 character because some application
environments transliterate that to an apostrophe/single quote, not because
U+0084 'dangerous' in it's own right.

False positives occur because when processing the U+0084 character (\xc2\xb4
in UTF8) the PCRE interprets the \xc2\xb4 as individual bytes and will
trigger on any string where the first/last character's first/last byte
(respectively) is \xc2 or \xb4.

There isn't a direct fix for this PCRE multibyte issue but by::

1)Adding a t:utf8toUnicode to the 981318 rule it will cause any \xc2\xb4 in
the input to be transformed to a %u0084 representation internally.
2)Setting up the
 SecUnicodeMapFile /etc/apache2/unicode.mapping 20127
it will cause the %u0084 representation to be transliterated to an ascii
apostrophe/single quote

The U+0084 character in the 981318 is now unnecessary because any instances
of that in the input will now just appear to the rule as an apostrophe
covered elsewhere in the rule.
This allows us to remove the U+0084 from the rule and eliminate the
multibyte PCRE collision issue.

So, in essence, t:utf8toUnicode and SecUnicodeMapFile don't solve the
underlying PCRE problem per se but avoid needing to put multibyte data into
the PCRE for the rule to have the same effect.

So the best way to 'fix' rule 981318 would be to:
-Set up the SecUnicodeMapFile
-Add t:utf8toUnicode to the 981318 rule
-Remove the U+0084 (and other non-ascii) characters from the 981318 regex.

Does that make sense?

Similarly if you were ultra confident nothing in your application stack did
do U+0084 to 'single quote' transliteration (and for other characters) you
could just remove them from the 981318 rule.

Paul





On Tue, Mar 18, 2014 at 1:16 AM, Ryan Barnett &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">ryan.barnett at owasp.org</A>&gt;wrote:

&gt;<i> On 3/17/14 10:01 AM, &quot;Piotr Gackiewicz&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">p.gackiewicz at intertele.pl</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;<i> &gt;On Mon, 17 Mar 2014, Ramy Darwish wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt; Hi Piotr,
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; In my experience, you need to use a utf8toUnicode transformation to
</I>&gt;<i> &gt;&gt;properly
</I>&gt;<i> &gt;&gt; map UTF8 strings to Unicode before the rule processes the input as
</I>&gt;<i> &gt;&gt;Unicode,
</I>&gt;<i> &gt;&gt; as well as fine-tune the urlDecodeUni transformation to properly
</I>&gt;<i> &gt;&gt;normalize
</I>&gt;<i> &gt;&gt; Central European Unicode characters.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Provide a code point declaration for the urlDecodeUni transformation,
</I>&gt;<i> &gt;&gt; in order to properly normalize Unicode strings (in modsecurity.conf)
</I>&gt;<i> &gt;&gt; ---------------------------------------------------
</I>&gt;<i> &gt;&gt; # With the 1250 code point for Central Europe:
</I>&gt;<i> &gt;&gt; SecUnicodeMapFile /etc/modsecurity/unicode.mapping
</I>&gt;<i> &gt;&gt; SecUnicodeCodePage 1250
</I>&gt;<i> &gt;&gt; ---------------------------------------------------
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; See these resources for more info:
</I>&gt;<i> &gt;&gt; http:
</I>&gt;<i> &gt;&gt;//
</I>&gt;<i> blog.spiderlabs.com/2011/06/modsecurity-advanced-topic-of-the-week-unic
</I>&gt;<i> &gt;&gt;ode-mapping-support.html
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;Thanks for the response.
</I>&gt;<i> &gt;Unfortunately, both You and  Ryan Barnett in:
</I>&gt;<i> &gt;&gt; http: //blog.spiderlabs.com/2012/08/waf-normalization-and-i18n.html
</I>&gt;<i> &gt;are probably missing the point.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;This is not the problem with URI normalization/Best-Fit Mapping. This is a
</I>&gt;<i> &gt;problem with UTF8 multibyte characters, put into rule regexp,
</I>&gt;<i> &gt;matched with UTF8-unaware PCRE code.
</I>&gt;<i>
</I>&gt;<i> You are correct.  These rules were made prior to the UTF8/Unicode mapping
</I>&gt;<i> and transformation functions were added to the ModSecurity code.  These
</I>&gt;<i> regexes in the rules will be updated (in CRS v.3.0.0) to be quote (')
</I>&gt;<i> double-quote (&quot;) and backtick (`) characters instead.  The
</I>&gt;<i> SecUnicodeMapFile directive + t:utf8toUnicode.t:urlDecodeUni
</I>&gt;<i> transformation functions should then properly handle the data.
</I>&gt;<i>
</I>&gt;<i> -Ryan
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Owasp-modsecurity-core-rule-set mailing list
</I>&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>
</I>&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20140327/d74c1d31/attachment.html">http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20140327/d74c1d31/attachment.html</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001514.html">[Owasp-modsecurity-core-rule-set] Rule id:981318 SQL Injection problem
</A></li>
	<LI>Next message: <A HREF="001510.html">[Owasp-modsecurity-core-rule-set] Skip Static Content
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1528">[ date ]</a>
              <a href="thread.html#1528">[ thread ]</a>
              <a href="subject.html#1528">[ subject ]</a>
              <a href="author.html#1528">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
