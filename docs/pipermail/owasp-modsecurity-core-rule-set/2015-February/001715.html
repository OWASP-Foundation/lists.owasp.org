<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Exception for DoS rules for IP range
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Exception%20for%20DoS%20rules%20for%0A%20IP%20range&In-Reply-To=%3CDUB126-W72703CDF3B92149C44F101822F0%40phx.gbl%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001714.html">
   <LINK REL="Next"  HREF="001716.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Exception for DoS rules for IP range</H1>
    <B>Barry Pollard</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Exception%20for%20DoS%20rules%20for%0A%20IP%20range&In-Reply-To=%3CDUB126-W72703CDF3B92149C44F101822F0%40phx.gbl%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] Exception for DoS rules for IP range">barry_pollard at hotmail.com
       </A><BR>
    <I>Tue Feb 17 11:29:13 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="001714.html">[Owasp-modsecurity-core-rule-set] Exception for DoS rules for IP	range
</A></li>
        <LI>Next message: <A HREF="001716.html">[Owasp-modsecurity-core-rule-set] modsecurity not detecting php	reverse shell
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1715">[ date ]</a>
              <a href="thread.html#1715">[ thread ]</a>
              <a href="subject.html#1715">[ subject ]</a>
              <a href="author.html#1715">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Figured out this myself if anyone's interested.

You don't seem to have access to any variables or headers not specified in the rule arguments, so not as simple as adding a new rule filter (especially if you want to use other fields such as X-Forwarded-For header).

The best way I found was to put a rule in before with a ctl to remove the applicable rule:
&#160; SecRule REMOTE_ADDR &quot;^127\.0\.&quot; &quot;id:4,nolog,pass,ctl:ruleRemoveById=981044&quot;
And similarly for other rules or other criteria (e.g. X-Forward-By headers...etc).

The gives me flexibility to remove the rule based on exact criteria I want rather than complicating the rule itself.

BTW I've found Ivan Ristic's Mod Security Handbook a very good resource for learning Mod Security. Was initially worried it was too old as only covers up to ModSecurity 2.6 but seems to only be small changes since then so still very relevant. Main thing I've noticed is the id is now mandatory since 2.7. And first chapters are available free on feistyduck.com.

Thanks,
Barry

----------------------------------------
&gt;<i> From: <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">barry_pollard at hotmail.com</A>
</I>&gt;<i> To: <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>
</I>&gt;<i> Date: Fri, 13 Feb 2015 11:36:12 +0000
</I>&gt;<i> Subject: [Owasp-modsecurity-core-rule-set] Exception for DoS rules for IP range
</I>&gt;<i>
</I>&gt;<i> Is it possible to exclude modsecurity_crs_11_dos_protection.conf rules only for certain IP ranges?
</I>&gt;<i>
</I>&gt;<i> Our internal test suites are being flagged with this (as expected as they run a lot of tests in a short period of time) so I would like them excluded. However I want the other CRS tests to be included in case we add changes that cause issues with them (and also because ModSecurity is proving quite helpful in identifying issues in our code!).
</I>&gt;<i>
</I>&gt;<i> I also don't want to have to set SecRuleEngine to DetectionOnly in test, and ignore the DoS errors as there are a lot of them in the logs and could easily lead to real alerts being ignored.
</I>&gt;<i>
</I>&gt;<i> I could just not include this conf file on test environments but would prefer to keep my production and testing configuration the same, with a few exceptions I have based on environment variables (e.g. to have extra logging on in test). Or is there a way to only include files in Apache based on an environment variable?
</I>&gt;<i>
</I>&gt;<i> I also tried to use SecRuleRemoveByMsg but think that checks the actual rule message configured in the rule, rather than the one outputted after the rule runs, so below does not work to exclude 127.0.x.x IP addresses for example:
</I>&gt;<i>
</I>&gt;<i> #Remove internal IPs from DoS blocking so Testing can run scripts
</I>&gt;<i> SecRuleRemoveByMsg &quot;Denial of Service \(DoS\) Attack Identified from 127\.0&quot;
</I>&gt;<i> SecRuleRemoveByMsg &quot;Potential Denial of Service \(DoS\) Attack from 127\.0&quot;
</I>&gt;<i>
</I>&gt;<i> On a separate but related topic, why are these still marked as &quot;experimental&quot; rules rather than optional ones despite being over two years old? Is there a definition on this? Are there extra risks for the experimental rules that I should be aware of and are they not recommended for production use?
</I>&gt;<i>
</I>&gt;<i> Finally is there a way of searching the mail archives in case any of this has been asked before as going step by step through the posts on <A HREF="http://lists.owasp.org.pipermail/owasp-modsecurity-core-rule-set/">http://lists.owasp.org.pipermail/owasp-modsecurity-core-rule-set/</A> isn't the easiest.
</I>&gt;<i>
</I>&gt;<i> Thanks,
</I>&gt;<i> Barry
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Owasp-modsecurity-core-rule-set mailing list
</I>&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>
</I>&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set</A>
</I> 		 	   		  
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001714.html">[Owasp-modsecurity-core-rule-set] Exception for DoS rules for IP	range
</A></li>
	<LI>Next message: <A HREF="001716.html">[Owasp-modsecurity-core-rule-set] modsecurity not detecting php	reverse shell
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1715">[ date ]</a>
              <a href="thread.html#1715">[ thread ]</a>
              <a href="subject.html#1715">[ subject ]</a>
              <a href="author.html#1715">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
