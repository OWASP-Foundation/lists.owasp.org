<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Matched rule modification
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Matched%20rule%20modification&In-Reply-To=%3C20170531063203.GB1908%40arxnet.hu%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002370.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Matched rule modification</H1>
    <B>Ervin Heged&#252;s</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Matched%20rule%20modification&In-Reply-To=%3C20170531063203.GB1908%40arxnet.hu%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] Matched rule modification">airween at gmail.com
       </A><BR>
    <I>Wed May 31 06:32:03 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="002370.html">[Owasp-modsecurity-core-rule-set] Matched rule modification
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2371">[ date ]</a>
              <a href="thread.html#2371">[ thread ]</a>
              <a href="subject.html#2371">[ subject ]</a>
              <a href="author.html#2371">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Chaim,

many thanks for your detailed answer.

On Tue, May 30, 2017 at 09:15:53PM -0400, Chaim Sanders wrote:
&gt;<i> Hey Ervin,
</I>&gt;<i> Thanks for the report. It it is a combination of the curly and the word
</I>&gt;<i> 'sort' (<A HREF="https://regex101.com/r/oV5rl6/1">https://regex101.com/r/oV5rl6/1</A>). As you noted this is a new rule
</I>&gt;<i> to the 3.x branch. Put together based on the list available here:
</I>&gt;<i> <A HREF="https://github.com/SpiderLabs/owasp-modsecurity-crs/blob/v3.0/master/util/regexp-assemble/regexp-932115.txt.">https://github.com/SpiderLabs/owasp-modsecurity-crs/blob/v3.0/master/util/regexp-assemble/regexp-932115.txt.</A>
</I>&gt;<i> There is probably an argument to be made for removing 'sort' from this
</I>&gt;<i> list. 
</I>
you propose should I remove the &quot;sort&quot; word from that list, and
re-assemble the CSR? (I just grabbed the CSR rules, and made a
package for my Debian distros.)

&gt;<i> The other item of interest here is ModSecurity's pretty poor job at
</I>&gt;<i> being able to parse JSON (which this looks to be). In any event, I think it
</I>&gt;<i> is something we can probably address. At least for this version (3.0.2) you
</I>&gt;<i> can either add an exception for that argument to this rule (see below),
</I>
thanks, I'll check out your example.

&gt;<i>  or
</I>&gt;<i> rebuild the regex as outlined in the rule.
</I>
yep', now I reviewed the rule file, and I found the rebuild flow - thanks.

&gt;<i> If you wouldn't mind opening an
</I>&gt;<i> issue on our GitHub, we'll be able to have a more persistent log of the
</I>&gt;<i> issue and also be able to reach out to you if we have more questions. If
</I>&gt;<i> you don't have a GitHub or don't want to take the time I can also do it,
</I>&gt;<i> just let me know! Thanks!
</I>
I thank you - I have Github account (@airween), and I think that
would be bigger help to you, when I open a new issue. Just let me
know, what should I put the riport?

&gt;<i> SecRule REQUEST_URI &quot;@beginsWith /api/tree&quot;
</I>&gt;<i> &quot;id:1001,phase:1,pass,nolog,ctl:ruleRemoveTargetById=932115;ARGS:ExtraParams&quot;
</I>
thanks again.

And there is an another issue with 3.0.2 (but may be that affects
another versions too).

The request is similar that I detailed in my first post. The
&quot;extraParams&quot; value (JSON field) is this:

extraParams {&quot;node&quot;:&quot;3&quot;,&quot;text&quot;:&quot;v&#233;gs&#337; fejezet&quot;}

As you can see, this is a UTF8 text, and client sends it as UTF8:

Content-Type: application/x-www-form-urlencoded; charset=UTF-8
X-Requested-With: XMLHttpRequest
Accept-Encoding: gzip, deflate

The encoded URI will be:

extraParams=%7B%22node%22%3A%223%22%2C%22text%22%3A%22v%C3%A9gs%C5%91%20fejezet%22

The characters &quot;&#233;&quot; and &quot;&#337;&quot; are two bytes utf8 characters:
\xC3\xA9 and \xC5\x91.

But in audit log I get:

ModSecurity: Warning. Matched &quot;Operator `ValidadeByteRange' with parameter `1-255' against variable `ARGS:extraParams' (Value: `{&quot;node&quot;:&quot;3&quot;,&quot;text&quot;:&quot;v\xffffffc3\xffffffa9gs\xffffffc5\xffffff91 fejezet&quot;,&quot;parentNode&quot;:&quot;0&quot;,&quot;tid&quot;:&quot;144 (3 characters omitted)' ) [file &quot;/etc/nginx/owasp-modsecurity-crs/rules/REQUEST-920-PROTOCOL-ENFORCEMENT.conf&quot;] [line &quot;488&quot;] [id &quot;920270&quot;] [rev &quot;2&quot;] [msg &quot;Invalid character in request (null character)&quot;] [data &quot;&quot;] [severity &quot;2&quot;] [ver &quot;OWASP_CRS/3.0.0&quot;] [maturity &quot;9&quot;] [accuracy &quot;9&quot;] [tag &quot;application-multi&quot;] [tag &quot;language-multi&quot;] [tag &quot;platform-multi&quot;] [tag &quot;attack-protocol&quot;] [tag &quot;OWASP_CRS/PROTOCOL_VIOLATION/EVASION&quot;] [ref &quot;o21,1o22,1o25,1o26,1v921,67t:urlDecodeUni&quot;]

Why is the ValidadeByteRange is 1-255? And why converts the
urlDecodeUni the UTF8 chars to UTF32? What would be the right way
to send legal UTF8 (or UTF32) characters to server?


(An addition note: I just see the &quot;ver OWASP_CRS/3.0.0&quot; string
now, when I copied the line, but I'm sure I've pulled out the
3.0.2:

$ git log
commit e4e0497be4d598cce0e0a8fef20d1f1e5578c8d0
Merge: d46913e 9d2465d
Author: Chaim Sanders &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">chaim.sanders at gmail.com</A>&gt;
Date:   Fri May 12 13:11:20 2017 -0400

    pushing to v3.0.2

)


Many thanks again!


a.


&gt;<i> On Tue, May 30, 2017 at 10:19 AM, Ervin Heged&#252;s &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">airween at gmail.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> &gt; Hi,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; there is an existing web application, which have an API: the
</I>&gt;<i> &gt; client sends the requests to server in a fixed structure, and the
</I>&gt;<i> &gt; server answers to them. This app works since 4 years.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Now I've installed Libmodsecurity, and OWASP CRS (3.0.2).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Here is a client request (HTTP POST)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; action  filter_tree
</I>&gt;<i> &gt; extraParams     {&quot;sort&quot;:&quot;folderid&quot;}
</I>&gt;<i> &gt; node    0
</I>&gt;<i> &gt; table   tea_user_folders
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; In extraParams, there could be several keys and values.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The modsecurity bans this request with these lines (in
</I>&gt;<i> &gt; audit.log):
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ---1InxQ6aA---B--
</I>&gt;<i> &gt; POST /api/tree HTTP/1.1
</I>&gt;<i> &gt; Referer: <A HREF="http://my.app/">http://my.app/</A>
</I>&gt;<i> &gt; Content-Type: application/x-www-form-urlencoded; charset=UTF-8
</I>&gt;<i> &gt; X-Requested-With: XMLHttpRequest
</I>&gt;<i> &gt; Accept-Encoding: gzip, deflate
</I>&gt;<i> &gt; Cookie: _ga=GA1.2.978766370.1489422665; PHPSESSID=
</I>&gt;<i> &gt; bbfcaq0r0ahruiqn49mjg9bcc6
</I>&gt;<i> &gt; Content-Length: 94
</I>&gt;<i> &gt; Accept-Language: hu-HU,hu;q=0.8,en-US;q=0.5,en;q=0.3
</I>&gt;<i> &gt; Accept: */*
</I>&gt;<i> &gt; Cache-Control: max-age=0
</I>&gt;<i> &gt; User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64; rv:53.0) Gecko/20100101
</I>&gt;<i> &gt; Firefox/53.0
</I>&gt;<i> &gt; Host: my.app
</I>&gt;<i> &gt; Connection: keep-alive
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ---1InxQ6aA---D--
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ---1InxQ6aA---F--
</I>&gt;<i> &gt; Server: nginx/1.6.2
</I>&gt;<i> &gt; Date: Tue, 30 May 2017 13:55:47 GMT
</I>&gt;<i> &gt; Content-Length: 168
</I>&gt;<i> &gt; Content-Type: text/html
</I>&gt;<i> &gt; Connection: keep-alive
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ---1InxQ6aA---H--
</I>&gt;<i> &gt; ModSecurity: Warning. Matched &quot;Operator `Rx' with parameter
</I>&gt;<i> &gt; `(?i)(?:;|\{|\||\|\||&amp;|&amp;&amp;|\n|\r|`)\s*[\(,@\'\&quot;\s]*(?:[\w'\&quot;\
</I>&gt;<i> &gt; ./]+/|[\\\\'\&quot;\^]*\w[\\\\'\&quot;\^]*:.*\\\\|[\^\.\w'\&quot;/\\\\]*\\\
</I>&gt;<i> &gt; \)?[\&quot;\^]*(?:s[\&quot;\^]*(?:y[\&quot;\^]*s[\&quot;\^]*(?:t[\&quot;\^]*e[\&quot;\^]*m[\&quot;\^]*(?:p[\&quot;\^]*r[
</I>&gt;<i> &gt; (5092 characters omitted)' against variable `ARGS:extraParams' (Value:
</I>&gt;<i> &gt; `{&quot;sort&quot;:&quot;folderid&quot;}' ) [file &quot;/etc/nginx/owasp-modsecurity-
</I>&gt;<i> &gt; crs/rules/REQUEST-932-APPLICATION-ATTACK-RCE.conf&quot;] [line &quot;182&quot;] [id
</I>&gt;<i> &gt; &quot;932115&quot;] [rev &quot;4&quot;] [msg &quot;Remote Command Execution: Windows Command
</I>&gt;<i> &gt; Injection&quot;] [data &quot;Matched Data: {&quot;sort found within ARGS:extraParams:
</I>&gt;<i> &gt; {&quot;sort&quot;:&quot;folderid&quot;}&quot;] [severity &quot;2&quot;] [ver &quot;OWASP_CRS/3.0.0&quot;] [maturity &quot;9&quot;]
</I>&gt;<i> &gt; [accuracy &quot;8&quot;] [tag &quot;application-multi&quot;] [tag &quot;language-shell&quot;] [tag
</I>&gt;<i> &gt; &quot;platform-windows&quot;] [tag &quot;attack-rce&quot;] [tag &quot;OWASP_CRS/WEB_ATTACK/COMMAND_INJECTION&quot;]
</I>&gt;<i> &gt; [tag &quot;WASCTC/WASC-31&quot;] [tag &quot;OWASP_TOP_10/A1&quot;] [tag &quot;PCI/6.5.2&quot;] [ref
</I>&gt;<i> &gt; &quot;o0,6v621,19&quot;]
</I>&gt;<i> &gt; ModSecurity: Warning. Matched &quot;Operator `Ge' with parameter
</I>&gt;<i> &gt; `%{tx.inbound_anomaly_score_threshold}' against variable
</I>&gt;<i> &gt; `TX:ANOMALY_SCORE' (Value: `5' ) [file &quot;/etc/nginx/owasp-modsecurity-
</I>&gt;<i> &gt; crs/rules/REQUEST-949-BLOCKING-EVALUATION.conf&quot;] [line &quot;36&quot;] [id
</I>&gt;<i> &gt; &quot;949110&quot;] [rev &quot;&quot;] [msg &quot;Inbound Anomaly Score Exceeded (Total Score: 5)&quot;]
</I>&gt;<i> &gt; [data &quot;&quot;] [severity &quot;2&quot;] [ver &quot;&quot;] [maturity &quot;0&quot;] [accuracy &quot;0&quot;] [tag
</I>&gt;<i> &gt; &quot;application-multi&quot;] [tag &quot;language-multi&quot;] [tag &quot;platform-multi&quot;] [tag
</I>&gt;<i> &gt; &quot;attack-generic&quot;] [ref &quot;&quot;]
</I>&gt;<i> &gt; ModSecurity: Warning. Matched &quot;Operator `Ge' with parameter
</I>&gt;<i> &gt; `%{tx.inbound_anomaly_score_threshold}' against variable
</I>&gt;<i> &gt; `TX:INBOUND_ANOMALY_SCORE' (Value: `5' ) [file
</I>&gt;<i> &gt; &quot;/etc/nginx/owasp-modsecurity-crs/rules/RESPONSE-980-CORRELATION.conf&quot;]
</I>&gt;<i> &gt; [line &quot;61&quot;] [id &quot;980130&quot;] [rev &quot;&quot;] [msg &quot;Inbound Anomaly Score Exceeded
</I>&gt;<i> &gt; (Total Inbound Score: 5 - SQLI=0,XSS=0,RFI=0,LFI=0,RCE=5,PHPI=0,HTTP=0,SESS=0):
</I>&gt;<i> &gt; Remote Command Execution: Windows Command Injection'&quot;] [data &quot;&quot;] [severity
</I>&gt;<i> &gt; &quot;0&quot;] [ver &quot;&quot;] [maturity &quot;0&quot;] [accuracy &quot;0&quot;] [tag &quot;event-correlation&quot;] [ref
</I>&gt;<i> &gt; &quot;&quot;]
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ---1InxQ6aA---I--
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; My question is: what can I do?
</I>&gt;<i> &gt; - ignore that rule (remove the /etc/nginx/owasp-modsecurity-
</I>&gt;<i> &gt; crs/rules/REQUEST-932-APPLICATION-ATTACK-RCE.conf file?)
</I>&gt;<i> &gt; - change the &quot;sort&quot; keyword in full API (that would be a very
</I>&gt;<i> &gt;   hard work)? (and what should be the good choice? eg.
</I>&gt;<i> &gt;   &quot;sorting&quot;?)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; There isn't any Windows based OS, there are several Linux
</I>&gt;<i> &gt; containers, and nGInx is a front-end proxy.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Many thanks,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; a.
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; Owasp-modsecurity-core-rule-set mailing list
</I>&gt;<i> &gt; <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>
</I>&gt;<i> &gt; <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set</A>
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> -- 
</I>&gt;<i> -- 
</I>&gt;<i> Chaim Sanders
</I>&gt;<i> <A HREF="http://www.ChaimSanders.com">http://www.ChaimSanders.com</A>
</I>
&gt;<i> _______________________________________________
</I>&gt;<i> Owasp-modsecurity-core-rule-set mailing list
</I>&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>
</I>&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set</A>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002370.html">[Owasp-modsecurity-core-rule-set] Matched rule modification
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2371">[ date ]</a>
              <a href="thread.html#2371">[ thread ]</a>
              <a href="subject.html#2371">[ subject ]</a>
              <a href="author.html#2371">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
