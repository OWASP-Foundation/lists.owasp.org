<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] anomaly score range
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20anomaly%20score%20range&In-Reply-To=bdc0238f0908110340v33d0a835xb2e7d2c8cac4bd2a%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000029.html">
   <LINK REL="Next"  HREF="000031.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] anomaly score range</H1>
    <B>Ryan Barnett</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20anomaly%20score%20range&In-Reply-To=bdc0238f0908110340v33d0a835xb2e7d2c8cac4bd2a%40mail.gmail.com"
       TITLE="[Owasp-modsecurity-core-rule-set] anomaly score range">ryan.barnett at breach.com
       </A><BR>
    <I>Tue Aug 11 13:50:12 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="000029.html">[Owasp-modsecurity-core-rule-set] anomaly score range
</A></li>
        <LI>Next message: <A HREF="000031.html">[Owasp-modsecurity-core-rule-set] phpnuke/phpbb login problem with	2.0.1 crs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30">[ date ]</a>
              <a href="thread.html#30">[ thread ]</a>
              <a href="subject.html#30">[ subject ]</a>
              <a href="author.html#30">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

Ryan Barnett
Director of Application Security Research
Phone: (703) 794-2248
Cell: (703) 269-8998
Breach Security, Inc.
2141 Palomar Airport Road, Suite 200
Carlsbad, CA 92011
www.breach.com

On Tuesday 11 August 2009 06:40:43 am Gil Vidals wrote:
&gt;<i> I just installed the latest core rules and I see this anomaly score:
</I>&gt;<i>
</I>&gt;<i>     SecRule TX:ANOMALY_SCORE &quot;@ge 20&quot; \
</I>&gt;<i>
</I>&gt;<i> What is the range of the anomaly scores? Does it go from 0 to 100?
</I>&gt;<i>
</I>&gt;<i> I need help in understanding the score and what to set it to. Currently I
</I>&gt;<i> have it set to 10.
</I>&gt;<i>
</I>&gt;<i> The only documenation I could find so far is:
</I>&gt;<i> # Uncomment the anomaly sections you wish to use.
</I>&gt;<i> # You should set the score to the proper threshold you would prefer. If
</I>&gt;<i> kept at &quot;@gt 0&quot; # it will work similarly to previous Mod CRS rules and will
</I>&gt;<i> create an event in the error_log # file if there are any rules that match. 
</I>&gt;<i> If you would like to lessen the number of events # generated in the
</I>&gt;<i> error_log file, you should increase the anomaly score threshold to #
</I>&gt;<i> something like &quot;@gt 20&quot;.  This would only generate an event in the
</I>&gt;<i> error_log file if # there are multiple lower severity rule matches or if
</I>&gt;<i> any 1 higher severity item matches. #
</I>&gt;<i> # You should also set the desired disruptive action (deny, redirect,
</I>&gt;<i> etc...).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --Gil
</I>&gt;<i>
</I>
Hey Gil,
Yeah, the OWASP CRS project - Documentation section will need to be filled out 
with this type of information about how the anomaly scoring works.  Side note 
- one benefit of moving the CRS to OWASP is that the project is wiki-based now 
so anyone can help to update the documentation.  So, if anyone wants to help 
out, please jump in!

In previous versions of the CRS, each rule was self-contained.  This means 
that the rule would inspect the specified variable/targets with the operator 
data chosen (usually a regular expression) and then the action list would 
specify both the logging and blocking settings.

The idea with new CRS is that we want the rules to be more collaborative 
meaning that we have decoupled the logging/blocking actions from the rules 
that do the initial inspection.  Most of the inspection rules will issue a 
setvar to increase the TX anomaly score data for the current transaction and 
this score will be evaluated at the last possible request blocking point at 
the end of phase:2.  The scoring numbers are tied to the severity levels of 
the issue.  Take a look at the updated Severity data from the CHANGELOG file -

- Updated Severity Ratings
    The severity ratings in the rules have been updated to the following:
    - 0: Emergency - is generated from correlation where there is an inbound attack and
         an outbound leakage.
    - 1: Alert - is generated from correlation where there is an inbound attack and an
         outbound application level error.
    - 2: Critical - is the highest severity level possible without correlation.  It is
         normally generated by the web attack rules (40 level files).
    - 3: Error - is generated mostly from outbound leakage rules (50 level files).
    - 4: Warning - is generated by malicious client rules (35 level files).
    - 5: Notice - is generated by the Protocol policy and anomaly files.
    - 6: Info - is generated by the search engine clients (55 marketing file). 
The normal web attack categories (such as XSS and SQL Injection, etc...) have 
a severity of 2/Critical and will increase the score by 20 points.  3/Error = 
15 points, 4/Warning = 10 points and 5/Notice is 5 points.

So, what all of this means, in relation to the modsecurity_49_enforcement.conf 
file, is that you can set an anomaly scoring threshold that you deem 
appropriate for your site.  These thresholds can control logging and/or 
blocking.  For instance, let's say that you don't really care about clients 
that are missing 1 or 2 request headers (which is something that is flagged in 
the 21 protocol anomalies file), then you should set your anomaly score at 15.  
This means that if a client violates any 2 of the severity 5 rules, this would 
only amount to an anomaly score of 10.  If, however, they violate any 3 
severity 5 issues, then they would trigger.  In the previous CRS, the XSS/SQLi 
types of rules issued blocking actions so that is why the comment section 
above mentions setting the score to 20.  This would result in an anomaly 
scoring match if *any* severity 2 rule matches.
 
Another item to consider with anomaly scoring and that is that you can 
actually combine 2 issues together - 

1) Confidence level in blocking
Due to the fact that we have broken out the highly optimized regex, this means 
that we have many more individual rules that could possibly contribute to an 
anomaly score.  This means that the *higher* the anomaly score, the more 
confident you can be that something malicious is being detected.

2) Handling exceptions
If you are running into a false positive match, for say an XSS attack, against 
one particular parameter payload in your app, chances are that the anomaly 
score for it is rather low and is just barely going over it.  An exception may 
be as easy as bumping up the anomaly score by 20 points.  There are other 
exceptions mechanisms (that we will document later on the OWASP site) that are 
easy as well but this is the easiest.

Hopefully this info helps.

-- 
Ryan C. Barnett
WASC Distributed Open Proxy Honeypot Project Leader
OWASP ModSecurity Core Rule Set Project Leader
Tactical Web Application Security
<A HREF="http://tacticalwebappsec.blogspot.com">http://tacticalwebappsec.blogspot.com</A>



-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20090811/2dc56a01/attachment.html">https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20090811/2dc56a01/attachment.html</A> 
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000029.html">[Owasp-modsecurity-core-rule-set] anomaly score range
</A></li>
	<LI>Next message: <A HREF="000031.html">[Owasp-modsecurity-core-rule-set] phpnuke/phpbb login problem with	2.0.1 crs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30">[ date ]</a>
              <a href="thread.html#30">[ thread ]</a>
              <a href="subject.html#30">[ subject ]</a>
              <a href="author.html#30">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
