<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] phpnuke/phpbb login problem	with 2.0.1 crs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20phpnuke/phpbb%20login%20problem%0A%09with%202.0.1%20crs&In-Reply-To=4A81C89B.6040202%40suck-o.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000031.html">
   <LINK REL="Next"  HREF="000033.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] phpnuke/phpbb login problem	with 2.0.1 crs</H1>
    <B>Ryan Barnett</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20phpnuke/phpbb%20login%20problem%0A%09with%202.0.1%20crs&In-Reply-To=4A81C89B.6040202%40suck-o.com"
       TITLE="[Owasp-modsecurity-core-rule-set] phpnuke/phpbb login problem	with 2.0.1 crs">ryan.barnett at breach.com
       </A><BR>
    <I>Tue Aug 11 16:27:08 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="000031.html">[Owasp-modsecurity-core-rule-set] phpnuke/phpbb login problem with	2.0.1 crs
</A></li>
        <LI>Next message: <A HREF="000033.html">[Owasp-modsecurity-core-rule-set] Fwd: [JIRA] Resolved:	(CORERULES-5) False positive with Joomla and javascript
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32">[ date ]</a>
              <a href="thread.html#32">[ thread ]</a>
              <a href="subject.html#32">[ subject ]</a>
              <a href="author.html#32">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tuesday 11 August 2009 03:38:03 pm bad_brain // suck-o.com wrote:
&gt;<i> hey there...;)
</I>&gt;<i>
</I>
Hey, welcome :)

&gt;<i> when using the 2.0.1 crs users can't login anymore to phpbb/phpnuke, and
</I>&gt;<i> I am a little confused by the triggered rule because I can't find the ID
</I>&gt;<i> to set an exception like I did it in 1.6.1.
</I>
The event logging has changed in v2.0.x so that *only* correlated events will 
show up within the Apache error_log file.  This was designed to help error_log 
event monitoring.  All of the rules are configured to log an event to the audit 
log but not to the error_log (using nolog,auditlog setting).  By a correlated 
event, I mean that the evaluation of the anomaly score at the end of phase:2.  
As the individual rules are setting TX variables when the rules match, it is 
also setting tx.msg data that is displayed in correlated event.

&gt;<i> here is the log entry:
</I>&gt;<i>
</I>&gt;<i> Message: Warning. Operator GE matched 5 at TX:anomaly_score. [file
</I>&gt;<i> &quot;/etc/modsecurity2/base_rules/modsecurity_crs_60_correlation.conf&quot;]
</I>&gt;<i> [line &quot;41&quot;] [msg &quot;Transactional Anomaly Score (score 20): Blind SQL
</I>&gt;<i> Injection Attack&quot;]
</I>&gt;<i> Action: Intercepted (phase 2)
</I>&gt;<i> Stopwatch: 1250012515250667 12627 (2426* 10440 -)
</I>&gt;<i> Producer: ModSecurity for Apache/2.5.9 (<A HREF="http://www.modsecurity.org/">http://www.modsecurity.org/</A>);
</I>&gt;<i> core ruleset/2.0.1.
</I>&gt;<i>
</I>
This correlated event tells you that the anomaly score is 20 and that the rule 
that matched was in the Blind SQ Injection category.  In order to identify the 
actual, individual rule that matched, you will need to review the audit log 
entry for this transaction and the normal Message event details will be there 
for you (as it was in older CRS) that will include the rule ID data.

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I have commented the rule out to test it, but the request is still
</I>&gt;<i> blocked, this time even without naming any explicit rule being triggered:
</I>&gt;<i>
</I>&gt;<i> Action: Intercepted (phase 2)
</I>&gt;<i> Stopwatch: 1250012698532648 23056 (6157* 15148 -)
</I>&gt;<i> Producer: ModSecurity for Apache/2.5.9 (<A HREF="http://www.modsecurity.org/">http://www.modsecurity.org/</A>);
</I>&gt;<i> core ruleset/2.0.1.
</I>&gt;<i>
</I>
If you identify a false positive issue, you can implement a custom exception 
by adding a rule to the modsecurity_crs_48_local_exceptions.conf file.  The file 
provides some exception examples and you can also review an example in this 
recent JIRA ticket - <A HREF="https://www.modsecurity.org/tracker/browse/CORERULES-2">https://www.modsecurity.org/tracker/browse/CORERULES-2</A>

The idea is that you need to know what the TX variable data looks like for the 
false positive and then you create an exception that looks for that *exact* 
data and then it corrects that anomaly score be decrementing it by 20 points.
  
One other item that I would recommend is to change the &quot;deny&quot; action in the 
modsecurity_crs_49_enforcement.conf file to &quot;pass&quot; if you want to run in a 
simulation/detection-only mode while testing the new CRS.

# Alert and Deny on High Anomaly Scores
#
SecRule TX:ANOMALY_SCORE &quot;@ge 20&quot; \
    &quot;phase:2,t:none,nolog,auditlog,pass,msg:'Anomaly Score Exceeded (score 
%{TX.ANOMALY_SCORE}): %{tx.msg}',setvar:tx.inbound_tx_msg=%{tx.msg}&quot;

Let me know if you need any more help.

-- 
Ryan C. Barnett
WASC Distributed Open Proxy Honeypot Project Leader
OWASP ModSecurity Core Rule Set Project Leader
Tactical Web Application Security
<A HREF="http://tacticalwebappsec.blogspot.com">http://tacticalwebappsec.blogspot.com</A>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20090811/f0bd590f/attachment.html">https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20090811/f0bd590f/attachment.html</A> 
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000031.html">[Owasp-modsecurity-core-rule-set] phpnuke/phpbb login problem with	2.0.1 crs
</A></li>
	<LI>Next message: <A HREF="000033.html">[Owasp-modsecurity-core-rule-set] Fwd: [JIRA] Resolved:	(CORERULES-5) False positive with Joomla and javascript
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32">[ date ]</a>
              <a href="thread.html#32">[ thread ]</a>
              <a href="subject.html#32">[ subject ]</a>
              <a href="author.html#32">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
