From bclark at restaurant.com  Mon Oct 20 17:05:31 2014
From: bclark at restaurant.com (Brian Clark)
Date: Mon, 20 Oct 2014 17:05:31 +0000
Subject: [Owasp-modsecurity-core-rule-set] ModSecurity, AJAX,
	CORS and responses being dropped
Message-ID: <D06AAB0A.56926%bclark@restaurant.com>

Hello,

We use AJAX and CORS as part of a login form on our website. For some
reason, ModSecurity 2.8.0 for Windows seems to be preventing this from
working properly. However, nothing shows up in the debug logs (level = 9)
showing that anything had been blocked. I can see in the logs that
ModSecurity is receiving the HTTP Post with the email/password login
values. The debug.log does not show any any positive rule hits. Also, I?m
in detect-only mode so it shouldn?t be dropping anything.

My thought was that something in the outbound rule set is modifying the
response in some way, but I disabled it and still had the issue. When I
disable ModSecurity entirely, login works just fine.

I am using the base CRS rules that are installed by default by the
ModSecurity installer.

Any thoughts on how to troubleshoot this? Without anything showing up in
the debug.log I am lost.

(BTW:  I originally posted this to the regular mod security users list and
am reposting here for additional feedback.)

Thanks,
Brian Clark



Restaurant.com - Best Deal. Every Meal.

Restaurant.com is the trusted and valued source connecting diners, restaurants, businesses and communities since 1999. The company offers savings at thousands of restaurants nationwide with more than 30,000 gift certificate options. The Restaurant.com Independent Consultant program offers thousands of self-employment opportunities to individuals that want to earn money while helping Restaurant.com to expand to more restaurants, businesses and communities nationwide. To date, Restaurant.com customers have saved more than $1 billion through the gift certificate program filling more than 3.5 million tables annually. Restaurant.com is a pioneer in the restaurant deal space and is headquartered in Arlington Heights, IL.

Smartphone and iPad users: download our app - iPhone<https://itunes.apple.com/us/app/restaurant.com/id488860392?ls=1&mt=8>, iPad<https://itunes.apple.com/us/app/restaurant.com/id488860392?ls=1&mt=8> and Android<https://play.google.com/store/apps/details?id=com.restaurant.mobile>

Learn more about Restaurant.com https://sales.restaurant.com/Overview
Find dining deals near you http://www.restaurant.com
Make money with Restaurant.com https://sales.restaurant.com/MakeMoney

From RBarnett at trustwave.com  Wed Oct 22 21:57:24 2014
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Wed, 22 Oct 2014 21:57:24 +0000
Subject: [Owasp-modsecurity-core-rule-set] Welcoming Chaim Sanders to the
	SpiderLabs Research Team
Message-ID: <D06DA081.11E967%rbarnett@trustwave.com>

I wanted to send a note out to the ModSecurity community to introduce Chaim Sanders - https://www.linkedin.com/pub/chaim-sanders/13/237/a7a.  He is joining the SpiderLabs Research team where he will be focusing on supporting the ModSecurity project and community.  This means he will help out answering emails from the community on these mail-lists, help Felipe Costa with development on our Github repos, creating new signatures for OWASP CRS/Commercial Rules and also helping to delivery professional services from Trustwave for our commercial customers.  Needless to say, we have a lot of work for Chaim and we are thrilled to have him on the team.  His background in web application pentration testing gives him a great "Know Your Enemy" perspective to bring to web application defenses like ModSecurity.

Please join me in welcoming Chaim.

Thanks.

Ryan Barnett
Senior Lead Security Researcher, SpiderLabs

Trustwave | SMART SECURITY ON DEMAND
www.trustwave.com<http://www.trustwave.com/>

________________________________

This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is strictly prohibited. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20141022/ef11e0b5/attachment.html>

From jroback at gmail.com  Wed Oct 22 22:20:02 2014
From: jroback at gmail.com (Joshua Roback)
Date: Wed, 22 Oct 2014 18:20:02 -0400
Subject: [Owasp-modsecurity-core-rule-set] Welcoming Chaim Sanders to
 the SpiderLabs Research Team
In-Reply-To: <D06DA081.11E967%rbarnett@trustwave.com>
References: <D06DA081.11E967%rbarnett@trustwave.com>
Message-ID: <CAExQ=_f11ZwVApwOPaRmhyBOw_s-0KZy1QEPZ7iaPdkubj5KzQ@mail.gmail.com>

Welcome, Chaim!

On Wed, Oct 22, 2014 at 5:57 PM, Ryan Barnett <RBarnett at trustwave.com>
wrote:

>  I wanted to send a note out to the ModSecurity community to introduce
> Chaim Sanders - https://www.linkedin.com/pub/chaim-sanders/13/237/a7a.
> He is joining the SpiderLabs Research team where he will be focusing on
> supporting the ModSecurity project and community.  This means he will help
> out answering emails from the community on these mail-lists, help Felipe
> Costa with development on our Github repos, creating new signatures for
> OWASP CRS/Commercial Rules and also helping to delivery professional
> services from Trustwave for our commercial customers.  Needless to say, we
> have a lot of work for Chaim and we are thrilled to have him on the team.
> His background in web application pentration testing gives him a great
> "Know Your Enemy" perspective to bring to web application defenses like
> ModSecurity.
>
>  Please join me in welcoming Chaim.
>
>  Thanks.
>
>  *Ryan Barnett*
>
> Senior Lead Security Researcher, SpiderLabs
>
>
>
> *Trustwave* | SMART SECURITY ON DEMAND
>
> www.trustwave.com
>
>
> ------------------------------
>
> This transmission may contain information that is privileged,
> confidential, and/or exempt from disclosure under applicable law. If you
> are not the intended recipient, you are hereby notified that any
> disclosure, copying, distribution, or use of the information contained
> herein (including any reliance thereon) is strictly prohibited. If you
> received this transmission in error, please immediately contact the sender
> and destroy the material in its entirety, whether in electronic or hard
> copy format.
>
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>
>


-- 
Joshua Roback
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20141022/cfbf67e9/attachment.html>

From modsec at spam.lifeforms.nl  Thu Oct 23 12:23:27 2014
From: modsec at spam.lifeforms.nl (Walter Hop)
Date: Thu, 23 Oct 2014 14:23:27 +0200
Subject: [Owasp-modsecurity-core-rule-set] [mod-security-users]
	Welcoming Chaim Sanders to the SpiderLabs Research Team
In-Reply-To: <D06DA081.11E967%rbarnett@trustwave.com>
References: <D06DA081.11E967%rbarnett@trustwave.com>
Message-ID: <ABF65A0F-5D4F-43BE-98E4-483E4F4ED8E0@spam.lifeforms.nl>

Welcome Chaim!

> On 22 Oct 2014, at 23:57, Ryan Barnett <RBarnett at trustwave.com> wrote:
> 
> I wanted to send a note out to the ModSecurity community to introduce Chaim Sanders - https://www.linkedin.com/pub/chaim-sanders/13/237/a7a <https://www.linkedin.com/pub/chaim-sanders/13/237/a7a>.  He is joining the SpiderLabs Research team  where he will be focusing on supporting the ModSecurity project and community.  This means he will help out answering emails from the community on these mail-lists, help Felipe Costa with development on our Github repos, creating new signatures for OWASP CRS/Commercial Rules and also helping to delivery professional services from Trustwave for our commercial customers.  Needless to say, we have a lot of work for Chaim and we are thrilled to have him on the team.  His background in web application pentration testing gives him a great "Know Your Enemy" perspective to bring to web application defenses like ModSecurity.
> 
> Please join me in welcoming Chaim.
> 
> Thanks.
> 
> Ryan Barnett
> Senior Lead Security Researcher, SpiderLabs
>  
> Trustwave | SMART SECURITY ON DEMAND
> www.trustwave.com <http://www.trustwave.com/>
> 
> 
> 
> This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is strictly prohibited. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
> ------------------------------------------------------------------------------
> _______________________________________________
> mod-security-users mailing list
> mod-security-users at lists.sourceforge.net
> https://lists.sourceforge.net/lists/listinfo/mod-security-users
> Commercial ModSecurity Rules and Support from Trustwave's SpiderLabs:
> http://www.modsecurity.org/projects/commercial/rules/
> http://www.modsecurity.org/projects/commercial/support/

-- 
Walter Hop | PGP key: https://lifeforms.nl/pgp

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20141023/b6ae7a0e/attachment.html>

From ctummalapalli at qatarairways.com.qa  Tue Oct 28 10:59:45 2014
From: ctummalapalli at qatarairways.com.qa (Chaitanya Kumar Tummalapalli)
Date: Tue, 28 Oct 2014 10:59:45 +0000
Subject: [Owasp-modsecurity-core-rule-set] Require Mod_Security rule for
 preventing random query sting DOS attacks
Message-ID: <53CDA9CCB03E0846B68EEA5D8E40FB7FDAA7C3A2@DOHQDQMX03.qr.qrgrp.local>

Hello,

We faced a DDOS Attack on our web site very recently. The nature of attack is a HTTP Flood Attack which raised our bandwidth utilization form 2MBPS to 20 MBPS

We have CDN edge caching servers for content delivery to the end user.

There are around 1.2 Million requests made to the apache web server in 20 minutes with one specific pattern.

For ex: http://www.abc.com/index.html?~77462375

Request appended with query string with random sequence number.  The Website usually responds with default page for every such request.

But within no time the web servers resources got exhausted and was unable to respond. Leading to total downtime.

I have attached a white paper which describes about similar attacks which we have undergone.

We need a rule from mod_security crs which can defend the attack and drop such kind of requests.

Regards,
Chaitanya

Qatar Airways - Proud member of the oneworld alliance.



Disclaimer:- This message (including attachments) is intended solely for the addressee named above. It may be confidential, privileged, subject to copyright, trade secret, or other legal rules and may not be forwarded without the author's permission. If you are not the addressee you must not read, copy or disseminate this message. If you have received it in error please notify the sender immediately and delete the message from all storage devices. Any opinions expressed in this message do not necessarily represent the official positions of Qatar Airways. Any agreements (including any warranties, representations, or offers) concluded with Qatar Airways by using electronic correspondence shall only come into existence if an authorized representative of Qatar Airways has explicitly approved such contract formation. To the fullest extent permissible by law, Qatar Airways disclaim all liability for loss or damage to person or property arising from this message being infected by computer virus or other contamination.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20141028/91798c01/attachment-0001.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: 1109.4404.pdf
Type: application/pdf
Size: 85018 bytes
Desc: 1109.4404.pdf
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20141028/91798c01/attachment-0001.pdf>

From joerg.stephan at owasp.org  Tue Oct 28 13:33:32 2014
From: joerg.stephan at owasp.org (Joerg Stephan)
Date: Tue, 28 Oct 2014 14:33:32 +0100
Subject: [Owasp-modsecurity-core-rule-set] Require Mod_Security rule for
 preventing random query sting DOS attacks
In-Reply-To: <53CDA9CCB03E0846B68EEA5D8E40FB7FDAA7C3A2@DOHQDQMX03.qr.qrgrp.local>
References: <53CDA9CCB03E0846B68EEA5D8E40FB7FDAA7C3A2@DOHQDQMX03.qr.qrgrp.local>
Message-ID: <CAANsTqghhJm6AWADEtjRMmWZBHVj+VZWho4xHmS1h=ZJfEzzjw@mail.gmail.com>

Good $localtime,

how many queries have been done by a single ip address?

In my opinion, when it comes to HTTP flooding we will have a problem
adjusting the rules, cause it will be hard to determine if it is a valid
request or not. In such cases i would prefer using mod_evasive or fail2ban.

Just my 2 cents

Kind regards

Joerg

On Tue, Oct 28, 2014 at 11:59 AM, Chaitanya Kumar Tummalapalli <
ctummalapalli at qatarairways.com.qa> wrote:

>  Hello,
>
>
>
> We faced a DDOS Attack on our web site very recently. The nature of attack
> is a HTTP Flood Attack which raised our bandwidth utilization form 2MBPS to
> 20 MBPS
>
>
>
> We have CDN edge caching servers for content delivery to the end user.
>
>
>
> There are around 1.2 Million requests made to the apache web server in 20
> minutes with one specific pattern.
>
>
>
> For ex: http://www.abc.com/index.html?~77462375
>
>
>
> Request appended with query string with random sequence number.  The
> Website usually responds with default page for every such request.
>
>
>
> But within no time the web servers resources got exhausted and was unable
> to respond. Leading to total downtime.
>
>
>
> I have attached a white paper which describes about similar attacks which
> we have undergone.
>
>
>
> We need a rule from mod_security crs which can defend the attack and drop
> such kind of requests.
>
>
>
> *Regards,*
>
> *Chaitanya*
>
>
>  Qatar Airways - Proud member of the *one*world alliance.
>
> *[image: OW LOGO]*
>
> Disclaimer:- This message (including attachments) is intended solely for
> the addressee named above. It may be confidential, privileged, subject to
> copyright, trade secret, or other legal rules and may not be forwarded
> without the author's permission. If you are not the addressee you must not
> read, copy or disseminate this message. If you have received it in error
> please notify the sender immediately and delete the message from all
> storage devices. Any opinions expressed in this message do not necessarily
> represent the official positions of Qatar Airways. Any agreements
> (including any warranties, representations, or offers) concluded with Qatar
> Airways by using electronic correspondence shall only come into existence
> if an authorized representative of Qatar Airways has explicitly approved
> such contract formation. To the fullest extent permissible by law, Qatar
> Airways disclaim all liability for loss or damage to person or property
> arising from this message being infected by computer virus or other
> contamination.
>
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20141028/e2f21d0e/attachment.html>

From soeren.christian.aarup at dibs.dk  Tue Oct 28 13:43:21 2014
From: soeren.christian.aarup at dibs.dk (=?iso-8859-1?Q?S=F8ren_Christian_Aarup?=)
Date: Tue, 28 Oct 2014 13:43:21 +0000
Subject: [Owasp-modsecurity-core-rule-set] Require Mod_Security rule for
 preventing random query sting DOS attacks
In-Reply-To: <CAANsTqghhJm6AWADEtjRMmWZBHVj+VZWho4xHmS1h=ZJfEzzjw@mail.gmail.com>
Message-ID: <D0755C05.1867EA%scaa@dibs.dk>

Hi

We are mitigating this with rate-limiting in Nginx, which acts as reverse proxies in front of our application webservers.


Med venlig hilsen/Regards

S?ren Christian Aarup
DBA/System Administrator

LinkedIn: www.linkedin.com/in/aarup<http://www.linkedin.com/in/aarup>
[DIBS - Payments made easy]<http://www.dibs.dk/>



From: Joerg Stephan <joerg.stephan at owasp.org<mailto:joerg.stephan at owasp.org>>
Date: Tuesday28October2014 15:33
To: Chaitanya Kumar Tummalapalli <ctummalapalli at qatarairways.com.qa<mailto:ctummalapalli at qatarairways.com.qa>>
Cc: "owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>" <owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>>
Subject: Re: [Owasp-modsecurity-core-rule-set] Require Mod_Security rule for preventing random query sting DOS attacks

Good $localtime,

how many queries have been done by a single ip address?

In my opinion, when it comes to HTTP flooding we will have a problem adjusting the rules, cause it will be hard to determine if it is a valid request or not. In such cases i would prefer using mod_evasive or fail2ban.

Just my 2 cents

Kind regards

Joerg

On Tue, Oct 28, 2014 at 11:59 AM, Chaitanya Kumar Tummalapalli <ctummalapalli at qatarairways.com.qa<mailto:ctummalapalli at qatarairways.com.qa>> wrote:
Hello,

We faced a DDOS Attack on our web site very recently. The nature of attack is a HTTP Flood Attack which raised our bandwidth utilization form 2MBPS to 20 MBPS

We have CDN edge caching servers for content delivery to the end user.

There are around 1.2 Million requests made to the apache web server in 20 minutes with one specific pattern.

For ex: http://www.abc.com/index.html?~77462375

Request appended with query string with random sequence number.  The Website usually responds with default page for every such request.

But within no time the web servers resources got exhausted and was unable to respond. Leading to total downtime.

I have attached a white paper which describes about similar attacks which we have undergone.

We need a rule from mod_security crs which can defend the attack and drop such kind of requests.

Regards,
Chaitanya

Qatar Airways - Proud member of the oneworld alliance.

[OW LOGO]

Disclaimer:- This message (including attachments) is intended solely for the addressee named above. It may be confidential, privileged, subject to copyright, trade secret, or other legal rules and may not be forwarded without the author's permission. If you are not the addressee you must not read, copy or disseminate this message. If you have received it in error please notify the sender immediately and delete the message from all storage devices. Any opinions expressed in this message do not necessarily represent the official positions of Qatar Airways. Any agreements (including any warranties, representations, or offers) concluded with Qatar Airways by using electronic correspondence shall only come into existence if an authorized representative of Qatar Airways has explicitly approved such contract formation. To the fullest extent permissible by law, Qatar Airways disclaim all liability for loss or damage to person or property arising from this message being infected by computer virus or other contamination.

_______________________________________________
Owasp-modsecurity-core-rule-set mailing list
Owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:Owasp-modsecurity-core-rule-set at lists.owasp.org>
https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set


-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20141028/c064c6eb/attachment-0001.html>

From ctummalapalli at qatarairways.com.qa  Tue Oct 28 14:00:04 2014
From: ctummalapalli at qatarairways.com.qa (Chaitanya Kumar Tummalapalli)
Date: Tue, 28 Oct 2014 14:00:04 +0000
Subject: [Owasp-modsecurity-core-rule-set] Require Mod_Security rule for
 preventing random query sting DOS attacks
In-Reply-To: <CAANsTqghhJm6AWADEtjRMmWZBHVj+VZWho4xHmS1h=ZJfEzzjw@mail.gmail.com>
References: <53CDA9CCB03E0846B68EEA5D8E40FB7FDAA7C3A2@DOHQDQMX03.qr.qrgrp.local>
	<CAANsTqghhJm6AWADEtjRMmWZBHVj+VZWho4xHmS1h=ZJfEzzjw@mail.gmail.com>
Message-ID: <53CDA9CCB03E0846B68EEA5D8E40FB7FDAA7C651@DOHQDQMX03.qr.qrgrp.local>

Hello Joerg,

Thanks for your reply.

In our analysis of access logs the attacker has used 436 IP?s (botnets) to generate this 1.2 million requests with random number queries. Within 20 minutes time.

So on an average we have got 2750 requests from one single IP.

Our web site which was under attack  has maximum of 45 valid known query strings and beyond them can be treated as spurious like below

122.226.28.22, 23.212.108.67 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?953341233 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/536.11 (KHTML, like Gecko) Chrome/20.0.1132.47 Safari/536.11"
120.28.113.179, 23.212.108.67 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?2110115717 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_6_8) AppleWebKit/536.5 (KHTML, like Gecko) Chrome/19.0.1084.56 Safari/536.5"
93.183.239.56, 23.212.108.73 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?-404454353 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Windows NT 5.1; rv:5.0.1) Gecko/20100101 Firefox/5.0.1"
221.178.236.122, 23.212.108.73 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?-304549227 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Windows NT 6.1; rv:12.0) Gecko/20100101 Firefox/12.0"
117.25.192.227, 23.212.108.67 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?-1186515202 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.6; rv:13.0) Gecko/20100101 Firefox/13.0.1"
60.174.55.148, 23.212.108.70, 2.18.243.13 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?-16740259 HTTP/1.1" 200 2797 "-" "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)"
218.63.78.48, 23.212.108.73 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?-441220308 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Windows NT 6.1) AppleWebKit/536.5 (KHTML, like Gecko) Chrome/19.0.1084.56 Safari/536.5"
183.63.45.186, 23.212.108.73 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?-1330852491 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:12.0) Gecko/20100101 Firefox/12.0"
213.148.184.156, 23.212.108.63, 2.18.243.13 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?-1092903431 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Windows NT 6.1) AppleWebKit/536.11 (KHTML, like Gecko) Chrome/20.0.1132.47 Safari/536.11"
61.133.234.21, 23.212.108.67 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?-1925985494 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Windows NT 6.1; rv:5.0) Gecko/20100101 Firefox/5.02"
125.74.189.77, 23.212.108.67 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?1261388031 HTTP/1.1" 200 2797 "-" "Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.0; Trident/4.0; Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1) ; .NET CLR 3.5.30729)"

Vaild query string will look like this

82.79.99.142, 81.196.26.231, 80.239.171.212 - - [28/Oct/2014:16:56:01 +0300] "GET /index.html?q=ro/en HTTP/1.1" 200


So can we think of a rule which drops the requests like /index.html?953341233 this. Or if it can be achieved by mod_evasive . Sorry I?m new to mod_evasive. Could you please elaborate on how to use it.



Chaitanya Kumar Tummalapalli
TS Controller
I n f o r m a t i o n  T e c h n o l o g y
M :  ( + 9 7 4 )  3 3 6 9 - 0915  | P :  ( + 9 7 4 )  4022 - 7486 | (ctummalapalli at qatarairways.com.qa<mailto:ctummalapalli at qatarairways.com.qa>)

W o r l d ' s  5 - s t a r  a i r l i n e  | www.  q a t a r a i r w a y s . c o m

From: Joerg Stephan [mailto:joerg.stephan at owasp.org]
Sent: 28 October 2014 4:34 PM
To: Chaitanya Kumar Tummalapalli
Cc: owasp-modsecurity-core-rule-set at lists.owasp.org
Subject: Re: [Owasp-modsecurity-core-rule-set] Require Mod_Security rule for preventing random query sting DOS attacks

Good $localtime,

how many queries have been done by a single ip address?

In my opinion, when it comes to HTTP flooding we will have a problem adjusting the rules, cause it will be hard to determine if it is a valid request or not. In such cases i would prefer using mod_evasive or fail2ban.

Just my 2 cents

Kind regards

Joerg

On Tue, Oct 28, 2014 at 11:59 AM, Chaitanya Kumar Tummalapalli <ctummalapalli at qatarairways.com.qa<mailto:ctummalapalli at qatarairways.com.qa>> wrote:
Hello,

We faced a DDOS Attack on our web site very recently. The nature of attack is a HTTP Flood Attack which raised our bandwidth utilization form 2MBPS to 20 MBPS

We have CDN edge caching servers for content delivery to the end user.

There are around 1.2 Million requests made to the apache web server in 20 minutes with one specific pattern.

For ex: http://www.abc.com/index.html?~77462375

Request appended with query string with random sequence number.  The Website usually responds with default page for every such request.

But within no time the web servers resources got exhausted and was unable to respond. Leading to total downtime.

I have attached a white paper which describes about similar attacks which we have undergone.

We need a rule from mod_security crs which can defend the attack and drop such kind of requests.

Regards,
Chaitanya

Qatar Airways - Proud member of the oneworld alliance.

[Image removed by sender. OW LOGO]

Disclaimer:- This message (including attachments) is intended solely for the addressee named above. It may be confidential, privileged, subject to copyright, trade secret, or other legal rules and may not be forwarded without the author's permission. If you are not the addressee you must not read, copy or disseminate this message. If you have received it in error please notify the sender immediately and delete the message from all storage devices. Any opinions expressed in this message do not necessarily represent the official positions of Qatar Airways. Any agreements (including any warranties, representations, or offers) concluded with Qatar Airways by using electronic correspondence shall only come into existence if an authorized representative of Qatar Airways has explicitly approved such contract formation. To the fullest extent permissible by law, Qatar Airways disclaim all liability for loss or damage to person or property arising from this message being infected by computer virus or other contamination.

_______________________________________________
Owasp-modsecurity-core-rule-set mailing list
Owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:Owasp-modsecurity-core-rule-set at lists.owasp.org>
https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20141028/1637e597/attachment-0001.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: ~WRD000.jpg
Type: image/jpeg
Size: 823 bytes
Desc: ~WRD000.jpg
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20141028/1637e597/attachment-0001.jpg>

From Ronald.Ploeger at bertelsmann.de  Tue Oct 28 14:11:18 2014
From: Ronald.Ploeger at bertelsmann.de (Ronald.Ploeger at bertelsmann.de)
Date: Tue, 28 Oct 2014 14:11:18 +0000
Subject: [Owasp-modsecurity-core-rule-set] Missing/Empty Accept Header Rule
	#960015
Message-ID: <C2603171F3A6024299778D9A2D6BE3364C145733@GTLBMLXEN0007.bagmail.net>

Hi,

why does the core rule set check for a missing "Accept" header?

As far as I understand it is optional. See http://www.w3.org/Protocols/HTTP/HTRQ_Headers.html

"If no Accept: field is present, then it is assumed that text/plain and text/html are accepted."

Thanks and best regards,
Ronald

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20141028/8531d965/attachment.html>

From joerg.stephan at owasp.org  Tue Oct 28 14:14:19 2014
From: joerg.stephan at owasp.org (Joerg Stephan)
Date: Tue, 28 Oct 2014 15:14:19 +0100
Subject: [Owasp-modsecurity-core-rule-set] Require Mod_Security rule for
 preventing random query sting DOS attacks
In-Reply-To: <53CDA9CCB03E0846B68EEA5D8E40FB7FDAA7C651@DOHQDQMX03.qr.qrgrp.local>
References: <53CDA9CCB03E0846B68EEA5D8E40FB7FDAA7C3A2@DOHQDQMX03.qr.qrgrp.local>
	<CAANsTqghhJm6AWADEtjRMmWZBHVj+VZWho4xHmS1h=ZJfEzzjw@mail.gmail.com>
	<53CDA9CCB03E0846B68EEA5D8E40FB7FDAA7C651@DOHQDQMX03.qr.qrgrp.local>
Message-ID: <CAANsTqh242uWV70xPL2ou4thqTKrzt+-kUDgYDWWpCmppy9HHA@mail.gmail.com>

Hi again,

okay, so definitely mod_evasive or fail2ban would have solved the problem,
as there should be more than 2400 requests by each single IP addresses.
Evasive can handle this.

On the other hand, it should not be a lot of magic to right a rule to drop
all traffic which does not fit your naming style, but is this would sole
your problem only, i guess we should not code it into the core rules, as
style is different from user to user.

Maybe you can also think about a string-match rule inside of iptables. The
20MBit traffic would hit your apache system anyway, even it it is only the
modules.

I would say, place a Nginx proxy in front of it, enable fail2ban on the
proxy server an you will be much safer than now. Also strange in my mind,
1.2 Mio requests in 20 minuits are only 1000 a second. Maybe you should
rethink your design also. As a important website you should have load
balanced you webservers, and so at least 3 of the webservers should handle
much more than 500 requests each.
I have build nginx webforwarders (php based redirecting logic) which
currently handle 1000 requests per second each. in peak time.

Cheers

On Tue, Oct 28, 2014 at 3:00 PM, Chaitanya Kumar Tummalapalli <
ctummalapalli at qatarairways.com.qa> wrote:

>  Hello Joerg,
>
>
>
> Thanks for your reply.
>
>
>
> In our analysis of access logs the attacker has used 436 IP?s (botnets) to
> generate this 1.2 million requests with random number queries. Within 20
> minutes time.
>
>
>
> So on an average we have got 2750 requests from one single IP.
>
>
>
> Our web site which was under attack  has maximum of 45 valid known query
> strings and beyond them can be treated as spurious like below
>
>
>
> 122.226.28.22, 23.212.108.67 - - [21/Oct/2014:10:00:26 +0300] "GET
> /index.html?953341233 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Windows NT 6.1;
> WOW64) AppleWebKit/536.11 (KHTML, like Gecko) Chrome/20.0.1132.47
> Safari/536.11"
>
> 120.28.113.179, 23.212.108.67 - - [21/Oct/2014:10:00:26 +0300] "GET
> /index.html?2110115717 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Macintosh;
> Intel Mac OS X 10_6_8) AppleWebKit/536.5 (KHTML, like Gecko)
> Chrome/19.0.1084.56 Safari/536.5"
>
> 93.183.239.56, 23.212.108.73 - - [21/Oct/2014:10:00:26 +0300] "GET
> /index.html?-404454353 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Windows NT 5.1;
> rv:5.0.1) Gecko/20100101 Firefox/5.0.1"
>
> 221.178.236.122, 23.212.108.73 - - [21/Oct/2014:10:00:26 +0300] "GET
> /index.html?-304549227 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Windows NT 6.1;
> rv:12.0) Gecko/20100101 Firefox/12.0"
>
> 117.25.192.227, 23.212.108.67 - - [21/Oct/2014:10:00:26 +0300] "GET
> /index.html?-1186515202 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Macintosh;
> Intel Mac OS X 10.6; rv:13.0) Gecko/20100101 Firefox/13.0.1"
>
> 60.174.55.148, 23.212.108.70, 2.18.243.13 - - [21/Oct/2014:10:00:26 +0300]
> "GET /index.html?-16740259 HTTP/1.1" 200 2797 "-" "Mozilla/4.0 (compatible;
> MSIE 6.0; Windows NT 5.1; SV1)"
>
> 218.63.78.48, 23.212.108.73 - - [21/Oct/2014:10:00:26 +0300] "GET
> /index.html?-441220308 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Windows NT 6.1)
> AppleWebKit/536.5 (KHTML, like Gecko) Chrome/19.0.1084.56 Safari/536.5"
>
> 183.63.45.186, 23.212.108.73 - - [21/Oct/2014:10:00:26 +0300] "GET
> /index.html?-1330852491 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Windows NT
> 6.1; WOW64; rv:12.0) Gecko/20100101 Firefox/12.0"
>
> 213.148.184.156, 23.212.108.63, 2.18.243.13 - - [21/Oct/2014:10:00:26
> +0300] "GET /index.html?-1092903431 HTTP/1.1" 200 2797 "-" "Mozilla/5.0
> (Windows NT 6.1) AppleWebKit/536.11 (KHTML, like Gecko) Chrome/20.0.1132.47
> Safari/536.11"
>
> 61.133.234.21, 23.212.108.67 - - [21/Oct/2014:10:00:26 +0300] "GET
> /index.html?-1925985494 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Windows NT
> 6.1; rv:5.0) Gecko/20100101 Firefox/5.02"
>
> 125.74.189.77, 23.212.108.67 - - [21/Oct/2014:10:00:26 +0300] "GET
> /index.html?1261388031 HTTP/1.1" 200 2797 "-" "Mozilla/4.0 (compatible;
> MSIE 8.0; Windows NT 6.0; Trident/4.0; Mozilla/4.0 (compatible; MSIE 6.0;
> Windows NT 5.1; SV1) ; .NET CLR 3.5.30729)"
>
>
>
> Vaild query string will look like this
>
>
>
> 82.79.99.142, 81.196.26.231, 80.239.171.212 - - [28/Oct/2014:16:56:01
> +0300] "GET /index.*html?q=ro/en* HTTP/1.1" 200
>
>
>
>
>
> So can we think of a rule which drops the requests like
> /index.html?953341233 this. Or if it can be achieved by mod_evasive . Sorry
> I?m new to mod_evasive. Could you please elaborate on how to use it.
>
>
>
>
>
>
>
> *Chaitanya Kumar Tummalapalli*
>
> TS Controller
>
> I n f o r m a t i o n  T e c h n o l o g y
>
> M :  ( + 9 7 4 )  3 3 6 9 - 0915  | P :  ( + 9 7 4 )  4022 - 7486 | (
> ctummalapalli at qatarairways.com.qa)
>
>
>
> W o r l d ' s  5 - s t a r  a i r l i n e  | *www*.  *q a t a r a i r w a
> y s . c o m*
>
>
>
> *From:* Joerg Stephan [mailto:joerg.stephan at owasp.org]
> *Sent:* 28 October 2014 4:34 PM
> *To:* Chaitanya Kumar Tummalapalli
> *Cc:* owasp-modsecurity-core-rule-set at lists.owasp.org
> *Subject:* Re: [Owasp-modsecurity-core-rule-set] Require Mod_Security
> rule for preventing random query sting DOS attacks
>
>
>
> Good $localtime,
>
>
>
> how many queries have been done by a single ip address?
>
>
>
> In my opinion, when it comes to HTTP flooding we will have a problem
> adjusting the rules, cause it will be hard to determine if it is a valid
> request or not. In such cases i would prefer using mod_evasive or fail2ban.
>
>
>
> Just my 2 cents
>
>
>
> Kind regards
>
>
>
> Joerg
>
>
>
> On Tue, Oct 28, 2014 at 11:59 AM, Chaitanya Kumar Tummalapalli <
> ctummalapalli at qatarairways.com.qa> wrote:
>
> Hello,
>
>
>
> We faced a DDOS Attack on our web site very recently. The nature of attack
> is a HTTP Flood Attack which raised our bandwidth utilization form 2MBPS to
> 20 MBPS
>
>
>
> We have CDN edge caching servers for content delivery to the end user.
>
>
>
> There are around 1.2 Million requests made to the apache web server in 20
> minutes with one specific pattern.
>
>
>
> For ex: http://www.abc.com/index.html?~77462375
>
>
>
> Request appended with query string with random sequence number.  The
> Website usually responds with default page for every such request.
>
>
>
> But within no time the web servers resources got exhausted and was unable
> to respond. Leading to total downtime.
>
>
>
> I have attached a white paper which describes about similar attacks which
> we have undergone.
>
>
>
> We need a rule from mod_security crs which can defend the attack and drop
> such kind of requests.
>
>
>
> *Regards,*
>
> *Chaitanya*
>
>
>
> Qatar Airways - Proud member of the *one*world alliance.
>
> *[image: Image removed by sender. OW LOGO]*
>
> Disclaimer:- This message (including attachments) is intended solely for
> the addressee named above. It may be confidential, privileged, subject to
> copyright, trade secret, or other legal rules and may not be forwarded
> without the author's permission. If you are not the addressee you must not
> read, copy or disseminate this message. If you have received it in error
> please notify the sender immediately and delete the message from all
> storage devices. Any opinions expressed in this message do not necessarily
> represent the official positions of Qatar Airways. Any agreements
> (including any warranties, representations, or offers) concluded with Qatar
> Airways by using electronic correspondence shall only come into existence
> if an authorized representative of Qatar Airways has explicitly approved
> such contract formation. To the fullest extent permissible by law, Qatar
> Airways disclaim all liability for loss or damage to person or property
> arising from this message being infected by computer virus or other
> contamination.
>
>
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20141028/ad6d43d0/attachment-0001.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: ~WRD000.jpg
Type: image/jpeg
Size: 823 bytes
Desc: not available
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20141028/ad6d43d0/attachment-0001.jpg>

From ctummalapalli at qatarairways.com.qa  Tue Oct 28 14:00:04 2014
From: ctummalapalli at qatarairways.com.qa (Chaitanya Kumar Tummalapalli)
Date: Tue, 28 Oct 2014 07:00:04 -0700
Subject: [Owasp-modsecurity-core-rule-set] Require Mod_Security rule for
 preventing random query sting DOS attacks
In-Reply-To: <CAANsTqghhJm6AWADEtjRMmWZBHVj+VZWho4xHmS1h=ZJfEzzjw@mail.gmail.com>
References: <53CDA9CCB03E0846B68EEA5D8E40FB7FDAA7C3A2@DOHQDQMX03.qr.qrgrp.local>
	<CAANsTqghhJm6AWADEtjRMmWZBHVj+VZWho4xHmS1h=ZJfEzzjw@mail.gmail.com>
Message-ID: <53CDA9CCB03E0846B68EEA5D8E40FB7FDAA7C651@DOHQDQMX03.qr.qrgrp.local>

An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20141028/1637e597/attachment-0003.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: ~WRD000.jpg
Type: image/jpeg
Size: 823 bytes
Desc: ~WRD000.jpg
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20141028/1637e597/attachment-0003.jpg>
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: ATT00001.txt
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20141028/1637e597/attachment-0001.txt>

From RBarnett at trustwave.com  Tue Oct 28 17:11:00 2014
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Tue, 28 Oct 2014 17:11:00 +0000
Subject: [Owasp-modsecurity-core-rule-set] Missing/Empty Accept Header
 Rule #960015
In-Reply-To: <C2603171F3A6024299778D9A2D6BE3364C145733@GTLBMLXEN0007.bagmail.net>
References: <C2603171F3A6024299778D9A2D6BE3364C145733@GTLBMLXEN0007.bagmail.net>
Message-ID: <D0754588.120B64%rbarnett@trustwave.com>

The main purpose of those rules in the modsecurity_crs_21_protocol_anomalies.conf file are to identify non-browser clients.  While the RFC says it is optional, all major browsers will send Host, User-Agent and Accept headers.  So, if you get a request with a User-Agent value like this -

User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.8; rv:32.0) Gecko/20100101 Firefox/32.0

But is it missing an Accept header, then this client is spoofing their User-Agent information.  These rules should probably not be configured to block on their own, however when running in an anomaly scoring mode, they can help to contribute to the overall transactional score for possible blocking.

Ryan Barnett
Senior Lead Security Researcher, SpiderLabs

Trustwave | SMART SECURITY ON DEMAND
www.trustwave.com<http://www.trustwave.com/>

From: "Ronald.Ploeger at bertelsmann.de<mailto:Ronald.Ploeger at bertelsmann.de>" <Ronald.Ploeger at bertelsmann.de<mailto:Ronald.Ploeger at bertelsmann.de>>
Date: Tuesday, October 28, 2014 10:11 AM
To: "owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>" <owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>>
Subject: [Owasp-modsecurity-core-rule-set] Missing/Empty Accept Header Rule #960015

Hi,

why does the core rule set check for a missing ?Accept? header?

As far as I understand it is optional. See http://www.w3.org/Protocols/HTTP/HTRQ_Headers.html<http://scanmail.trustwave.com/?c=4062&d=wanP1Gd59E_yzvm6V2I7_mriayONTN5S_nOssxt7Dw&s=5&u=http%3a%2f%2fwww%2ew3%2eorg%2fProtocols%2fHTTP%2fHTRQ%5fHeaders%2ehtml>

?If no Accept: field is present, then it is assumed that text/plain and text/html are accepted.?

Thanks and best regards,
Ronald


________________________________

This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is strictly prohibited. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20141028/af988232/attachment.html>

From RBarnett at trustwave.com  Tue Oct 28 18:04:09 2014
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Tue, 28 Oct 2014 18:04:09 +0000
Subject: [Owasp-modsecurity-core-rule-set] Require Mod_Security rule for
 preventing random query sting DOS attacks
In-Reply-To: <53CDA9CCB03E0846B68EEA5D8E40FB7FDAA7C651@DOHQDQMX03.qr.qrgrp.local>
References: <53CDA9CCB03E0846B68EEA5D8E40FB7FDAA7C3A2@DOHQDQMX03.qr.qrgrp.local>
	<CAANsTqghhJm6AWADEtjRMmWZBHVj+VZWho4xHmS1h=ZJfEzzjw@mail.gmail.com>
	<53CDA9CCB03E0846B68EEA5D8E40FB7FDAA7C651@DOHQDQMX03.qr.qrgrp.local>
Message-ID: <D0754D5D.120B88%rbarnett@trustwave.com>

You could write up some ModSecurity rules that would check for these types of request anomalies and block.  Try these (untested) -

SecRule &ARGS_GET_NAMES "@eq 1" "chain,phase:1,t:none,drop,msg:'Botnet DDoS Attack Detected'"
SecRule ARGS_GET "@rx ^$" "chain"
SecRule ARGS_GET_NAMES "@rx ^\-?\d{8,10}$" "exec:/path/to/blacklist.sh"

Not the last line has an execute action where you can do things much like Fail2Ban where you can have a shell script that will talk to a local/remote Firewall device and dynamically update the ACLs to blacklist the client IP address.

Ryan Barnett
Senior Lead Security Researcher, SpiderLabs

Trustwave | SMART SECURITY ON DEMAND
www.trustwave.com<http://www.trustwave.com/>

From: Chaitanya Kumar Tummalapalli <ctummalapalli at qatarairways.com.qa<mailto:ctummalapalli at qatarairways.com.qa>>
Date: Tuesday, October 28, 2014 10:00 AM
To: Joerg Stephan <joerg.stephan at owasp.org<mailto:joerg.stephan at owasp.org>>
Cc: "owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>" <owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>>
Subject: Re: [Owasp-modsecurity-core-rule-set] Require Mod_Security rule for preventing random query sting DOS attacks

Hello Joerg,

Thanks for your reply.

In our analysis of access logs the attacker has used 436 IP?s (botnets) to generate this 1.2 million requests with random number queries. Within 20 minutes time.

So on an average we have got 2750 requests from one single IP.

Our web site which was under attack  has maximum of 45 valid known query strings and beyond them can be treated as spurious like below

122.226.28.22, 23.212.108.67 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?953341233 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/536.11 (KHTML, like Gecko) Chrome/20.0.1132.47 Safari/536.11"
120.28.113.179, 23.212.108.67 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?2110115717 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_6_8) AppleWebKit/536.5 (KHTML, like Gecko) Chrome/19.0.1084.56 Safari/536.5"
93.183.239.56, 23.212.108.73 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?-404454353 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Windows NT 5.1; rv:5.0.1) Gecko/20100101 Firefox/5.0.1"
221.178.236.122, 23.212.108.73 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?-304549227 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Windows NT 6.1; rv:12.0) Gecko/20100101 Firefox/12.0"
117.25.192.227, 23.212.108.67 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?-1186515202 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.6; rv:13.0) Gecko/20100101 Firefox/13.0.1"
60.174.55.148, 23.212.108.70, 2.18.243.13 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?-16740259 HTTP/1.1" 200 2797 "-" "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)"
218.63.78.48, 23.212.108.73 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?-441220308 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Windows NT 6.1) AppleWebKit/536.5 (KHTML, like Gecko) Chrome/19.0.1084.56 Safari/536.5"
183.63.45.186, 23.212.108.73 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?-1330852491 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:12.0) Gecko/20100101 Firefox/12.0"
213.148.184.156, 23.212.108.63, 2.18.243.13 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?-1092903431 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Windows NT 6.1) AppleWebKit/536.11 (KHTML, like Gecko) Chrome/20.0.1132.47 Safari/536.11"
61.133.234.21, 23.212.108.67 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?-1925985494 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Windows NT 6.1; rv:5.0) Gecko/20100101 Firefox/5.02"
125.74.189.77, 23.212.108.67 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?1261388031 HTTP/1.1" 200 2797 "-" "Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.0; Trident/4.0; Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1) ; .NET CLR 3.5.30729)"

Vaild query string will look like this

82.79.99.142, 81.196.26.231, 80.239.171.212 - - [28/Oct/2014:16:56:01 +0300] "GET /index.html?q=ro/en HTTP/1.1" 200


So can we think of a rule which drops the requests like /index.html?953341233 this. Or if it can be achieved by mod_evasive . Sorry I?m new to mod_evasive. Could you please elaborate on how to use it.



Chaitanya Kumar Tummalapalli
TS Controller
I n f o r m a t i o n  T e c h n o l o g y
M :  ( + 9 7 4 )  3 3 6 9 - 0915  | P :  ( + 9 7 4 )  4022 - 7486 | (ctummalapalli at qatarairways.com.qa<mailto:ctummalapalli at qatarairways.com.qa>)

W o r l d ' s  5 - s t a r  a i r l i n e  | www.  q a t a r a i r w a y s . c o m

From: Joerg Stephan [mailto:joerg.stephan at owasp.org]
Sent: 28 October 2014 4:34 PM
To: Chaitanya Kumar Tummalapalli
Cc: owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>
Subject: Re: [Owasp-modsecurity-core-rule-set] Require Mod_Security rule for preventing random query sting DOS attacks

Good $localtime,

how many queries have been done by a single ip address?

In my opinion, when it comes to HTTP flooding we will have a problem adjusting the rules, cause it will be hard to determine if it is a valid request or not. In such cases i would prefer using mod_evasive or fail2ban.

Just my 2 cents

Kind regards

Joerg

On Tue, Oct 28, 2014 at 11:59 AM, Chaitanya Kumar Tummalapalli <ctummalapalli at qatarairways.com.qa<mailto:ctummalapalli at qatarairways.com.qa>> wrote:
Hello,

We faced a DDOS Attack on our web site very recently. The nature of attack is a HTTP Flood Attack which raised our bandwidth utilization form 2MBPS to 20 MBPS

We have CDN edge caching servers for content delivery to the end user.

There are around 1.2 Million requests made to the apache web server in 20 minutes with one specific pattern.

For ex: http://www.abc.com/index.html?~77462375<http://scanmail.trustwave.com/?c=4062&d=xafP1ApK3TjrTN55NhvDV4qVJLnpvYD91J3j6tHRzQ&s=5&u=http%3a%2f%2fwww%2eabc%2ecom%2findex%2ehtml%3f%7e77462375>

Request appended with query string with random sequence number.  The Website usually responds with default page for every such request.

But within no time the web servers resources got exhausted and was unable to respond. Leading to total downtime.

I have attached a white paper which describes about similar attacks which we have undergone.

We need a rule from mod_security crs which can defend the attack and drop such kind of requests.

Regards,
Chaitanya

Qatar Airways - Proud member of the oneworld alliance.

[Image removed by sender. OW LOGO]

Disclaimer:- This message (including attachments) is intended solely for the addressee named above. It may be confidential, privileged, subject to copyright, trade secret, or other legal rules and may not be forwarded without the author's permission. If you are not the addressee you must not read, copy or disseminate this message. If you have received it in error please notify the sender immediately and delete the message from all storage devices. Any opinions expressed in this message do not necessarily represent the official positions of Qatar Airways. Any agreements (including any warranties, representations, or offers) concluded with Qatar Airways by using electronic correspondence shall only come into existence if an authorized representative of Qatar Airways has explicitly approved such contract formation. To the fullest extent permissible by law, Qatar Airways disclaim all liability for loss or damage to person or property arising from this message being infected by computer virus or other contamination.

_______________________________________________
Owasp-modsecurity-core-rule-set mailing list
Owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:Owasp-modsecurity-core-rule-set at lists.owasp.org>
https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set<http://scanmail.trustwave.com/?c=4062&d=xafP1ApK3TjrTN55NhvDV4qVJLnpvYD91Jjk69KExw&s=5&u=https%3a%2f%2flists%2eowasp%2eorg%2fmailman%2flistinfo%2fowasp-modsecurity-core-rule-set>


________________________________

This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is strictly prohibited. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20141028/1814d2d9/attachment-0001.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: ~WRD000.jpg
Type: image/jpeg
Size: 823 bytes
Desc: ~WRD000.jpg
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20141028/1814d2d9/attachment-0001.jpg>

From RBarnett at trustwave.com  Tue Oct 28 18:04:09 2014
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Tue, 28 Oct 2014 11:04:09 -0700
Subject: [Owasp-modsecurity-core-rule-set] Require Mod_Security rule for
 preventing random query sting DOS attacks
In-Reply-To: <53CDA9CCB03E0846B68EEA5D8E40FB7FDAA7C651@DOHQDQMX03.qr.qrgrp.local>
References: <53CDA9CCB03E0846B68EEA5D8E40FB7FDAA7C3A2@DOHQDQMX03.qr.qrgrp.local>
	<CAANsTqghhJm6AWADEtjRMmWZBHVj+VZWho4xHmS1h=ZJfEzzjw@mail.gmail.com>
	<53CDA9CCB03E0846B68EEA5D8E40FB7FDAA7C651@DOHQDQMX03.qr.qrgrp.local>
Message-ID: <D0754D5D.120B88%rbarnett@trustwave.com>

An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20141028/1814d2d9/attachment-0003.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: ~WRD000.jpg
Type: image/jpeg
Size: 823 bytes
Desc: ~WRD000.jpg
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20141028/1814d2d9/attachment-0003.jpg>
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: ATT00001.txt
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20141028/1814d2d9/attachment-0001.txt>

From ctummalapalli at qatarairways.com.qa  Wed Oct 29 09:19:19 2014
From: ctummalapalli at qatarairways.com.qa (Chaitanya Kumar Tummalapalli)
Date: Wed, 29 Oct 2014 09:19:19 +0000
Subject: [Owasp-modsecurity-core-rule-set] Require Mod_Security rule for
 preventing random query sting DOS attacks
In-Reply-To: <D0754D5D.120B88%rbarnett@trustwave.com>
References: <53CDA9CCB03E0846B68EEA5D8E40FB7FDAA7C3A2@DOHQDQMX03.qr.qrgrp.local>
	<CAANsTqghhJm6AWADEtjRMmWZBHVj+VZWho4xHmS1h=ZJfEzzjw@mail.gmail.com>
	<53CDA9CCB03E0846B68EEA5D8E40FB7FDAA7C651@DOHQDQMX03.qr.qrgrp.local>
	<D0754D5D.120B88%rbarnett@trustwave.com>
Message-ID: <53CDA9CCB03E0846B68EEA5D8E40FB7FDAA7C917@DOHQDQMX03.qr.qrgrp.local>

Hello Ryan,

Thanks a lot for your reply.

I tried using the rule .. I have place these three lines in modsecurity_crs_10_config.conf without execute action.

But no luck, Rule is not dropping requests like index.html?~5678788.

I'm novice to mod_security hence not conversant to tweak the rule.

Chaitanya Kumar Tummalapalli
TS Controller
I n f o r m a t i o n  T e c h n o l o g y
M :  ( + 9 7 4 )  3 3 6 9 - 0915  | P :  ( + 9 7 4 )  4022 - 7486 | (ctummalapalli at qatarairways.com.qa<mailto:ctummalapalli at qatarairways.com.qa>)

W o r l d ' s  5 - s t a r  a i r l i n e  | www.  q a t a r a i r w a y s . c o m

From: Ryan Barnett [mailto:RBarnett at trustwave.com]
Sent: 28 October 2014 9:04 PM
To: Chaitanya Kumar Tummalapalli; Joerg Stephan
Cc: owasp-modsecurity-core-rule-set at lists.owasp.org
Subject: Re: [Owasp-modsecurity-core-rule-set] Require Mod_Security rule for preventing random query sting DOS attacks

You could write up some ModSecurity rules that would check for these types of request anomalies and block.  Try these (untested) -

SecRule &ARGS_GET_NAMES "@eq 1" "chain,phase:1,t:none,drop,msg:'Botnet DDoS Attack Detected'"
SecRule ARGS_GET "@rx ^$" "chain"
SecRule ARGS_GET_NAMES "@rx ^\-?\d{8,10}$" "exec:/path/to/blacklist.sh"

Not the last line has an execute action where you can do things much like Fail2Ban where you can have a shell script that will talk to a local/remote Firewall device and dynamically update the ACLs to blacklist the client IP address.

Ryan Barnett
Senior Lead Security Researcher, SpiderLabs

Trustwave | SMART SECURITY ON DEMAND
www.trustwave.com<http://www.trustwave.com/>

From: Chaitanya Kumar Tummalapalli <ctummalapalli at qatarairways.com.qa<mailto:ctummalapalli at qatarairways.com.qa>>
Date: Tuesday, October 28, 2014 10:00 AM
To: Joerg Stephan <joerg.stephan at owasp.org<mailto:joerg.stephan at owasp.org>>
Cc: "owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>" <owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>>
Subject: Re: [Owasp-modsecurity-core-rule-set] Require Mod_Security rule for preventing random query sting DOS attacks

Hello Joerg,

Thanks for your reply.

In our analysis of access logs the attacker has used 436 IP's (botnets) to generate this 1.2 million requests with random number queries. Within 20 minutes time.

So on an average we have got 2750 requests from one single IP.

Our web site which was under attack  has maximum of 45 valid known query strings and beyond them can be treated as spurious like below

122.226.28.22, 23.212.108.67 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?953341233 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/536.11 (KHTML, like Gecko) Chrome/20.0.1132.47 Safari/536.11"
120.28.113.179, 23.212.108.67 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?2110115717 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_6_8) AppleWebKit/536.5 (KHTML, like Gecko) Chrome/19.0.1084.56 Safari/536.5"
93.183.239.56, 23.212.108.73 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?-404454353 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Windows NT 5.1; rv:5.0.1) Gecko/20100101 Firefox/5.0.1"
221.178.236.122, 23.212.108.73 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?-304549227 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Windows NT 6.1; rv:12.0) Gecko/20100101 Firefox/12.0"
117.25.192.227, 23.212.108.67 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?-1186515202 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.6; rv:13.0) Gecko/20100101 Firefox/13.0.1"
60.174.55.148, 23.212.108.70, 2.18.243.13 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?-16740259 HTTP/1.1" 200 2797 "-" "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)"
218.63.78.48, 23.212.108.73 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?-441220308 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Windows NT 6.1) AppleWebKit/536.5 (KHTML, like Gecko) Chrome/19.0.1084.56 Safari/536.5"
183.63.45.186, 23.212.108.73 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?-1330852491 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:12.0) Gecko/20100101 Firefox/12.0"
213.148.184.156, 23.212.108.63, 2.18.243.13 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?-1092903431 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Windows NT 6.1) AppleWebKit/536.11 (KHTML, like Gecko) Chrome/20.0.1132.47 Safari/536.11"
61.133.234.21, 23.212.108.67 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?-1925985494 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Windows NT 6.1; rv:5.0) Gecko/20100101 Firefox/5.02"
125.74.189.77, 23.212.108.67 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?1261388031 HTTP/1.1" 200 2797 "-" "Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.0; Trident/4.0; Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1) ; .NET CLR 3.5.30729)"

Vaild query string will look like this

82.79.99.142, 81.196.26.231, 80.239.171.212 - - [28/Oct/2014:16:56:01 +0300] "GET /index.html?q=ro/en HTTP/1.1" 200


So can we think of a rule which drops the requests like /index.html?953341233 this. Or if it can be achieved by mod_evasive . Sorry I'm new to mod_evasive. Could you please elaborate on how to use it.



Chaitanya Kumar Tummalapalli
TS Controller
I n f o r m a t i o n  T e c h n o l o g y
M :  ( + 9 7 4 )  3 3 6 9 - 0915  | P :  ( + 9 7 4 )  4022 - 7486 | (ctummalapalli at qatarairways.com.qa<mailto:ctummalapalli at qatarairways.com.qa>)

W o r l d ' s  5 - s t a r  a i r l i n e  | www.  q a t a r a i r w a y s . c o m

From: Joerg Stephan [mailto:joerg.stephan at owasp.org]
Sent: 28 October 2014 4:34 PM
To: Chaitanya Kumar Tummalapalli
Cc: owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>
Subject: Re: [Owasp-modsecurity-core-rule-set] Require Mod_Security rule for preventing random query sting DOS attacks

Good $localtime,

how many queries have been done by a single ip address?

In my opinion, when it comes to HTTP flooding we will have a problem adjusting the rules, cause it will be hard to determine if it is a valid request or not. In such cases i would prefer using mod_evasive or fail2ban.

Just my 2 cents

Kind regards

Joerg

On Tue, Oct 28, 2014 at 11:59 AM, Chaitanya Kumar Tummalapalli <ctummalapalli at qatarairways.com.qa<mailto:ctummalapalli at qatarairways.com.qa>> wrote:
Hello,

We faced a DDOS Attack on our web site very recently. The nature of attack is a HTTP Flood Attack which raised our bandwidth utilization form 2MBPS to 20 MBPS

We have CDN edge caching servers for content delivery to the end user.

There are around 1.2 Million requests made to the apache web server in 20 minutes with one specific pattern.

For ex: http://www.abc.com/index.html?~77462375<http://scanmail.trustwave.com/?c=4062&d=xafP1ApK3TjrTN55NhvDV4qVJLnpvYD91J3j6tHRzQ&s=5&u=http%3a%2f%2fwww%2eabc%2ecom%2findex%2ehtml%3f%7e77462375>

Request appended with query string with random sequence number.  The Website usually responds with default page for every such request.

But within no time the web servers resources got exhausted and was unable to respond. Leading to total downtime.

I have attached a white paper which describes about similar attacks which we have undergone.

We need a rule from mod_security crs which can defend the attack and drop such kind of requests.

Regards,
Chaitanya

Qatar Airways - Proud member of the oneworld alliance.

[Image removed by sender. OW LOGO]

Disclaimer:- This message (including attachments) is intended solely for the addressee named above. It may be confidential, privileged, subject to copyright, trade secret, or other legal rules and may not be forwarded without the author's permission. If you are not the addressee you must not read, copy or disseminate this message. If you have received it in error please notify the sender immediately and delete the message from all storage devices. Any opinions expressed in this message do not necessarily represent the official positions of Qatar Airways. Any agreements (including any warranties, representations, or offers) concluded with Qatar Airways by using electronic correspondence shall only come into existence if an authorized representative of Qatar Airways has explicitly approved such contract formation. To the fullest extent permissible by law, Qatar Airways disclaim all liability for loss or damage to person or property arising from this message being infected by computer virus or other contamination.

_______________________________________________
Owasp-modsecurity-core-rule-set mailing list
Owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:Owasp-modsecurity-core-rule-set at lists.owasp.org>
https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set<http://scanmail.trustwave.com/?c=4062&d=xafP1ApK3TjrTN55NhvDV4qVJLnpvYD91Jjk69KExw&s=5&u=https%3a%2f%2flists%2eowasp%2eorg%2fmailman%2flistinfo%2fowasp-modsecurity-core-rule-set>


________________________________

This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is strictly prohibited. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20141029/64eeac62/attachment-0001.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: image001.jpg
Type: image/jpeg
Size: 823 bytes
Desc: image001.jpg
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20141029/64eeac62/attachment-0001.jpg>

From RBarnett at trustwave.com  Wed Oct 29 13:44:01 2014
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Wed, 29 Oct 2014 13:44:01 +0000
Subject: [Owasp-modsecurity-core-rule-set] Require Mod_Security rule for
 preventing random query sting DOS attacks
In-Reply-To: <53CDA9CCB03E0846B68EEA5D8E40FB7FDAA7C917@DOHQDQMX03.qr.qrgrp.local>
References: <53CDA9CCB03E0846B68EEA5D8E40FB7FDAA7C3A2@DOHQDQMX03.qr.qrgrp.local>
	<CAANsTqghhJm6AWADEtjRMmWZBHVj+VZWho4xHmS1h=ZJfEzzjw@mail.gmail.com>
	<53CDA9CCB03E0846B68EEA5D8E40FB7FDAA7C651@DOHQDQMX03.qr.qrgrp.local>
	<D0754D5D.120B88%rbarnett@trustwave.com>
	<53CDA9CCB03E0846B68EEA5D8E40FB7FDAA7C917@DOHQDQMX03.qr.qrgrp.local>
Message-ID: <D076646A.120D3F%rbarnett@trustwave.com>

Chaitanya,
The regular expression used in the last SecRule is looking for between 8 to 10 digits characters - http://www.regexper.com/#%5E%5C-%3F%5Cd%7B8%2C10%7D%24.  This was based on the data sample you provided below from the Apache access logs.  The example you showed in your last email only showed 7 digits.  You would therefore need to adjust the final rule regex to be this -

@rx ^\-?\d{7,10}$

Ryan Barnett
Senior Lead Security Researcher, SpiderLabs

Trustwave | SMART SECURITY ON DEMAND
www.trustwave.com<http://www.trustwave.com/>

From: Chaitanya Kumar Tummalapalli <ctummalapalli at qatarairways.com.qa<mailto:ctummalapalli at qatarairways.com.qa>>
Date: Wednesday, October 29, 2014 5:19 AM
To: Ryan Barnett <rbarnett at trustwave.com<mailto:rbarnett at trustwave.com>>
Cc: "owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>" <owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>>, Joerg Stephan <joerg.stephan at owasp.org<mailto:joerg.stephan at owasp.org>>
Subject: RE: [Owasp-modsecurity-core-rule-set] Require Mod_Security rule for preventing random query sting DOS attacks

Hello Ryan,

Thanks a lot for your reply.

I tried using the rule .. I have place these three lines in modsecurity_crs_10_config.conf without execute action.

But no luck, Rule is not dropping requests like index.html?~5678788.

I?m novice to mod_security hence not conversant to tweak the rule.

Chaitanya Kumar Tummalapalli
TS Controller
I n f o r m a t i o n  T e c h n o l o g y
M :  ( + 9 7 4 )  3 3 6 9 - 0915  | P :  ( + 9 7 4 )  4022 - 7486 | (ctummalapalli at qatarairways.com.qa<mailto:ctummalapalli at qatarairways.com.qa>)

W o r l d ' s  5 - s t a r  a i r l i n e  | www.  q a t a r a i r w a y s . c o m

From: Ryan Barnett [mailto:RBarnett at trustwave.com]
Sent: 28 October 2014 9:04 PM
To: Chaitanya Kumar Tummalapalli; Joerg Stephan
Cc: owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>
Subject: Re: [Owasp-modsecurity-core-rule-set] Require Mod_Security rule for preventing random query sting DOS attacks

You could write up some ModSecurity rules that would check for these types of request anomalies and block.  Try these (untested) -

SecRule &ARGS_GET_NAMES "@eq 1" "chain,phase:1,t:none,drop,msg:'Botnet DDoS Attack Detected'"
SecRule ARGS_GET "@rx ^$" "chain"
SecRule ARGS_GET_NAMES "@rx ^\-?\d{8,10}$" "exec:/path/to/blacklist.sh"

Not the last line has an execute action where you can do things much like Fail2Ban where you can have a shell script that will talk to a local/remote Firewall device and dynamically update the ACLs to blacklist the client IP address.

Ryan Barnett
Senior Lead Security Researcher, SpiderLabs

Trustwave | SMART SECURITY ON DEMAND
www.trustwave.com<http://www.trustwave.com/>

From: Chaitanya Kumar Tummalapalli <ctummalapalli at qatarairways.com.qa<mailto:ctummalapalli at qatarairways.com.qa>>
Date: Tuesday, October 28, 2014 10:00 AM
To: Joerg Stephan <joerg.stephan at owasp.org<mailto:joerg.stephan at owasp.org>>
Cc: "owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>" <owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>>
Subject: Re: [Owasp-modsecurity-core-rule-set] Require Mod_Security rule for preventing random query sting DOS attacks

Hello Joerg,

Thanks for your reply.

In our analysis of access logs the attacker has used 436 IP?s (botnets) to generate this 1.2 million requests with random number queries. Within 20 minutes time.

So on an average we have got 2750 requests from one single IP.

Our web site which was under attack  has maximum of 45 valid known query strings and beyond them can be treated as spurious like below

122.226.28.22, 23.212.108.67 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?953341233 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/536.11 (KHTML, like Gecko) Chrome/20.0.1132.47 Safari/536.11"
120.28.113.179, 23.212.108.67 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?2110115717 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_6_8) AppleWebKit/536.5 (KHTML, like Gecko) Chrome/19.0.1084.56 Safari/536.5"
93.183.239.56, 23.212.108.73 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?-404454353 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Windows NT 5.1; rv:5.0.1) Gecko/20100101 Firefox/5.0.1"
221.178.236.122, 23.212.108.73 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?-304549227 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Windows NT 6.1; rv:12.0) Gecko/20100101 Firefox/12.0"
117.25.192.227, 23.212.108.67 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?-1186515202 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.6; rv:13.0) Gecko/20100101 Firefox/13.0.1"
60.174.55.148, 23.212.108.70, 2.18.243.13 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?-16740259 HTTP/1.1" 200 2797 "-" "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)"
218.63.78.48, 23.212.108.73 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?-441220308 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Windows NT 6.1) AppleWebKit/536.5 (KHTML, like Gecko) Chrome/19.0.1084.56 Safari/536.5"
183.63.45.186, 23.212.108.73 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?-1330852491 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:12.0) Gecko/20100101 Firefox/12.0"
213.148.184.156, 23.212.108.63, 2.18.243.13 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?-1092903431 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Windows NT 6.1) AppleWebKit/536.11 (KHTML, like Gecko) Chrome/20.0.1132.47 Safari/536.11"
61.133.234.21, 23.212.108.67 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?-1925985494 HTTP/1.1" 200 2797 "-" "Mozilla/5.0 (Windows NT 6.1; rv:5.0) Gecko/20100101 Firefox/5.02"
125.74.189.77, 23.212.108.67 - - [21/Oct/2014:10:00:26 +0300] "GET /index.html?1261388031 HTTP/1.1" 200 2797 "-" "Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.0; Trident/4.0; Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1) ; .NET CLR 3.5.30729)"

Vaild query string will look like this

82.79.99.142, 81.196.26.231, 80.239.171.212 - - [28/Oct/2014:16:56:01 +0300] "GET /index.html?q=ro/en HTTP/1.1" 200


So can we think of a rule which drops the requests like /index.html?953341233 this. Or if it can be achieved by mod_evasive . Sorry I?m new to mod_evasive. Could you please elaborate on how to use it.



Chaitanya Kumar Tummalapalli
TS Controller
I n f o r m a t i o n  T e c h n o l o g y
M :  ( + 9 7 4 )  3 3 6 9 - 0915  | P :  ( + 9 7 4 )  4022 - 7486 | (ctummalapalli at qatarairways.com.qa<mailto:ctummalapalli at qatarairways.com.qa>)

W o r l d ' s  5 - s t a r  a i r l i n e  | www.  q a t a r a i r w a y s . c o m

From: Joerg Stephan [mailto:joerg.stephan at owasp.org]
Sent: 28 October 2014 4:34 PM
To: Chaitanya Kumar Tummalapalli
Cc: owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>
Subject: Re: [Owasp-modsecurity-core-rule-set] Require Mod_Security rule for preventing random query sting DOS attacks

Good $localtime,

how many queries have been done by a single ip address?

In my opinion, when it comes to HTTP flooding we will have a problem adjusting the rules, cause it will be hard to determine if it is a valid request or not. In such cases i would prefer using mod_evasive or fail2ban.

Just my 2 cents

Kind regards

Joerg

On Tue, Oct 28, 2014 at 11:59 AM, Chaitanya Kumar Tummalapalli <ctummalapalli at qatarairways.com.qa<mailto:ctummalapalli at qatarairways.com.qa>> wrote:
Hello,

We faced a DDOS Attack on our web site very recently. The nature of attack is a HTTP Flood Attack which raised our bandwidth utilization form 2MBPS to 20 MBPS

We have CDN edge caching servers for content delivery to the end user.

There are around 1.2 Million requests made to the apache web server in 20 minutes with one specific pattern.

For ex: http://www.abc.com/index.html?~77462375<http://scanmail.trustwave.com/?c=4062&d=pLHQ1M32dTOx0zDnirzUEX3Q9h_vmqQ2rtb-Uud9iw&s=5&u=http%3a%2f%2fwww%2eabc%2ecom%2findex%2ehtml%3f%7e77462375>

Request appended with query string with random sequence number.  The Website usually responds with default page for every such request.

But within no time the web servers resources got exhausted and was unable to respond. Leading to total downtime.

I have attached a white paper which describes about similar attacks which we have undergone.

We need a rule from mod_security crs which can defend the attack and drop such kind of requests.

Regards,
Chaitanya

Qatar Airways - Proud member of the oneworld alliance.

[Image removed by sender. OW LOGO]

Disclaimer:- This message (including attachments) is intended solely for the addressee named above. It may be confidential, privileged, subject to copyright, trade secret, or other legal rules and may not be forwarded without the author's permission. If you are not the addressee you must not read, copy or disseminate this message. If you have received it in error please notify the sender immediately and delete the message from all storage devices. Any opinions expressed in this message do not necessarily represent the official positions of Qatar Airways. Any agreements (including any warranties, representations, or offers) concluded with Qatar Airways by using electronic correspondence shall only come into existence if an authorized representative of Qatar Airways has explicitly approved such contract formation. To the fullest extent permissible by law, Qatar Airways disclaim all liability for loss or damage to person or property arising from this message being infected by computer virus or other contamination.

_______________________________________________
Owasp-modsecurity-core-rule-set mailing list
Owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:Owasp-modsecurity-core-rule-set at lists.owasp.org>
https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set<http://scanmail.trustwave.com/?c=4062&d=pLHQ1M32dTOx0zDnirzUEX3Q9h_vmqQ2rtP5U-QogQ&s=5&u=https%3a%2f%2flists%2eowasp%2eorg%2fmailman%2flistinfo%2fowasp-modsecurity-core-rule-set>


________________________________

This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is strictly prohibited. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.

________________________________

This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is strictly prohibited. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20141029/815bd0a8/attachment-0001.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: image001.jpg
Type: image/jpeg
Size: 823 bytes
Desc: image001.jpg
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20141029/815bd0a8/attachment-0001.jpg>

From RBarnett at trustwave.com  Wed Oct 29 13:44:01 2014
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Wed, 29 Oct 2014 06:44:01 -0700
Subject: [Owasp-modsecurity-core-rule-set] Require Mod_Security rule for
 preventing random query sting DOS attacks
In-Reply-To: <53CDA9CCB03E0846B68EEA5D8E40FB7FDAA7C917@DOHQDQMX03.qr.qrgrp.local>
References: <53CDA9CCB03E0846B68EEA5D8E40FB7FDAA7C3A2@DOHQDQMX03.qr.qrgrp.local>
	<CAANsTqghhJm6AWADEtjRMmWZBHVj+VZWho4xHmS1h=ZJfEzzjw@mail.gmail.com>
	<53CDA9CCB03E0846B68EEA5D8E40FB7FDAA7C651@DOHQDQMX03.qr.qrgrp.local>
	<D0754D5D.120B88%rbarnett@trustwave.com>
	<53CDA9CCB03E0846B68EEA5D8E40FB7FDAA7C917@DOHQDQMX03.qr.qrgrp.local>
Message-ID: <D076646A.120D3F%rbarnett@trustwave.com>

An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20141029/815bd0a8/attachment-0003.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: image001.jpg
Type: image/jpeg
Size: 823 bytes
Desc: image001.jpg
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20141029/815bd0a8/attachment-0003.jpg>
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: ATT00001.txt
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20141029/815bd0a8/attachment-0001.txt>

