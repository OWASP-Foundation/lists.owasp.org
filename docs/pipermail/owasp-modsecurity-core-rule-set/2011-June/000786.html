<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] [Mod-security-developers] CRS	DoS bugs/suggestions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20%5BMod-security-developers%5D%20CRS%0A%09DoS%20bugs/suggestions&In-Reply-To=CA20BCA5.29064%25rbarnett%40trustwave.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000785.html">
   <LINK REL="Next"  HREF="000787.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] [Mod-security-developers] CRS	DoS bugs/suggestions</H1>
    <B>Oleg Gryb</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20%5BMod-security-developers%5D%20CRS%0A%09DoS%20bugs/suggestions&In-Reply-To=CA20BCA5.29064%25rbarnett%40trustwave.com"
       TITLE="[Owasp-modsecurity-core-rule-set] [Mod-security-developers] CRS	DoS bugs/suggestions">oleg_gryb at yahoo.com
       </A><BR>
    <I>Fri Jun 17 13:58:15 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="000785.html">[Owasp-modsecurity-core-rule-set] [Mod-security-developers] CRS	DoS bugs/suggestions
</A></li>
        <LI>Next message: <A HREF="000787.html">[Owasp-modsecurity-core-rule-set] Announcing the ModSecurity SQL	Injection Challenge
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#786">[ date ]</a>
              <a href="thread.html#786">[ thread ]</a>
              <a href="subject.html#786">[ subject ]</a>
              <a href="author.html#786">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>No, I think it's a logical error. !ip.dos_counter is called only  after 
dos_counter reached the threshold. Now, think about the following  scenario:

1. I've sent a couple of requests
2. Waited for more than dos_burst_time_slice seconds hoping that it will clear 
the dos_counter
3. Send some requests again. All of them will be added to the dos_counter 
becuase it didn't expire.

All that means that you can keep adding to dos_counter for a very long  period 
of time, which is much longer than dos_burst_time_slice and it  defeats the 
purpose of dos_burst_time_slice parameter in my view.





----- Original Message ----
&gt;<i> From: Ryan Barnett &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">RBarnett at trustwave.com</A>&gt;
</I>&gt;<i> To: &quot;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">oleg at gryb.info</A>&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">oleg at gryb.info</A>&gt;; 
</I>&gt;<i>&quot;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">mod-security-developers at lists.sourceforge.net</A>&quot; 
</I>&gt;<i>&lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">mod-security-developers at lists.sourceforge.net</A>&gt;
</I>&gt;<i> Sent: Fri, June 17, 2011 5:15:57 AM
</I>&gt;<i> Subject: Re: [Mod-security-developers] CRS DoS bugs/suggestions
</I>&gt;<i> 
</I>&gt;<i> Oleg,
</I>&gt;<i> First of all, thank you for taking the time to test these rules  further.  The 
</I>&gt;<i>rule quality will only improve if the community takes the  time to test them and 
</I>&gt;<i>report back the status.
</I>&gt;<i> 
</I>&gt;<i> To your comments about the  lack of &quot;expirevar&quot; actions, this should not be 
</I>&gt;<i>needed for the ip.dos_counter  var as the last rule uses the 
</I>&gt;<i>&quot;setvar:!ip.dos_counter&quot; action to actually remove  that variable if the 
</I>&gt;<i>operator matches.  Can you please check your debug log  during testing to verify 
</I>&gt;<i>if that action is not removing that variable?   Perhaps there is a bug in 
</I>&gt;<i>removing the variable with the &quot;!&quot; symbol and using  expirevar is more reliable.
</I>&gt;<i> 
</I>&gt;<i> Also &#8211; what version of ModSecurity are you  using?
</I>&gt;<i> 
</I>&gt;<i> -Ryan
</I>&gt;<i> 
</I>&gt;<i> From: Oleg Gryb &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">oleg_gryb at yahoo.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">oleg_gryb at yahoo.com</A>&gt;&gt;
</I>&gt;<i> Reply-To:  &quot;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">oleg at gryb.info</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">oleg at gryb.info</A>&gt;&quot; 
</I>&gt;<i>&lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">oleg at gryb.info</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">oleg at gryb.info</A>&gt;&gt;, 
</I>&gt;<i>&quot;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">mod-security-developers at lists.sourceforge.net</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">mod-security-developers at lists.sourceforge.net</A>&gt;&quot;
</I>&gt;<i>  
</I>&gt;<i>&lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">mod-security-developers at lists.sourceforge.net</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">mod-security-developers at lists.sourceforge.net</A>&gt;&gt;
</I>&gt;<i>
</I>&gt;<i> Date:  Thu, 16 Jun 2011 11:32:11 -0500
</I>&gt;<i> To: 
</I>&gt;<i>&quot;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">mod-security-developers at lists.sourceforge.net</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">mod-security-developers at lists.sourceforge.net</A>&gt;&quot;
</I>&gt;<i>  
</I>&gt;<i>&lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">mod-security-developers at lists.sourceforge.net</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">mod-security-developers at lists.sourceforge.net</A>&gt;&gt;
</I>&gt;<i>
</I>&gt;<i> Subject:  [Mod-security-developers] CRS DoS bugs/suggestions
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I was testing DoS  ruleset lately and found that there probably was a bug 
</I>&gt;<i>related to ip.dos_counter  variable. The expiration time was not set for this 
</I>&gt;<i>var, as a result the counter  persists longer than tx.dos_burst_time_slice. As a 
</I>&gt;<i>result, the history of hits  is counted for a longer time period.
</I>&gt;<i> 
</I>&gt;<i> I've added expiration time in two  places and it started to work correctly 
</I>&gt;<i>after that. The changes are  below:
</I>&gt;<i> 
</I>&gt;<i> SecRule REQUEST_BASENAME &quot;!\.(jpe?g|png|gif|js|css|ico)$&quot;  
</I>&gt;<i>&quot;phase:5,t:none,nolog,pass,setvar:ip.dos_counter=+1,expirevar:ip.dos_counter=%{tx.dos_burst_time_slice}&quot;
</I>&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> ...
</I>&gt;<i> 
</I>&gt;<i> SecRule  IP:DOS_COUNTER &quot;@ge %{tx.dos_counter_threshold}&quot;  
</I>&gt;<i>&quot;phase:5,t:none,nolog,pass,t:none,setvar:ip.dos_burst_counter=+1,expirevar:ip.dos_burst_counter=%{tx.dos_burst_time_slice},setvar:!ip.dos_counter,expirevar:ip.dos_counter=%{tx.dos_burst_time_slice}&quot;
</I>&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> I've  also attached the sample of testing program. I think, we should have 
</I>&gt;<i>something  like that to test all limits. There are only two tests implemented 
</I>&gt;<i>for now: for  request size and DoS, but it should be easy to add  more.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ________________________________
</I>&gt;<i> This transmission may  contain information that is privileged, confidential, 
</I>&gt;<i>and/or exempt from  disclosure under applicable law. If you are not the intended 
</I>&gt;<i>recipient, you are  hereby notified that any disclosure, copying, distribution, 
</I>&gt;<i>or use of the  information contained herein (including any reliance thereon) is 
</I>&gt;<i>STRICTLY  PROHIBITED. If you received this transmission in error, please 
</I>&gt;<i>immediately  contact the sender and destroy the material in its entirety, 
</I>&gt;<i>whether in  electronic or hard copy format.
</I>&gt;<i> 
</I>&gt;<i> 
</I></PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000785.html">[Owasp-modsecurity-core-rule-set] [Mod-security-developers] CRS	DoS bugs/suggestions
</A></li>
	<LI>Next message: <A HREF="000787.html">[Owasp-modsecurity-core-rule-set] Announcing the ModSecurity SQL	Injection Challenge
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#786">[ date ]</a>
              <a href="thread.html#786">[ thread ]</a>
              <a href="subject.html#786">[ subject ]</a>
              <a href="author.html#786">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
