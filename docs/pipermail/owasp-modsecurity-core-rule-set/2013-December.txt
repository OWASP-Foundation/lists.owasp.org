From RBarnett at trustwave.com  Mon Dec  2 19:29:12 2013
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Mon, 2 Dec 2013 19:29:12 +0000
Subject: [Owasp-modsecurity-core-rule-set] Location/LocationMatch
 failing to disable rules
In-Reply-To: <CAONsccWC47rqTeVeFNr272P=VuL_tXAfo4PWpj3YkYQJXOX7kQ@mail.gmail.com>
References: <CAEHCsU+1re8UuVBz3Pv18SByQjfoCkq_sGYBMipkACdcbhU8Ew@mail.gmail.com>
	<CAONsccWC47rqTeVeFNr272P=VuL_tXAfo4PWpj3YkYQJXOX7kQ@mail.gmail.com>
Message-ID: <CEC2496D.C709C%rbarnett@trustwave.com>


From: Phill Watkins <phill.watkins at gmail.com<mailto:phill.watkins at gmail.com>>
Date: Tuesday, November 26, 2013 4:54 PM
To: OWASP CRS Mailing List <owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>>
Subject: [Owasp-modsecurity-core-rule-set] Location/LocationMatch failing to disable rules

This has solved my problem.

Thank you and everyone who has chimed in on this.

One last question though. Is this generally a better approach than using Location, LocationMatch etc to disable rules?

Personally, I believe it is however it is visually more intuitive to group rules within Apache scope locations.  The downside of that approach is what you are running into here.

-Ryan



On Tuesday, November 26, 2013, Ryan Barnett wrote:
Hey Phil,
Based on the info you gave about your setup, I think I know what the issue might be.  First of all, take a look at this Apache request flow diagram on the ModSecurity Reference Manual Wiki page -
https://github.com/SpiderLabs/ModSecurity/wiki/Reference-Manual#wiki-Processing_Phases

This diagram shows where ModSecurity's Phase hooks are.  With this as a visual backdrop, now understand that if you place any ModSecurity rules or directives inside Apache scope locations (<Location>, <LocationMatch>, <Directory>, etc?) then they will only be available to ModSecurity in Phase:2 (Fixup hook).  The issue, most likely, is that your AJP proxying is happening before the Fixup Phase:2 hook so your rules/exceptions are not working.

What I recommend for you situation would be to use SecRules + ctl:ruleRemoveById action in Phase:1 instead of nesting them within Apache scope locations.  Something like this (untested) added to a modsecurity_crs_15_custon.conf file so that it runs before the rest of the CRS rules -

   SecRule REQUEST_FILENAME "@beginsWith /subsonic/" "id:1234,phase:1,t:none,nolog,pass,ctl:ruleRemoveById=330792"

One other note ? you might need to recompile with "--enable-request-early" to get this to work in the "post-read-request" hook  (https://github.com/SpiderLabs/ModSecurity/wiki/Reference-Manual#wiki-Configure_ModSecurity)

Hope this info helps.

--
Ryan Barnett
Trustwave SpiderLabs
ModSecurity Project Leader
OWASP ModSecurity CRS Project Leader


From: Phill Watkins <phill.watkins at gmail.com>
Date: Monday, November 25, 2013 6:45 AM
To: OWASP CRS Mailing List <owasp-modsecurity-core-rule-set at lists.owasp.org>
Subject: [Owasp-modsecurity-core-rule-set] Location/LocationMatch failing to disable rules

Hi,

For some reason I'm struggling to to disable rules using SecRuleRemoveById inside a Location or LocationMatch.

I can disable rules globally (which isn't ideal) so I know the directive works but I don't know why Apache doesn't act upon the Location/LocationMatch.

One of the applications on my web server that I'm trying to disable a rule for is Subsonic. Subsonic requires Tomcat and is a connected to Apache via the AJP connector module.

I have successfully disabled one of the Atomicorp delayed rules in the past like this:

<IfModule mod_jk.c>
JkMount /subsonic ajp13_worker
JkMount /subsonic/* ajp13_worker
<Location /subsonic/upload.view>
SecRuleRemoveById 330792
</Location>
</IfModule>

I am now trying to disable rule 960010 from the CRS for the entire application because of too many false positives.

I have tried <Location /subsonic/>  as well as multiple regular expressions for days but nothing works.

Here is an example from the audit log:

--35e37e6c-A--
[12/Nov/2013:12:19:05 +0000] UoIcuX8AAQEAAAJ3AQgAAAAA hidden 45509 hidden 443
--35e37e6c-B--
POST /subsonic/dwr/call/plaincall/nowPlayingService.getNowPlaying.dwr HTTP/1.1
Host: hidden
Connection: keep-alive
Content-Length: 214
Origin: https://hidden
User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/30.0.1599.114 Safari/537.36
Content-Type: text/plain
Accept: */*
Referer: https://hidden/subsonic/right.view?
Accept-Encoding: gzip,deflate,sdch
Accept-Language: en-GB,en-US;q=0.8,en;q=0.6
Cookie: player-656c6c6965=6; player-73727661646d=6; JSESSIONID=088A746CDC6B4356A388E7C1D44EEE6A.ajp13_worker; player-7068696c6c=9; compact_display_state=false

--35e37e6c-F--
HTTP/1.1 403 Forbidden
Vary: Accept-Encoding
Content-Encoding: gzip
Content-Length: 221
Keep-Alive: timeout=5, max=88
Connection: Keep-Alive
Content-Type: text/html; charset=iso-8859-1

--35e37e6c-H--
Message: Access denied with code 403 (phase 1). Match of "rx ^%{tx.allowed_request_content_type}$" against "TX:0" required. [file "/etc/apache2/owasp-modsecurity-crs/activated_rules/modsecurity_crs_30_http_policy.conf"] [line "64"] [id "960010"] [rev "2"] [msg "Request content type is not allowed by policy"] [data "text/plain"] [severity "CRITICAL"] [ver "OWASP_CRS/2.2.8"] [maturity "9"] [accuracy "9"] [tag "OWASP_CRS/POLICY/ENCODING_NOT_ALLOWED"] [tag "WASCTC/WASC-20"] [tag "OWASP_TOP_10/A1"] [tag "OWASP_AppSensor/EE2"] [tag "PCI/12.1"]
Action: Intercepted (phase 1)
Stopwatch: 1384258745437774 1085 (- - -)
Stopwatch2: 1384258745437774 1085; combined=426, p1=363, p2=0, p3=0, p4=0, p5=63, sr=48, sw=0, l=0, gc=0
Producer: ModSecurity for Apache/2.7.5 (http://www.modsecurity.org/); OWASP_CRS/2.2.8.<http://2.2.8.>
Server: Apache
Engine-Mode: "ENABLED"

--35e37e6c-Z--

I'd be grateful of any advice.

Thanks for your time.


________________________________

This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is strictly prohibited. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.

________________________________

This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is strictly prohibited. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20131202/1bd99929/attachment.html>

From fzipi at fing.edu.uy  Mon Dec  2 19:54:38 2013
From: fzipi at fing.edu.uy (Felipe Zipitria)
Date: Mon, 02 Dec 2013 17:54:38 -0200
Subject: [Owasp-modsecurity-core-rule-set] Global Piwik support?
Message-ID: <529CE57E.7050504@fing.edu.uy>


-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Ryan et al.,

I've been struggling trying to exclude from our rules false positives in
piwik analytics. I tried using "SecUpdateTargetBy*", or matching
specifically using SecRule REQUEST_URI and 'ctl:remove*', without success.

In the meantime, I saw that there is a global exclusion for Google
analytics cookies (__utm) , but no for Piwik cookies (_pk_ref).

Using that information, I made my exclusion on all rules, using this
oneliner:

<code>
for rulefile in activated_rules/*.conf; do sed -i -e
's@:/__utm/@:'/_(_utm|pk_ref)/'@g' $rulefile; done
</code>

at my 'activated_rules' directory. As this applies to the core ruleset,
surely it will be overwritten at the next update.

Could this addition made it into default rules (well, google analytics
is already there, so...)? All Piwik users will be grateful :)

Regards,

Felipe.


-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.15 (GNU/Linux)
Comment: Using GnuPG with Thunderbird - http://www.enigmail.net/

iEYEARECAAYFAlKc5X4ACgkQH2cTtfSrHKkQuQCaApKKGngkByPErrxIhsR78GKQ
Ih8AoIGm887bjG5H7eIsM+g7VI9F4Zt8
=zADt
-----END PGP SIGNATURE-----


From christian.folini at time-machine.ch  Mon Dec 16 05:38:29 2013
From: christian.folini at time-machine.ch (Christian Folini)
Date: Mon, 16 Dec 2013 06:38:29 +0100
Subject: [Owasp-modsecurity-core-rule-set] Update to
 http://blog.spiderlabs.com/2011/08/modsecurity-advanced-topic-of-the-week-exception-handling.html
Message-ID: <20131216053829.GA26660@elias>

Hi there,

The blog post 
http://blog.spiderlabs.com/2011/08/modsecurity-advanced-topic-of-the-week-exception-handling.html
has been updated for changes in the rule engine. So I think it is still 
the reference on the handling of false positives.

In the section on Anomaly Scoring Exceptions, the inbound anomaly score
is being referenced as tx.anomaly_score, while the core rules reference
it as tx.inbound_anomaly_score.

I think this should be fixed.

Cheers,

Christian

-- 
If you have men who will only come if they know there is a good road, 
I don't want them. I want men who will come if there is no road at all.
-- David Livingstone

From FCosta at trustwave.com  Tue Dec 17 20:29:41 2013
From: FCosta at trustwave.com (Felipe Costa)
Date: Tue, 17 Dec 2013 20:29:41 +0000
Subject: [Owasp-modsecurity-core-rule-set] ModSecurity release 2.7.6
Message-ID: <047B2ED9-D2E9-49F2-9EC4-74BFB38E5DCC@trustwave.com>

Hi,

We are pleased to announce ModSecurity release 2.7.6. Besides the bug fixes this release also includes modification on the build system that counts on QA mechanisms such as coding style checker and static analysis. All ports and all platforms had some changes that may reduce the possibility of errors while trying to compile the project. Regression tests and unit tests are now more independent of platform or utilities versions. There is a new installer for MS Windows. Libinjection was updated. For further information on the changes, please check the release notes. For more information about the fixed bugs or to report a new one, have a look at our Issues on GitHub.<https://github.com/SpiderLabs/ModSecurity/issues>

It is also a pleasure to announce that we now have a Buildbot to help us to control the quality of our code/releases. For each build, the Buildbots are building the code,  checking coding style and doing a static analysis. Unit tests and regression tests are also performed. Compilation warnings are been monitored on our different ports/platforms. To follow up our builds, have a visit at: http://www.modsecurity.org/developers/buildbot

All releases that were archived as Branches on our git are now archived as Tags, not appearing on the Branch list anymore, but still available under Tags. New features now will be placed under specific branches, for continuous testing until the stability is ensured and then merge at branch master to be released.

Thanks,
Felipe "Zimmerle" Costa
Lead Developer for ModSecurity, SpiderLabs
m: +55 81 8706.5547

Trustwave | SMART SECURITY ON DEMAND
www.trustwave.com<http://www.trustwave.com/>

________________________________

This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is strictly prohibited. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20131217/f92bc7f5/attachment.html>

From tmunyai at easypay.co.za  Wed Dec 18 06:26:45 2013
From: tmunyai at easypay.co.za (Tendani Munyai)
Date: Wed, 18 Dec 2013 08:26:45 +0200
Subject: [Owasp-modsecurity-core-rule-set] I have commented
	modsecurity_crs_23_request_limits.conf
In-Reply-To: <mailman.17.1387195204.26176.owasp-modsecurity-core-rule-set@lists.owasp.org>
References: <mailman.17.1387195204.26176.owasp-modsecurity-core-rule-set@lists.owasp.org>
Message-ID: <52B14025.9050602@easypay.co.za>

Hi,

I have commented modsecurity_crs_23_request_limits.conf. I want to know 
whether i'm still gonna be OWASP compliant.

Thanks in advance.
Tendani

On 16/12/2013 14:00, 
owasp-modsecurity-core-rule-set-request at lists.owasp.org wrote:
> Send Owasp-modsecurity-core-rule-set mailing list submissions to
> 	owasp-modsecurity-core-rule-set at lists.owasp.org
>
> To subscribe or unsubscribe via the World Wide Web, visit
> 	https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>
> or, via email, send a message with subject or body 'help' to
> 	owasp-modsecurity-core-rule-set-request at lists.owasp.org
>
> You can reach the person managing the list at
> 	owasp-modsecurity-core-rule-set-owner at lists.owasp.org
>
> When replying, please edit your Subject line so it is more specific
> than "Re: Contents of Owasp-modsecurity-core-rule-set digest..."
>
>
> Today's Topics:
>
>     1. Update to
>        http://blog.spiderlabs.com/2011/08/modsecurity-advanced-topic-of-the-week-exception-handling.html
>        (Christian Folini)
>
>
> ----------------------------------------------------------------------
>
> Message: 1
> Date: Mon, 16 Dec 2013 06:38:29 +0100
> From: Christian Folini <christian.folini at time-machine.ch>
> To: owasp-modsecurity-core-rule-set at lists.owasp.org
> Subject: [Owasp-modsecurity-core-rule-set] Update to
> 	http://blog.spiderlabs.com/2011/08/modsecurity-advanced-topic-of-the-week-exception-handling.html
> 	
> Message-ID: <20131216053829.GA26660 at elias>
> Content-Type: text/plain; charset=utf-8
>
> Hi there,
>
> The blog post
> http://blog.spiderlabs.com/2011/08/modsecurity-advanced-topic-of-the-week-exception-handling.html
> has been updated for changes in the rule engine. So I think it is still
> the reference on the handling of false positives.
>
> In the section on Anomaly Scoring Exceptions, the inbound anomaly score
> is being referenced as tx.anomaly_score, while the core rules reference
> it as tx.inbound_anomaly_score.
>
> I think this should be fixed.
>
> Cheers,
>
> Christian
>


From FCosta at trustwave.com  Thu Dec 19 13:55:55 2013
From: FCosta at trustwave.com (Felipe Costa)
Date: Thu, 19 Dec 2013 13:55:55 +0000
Subject: [Owasp-modsecurity-core-rule-set] ModSecurity Release 2.7.7
Message-ID: <BFC86740-E7F7-4570-B2F8-E1233D284CF4@trustwave.com>

Hi,

ModSecurity Release 2.7.7 is ready. It contains small fixes to allow an easy integration to packaging generation and build automation. Tarball were renamed to fit the same structure of older releases and configure scripts were placed back as part of the Tarball. For further information on the changes check the release notes<https://github.com/SpiderLabs/ModSecurity/releases>. For issues, please check the Issues on GitHub<https://github.com/SpiderLabs/ModSecurity/issues?direction=desc&sort=created&state=open>.

Archives also available at:

  *   Apache/Nginx:
     *   https://www.modsecurity.org/tarball/2.7.7/modsecurity-apache_2.7.7.tar.gz
     *   https://www.modsecurity.org/tarball/2.7.7/modsecurity-apache_2.7.7.tar.gz.sha256
  *   IIS
     *   https://www.modsecurity.org/tarball/2.7.7/modsecurity-apache_2.7.7-32b.msi
     *   https://www.modsecurity.org/tarball/2.7.7/modsecurity-apache_2.7.7-32b.msi.sha256
     *   https://www.modsecurity.org/tarball/2.7.7/modsecurity-apache_2.7.7-64b.msi
     *   https://www.modsecurity.org/tarball/2.7.7/modsecurity-apache_2.7.7-64b.msi.sha256


Thanks,
Felipe "Zimmerle" Costa
Lead Developer for ModSecurity, SpiderLabs

Trustwave | SMART SECURITY ON DEMAND
www.trustwave.com<http://www.trustwave.com/>

________________________________

This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is strictly prohibited. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20131219/fea25fef/attachment.html>

From marcus.semblano at locaweb.com.br  Thu Dec 19 14:11:34 2013
From: marcus.semblano at locaweb.com.br (Marcus Semblano)
Date: Thu, 19 Dec 2013 14:11:34 +0000
Subject: [Owasp-modsecurity-core-rule-set] [mod-security-users]
	ModSecurity Release 2.7.7
In-Reply-To: <BFC86740-E7F7-4570-B2F8-E1233D284CF4@trustwave.com>
References: <BFC86740-E7F7-4570-B2F8-E1233D284CF4@trustwave.com>
Message-ID: <2A6AC8A64E822C499B733990C81B79C6AEBAE178@srvexchmbx02.fabrica.locaweb.com.br>

Is IIS package called modsecurity-apache_2.7.7-64b.msi<https://www.modsecurity.org/tarball/2.7.7/modsecurity-apache_2.7.7-64b.msi>?


 Atenciosamente,

Marcus Semblano
CT - Seguran?a | Security Specialist
T: 11 3544-0444

Locaweb ? www.locaweb.com.br<http://www.locaweb.com.br>
L?der em Hosting Infrastructure Services no Brasil e na Am?rica Latina em 2012, segundo a IDC

________________________________
From: Felipe Costa [FCosta at trustwave.com]
Sent: Thursday, December 19, 2013 11:57 AM
To: <mod-security-users at lists.sourceforge.net>; mod-security-developers at lists.sourceforge.net; mod-security-packagers at lists.sourceforge.net; owasp-modsecurity-core-rule-set at lists.owasp.org
Subject: [mod-security-users] ModSecurity Release 2.7.7

Hi,

ModSecurity Release 2.7.7 is ready. It contains small fixes to allow an easy integration to packaging generation and build automation. Tarball were renamed to fit the same structure of older releases and configure scripts were placed back as part of the Tarball. For further information on the changes check the release notes<https://github.com/SpiderLabs/ModSecurity/releases>. For issues, please check the Issues on GitHub<https://github.com/SpiderLabs/ModSecurity/issues?direction=desc&sort=created&state=open>.

Archives also available at:

  *   Apache/Nginx:
     *   https://www.modsecurity.org/tarball/2.7.7/modsecurity-apache_2.7.7.tar.gz
     *   https://www.modsecurity.org/tarball/2.7.7/modsecurity-apache_2.7.7.tar.gz.sha256
  *   IIS
     *   https://www.modsecurity.org/tarball/2.7.7/modsecurity-apache_2.7.7-32b.msi
     *   https://www.modsecurity.org/tarball/2.7.7/modsecurity-apache_2.7.7-32b.msi.sha256
     *   https://www.modsecurity.org/tarball/2.7.7/modsecurity-apache_2.7.7-64b.msi
     *   https://www.modsecurity.org/tarball/2.7.7/modsecurity-apache_2.7.7-64b.msi.sha256


Thanks,
Felipe "Zimmerle" Costa
Lead Developer for ModSecurity, SpiderLabs

Trustwave | SMART SECURITY ON DEMAND
www.trustwave.com<http://www.trustwave.com/>

________________________________

This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is strictly prohibited. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20131219/9caa09ab/attachment.html>

