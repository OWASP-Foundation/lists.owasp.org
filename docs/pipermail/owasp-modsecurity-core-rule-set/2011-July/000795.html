<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Problem with	modsecurity_crs_16_session_hijacking.conf
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20Problem%20with%0A%09modsecurity_crs_16_session_hijacking.conf&In-Reply-To=CAFW5hxB2WGzDWj3pCfyHPUxxVdo4y-bYwnJq-wHmZuEwA8afkg%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000794.html">
   <LINK REL="Next"  HREF="000796.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Problem with	modsecurity_crs_16_session_hijacking.conf</H1>
    <B>Michael Haas</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20Problem%20with%0A%09modsecurity_crs_16_session_hijacking.conf&In-Reply-To=CAFW5hxB2WGzDWj3pCfyHPUxxVdo4y-bYwnJq-wHmZuEwA8afkg%40mail.gmail.com"
       TITLE="[Owasp-modsecurity-core-rule-set] Problem with	modsecurity_crs_16_session_hijacking.conf">michael.haas10 at gmail.com
       </A><BR>
    <I>Sat Jul 16 14:24:30 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="000794.html">[Owasp-modsecurity-core-rule-set] Problem with	modsecurity_crs_16_session_hijacking.conf
</A></li>
        <LI>Next message: <A HREF="000796.html">[Owasp-modsecurity-core-rule-set] Problem	with	modsecurity_crs_16_session_hijacking.conf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#795">[ date ]</a>
              <a href="thread.html#795">[ thread ]</a>
              <a href="subject.html#795">[ subject ]</a>
              <a href="author.html#795">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

i think the Rule should be changed to something like that

SecRule TX:IP &quot;^(\d{1,3}\.\d{1,3}\.\d{1,3}\.)&quot;
 &quot;chain,phase:3,id:'981063',t:none,nolog,pass&quot;
        SecRule MATCHED_VARS &quot;(.*)&quot;
&quot;capture,t:none,t:sha1,t:hexEncode,nolog,setvar:session.ip=%{tx.1}&quot;

then it works too.

Michael

2011/7/15 Michael Haas &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">michael.haas10 at gmail.com</A>&gt;

&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> Yes i'm using
</I>&gt;<i> <A HREF="http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/optional_rules/modsecurity_crs_16_session_hijacking.conf">http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/optional_rules/modsecurity_crs_16_session_hijacking.conf</A>
</I>&gt;<i> .
</I>&gt;<i> if i look at a debug log i see that the session.ip is not saved, i think it
</I>&gt;<i> doesn't capture because it doesn't match.
</I>&gt;<i>
</I>&gt;<i> Rule 822ce0: SecRule &quot;TX:IP&quot; &quot;@rx ^(\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.)&quot;
</I>&gt;<i> &quot;phase:3,auditlog,id:981063,capture,t:none,t:sha1,t:hexEncode,nolog,pass,setvar:session.ip=%{tx.1}&quot;
</I>&gt;<i> T (0) sha1: &quot;\xb5O`\x10\x1bj\xed\xdf\x81J\x8f\xfb\x11\x98^K\xfc{t4&quot;
</I>&gt;<i> T (0) hexEncode: &quot;b54f60101b6aeddf814a8ffb11985e4bfc7b7434&quot;
</I>&gt;<i> Transformation completed in 24 usec.
</I>&gt;<i> Executing operator &quot;rx&quot; with param &quot;^(\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.)&quot;
</I>&gt;<i> against TX:ip.
</I>&gt;<i> Target value: &quot;b54f60101b6aeddf814a8ffb11985e4bfc7b7434&quot;
</I>&gt;<i> Operator completed in 2 usec.
</I>&gt;<i> Rule returned 0.
</I>&gt;<i> No match, not chained -&gt; mode NEXT_RULE.
</I>&gt;<i>
</I>&gt;<i> If i use this Rule it captures because it matches.
</I>&gt;<i>
</I>&gt;<i> Rule 822cc8: SecRule &quot;TX:IP&quot; &quot;@rx (.*)&quot;
</I>&gt;<i> &quot;phase:3,auditlog,id:981063,capture,t:none,t:sha1,t:hexEncode,nolog,pass,setvar:session.ip=%{tx.1}&quot;
</I>&gt;<i> T (0) sha1: &quot;\xb5O`\x10\x1bj\xed\xdf\x81J\x8f\xfb\x11\x98^K\xfc{t4&quot;
</I>&gt;<i> T (0) hexEncode: &quot;b54f60101b6aeddf814a8ffb11985e4bfc7b7434&quot;
</I>&gt;<i> Transformation completed in 24 usec.
</I>&gt;<i> Executing operator &quot;rx&quot; with param &quot;(.*)&quot; against TX:ip.
</I>&gt;<i> Target value: &quot;b54f60101b6aeddf814a8ffb11985e4bfc7b7434&quot;
</I>&gt;<i> Added regex subexpression to TX.0: b54f60101b6aeddf814a8ffb11985e4bfc7b7434
</I>&gt;<i> Added regex subexpression to TX.1: b54f60101b6aeddf814a8ffb11985e4bfc7b7434
</I>&gt;<i> Operator completed in 25 usec.
</I>&gt;<i> Setting variable: session.ip=%{tx.1}
</I>&gt;<i> Resolved macro %{tx.1} to: b54f60101b6aeddf814a8ffb11985e4bfc7b7434
</I>&gt;<i> Set variable &quot;session.ip&quot; to &quot;b54f60101b6aeddf814a8ffb11985e4bfc7b7434&quot;.
</I>&gt;<i> Warning. Pattern match &quot;(.*)&quot; at TX:ip. [file
</I>&gt;<i> &quot;/xxx/modsecurity_crs_16_session_hijacking.conf&quot;] [line &quot;46&quot;] [id &quot;981063&quot;]
</I>&gt;<i> Rule returned 1.
</I>&gt;<i> Match -&gt; mode NEXT_RULE.
</I>&gt;<i>
</I>&gt;<i> The Problem is that the Target Value is already transformed with
</I>&gt;<i> &quot;t:sha1,t:hexEncode&quot;
</I>&gt;<i>
</I>&gt;<i> Michael
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> 2011/7/15 Ryan Barnett &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">RBarnett at trustwave.com</A>&gt;
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> From: Michael Haas &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">michael.haas10 at gmail.com</A>&lt;mailto:
</I>&gt;&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">michael.haas10 at gmail.com</A>&gt;&gt;
</I>&gt;&gt;<i> Date: Fri, 15 Jul 2011 08:54:49 -0500
</I>&gt;&gt;<i> To: &quot;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:
</I>&gt;&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&quot; &lt;
</I>&gt;&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:
</I>&gt;&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&gt;
</I>&gt;&gt;<i> Subject: [Owasp-modsecurity-core-rule-set] Problem with
</I>&gt;&gt;<i> modsecurity_crs_16_session_hijacking.conf
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> i'm trying to use the session hijacking protection but have some problems
</I>&gt;&gt;<i> with it.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Are you using this file?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> <A HREF="http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/optional_rules/modsecurity_crs_16_session_hijacking.conf">http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/optional_rules/modsecurity_crs_16_session_hijacking.conf</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The Rules 981057 and 981063 are never matching because they check a normal
</I>&gt;&gt;<i> IP with a encoded IP (t:sha1,t:hexEncode) so the ip is never saved in the
</I>&gt;&gt;<i> collection.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> You are misunderstanding the logic of these rules.  Let's start at the end
</I>&gt;&gt;<i> of the file.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #
</I>&gt;&gt;<i> # This rule will identify the outbound Set-Cookie SessionID data and
</I>&gt;&gt;<i> capture it in a setsid
</I>&gt;&gt;<i> #
</I>&gt;&gt;<i> SecRule RESPONSE_HEADERS:/Set-Cookie2?/
</I>&gt;&gt;<i> &quot;(?i:(j?sessionid|(php)?sessid|(asp|jserv|jw)?session[-_]?(id)?|cf(id|token)|sid)=([^\s]+)\;\s?)&quot;
</I>&gt;&gt;<i> &quot;chain,phase:3,id:'981062',t:none,pass,nolog,capture,setsid:%{TX.6},setvar:session.sessionid=%{TX.6},setvar:tx.ip=%{remote_addr},setvar:
</I>&gt;&gt;<i> tx.ua=%{request_headers.user-agent},setvar:session.valid=1&quot;
</I>&gt;&gt;<i>        SecRule SESSION:SESSIONID &quot;(.*)&quot;
</I>&gt;&gt;<i> &quot;t:none,t:sha1,t:hexEncode,capture,setvar:session.csrf_token=%{TX.1}&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> SecRule TX:IP &quot;^(\d{1,3}\.\d{1,3}\.\d{1,3}\.)&quot;
</I>&gt;&gt;<i>  &quot;phase:3,id:'981063',capture,t:none,t:sha1,t:hexEncode,nolog,pass,setvar:session.ip=%{tx.1}&quot;
</I>&gt;&gt;<i> SecRule TX:UA &quot;(.*)&quot;
</I>&gt;&gt;<i> &quot;phase:3,id:'981064',capture,t:none,t:sha1,t:hexEncode,nolog,pass,setvar:
</I>&gt;&gt;<i> session.ua=%{tx.0}&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> These rules will identify if/when common SessionIDs are being sent out by
</I>&gt;&gt;<i> the app in Set-Cookie response headers.  If these are found, then a few
</I>&gt;&gt;<i> things happen -
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  1.  Setsid is used to initialize the Session collection
</I>&gt;&gt;<i>  2.  The SessionID is marked as &quot;valid&quot; so that we can detect then bogus
</I>&gt;&gt;<i> SessionIDs are sent (perhaps by brute force tools)
</I>&gt;&gt;<i>  3.  We then capture a hash of the network block of the client IP (first 3
</I>&gt;&gt;<i> octets).  We don't use full IP address as there a too many false positives
</I>&gt;&gt;<i> where an IP will change, however the network block should not.
</I>&gt;&gt;<i>  4.  We then also capture a hash of the User-Agent string.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Now that we have saved this data when the app sent out the Set-Cookie, we
</I>&gt;&gt;<i> can now perform validation on subsequent requests.  If a client sends a
</I>&gt;&gt;<i> SessionID cookie value, we can check the data we have saved.  Now onto the
</I>&gt;&gt;<i> rules at the top of the rules file -
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #
</I>&gt;&gt;<i> # This rule set will identify subsequent SessionIDs being submitted by
</I>&gt;&gt;<i> clients in
</I>&gt;&gt;<i> # Request Headers.  First we check that the SessionID submitted is a valid
</I>&gt;&gt;<i> one
</I>&gt;&gt;<i> #
</I>&gt;&gt;<i> SecMarker BEGIN_SESSION_STARTUP
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> SecRule
</I>&gt;&gt;<i> REQUEST_COOKIES:'/(j?sessionid|(php)?sessid|(asp|jserv|jw)?session[-_]?(id)?|cf(id|token)|sid)/'
</I>&gt;&gt;<i> &quot;.*&quot; &quot;chain,phase:1,id:'981054',t:none,block,log,msg:'Invalid SessionID
</I>&gt;&gt;<i> Submitted.',setsid:%{matched_var},setvar:tx.sessionid=%{matched_var},skipAfter:END_SESSION_STARTUP&quot;
</I>&gt;&gt;<i>        SecRule SESSION:VALID &quot;!@eq 1&quot;
</I>&gt;&gt;<i> &quot;t:none,setvar:tx.anomaly_score=+%{tx.critical_anomaly_score},setvar:tx.%{
</I>&gt;&gt;<i> rule.id}-WEB_ATTACK/INVALID_SESSIONID-%{matched_var_name}=%{tx.0}&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> SecRule
</I>&gt;&gt;<i> &amp;REQUEST_COOKIES:'/(j?sessionid|(php)?sessid|(asp|jserv|jw)?session[-_]?(id)?|cf(id|token)|sid)/'
</I>&gt;&gt;<i> &quot;@eq 0&quot;
</I>&gt;&gt;<i> &quot;phase:1,id:'981055',t:none,nolog,pass,skipAfter:END_SESSION_STARTUP&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The first rule checks to see if the client is submitting a SessionID from
</I>&gt;&gt;<i> the named list.  If so, then we check the saved SessionID collection in
</I>&gt;&gt;<i> ModSecurity to see if the &quot;valid&quot; variable exists.  If not, then it means
</I>&gt;&gt;<i> that we did not see the application hand out this SessionID and thus we can
</I>&gt;&gt;<i> flag is as bogus.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The last SecRule checks to see if there are no SessionID cookies at all.
</I>&gt;&gt;<i>  If the client didn't send one, then we can skip the other checks.  Sidenote
</I>&gt;&gt;<i> &#8211; from an optimization perspective, I guess we could switch these two rules
</I>&gt;&gt;<i> around.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Then we get to the set of rules you mentioned -
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> SecAction
</I>&gt;&gt;<i> &quot;phase:1,id:'981056',t:none,nolog,pass,setuid:%{session.username},setvar:session.sessionid=%{tx.sessionid},setvar:tx.ip=%{remote_addr},setvar:
</I>&gt;&gt;<i> tx.ua=%{request_headers.user-agent}&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> SecRule TX:IP &quot;^(\d{1,3}\.\d{1,3}\.\d{1,3}\.)&quot;
</I>&gt;&gt;<i> &quot;phase:1,id:'981057',capture,t:none,t:sha1,t:hexEncode,nolog,pass,setvar:tx.ip_hash=%{tx.0}&quot;
</I>&gt;&gt;<i> SecRule TX:UA &quot;(.*)&quot;
</I>&gt;&gt;<i> &quot;phase:1,id:'981058',capture,t:none,t:sha1,t:hexEncode,nolog,pass,setvar:tx.ua_hash=%{tx.0}&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> These rules are meant to capture the hash of the same data mentioned above
</I>&gt;&gt;<i> but for the CURRENT transaction.  Once we have these hashes capture in TX
</I>&gt;&gt;<i> variables, we can then compare them to the data we originally saved in the
</I>&gt;&gt;<i> Session collection when the Set-Cookie was issued -
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> SecRule TX:IP_HASH &quot;!@streq %{SESSION.IP}&quot;
</I>&gt;&gt;<i> &quot;phase:1,id:'981059',t:none,block,setvar:tx.sticky_session_anomaly=+1,msg:'Warning
</I>&gt;&gt;<i> - Sticky SessionID Data Changed - IP Address
</I>&gt;&gt;<i> Mismatch.',setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.notice_anomaly_score},setvar:tx.%{
</I>&gt;&gt;<i> rule.id}-WEB_ATTACK/SESSION_HIJACK-%{matched_var_name}=%{tx.0}&quot;
</I>&gt;&gt;<i> SecRule TX:UA_HASH &quot;!@streq %{SESSION.UA}&quot;
</I>&gt;&gt;<i> &quot;phase:1,id:'981060',t:none,block,setvar:tx.sticky_session_anomaly=+1,msg:'Warning
</I>&gt;&gt;<i> - Sticky SessionID Data Changed - User-Agent
</I>&gt;&gt;<i> Mismatch.',setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.notice_anomaly_score},setvar:tx.%{
</I>&gt;&gt;<i> rule.id}-WEB_ATTACK/SESSION_HIJACK-%{matched_var_name}=%{tx.0}&quot;
</I>&gt;&gt;<i> SecRule TX:STICKY_SESSION_ANOMALY &quot;@eq 2&quot;
</I>&gt;&gt;<i> &quot;phase:1,id:'981061',t:none,block,msg:'Possible Session Hijacking - IP
</I>&gt;&gt;<i> Address and User-Agent
</I>&gt;&gt;<i> Mismatch.',setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.critical_anomaly_score},setvar:tx.%{
</I>&gt;&gt;<i> rule.id}-WEB_ATTACK/SESSION_HIJACK-%{matched_var_name}=%{tx.0}&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> These rules are simply check the current hashes with the saved hashes and
</I>&gt;&gt;<i> they then increase an anomaly score.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hopefully this description helps to explain the logic of the Session
</I>&gt;&gt;<i> Hijacking rules.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> -Ryan
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I changed &quot;^(\d{1,3}\.\d{1,3}\.\d{1,3}\.)&quot; to &quot;(.*)&quot; after that the Rules
</I>&gt;&gt;<i> are working.
</I>&gt;&gt;<i> Is this the right approach to fix this or should this be fixed in another
</I>&gt;&gt;<i> way?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks in Advance
</I>&gt;&gt;<i> Michael
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ________________________________
</I>&gt;&gt;<i> This transmission may contain information that is privileged,
</I>&gt;&gt;<i> confidential, and/or exempt from disclosure under applicable law. If you are
</I>&gt;&gt;<i> not the intended recipient, you are hereby notified that any disclosure,
</I>&gt;&gt;<i> copying, distribution, or use of the information contained herein (including
</I>&gt;&gt;<i> any reliance thereon) is STRICTLY PROHIBITED. If you received this
</I>&gt;&gt;<i> transmission in error, please immediately contact the sender and destroy the
</I>&gt;&gt;<i> material in its entirety, whether in electronic or hard copy format.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20110716/255bfe69/attachment.html">https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20110716/255bfe69/attachment.html</A> 
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000794.html">[Owasp-modsecurity-core-rule-set] Problem with	modsecurity_crs_16_session_hijacking.conf
</A></li>
	<LI>Next message: <A HREF="000796.html">[Owasp-modsecurity-core-rule-set] Problem	with	modsecurity_crs_16_session_hijacking.conf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#795">[ date ]</a>
              <a href="thread.html#795">[ thread ]</a>
              <a href="subject.html#795">[ subject ]</a>
              <a href="author.html#795">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
