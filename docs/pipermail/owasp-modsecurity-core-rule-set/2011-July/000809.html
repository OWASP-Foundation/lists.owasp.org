<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Problem with modsecurity_crs_16_session_hijacking.conf
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20Problem%20with%0A%20modsecurity_crs_16_session_hijacking.conf&In-Reply-To=CAFW5hxB0dpgxQaiK%3DvufyP9NmHZS0vwN%2BtRYx1zbmrs9aqNP0A%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000808.html">
   <LINK REL="Next"  HREF="000798.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Problem with modsecurity_crs_16_session_hijacking.conf</H1>
    <B>Ryan Barnett</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20Problem%20with%0A%20modsecurity_crs_16_session_hijacking.conf&In-Reply-To=CAFW5hxB0dpgxQaiK%3DvufyP9NmHZS0vwN%2BtRYx1zbmrs9aqNP0A%40mail.gmail.com"
       TITLE="[Owasp-modsecurity-core-rule-set] Problem with modsecurity_crs_16_session_hijacking.conf">RBarnett at trustwave.com
       </A><BR>
    <I>Thu Jul 21 08:01:56 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="000808.html">[Owasp-modsecurity-core-rule-set] Problem with	modsecurity_crs_16_session_hijacking.conf
</A></li>
        <LI>Next message: <A HREF="000798.html">[Owasp-modsecurity-core-rule-set] redirect with Apache
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#809">[ date ]</a>
              <a href="thread.html#809">[ thread ]</a>
              <a href="subject.html#809">[ subject ]</a>
              <a href="author.html#809">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Good catch Michael.

I updated the Session Hijacking rules in SVN trunk -
<A HREF="http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/optional_rules/modsecurity_crs_16_session_hijacking.conf?revision=1820">http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/optional_rules/modsecurity_crs_16_session_hijacking.conf?revision=1820</A>

-Ryan

From: Michael Haas &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">michael.haas10 at gmail.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">michael.haas10 at gmail.com</A>&gt;&gt;
Date: Thu, 21 Jul 2011 03:18:42 -0500
To: &quot;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&gt;
Subject: Re: [Owasp-modsecurity-core-rule-set] Problem with modsecurity_crs_16_session_hijacking.conf

Hello,

in crs 2.2.1 there is a oversight in Rule 981063. It should save session.ip but it saves tx.ip_hash.
And if the hash value should be saved then the &quot;capture&quot; is missing in the chained rule. Now only the 3 octets are saved so the naming of the variables is a little bit misunderstanding (tx.ip_hash).

So the Rules should look like this.

SecRule TX:IP &quot;^(\d{1,3}\.\d{1,3}\.\d{1,3}\.)&quot; &quot;chain,phase:1,id:'981057',capture,t:none,nolog,pass&quot;
        SecRule TX:1 &quot;.*&quot; &quot;capture,t:sha1,t:hexEncode,setvar:tx.ip_hash=%{tx.0}&quot;

SecRule TX:IP &quot;^(\d{1,3}\.\d{1,3}\.\d{1,3}\.)&quot; &quot;chain,phase:3,id:'981063',capture,t:none,nolog,pass&quot;
        SecRule TX:1 &quot;.*&quot; &quot;capture,t:sha1,t:hexEncode,setvar:session.ip=%{tx.0}&quot;

Michael


2011/7/17 Michael Haas &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">michael.haas10 at gmail.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">michael.haas10 at gmail.com</A>&gt;&gt;
Hi,
i have another problem with the rules in this file.
The Rules are working as expected if i change the IP or the UA but if i change the sessionid to another value it's not working as expected.
I Think the following Rule is not working if the session id is changed to an unknown value, because the ! operator does not work with non existent variables(don't know if its a bug or not).
SecRule REQUEST_COOKIES:'/(j?sessionid|(php)?sessid|(asp|jserv|jw)?session[-_]?(id)?|cf(id|token)|sid)/' &quot;.*&quot; &quot;chain,phase:1,id:'981054',t:none,block,log,msg:'Invalid SessionID Submitted.',setsid:%{matched_var},setvar:tx.sessionid=%{matched_var},skipAfter:END_SESSION_STARTUP&quot;
        SecRule SESSION:VALID &quot;!@eq 1&quot; &quot;t:none,setvar:tx.anomaly_score=+%{tx.critical_anomaly_score},setvar:tx.%{rule.id&lt;<A HREF="http://rule.id">http://rule.id</A>&gt;}-WEB_ATTACK/INVALID_SESSIONID-%{matched_var_name}=%{tx.0}&quot;
SESSION:VALID does not match if the SESSION.VALID Variable doesn't exist.

I have verfied this with the following test.

 SecAction &quot;phase:1,id:'2000',t:none,nolog,pass,setvar:tx.test=1&quot;
SecRule TX:TEST &quot;@eq 1&quot; &quot;phase:1,t:none,id:'2001'&quot;
SecRule TX:TEST &quot;!@eq 0&quot; &quot;phase:1,t:none,id:'2002'&quot;
SecRule TX:TEST &quot;!@eq 1&quot; &quot;phase:1,t:none,id:'2003'&quot;
TEST1 doesn't exist.
SecRule TX:TEST1 &quot;@eq 1&quot; &quot;phase:1,t:none,id:'2004'&quot;
SecRule TX:TEST1 &quot;!@eq 1&quot; &quot;phase:1,t:none,id:'2005'&quot;     Thats the Problem, it should match because TEST1 is not equal to 1 but it does not match.

Debug Log for the test.

Rule 801648: SecAction &quot;phase:1,auditlog,id:2000,t:none,nolog,pass,setvar:tx.test=1&quot;
 Setting variable: tx.test=1
 Set variable &quot;tx.test&quot; to &quot;1&quot;.
 Rule returned 1.
 Match -&gt; mode NEXT_RULE.
 Rule 809ed0: SecRule &quot;TX:TEST&quot; &quot;@eq 1&quot; &quot;phase:1,pass,nolog,auditlog,t:none,id:2001&quot;
 Executing operator &quot;eq&quot; with param &quot;1&quot; against TX:test.
 Target value: &quot;1&quot;
 Rule returned 1.
 Rule 80a588: SecRule &quot;TX:TEST&quot; &quot;!@eq 0&quot; &quot;phase:1,pass,nolog,auditlog,t:none,id:2002&quot;
 Executing operator &quot;!eq&quot; with param &quot;0&quot; against TX:test.
 Target value: &quot;1&quot;
 Rule returned 1.
 Rule 80ac50: SecRule &quot;TX:TEST&quot; &quot;!@eq 1&quot; &quot;phase:1,pass,nolog,auditlog,t:none,id:2003&quot;
 Executing operator &quot;!eq&quot; with param &quot;1&quot; against TX:test.
 Target value: &quot;1&quot;
 Rule returned 0.
 Rule 80b318: SecRule &quot;TX:TEST1&quot; &quot;@eq 1&quot; &quot;phase:1,pass,nolog,auditlog,t:none,id:2004&quot;
 Rule returned 0.
 Rule 80dbd0: SecRule &quot;TX:TEST1&quot; &quot;!@eq 1&quot; &quot;phase:1,pass,nolog,auditlog,t:none,id:2005&quot;
 Rule returned 0.

If i change the Rule to only check if the Variable exists &amp;SESSION:VALID &quot;!@eq 1&quot;  it's working.

Michael

2011/7/16 Ryan Barnett &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">RBarnett at trustwave.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">RBarnett at trustwave.com</A>&gt;&gt;
Agreed - these need to be fixed. We can simplify the IP capturing ones by not using the hashed. We were using hashs initially for the User-Agent field as their length could get pretty long.  We would not need that for IP addresses.

I will fix these and push to the CRS SVN repo on Monday.

Thanks.
Ryan

On Jul 16, 2011, at 2:24 PM, &quot;Michael Haas&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">michael.haas10 at gmail.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">michael.haas10 at gmail.com</A>&gt;&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">michael.haas10 at gmail.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">michael.haas10 at gmail.com</A>&gt;&gt;&gt; wrote:

Hi,

i think the Rule should be changed to something like that

SecRule TX:IP &quot;^(\d{1,3}\.\d{1,3}\.\d{1,3}\.)&quot;  &quot;chain,phase:3,id:'981063',t:none,nolog,pass&quot;
       SecRule MATCHED_VARS &quot;(.*)&quot; &quot;capture,t:none,t:sha1,t:hexEncode,nolog,setvar:session.ip=%{tx.1}&quot;

then it works too.

Michael

2011/7/15 Michael Haas &lt;&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">michael.haas10 at gmail.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">michael.haas10 at gmail.com</A>&gt;&gt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">michael.haas10 at gmail.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">michael.haas10 at gmail.com</A>&gt;&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">michael.haas10 at gmail.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">michael.haas10 at gmail.com</A>&gt;&gt;&gt;
Hi,

Yes i'm using &lt;<A HREF="http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/optional_rules/modsecurity_crs_16_session_hijacking.conf">http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/optional_rules/modsecurity_crs_16_session_hijacking.conf</A>&gt; <A HREF="http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/optional_rules/modsecurity_crs_16_session_hijacking.conf.">http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/optional_rules/modsecurity_crs_16_session_hijacking.conf.</A>
if i look at a debug log i see that the session.ip is not saved, i think it doesn't capture because it doesn't match.

Rule 822ce0: SecRule &quot;TX:IP&quot; &quot;@rx ^(\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.)&quot; &quot;phase:3,auditlog,id:981063,capture,t:none,t:sha1,t:hexEncode,nolog,pass,setvar:session.ip=%{tx.1}&quot;
T (0) sha1: &quot;\xb5O`\x10\x1bj\xed\xdf\x81J\x8f\xfb\x11\x98^K\xfc{t4&quot;
T (0) hexEncode: &quot;b54f60101b6aeddf814a8ffb11985e4bfc7b7434&quot;
Transformation completed in 24 usec.
Executing operator &quot;rx&quot; with param &quot;^(\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.)&quot; against TX:ip.
Target value: &quot;b54f60101b6aeddf814a8ffb11985e4bfc7b7434&quot;
Operator completed in 2 usec.
Rule returned 0.
No match, not chained -&gt; mode NEXT_RULE.

If i use this Rule it captures because it matches.

Rule 822cc8: SecRule &quot;TX:IP&quot; &quot;@rx (.*)&quot; &quot;phase:3,auditlog,id:981063,capture,t:none,t:sha1,t:hexEncode,nolog,pass,setvar:session.ip=%{tx.1}&quot;
T (0) sha1: &quot;\xb5O`\x10\x1bj\xed\xdf\x81J\x8f\xfb\x11\x98^K\xfc{t4&quot;
T (0) hexEncode: &quot;b54f60101b6aeddf814a8ffb11985e4bfc7b7434&quot;
Transformation completed in 24 usec.
Executing operator &quot;rx&quot; with param &quot;(.*)&quot; against TX:ip.
Target value: &quot;b54f60101b6aeddf814a8ffb11985e4bfc7b7434&quot;
Added regex subexpression to TX.0: b54f60101b6aeddf814a8ffb11985e4bfc7b7434
Added regex subexpression to TX.1: b54f60101b6aeddf814a8ffb11985e4bfc7b7434
Operator completed in 25 usec.
Setting variable: session.ip=%{tx.1}
Resolved macro %{tx.1} to: b54f60101b6aeddf814a8ffb11985e4bfc7b7434
Set variable &quot;session.ip&quot; to &quot;b54f60101b6aeddf814a8ffb11985e4bfc7b7434&quot;.
Warning. Pattern match &quot;(.*)&quot; at TX:ip. [file &quot;/xxx/modsecurity_crs_16_session_hijacking.conf&quot;] [line &quot;46&quot;] [id &quot;981063&quot;]
Rule returned 1.
Match -&gt; mode NEXT_RULE.

The Problem is that the Target Value is already transformed with &quot;t:sha1,t:hexEncode&quot;

Michael


2011/7/15 Ryan Barnett &lt;&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">RBarnett at trustwave.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">RBarnett at trustwave.com</A>&gt;&gt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">RBarnett at trustwave.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">RBarnett at trustwave.com</A>&gt;&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">RBarnett at trustwave.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">RBarnett at trustwave.com</A>&gt;&gt;&gt;

From: Michael Haas &lt;&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">michael.haas10 at gmail.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">michael.haas10 at gmail.com</A>&gt;&gt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">michael.haas10 at gmail.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">michael.haas10 at gmail.com</A>&gt;&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">michael.haas10 at gmail.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">michael.haas10 at gmail.com</A>&gt;&gt;&lt;mailto:&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">michael.haas10 at gmail.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">michael.haas10 at gmail.com</A>&gt;&gt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">michael.haas10 at gmail.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">michael.haas10 at gmail.com</A>&gt;&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">michael.haas10 at gmail.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">michael.haas10 at gmail.com</A>&gt;&gt;&gt;&gt;
Date: Fri, 15 Jul 2011 08:54:49 -0500
To: &quot;&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&gt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&gt;&lt;mailto:&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&gt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&gt;&gt;&quot; &lt;&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&gt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&gt;&lt;mailto:&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&gt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&gt;&gt;&gt;
Subject: [Owasp-modsecurity-core-rule-set] Problem with modsecurity_crs_16_session_hijacking.conf

Hi,

i'm trying to use the session hijacking protection but have some problems with it.

Are you using this file?
&lt;<A HREF="http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/optional_rules/modsecurity_crs_16_session_hijacking.conf">http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/optional_rules/modsecurity_crs_16_session_hijacking.conf</A>&gt;<A HREF="http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/optional_rules/modsecurity_crs_16_session_hijacking.conf">http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/optional_rules/modsecurity_crs_16_session_hijacking.conf</A>



The Rules 981057 and 981063 are never matching because they check a normal IP with a encoded IP (t:sha1,t:hexEncode) so the ip is never saved in the collection.

You are misunderstanding the logic of these rules.  Let's start at the end of the file.


#
# This rule will identify the outbound Set-Cookie SessionID data and capture it in a setsid
#
SecRule RESPONSE_HEADERS:/Set-Cookie2?/ &quot;(?i:(j?sessionid|(php)?sessid|(asp|jserv|jw)?session[-_]?(id)?|cf(id|token)|sid)=([^\s]+)\;\s?)&quot; &quot;chain,phase:3,id:'981062',t:none,pass,nolog,capture,setsid:%{TX.6},setvar:session.sessionid=%{TX.6},setvar:tx.ip=%{remote_addr},setvar:&lt;<A HREF="http://tx.ua">http://tx.ua</A>&gt;tx.ua&lt;<A HREF="http://tx.ua">http://tx.ua</A>&gt;&lt;<A HREF="http://tx.ua">http://tx.ua</A>&gt;=%{request_headers.user-agent},setvar:session.valid=1&quot;
      SecRule SESSION:SESSIONID &quot;(.*)&quot; &quot;t:none,t:sha1,t:hexEncode,capture,setvar:session.csrf_token=%{TX.1}&quot;

SecRule TX:IP &quot;^(\d{1,3}\.\d{1,3}\.\d{1,3}\.)&quot;  &quot;phase:3,id:'981063',capture,t:none,t:sha1,t:hexEncode,nolog,pass,setvar:session.ip=%{tx.1}&quot;
SecRule TX:UA &quot;(.*)&quot; &quot;phase:3,id:'981064',capture,t:none,t:sha1,t:hexEncode,nolog,pass,setvar:&lt;<A HREF="http://session.ua">http://session.ua</A>&gt;session.ua&lt;<A HREF="http://session.ua">http://session.ua</A>&gt;&lt;<A HREF="http://session.ua">http://session.ua</A>&gt;=%{tx.0}&quot;

These rules will identify if/when common SessionIDs are being sent out by the app in Set-Cookie response headers.  If these are found, then a few things happen -

 1.  Setsid is used to initialize the Session collection
 2.  The SessionID is marked as &quot;valid&quot; so that we can detect then bogus SessionIDs are sent (perhaps by brute force tools)
 3.  We then capture a hash of the network block of the client IP (first 3 octets).  We don't use full IP address as there a too many false positives where an IP will change, however the network block should not.
 4.  We then also capture a hash of the User-Agent string.

Now that we have saved this data when the app sent out the Set-Cookie, we can now perform validation on subsequent requests.  If a client sends a SessionID cookie value, we can check the data we have saved.  Now onto the rules at the top of the rules file -


#
# This rule set will identify subsequent SessionIDs being submitted by clients in
# Request Headers.  First we check that the SessionID submitted is a valid one
#
SecMarker BEGIN_SESSION_STARTUP

SecRule REQUEST_COOKIES:'/(j?sessionid|(php)?sessid|(asp|jserv|jw)?session[-_]?(id)?|cf(id|token)|sid)/' &quot;.*&quot; &quot;chain,phase:1,id:'981054',t:none,block,log,msg:'Invalid SessionID Submitted.',setsid:%{matched_var},setvar:tx.sessionid=%{matched_var},skipAfter:END_SESSION_STARTUP&quot;
      SecRule SESSION:VALID &quot;!@eq 1&quot; &quot;t:none,setvar:tx.anomaly_score=+%{tx.critical_anomaly_score},setvar:tx.%{rule.id&lt;<A HREF="http://rule.id">http://rule.id</A>&gt;&lt;<A HREF="http://rule.id">http://rule.id</A>&gt;}-WEB_ATTACK/INVALID_SESSIONID-%{matched_var_name}=%{tx.0}&quot;

SecRule &amp;REQUEST_COOKIES:'/(j?sessionid|(php)?sessid|(asp|jserv|jw)?session[-_]?(id)?|cf(id|token)|sid)/' &quot;@eq 0&quot; &quot;phase:1,id:'981055',t:none,nolog,pass,skipAfter:END_SESSION_STARTUP&quot;

The first rule checks to see if the client is submitting a SessionID from the named list.  If so, then we check the saved SessionID collection in ModSecurity to see if the &quot;valid&quot; variable exists.  If not, then it means that we did not see the application hand out this SessionID and thus we can flag is as bogus.

The last SecRule checks to see if there are no SessionID cookies at all.  If the client didn't send one, then we can skip the other checks.  Sidenote &#8211; from an optimization perspective, I guess we could switch these two rules around.

Then we get to the set of rules you mentioned -

SecAction &quot;phase:1,id:'981056',t:none,nolog,pass,setuid:%{session.username},setvar:session.sessionid=%{tx.sessionid},setvar:tx.ip=%{remote_addr},setvar:&lt;<A HREF="http://tx.ua">http://tx.ua</A>&gt;tx.ua&lt;<A HREF="http://tx.ua">http://tx.ua</A>&gt;&lt;<A HREF="http://tx.ua">http://tx.ua</A>&gt;=%{request_headers.user-agent}&quot;

SecRule TX:IP &quot;^(\d{1,3}\.\d{1,3}\.\d{1,3}\.)&quot; &quot;phase:1,id:'981057',capture,t:none,t:sha1,t:hexEncode,nolog,pass,setvar:tx.ip_hash=%{tx.0}&quot;
SecRule TX:UA &quot;(.*)&quot; &quot;phase:1,id:'981058',capture,t:none,t:sha1,t:hexEncode,nolog,pass,setvar:tx.ua_hash=%{tx.0}&quot;

These rules are meant to capture the hash of the same data mentioned above but for the CURRENT transaction.  Once we have these hashes capture in TX variables, we can then compare them to the data we originally saved in the Session collection when the Set-Cookie was issued -


SecRule TX:IP_HASH &quot;!@streq %{SESSION.IP}&quot; &quot;phase:1,id:'981059',t:none,block,setvar:tx.sticky_session_anomaly=+1,msg:'Warning - Sticky SessionID Data Changed - IP Address Mismatch.',setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.notice_anomaly_score},setvar:tx.%{rule.id&lt;<A HREF="http://rule.id">http://rule.id</A>&gt;&lt;<A HREF="http://rule.id">http://rule.id</A>&gt;}-WEB_ATTACK/SESSION_HIJACK-%{matched_var_name}=%{tx.0}&quot;
SecRule TX:UA_HASH &quot;!@streq %{SESSION.UA&lt;<A HREF="http://SESSION.UA">http://SESSION.UA</A>&gt;&lt;<A HREF="http://SESSION.UA">http://SESSION.UA</A>&gt;}&quot; &quot;phase:1,id:'981060',t:none,block,setvar:tx.sticky_session_anomaly=+1,msg:'Warning - Sticky SessionID Data Changed - User-Agent Mismatch.',setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.notice_anomaly_score},setvar:tx.%{rule.id&lt;<A HREF="http://rule.id">http://rule.id</A>&gt;&lt;<A HREF="http://rule.id">http://rule.id</A>&gt;}-WEB_ATTACK/SESSION_HIJACK-%{matched_var_name}=%{tx.0}&quot;
SecRule TX:STICKY_SESSION_ANOMALY &quot;@eq 2&quot; &quot;phase:1,id:'981061',t:none,block,msg:'Possible Session Hijacking - IP Address and User-Agent Mismatch.',setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.critical_anomaly_score},setvar:tx.%{rule.id&lt;<A HREF="http://rule.id">http://rule.id</A>&gt;&lt;<A HREF="http://rule.id">http://rule.id</A>&gt;}-WEB_ATTACK/SESSION_HIJACK-%{matched_var_name}=%{tx.0}&quot;

These rules are simply check the current hashes with the saved hashes and they then increase an anomaly score.

Hopefully this description helps to explain the logic of the Session Hijacking rules.

-Ryan


I changed &quot;^(\d{1,3}\.\d{1,3}\.\d{1,3}\.)&quot; to &quot;(.*)&quot; after that the Rules are working.
Is this the right approach to fix this or should this be fixed in another way?

Thanks in Advance
Michael


________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.



_______________________________________________
Owasp-modsecurity-core-rule-set mailing list
<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&gt;
<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set</A>

________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.



________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000808.html">[Owasp-modsecurity-core-rule-set] Problem with	modsecurity_crs_16_session_hijacking.conf
</A></li>
	<LI>Next message: <A HREF="000798.html">[Owasp-modsecurity-core-rule-set] redirect with Apache
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#809">[ date ]</a>
              <a href="thread.html#809">[ thread ]</a>
              <a href="subject.html#809">[ subject ]</a>
              <a href="author.html#809">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
