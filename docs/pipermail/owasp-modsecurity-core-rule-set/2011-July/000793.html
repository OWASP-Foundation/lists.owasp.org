<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Problem with modsecurity_crs_16_session_hijacking.conf
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20Problem%20with%0A%20modsecurity_crs_16_session_hijacking.conf&In-Reply-To=CAFW5hxApMyteo22KSNMcLBf%2BBAd_%3Dr5f0gOLHZCPTDWEciXw-w%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000792.html">
   <LINK REL="Next"  HREF="000794.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Problem with modsecurity_crs_16_session_hijacking.conf</H1>
    <B>Ryan Barnett</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20Problem%20with%0A%20modsecurity_crs_16_session_hijacking.conf&In-Reply-To=CAFW5hxApMyteo22KSNMcLBf%2BBAd_%3Dr5f0gOLHZCPTDWEciXw-w%40mail.gmail.com"
       TITLE="[Owasp-modsecurity-core-rule-set] Problem with modsecurity_crs_16_session_hijacking.conf">RBarnett at trustwave.com
       </A><BR>
    <I>Fri Jul 15 10:40:29 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="000792.html">[Owasp-modsecurity-core-rule-set] Problem with	modsecurity_crs_16_session_hijacking.conf
</A></li>
        <LI>Next message: <A HREF="000794.html">[Owasp-modsecurity-core-rule-set] Problem with	modsecurity_crs_16_session_hijacking.conf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#793">[ date ]</a>
              <a href="thread.html#793">[ thread ]</a>
              <a href="subject.html#793">[ subject ]</a>
              <a href="author.html#793">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
From: Michael Haas &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">michael.haas10 at gmail.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">michael.haas10 at gmail.com</A>&gt;&gt;
Date: Fri, 15 Jul 2011 08:54:49 -0500
To: &quot;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&gt;
Subject: [Owasp-modsecurity-core-rule-set] Problem with modsecurity_crs_16_session_hijacking.conf

Hi,

i'm trying to use the session hijacking protection but have some problems with it.

Are you using this file?
<A HREF="http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/optional_rules/modsecurity_crs_16_session_hijacking.conf">http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/optional_rules/modsecurity_crs_16_session_hijacking.conf</A>



The Rules 981057 and 981063 are never matching because they check a normal IP with a encoded IP (t:sha1,t:hexEncode) so the ip is never saved in the collection.

You are misunderstanding the logic of these rules.  Let's start at the end of the file.


#
# This rule will identify the outbound Set-Cookie SessionID data and capture it in a setsid
#
SecRule RESPONSE_HEADERS:/Set-Cookie2?/ &quot;(?i:(j?sessionid|(php)?sessid|(asp|jserv|jw)?session[-_]?(id)?|cf(id|token)|sid)=([^\s]+)\;\s?)&quot; &quot;chain,phase:3,id:'981062',t:none,pass,nolog,capture,setsid:%{TX.6},setvar:session.sessionid=%{TX.6},setvar:tx.ip=%{remote_addr},setvar:tx.ua=%{request_headers.user-agent},setvar:session.valid=1&quot;
        SecRule SESSION:SESSIONID &quot;(.*)&quot; &quot;t:none,t:sha1,t:hexEncode,capture,setvar:session.csrf_token=%{TX.1}&quot;

SecRule TX:IP &quot;^(\d{1,3}\.\d{1,3}\.\d{1,3}\.)&quot;  &quot;phase:3,id:'981063',capture,t:none,t:sha1,t:hexEncode,nolog,pass,setvar:session.ip=%{tx.1}&quot;
SecRule TX:UA &quot;(.*)&quot; &quot;phase:3,id:'981064',capture,t:none,t:sha1,t:hexEncode,nolog,pass,setvar:session.ua=%{tx.0}&quot;

These rules will identify if/when common SessionIDs are being sent out by the app in Set-Cookie response headers.  If these are found, then a few things happen -

 1.  Setsid is used to initialize the Session collection
 2.  The SessionID is marked as &quot;valid&quot; so that we can detect then bogus SessionIDs are sent (perhaps by brute force tools)
 3.  We then capture a hash of the network block of the client IP (first 3 octets).  We don't use full IP address as there a too many false positives where an IP will change, however the network block should not.
 4.  We then also capture a hash of the User-Agent string.

Now that we have saved this data when the app sent out the Set-Cookie, we can now perform validation on subsequent requests.  If a client sends a SessionID cookie value, we can check the data we have saved.  Now onto the rules at the top of the rules file -


#
# This rule set will identify subsequent SessionIDs being submitted by clients in
# Request Headers.  First we check that the SessionID submitted is a valid one
#
SecMarker BEGIN_SESSION_STARTUP

SecRule REQUEST_COOKIES:'/(j?sessionid|(php)?sessid|(asp|jserv|jw)?session[-_]?(id)?|cf(id|token)|sid)/' &quot;.*&quot; &quot;chain,phase:1,id:'981054',t:none,block,log,msg:'Invalid SessionID Submitted.',setsid:%{matched_var},setvar:tx.sessionid=%{matched_var},skipAfter:END_SESSION_STARTUP&quot;
        SecRule SESSION:VALID &quot;!@eq 1&quot; &quot;t:none,setvar:tx.anomaly_score=+%{tx.critical_anomaly_score},setvar:tx.%{rule.id}-WEB_ATTACK/INVALID_SESSIONID-%{matched_var_name}=%{tx.0}&quot;

SecRule &amp;REQUEST_COOKIES:'/(j?sessionid|(php)?sessid|(asp|jserv|jw)?session[-_]?(id)?|cf(id|token)|sid)/' &quot;@eq 0&quot; &quot;phase:1,id:'981055',t:none,nolog,pass,skipAfter:END_SESSION_STARTUP&quot;

The first rule checks to see if the client is submitting a SessionID from the named list.  If so, then we check the saved SessionID collection in ModSecurity to see if the &quot;valid&quot; variable exists.  If not, then it means that we did not see the application hand out this SessionID and thus we can flag is as bogus.

The last SecRule checks to see if there are no SessionID cookies at all.  If the client didn't send one, then we can skip the other checks.  Sidenote &#8211; from an optimization perspective, I guess we could switch these two rules around.

Then we get to the set of rules you mentioned -

SecAction &quot;phase:1,id:'981056',t:none,nolog,pass,setuid:%{session.username},setvar:session.sessionid=%{tx.sessionid},setvar:tx.ip=%{remote_addr},setvar:tx.ua=%{request_headers.user-agent}&quot;

SecRule TX:IP &quot;^(\d{1,3}\.\d{1,3}\.\d{1,3}\.)&quot; &quot;phase:1,id:'981057',capture,t:none,t:sha1,t:hexEncode,nolog,pass,setvar:tx.ip_hash=%{tx.0}&quot;
SecRule TX:UA &quot;(.*)&quot; &quot;phase:1,id:'981058',capture,t:none,t:sha1,t:hexEncode,nolog,pass,setvar:tx.ua_hash=%{tx.0}&quot;

These rules are meant to capture the hash of the same data mentioned above but for the CURRENT transaction.  Once we have these hashes capture in TX variables, we can then compare them to the data we originally saved in the Session collection when the Set-Cookie was issued -


SecRule TX:IP_HASH &quot;!@streq %{SESSION.IP}&quot; &quot;phase:1,id:'981059',t:none,block,setvar:tx.sticky_session_anomaly=+1,msg:'Warning - Sticky SessionID Data Changed - IP Address Mismatch.',setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.notice_anomaly_score},setvar:tx.%{rule.id}-WEB_ATTACK/SESSION_HIJACK-%{matched_var_name}=%{tx.0}&quot;
SecRule TX:UA_HASH &quot;!@streq %{SESSION.UA}&quot; &quot;phase:1,id:'981060',t:none,block,setvar:tx.sticky_session_anomaly=+1,msg:'Warning - Sticky SessionID Data Changed - User-Agent Mismatch.',setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.notice_anomaly_score},setvar:tx.%{rule.id}-WEB_ATTACK/SESSION_HIJACK-%{matched_var_name}=%{tx.0}&quot;
SecRule TX:STICKY_SESSION_ANOMALY &quot;@eq 2&quot; &quot;phase:1,id:'981061',t:none,block,msg:'Possible Session Hijacking - IP Address and User-Agent Mismatch.',setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.critical_anomaly_score},setvar:tx.%{rule.id}-WEB_ATTACK/SESSION_HIJACK-%{matched_var_name}=%{tx.0}&quot;

These rules are simply check the current hashes with the saved hashes and they then increase an anomaly score.

Hopefully this description helps to explain the logic of the Session Hijacking rules.

-Ryan


I changed &quot;^(\d{1,3}\.\d{1,3}\.\d{1,3}\.)&quot; to &quot;(.*)&quot; after that the Rules are working.
Is this the right approach to fix this or should this be fixed in another way?

Thanks in Advance
Michael


________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000792.html">[Owasp-modsecurity-core-rule-set] Problem with	modsecurity_crs_16_session_hijacking.conf
</A></li>
	<LI>Next message: <A HREF="000794.html">[Owasp-modsecurity-core-rule-set] Problem with	modsecurity_crs_16_session_hijacking.conf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#793">[ date ]</a>
              <a href="thread.html#793">[ thread ]</a>
              <a href="subject.html#793">[ subject ]</a>
              <a href="author.html#793">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
