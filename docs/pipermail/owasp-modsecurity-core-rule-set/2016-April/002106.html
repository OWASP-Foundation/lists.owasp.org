<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Is it possible to use modsecurity rules to prevent logins by specific user accounts?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Is%20it%20possible%20to%20use%0A%20modsecurity%20rules%20to%20prevent%20logins%20by%20specific%20user%20accounts%3F&In-Reply-To=%3CDB5PR07MB1480C0F0B543EDF554754AB582680%40DB5PR07MB1480.eurprd07.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002105.html">
   <LINK REL="Next"  HREF="002108.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Is it possible to use modsecurity rules to prevent logins by specific user accounts?</H1>
    <B>Mansell, Gary</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Is%20it%20possible%20to%20use%0A%20modsecurity%20rules%20to%20prevent%20logins%20by%20specific%20user%20accounts%3F&In-Reply-To=%3CDB5PR07MB1480C0F0B543EDF554754AB582680%40DB5PR07MB1480.eurprd07.prod.outlook.com%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] Is it possible to use modsecurity rules to prevent logins by specific user accounts?">Gary.Mansell at ricardo.com
       </A><BR>
    <I>Fri Apr 15 12:42:34 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="002105.html">[Owasp-modsecurity-core-rule-set] Is it possible to use modsecurity rules to prevent logins by specific user accounts?
</A></li>
        <LI>Next message: <A HREF="002108.html">[Owasp-modsecurity-core-rule-set] Enabling the core rules for only	a certain pecentarge of requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2106">[ date ]</a>
              <a href="thread.html#2106">[ thread ]</a>
              <a href="subject.html#2106">[ subject ]</a>
              <a href="author.html#2106">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Absolutely spot on thank you so much for the solution, it works exactly as I originally hoped it would. Normal users can login fine via the external reverse proxy server, but admin users get denied access by the modsecurity rule.

Barry and Chaim - I really appreciate you both taking the time to help me with this because I was completely stumped and yet felt it should be something well within the capabilities of modsecurity.

I only hope that this information in the mailing list is of help to others that may want to do a similar thing.

Great Stuff !!

From: Barry Pollard [mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">barry_pollard at hotmail.com</A>]
Sent: 15 April 2016 13:29
To: Mansell, Gary &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Gary.Mansell at ricardo.com</A>&gt;; Chaim Sanders &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">csanders at trustwave.com</A>&gt;; <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>
Subject: RE: [Owasp-modsecurity-core-rule-set] Is it possible to use modsecurity rules to prevent logins by specific user accounts?

OK so the audit log shows shows this in your header:

   Authorization: Basic Z3JtYXdjYWRtaW46dGVzdA==

The value of the Authorization header is therefore &quot;Basic Z3JtYXdjYWRtaW46dGVzdA==&quot; which cannot be base64 decoded due to that initial &quot;Basic &quot; part which is not Base 64 encoded. This is what you are supposed to send so nothing wrong with your header, but it explains why your rule is not working as ModSecurity does not know you only want to base64 decode part of the header.

So you need to write a chained rule to capture the actual base64 encoded part using backets and &quot;capture&quot; and then base 64 decode the TX:1 variable which is captured:

SecRule &quot;REQUEST_HEADERS:Authorization&quot; &quot;^Basic (.*)$&quot; &quot;phase:1,id:1003,log,capture,chain,deny,status:403&quot;
        SecRule TX:1 &quot;@contains admin&quot; &quot;t:base64Decode&quot;

I've tested this and it seems to work.

Thanks,
Barry

&gt;<i> From: <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Gary.Mansell at ricardo.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Gary.Mansell at ricardo.com</A>&gt;
</I>&gt;<i> To: <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">barry_pollard at hotmail.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">barry_pollard at hotmail.com</A>&gt;; <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">csanders at trustwave.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">csanders at trustwave.com</A>&gt;; <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;
</I>&gt;<i> Subject: RE: [Owasp-modsecurity-core-rule-set] Is it possible to use modsecurity rules to prevent logins by specific user accounts?
</I>&gt;<i> Date: Fri, 15 Apr 2016 10:37:16 +0000
</I>&gt;<i>
</I>&gt;<i> I added the rule, cleared the logs and logged in again with the grmawcadmin user
</I>&gt;<i>
</I>&gt;<i> Here are the updated logs as requested.
</I>&gt;<i>
</I>
--------------------------------------------------------------------------------------------------------------------------------------------------------------
This e-mail and any files transmitted with it are confidential and intended solely for the use of the individual or entity to whom they are
addressed. If you have received this e-mail in error please notify the sender immediately and delete this e-mail from your system.
Please note that any views or opinions presented in this e-mail are solely those of the author and do not necessarily represent those
of Ricardo (save for reports and other documentation formally approved and signed for release to the intended recipient). Only Directors
are authorised to enter into legally binding obligations on behalf of Ricardo. Ricardo may monitor outgoing and incoming e-mails and
other telecommunications systems. By replying to this e-mail you give consent to such monitoring. The recipient should check e-mail and
any attachments for the presence of viruses. Ricardo accepts no liability for any damage caused by any virus transmitted by this e-mail.
&quot;Ricardo&quot; means Ricardo plc and its subsidiary companies.
Ricardo plc is a public limited company registered in England with registered number 00222915.
The registered office of Ricardo plc is Shoreham Technical Centre, Shoreham-by Sea, West Sussex, BN43 5FG.
--------------------------------------------------------------------------------------------------------------------------------------------------------------
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20160415/2c2e7a8a/attachment-0001.html">http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20160415/2c2e7a8a/attachment-0001.html</A>&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002105.html">[Owasp-modsecurity-core-rule-set] Is it possible to use modsecurity rules to prevent logins by specific user accounts?
</A></li>
	<LI>Next message: <A HREF="002108.html">[Owasp-modsecurity-core-rule-set] Enabling the core rules for only	a certain pecentarge of requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2106">[ date ]</a>
              <a href="thread.html#2106">[ thread ]</a>
              <a href="subject.html#2106">[ subject ]</a>
              <a href="author.html#2106">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
