<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Slow HTTP DOS protection not behaving as expected
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20Slow%20HTTP%20DOS%20protection%20not%0A%20behaving%20as%20expected&In-Reply-To=BANLkTimBWTGjsvmjWYFF11qGzotUQ1o_bQ%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000725.html">
   <LINK REL="Next"  HREF="000728.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Slow HTTP DOS protection not behaving as expected</H1>
    <B>Ryan Barnett</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20Slow%20HTTP%20DOS%20protection%20not%0A%20behaving%20as%20expected&In-Reply-To=BANLkTimBWTGjsvmjWYFF11qGzotUQ1o_bQ%40mail.gmail.com"
       TITLE="[Owasp-modsecurity-core-rule-set] Slow HTTP DOS protection not behaving as expected">RBarnett at trustwave.com
       </A><BR>
    <I>Thu Apr 14 14:12:43 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="000725.html">[Owasp-modsecurity-core-rule-set] Slow HTTP DOS protection not behaving as expected
</A></li>
        <LI>Next message: <A HREF="000728.html">[Owasp-modsecurity-core-rule-set] Slow HTTP DOS protection not behaving as expected
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#726">[ date ]</a>
              <a href="thread.html#726">[ thread ]</a>
              <a href="subject.html#726">[ subject ]</a>
              <a href="author.html#726">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>OK, if mod_reqtimeout is installed and that directive is working, then after 30 sec if Apache has not received the entire request body then it should terminate the request with a 408 status code.  The ModSecurity CRS rules are simply monitoring if/how many 408 alerts are generated by Apache per client.  After a certain amount, then ModSecurity will step in on subsequent requests in phase:1 and do drop actions.

So, by monitoring your Apache error log while you are running your http_dos_cli tool, does Apache generate 408 alerts after 30 secs?  If not, then I don't think that the mod_reqtimeout module or directive is working.

-Ryan


From: Guillaume Bilodeau &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">guillaume.bilodeau at gmail.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">guillaume.bilodeau at gmail.com</A>&gt;&gt;
Date: Thu, 14 Apr 2011 13:07:41 -0500
To: Ryan Barnett &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">rbarnett at trustwave.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">rbarnett at trustwave.com</A>&gt;&gt;
Cc: &quot;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&gt;
Subject: Re: [Owasp-modsecurity-core-rule-set] Slow HTTP DOS protection not behaving as expected

Hi Ryan,

I'm no Apache expert, but AFAICT the req_timeout module is installed.  A /server-info shows the req_timeout.c module with the RequestReadTimeout parameter.

Thanks,
GB

On Thu, Apr 14, 2011 at 1:56 PM, Ryan Barnett &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">RBarnett at trustwave.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">RBarnett at trustwave.com</A>&gt;&gt; wrote:
Did you install the reqtimeout module?

#
# Mitigate Slow HTTP POST attacks
#
# Must have the mod_reqtimeout module installed
# You should adjust the RequestReadTimeout body directive setting to a limit
# that will allow any legitimate slow clients or large file uplaods.
#
&lt;IfModule reqtimeout_module&gt;
RequestReadTimeout body=30
&lt;/IfModule&gt;

-Ryan



From: Guillaume Bilodeau &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">guillaume.bilodeau at gmail.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">guillaume.bilodeau at gmail.com</A>&gt;&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">guillaume.bilodeau at gmail.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">guillaume.bilodeau at gmail.com</A>&gt;&gt;&gt;
Date: Thu, 14 Apr 2011 12:33:52 -0500
To: &quot;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&gt;&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&gt;&gt;
Subject: [Owasp-modsecurity-core-rule-set] Slow HTTP DOS protection not behaving as expected

Hi all,

We are trying to setup the OWASP Core Rule Set to protect our application from Slow HTTP DOS attacks.

We have setup ModSecurity 2.5.13 on our Apache 2.2.17 instance, loaded the module, and included all CRS base rules plus modsecurity_crs_11_slow_dos_protection.conf.  We didn't change the settings defined in the conf file, so SecReadStateLimit is set to 5 and RequestReadTimeout is set to body=30.  We are using the http_dos_cli command line tool to do our tests, with the connection parameter set to 500.

When running the slow-headers test, ModSecurity seems to be protecting the application correctly, dropping most (all?) requests from the tester's IP and allowing requests from a different IP to be served.  However, when running the slow-post test, ModSecurity doesn't seem to be doing anything.  From what I understand, the test successfully creates the 500 connections and keeps them open; none of them are dropped.  Requests coming from a different IP are not served and eventually time out.  A tail -f error_log shows nothing except the eventual message on MaxClients (set to 300 now) being reached.  Interestingly, when we kill the http_dos_cli process, the error_log is then flooded with hundreds of entries such as this:


[Mon Nov 22 17:44:46 2010] [warn] ModSecurity: Access denied with code 400.
Too many connections [6] of 5 allowed in READ state from 211.144.112.20 -
Possible DoS Consumption Attack [Rejected]

(this has been taken from the SpiderLabs blog entry, dates and IPs are obviously different)

Any idea on why this isn't behaving like we're expecting it to be?

Thanks!
GB




</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000725.html">[Owasp-modsecurity-core-rule-set] Slow HTTP DOS protection not behaving as expected
</A></li>
	<LI>Next message: <A HREF="000728.html">[Owasp-modsecurity-core-rule-set] Slow HTTP DOS protection not behaving as expected
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#726">[ date ]</a>
              <a href="thread.html#726">[ thread ]</a>
              <a href="subject.html#726">[ subject ]</a>
              <a href="author.html#726">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
