<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Seeking Feedback - New Approach	for XSS Detection/Response
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20Seeking%20Feedback%20-%20New%20Approach%0A%09for%20XSS%20Detection/Response&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000709.html">
   <LINK REL="Next"  HREF="000721.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Seeking Feedback - New Approach	for XSS Detection/Response</H1>
    <B>Ryan Barnett</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20Seeking%20Feedback%20-%20New%20Approach%0A%09for%20XSS%20Detection/Response&In-Reply-To="
       TITLE="[Owasp-modsecurity-core-rule-set] Seeking Feedback - New Approach	for XSS Detection/Response">RBarnett at trustwave.com
       </A><BR>
    <I>Thu Apr 14 11:15:51 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="000709.html">[Owasp-modsecurity-core-rule-set] Problems with rule:	modsecurity_crs_41_sql_injection_attacks
</A></li>
        <LI>Next message: <A HREF="000721.html">[Owasp-modsecurity-core-rule-set] Seeking Feedback - New Approach for XSS Detection/Response
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#720">[ date ]</a>
              <a href="thread.html#720">[ thread ]</a>
              <a href="subject.html#720">[ subject ]</a>
              <a href="author.html#720">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I have been thinking a lot recently about XSS Attacks and how ModSecurity can potentially identify these attacks and respond - <A HREF="http://www.modsecurity.org/documentation/XSS_Street_Fight-Ryan_Barnett-BlackhatDC-2011.pdf">http://www.modsecurity.org/documentation/XSS_Street_Fight-Ryan_Barnett-BlackhatDC-2011.pdf</A>

I would like to get some community feedback on a possible new approach for XSS.

The big current issue I see with the ModSecurity CRS approach is that the rules are looking for potentially malicious input and flagging them as XSS and executing blocking.  This approach is flawed for 2 reasons -

 1.  Many of the XSS signatures are too broad and are looking for any html data on inbound.  This may work OK if the application or specific parameter is never supposed to contain html code, however many users have apps that allow for some html code on the inbound.  There are many ModSecurity users who get upset because the rules end up blocking normal transaction in applications like WordPress.  The XSS signatures should probably be broken up into separate files - 1) Malicious code &#8211; which would only contain signatures for confirmed, malicious code.  These rules can be acted upon for blocking actions in any circumstance.  2) Html code &#8211; which would trigger on any html-like code.  This could be activated for sites that don't allow any html code.
 2.  Blocking inbound data for XSS is prone to False Positives.  XSS manifests itself when client-supplied data is echoed back out to clients in a non-escaped format.  The applications may actually be properly output escaping user-supplied data and they don't need for ModSecurity to do any blocking.  It seems that the best place to choose a blocking action for XSS is actually in the response back to the client.

Here is an example approach for #2 above.
We are already flagging inbound data as potential XSS attacks and saving the data in TX variables.  If we were to not block for XSS on the inbound, but instead inspect the RESPONSE_BODY variables for matches of TX XSS data, we could then choose to block.  Here is an example rule which does just that -

SecRule TX:/XSS/ &quot;@within %{response_body}&quot; &quot;phase:4,t:none,log,block,msg:'Malicious Client Data Found in Response Page.',logdata:'%{matched_var}'&quot;

As a test, I sent the following request (from the ModSec audit log) -

###############################
--25ab4619-B--
POST /cgi-bin/fup.cgi HTTP/1.1
Host: localhost
Connection: keep-alive
Referer: <A HREF="http://localhost/upload.html">http://localhost/upload.html</A>
Content-Length: 429
Cache-Control: max-age=0
Origin: <A HREF="http://localhost">http://localhost</A>
User-Agent: Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10_6_7; en-US) AppleWebKit/534.16 (KHTML, like Gecko) Chrome/10.0.648.204 Safari/534.16
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary5l4ChTnz96IS0ru8
Accept: application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
Accept-Encoding: gzip,deflate,sdch
Accept-Language: en-US,en;q=0.8
Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.3

--25ab4619-I--
note=%3cscript%3ealert%28%27xss%27%29%3c%2fscript%3e
--25ab4619-F--
HTTP/1.1 200 OK
Content-Length: 308
Keep-Alive: timeout=5, max=100
Connection: Keep-Alive
Content-Type: text/html

--25ab4619-E--
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;File Upload Results&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;File Upload Results&lt;/h1&gt;

&lt;p&gt;You've uploaded a file.  Your notes on the file were:&lt;br&gt;
&lt;blockquote&gt;&lt;script&gt;alert('xss')&lt;/script&gt;&lt;/blockquote&gt;&lt;br&gt;
&lt;p&gt;The file's contents are:
&lt;pre&gt;

&lt;/pre&gt;
&lt;/body&gt;
&lt;/html&gt;
###############################

The new rule generated a number of events -

[Thu Apr 14 11:00:59 2011] [error] [client ::1] ModSecurity: Warning. String match within &quot;&lt;html&gt;\\n&lt;head&gt;\\n&lt;title&gt;File Upload Results&lt;/title&gt;\\n&lt;/head&gt;\\n&lt;body&gt;\\n&lt;h1&gt;File Upload Results&lt;/h1&gt;\\n\\n&lt;p&gt;You've uploaded a file.  Your notes on the file were:&lt;br&gt;\\n&lt;blockquote&gt;&lt;script&gt;alert('xss')&lt;/script&gt;&lt;/blockquote&gt;&lt;br&gt;\\n&lt;script&gt;&lt;/script&gt;\\n&lt;script&gt;&lt;/script&gt;\\n&lt;p&gt;The file's contents are:\\n&lt;pre&gt;\\n\\n&lt;/pre&gt;\\n&lt;/body&gt;\\n&lt;/html&gt;\\n&quot; at TX:958052-WEB_ATTACK/XSS-ARGS:note. [file &quot;/usr/local/apache/conf/crs/base_rules/modsecurity_crs_15_customrules.conf&quot;] [line &quot;17&quot;] [msg &quot;Malicious Client Data Found n Response Page.&quot;] [data &quot;alert(&quot;] [hostname &quot;localhost&quot;] [uri &quot;/cgi-bin/fup.cgi&quot;] [unique_id &quot;TacMK8CoqAEAAKdOIfUAAAAB&quot;]
[Thu Apr 14 11:00:59 2011] [error] [client ::1] ModSecurity: Warning. String match within &quot;&lt;html&gt;\\n&lt;head&gt;\\n&lt;title&gt;File Upload Results&lt;/title&gt;\\n&lt;/head&gt;\\n&lt;body&gt;\\n&lt;h1&gt;File Upload Results&lt;/h1&gt;\\n\\n&lt;p&gt;You've uploaded a file.  Your notes on the file were:&lt;br&gt;\\n&lt;blockquote&gt;&lt;script&gt;alert('xss')&lt;/script&gt;&lt;/blockquote&gt;&lt;br&gt;\\n&lt;script&gt;&lt;/script&gt;\\n&lt;script&gt;&lt;/script&gt;\\n&lt;p&gt;The file's contents are:\\n&lt;pre&gt;\\n\\n&lt;/pre&gt;\\n&lt;/body&gt;\\n&lt;/html&gt;\\n&quot; at TX:958051-WEB_ATTACK/XSS-ARGS:note. [file &quot;/usr/local/apache/conf/crs/base_rules/modsecurity_crs_15_customrules.conf&quot;] [line &quot;17&quot;] [msg &quot;Malicious Client Data Found n Response Page.&quot;] [data &quot;&lt;script&quot;] [hostname &quot;localhost&quot;] [uri &quot;/cgi-bin/fup.cgi&quot;] [unique_id &quot;TacMK8CoqAEAAKdOIfUAAAAB&quot;]
[Thu Apr 14 11:00:59 2011] [error] [client ::1] ModSecurity: Warning. String match within &quot;&lt;html&gt;\\n&lt;head&gt;\\n&lt;title&gt;File Upload Results&lt;/title&gt;\\n&lt;/head&gt;\\n&lt;body&gt;\\n&lt;h1&gt;File Upload Results&lt;/h1&gt;\\n\\n&lt;p&gt;You've uploaded a file.  Your notes on the file were:&lt;br&gt;\\n&lt;blockquote&gt;&lt;script&gt;alert('xss')&lt;/script&gt;&lt;/blockquote&gt;&lt;br&gt;\\n&lt;script&gt;&lt;/script&gt;\\n&lt;script&gt;&lt;/script&gt;\\n&lt;p&gt;The file's contents are:\\n&lt;pre&gt;\\n\\n&lt;/pre&gt;\\n&lt;/body&gt;\\n&lt;/html&gt;\\n&quot; at TX:973300-WEB_ATTACK/XSS-ARGS:note. [file &quot;/usr/local/apache/conf/crs/base_rules/modsecurity_crs_15_customrules.conf&quot;] [line &quot;17&quot;] [msg &quot;Malicious Client Data Found n Response Page.&quot;] [data &quot;&lt;script&gt;&quot;] [hostname &quot;localhost&quot;] [uri &quot;/cgi-bin/fup.cgi&quot;] [unique_id &quot;TacMK8CoqAEAAKdOIfUAAAAB&quot;]
[Thu Apr 14 11:00:59 2011] [error] [client ::1] ModSecurity: Warning. String match within &quot;&lt;html&gt;\\n&lt;head&gt;\\n&lt;title&gt;File Upload Results&lt;/title&gt;\\n&lt;/head&gt;\\n&lt;body&gt;\\n&lt;h1&gt;File Upload Results&lt;/h1&gt;\\n\\n&lt;p&gt;You've uploaded a file.  Your notes on the file were:&lt;br&gt;\\n&lt;blockquote&gt;&lt;script&gt;alert('xss')&lt;/script&gt;&lt;/blockquote&gt;&lt;br&gt;\\n&lt;script&gt;&lt;/script&gt;\\n&lt;script&gt;&lt;/script&gt;\\n&lt;p&gt;The file's contents are:\\n&lt;pre&gt;\\n\\n&lt;/pre&gt;\\n&lt;/body&gt;\\n&lt;/html&gt;\\n&quot; at TX:973307-WEB_ATTACK/XSS-ARGS:note. [file &quot;/usr/local/apache/conf/crs/base_rules/modsecurity_crs_15_customrules.conf&quot;] [line &quot;17&quot;] [msg &quot;Malicious Client Data Found n Response Page.&quot;] [data &quot;alert(&quot;] [hostname &quot;localhost&quot;] [uri &quot;/cgi-bin/fup.cgi&quot;] [unique_id &quot;TacMK8CoqAEAAKdOIfUAAAAB&quot;]
[Thu Apr 14 11:00:59 2011] [error] [client ::1] ModSecurity: Warning. String match within &quot;&lt;html&gt;\\n&lt;head&gt;\\n&lt;title&gt;File Upload Results&lt;/title&gt;\\n&lt;/head&gt;\\n&lt;body&gt;\\n&lt;h1&gt;File Upload Results&lt;/h1&gt;\\n\\n&lt;p&gt;You've uploaded a file.  Your notes on the file were:&lt;br&gt;\\n&lt;blockquote&gt;&lt;script&gt;alert('xss')&lt;/script&gt;&lt;/blockquote&gt;&lt;br&gt;\\n&lt;script&gt;&lt;/script&gt;\\n&lt;script&gt;&lt;/script&gt;\\n&lt;p&gt;The file's contents are:\\n&lt;pre&gt;\\n\\n&lt;/pre&gt;\\n&lt;/body&gt;\\n&lt;/html&gt;\\n&quot; at TX:973310-WEB_ATTACK/XSS-ARGS:note. [file &quot;/usr/local/apache/conf/crs/base_rules/modsecurity_crs_15_customrules.conf&quot;] [line &quot;17&quot;] [msg &quot;Malicious Client Data Found n Response Page.&quot;] [data &quot;'xss'&quot;] [hostname &quot;localhost&quot;] [uri &quot;/cgi-bin/fup.cgi&quot;] [unique_id &quot;TacMK8CoqAEAAKdOIfUAAAAB&quot;]
[Thu Apr 14 11:00:59 2011] [error] [client ::1] ModSecurity: Warning. String match within &quot;&lt;html&gt;\\n&lt;head&gt;\\n&lt;title&gt;File Upload Results&lt;/title&gt;\\n&lt;/head&gt;\\n&lt;body&gt;\\n&lt;h1&gt;File Upload Results&lt;/h1&gt;\\n\\n&lt;p&gt;You've uploaded a file.  Your notes on the file were:&lt;br&gt;\\n&lt;blockquote&gt;&lt;script&gt;alert('xss')&lt;/script&gt;&lt;/blockquote&gt;&lt;br&gt;\\n&lt;script&gt;&lt;/script&gt;\\n&lt;script&gt;&lt;/script&gt;\\n&lt;p&gt;The file's contents are:\\n&lt;pre&gt;\\n\\n&lt;/pre&gt;\\n&lt;/body&gt;\\n&lt;/html&gt;\\n&quot; at TX:973331-WEB_ATTACK/XSS-ARGS:note. [file &quot;/usr/local/apache/conf/crs/base_rules/modsecurity_crs_15_customrules.conf&quot;] [line &quot;17&quot;] [msg &quot;Malicious Client Data Found n Response Page.&quot;] [data &quot;&lt;script&gt;&quot;] [hostname &quot;localhost&quot;] [uri &quot;/cgi-bin/fup.cgi&quot;] [unique_id &quot;TacMK8CoqAEAAKdOIfUAAAAB&quot;]

This approach seems to me to be more accurate for detecting/reacting to XSS as you are doing the inspection/blocking in the outbound which means that you have less false positives.

Now, taking this approach one step further!  With the upcoming ModSecurity v2.6 &#8211; you could actually extend the rule logic to use @rsub against the STREAM_OUTPUT_BODY and actually remove malicious code from response bodies and still send the page :)

SecRule TX:/XSS/ &quot;@within %{response_body}&quot; &quot;chain,phase:4,t:none,log,pass,msg:'Malicious Client Data Removed From Response Page.',logdata:'%{matched_var}'&quot;
       SecRule STREAM_OUTPUT_BODY &quot;@rsub s/%{matched_var}/MALICIOUS_CODE_REMOVED/d&quot;

Running new ruleset &#8211; this is how the reflected XSS attack response page would look to a client -

$ curl &quot;<A HREF="http://localhost/cgi-bin/fup.cgi?note=&lt;script">http://localhost/cgi-bin/fup.cgi?note=&lt;script</A>&gt;alert('xss')&lt;/script&gt;&quot;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;File Upload Results&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;File Upload Results&lt;/h1&gt;

&lt;p&gt;You've uploaded a file.  Your notes on the file were:&lt;br&gt;
&lt;blockquote&gt;MALICIOUS_CODE_REMOVEDalert('xss')&lt;/script&gt;&lt;/blockquote&gt;&lt;br&gt;
&lt;p&gt;The file's contents are:
&lt;pre&gt;

&lt;/pre&gt;
&lt;/body&gt;
&lt;/html&gt;

Comments welcome!

-Ryan




________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000709.html">[Owasp-modsecurity-core-rule-set] Problems with rule:	modsecurity_crs_41_sql_injection_attacks
</A></li>
	<LI>Next message: <A HREF="000721.html">[Owasp-modsecurity-core-rule-set] Seeking Feedback - New Approach for XSS Detection/Response
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#720">[ date ]</a>
              <a href="thread.html#720">[ thread ]</a>
              <a href="subject.html#720">[ subject ]</a>
              <a href="author.html#720">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
