<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;I&#39;ve&nbsp;been&nbsp;experimenting&nbsp;with&nbsp;this modsecurity_crs_11_dos_protection.conf&nbsp;ruleset&nbsp;more.&nbsp;An&nbsp;outline&nbsp;of&nbsp;how&nbsp;it&nbsp;seems&nbsp;to&nbsp;work:&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;-&nbsp;Every&nbsp;non-image&nbsp;request&nbsp;increments&nbsp;the ip.dos_counter&nbsp;counter.&lt;/div&gt;<br>
&lt;div&nbsp;style&gt;-&nbsp;If&nbsp;that&nbsp;counter&nbsp;is&nbsp;&gt; tx.dos_counter_threshold,&nbsp;it&nbsp;increments&nbsp;ip.dos_burst_counter,&nbsp;sets&nbsp;an&nbsp;expiration&nbsp;time&nbsp;on&nbsp;ip.dos_burst_counter,&nbsp;and&nbsp;clears&nbsp;ip.dos_counter&lt;/div&gt;&lt;div&nbsp;style&gt;-&nbsp;If ip.dos_burst_counter&nbsp;&gt;&nbsp;ip.dos_burst_threshold,&nbsp;it&nbsp;blocks&nbsp;the&nbsp;request&nbsp;until tx.dos_block_timeout&nbsp;seconds&nbsp;elapses&lt;/div&gt;<br>
&lt;div&nbsp;style&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;The&nbsp;rational&nbsp;behind&nbsp;the&nbsp;burst&nbsp;counter&nbsp;seems&nbsp;to&nbsp;be&nbsp;because&nbsp;mod_security&nbsp;expiration&nbsp;doesn&#39;t&nbsp;work&nbsp;based&nbsp;on&nbsp;the&nbsp;FIRST&nbsp;write&nbsp;to&nbsp;a&nbsp;variable,&nbsp;it&nbsp;works&nbsp;based&nbsp;on&nbsp;the&nbsp;most&nbsp;recent&nbsp;write.&nbsp;In&nbsp;my&nbsp;case,&nbsp;I&#39;m&nbsp;using&nbsp;a&nbsp;time&nbsp;slice&nbsp;of&nbsp;60&nbsp;seconds,&nbsp;but&nbsp;if&nbsp;a&nbsp;bot&nbsp;requests&nbsp;a&nbsp;page&nbsp;every&nbsp;10&nbsp;seconds&nbsp;for&nbsp;hours&nbsp;it&nbsp;will&nbsp;never&nbsp;expire&nbsp;ip_dos_counter,&nbsp;the&nbsp;only&nbsp;time&nbsp;that&nbsp;will&nbsp;happen&nbsp;is&nbsp;if&nbsp;they&nbsp;don&#39;t&nbsp;do&nbsp;any&nbsp;requests&nbsp;for&nbsp;60&nbsp;seconds.&nbsp;So,&nbsp;this&nbsp;burst&nbsp;counter&nbsp;is&nbsp;designed&nbsp;to&nbsp;try&nbsp;to&nbsp;get&nbsp;around&nbsp;this&nbsp;problem&nbsp;by&nbsp;waiting&nbsp;until&nbsp;the&nbsp;dos_counter&nbsp;is&nbsp;over&nbsp;the&nbsp;threshold&nbsp;(which&nbsp;doesn&#39;t&nbsp;really&nbsp;prove&nbsp;anything&nbsp;about&nbsp;how&nbsp;fast&nbsp;requests&nbsp;were&nbsp;being&nbsp;made,&nbsp;only&nbsp;that&nbsp;the&nbsp;user&nbsp;has&nbsp;done&nbsp;a&nbsp;bunch&nbsp;of&nbsp;requests&nbsp;without&nbsp;pausing)&nbsp;and&nbsp;then&nbsp;it&nbsp;increments&nbsp;the&nbsp;burst&nbsp;counter&nbsp;which&nbsp;has&nbsp;an&nbsp;expiration&nbsp;time&nbsp;(in&nbsp;my&nbsp;case,&nbsp;60&nbsp;seconds)&nbsp;and&nbsp;clears&nbsp;out&nbsp;the&nbsp;dos_counter.&nbsp;So,&nbsp;if&nbsp;the&nbsp;dos&nbsp;counter&nbsp;gets&nbsp;up&nbsp;to&nbsp;the&nbsp;threshold&nbsp;AGAIN,&nbsp;then&nbsp;it&nbsp;knows&nbsp;that&nbsp;those&nbsp;requests&nbsp;really&nbsp;all&nbsp;have&nbsp;come&nbsp;in&nbsp;the&nbsp;past&nbsp;60&nbsp;seconds,&nbsp;so&nbsp;it&nbsp;knows&nbsp;that&nbsp;the&nbsp;user&nbsp;is&nbsp;requesting&nbsp;too&nbsp;quickly.&lt;/div&gt;<br>
&lt;div&nbsp;style&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;Great&nbsp;in&nbsp;theory,&nbsp;but&nbsp;this&nbsp;is&nbsp;broken.&lt;/div&gt;&lt;div&nbsp;style&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;The&nbsp;problem&nbsp;scenario:&lt;/div&gt;&lt;div&nbsp;style&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;-&nbsp;A&nbsp;bot&nbsp;(bingbot&nbsp;in&nbsp;my&nbsp;case)&nbsp;has&nbsp;been&nbsp;requesting&nbsp;pages&nbsp;for&nbsp;the&nbsp;past&nbsp;hour.&nbsp;Averaging&nbsp;one&nbsp;or&nbsp;two&nbsp;requests&nbsp;per&nbsp;second.&nbsp;Nothing&nbsp;to&nbsp;worry&nbsp;about.&lt;/div&gt;<br>
&lt;div&nbsp;style&gt;-&nbsp;The&nbsp;dos_counter&nbsp;is&nbsp;over&nbsp;the&nbsp;threshold&nbsp;because&nbsp;it&nbsp;has&nbsp;been&nbsp;submitting&nbsp;requests&nbsp;for&nbsp;a&nbsp;long&nbsp;time&nbsp;without&nbsp;pausing&lt;/div&gt;&lt;div&nbsp;style&gt;-&nbsp;Sometimes&nbsp;it&nbsp;submits&nbsp;2-4&nbsp;requests&nbsp;virtually&nbsp;simultaneously&nbsp;(on&nbsp;the&nbsp;same&nbsp;second&nbsp;in&nbsp;the&nbsp;log)&lt;/div&gt;<br>
&lt;div&nbsp;style&gt;-&nbsp;It&nbsp;submits&nbsp;2&nbsp;or&nbsp;more&nbsp;requests&nbsp;simultaneously.&nbsp;For&nbsp;EACH&nbsp;REQUEST,&nbsp;mod_security&nbsp;sees&nbsp;that&nbsp;ip_dos_counter&nbsp;is&nbsp;over&nbsp;the&nbsp;threshold,&nbsp;so&nbsp;each&nbsp;request&nbsp;increments&nbsp;ip_dos_burst_counter.&nbsp;bingbot&nbsp;is&nbsp;now&nbsp;blocked.&lt;/div&gt;&lt;div&nbsp;style&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;So&nbsp;this&nbsp;is&nbsp;an&nbsp;example&nbsp;where&nbsp;the&nbsp;bot&nbsp;was&nbsp;blocked&nbsp;even&nbsp;though&nbsp;it&nbsp;was&nbsp;operating&nbsp;at&nbsp;a&nbsp;far&nbsp;slower&nbsp;rate&nbsp;than&nbsp;the&nbsp;DoS&nbsp;settings&nbsp;specify.&nbsp;If&nbsp;those&nbsp;2&nbsp;requests&nbsp;would&nbsp;have&nbsp;been&nbsp;spaced&nbsp;apart&nbsp;by&nbsp;a&nbsp;second,&nbsp;it&nbsp;would&nbsp;not&nbsp;have&nbsp;been&nbsp;blocked.&nbsp;But,&nbsp;by&nbsp;submitting&nbsp;requests&nbsp;very&nbsp;close&nbsp;together,&nbsp;a&nbsp;bot&nbsp;can&nbsp;be&nbsp;blocked&nbsp;without&nbsp;really&nbsp;submitting&nbsp;that&nbsp;many&nbsp;requests&nbsp;very&nbsp;quickly.&nbsp;This&nbsp;is&nbsp;happening&nbsp;on&nbsp;my&nbsp;server&nbsp;at&nbsp;least&nbsp;every&nbsp;day.&lt;/div&gt;<br>
&lt;div&nbsp;style&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;I&nbsp;am&nbsp;new&nbsp;to&nbsp;mod_security&nbsp;so&nbsp;I&#39;m&nbsp;still&nbsp;learning&nbsp;exactly&nbsp;how&nbsp;these&nbsp;rules&nbsp;work,&nbsp;but&nbsp;are&nbsp;there&nbsp;any&nbsp;solutions&nbsp;to&nbsp;this&nbsp;problem?&nbsp;The&nbsp;way&nbsp;this&nbsp;rule&nbsp;is&nbsp;set&nbsp;up,&nbsp;it&nbsp;seems&nbsp;to&nbsp;be&nbsp;operating&nbsp;on&nbsp;the&nbsp;principle&nbsp;that&nbsp;the&nbsp;rule&nbsp;is&nbsp;atomic&nbsp;when&nbsp;it&nbsp;clearly&nbsp;isn&#39;t.&nbsp;If&nbsp;dos_counter&nbsp;would&nbsp;be&nbsp;cleared&nbsp;before&nbsp;the&nbsp;burst&nbsp;counter&nbsp;is&nbsp;incremented,&nbsp;this&nbsp;problem&nbsp;wouldn&#39;t&nbsp;exist.&lt;/div&gt;<br>
&lt;div&nbsp;style&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;I&#39;m&nbsp;also&nbsp;unclear&nbsp;on&nbsp;how&nbsp;this&nbsp;is&nbsp;coordinated&nbsp;across&nbsp;the&nbsp;multiple&nbsp;apache&nbsp;processes.&nbsp;I&nbsp;understand&nbsp;this&nbsp;to&nbsp;be&nbsp;a&nbsp;collection,&nbsp;which&nbsp;resides&nbsp;on&nbsp;disk,&nbsp;so&nbsp;I&#39;m&nbsp;not&nbsp;sure&nbsp;when&nbsp;mod_security&nbsp;writes&nbsp;this&nbsp;information&nbsp;to&nbsp;disk.&lt;/div&gt;<br>
&lt;div&nbsp;style&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;Does&nbsp;anyone&nbsp;have&nbsp;any&nbsp;pointers&nbsp;for&nbsp;where&nbsp;to&nbsp;look,&nbsp;or&nbsp;a&nbsp;different&nbsp;DoS&nbsp;ruleset&nbsp;to&nbsp;try?&lt;/div&gt;&lt;div&nbsp;style&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;Or&nbsp;is&nbsp;DoS&nbsp;protection&nbsp;not&nbsp;something&nbsp;that&nbsp;is&nbsp;possible&nbsp;with&nbsp;mod_security,&nbsp;and&nbsp;I&nbsp;need&nbsp;another&nbsp;module?&nbsp;I&nbsp;don&#39;t&nbsp;need&nbsp;anything&nbsp;fancy,&nbsp;I&nbsp;just&nbsp;want&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;limit&nbsp;an&nbsp;IP&nbsp;address&nbsp;to&nbsp;a&nbsp;certain&nbsp;number&nbsp;of&nbsp;requests&nbsp;within&nbsp;a&nbsp;time&nbsp;period.&nbsp;Thanks,&lt;/div&gt;<br>
&lt;div&nbsp;style&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style&gt;Nick&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Mon,&nbsp;Apr&nbsp;29,&nbsp;2013&nbsp;at&nbsp;12:49&nbsp;PM,&nbsp;Nick&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:darknovanick@gmail.com&quot;&nbsp;target=&quot;_blank&quot;&gt;darknovanick@gmail.com&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hello,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&#39;ve&nbsp;been&nbsp;setting&nbsp;up&nbsp;mod_security&nbsp;and&nbsp;enabled&nbsp;the modsecurity_crs_11_dos_protection.conf&nbsp;rule.&nbsp;This&nbsp;is&nbsp;mod_security&nbsp;2.6.8&nbsp;and CRS&nbsp;version&nbsp;2.2.5.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;have&nbsp;initialized&nbsp;the&nbsp;settings&nbsp;with:&lt;/div&gt;<br>
&lt;div&gt;&lt;div&gt;SecAction&nbsp;\&lt;/div&gt;&lt;div&gt; &nbsp;&quot;id:&#39;900015&#39;,&nbsp;\&lt;/div&gt;&lt;div&gt; &nbsp;phase:1,&nbsp;\&lt;/div&gt;&lt;div&gt; &nbsp;t:none,&nbsp;\&lt;/div&gt;&lt;div&gt; &nbsp;setvar:&#39;tx.dos_burst_time_slice=60&#39;,&nbsp;\&lt;/div&gt;&lt;div&gt; &nbsp;setvar:&#39;tx.dos_counter_threshold=300&#39;,&nbsp;\&lt;/div&gt;<br>
<br>
&lt;div&gt; &nbsp;setvar:&#39;tx.dos_block_timeout=600&#39;,&nbsp;\&lt;/div&gt;&lt;div&gt; &nbsp;nolog,&nbsp;\&lt;/div&gt;&lt;div&gt; &nbsp;pass&quot;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;works&nbsp;and&nbsp;it&nbsp;is&nbsp;blocking&nbsp;some&nbsp;very&nbsp;aggressive&nbsp;bots&nbsp;the&nbsp;way&nbsp;it&nbsp;should.&nbsp;But&nbsp;there&nbsp;is&nbsp;a&nbsp;problem.&nbsp;I&nbsp;have&nbsp;occasionally&nbsp;been&nbsp;getting&nbsp;lines&nbsp;like&nbsp;this&nbsp;in&nbsp;the&nbsp;log:&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;Warning.&nbsp;Operator&nbsp;GE&nbsp;matched&nbsp;2&nbsp;at&nbsp;IP:dos_burst_counter.&nbsp;[file&nbsp;&quot;/etc/httpd/modsecurity.d/activated_rules/modsecurity_crs_11_dos_protection.conf&quot;]&nbsp;[line&nbsp;&quot;44&quot;]&nbsp;[id&nbsp;&quot;981049&quot;]&nbsp;[msg&nbsp;&quot;Potential&nbsp;Denial&nbsp;of&nbsp;Service&nbsp;(DoS)&nbsp;Attack&nbsp;from&nbsp;65.55.24.236&nbsp;-&nbsp;#&nbsp;of&nbsp;Request&nbsp;Bursts:&nbsp;3&quot;]&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;bot&nbsp;was&nbsp;actually&nbsp;bingbot.&nbsp;I&nbsp;am&nbsp;new&nbsp;to&nbsp;mod_security,&nbsp;but&nbsp;my&nbsp;understanding&nbsp;of&nbsp;my&nbsp;settings&nbsp;is&nbsp;that&nbsp;it&nbsp;shouldn&#39;t&nbsp;block&nbsp;until&nbsp;a&nbsp;bot&nbsp;has&nbsp;requested&nbsp;300&nbsp;pages&nbsp;in&nbsp;60&nbsp;seconds.&lt;/div&gt;&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;&lt;div&gt;When&nbsp;I&nbsp;check&nbsp;the&nbsp;logs&nbsp;I&nbsp;see&nbsp;that&nbsp;IP&nbsp;65.55.24.236&nbsp;has&nbsp;requested&nbsp;313&nbsp;pages&nbsp;in&nbsp;1&nbsp;hour.&nbsp;In&nbsp;the&nbsp;60&nbsp;seconds&nbsp;before&nbsp;the&nbsp;DoS&nbsp;block&nbsp;happening,&nbsp;this&nbsp;IP&nbsp;only&nbsp;requested&nbsp;6&nbsp;pages.&nbsp;This&nbsp;block&nbsp;obviously&nbsp;shouldn&#39;t&nbsp;be&nbsp;happening.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;am&nbsp;grossly&nbsp;misunderstanding&nbsp;something,&nbsp;or&nbsp;what&nbsp;can&nbsp;I&nbsp;do&nbsp;to&nbsp;fix&nbsp;this?&nbsp;Thanks,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Nick&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
