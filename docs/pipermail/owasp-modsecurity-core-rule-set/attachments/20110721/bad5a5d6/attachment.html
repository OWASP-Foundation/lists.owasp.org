<tt>
Hello,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;in&nbsp;crs&nbsp;2.2.1&nbsp;there&nbsp;is&nbsp;a&nbsp;oversight&nbsp;in&nbsp;Rule 981063.&nbsp;It&nbsp;should&nbsp;save&nbsp;session.ip&nbsp;but&nbsp;it&nbsp;saves&nbsp;tx.ip_hash.&lt;/div&gt;&lt;div&gt;And&nbsp;if&nbsp;the&nbsp;hash&nbsp;value&nbsp;should&nbsp;be&nbsp;saved&nbsp;then&nbsp;the&nbsp;&amp;quot;capture&amp;quot;&nbsp;is&nbsp;missing&nbsp;in&nbsp;the&nbsp;chained&nbsp;rule.&nbsp;Now&nbsp;only&nbsp;the&nbsp;3&nbsp;octets&nbsp;are&nbsp;saved&nbsp;so&nbsp;the&nbsp;naming&nbsp;of&nbsp;the&nbsp;variables&nbsp;is&nbsp;a&nbsp;little&nbsp;bit&nbsp;misunderstanding&nbsp;(tx.ip_hash).&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;So&nbsp;the&nbsp;Rules&nbsp;should&nbsp;look&nbsp;like&nbsp;this.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;SecRule&nbsp;TX:IP&nbsp;&amp;quot;^(\d{1,3}\.\d{1,3}\.\d{1,3}\.)&amp;quot;&nbsp;&amp;quot;chain,phase:1,id:&amp;#39;981057&amp;#39;,capture,t:none,nolog,pass&amp;quot;&lt;/div&gt;&lt;div&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp;SecRule&nbsp;TX:1&nbsp;&amp;quot;.*&amp;quot;&nbsp;&amp;quot;capture,t:sha1,t:hexEncode,setvar:tx.ip_hash=%{tx.0}&amp;quot;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;SecRule&nbsp;TX:IP&nbsp;&amp;quot;^(\d{1,3}\.\d{1,3}\.\d{1,3}\.)&amp;quot;&nbsp;&amp;quot;chain,phase:3,id:&amp;#39;981063&amp;#39;,capture,t:none,nolog,pass&amp;quot;&lt;/div&gt;<br>
&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;SecRule&nbsp;TX:1&nbsp;&amp;quot;.*&amp;quot;&nbsp;&amp;quot;capture,t:sha1,t:hexEncode,setvar:session.ip=%{tx.0}&amp;quot;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Michael&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;2011/7/17&nbsp;Michael&nbsp;Haas&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:michael.haas10@gmail.com&quot;&gt;michael.haas10@gmail.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;Hi, &lt;div&gt;i&nbsp;have&nbsp;another&nbsp;problem&nbsp;with&nbsp;the&nbsp;rules&nbsp;in&nbsp;this&nbsp;file.&lt;div&gt;The&nbsp;Rules&nbsp;are&nbsp;working&nbsp;as&nbsp;expected&nbsp;if&nbsp;i&nbsp;change&nbsp;the&nbsp;IP&nbsp;or&nbsp;the&nbsp;UA&nbsp;but&nbsp;if&nbsp;i&nbsp;change&nbsp;the&nbsp;sessionid&nbsp;to&nbsp;another&nbsp;value&nbsp;it&amp;#39;s&nbsp;not&nbsp;working&nbsp;as&nbsp;expected.&lt;/div&gt;<br>
&lt;div&gt;I&nbsp;Think&nbsp;the&nbsp;following&nbsp;Rule&nbsp;is&nbsp;not&nbsp;working&nbsp;if&nbsp;the&nbsp;session&nbsp;id&nbsp;is&nbsp;changed&nbsp;to&nbsp;an&nbsp;unknown&nbsp;value,&nbsp;because&nbsp;the&nbsp;!&nbsp;operator&nbsp;does&nbsp;not&nbsp;work&nbsp;with&nbsp;non&nbsp;existent&nbsp;variables(don&amp;#39;t&nbsp;know&nbsp;if&nbsp;its&nbsp;a&nbsp;bug&nbsp;or&nbsp;not).&lt;/div&gt;<br>
&lt;div&gt;&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;div&gt;SecRule&nbsp;REQUEST_COOKIES:&amp;#39;/(j?sessionid|(php)?sessid|(asp|jserv|jw)?session[-_]?(id)?|cf(id|token)|sid)/&amp;#39;&nbsp;&amp;quot;.*&amp;quot;&nbsp;&amp;quot;chain,phase:1,id:&amp;#39;981054&amp;#39;,t:none,block,log,msg:&amp;#39;Invalid&nbsp;SessionID&nbsp;Submitted.&amp;#39;,setsid:%{matched_var},setvar:tx.sessionid=%{matched_var},skipAfter:END_SESSION_STARTUP&amp;quot;&lt;/div&gt;<br>
<br>
&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;SecRule&nbsp;SESSION:VALID&nbsp;&amp;quot;!@eq&nbsp;1&amp;quot;&nbsp;&amp;quot;t:none,setvar:tx.anomaly_score=+%{tx.critical_anomaly_score},setvar:tx.%{&lt;a&nbsp;href=&quot;http://rule.id&quot;&nbsp;target=&quot;_blank&quot;&gt;rule.id&lt;/a&gt;}-WEB_ATTACK/INVALID_SESSIONID-%{matched_var_name}=%{tx.0}&amp;quot;&lt;/div&gt;<br>
<br>
&lt;/div&gt;&lt;div&gt;SESSION:VALID&nbsp;does&nbsp;not&nbsp;match&nbsp;if&nbsp;the&nbsp;SESSION.VALID&nbsp;Variable&nbsp;doesn&amp;#39;t&nbsp;exist.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;have&nbsp;verfied&nbsp;this&nbsp;with&nbsp;the&nbsp;following&nbsp;test.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; SecAction&nbsp;&amp;quot;phase:1,id:&amp;#39;2000&amp;#39;,t:none,nolog,pass,setvar:tx.test=1&amp;quot;&lt;/div&gt;<br>
<br>
&lt;div&gt;SecRule&nbsp;TX:TEST&nbsp;&amp;quot;@eq&nbsp;1&amp;quot;&nbsp;&amp;quot;phase:1,t:none,id:&amp;#39;2001&amp;#39;&amp;quot;&lt;/div&gt;&lt;div&gt;SecRule&nbsp;TX:TEST&nbsp;&amp;quot;!@eq&nbsp;0&amp;quot;&nbsp;&amp;quot;phase:1,t:none,id:&amp;#39;2002&amp;#39;&amp;quot;&lt;/div&gt;&lt;div&gt;SecRule&nbsp;TX:TEST&nbsp;&amp;quot;!@eq&nbsp;1&amp;quot;&nbsp;&amp;quot;phase:1,t:none,id:&amp;#39;2003&amp;#39;&amp;quot;&lt;/div&gt;<br>
<br>
&lt;div&gt;TEST1&nbsp;doesn&amp;#39;t&nbsp;exist.&lt;/div&gt;&lt;div&gt;SecRule&nbsp;TX:TEST1&nbsp;&amp;quot;@eq&nbsp;1&amp;quot;&nbsp;&amp;quot;phase:1,t:none,id:&amp;#39;2004&amp;#39;&amp;quot;&lt;/div&gt;&lt;div&gt;SecRule&nbsp;TX:TEST1&nbsp;&amp;quot;!@eq&nbsp;1&amp;quot;&nbsp;&amp;quot;phase:1,t:none,id:&amp;#39;2005&amp;#39;&amp;quot;&nbsp; &nbsp; &nbsp;Thats&nbsp;the&nbsp;Problem,&nbsp;it&nbsp;should&nbsp;match&nbsp;because&nbsp;TEST1&nbsp;is&nbsp;not equal to&nbsp;1&nbsp;but&nbsp;it&nbsp;does&nbsp;not&nbsp;match.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Debug&nbsp;Log&nbsp;for&nbsp;the&nbsp;test.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;Rule&nbsp;801648:&nbsp;SecAction&nbsp;&amp;quot;phase:1,auditlog,id:2000,t:none,nolog,pass,setvar:tx.test=1&amp;quot;&lt;/div&gt;&lt;div&gt; Setting&nbsp;variable:&nbsp;tx.test=1&lt;/div&gt;&lt;div&gt; Set&nbsp;variable&nbsp;&amp;quot;tx.test&amp;quot;&nbsp;to&nbsp;&amp;quot;1&amp;quot;.&lt;/div&gt;<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;<br>
&lt;div&gt; Rule&nbsp;returned&nbsp;1.&lt;/div&gt;&lt;div&gt; Match&nbsp;-&amp;gt;&nbsp;mode&nbsp;NEXT_RULE.&lt;/div&gt;&lt;/div&gt;&lt;div&gt; Rule&nbsp;809ed0:&nbsp;SecRule&nbsp;&amp;quot;TX:TEST&amp;quot;&nbsp;&amp;quot;@eq&nbsp;1&amp;quot;&nbsp;&amp;quot;phase:1,pass,nolog,auditlog,t:none,id:2001&amp;quot;&lt;/div&gt;&lt;div&gt; Executing&nbsp;operator&nbsp;&amp;quot;eq&amp;quot;&nbsp;with&nbsp;param&nbsp;&amp;quot;1&amp;quot;&nbsp;against&nbsp;TX:test.&lt;/div&gt;<br>
<br>
&lt;div&gt; Target&nbsp;value:&nbsp;&amp;quot;1&amp;quot;&lt;/div&gt;&lt;div&gt; Rule&nbsp;returned&nbsp;1.&lt;/div&gt;&lt;div&gt; Rule&nbsp;80a588:&nbsp;SecRule&nbsp;&amp;quot;TX:TEST&amp;quot;&nbsp;&amp;quot;!@eq&nbsp;0&amp;quot;&nbsp;&amp;quot;phase:1,pass,nolog,auditlog,t:none,id:2002&amp;quot;&lt;/div&gt;&lt;div&gt; Executing&nbsp;operator&nbsp;&amp;quot;!eq&amp;quot;&nbsp;with&nbsp;param&nbsp;&amp;quot;0&amp;quot;&nbsp;against&nbsp;TX:test.&lt;/div&gt;<br>
<br>
&lt;div&gt; Target&nbsp;value:&nbsp;&amp;quot;1&amp;quot;&lt;/div&gt;&lt;div&gt; Rule&nbsp;returned&nbsp;1.&lt;/div&gt;&lt;div&gt; Rule&nbsp;80ac50:&nbsp;SecRule&nbsp;&amp;quot;TX:TEST&amp;quot;&nbsp;&amp;quot;!@eq&nbsp;1&amp;quot;&nbsp;&amp;quot;phase:1,pass,nolog,auditlog,t:none,id:2003&amp;quot;&lt;/div&gt;&lt;div&gt; Executing&nbsp;operator&nbsp;&amp;quot;!eq&amp;quot;&nbsp;with&nbsp;param&nbsp;&amp;quot;1&amp;quot;&nbsp;against&nbsp;TX:test.&lt;/div&gt;<br>
<br>
&lt;div&gt; Target&nbsp;value:&nbsp;&amp;quot;1&amp;quot;&lt;/div&gt;&lt;div&gt; Rule&nbsp;returned&nbsp;0.&lt;/div&gt;&lt;div&gt; Rule&nbsp;80b318:&nbsp;SecRule&nbsp;&amp;quot;TX:TEST1&amp;quot;&nbsp;&amp;quot;@eq&nbsp;1&amp;quot;&nbsp;&amp;quot;phase:1,pass,nolog,auditlog,t:none,id:2004&amp;quot;&lt;/div&gt;&lt;div&gt; Rule&nbsp;returned&nbsp;0.&lt;/div&gt;<br>
<br>
&lt;div&gt; Rule&nbsp;80dbd0:&nbsp;SecRule&nbsp;&amp;quot;TX:TEST1&amp;quot;&nbsp;&amp;quot;!@eq&nbsp;1&amp;quot;&nbsp;&amp;quot;phase:1,pass,nolog,auditlog,t:none,id:2005&amp;quot;&lt;/div&gt;&lt;div&gt; Rule&nbsp;returned&nbsp;0.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;If&nbsp;i&nbsp;change&nbsp;the&nbsp;Rule&nbsp;to&nbsp;only&nbsp;check&nbsp;if&nbsp;the Variable exists&nbsp;&amp;amp;SESSION:VALID &amp;quot;!@eq&nbsp;1&amp;quot;&nbsp; it&amp;#39;s&nbsp;working.&lt;/div&gt;<br>
<br>
&lt;div&gt; &lt;/div&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;div&gt;Michael&lt;/div&gt;&lt;/font&gt;&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;2011/7/16&nbsp;Ryan&nbsp;Barnett&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:RBarnett@trustwave.com&quot;&nbsp;target=&quot;_blank&quot;&gt;RBarnett@trustwave.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
Agreed&nbsp;-&nbsp;these&nbsp;need&nbsp;to&nbsp;be&nbsp;fixed.&nbsp;We&nbsp;can&nbsp;simplify&nbsp;the&nbsp;IP&nbsp;capturing&nbsp;ones&nbsp;by&nbsp;not&nbsp;using&nbsp;the&nbsp;hashed.&nbsp;We&nbsp;were&nbsp;using&nbsp;hashs&nbsp;initially&nbsp;for&nbsp;the&nbsp;User-Agent&nbsp;field&nbsp;as&nbsp;their&nbsp;length&nbsp;could&nbsp;get&nbsp;pretty&nbsp;long.&nbsp; We&nbsp;would&nbsp;not&nbsp;need&nbsp;that&nbsp;for&nbsp;IP&nbsp;addresses.&lt;br&gt;<br>
<br>
<br>
&lt;br&gt;<br>
I&nbsp;will&nbsp;fix&nbsp;these&nbsp;and&nbsp;push&nbsp;to&nbsp;the&nbsp;CRS&nbsp;SVN&nbsp;repo&nbsp;on&nbsp;Monday.&lt;br&gt;<br>
&lt;br&gt;<br>
Thanks.&lt;br&gt;<br>
Ryan&lt;br&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
On&nbsp;Jul&nbsp;16,&nbsp;2011,&nbsp;at&nbsp;2:24&nbsp;PM,&nbsp;&amp;quot;Michael&nbsp;Haas&amp;quot;&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:michael.haas10@gmail.com&quot;&nbsp;target=&quot;_blank&quot;&gt;michael.haas10@gmail.com&lt;/a&gt;&amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:michael.haas10@gmail.com&quot;&nbsp;target=&quot;_blank&quot;&gt;michael.haas10@gmail.com&lt;/a&gt;&amp;gt;&amp;gt;&nbsp;wrote:&lt;br&gt;<br>
<br>
<br>
&lt;br&gt;<br>
Hi,&lt;br&gt;<br>
&lt;br&gt;<br>
i&nbsp;think&nbsp;the&nbsp;Rule&nbsp;should&nbsp;be&nbsp;changed&nbsp;to&nbsp;something&nbsp;like&nbsp;that&lt;br&gt;<br>
&lt;br&gt;<br>
SecRule&nbsp;TX:IP&nbsp;&amp;quot;^(\d{1,3}\.\d{1,3}\.\d{1,3}\.)&amp;quot;&nbsp; &amp;quot;chain,phase:3,id:&amp;#39;981063&amp;#39;,t:none,nolog,pass&amp;quot;&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; SecRule&nbsp;MATCHED_VARS&nbsp;&amp;quot;(.*)&amp;quot;&nbsp;&amp;quot;capture,t:none,t:sha1,t:hexEncode,nolog,setvar:session.ip=%{tx.1}&amp;quot;&lt;br&gt;<br>
&lt;br&gt;<br>
then&nbsp;it&nbsp;works&nbsp;too.&lt;br&gt;<br>
&lt;br&gt;<br>
Michael&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;2011/7/15&nbsp;Michael&nbsp;Haas&nbsp;&amp;lt;&amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:michael.haas10@gmail.com&quot;&nbsp;target=&quot;_blank&quot;&gt;michael.haas10@gmail.com&lt;/a&gt;&amp;gt;&lt;a&nbsp;href=&quot;mailto:michael.haas10@gmail.com&quot;&nbsp;target=&quot;_blank&quot;&gt;michael.haas10@gmail.com&lt;/a&gt;&amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:michael.haas10@gmail.com&quot;&nbsp;target=&quot;_blank&quot;&gt;michael.haas10@gmail.com&lt;/a&gt;&amp;gt;&amp;gt;&lt;br&gt;<br>
<br>
<br>
Hi,&lt;br&gt;<br>
&lt;br&gt;<br>
Yes&nbsp;i&amp;#39;m&nbsp;using&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/optional_rules/modsecurity_crs_16_session_hijacking.conf&quot;&nbsp;target=&quot;_blank&quot;&gt;http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/optional_rules/modsecurity_crs_16_session_hijacking.conf&lt;/a&gt;&amp;gt;&nbsp;&lt;a&nbsp;href=&quot;http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/optional_rules/modsecurity_crs_16_session_hijacking.conf&quot;&nbsp;target=&quot;_blank&quot;&gt;http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/optional_rules/modsecurity_crs_16_session_hijacking.conf&lt;/a&gt;.&lt;br&gt;<br>
<br>
<br>
&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&gt;if&nbsp;i&nbsp;look&nbsp;at&nbsp;a&nbsp;debug&nbsp;log&nbsp;i&nbsp;see&nbsp;that&nbsp;the&nbsp;session.ip&nbsp;is&nbsp;not&nbsp;saved,&nbsp;i&nbsp;think&nbsp;it&nbsp;doesn&amp;#39;t&nbsp;capture&nbsp;because&nbsp;it&nbsp;doesn&amp;#39;t&nbsp;match.&lt;br&gt;<br>
&lt;br&gt;<br>
Rule&nbsp;822ce0:&nbsp;SecRule&nbsp;&amp;quot;TX:IP&amp;quot;&nbsp;&amp;quot;@rx&nbsp;^(\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.)&amp;quot;&nbsp;&amp;quot;phase:3,auditlog,id:981063,capture,t:none,t:sha1,t:hexEncode,nolog,pass,setvar:session.ip=%{tx.1}&amp;quot;&lt;br&gt;<br>
T&nbsp;(0)&nbsp;sha1:&nbsp;&amp;quot;\xb5O`\x10\x1bj\xed\xdf\x81J\x8f\xfb\x11\x98^K\xfc{t4&amp;quot;&lt;br&gt;<br>
T&nbsp;(0)&nbsp;hexEncode:&nbsp;&amp;quot;b54f60101b6aeddf814a8ffb11985e4bfc7b7434&amp;quot;&lt;br&gt;<br>
Transformation&nbsp;completed&nbsp;in&nbsp;24&nbsp;usec.&lt;br&gt;<br>
Executing&nbsp;operator&nbsp;&amp;quot;rx&amp;quot;&nbsp;with&nbsp;param&nbsp;&amp;quot;^(\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.)&amp;quot;&nbsp;against&nbsp;TX:ip.&lt;br&gt;<br>
Target&nbsp;value:&nbsp;&amp;quot;b54f60101b6aeddf814a8ffb11985e4bfc7b7434&amp;quot;&lt;br&gt;<br>
Operator&nbsp;completed&nbsp;in&nbsp;2&nbsp;usec.&lt;br&gt;<br>
Rule&nbsp;returned&nbsp;0.&lt;br&gt;<br>
No&nbsp;match,&nbsp;not&nbsp;chained&nbsp;-&amp;gt;&nbsp;mode&nbsp;NEXT_RULE.&lt;br&gt;<br>
&lt;br&gt;<br>
If&nbsp;i&nbsp;use&nbsp;this&nbsp;Rule&nbsp;it&nbsp;captures&nbsp;because&nbsp;it&nbsp;matches.&lt;br&gt;<br>
&lt;br&gt;<br>
Rule&nbsp;822cc8:&nbsp;SecRule&nbsp;&amp;quot;TX:IP&amp;quot;&nbsp;&amp;quot;@rx&nbsp;(.*)&amp;quot;&nbsp;&amp;quot;phase:3,auditlog,id:981063,capture,t:none,t:sha1,t:hexEncode,nolog,pass,setvar:session.ip=%{tx.1}&amp;quot;&lt;br&gt;<br>
T&nbsp;(0)&nbsp;sha1:&nbsp;&amp;quot;\xb5O`\x10\x1bj\xed\xdf\x81J\x8f\xfb\x11\x98^K\xfc{t4&amp;quot;&lt;br&gt;<br>
T&nbsp;(0)&nbsp;hexEncode:&nbsp;&amp;quot;b54f60101b6aeddf814a8ffb11985e4bfc7b7434&amp;quot;&lt;br&gt;<br>
Transformation&nbsp;completed&nbsp;in&nbsp;24&nbsp;usec.&lt;br&gt;<br>
Executing&nbsp;operator&nbsp;&amp;quot;rx&amp;quot;&nbsp;with&nbsp;param&nbsp;&amp;quot;(.*)&amp;quot;&nbsp;against&nbsp;TX:ip.&lt;br&gt;<br>
Target&nbsp;value:&nbsp;&amp;quot;b54f60101b6aeddf814a8ffb11985e4bfc7b7434&amp;quot;&lt;br&gt;<br>
Added&nbsp;regex&nbsp;subexpression&nbsp;to&nbsp;TX.0:&nbsp;b54f60101b6aeddf814a8ffb11985e4bfc7b7434&lt;br&gt;<br>
Added&nbsp;regex&nbsp;subexpression&nbsp;to&nbsp;TX.1:&nbsp;b54f60101b6aeddf814a8ffb11985e4bfc7b7434&lt;br&gt;<br>
Operator&nbsp;completed&nbsp;in&nbsp;25&nbsp;usec.&lt;br&gt;<br>
Setting&nbsp;variable:&nbsp;session.ip=%{tx.1}&lt;br&gt;<br>
Resolved&nbsp;macro&nbsp;%{tx.1}&nbsp;to:&nbsp;b54f60101b6aeddf814a8ffb11985e4bfc7b7434&lt;br&gt;<br>
Set&nbsp;variable&nbsp;&amp;quot;session.ip&amp;quot;&nbsp;to&nbsp;&amp;quot;b54f60101b6aeddf814a8ffb11985e4bfc7b7434&amp;quot;.&lt;br&gt;<br>
Warning.&nbsp;Pattern&nbsp;match&nbsp;&amp;quot;(.*)&amp;quot;&nbsp;at&nbsp;TX:ip.&nbsp;[file&nbsp;&amp;quot;/xxx/modsecurity_crs_16_session_hijacking.conf&amp;quot;]&nbsp;[line&nbsp;&amp;quot;46&amp;quot;]&nbsp;[id&nbsp;&amp;quot;981063&amp;quot;]&lt;br&gt;<br>
Rule&nbsp;returned&nbsp;1.&lt;br&gt;<br>
Match&nbsp;-&amp;gt;&nbsp;mode&nbsp;NEXT_RULE.&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;Problem&nbsp;is&nbsp;that&nbsp;the&nbsp;Target&nbsp;Value&nbsp;is&nbsp;already&nbsp;transformed&nbsp;with&nbsp;&amp;quot;t:sha1,t:hexEncode&amp;quot;&lt;br&gt;<br>
&lt;br&gt;<br>
Michael&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;2011/7/15&nbsp;Ryan&nbsp;Barnett&nbsp;&amp;lt;&amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:RBarnett@trustwave.com&quot;&nbsp;target=&quot;_blank&quot;&gt;RBarnett@trustwave.com&lt;/a&gt;&amp;gt;&lt;a&nbsp;href=&quot;mailto:RBarnett@trustwave.com&quot;&nbsp;target=&quot;_blank&quot;&gt;RBarnett@trustwave.com&lt;/a&gt;&amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:RBarnett@trustwave.com&quot;&nbsp;target=&quot;_blank&quot;&gt;RBarnett@trustwave.com&lt;/a&gt;&amp;gt;&amp;gt;&lt;br&gt;<br>
<br>
<br>
&lt;br&gt;<br>
From:&nbsp;Michael&nbsp;Haas&nbsp;&amp;lt;&amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:michael.haas10@gmail.com&quot;&nbsp;target=&quot;_blank&quot;&gt;michael.haas10@gmail.com&lt;/a&gt;&amp;gt;&lt;a&nbsp;href=&quot;mailto:michael.haas10@gmail.com&quot;&nbsp;target=&quot;_blank&quot;&gt;michael.haas10@gmail.com&lt;/a&gt;&amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:michael.haas10@gmail.com&quot;&nbsp;target=&quot;_blank&quot;&gt;michael.haas10@gmail.com&lt;/a&gt;&amp;gt;&amp;lt;mailto:&amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:michael.haas10@gmail.com&quot;&nbsp;target=&quot;_blank&quot;&gt;michael.haas10@gmail.com&lt;/a&gt;&amp;gt;&lt;a&nbsp;href=&quot;mailto:michael.haas10@gmail.com&quot;&nbsp;target=&quot;_blank&quot;&gt;michael.haas10@gmail.com&lt;/a&gt;&amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:michael.haas10@gmail.com&quot;&nbsp;target=&quot;_blank&quot;&gt;michael.haas10@gmail.com&lt;/a&gt;&amp;gt;&amp;gt;&amp;gt;&lt;br&gt;<br>
<br>
<br>
&lt;div&gt;Date:&nbsp;Fri,&nbsp;15&nbsp;Jul&nbsp;2011&nbsp;08:54:49&nbsp;-0500&lt;br&gt;<br>
&lt;/div&gt;To:&nbsp;&amp;quot;&amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:owasp-modsecurity-core-rule-set@lists.owasp.org&quot;&nbsp;target=&quot;_blank&quot;&gt;owasp-modsecurity-core-rule-set@lists.owasp.org&lt;/a&gt;&amp;gt;&lt;a&nbsp;href=&quot;mailto:owasp-modsecurity-core-rule-set@lists.owasp.org&quot;&nbsp;target=&quot;_blank&quot;&gt;owasp-modsecurity-core-rule-set@lists.owasp.org&lt;/a&gt;&amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:owasp-modsecurity-core-rule-set@lists.owasp.org&quot;&nbsp;target=&quot;_blank&quot;&gt;owasp-modsecurity-core-rule-set@lists.owasp.org&lt;/a&gt;&amp;gt;&amp;lt;mailto:&amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:owasp-modsecurity-core-rule-set@lists.owasp.org&quot;&nbsp;target=&quot;_blank&quot;&gt;owasp-modsecurity-core-rule-set@lists.owasp.org&lt;/a&gt;&amp;gt;&lt;a&nbsp;href=&quot;mailto:owasp-modsecurity-core-rule-set@lists.owasp.org&quot;&nbsp;target=&quot;_blank&quot;&gt;owasp-modsecurity-core-rule-set@lists.owasp.org&lt;/a&gt;&amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:owasp-modsecurity-core-rule-set@lists.owasp.org&quot;&nbsp;target=&quot;_blank&quot;&gt;owasp-modsecurity-core-rule-set@lists.owasp.org&lt;/a&gt;&amp;gt;&amp;gt;&amp;quot;&nbsp;&amp;lt;&amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:owasp-modsecurity-core-rule-set@lists.owasp.org&quot;&nbsp;target=&quot;_blank&quot;&gt;owasp-modsecurity-core-rule-set@lists.owasp.org&lt;/a&gt;&amp;gt;&lt;a&nbsp;href=&quot;mailto:owasp-modsecurity-core-rule-set@lists.owasp.org&quot;&nbsp;target=&quot;_blank&quot;&gt;owasp-modsecurity-core-rule-set@lists.owasp.org&lt;/a&gt;&amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:owasp-modsecurity-core-rule-set@lists.owasp.org&quot;&nbsp;target=&quot;_blank&quot;&gt;owasp-modsecurity-core-rule-set@lists.owasp.org&lt;/a&gt;&amp;gt;&amp;lt;mailto:&amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:owasp-modsecurity-core-rule-set@lists.owasp.org&quot;&nbsp;target=&quot;_blank&quot;&gt;owasp-modsecurity-core-rule-set@lists.owasp.org&lt;/a&gt;&amp;gt;&lt;a&nbsp;href=&quot;mailto:owasp-modsecurity-core-rule-set@lists.owasp.org&quot;&nbsp;target=&quot;_blank&quot;&gt;owasp-modsecurity-core-rule-set@lists.owasp.org&lt;/a&gt;&amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:owasp-modsecurity-core-rule-set@lists.owasp.org&quot;&nbsp;target=&quot;_blank&quot;&gt;owasp-modsecurity-core-rule-set@lists.owasp.org&lt;/a&gt;&amp;gt;&amp;gt;&amp;gt;&lt;br&gt;<br>
<br>
<br>
&lt;div&gt;Subject:&nbsp;[Owasp-modsecurity-core-rule-set]&nbsp;Problem&nbsp;with&nbsp;modsecurity_crs_16_session_hijacking.conf&lt;br&gt;<br>
&lt;br&gt;<br>
Hi,&lt;br&gt;<br>
&lt;br&gt;<br>
i&amp;#39;m&nbsp;trying&nbsp;to&nbsp;use&nbsp;the&nbsp;session&nbsp;hijacking&nbsp;protection&nbsp;but&nbsp;have&nbsp;some&nbsp;problems&nbsp;with&nbsp;it.&lt;br&gt;<br>
&lt;br&gt;<br>
Are&nbsp;you&nbsp;using&nbsp;this&nbsp;file?&lt;br&gt;<br>
&lt;/div&gt;&amp;lt;&lt;a&nbsp;href=&quot;http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/optional_rules/modsecurity_crs_16_session_hijacking.conf&quot;&nbsp;target=&quot;_blank&quot;&gt;http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/optional_rules/modsecurity_crs_16_session_hijacking.conf&lt;/a&gt;&amp;gt;&lt;a&nbsp;href=&quot;http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/optional_rules/modsecurity_crs_16_session_hijacking.conf&quot;&nbsp;target=&quot;_blank&quot;&gt;http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/optional_rules/modsecurity_crs_16_session_hijacking.conf&lt;/a&gt;&lt;br&gt;<br>
<br>
<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;Rules&nbsp;981057&nbsp;and&nbsp;981063&nbsp;are&nbsp;never&nbsp;matching&nbsp;because&nbsp;they&nbsp;check&nbsp;a&nbsp;normal&nbsp;IP&nbsp;with&nbsp;a&nbsp;encoded&nbsp;IP&nbsp;(t:sha1,t:hexEncode)&nbsp;so&nbsp;the&nbsp;ip&nbsp;is&nbsp;never&nbsp;saved&nbsp;in&nbsp;the&nbsp;collection.&lt;br&gt;<br>
&lt;br&gt;<br>
You&nbsp;are&nbsp;misunderstanding&nbsp;the&nbsp;logic&nbsp;of&nbsp;these&nbsp;rules.&nbsp; Let&amp;#39;s&nbsp;start&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;file.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
#&lt;br&gt;<br>
#&nbsp;This&nbsp;rule&nbsp;will&nbsp;identify&nbsp;the&nbsp;outbound&nbsp;Set-Cookie&nbsp;SessionID&nbsp;data&nbsp;and&nbsp;capture&nbsp;it&nbsp;in&nbsp;a&nbsp;setsid&lt;br&gt;<br>
#&lt;br&gt;<br>
&lt;/div&gt;SecRule&nbsp;RESPONSE_HEADERS:/Set-Cookie2?/&nbsp;&amp;quot;(?i:(j?sessionid|(php)?sessid|(asp|jserv|jw)?session[-_]?(id)?|cf(id|token)|sid)=([^\s]+)\;\s?)&amp;quot;&nbsp;&amp;quot;chain,phase:3,id:&amp;#39;981062&amp;#39;,t:none,pass,nolog,capture,setsid:%{TX.6},setvar:session.sessionid=%{TX.6},setvar:tx.ip=%{remote_addr},setvar:&amp;lt;&lt;a&nbsp;href=&quot;http://tx.ua&quot;&nbsp;target=&quot;_blank&quot;&gt;http://tx.ua&lt;/a&gt;&amp;gt;&lt;a&nbsp;href=&quot;http://tx.ua&quot;&nbsp;target=&quot;_blank&quot;&gt;tx.ua&lt;/a&gt;&amp;lt;&lt;a&nbsp;href=&quot;http://tx.ua&quot;&nbsp;target=&quot;_blank&quot;&gt;http://tx.ua&lt;/a&gt;&amp;gt;=%{request_headers.user-agent},setvar:session.valid=1&amp;quot;&lt;br&gt;<br>
<br>
<br>
&lt;div&gt;&nbsp; &nbsp; &nbsp; &nbsp;SecRule&nbsp;SESSION:SESSIONID&nbsp;&amp;quot;(.*)&amp;quot;&nbsp;&amp;quot;t:none,t:sha1,t:hexEncode,capture,setvar:session.csrf_token=%{TX.1}&amp;quot;&lt;br&gt;<br>
&lt;br&gt;<br>
SecRule&nbsp;TX:IP&nbsp;&amp;quot;^(\d{1,3}\.\d{1,3}\.\d{1,3}\.)&amp;quot;&nbsp; &amp;quot;phase:3,id:&amp;#39;981063&amp;#39;,capture,t:none,t:sha1,t:hexEncode,nolog,pass,setvar:session.ip=%{tx.1}&amp;quot;&lt;br&gt;<br>
&lt;/div&gt;SecRule&nbsp;TX:UA&nbsp;&amp;quot;(.*)&amp;quot;&nbsp;&amp;quot;phase:3,id:&amp;#39;981064&amp;#39;,capture,t:none,t:sha1,t:hexEncode,nolog,pass,setvar:&amp;lt;&lt;a&nbsp;href=&quot;http://session.ua&quot;&nbsp;target=&quot;_blank&quot;&gt;http://session.ua&lt;/a&gt;&amp;gt;&lt;a&nbsp;href=&quot;http://session.ua&quot;&nbsp;target=&quot;_blank&quot;&gt;session.ua&lt;/a&gt;&amp;lt;&lt;a&nbsp;href=&quot;http://session.ua&quot;&nbsp;target=&quot;_blank&quot;&gt;http://session.ua&lt;/a&gt;&amp;gt;=%{tx.0}&amp;quot;&lt;br&gt;<br>
<br>
<br>
&lt;div&gt;&lt;br&gt;<br>
These&nbsp;rules&nbsp;will&nbsp;identify&nbsp;if/when&nbsp;common&nbsp;SessionIDs&nbsp;are&nbsp;being&nbsp;sent&nbsp;out&nbsp;by&nbsp;the&nbsp;app&nbsp;in&nbsp;Set-Cookie&nbsp;response&nbsp;headers.&nbsp; If&nbsp;these&nbsp;are&nbsp;found,&nbsp;then&nbsp;a&nbsp;few&nbsp;things&nbsp;happen&nbsp;-&lt;br&gt;<br>
&lt;br&gt;<br>
 1.&nbsp; Setsid&nbsp;is&nbsp;used&nbsp;to&nbsp;initialize&nbsp;the&nbsp;Session&nbsp;collection&lt;br&gt;<br>
 2.&nbsp; The&nbsp;SessionID&nbsp;is&nbsp;marked&nbsp;as&nbsp;&amp;quot;valid&amp;quot;&nbsp;so&nbsp;that&nbsp;we&nbsp;can&nbsp;detect&nbsp;then&nbsp;bogus&nbsp;SessionIDs&nbsp;are&nbsp;sent&nbsp;(perhaps&nbsp;by&nbsp;brute&nbsp;force&nbsp;tools)&lt;br&gt;<br>
 3.&nbsp; We&nbsp;then&nbsp;capture&nbsp;a&nbsp;hash&nbsp;of&nbsp;the&nbsp;network&nbsp;block&nbsp;of&nbsp;the&nbsp;client&nbsp;IP&nbsp;(first&nbsp;3&nbsp;octets).&nbsp; We&nbsp;don&amp;#39;t&nbsp;use&nbsp;full&nbsp;IP&nbsp;address&nbsp;as&nbsp;there&nbsp;a&nbsp;too&nbsp;many&nbsp;false&nbsp;positives&nbsp;where&nbsp;an&nbsp;IP&nbsp;will&nbsp;change,&nbsp;however&nbsp;the&nbsp;network&nbsp;block&nbsp;should&nbsp;not.&lt;br&gt;<br>
<br>
<br>
 4.&nbsp; We&nbsp;then&nbsp;also&nbsp;capture&nbsp;a&nbsp;hash&nbsp;of&nbsp;the&nbsp;User-Agent&nbsp;string.&lt;br&gt;<br>
&lt;br&gt;<br>
Now&nbsp;that&nbsp;we&nbsp;have&nbsp;saved&nbsp;this&nbsp;data&nbsp;when&nbsp;the&nbsp;app&nbsp;sent&nbsp;out&nbsp;the&nbsp;Set-Cookie,&nbsp;we&nbsp;can&nbsp;now&nbsp;perform&nbsp;validation&nbsp;on&nbsp;subsequent&nbsp;requests.&nbsp; If&nbsp;a&nbsp;client&nbsp;sends&nbsp;a&nbsp;SessionID&nbsp;cookie&nbsp;value,&nbsp;we&nbsp;can&nbsp;check&nbsp;the&nbsp;data&nbsp;we&nbsp;have&nbsp;saved.&nbsp; Now&nbsp;onto&nbsp;the&nbsp;rules&nbsp;at&nbsp;the&nbsp;top&nbsp;of&nbsp;the&nbsp;rules&nbsp;file&nbsp;-&lt;br&gt;<br>
<br>
<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
#&lt;br&gt;<br>
#&nbsp;This&nbsp;rule&nbsp;set&nbsp;will&nbsp;identify&nbsp;subsequent&nbsp;SessionIDs&nbsp;being&nbsp;submitted&nbsp;by&nbsp;clients&nbsp;in&lt;br&gt;<br>
#&nbsp;Request&nbsp;Headers.&nbsp; First&nbsp;we&nbsp;check&nbsp;that&nbsp;the&nbsp;SessionID&nbsp;submitted&nbsp;is&nbsp;a&nbsp;valid&nbsp;one&lt;br&gt;<br>
#&lt;br&gt;<br>
SecMarker&nbsp;BEGIN_SESSION_STARTUP&lt;br&gt;<br>
&lt;br&gt;<br>
SecRule&nbsp;REQUEST_COOKIES:&amp;#39;/(j?sessionid|(php)?sessid|(asp|jserv|jw)?session[-_]?(id)?|cf(id|token)|sid)/&amp;#39;&nbsp;&amp;quot;.*&amp;quot;&nbsp;&amp;quot;chain,phase:1,id:&amp;#39;981054&amp;#39;,t:none,block,log,msg:&amp;#39;Invalid&nbsp;SessionID&nbsp;Submitted.&amp;#39;,setsid:%{matched_var},setvar:tx.sessionid=%{matched_var},skipAfter:END_SESSION_STARTUP&amp;quot;&lt;br&gt;<br>
<br>
<br>
&lt;/div&gt;&nbsp; &nbsp; &nbsp; &nbsp;SecRule&nbsp;SESSION:VALID&nbsp;&amp;quot;!@eq&nbsp;1&amp;quot;&nbsp;&amp;quot;t:none,setvar:tx.anomaly_score=+%{tx.critical_anomaly_score},setvar:tx.%{&lt;a&nbsp;href=&quot;http://rule.id&quot;&nbsp;target=&quot;_blank&quot;&gt;rule.id&lt;/a&gt;&amp;lt;&lt;a&nbsp;href=&quot;http://rule.id&quot;&nbsp;target=&quot;_blank&quot;&gt;http://rule.id&lt;/a&gt;&amp;gt;}-WEB_ATTACK/INVALID_SESSIONID-%{matched_var_name}=%{tx.0}&amp;quot;&lt;br&gt;<br>
<br>
<br>
&lt;div&gt;&lt;br&gt;<br>
SecRule&nbsp;&amp;amp;REQUEST_COOKIES:&amp;#39;/(j?sessionid|(php)?sessid|(asp|jserv|jw)?session[-_]?(id)?|cf(id|token)|sid)/&amp;#39;&nbsp;&amp;quot;@eq&nbsp;0&amp;quot;&nbsp;&amp;quot;phase:1,id:&amp;#39;981055&amp;#39;,t:none,nolog,pass,skipAfter:END_SESSION_STARTUP&amp;quot;&lt;br&gt;<br>
<br>
<br>
&lt;br&gt;<br>
The&nbsp;first&nbsp;rule&nbsp;checks&nbsp;to&nbsp;see&nbsp;if&nbsp;the&nbsp;client&nbsp;is&nbsp;submitting&nbsp;a&nbsp;SessionID&nbsp;from&nbsp;the&nbsp;named&nbsp;list.&nbsp; If&nbsp;so,&nbsp;then&nbsp;we&nbsp;check&nbsp;the&nbsp;saved&nbsp;SessionID&nbsp;collection&nbsp;in&nbsp;ModSecurity&nbsp;to&nbsp;see&nbsp;if&nbsp;the&nbsp;&amp;quot;valid&amp;quot;&nbsp;variable&nbsp;exists.&nbsp; If&nbsp;not,&nbsp;then&nbsp;it&nbsp;means&nbsp;that&nbsp;we&nbsp;did&nbsp;not&nbsp;see&nbsp;the&nbsp;application&nbsp;hand&nbsp;out&nbsp;this&nbsp;SessionID&nbsp;and&nbsp;thus&nbsp;we&nbsp;can&nbsp;flag&nbsp;is&nbsp;as&nbsp;bogus.&lt;br&gt;<br>
<br>
<br>
&lt;br&gt;<br>
The&nbsp;last&nbsp;SecRule&nbsp;checks&nbsp;to&nbsp;see&nbsp;if&nbsp;there&nbsp;are&nbsp;no&nbsp;SessionID&nbsp;cookies&nbsp;at&nbsp;all.&nbsp; If&nbsp;the&nbsp;client&nbsp;didn&amp;#39;t&nbsp;send&nbsp;one,&nbsp;then&nbsp;we&nbsp;can&nbsp;skip&nbsp;the&nbsp;other&nbsp;checks.&nbsp; Sidenote&nbsp;&nbsp;from&nbsp;an&nbsp;optimization&nbsp;perspective,&nbsp;I&nbsp;guess&nbsp;we&nbsp;could&nbsp;switch&nbsp;these&nbsp;two&nbsp;rules&nbsp;around.&lt;br&gt;<br>
<br>
<br>
&lt;br&gt;<br>
Then&nbsp;we&nbsp;get&nbsp;to&nbsp;the&nbsp;set&nbsp;of&nbsp;rules&nbsp;you&nbsp;mentioned&nbsp;-&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;SecAction&nbsp;&amp;quot;phase:1,id:&amp;#39;981056&amp;#39;,t:none,nolog,pass,setuid:%{session.username},setvar:session.sessionid=%{tx.sessionid},setvar:tx.ip=%{remote_addr},setvar:&amp;lt;&lt;a&nbsp;href=&quot;http://tx.ua&quot;&nbsp;target=&quot;_blank&quot;&gt;http://tx.ua&lt;/a&gt;&amp;gt;&lt;a&nbsp;href=&quot;http://tx.ua&quot;&nbsp;target=&quot;_blank&quot;&gt;tx.ua&lt;/a&gt;&amp;lt;&lt;a&nbsp;href=&quot;http://tx.ua&quot;&nbsp;target=&quot;_blank&quot;&gt;http://tx.ua&lt;/a&gt;&amp;gt;=%{request_headers.user-agent}&amp;quot;&lt;br&gt;<br>
<br>
<br>
&lt;div&gt;&lt;br&gt;<br>
SecRule&nbsp;TX:IP&nbsp;&amp;quot;^(\d{1,3}\.\d{1,3}\.\d{1,3}\.)&amp;quot;&nbsp;&amp;quot;phase:1,id:&amp;#39;981057&amp;#39;,capture,t:none,t:sha1,t:hexEncode,nolog,pass,setvar:tx.ip_hash=%{tx.0}&amp;quot;&lt;br&gt;<br>
SecRule&nbsp;TX:UA&nbsp;&amp;quot;(.*)&amp;quot;&nbsp;&amp;quot;phase:1,id:&amp;#39;981058&amp;#39;,capture,t:none,t:sha1,t:hexEncode,nolog,pass,setvar:tx.ua_hash=%{tx.0}&amp;quot;&lt;br&gt;<br>
&lt;br&gt;<br>
These&nbsp;rules&nbsp;are&nbsp;meant&nbsp;to&nbsp;capture&nbsp;the&nbsp;hash&nbsp;of&nbsp;the&nbsp;same&nbsp;data&nbsp;mentioned&nbsp;above&nbsp;but&nbsp;for&nbsp;the&nbsp;CURRENT&nbsp;transaction.&nbsp; Once&nbsp;we&nbsp;have&nbsp;these&nbsp;hashes&nbsp;capture&nbsp;in&nbsp;TX&nbsp;variables,&nbsp;we&nbsp;can&nbsp;then&nbsp;compare&nbsp;them&nbsp;to&nbsp;the&nbsp;data&nbsp;we&nbsp;originally&nbsp;saved&nbsp;in&nbsp;the&nbsp;Session&nbsp;collection&nbsp;when&nbsp;the&nbsp;Set-Cookie&nbsp;was&nbsp;issued&nbsp;-&lt;br&gt;<br>
<br>
<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;SecRule&nbsp;TX:IP_HASH&nbsp;&amp;quot;!@streq&nbsp;%{SESSION.IP}&amp;quot;&nbsp;&amp;quot;phase:1,id:&amp;#39;981059&amp;#39;,t:none,block,setvar:tx.sticky_session_anomaly=+1,msg:&amp;#39;Warning&nbsp;-&nbsp;Sticky&nbsp;SessionID&nbsp;Data&nbsp;Changed&nbsp;-&nbsp;IP&nbsp;Address&nbsp;Mismatch.&amp;#39;,setvar:&amp;#39;tx.msg=%{rule.msg}&amp;#39;,setvar:tx.anomaly_score=+%{tx.notice_anomaly_score},setvar:tx.%{&lt;a&nbsp;href=&quot;http://rule.id&quot;&nbsp;target=&quot;_blank&quot;&gt;rule.id&lt;/a&gt;&amp;lt;&lt;a&nbsp;href=&quot;http://rule.id&quot;&nbsp;target=&quot;_blank&quot;&gt;http://rule.id&lt;/a&gt;&amp;gt;}-WEB_ATTACK/SESSION_HIJACK-%{matched_var_name}=%{tx.0}&amp;quot;&lt;br&gt;<br>
<br>
<br>
SecRule&nbsp;TX:UA_HASH&nbsp;&amp;quot;!@streq&nbsp;%{&lt;a&nbsp;href=&quot;http://SESSION.UA&quot;&nbsp;target=&quot;_blank&quot;&gt;SESSION.UA&lt;/a&gt;&amp;lt;&lt;a&nbsp;href=&quot;http://SESSION.UA&quot;&nbsp;target=&quot;_blank&quot;&gt;http://SESSION.UA&lt;/a&gt;&amp;gt;}&amp;quot;&nbsp;&amp;quot;phase:1,id:&amp;#39;981060&amp;#39;,t:none,block,setvar:tx.sticky_session_anomaly=+1,msg:&amp;#39;Warning&nbsp;-&nbsp;Sticky&nbsp;SessionID&nbsp;Data&nbsp;Changed&nbsp;-&nbsp;User-Agent&nbsp;Mismatch.&amp;#39;,setvar:&amp;#39;tx.msg=%{rule.msg}&amp;#39;,setvar:tx.anomaly_score=+%{tx.notice_anomaly_score},setvar:tx.%{&lt;a&nbsp;href=&quot;http://rule.id&quot;&nbsp;target=&quot;_blank&quot;&gt;rule.id&lt;/a&gt;&amp;lt;&lt;a&nbsp;href=&quot;http://rule.id&quot;&nbsp;target=&quot;_blank&quot;&gt;http://rule.id&lt;/a&gt;&amp;gt;}-WEB_ATTACK/SESSION_HIJACK-%{matched_var_name}=%{tx.0}&amp;quot;&lt;br&gt;<br>
<br>
<br>
SecRule&nbsp;TX:STICKY_SESSION_ANOMALY&nbsp;&amp;quot;@eq&nbsp;2&amp;quot;&nbsp;&amp;quot;phase:1,id:&amp;#39;981061&amp;#39;,t:none,block,msg:&amp;#39;Possible&nbsp;Session&nbsp;Hijacking&nbsp;-&nbsp;IP&nbsp;Address&nbsp;and&nbsp;User-Agent&nbsp;Mismatch.&amp;#39;,setvar:&amp;#39;tx.msg=%{rule.msg}&amp;#39;,setvar:tx.anomaly_score=+%{tx.critical_anomaly_score},setvar:tx.%{&lt;a&nbsp;href=&quot;http://rule.id&quot;&nbsp;target=&quot;_blank&quot;&gt;rule.id&lt;/a&gt;&amp;lt;&lt;a&nbsp;href=&quot;http://rule.id&quot;&nbsp;target=&quot;_blank&quot;&gt;http://rule.id&lt;/a&gt;&amp;gt;}-WEB_ATTACK/SESSION_HIJACK-%{matched_var_name}=%{tx.0}&amp;quot;&lt;br&gt;<br>
<br>
<br>
&lt;div&gt;&lt;br&gt;<br>
These&nbsp;rules&nbsp;are&nbsp;simply&nbsp;check&nbsp;the&nbsp;current&nbsp;hashes&nbsp;with&nbsp;the&nbsp;saved&nbsp;hashes&nbsp;and&nbsp;they&nbsp;then&nbsp;increase&nbsp;an&nbsp;anomaly&nbsp;score.&lt;br&gt;<br>
&lt;br&gt;<br>
Hopefully&nbsp;this&nbsp;description&nbsp;helps&nbsp;to&nbsp;explain&nbsp;the&nbsp;logic&nbsp;of&nbsp;the&nbsp;Session&nbsp;Hijacking&nbsp;rules.&lt;br&gt;<br>
&lt;br&gt;<br>
-Ryan&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;changed&nbsp;&amp;quot;^(\d{1,3}\.\d{1,3}\.\d{1,3}\.)&amp;quot;&nbsp;to&nbsp;&amp;quot;(.*)&amp;quot;&nbsp;after&nbsp;that&nbsp;the&nbsp;Rules&nbsp;are&nbsp;working.&lt;br&gt;<br>
Is&nbsp;this&nbsp;the&nbsp;right&nbsp;approach&nbsp;to&nbsp;fix&nbsp;this&nbsp;or&nbsp;should&nbsp;this&nbsp;be&nbsp;fixed&nbsp;in&nbsp;another&nbsp;way?&lt;br&gt;<br>
&lt;br&gt;<br>
Thanks&nbsp;in&nbsp;Advance&lt;br&gt;<br>
Michael&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
________________________________&lt;br&gt;<br>
This&nbsp;transmission&nbsp;may&nbsp;contain&nbsp;information&nbsp;that&nbsp;is&nbsp;privileged,&nbsp;confidential,&nbsp;and/or&nbsp;exempt&nbsp;from&nbsp;disclosure&nbsp;under&nbsp;applicable&nbsp;law.&nbsp;If&nbsp;you&nbsp;are&nbsp;not&nbsp;the&nbsp;intended&nbsp;recipient,&nbsp;you&nbsp;are&nbsp;hereby&nbsp;notified&nbsp;that&nbsp;any&nbsp;disclosure,&nbsp;copying,&nbsp;distribution,&nbsp;or&nbsp;use&nbsp;of&nbsp;the&nbsp;information&nbsp;contained&nbsp;herein&nbsp;(including&nbsp;any&nbsp;reliance&nbsp;thereon)&nbsp;is&nbsp;STRICTLY&nbsp;PROHIBITED.&nbsp;If&nbsp;you&nbsp;received&nbsp;this&nbsp;transmission&nbsp;in&nbsp;error,&nbsp;please&nbsp;immediately&nbsp;contact&nbsp;the&nbsp;sender&nbsp;and&nbsp;destroy&nbsp;the&nbsp;material&nbsp;in&nbsp;its&nbsp;entirety,&nbsp;whether&nbsp;in&nbsp;electronic&nbsp;or&nbsp;hard&nbsp;copy&nbsp;format.&lt;br&gt;<br>
<br>
<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;_______________________________________________&lt;br&gt;<br>
Owasp-modsecurity-core-rule-set&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:Owasp-modsecurity-core-rule-set@lists.owasp.org&quot;&nbsp;target=&quot;_blank&quot;&gt;Owasp-modsecurity-core-rule-set@lists.owasp.org&lt;/a&gt;&amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:Owasp-modsecurity-core-rule-set@lists.owasp.org&quot;&nbsp;target=&quot;_blank&quot;&gt;Owasp-modsecurity-core-rule-set@lists.owasp.org&lt;/a&gt;&amp;gt;&lt;br&gt;<br>
<br>
<br>
&lt;a&nbsp;href=&quot;https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set&quot;&nbsp;target=&quot;_blank&quot;&gt;https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set&lt;/a&gt;&lt;br&gt;<br>
&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;<br>
________________________________&lt;br&gt;<br>
This&nbsp;transmission&nbsp;may&nbsp;contain&nbsp;information&nbsp;that&nbsp;is&nbsp;privileged,&nbsp;confidential,&nbsp;and/or&nbsp;exempt&nbsp;from&nbsp;disclosure&nbsp;under&nbsp;applicable&nbsp;law.&nbsp;If&nbsp;you&nbsp;are&nbsp;not&nbsp;the&nbsp;intended&nbsp;recipient,&nbsp;you&nbsp;are&nbsp;hereby&nbsp;notified&nbsp;that&nbsp;any&nbsp;disclosure,&nbsp;copying,&nbsp;distribution,&nbsp;or&nbsp;use&nbsp;of&nbsp;the&nbsp;information&nbsp;contained&nbsp;herein&nbsp;(including&nbsp;any&nbsp;reliance&nbsp;thereon)&nbsp;is&nbsp;STRICTLY&nbsp;PROHIBITED.&nbsp;If&nbsp;you&nbsp;received&nbsp;this&nbsp;transmission&nbsp;in&nbsp;error,&nbsp;please&nbsp;immediately&nbsp;contact&nbsp;the&nbsp;sender&nbsp;and&nbsp;destroy&nbsp;the&nbsp;material&nbsp;in&nbsp;its&nbsp;entirety,&nbsp;whether&nbsp;in&nbsp;electronic&nbsp;or&nbsp;hard&nbsp;copy&nbsp;format.&lt;br&gt;<br>
<br>
<br>
&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
