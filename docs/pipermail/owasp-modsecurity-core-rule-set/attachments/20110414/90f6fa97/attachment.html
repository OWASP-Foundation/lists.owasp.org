<tt>
Hi&nbsp;Ryan,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;installed&nbsp;WireShark&nbsp;and&nbsp;started&nbsp;sniffing&nbsp;on&nbsp;all&nbsp;traffic.&nbsp; It&nbsp;seems&nbsp;that&nbsp;Apache&nbsp;is&nbsp;returning&nbsp;a&nbsp;200&nbsp;status&nbsp;code&nbsp;instead&nbsp;of&nbsp;a&nbsp;408&nbsp;when&nbsp;the&nbsp;request&nbsp;reaches&nbsp;30&nbsp;seconds,&nbsp;so&nbsp;from&nbsp;what&nbsp;I&nbsp;understand&nbsp;ModSecurity&nbsp;can&amp;#39;t&nbsp;do&nbsp;much&nbsp;about&nbsp;that.&nbsp; The&nbsp;funny&nbsp;thing&nbsp;is,&nbsp;if&nbsp;we&nbsp;follow&nbsp;one&nbsp;of&nbsp;the&nbsp;TCP&nbsp;streams,&nbsp;we&nbsp;see&nbsp;that&nbsp;http_dos_cli&nbsp;keeps&nbsp;sending&nbsp;data&nbsp;even&nbsp;after&nbsp;receiving&nbsp;the&nbsp;200&nbsp;code.&nbsp; Maybe&nbsp;something&nbsp;to&nbsp;do&nbsp;with&nbsp; keep-alive&nbsp;connections?&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Cheers,&lt;/div&gt;&lt;div&gt;GB&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Thu,&nbsp;Apr&nbsp;14,&nbsp;2011&nbsp;at&nbsp;2:12&nbsp;PM,&nbsp;Ryan&nbsp;Barnett&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:RBarnett@trustwave.com&quot;&gt;RBarnett@trustwave.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;OK,&nbsp;if&nbsp;mod_reqtimeout&nbsp;is&nbsp;installed&nbsp;and&nbsp;that&nbsp;directive&nbsp;is&nbsp;working,&nbsp;then&nbsp;after&nbsp;30&nbsp;sec&nbsp;if&nbsp;Apache&nbsp;has&nbsp;not&nbsp;received&nbsp;the&nbsp;entire&nbsp;request&nbsp;body&nbsp;then&nbsp;it&nbsp;should&nbsp;terminate&nbsp;the&nbsp;request&nbsp;with&nbsp;a&nbsp;408&nbsp;status&nbsp;code.&nbsp; The&nbsp;ModSecurity&nbsp;CRS&nbsp;rules&nbsp;are&nbsp;simply&nbsp;monitoring&nbsp;if/how&nbsp;many&nbsp;408&nbsp;alerts&nbsp;are&nbsp;generated&nbsp;by&nbsp;Apache&nbsp;per&nbsp;client.&nbsp; After&nbsp;a&nbsp;certain&nbsp;amount,&nbsp;then&nbsp;ModSecurity&nbsp;will&nbsp;step&nbsp;in&nbsp;on&nbsp;subsequent&nbsp;requests&nbsp;in&nbsp;phase:1&nbsp;and&nbsp;do&nbsp;drop&nbsp;actions.&lt;br&gt;<br>
<br>
&lt;br&gt;<br>
So,&nbsp;by&nbsp;monitoring&nbsp;your&nbsp;Apache&nbsp;error&nbsp;log&nbsp;while&nbsp;you&nbsp;are&nbsp;running&nbsp;your&nbsp;http_dos_cli&nbsp;tool,&nbsp;does&nbsp;Apache&nbsp;generate&nbsp;408&nbsp;alerts&nbsp;after&nbsp;30&nbsp;secs?&nbsp; If&nbsp;not,&nbsp;then&nbsp;I&nbsp;don&amp;#39;t&nbsp;think&nbsp;that&nbsp;the&nbsp;mod_reqtimeout&nbsp;module&nbsp;or&nbsp;directive&nbsp;is&nbsp;working.&lt;br&gt;<br>
<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
-Ryan&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
From:&nbsp;Guillaume&nbsp;Bilodeau&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:guillaume.bilodeau@gmail.com&quot;&gt;guillaume.bilodeau@gmail.com&lt;/a&gt;&amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:guillaume.bilodeau@gmail.com&quot;&gt;guillaume.bilodeau@gmail.com&lt;/a&gt;&amp;gt;&amp;gt;&lt;br&gt;<br>
&lt;/div&gt;Date:&nbsp;Thu,&nbsp;14&nbsp;Apr&nbsp;2011&nbsp;13:07:41&nbsp;-0500&lt;br&gt;<br>
To:&nbsp;Ryan&nbsp;Barnett&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:rbarnett@trustwave.com&quot;&gt;rbarnett@trustwave.com&lt;/a&gt;&amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:rbarnett@trustwave.com&quot;&gt;rbarnett@trustwave.com&lt;/a&gt;&amp;gt;&amp;gt;&lt;br&gt;<br>
Cc:&nbsp;&amp;quot;&lt;a&nbsp;href=&quot;mailto:owasp-modsecurity-core-rule-set@lists.owasp.org&quot;&gt;owasp-modsecurity-core-rule-set@lists.owasp.org&lt;/a&gt;&amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:owasp-modsecurity-core-rule-set@lists.owasp.org&quot;&gt;owasp-modsecurity-core-rule-set@lists.owasp.org&lt;/a&gt;&amp;gt;&amp;quot;&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:owasp-modsecurity-core-rule-set@lists.owasp.org&quot;&gt;owasp-modsecurity-core-rule-set@lists.owasp.org&lt;/a&gt;&amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:owasp-modsecurity-core-rule-set@lists.owasp.org&quot;&gt;owasp-modsecurity-core-rule-set@lists.owasp.org&lt;/a&gt;&amp;gt;&amp;gt;&lt;br&gt;<br>
<br>
Subject:&nbsp;Re:&nbsp;[Owasp-modsecurity-core-rule-set]&nbsp;Slow&nbsp;HTTP&nbsp;DOS&nbsp;protection&nbsp;not&nbsp;behaving&nbsp;as&nbsp;expected&lt;br&gt;<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;<br>
Hi&nbsp;Ryan,&lt;br&gt;<br>
&lt;br&gt;<br>
I&amp;#39;m&nbsp;no&nbsp;Apache&nbsp;expert,&nbsp;but&nbsp;AFAICT&nbsp;the&nbsp;req_timeout&nbsp;module&nbsp;is&nbsp;installed.&nbsp; A&nbsp;/server-info&nbsp;shows&nbsp;the&nbsp;req_timeout.c&nbsp;module&nbsp;with&nbsp;the&nbsp;RequestReadTimeout&nbsp;parameter.&lt;br&gt;<br>
&lt;br&gt;<br>
Thanks,&lt;br&gt;<br>
GB&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;&lt;div&nbsp;class=&quot;im&quot;&gt;On&nbsp;Thu,&nbsp;Apr&nbsp;14,&nbsp;2011&nbsp;at&nbsp;1:56&nbsp;PM,&nbsp;Ryan&nbsp;Barnett&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:RBarnett@trustwave.com&quot;&gt;RBarnett@trustwave.com&lt;/a&gt;&amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:RBarnett@trustwave.com&quot;&gt;RBarnett@trustwave.com&lt;/a&gt;&amp;gt;&amp;gt;&nbsp;wrote:&lt;br&gt;<br>
<br>
Did&nbsp;you&nbsp;install&nbsp;the&nbsp;reqtimeout&nbsp;module?&lt;br&gt;<br>
&lt;br&gt;<br>
#&lt;br&gt;<br>
#&nbsp;Mitigate&nbsp;Slow&nbsp;HTTP&nbsp;POST&nbsp;attacks&lt;br&gt;<br>
#&lt;br&gt;<br>
#&nbsp;Must&nbsp;have&nbsp;the&nbsp;mod_reqtimeout&nbsp;module&nbsp;installed&lt;br&gt;<br>
#&nbsp;You&nbsp;should&nbsp;adjust&nbsp;the&nbsp;RequestReadTimeout&nbsp;body&nbsp;directive&nbsp;setting&nbsp;to&nbsp;a&nbsp;limit&lt;br&gt;<br>
#&nbsp;that&nbsp;will&nbsp;allow&nbsp;any&nbsp;legitimate&nbsp;slow&nbsp;clients&nbsp;or&nbsp;large&nbsp;file&nbsp;uplaods.&lt;br&gt;<br>
#&lt;br&gt;<br>
&amp;lt;IfModule&nbsp;reqtimeout_module&amp;gt;&lt;br&gt;<br>
RequestReadTimeout&nbsp;body=30&lt;br&gt;<br>
&amp;lt;/IfModule&amp;gt;&lt;br&gt;<br>
&lt;br&gt;<br>
-Ryan&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;From:&nbsp;Guillaume&nbsp;Bilodeau&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:guillaume.bilodeau@gmail.com&quot;&gt;guillaume.bilodeau@gmail.com&lt;/a&gt;&amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:guillaume.bilodeau@gmail.com&quot;&gt;guillaume.bilodeau@gmail.com&lt;/a&gt;&amp;gt;&amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:guillaume.bilodeau@gmail.com&quot;&gt;guillaume.bilodeau@gmail.com&lt;/a&gt;&amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:guillaume.bilodeau@gmail.com&quot;&gt;guillaume.bilodeau@gmail.com&lt;/a&gt;&amp;gt;&amp;gt;&amp;gt;&lt;br&gt;<br>
<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;Date:&nbsp;Thu,&nbsp;14&nbsp;Apr&nbsp;2011&nbsp;12:33:52&nbsp;-0500&lt;br&gt;<br>
&lt;/div&gt;To:&nbsp;&amp;quot;&lt;a&nbsp;href=&quot;mailto:owasp-modsecurity-core-rule-set@lists.owasp.org&quot;&gt;owasp-modsecurity-core-rule-set@lists.owasp.org&lt;/a&gt;&amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:owasp-modsecurity-core-rule-set@lists.owasp.org&quot;&gt;owasp-modsecurity-core-rule-set@lists.owasp.org&lt;/a&gt;&amp;gt;&amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:owasp-modsecurity-core-rule-set@lists.owasp.org&quot;&gt;owasp-modsecurity-core-rule-set@lists.owasp.org&lt;/a&gt;&amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:owasp-modsecurity-core-rule-set@lists.owasp.org&quot;&gt;owasp-modsecurity-core-rule-set@lists.owasp.org&lt;/a&gt;&amp;gt;&amp;gt;&amp;quot;&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:owasp-modsecurity-core-rule-set@lists.owasp.org&quot;&gt;owasp-modsecurity-core-rule-set@lists.owasp.org&lt;/a&gt;&amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:owasp-modsecurity-core-rule-set@lists.owasp.org&quot;&gt;owasp-modsecurity-core-rule-set@lists.owasp.org&lt;/a&gt;&amp;gt;&amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:owasp-modsecurity-core-rule-set@lists.owasp.org&quot;&gt;owasp-modsecurity-core-rule-set@lists.owasp.org&lt;/a&gt;&amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:owasp-modsecurity-core-rule-set@lists.owasp.org&quot;&gt;owasp-modsecurity-core-rule-set@lists.owasp.org&lt;/a&gt;&amp;gt;&amp;gt;&amp;gt;&lt;br&gt;<br>
<br>
&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;Subject:&nbsp;[Owasp-modsecurity-core-rule-set]&nbsp;Slow&nbsp;HTTP&nbsp;DOS&nbsp;protection&nbsp;not&nbsp;behaving&nbsp;as&nbsp;expected&lt;br&gt;<br>
&lt;br&gt;<br>
Hi&nbsp;all,&lt;br&gt;<br>
&lt;br&gt;<br>
We&nbsp;are&nbsp;trying&nbsp;to&nbsp;setup&nbsp;the&nbsp;OWASP&nbsp;Core&nbsp;Rule&nbsp;Set&nbsp;to&nbsp;protect&nbsp;our&nbsp;application&nbsp;from&nbsp;Slow&nbsp;HTTP&nbsp;DOS&nbsp;attacks.&lt;br&gt;<br>
&lt;br&gt;<br>
We&nbsp;have&nbsp;setup&nbsp;ModSecurity&nbsp;2.5.13&nbsp;on&nbsp;our&nbsp;Apache&nbsp;2.2.17&nbsp;instance,&nbsp;loaded&nbsp;the&nbsp;module,&nbsp;and&nbsp;included&nbsp;all&nbsp;CRS&nbsp;base&nbsp;rules&nbsp;plus&nbsp;modsecurity_crs_11_slow_dos_protection.conf.&nbsp; We&nbsp;didn&amp;#39;t&nbsp;change&nbsp;the&nbsp;settings&nbsp;defined&nbsp;in&nbsp;the&nbsp;conf&nbsp;file,&nbsp;so&nbsp;SecReadStateLimit&nbsp;is&nbsp;set&nbsp;to&nbsp;5&nbsp;and&nbsp;RequestReadTimeout&nbsp;is&nbsp;set&nbsp;to&nbsp;body=30.&nbsp; We&nbsp;are&nbsp;using&nbsp;the&nbsp;http_dos_cli&nbsp;command&nbsp;line&nbsp;tool&nbsp;to&nbsp;do&nbsp;our&nbsp;tests,&nbsp;with&nbsp;the&nbsp;connection&nbsp;parameter&nbsp;set&nbsp;to&nbsp;500.&lt;br&gt;<br>
<br>
&lt;br&gt;<br>
When&nbsp;running&nbsp;the&nbsp;slow-headers&nbsp;test,&nbsp;ModSecurity&nbsp;seems&nbsp;to&nbsp;be&nbsp;protecting&nbsp;the&nbsp;application&nbsp;correctly,&nbsp;dropping&nbsp;most&nbsp;(all?)&nbsp;requests&nbsp;from&nbsp;the&nbsp;tester&amp;#39;s&nbsp;IP&nbsp;and&nbsp;allowing&nbsp;requests&nbsp;from&nbsp;a&nbsp;different&nbsp;IP&nbsp;to&nbsp;be&nbsp;served.&nbsp; However,&nbsp;when&nbsp;running&nbsp;the&nbsp;slow-post&nbsp;test,&nbsp;ModSecurity&nbsp;doesn&amp;#39;t&nbsp;seem&nbsp;to&nbsp;be&nbsp;doing&nbsp;anything.&nbsp; From&nbsp;what&nbsp;I&nbsp;understand,&nbsp;the&nbsp;test&nbsp;successfully&nbsp;creates&nbsp;the&nbsp;500&nbsp;connections&nbsp;and&nbsp;keeps&nbsp;them&nbsp;open;&nbsp;none&nbsp;of&nbsp;them&nbsp;are&nbsp;dropped.&nbsp; Requests&nbsp;coming&nbsp;from&nbsp;a&nbsp;different&nbsp;IP&nbsp;are&nbsp;not&nbsp;served&nbsp;and&nbsp;eventually&nbsp;time&nbsp;out.&nbsp; A&nbsp;tail&nbsp;-f&nbsp;error_log&nbsp;shows&nbsp;nothing&nbsp;except&nbsp;the&nbsp;eventual&nbsp;message&nbsp;on&nbsp;MaxClients&nbsp;(set&nbsp;to&nbsp;300&nbsp;now)&nbsp;being&nbsp;reached.&nbsp; Interestingly,&nbsp;when&nbsp;we&nbsp;kill&nbsp;the&nbsp;http_dos_cli&nbsp;process,&nbsp;the&nbsp;error_log&nbsp;is&nbsp;then&nbsp;flooded&nbsp;with&nbsp;hundreds&nbsp;of&nbsp;entries&nbsp;such&nbsp;as&nbsp;this:&lt;br&gt;<br>
<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
[Mon&nbsp;Nov&nbsp;22&nbsp;17:44:46&nbsp;2010]&nbsp;[warn]&nbsp;ModSecurity:&nbsp;Access&nbsp;denied&nbsp;with&nbsp;code&nbsp;400.&lt;br&gt;<br>
Too&nbsp;many&nbsp;connections&nbsp;[6]&nbsp;of&nbsp;5&nbsp;allowed&nbsp;in&nbsp;READ&nbsp;state&nbsp;from&nbsp;211.144.112.20&nbsp;-&lt;br&gt;<br>
Possible&nbsp;DoS&nbsp;Consumption&nbsp;Attack&nbsp;[Rejected]&lt;br&gt;<br>
&lt;br&gt;<br>
(this&nbsp;has&nbsp;been&nbsp;taken&nbsp;from&nbsp;the&nbsp;SpiderLabs&nbsp;blog&nbsp;entry,&nbsp;dates&nbsp;and&nbsp;IPs&nbsp;are&nbsp;obviously&nbsp;different)&lt;br&gt;<br>
&lt;br&gt;<br>
Any&nbsp;idea&nbsp;on&nbsp;why&nbsp;this&nbsp;isn&amp;#39;t&nbsp;behaving&nbsp;like&nbsp;we&amp;#39;re&nbsp;expecting&nbsp;it&nbsp;to&nbsp;be?&lt;br&gt;<br>
&lt;br&gt;<br>
Thanks!&lt;br&gt;<br>
GB&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
