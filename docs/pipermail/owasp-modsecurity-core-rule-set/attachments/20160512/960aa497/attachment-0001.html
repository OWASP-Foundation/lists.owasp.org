<tt>
&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&nbsp;color:&nbsp;rgb(0,&nbsp;0,&nbsp;0);&nbsp;font-size:&nbsp;14px;&nbsp;font-family:&nbsp;Calibri,&nbsp;sans-serif;&quot;&gt;&lt;div&gt;&lt;div&gt;Hey&nbsp;everyone,&lt;/div&gt;&lt;div&gt;Thought&nbsp;I&nbsp;would&nbsp;come&nbsp;&quot;out&nbsp;the&nbsp;shadows&quot;&nbsp;and&nbsp;comment&nbsp;on&nbsp;this&nbsp;topic&nbsp;since&nbsp;I&nbsp;was&nbsp;the&nbsp;one&nbsp;who&nbsp;created&nbsp;those&nbsp;CSRF&nbsp;rules&nbsp;-&lt;/div&gt;&lt;ul&gt;&lt;li&gt;These&nbsp;are&nbsp;definitely&nbsp;PoC&nbsp;level&nbsp;rules.&nbsp;&nbsp;They&nbsp;were&nbsp;intended&nbsp;to&nbsp;show&nbsp;ModSecurity&#8217;s&nbsp;content&nbsp;injection&nbsp;capabilities&nbsp;and&nbsp;this&nbsp;was&nbsp;just&nbsp;one&nbsp;use-case.&lt;/li&gt;&lt;li&gt;The&nbsp;actual&nbsp;JS&nbsp;code&nbsp;that&nbsp;is&nbsp;injected&nbsp;(&lt;a&nbsp;href=&quot;https://github.com/SpiderLabs/owasp-modsecurity-crs/blob/master/optional_rules/modsecurity_crs_43_csrf_protection.conf#L42-L107&quot;&gt;https://github.com/SpiderLabs/owasp-modsecurity-crs/blob/master/optional_rules/modsecurity_crs_43_csrf_protection.conf#L42-L107&lt;/a&gt;)&nbsp;is&nbsp;adapted&nbsp;from&nbsp;the&nbsp;older&nbsp;OWASP&nbsp;CSRFGuard&nbsp;code&nbsp;and&nbsp;it&nbsp;has&nbsp;limitations&nbsp;in&nbsp;its&nbsp;ability&nbsp;to&nbsp;properly&nbsp;modify&nbsp;all&nbsp;DOM&nbsp;elements&nbsp;to&nbsp;add&nbsp;the&nbsp;CSRF&nbsp;token.&nbsp;&nbsp;There&nbsp;is&nbsp;newer&nbsp;code&nbsp;available&nbsp;for&nbsp;that&nbsp;project&nbsp;that&nbsp;addresses&nbsp;some&nbsp;of&nbsp;these&nbsp;limitations&nbsp;-&nbsp;&lt;a&nbsp;href=&quot;https://github.com/esheri3/OWASP-CSRFGuard/blob/master/csrfguard/src/main/resources/csrfguard.js&quot;&gt;https://github.com/esheri3/OWASP-CSRFGuard/blob/master/csrfguard/src/main/resources/csrfguard.js&lt;/a&gt;&lt;/li&gt;&lt;li&gt;If&nbsp;you&nbsp;want&nbsp;to&nbsp;still&nbsp;try&nbsp;and&nbsp;use&nbsp;this&nbsp;&#8211;&nbsp;you&nbsp;probably&nbsp;want&nbsp;to&nbsp;modify&nbsp;which&nbsp;URLs&nbsp;are&nbsp;enforcing&nbsp;this&nbsp;logic&nbsp;as&nbsp;currently&nbsp;it&nbsp;is&nbsp;matching&nbsp;all&nbsp;-&nbsp;&lt;a&nbsp;href=&quot;https://github.com/SpiderLabs/owasp-modsecurity-crs/blob/master/optional_rules/modsecurity_crs_43_csrf_protection.conf#L30&quot;&gt;https://github.com/SpiderLabs/owasp-modsecurity-crs/blob/master/optional_rules/modsecurity_crs_43_csrf_protection.conf#L30&lt;/a&gt;&lt;/li&gt;&lt;li&gt;In&nbsp;addition&nbsp;to&nbsp;also&nbsp;requiring&nbsp;that&nbsp;the&nbsp;session&nbsp;hijacking&nbsp;conf&nbsp;file&nbsp;is&nbsp;activated&nbsp;-&nbsp;&lt;a&nbsp;href=&quot;https://github.com/SpiderLabs/owasp-modsecurity-crs/blob/master/optional_rules/modsecurity_crs_16_session_hijacking.conf#L44-L45&quot;&gt;https://github.com/SpiderLabs/owasp-modsecurity-crs/blob/master/optional_rules/modsecurity_crs_16_session_hijacking.conf#L44-L45&lt;/a&gt;&nbsp;&#8211;&nbsp;you&nbsp;also&nbsp;should&nbsp;activate&nbsp;the&nbsp;Ignore&nbsp;Static&nbsp;Content&nbsp;conf&nbsp;file&nbsp;so&nbsp;that&nbsp;you&nbsp;aren&#8217;t&nbsp;triggering&nbsp;alerts&nbsp;for&nbsp;request&nbsp;to&nbsp;static&nbsp;image&nbsp;files,&nbsp;etc..&nbsp;-&nbsp;&lt;a&nbsp;href=&quot;https://github.com/SpiderLabs/owasp-modsecurity-crs/blob/master/optional_rules/modsecurity_crs_10_ignore_static.conf&quot;&gt;https://github.com/SpiderLabs/owasp-modsecurity-crs/blob/master/optional_rules/modsecurity_crs_10_ignore_static.conf&lt;/a&gt;&lt;/li&gt;&lt;li&gt;You&nbsp;might&nbsp;also&nbsp;want&nbsp;to&nbsp;try&nbsp;to&nbsp;use&nbsp;the&nbsp;@rsub&nbsp;approach&nbsp;mentioned&nbsp;at&nbsp;the&nbsp;bottom&nbsp;of&nbsp;this&nbsp;blog&nbsp;post&nbsp;-&nbsp;&lt;a&nbsp;href=&quot;https://www.trustwave.com/Resources/SpiderLabs-Blog/Detecting-Malice-with-ModSecurity--(Updated)-CSRF-Attacks/&quot;&gt;https://www.trustwave.com/Resources/SpiderLabs-Blog/Detecting-Malice-with-ModSecurity--(Updated)-CSRF-Attacks/&lt;/a&gt;.&nbsp;&nbsp;This&nbsp;will&nbsp;modify&nbsp;the&nbsp;FORM&nbsp;HTML&nbsp;and&nbsp;inject&nbsp;the&nbsp;token&nbsp;directly&nbsp;into&nbsp;it&nbsp;vs.&nbsp;appending&nbsp;a&nbsp;bunch&nbsp;of&nbsp;JS&nbsp;and&nbsp;then&nbsp;having&nbsp;it&nbsp;modify&nbsp;the&nbsp;DOM.&lt;/li&gt;&lt;li&gt;Now,&nbsp;if&nbsp;I&nbsp;were&nbsp;to&nbsp;try&nbsp;to&nbsp;tackle&nbsp;CSRF&nbsp;today&nbsp;in&nbsp;ModSecurity,&nbsp;I&nbsp;would&nbsp;use&nbsp;the&nbsp;RSUB&nbsp;approach&nbsp;(above)&nbsp;along&nbsp;with&nbsp;JS&nbsp;append&nbsp;to&nbsp;implement&nbsp;the&nbsp;Double-Submit&nbsp;Cookie&nbsp;anti-CSRF&nbsp;approach&nbsp;-&nbsp;&lt;a&nbsp;href=&quot;http://appsandsecurity.blogspot.com/2012/01/stateless-csrf-protection.html&quot;&gt;http://appsandsecurity.blogspot.com/2012/01/stateless-csrf-protection.html&lt;/a&gt;.&nbsp;&nbsp;The&nbsp;advantage&nbsp;to&nbsp;this&nbsp;approach&nbsp;is&nbsp;that&nbsp;it&nbsp;is&nbsp;&#8220;stateless&#8221;&nbsp;meaning&nbsp;that&nbsp;you&nbsp;won&#8217;t&nbsp;have&nbsp;to&nbsp;use&nbsp;ModSecurity&#8217;s&nbsp;SDBM&nbsp;persistent&nbsp;storage.&nbsp;&nbsp;If&nbsp;you&nbsp;are&nbsp;injecting&nbsp;the&nbsp;same&nbsp;anti-CSRF&nbsp;token&nbsp;value&nbsp;as&nbsp;BOTH&nbsp;a&nbsp;hidden&nbsp;FORM&nbsp;param&nbsp;and&nbsp;as&nbsp;a&nbsp;new&nbsp;Cookie&nbsp;value&nbsp;then&nbsp;all&nbsp;ModSecurity&nbsp;WAF&nbsp;has&nbsp;to&nbsp;do&nbsp;is&nbsp;make&nbsp;sure&nbsp;that&nbsp;URLs&nbsp;that&nbsp;you&nbsp;want&nbsp;to&nbsp;protect&nbsp;(e.g.&nbsp;-&nbsp;POST&nbsp;requests&nbsp;to&nbsp;URL&nbsp;/checkout,&nbsp;etc&#8230;)&nbsp;have&nbsp;BOTH&nbsp;the&nbsp;CSRF&nbsp;param&nbsp;and&nbsp;cookie&nbsp;and&nbsp;that&nbsp;they&nbsp;BOTH&nbsp;match&nbsp;each&nbsp;other.&lt;/li&gt;&lt;li&gt;One&nbsp;last&nbsp;comment&nbsp;&#8211;&nbsp;&lt;b&gt;&lt;i&gt;Perfection&nbsp;is&nbsp;the&nbsp;Enemy&nbsp;of&nbsp;Good&lt;/i&gt;&lt;/b&gt;.&nbsp;&nbsp;While&nbsp;anti-CSRF&nbsp;tokens&nbsp;are&nbsp;sexy&nbsp;don&#8217;t&nbsp;sleep&nbsp;on&nbsp;good&nbsp;old&nbsp;Referer&nbsp;Enforcement&nbsp;checks.&nbsp;&nbsp;If&nbsp;you&nbsp;have&nbsp;a&nbsp;workflow&nbsp;that&nbsp;follows&nbsp;a&nbsp;strict&nbsp;path&nbsp;and&nbsp;you&nbsp;want&nbsp;to&nbsp;prevent&nbsp;CSRF&nbsp;attacks,&nbsp;you&nbsp;can&nbsp;simply&nbsp;craft&nbsp;up&nbsp;some&nbsp;SecRules&nbsp;that&nbsp;check&nbsp;the&nbsp;Method&nbsp;+&nbsp;URL&nbsp;+&nbsp;Referer(s)&nbsp;and&nbsp;block&nbsp;ones&nbsp;that&nbsp;are:&nbsp;1)&nbsp;Missing&nbsp;Referer,&nbsp;2)&nbsp;Coming&nbsp;from&nbsp;off-domain,&nbsp;or&nbsp;3)&nbsp;Not&nbsp;coming&nbsp;from&nbsp;your&nbsp;on-domain&nbsp;approved&nbsp;Referer&nbsp;page&nbsp;list.&lt;/li&gt;&lt;/ul&gt;&lt;div&gt;Hope&nbsp;this&nbsp;info&nbsp;helps.&lt;/div&gt;&lt;div&gt;Ryan&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&nbsp;id=&quot;MAC_OUTLOOK_SIGNATURE&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;span&nbsp;id=&quot;OLK_SRC_BODY_SECTION&quot;&gt;&lt;div&nbsp;style=&quot;font-family:Calibri;&nbsp;font-size:12pt;&nbsp;text-align:left;&nbsp;color:black;&nbsp;BORDER-BOTTOM:&nbsp;medium&nbsp;none;&nbsp;BORDER-LEFT:&nbsp;medium&nbsp;none;&nbsp;PADDING-BOTTOM:&nbsp;0in;&nbsp;PADDING-LEFT:&nbsp;0in;&nbsp;PADDING-RIGHT:&nbsp;0in;&nbsp;BORDER-TOP:&nbsp;#b5c4df&nbsp;1pt&nbsp;solid;&nbsp;BORDER-RIGHT:&nbsp;medium&nbsp;none;&nbsp;PADDING-TOP:&nbsp;3pt&quot;&gt;&lt;span&nbsp;style=&quot;font-weight:bold&quot;&gt;From:&nbsp;&lt;/span&gt;&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:owasp-modsecurity-core-rule-set-bounces@lists.owasp.org&quot;&gt;owasp-modsecurity-core-rule-set-bounces@lists.owasp.org&lt;/a&gt;&gt;&nbsp;on&nbsp;behalf&nbsp;of&nbsp;Christian&nbsp;Folini&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:christian.folini@netnea.com&quot;&gt;christian.folini@netnea.com&lt;/a&gt;&gt;&lt;br&gt;&lt;span&nbsp;style=&quot;font-weight:bold&quot;&gt;Date:&nbsp;&lt;/span&gt;&nbsp;Thursday,&nbsp;May&nbsp;12,&nbsp;2016&nbsp;at&nbsp;5:20&nbsp;AM&lt;br&gt;&lt;span&nbsp;style=&quot;font-weight:bold&quot;&gt;To:&nbsp;&lt;/span&gt;&nbsp;Barry&nbsp;Pollard&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:barry_pollard@hotmail.com&quot;&gt;barry_pollard@hotmail.com&lt;/a&gt;&gt;&lt;br&gt;&lt;span&nbsp;style=&quot;font-weight:bold&quot;&gt;Cc:&nbsp;&lt;/span&gt;&nbsp;&quot;&lt;a&nbsp;href=&quot;mailto:owasp-modsecurity-core-rule-set@lists.owasp.org&quot;&gt;owasp-modsecurity-core-rule-set@lists.owasp.org&lt;/a&gt;&quot;&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:owasp-modsecurity-core-rule-set@lists.owasp.org&quot;&gt;owasp-modsecurity-core-rule-set@lists.owasp.org&lt;/a&gt;&gt;&lt;br&gt;&lt;span&nbsp;style=&quot;font-weight:bold&quot;&gt;Subject:&nbsp;&lt;/span&gt;&nbsp;Re:&nbsp;[Owasp-modsecurity-core-rule-set]&nbsp;CSRF&nbsp;Attack&nbsp;Detected&nbsp;-&nbsp;Invalid&nbsp;Token&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;Barry,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;On&nbsp;Thu,&nbsp;May&nbsp;12,&nbsp;2016&nbsp;at&nbsp;10:01:53AM&nbsp;+0100,&nbsp;Barry&nbsp;Pollard&nbsp;wrote:&lt;/div&gt;&lt;blockquote&nbsp;id=&quot;MAC_OUTLOOK_ATTRIBUTION_BLOCKQUOTE&quot;&nbsp;style=&quot;BORDER-LEFT:&nbsp;#b5c4df&nbsp;5&nbsp;solid;&nbsp;PADDING:0&nbsp;0&nbsp;0&nbsp;5;&nbsp;MARGIN:0&nbsp;0&nbsp;0&nbsp;5;&quot;&gt;&lt;div&gt;&nbsp;I&nbsp;had&nbsp;a&nbsp;look&nbsp;at&nbsp;this&nbsp;rule&nbsp;before&nbsp;and&nbsp;am&nbsp;not&nbsp;a&nbsp;fan.&nbsp;&nbsp;&lt;/div&gt;&lt;div&gt;&nbsp;CSRF_TOKEN's&lt;/div&gt;&lt;div&gt;&nbsp;should&nbsp;come&nbsp;from&nbsp;the&nbsp;app&nbsp;in&nbsp;my&nbsp;mind&nbsp;and&nbsp;not&nbsp;the&nbsp;WAF.&nbsp;However&lt;/div&gt;&lt;div&gt;&nbsp;ModSecurity&nbsp;does&nbsp;have&nbsp;a&nbsp;method&nbsp;of&nbsp;using&nbsp;them,&nbsp;which&nbsp;is&nbsp;an&nbsp;interesting&lt;/div&gt;&lt;div&gt;&nbsp;proof&nbsp;of&nbsp;concept,&nbsp;but&nbsp;I&nbsp;think&nbsp;it's&nbsp;flaky&nbsp;for&nbsp;a&nbsp;number&nbsp;of&nbsp;reasons.&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thank&nbsp;you&nbsp;for&nbsp;sharing&nbsp;your&nbsp;experience&nbsp;/&nbsp;observations.&nbsp;This&nbsp;was&nbsp;exactly&nbsp;&lt;/div&gt;&lt;div&gt;my&nbsp;impression&nbsp;of&nbsp;this&nbsp;rule&nbsp;as&nbsp;well.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;have&nbsp;sites&nbsp;in&nbsp;production&nbsp;that&nbsp;use&nbsp;persistent&nbsp;collections&nbsp;and&lt;/div&gt;&lt;div&gt;prepend/append&nbsp;constructs.&nbsp;But&nbsp;the&nbsp;scope&nbsp;is&nbsp;very&nbsp;limited&nbsp;and&nbsp;none&lt;/div&gt;&lt;div&gt;is&nbsp;high&nbsp;traffic.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;So&nbsp;yes,&nbsp;this&nbsp;can&nbsp;be&nbsp;made&nbsp;to&nbsp;work,&nbsp;but&nbsp;it's&nbsp;a&nbsp;road&nbsp;that&nbsp;is&nbsp;rarely&lt;/div&gt;&lt;div&gt;travelled.&nbsp;It's&nbsp;kind&nbsp;of&nbsp;adventurous.&nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Ahoj,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Christian&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;--&nbsp;&lt;/div&gt;&lt;div&gt;If&nbsp;you&nbsp;have&nbsp;men&nbsp;who&nbsp;will&nbsp;only&nbsp;come&nbsp;if&nbsp;they&nbsp;know&nbsp;there&nbsp;is&nbsp;a&nbsp;good&nbsp;road,&nbsp;&lt;/div&gt;&lt;div&gt;I&nbsp;don't&nbsp;want&nbsp;them.&nbsp;I&nbsp;want&nbsp;men&nbsp;who&nbsp;will&nbsp;come&nbsp;if&nbsp;there&nbsp;is&nbsp;no&nbsp;road&nbsp;at&nbsp;all.&lt;/div&gt;&lt;div&gt;--&nbsp;David&nbsp;Livingstone&lt;/div&gt;&lt;div&gt;_______________________________________________&lt;/div&gt;&lt;div&gt;Owasp-modsecurity-core-rule-set&nbsp;mailing&nbsp;list&lt;/div&gt;&lt;div&gt;&lt;a&nbsp;href=&quot;mailto:Owasp-modsecurity-core-rule-set@lists.owasp.org&quot;&gt;Owasp-modsecurity-core-rule-set@lists.owasp.org&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;a&nbsp;href=&quot;https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set&quot;&gt;https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/span&gt;&lt;/body&gt;&lt;/html&gt;<br>

</tt>
