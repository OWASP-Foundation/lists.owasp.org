<tt>
&lt;html&gt;<br>
&lt;head&gt;<br>
&lt;style&gt;&lt;!--<br>
.hmmessage&nbsp;P<br>
{<br>
margin:0px;<br>
padding:0px<br>
}<br>
body.hmmessage<br>
{<br>
font-size:&nbsp;12pt;<br>
font-family:Calibri<br>
}<br>
--&gt;&lt;/style&gt;&lt;/head&gt;<br>
&lt;body&nbsp;class='hmmessage'&gt;&lt;div&nbsp;dir='ltr'&gt;Dauto&nbsp;(and&nbsp;Christian),&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;had&nbsp;a&nbsp;look&nbsp;at&nbsp;this&nbsp;rule&nbsp;before&nbsp;and&nbsp;am&nbsp;not&nbsp;a&nbsp;fan.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;CSRF_TOKEN's&nbsp;should&nbsp;come&nbsp;from&nbsp;the&nbsp;app&nbsp;in&nbsp;my&nbsp;mind&nbsp;and&nbsp;not&nbsp;the&nbsp;WAF.&nbsp;However&nbsp;ModSecurity&nbsp;does&nbsp;have&nbsp;a&nbsp;method&nbsp;of&nbsp;using&nbsp;them,&nbsp;which&nbsp;is&nbsp;an&nbsp;interesting&nbsp;proof&nbsp;of&nbsp;concept,&nbsp;but&nbsp;I&nbsp;think&nbsp;it's&nbsp;flaky&nbsp;for&nbsp;a&nbsp;number&nbsp;of&nbsp;reasons.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;way&nbsp;it&nbsp;works&nbsp;is&nbsp;i&lt;span&nbsp;style=&quot;font-size:&nbsp;12pt;&quot;&gt;t&nbsp;uses&nbsp;collections&nbsp;to&nbsp;store&nbsp;the&nbsp;CSRF_TOKEN.&nbsp;R&lt;/span&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;12pt;&quot;&gt;ule&nbsp;981145&nbsp;uses&nbsp;content&nbsp;injection&nbsp;to&nbsp;inject&nbsp;a&nbsp;bit&nbsp;of&nbsp;Javascript&nbsp;to&nbsp;set&nbsp;the&nbsp;CSRF&nbsp;token&nbsp;on&nbsp;any&nbsp;URLs&nbsp;or&nbsp;forms&nbsp;for&nbsp;any&nbsp;HTML&nbsp;pages&nbsp;requested&lt;/span&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;12pt;&quot;&gt;&nbsp;and&nbsp;when&nbsp;the&nbsp;subsequent&nbsp;request&nbsp;comes&nbsp;in&nbsp;after&nbsp;rule&nbsp;981144&nbsp;compares&nbsp;the&nbsp;CSRF_TOKEN&nbsp;in&nbsp;the&nbsp;collection&nbsp;and&nbsp;rejects&nbsp;any&nbsp;requests&nbsp;without&nbsp;a&nbsp;valid&nbsp;token.&nbsp;The&nbsp;below&nbsp;rule&nbsp;is&nbsp;firing&nbsp;because&nbsp;it&nbsp;didn't&nbsp;match.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;12pt;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;It's&nbsp;an&nbsp;interesting&nbsp;idea,&nbsp;and&nbsp;would&nbsp;work&nbsp;in&nbsp;certain&nbsp;scenarios,&nbsp;but&nbsp;I&nbsp;can&nbsp;see&nbsp;multiple&nbsp;issues&nbsp;with&nbsp;it.&nbsp;For&nbsp;a&nbsp;start&nbsp;when&nbsp;first&nbsp;turning&nbsp;it&nbsp;on&nbsp;none&nbsp;of&nbsp;the&nbsp;current&nbsp;messages&nbsp;will&nbsp;have&nbsp;CSRF&nbsp;tokens&nbsp;so&nbsp;need&nbsp;to&nbsp;think&nbsp;about&nbsp;how&nbsp;to&nbsp;deploy,&nbsp;and&nbsp;the&nbsp;content&nbsp;injection&nbsp;concept&nbsp;has&nbsp;multiple&nbsp;issues&nbsp;in&nbsp;my&nbsp;mind,&nbsp;but&nbsp;for&nbsp;me&nbsp;the&nbsp;biggest&nbsp;issues&nbsp;is&nbsp;with&nbsp;collections.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Collections&nbsp;is,&nbsp;IMHO,&nbsp;one&nbsp;of&nbsp;the&nbsp;weak&nbsp;points&nbsp;of&nbsp;ModSecurity.&nbsp;As&nbsp;soon&nbsp;as&nbsp;you&nbsp;get&nbsp;any&nbsp;volume&nbsp;of&nbsp;traffic&nbsp;Modsecurity&nbsp;struggles&nbsp;to&nbsp;cope&nbsp;with&nbsp;the&nbsp;file&nbsp;based&nbsp;SDBM&nbsp;format&nbsp;it&nbsp;uses&nbsp;to&nbsp;hold&nbsp;collections.&nbsp;I&nbsp;(and&nbsp;lots&nbsp;of&nbsp;others)&nbsp;see&nbsp;multiple&nbsp;issues&nbsp;with&nbsp;managing&nbsp;collections,&nbsp;from&nbsp;alerts&nbsp;like&nbsp;&quot;collections_remove_stale:&nbsp;Failed&nbsp;deleting&nbsp;collection&quot;&nbsp;to&nbsp;collections&nbsp;growing&nbsp;massively&nbsp;in&nbsp;size&nbsp;unless&nbsp;periodically&nbsp;deleted,&nbsp;to&nbsp;collections&nbsp;not&nbsp;working&nbsp;across&nbsp;multiple&nbsp;instances&nbsp;of&nbsp;Apache/ModSecurity&nbsp;without&nbsp;a&nbsp;complicated&nbsp;sharing&nbsp;mechanism...etc.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Maybe&nbsp;this&nbsp;will&nbsp;be&nbsp;improved&nbsp;in&nbsp;ModSecurity&nbsp;v3&nbsp;which&nbsp;might&nbsp;have&nbsp;memcache&nbsp;based&nbsp;collections&nbsp;rather&nbsp;than&nbsp;disk&nbsp;based&nbsp;collections&nbsp;but&nbsp;for&nbsp;now,&nbsp;collections&nbsp;cannot&nbsp;really&nbsp;be&nbsp;relied&nbsp;upon&nbsp;in&nbsp;my&nbsp;view&nbsp;(though&nbsp;others&nbsp;may&nbsp;disagree).&nbsp;They&nbsp;are&nbsp;fine&nbsp;(just!)&nbsp;for&nbsp;rate&nbsp;limiting&nbsp;(where&nbsp;missing&nbsp;an&nbsp;odd&nbsp;update&nbsp;or&nbsp;read&nbsp;of&nbsp;collection&nbsp;doesn't&nbsp;matter&nbsp;too&nbsp;much&nbsp;as,&nbsp;in&nbsp;worst&nbsp;case&nbsp;you&nbsp;just&nbsp;don't&nbsp;block&nbsp;until&nbsp;a&nbsp;little&nbsp;later),&nbsp;but&nbsp;cannot&nbsp;be&nbsp;used&nbsp;when&nbsp;you&nbsp;need&nbsp;to&nbsp;reply&nbsp;on&nbsp;them.&nbsp;And&nbsp;CSRF_TOKEN's&nbsp;need&nbsp;to&nbsp;reply&nbsp;on&nbsp;them&nbsp;or&nbsp;they&nbsp;reject&nbsp;messages.&nbsp;&lt;span&nbsp;style=&quot;font-size:&nbsp;12pt;&quot;&gt;Hoping&nbsp;it&nbsp;is&nbsp;fixed&nbsp;in&nbsp;v3&nbsp;as&nbsp;reliable&nbsp;collections&nbsp;open&nbsp;up&nbsp;a&nbsp;wealth&nbsp;of&nbsp;opportunities&nbsp;like&nbsp;this&nbsp;CSRF&nbsp;implementation&nbsp;(though&nbsp;still&nbsp;wouldn't&nbsp;recommend&nbsp;it&nbsp;for&nbsp;CSRF&nbsp;for&nbsp;other&nbsp;reasons&nbsp;mentioned&nbsp;briefly&nbsp;above).&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Anyway&nbsp;for&nbsp;now&nbsp;I&nbsp;don't&nbsp;recommend&nbsp;using&nbsp;this&nbsp;(or&nbsp;most&nbsp;of&nbsp;the&nbsp;optional&nbsp;rules&nbsp;to&nbsp;be&nbsp;honest).&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks,&lt;/div&gt;&lt;div&gt;Barry&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;style&gt;&lt;!--<br>
.ExternalClass&nbsp;.ecxhmmessage&nbsp;P&nbsp;{<br>
padding:0px;<br>
}<br>
<br>
.ExternalClass&nbsp;body.ecxhmmessage&nbsp;{<br>
font-size:12pt;<br>
font-family:Calibri;<br>
}<br>
<br>
--&gt;&lt;/style&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;&lt;/body&gt;<br>
&lt;/html&gt;
</tt>
