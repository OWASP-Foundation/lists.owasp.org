<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] DoS Protection Problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20DoS%20Protection%20Problem&In-Reply-To=%3C523AD284.3040507%40aleksic.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001448.html">
   <LINK REL="Next"  HREF="001450.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] DoS Protection Problem</H1>
    <B>Slobodan Aleksi&#263;</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20DoS%20Protection%20Problem&In-Reply-To=%3C523AD284.3040507%40aleksic.de%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] DoS Protection Problem">lists at aleksic.de
       </A><BR>
    <I>Thu Sep 19 10:31:32 UTC 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="001448.html">[Owasp-modsecurity-core-rule-set] XSS/CSP brain storm
</A></li>
        <LI>Next message: <A HREF="001450.html">[Owasp-modsecurity-core-rule-set] DoS Protection Problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1449">[ date ]</a>
              <a href="thread.html#1449">[ thread ]</a>
              <a href="subject.html#1449">[ subject ]</a>
              <a href="author.html#1449">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello list,

we have the same problem as Nick mentioned.
We have loadbalancers in front of Apache reverse proxies and when
activating the modsecurity_crs_11_dos_protection.conf the loadbalancers
are causing the rule to trigger.
We counted the requests - *only* about 120req/hour which is quiet normal.
A whitelist is helping us, but what is with legitime requests like Nick
mentioned? Any ideas or an improved version of
modsecurity_crs_11_dos_protection.conf on the way ?


Best regards




On 05/07/2013 07:36 PM, Nick wrote:
&gt;<i> I've been experimenting with this modsecurity_crs_11_dos_protection.conf
</I>&gt;<i> ruleset more. An outline of how it seems to work:
</I>&gt;<i> 
</I>&gt;<i> - Every non-image request increments the ip.dos_counter counter.
</I>&gt;<i> - If that counter is &gt; tx.dos_counter_threshold, it increments
</I>&gt;<i> ip.dos_burst_counter, sets an expiration time on ip.dos_burst_counter,
</I>&gt;<i> and clears ip.dos_counter
</I>&gt;<i> - If ip.dos_burst_counter &gt; ip.dos_burst_threshold, it blocks the
</I>&gt;<i> request until tx.dos_block_timeout seconds elapses
</I>&gt;<i> 
</I>&gt;<i> The rational behind the burst counter seems to be because mod_security
</I>&gt;<i> expiration doesn't work based on the FIRST write to a variable, it works
</I>&gt;<i> based on the most recent write. In my case, I'm using a time slice of 60
</I>&gt;<i> seconds, but if a bot requests a page every 10 seconds for hours it will
</I>&gt;<i> never expire ip_dos_counter, the only time that will happen is if they
</I>&gt;<i> don't do any requests for 60 seconds. So, this burst counter is designed
</I>&gt;<i> to try to get around this problem by waiting until the dos_counter is
</I>&gt;<i> over the threshold (which doesn't really prove anything about how fast
</I>&gt;<i> requests were being made, only that the user has done a bunch of
</I>&gt;<i> requests without pausing) and then it increments the burst counter which
</I>&gt;<i> has an expiration time (in my case, 60 seconds) and clears out the
</I>&gt;<i> dos_counter. So, if the dos counter gets up to the threshold AGAIN, then
</I>&gt;<i> it knows that those requests really all have come in the past 60
</I>&gt;<i> seconds, so it knows that the user is requesting too quickly.
</I>&gt;<i> 
</I>&gt;<i> Great in theory, but this is broken.
</I>&gt;<i> 
</I>&gt;<i> The problem scenario:
</I>&gt;<i> 
</I>&gt;<i> - A bot (bingbot in my case) has been requesting pages for the past
</I>&gt;<i> hour. Averaging one or two requests per second. Nothing to worry about.
</I>&gt;<i> - The dos_counter is over the threshold because it has been submitting
</I>&gt;<i> requests for a long time without pausing
</I>&gt;<i> - Sometimes it submits 2-4 requests virtually simultaneously (on the
</I>&gt;<i> same second in the log)
</I>&gt;<i> - It submits 2 or more requests simultaneously. For EACH REQUEST,
</I>&gt;<i> mod_security sees that ip_dos_counter is over the threshold, so each
</I>&gt;<i> request increments ip_dos_burst_counter. bingbot is now blocked.
</I>&gt;<i> 
</I>&gt;<i> So this is an example where the bot was blocked even though it was
</I>&gt;<i> operating at a far slower rate than the DoS settings specify. If those 2
</I>&gt;<i> requests would have been spaced apart by a second, it would not have
</I>&gt;<i> been blocked. But, by submitting requests very close together, a bot can
</I>&gt;<i> be blocked without really submitting that many requests very quickly.
</I>&gt;<i> This is happening on my server at least every day.
</I>&gt;<i> 
</I>&gt;<i> I am new to mod_security so I'm still learning exactly how these rules
</I>&gt;<i> work, but are there any solutions to this problem? The way this rule is
</I>&gt;<i> set up, it seems to be operating on the principle that the rule is
</I>&gt;<i> atomic when it clearly isn't. If dos_counter would be cleared before the
</I>&gt;<i> burst counter is incremented, this problem wouldn't exist.
</I>&gt;<i> 
</I>&gt;<i> I'm also unclear on how this is coordinated across the multiple apache
</I>&gt;<i> processes. I understand this to be a collection, which resides on disk,
</I>&gt;<i> so I'm not sure when mod_security writes this information to disk.
</I>&gt;<i> 
</I>&gt;<i> Does anyone have any pointers for where to look, or a different DoS
</I>&gt;<i> ruleset to try?
</I>&gt;<i> 
</I>&gt;<i> Or is DoS protection not something that is possible with mod_security,
</I>&gt;<i> and I need another module? I don't need anything fancy, I just want to
</I>&gt;<i> be able to limit an IP address to a certain number of requests within a
</I>&gt;<i> time period. Thanks,
</I>&gt;<i> 
</I>&gt;<i> Nick
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> On Mon, Apr 29, 2013 at 12:49 PM, Nick &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">darknovanick at gmail.com</A>
</I>&gt;<i> &lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">darknovanick at gmail.com</A>&gt;&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i>     Hello,
</I>&gt;<i> 
</I>&gt;<i>     I've been setting up mod_security and enabled
</I>&gt;<i>     the modsecurity_crs_11_dos_protection.conf rule. This is
</I>&gt;<i>     mod_security 2.6.8 and CRS version 2.2.5.
</I>&gt;<i> 
</I>&gt;<i>     I have initialized the settings with:
</I>&gt;<i>     SecAction \
</I>&gt;<i>       &quot;id:'900015', \
</I>&gt;<i>       phase:1, \
</I>&gt;<i>       t:none, \
</I>&gt;<i>       setvar:'tx.dos_burst_time_slice=60', \
</I>&gt;<i>       setvar:'tx.dos_counter_threshold=300', \
</I>&gt;<i>       setvar:'tx.dos_block_timeout=600', \
</I>&gt;<i>       nolog, \
</I>&gt;<i>       pass&quot;
</I>&gt;<i> 
</I>&gt;<i>     This works and it is blocking some very aggressive bots the way it
</I>&gt;<i>     should. But there is a problem. I have occasionally been getting
</I>&gt;<i>     lines like this in the log:
</I>&gt;<i> 
</I>&gt;<i>     Warning. Operator GE matched 2 at IP:dos_burst_counter. [file
</I>&gt;<i>     &quot;/etc/httpd/modsecurity.d/activated_rules/modsecurity_crs_11_dos_protection.conf&quot;]
</I>&gt;<i>     [line &quot;44&quot;] [id &quot;981049&quot;] [msg &quot;Potential Denial of Service (DoS)
</I>&gt;<i>     Attack from 65.55.24.236 - # of Request Bursts: 3&quot;]
</I>&gt;<i> 
</I>&gt;<i>     This bot was actually bingbot. I am new to mod_security, but my
</I>&gt;<i>     understanding of my settings is that it shouldn't block until a bot
</I>&gt;<i>     has requested 300 pages in 60 seconds.
</I>&gt;<i> 
</I>&gt;<i>     When I check the logs I see that IP 65.55.24.236 has requested 313
</I>&gt;<i>     pages in 1 hour. In the 60 seconds before the DoS block happening,
</I>&gt;<i>     this IP only requested 6 pages. This block obviously shouldn't be
</I>&gt;<i>     happening.
</I>&gt;<i> 
</I>&gt;<i>     I am grossly misunderstanding something, or what can I do to fix
</I>&gt;<i>     this? Thanks,
</I>&gt;<i> 
</I>&gt;<i>     Nick
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> This body part will be downloaded on demand.
</I>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001448.html">[Owasp-modsecurity-core-rule-set] XSS/CSP brain storm
</A></li>
	<LI>Next message: <A HREF="001450.html">[Owasp-modsecurity-core-rule-set] DoS Protection Problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1449">[ date ]</a>
              <a href="thread.html#1449">[ thread ]</a>
              <a href="subject.html#1449">[ subject ]</a>
              <a href="author.html#1449">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
