<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] DoS Protection Problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20DoS%20Protection%20Problem&In-Reply-To=%3CCA%2BQch%3DLcatf12H3QuVVGZAjDDrencAP%2B%2BJvvWT6QSBZFcp12%3Dg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001449.html">
   <LINK REL="Next"  HREF="001451.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] DoS Protection Problem</H1>
    <B>Nick</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20DoS%20Protection%20Problem&In-Reply-To=%3CCA%2BQch%3DLcatf12H3QuVVGZAjDDrencAP%2B%2BJvvWT6QSBZFcp12%3Dg%40mail.gmail.com%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] DoS Protection Problem">darknovanick at gmail.com
       </A><BR>
    <I>Thu Sep 19 15:38:58 UTC 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="001449.html">[Owasp-modsecurity-core-rule-set] DoS Protection Problem
</A></li>
        <LI>Next message: <A HREF="001451.html">[Owasp-modsecurity-core-rule-set] Request
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1450">[ date ]</a>
              <a href="thread.html#1450">[ thread ]</a>
              <a href="subject.html#1450">[ subject ]</a>
              <a href="author.html#1450">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

I researched this more and never found any small modification to
modsecurity_crs_11_dos_protection.conf that would fix this problem, so I
decided to rewrite the rule.

I pasted in the rule I'm using at the end of this email. I'm far from a
mod_security expert, but I've been running this rule for a few months now
and it seems to be working well in blocking most illegitimate clients while
letting through virtually all legitimate ones. I haven't actually been
attacked, as far as I know of, by anyone intent on actually bringing down
the site, so I'm not sure that it would work under extreme pressure or not.
I'd be very interested in hearing if other people tried it out, or made
modifications to it, as I know it can be improved.

The rule is based on the modsecurity_crs_11_dos_protection.conf rule, along
with some examples I read in a book. There are basically two separate parts
to the rule, and only one or the other needs to be enabled if desired (but
I use both as they work differently).

ID 2106 involves blocking an IP if it requests too quickly, which is
similar to the broken DoS rule but does it a different way using the
update_rate -- this has limitations compared to the theoretical CRS DoS
rule, but doesn't have that bug, so it works much better for me.

Rule 2105 actually keeps track of how much CPU time one IP is using and can
block based on that. So that's more useful if you have some scripts that
are &quot;heavier&quot; than other pages. I have notes in the code but the main weird
thing about that rule is that mod_security 2.6.x (which is what I have)
uses duration in milliseconds and they changed it in 2.7.x to use
microseconds, so if you have 2.7.x you need to multiply by 1000 in order to
get the same result. If using this rule it is very important to adjust that
based on the version of mod_security you are using, or else it's not going
to work.

Rule 2104 adds a delay to fast requests, if they haven't met the block
threshold. I added this after I found that some legitimate bots (like Bing)
sometimes make a ton of requests simultaneously, and I think adding this
delay gets them to slow down the requests a little. I've found that when
using it, I have almost no legitimate clients trigger a block.

And note that this rule probably doesn't play well with the CRS's DoS rule
so you'd want to disable that one. If you do play with it and find a
problem or make an improvement, please let me know! Thanks,

Nick



------

#
# Anti-Automation rule set for detecting Denial of Service Attacks.
#
# This ruleset is designed to monitor both how much server time an
# IP address uses and also how quickly an IP makes requests, and
# can block based on either factor.
#
# RULE NOTE -- IP.duration is in milliseconds in mod_security 2.6.x.
# In mod_security 2.7.x this will change to microseconds, which requires
that
# all these constant factors be multiplied by 1000 to stay the same
#
# Settings of 30000 ms load until block and 250/1 deprecate factor
effectively
# mean that with a 4 core machine, a client can burst up to using one whole
# core for 30s, or 4 cores for 7.5s, before being blocked. If it doesn't use
# a full burst but still is requesting quickly, the 250/1 means that for
every
# 1 second that elapses we'll subtract 250 ms of load, so over time a client
# can use about 1 full core without triggering the ban. This may be too much
# but no legitimate client should use that much so it should be safe.


#
# Enforce an existing IP address block and log only 1-time/minute
# We don't want to get flooded by alerts during an attack or scan so
# we are only triggering an alert once/minute.  You can adjust how often
# you want to receive status alerts by changing the expirevar setting below.
#
SecRule IP:DOS_BLOCK &quot;@eq 1&quot; &quot;chain,phase:1,id:'2100',drop,msg:'Denial of
Service (DoS) Attack Identified from %{remote_addr}
(%{tx.dos_block_counter} hits since last
alert)',setvar:ip.dos_block_counter=+1&quot;
        SecRule &amp;IP:DOS_BLOCK_FLAG &quot;@eq 0&quot;
&quot;setvar:ip.dos_block_flag=1,expirevar:ip.dos_block_flag=60,setvar:tx.dos_block_counter=%{ip.dos_block_counter},setvar:ip.dos_block_counter=0&quot;

#
# Block and track # of requests but don't log
SecRule IP:DOS_BLOCK &quot;@eq 1&quot;
&quot;phase:1,id:'2101',t:none,drop,nolog,setvar:ip.dos_block_counter=+1&quot;

#
# skipAfter Check
# There are different scenarios where we don't want to do checks -
# 1. If the current IP address has already been blocked due to high requests
# In this case, we skip doing the request counts.
#
SecRule IP:DOS_BLOCK &quot;@eq 1&quot;
&quot;phase:5,id:'2102',t:none,nolog,pass,skipAfter:END_DOS_PROTECTION_CHECKS&quot;



# Keep track of how much web server time is consumed by each IP address
# Decrease the load time by 250 ms every second that elapses so the load
time decreases if the bot
# lightens up on the requests.
SecRule REQUEST_BASENAME &quot;!\.(jpe?g|png|gif|js|css|ico)$&quot;
&quot;phase:5,id:'2103',t:none,nolog,pass,setvar:IP.load=+%{DURATION},deprecatevar:IP.load=250/1&quot;

# If a bot is using a lot of time but isn't actually over the block
threshold yet, slow it down.
# This is most useful for &quot;friendly&quot; bots like bingbot that are just being
more aggressive than
# we'd like. If a bot is trying to do a denial-of-service attack, this
could potentially be
# bad as this Apache process will just sit idle for the delay period. But
I'm not sure that's
# all bad as we have a lot more processes than we have cores, so if this
one is idle then
# another thread will be able to use the CPU time if there is a lot going
on with the server
SecRule IP:LOAD &quot;@ge 15000&quot;
&quot;phase:5,id:'2104',t:none,log,pass,msg:'Delaying aggressive IP
%{remote_addr} - IP load too high: %{IP.load}',pause:5000&quot;


# Block an IP address if it uses too much of the web server's time
SecRule IP:LOAD &quot;@ge 30000&quot;
&quot;phase:5,id:'2105',t:none,log,pass,msg:'Potential Denial of Service (DoS)
Attack from %{remote_addr} - IP load too high:
%{IP.load}',setvar:ip.dos_block=1,expirevar:ip.dos_block=%{tx.dos_block_timeout}&quot;


# Also block an IP address if it makes too many requests too quickly.
# IP.UPDATE_RATE contains the average number of requests per MINUTE, over
the lifetime of the ip collection.
# Note that since it is calculated over its lifetime, if the IP has been
continually requesting pages for
# a long time and then all of a sudden ramps things up a lot, the average
will rise very slowly. This is
# more useful when they start out hitting consistently hard.
# IP.UPDATE_COUNTER is used to make sure it doesn't check the UPDATE_RATE
if only a small number of
# requests have been made, because if an IP makes 5 requests in the same
second we don't necessarily want
# to block immediately if those are all the requests they've made.
SecRule IP:UPDATE_COUNTER &quot;@ge 50&quot;
&quot;chain,phase:5,id:'2106',t:none,log,pass,msg:'Potential Denial of Service
(DoS) Attack from %{remote_addr} - Request update rate: %{IP.UPDATE_RATE}
too high'&quot;
        SecRule IP:UPDATE_RATE &quot;@ge 650&quot;
&quot;setvar:ip.dos_block=1,expirevar:ip.dos_block=%{tx.dos_block_timeout}&quot;

SecMarker END_DOS_PROTECTION_CHECKS

------


On Thu, Sep 19, 2013 at 5:31 AM, Slobodan Aleksi&#263; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">lists at aleksic.de</A>&gt; wrote:

&gt;<i> Hello list,
</I>&gt;<i>
</I>&gt;<i> we have the same problem as Nick mentioned.
</I>&gt;<i> We have loadbalancers in front of Apache reverse proxies and when
</I>&gt;<i> activating the modsecurity_crs_11_dos_protection.conf the loadbalancers
</I>&gt;<i> are causing the rule to trigger.
</I>&gt;<i> We counted the requests - *only* about 120req/hour which is quiet normal.
</I>&gt;<i> A whitelist is helping us, but what is with legitime requests like Nick
</I>&gt;<i> mentioned? Any ideas or an improved version of
</I>&gt;<i> modsecurity_crs_11_dos_protection.conf on the way ?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Best regards
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On 05/07/2013 07:36 PM, Nick wrote:
</I>&gt;<i> &gt; I've been experimenting with this modsecurity_crs_11_dos_protection.conf
</I>&gt;<i> &gt; ruleset more. An outline of how it seems to work:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; - Every non-image request increments the ip.dos_counter counter.
</I>&gt;<i> &gt; - If that counter is &gt; tx.dos_counter_threshold, it increments
</I>&gt;<i> &gt; ip.dos_burst_counter, sets an expiration time on ip.dos_burst_counter,
</I>&gt;<i> &gt; and clears ip.dos_counter
</I>&gt;<i> &gt; - If ip.dos_burst_counter &gt; ip.dos_burst_threshold, it blocks the
</I>&gt;<i> &gt; request until tx.dos_block_timeout seconds elapses
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The rational behind the burst counter seems to be because mod_security
</I>&gt;<i> &gt; expiration doesn't work based on the FIRST write to a variable, it works
</I>&gt;<i> &gt; based on the most recent write. In my case, I'm using a time slice of 60
</I>&gt;<i> &gt; seconds, but if a bot requests a page every 10 seconds for hours it will
</I>&gt;<i> &gt; never expire ip_dos_counter, the only time that will happen is if they
</I>&gt;<i> &gt; don't do any requests for 60 seconds. So, this burst counter is designed
</I>&gt;<i> &gt; to try to get around this problem by waiting until the dos_counter is
</I>&gt;<i> &gt; over the threshold (which doesn't really prove anything about how fast
</I>&gt;<i> &gt; requests were being made, only that the user has done a bunch of
</I>&gt;<i> &gt; requests without pausing) and then it increments the burst counter which
</I>&gt;<i> &gt; has an expiration time (in my case, 60 seconds) and clears out the
</I>&gt;<i> &gt; dos_counter. So, if the dos counter gets up to the threshold AGAIN, then
</I>&gt;<i> &gt; it knows that those requests really all have come in the past 60
</I>&gt;<i> &gt; seconds, so it knows that the user is requesting too quickly.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Great in theory, but this is broken.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The problem scenario:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; - A bot (bingbot in my case) has been requesting pages for the past
</I>&gt;<i> &gt; hour. Averaging one or two requests per second. Nothing to worry about.
</I>&gt;<i> &gt; - The dos_counter is over the threshold because it has been submitting
</I>&gt;<i> &gt; requests for a long time without pausing
</I>&gt;<i> &gt; - Sometimes it submits 2-4 requests virtually simultaneously (on the
</I>&gt;<i> &gt; same second in the log)
</I>&gt;<i> &gt; - It submits 2 or more requests simultaneously. For EACH REQUEST,
</I>&gt;<i> &gt; mod_security sees that ip_dos_counter is over the threshold, so each
</I>&gt;<i> &gt; request increments ip_dos_burst_counter. bingbot is now blocked.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; So this is an example where the bot was blocked even though it was
</I>&gt;<i> &gt; operating at a far slower rate than the DoS settings specify. If those 2
</I>&gt;<i> &gt; requests would have been spaced apart by a second, it would not have
</I>&gt;<i> &gt; been blocked. But, by submitting requests very close together, a bot can
</I>&gt;<i> &gt; be blocked without really submitting that many requests very quickly.
</I>&gt;<i> &gt; This is happening on my server at least every day.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I am new to mod_security so I'm still learning exactly how these rules
</I>&gt;<i> &gt; work, but are there any solutions to this problem? The way this rule is
</I>&gt;<i> &gt; set up, it seems to be operating on the principle that the rule is
</I>&gt;<i> &gt; atomic when it clearly isn't. If dos_counter would be cleared before the
</I>&gt;<i> &gt; burst counter is incremented, this problem wouldn't exist.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I'm also unclear on how this is coordinated across the multiple apache
</I>&gt;<i> &gt; processes. I understand this to be a collection, which resides on disk,
</I>&gt;<i> &gt; so I'm not sure when mod_security writes this information to disk.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Does anyone have any pointers for where to look, or a different DoS
</I>&gt;<i> &gt; ruleset to try?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Or is DoS protection not something that is possible with mod_security,
</I>&gt;<i> &gt; and I need another module? I don't need anything fancy, I just want to
</I>&gt;<i> &gt; be able to limit an IP address to a certain number of requests within a
</I>&gt;<i> &gt; time period. Thanks,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Nick
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On Mon, Apr 29, 2013 at 12:49 PM, Nick &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">darknovanick at gmail.com</A>
</I>&gt;<i> &gt; &lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">darknovanick at gmail.com</A>&gt;&gt; wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Hello,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     I've been setting up mod_security and enabled
</I>&gt;<i> &gt;     the modsecurity_crs_11_dos_protection.conf rule. This is
</I>&gt;<i> &gt;     mod_security 2.6.8 and CRS version 2.2.5.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     I have initialized the settings with:
</I>&gt;<i> &gt;     SecAction \
</I>&gt;<i> &gt;       &quot;id:'900015', \
</I>&gt;<i> &gt;       phase:1, \
</I>&gt;<i> &gt;       t:none, \
</I>&gt;<i> &gt;       setvar:'tx.dos_burst_time_slice=60', \
</I>&gt;<i> &gt;       setvar:'tx.dos_counter_threshold=300', \
</I>&gt;<i> &gt;       setvar:'tx.dos_block_timeout=600', \
</I>&gt;<i> &gt;       nolog, \
</I>&gt;<i> &gt;       pass&quot;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     This works and it is blocking some very aggressive bots the way it
</I>&gt;<i> &gt;     should. But there is a problem. I have occasionally been getting
</I>&gt;<i> &gt;     lines like this in the log:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Warning. Operator GE matched 2 at IP:dos_burst_counter. [file
</I>&gt;<i> &gt;
</I>&gt;<i> &quot;/etc/httpd/modsecurity.d/activated_rules/modsecurity_crs_11_dos_protection.conf&quot;]
</I>&gt;<i> &gt;     [line &quot;44&quot;] [id &quot;981049&quot;] [msg &quot;Potential Denial of Service (DoS)
</I>&gt;<i> &gt;     Attack from 65.55.24.236 - # of Request Bursts: 3&quot;]
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     This bot was actually bingbot. I am new to mod_security, but my
</I>&gt;<i> &gt;     understanding of my settings is that it shouldn't block until a bot
</I>&gt;<i> &gt;     has requested 300 pages in 60 seconds.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     When I check the logs I see that IP 65.55.24.236 has requested 313
</I>&gt;<i> &gt;     pages in 1 hour. In the 60 seconds before the DoS block happening,
</I>&gt;<i> &gt;     this IP only requested 6 pages. This block obviously shouldn't be
</I>&gt;<i> &gt;     happening.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     I am grossly misunderstanding something, or what can I do to fix
</I>&gt;<i> &gt;     this? Thanks,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Nick
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; This body part will be downloaded on demand.
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20130919/09ce59ea/attachment-0001.html">http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20130919/09ce59ea/attachment-0001.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001449.html">[Owasp-modsecurity-core-rule-set] DoS Protection Problem
</A></li>
	<LI>Next message: <A HREF="001451.html">[Owasp-modsecurity-core-rule-set] Request
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1450">[ date ]</a>
              <a href="thread.html#1450">[ thread ]</a>
              <a href="subject.html#1450">[ subject ]</a>
              <a href="author.html#1450">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
