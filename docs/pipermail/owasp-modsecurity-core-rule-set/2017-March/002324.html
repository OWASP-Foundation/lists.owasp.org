<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Send back the correct response code
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Send%20back%20the%20correct%0A%20response%20code&In-Reply-To=%3C431f9211c3f64d8ea43f6ce05168782d%40PELEPCDEXC017.birch.int.bell.ca%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002323.html">
   <LINK REL="Next"  HREF="002325.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Send back the correct response code</H1>
    <B>Briand, Sheldon (NRC/CNRC)</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Send%20back%20the%20correct%0A%20response%20code&In-Reply-To=%3C431f9211c3f64d8ea43f6ce05168782d%40PELEPCDEXC017.birch.int.bell.ca%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] Send back the correct response code">sheldon.briand at canada.ca
       </A><BR>
    <I>Mon Mar 27 14:28:33 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="002323.html">[Owasp-modsecurity-core-rule-set] News from the Core Rules	(2017-03-10)
</A></li>
        <LI>Next message: <A HREF="002325.html">[Owasp-modsecurity-core-rule-set] Send back the correct response code
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2324">[ date ]</a>
              <a href="thread.html#2324">[ thread ]</a>
              <a href="subject.html#2324">[ subject ]</a>
              <a href="author.html#2324">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

Still playing with this one.  I can set my status in a rule (based on the backup tomcat status) but ultimately the user sees a 403 no matter what I do.

I'm guess it is because of the default disruptive action when a deny action is in effect.  The default action is to send a 403.  I see in RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf there are ways to change the default action.

Is there a way of saying: if backend_status is XXX then set the SetRuleUpdateActionById to a relevant rule? (Is that the best way to handle what I want to do?) I assume I would do that in the RESPONSE-999-EXCLUSION conf file.

Thanks,
-Sheldon

-----Original Message-----
From: <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">folini at netnea.com</A> [mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">folini at netnea.com</A>] 
Sent: Wednesday, March 01, 2017 5:28 PM
To: Briand, Sheldon (NRC/CNRC) &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">sheldon.briand at canada.ca</A>&gt;
Cc: Christian Folini &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">christian.folini at netnea.com</A>&gt;
Subject: RE: [Owasp-modsecurity-core-rule-set] Send back the correct response code

Hey Sheldon,

Your rule work in phase 4. But in phase 4, the status header is already sent out. If you want to manipulate it, you need to do this in phase 3.

Ahoj,

Christian

&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> Thanks for the suggestions so far.  I haven't managed to make it work 
</I>&gt;<i> and just wanted to see if what I did makes sense.  (BTW backend server 
</I>&gt;<i> is
</I>&gt;<i> tomcat)
</I>&gt;<i>
</I>&gt;<i> I put the following rule in a local.conf in the rules directory:
</I>&gt;<i> SecRule RESPONSE_HEADERS:status &quot;^(.*?)$&quot;
</I>&gt;<i> &quot;phase:3,pass,id:1,setvar:tx.backend_status=%{MATCHED_VAR}&quot;
</I>&gt;<i>
</I>&gt;<i> I changed RESPONSE-959-BLOCKING-EVALUATION.conf:
</I>&gt;<i> SecRule TX:OUTBOUND_ANOMALY_SCORE &quot;@ge 
</I>&gt;<i> %{tx.outbound_anomaly_score_threshold}&quot; \
</I>&gt;<i>   &quot;phase:4,\
</I>&gt;<i>   id:959100,\
</I>&gt;<i>   tag:'anomaly-evaluation',\
</I>&gt;<i>   t:none,\
</I>&gt;<i>   deny,\
</I>&gt;<i>   status:%{TX.backend_status}&quot;
</I>&gt;<i>
</I>&gt;<i> RESPONSE-952-DATA-LEAKAGES-JAVA.conf:
</I>&gt;<i> SecRule RESPONSE_BODY &quot;@pmFromFile java-code-leakages.data&quot; \
</I>&gt;<i>         &quot;phase:4,\
</I>&gt;<i>         rev:'3',\
</I>&gt;<i>         ver:'OWASP_CRS/3.0.0',\
</I>&gt;<i>         maturity:'9',\
</I>&gt;<i>         accuracy:'9',\
</I>&gt;<i>         t:none,\
</I>&gt;<i>         capture,\
</I>&gt;<i>         ctl:auditLogParts=+E,\
</I>&gt;<i>         block,\
</I>&gt;<i>         msg:'Java Source Code Leakage',\
</I>&gt;<i>         logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}:
</I>&gt;<i> %{MATCHED_VAR}',\
</I>&gt;<i>         id:952100,\
</I>&gt;<i>         tag:'application-multi',\
</I>&gt;<i>         tag:'language-java',\
</I>&gt;<i>         tag:'platform-multi',\
</I>&gt;<i>         tag:'attack-disclosure',\
</I>&gt;<i>         tag:'OWASP_CRS/LEAKAGE/SOURCE_CODE_JAVA',\
</I>&gt;<i>         tag:'WASCTC/WASC-13',\
</I>&gt;<i>         tag:'OWASP_TOP_10/A6',\
</I>&gt;<i>         tag:'PCI/6.5.6',\
</I>&gt;<i>         severity:'ERROR',\
</I>&gt;<i>         setvar:'tx.msg=Access denied with code %{tx.backend_status}',\
</I>&gt;<i>         setvar:tx.outbound_anomaly_score=+%{tx.error_anomaly_score},\
</I>&gt;<i>         setvar:tx.anomaly_score=+%{tx.error_anomaly_score},\
</I>&gt;<i>         setvar:tx.%{rule.id}-OWASP_CRS/LEAKAGE/SOURCE_CODE-%{matched_var_name}=%{tx.0}&quot;
</I>&gt;<i>
</I>&gt;<i> I'm seeing errors like this where the status isn't passed:
</I>&gt;<i> Message: Access denied with code 403 (phase 4). Matched phrase 
</I>&gt;<i> &quot;javax.servlet&quot; a t RESPONSE_BODY. [file 
</I>&gt;<i> &quot;/etc/httpd/modsecurity.d/owasp-modsecurity-crs/rules/RES
</I>&gt;<i> PONSE-952-DATA-LEAKAGES-JAVA.conf&quot;] [line &quot;50&quot;] [id &quot;952100&quot;] [rev 
</I>&gt;<i> &quot;3&quot;] [msg &quot;Ja va Source Code Leakage&quot;] [data &quot;Matched Data: 
</I>&gt;<i> javax.servlet found within RESPONS
</I>&gt;<i> E_BODY: &lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;title&gt;Apache Tomcat/8.0.41 - Error 
</I>&gt;<i> report&lt;/t
</I>&gt;<i> itle&gt;&lt;style type=\x22text/css\x22&gt;H1
</I>&gt;<i> {font-family:Tahoma,Arial,sans-serif;color:
</I>&gt;<i> white;background-color:#525D76;font-size:22px;} H2 
</I>&gt;<i> {font-family:Tahoma,Arial,san 
</I>&gt;<i> s-serif;color:white;background-color:#525D76;font-size:16px;} H3 
</I>&gt;<i> {font-family:Ta 
</I>&gt;<i> homa,Arial,sans-serif;color:white;background-color:#525D76;font-size:1
</I>&gt;<i> 4px;}
</I>&gt;<i> BODY
</I>&gt;<i>  {font-family:Tahoma,Arial,sans-serif;color:black;background-...&quot;]
</I>&gt;<i> [severity &quot;ER
</I>&gt;<i> ROR&quot;] [ver &quot;OWASP_CRS/3.0.0&quot;] [maturity &quot;9&quot;] [accuracy &quot;9&quot;] [tag 
</I>&gt;<i> &quot;application-mu lti&quot;] [tag &quot;language-java&quot;] [tag &quot;platform-multi&quot;] 
</I>&gt;<i> [tag &quot;attack-disclosure&quot;] [ta g &quot;OWASP_CRS/LEAKAGE/SOURCE_CODE_JAVA&quot;] 
</I>&gt;<i> [tag &quot;WASCTC/WASC-13&quot;] [tag &quot;OWA
</I>&gt;<i> Message: Warning. Operator GE matched 4 at TX:outbound_anomaly_score.
</I>&gt;<i> [file &quot;/et
</I>&gt;<i> c/httpd/modsecurity.d/owasp-modsecurity-crs/rules/RESPONSE-980-CORRELATION.conf&quot;
</I>&gt;<i> ] [line &quot;82&quot;] [id &quot;980140&quot;] [msg &quot;Outbound Anomaly Score Exceeded 
</I>&gt;<i> (score
</I>&gt;<i> 4): Acc
</I>&gt;<i> ess denied with code &quot;] [tag &quot;event-correlation&quot;]
</I>&gt;<i>
</I>&gt;<i> Thanks!
</I>&gt;<i> -Sheldon
</I>&gt;<i>
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: Christian Folini [mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">christian.folini at netnea.com</A>]
</I>&gt;<i> Sent: Tuesday, February 21, 2017 4:40 PM
</I>&gt;<i> To: Briand, Sheldon (NRC/CNRC) &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">sheldon.briand at canada.ca</A>&gt;
</I>&gt;<i> Subject: Re: [Owasp-modsecurity-core-rule-set] Send back the correct 
</I>&gt;<i> response code
</I>&gt;<i>
</I>&gt;<i> Hi there,
</I>&gt;<i>
</I>&gt;<i> I see. Now I get you.
</I>&gt;<i>
</I>&gt;<i> Assuming, that the status action accepts dynamic variables as 
</I>&gt;<i> parameters, you could save the status code at the beginning of phase 3 
</I>&gt;<i> and then replace 959100 with a rule with &quot;deny,status:%{TX.backend_status}&quot;
</I>&gt;<i>
</I>&gt;<i> This might work, but I have not tested this.
</I>&gt;<i>
</I>&gt;<i> Ahoj,
</I>&gt;<i>
</I>&gt;<i> Christian
</I>&gt;<i>
</I>&gt;<i> On Tue, Feb 21, 2017 at 08:33:12PM +0000, Briand, Sheldon (NRC/CNRC)
</I>&gt;<i> wrote:
</I>&gt;&gt;<i> Hi Christian,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Sorry for not being clear.  I'm fairly new to modsecurity.  I have a 
</I>&gt;&gt;<i> reverse proxy setup.  Let's say that a legitimate request comes in.
</I>&gt;&gt;<i> That request generates an error on the backend server.  I'd like to 
</I>&gt;&gt;<i> return whatever code the backend server would have returned instead 
</I>&gt;&gt;<i> of the modsecurity 403.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks,
</I>&gt;&gt;<i> -Sheldon
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> -----Original Message-----
</I>&gt;&gt;<i> From: Christian Folini [mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">christian.folini at netnea.com</A>]
</I>&gt;&gt;<i> Sent: Tuesday, February 21, 2017 4:24 PM
</I>&gt;&gt;<i> To: Briand, Sheldon (NRC/CNRC) &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">sheldon.briand at canada.ca</A>&gt;
</I>&gt;&gt;<i> Subject: Re: [Owasp-modsecurity-core-rule-set] Send back the correct 
</I>&gt;&gt;<i> response code
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hi Sheldon,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Not sure I understand you. What is the &quot;correct&quot; error code in your 
</I>&gt;&gt;<i> question?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The incoming requests are blocked in rule 949110. That rule does a 
</I>&gt;&gt;<i> &quot;deny&quot; which defaults to 403. You can update that rule to include a 
</I>&gt;&gt;<i> different status code. If I remember correctly, it is possible to 
</I>&gt;&gt;<i> assign a variable as status code. If not, you would have to juggle a 
</I>&gt;&gt;<i> bit writing rules for individual status codes and control them via 
</I>&gt;&gt;<i> variables or something.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Doable, but a bit of work.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Ahoj,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Christian
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Tue, Feb 21, 2017 at 07:55:09PM +0000, Briand, Sheldon (NRC/CNRC)
</I>&gt;&gt;<i> wrote:
</I>&gt;&gt;<i> &gt; Hi,
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; I'm wondering how to best setup the CRS 3 rules to allow 
</I>&gt;&gt;<i> &gt; modsecurity
</I>&gt;&gt;<i> to return the correct error code in the response.  The error message 
</I>&gt;&gt;<i> I don't need just the error code that was triggered instead of a 403 
</I>&gt;&gt;<i> every time.  I am running in self-contained mode.  Is this possible?
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Thanks,
</I>&gt;&gt;<i> &gt; -Sheldon
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Sheldon Briand
</I>&gt;&gt;<i> &gt; Computer Systems and Applications Analyst National Research 
</I>&gt;&gt;<i> &gt; Council/Government of Canada 
</I>&gt;&gt;<i> &gt; <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Sheldon.briand at canada.ca</A>/&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Sheldon.briand at canada.ca</A>/&gt; Tel:
</I>&gt;&gt;<i> &gt; (902)
</I>&gt;&gt;<i> &gt; 426-1677
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; _______________________________________________
</I>&gt;&gt;<i> &gt; Owasp-modsecurity-core-rule-set mailing list 
</I>&gt;&gt;<i> &gt; <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>
</I>&gt;&gt;<i> &gt; <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rul">https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rul</A>
</I>&gt;&gt;<i> &gt; e
</I>&gt;&gt;<i> &gt; -s
</I>&gt;&gt;<i> &gt; et
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002323.html">[Owasp-modsecurity-core-rule-set] News from the Core Rules	(2017-03-10)
</A></li>
	<LI>Next message: <A HREF="002325.html">[Owasp-modsecurity-core-rule-set] Send back the correct response code
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2324">[ date ]</a>
              <a href="thread.html#2324">[ thread ]</a>
              <a href="subject.html#2324">[ subject ]</a>
              <a href="author.html#2324">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
