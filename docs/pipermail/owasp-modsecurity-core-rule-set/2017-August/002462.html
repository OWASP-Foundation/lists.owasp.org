<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] File upload problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20File%20upload%20problem&In-Reply-To=%3C20170823155512.GA2734%40arxnet.hu%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002461.html">
   <LINK REL="Next"  HREF="002463.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] File upload problem</H1>
    <B>Ervin Heged&#252;s</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20File%20upload%20problem&In-Reply-To=%3C20170823155512.GA2734%40arxnet.hu%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] File upload problem">airween at gmail.com
       </A><BR>
    <I>Wed Aug 23 15:55:12 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="002461.html">[Owasp-modsecurity-core-rule-set] File upload problem
</A></li>
        <LI>Next message: <A HREF="002463.html">[Owasp-modsecurity-core-rule-set] File upload problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2462">[ date ]</a>
              <a href="thread.html#2462">[ thread ]</a>
              <a href="subject.html#2462">[ subject ]</a>
              <a href="author.html#2462">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Chaim, and folks,

thanks for the fast reply,


On Wed, Aug 23, 2017 at 11:27:54AM -0400, Chaim Sanders wrote:
&gt;<i> Rule '200004' is provided by ModSecurity's recommended configuration file:
</I>&gt;<i> <A HREF="https://github.com/SpiderLabs/ModSecurity/blob/v2/master/modsecurity.conf-recommended#L86">https://github.com/SpiderLabs/ModSecurity/blob/v2/master/modsecurity.conf-recommended#L86</A>
</I>
yes, I'm using that :) (as recommended config),
 
&gt;<i> In some cases it may trigger FPs, when non standard multipart uploads are
</I>
sorry for my 2c's, but what does it mean &quot;FP&quot;, and what do you
mean about the &quot;standard multipart&quot;?

&gt;<i> being used. It is possible this is a bug in libmodsecurity (this would need
</I>&gt;<i> testing to verify). However if this rule is triggering, it is due to the
</I>&gt;<i> ModSecurity supplied configuration, not CRS itself. That being said, It is
</I>&gt;<i> simple enough to make an exception for, I can walk you through it if you'd
</I>&gt;<i> like. Let me know!
</I>
yes, it would be good to solve this problem. We're using
Roundcube, and it supports the GPG keys. Looks like more users
would like to use that feature (in Roundcube), but only the
keys upload doesn't work.

How can I help you to test it?

And you're right, it is due the ModSec, not CRS - I've turned
_off_ the CRS, and this still occured with &quot;native&quot; ModSec.

Sorry for that I posted it for wrong list.


Regards,


a.

&gt;<i> On Wed, Aug 23, 2017 at 11:13 AM, Ervin Heged&#252;s &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">airween at gmail.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> &gt; Hi Christian,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On Wed, Aug 23, 2017 at 09:54:32AM +0200, Christian Folini wrote:
</I>&gt;<i> &gt; &gt; Hi there,
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Is this the full &quot;H&quot; part of the Audit Log?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; yes,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; Are you sure it's not an extension filter defined on the application
</I>&gt;<i> &gt; &gt; itself?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; yes, I am sure.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; Did you try this without CRS? Without ModSec?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; without CRS _and_ with ModSec it occures, without ModSec it
</I>&gt;<i> &gt; doesn't occure.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; Just questions that mean to guide you...
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I have an idea, but may be I'm wrong...
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; audit.log shows this line:
</I>&gt;<i> &gt; ModSecurity: Warning. Matched &quot;Operator `Eq' with parameter `0' against
</I>&gt;<i> &gt; variable `MULTIPART_UNMATCHED_BOUNDARY' (Value: `1' ) [file
</I>&gt;<i> &gt; &quot;/etc/nginx/modsecurity.conf&quot;] [line &quot;66&quot;] [id &quot;200004&quot;] [rev &quot;&quot;] [msg
</I>&gt;<i> &gt; &quot;Multipart parser detected a possible unmatched boundary.&quot;] [data &quot;&quot;]
</I>&gt;<i> &gt; [severity &quot;0&quot;] [ver &quot;&quot;] [maturity &quot;0&quot;] [accuracy &quot;0&quot;] [ref &quot;v810,1&quot;]
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The id:200004 looks like this:
</I>&gt;<i> &gt; SecRule MULTIPART_UNMATCHED_BOUNDARY &quot;!@eq 0&quot; \
</I>&gt;<i> &gt; &quot;id:'200004',phase:2,t:none,log,deny,msg:'Multipart parser detected a
</I>&gt;<i> &gt; possible unmatched boundary.'&quot;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; (but this isn't in line 66 in that file).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I think the MULTIPART_UNMATCHED_BOUNDARY is a hard-coded rule,
</I>&gt;<i> &gt; which exists in libmodsecurity/ code. And may be, that function
</I>&gt;<i> &gt; parses the GPG key header (and footer) as boundary...?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Regards,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; a.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; Ahoj,
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Christian
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; On Wed, Aug 23, 2017 at 09:30:30AM +0200, Ervin Heged&#252;s wrote:
</I>&gt;<i> &gt; &gt; &gt; Hi folks,
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; here is a new problem with CRS 3.0(.2). There is an nGinx with
</I>&gt;<i> &gt; &gt; &gt; Modsecurity 3.0, and CRS 3.0.2, and an Apache backend, which
</I>&gt;<i> &gt; &gt; &gt; serves a webmail (Roundcube).
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; When I try to import my GPG key through the upload, I got 403
</I>&gt;<i> &gt; &gt; &gt; Forbidden answer.
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; Here are the details:
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; HTTP req:
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; POST <A HREF="https://webmail.mydomain.com/?_task=settings&amp;_action=plugin.">https://webmail.mydomain.com/?_task=settings&amp;_action=plugin.</A>
</I>&gt;<i> &gt; enigmakeys&amp;_a=import&amp;_unlock=loading1503472197200
</I>&gt;<i> &gt; &gt; &gt; ...
</I>&gt;<i> &gt; &gt; &gt; Content-Length      4443
</I>&gt;<i> &gt; &gt; &gt; Content-Type        multipart/form-data; boundary=---------------------
</I>&gt;<i> &gt; ------186567636118947579521451609378
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; HTTP resp:
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; 403 Forbidden
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; Content of audit.log:
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; ---3U4kCbBk---A--
</I>&gt;<i> &gt; &gt; &gt; [23/Aug/2017:09:10:32 +0200] 15034722321.000000 client.ip.addr 51048
</I>&gt;<i> &gt; client.ip.addr 443
</I>&gt;<i> &gt; &gt; &gt; ---3U4kCbBk---B--
</I>&gt;<i> &gt; &gt; &gt; POST /?_task=settings&amp;_action=plugin.enigmakeys&amp;_a=import&amp;_
</I>&gt;<i> &gt; unlock=loading1503472197200
</I>&gt;<i> &gt; &gt; &gt; HTTP/1.1
</I>&gt;<i> &gt; &gt; &gt; Connection: keep-alive
</I>&gt;<i> &gt; &gt; &gt; Referer: <A HREF="https://webmail.mydomain.com/?_task=settings&amp;_framed=1&amp;">https://webmail.mydomain.com/?_task=settings&amp;_framed=1&amp;</A>_
</I>&gt;<i> &gt; action=plugin.enigmakeys&amp;_a=import
</I>&gt;<i> &gt; &gt; &gt; Content-Type: multipart/form-data; boundary=---------------------
</I>&gt;<i> &gt; ------186567636118947579521451609378
</I>&gt;<i> &gt; &gt; &gt; Accept-Encoding: gzip, deflate, br
</I>&gt;<i> &gt; &gt; &gt; Cookie: language=hu; _ga=GA1.2.817NNNNNN.14NNNNNNNN; roundcube_sessid=sessionidtoken;
</I>&gt;<i> &gt; roundcube_sessauth=sessauthidtoken
</I>&gt;<i> &gt; &gt; &gt; Content-Length: 4443
</I>&gt;<i> &gt; &gt; &gt; Accept-Language: hu-HU,hu;q=0.8,en-US;q=0.5,en;q=0.3
</I>&gt;<i> &gt; &gt; &gt; Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;
</I>&gt;<i> &gt; q=0.8
</I>&gt;<i> &gt; &gt; &gt; User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:55.0)
</I>&gt;<i> &gt; Gecko/20100101 Firefox/55.0
</I>&gt;<i> &gt; &gt; &gt; Host: webmail.mydomain.com
</I>&gt;<i> &gt; &gt; &gt; Upgrade-Insecure-Requests: 1
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; ---3U4kCbBk---D--
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; ---3U4kCbBk---E--
</I>&gt;<i> &gt; &gt; &gt; &#179;&#201;(&#201;&#881;&#227;&#229;&#178;&#201;HML&#177;&#179;)&#201;,&#201;I&#181;310Vp&#203;/J&#202;LII&#883;
</I>&gt;<i> &gt; &gt; &gt; ...
</I>&gt;<i> &gt; &gt; &gt; ...
</I>&gt;<i> &gt; &gt; &gt; ---3U4kCbBk---F--
</I>&gt;<i> &gt; &gt; &gt; Server: nginx/1.6.2
</I>&gt;<i> &gt; &gt; &gt; Date: Wed, 23 Aug 2017 07:10:32 GMT
</I>&gt;<i> &gt; &gt; &gt; Content-Type: text/html
</I>&gt;<i> &gt; &gt; &gt; Connection: keep-alive
</I>&gt;<i> &gt; &gt; &gt; Content-Encoding: gzip
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; ---3U4kCbBk---H--
</I>&gt;<i> &gt; &gt; &gt; ModSecurity: Warning. Matched &quot;Operator `Eq' with parameter `0'
</I>&gt;<i> &gt; against variable `MULTIPART_UNMATCHED_BOUNDARY' (Value: `1' ) [file
</I>&gt;<i> &gt; &quot;/etc/nginx/modsecurity.conf&quot;] [line &quot;66&quot;] [id &quot;200004&quot;] [rev &quot;&quot;] [msg
</I>&gt;<i> &gt; &quot;Multipart parser detected a possible unmatched boundary.&quot;] [data &quot;&quot;]
</I>&gt;<i> &gt; [severity &quot;0&quot;] [ver &quot;&quot;] [maturity &quot;0&quot;] [accuracy &quot;0&quot;] [ref &quot;v810,1&quot;]
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; ---3U4kCbBk---I--
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; ---3U4kCbBk---J--
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; ---3U4kCbBk---Z--
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; Here is the detail of POST request:
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; -----------------------------186567636118947579521451609378
</I>&gt;<i> &gt; &gt; &gt; Content-Disposition: form-data; name=&quot;_token&quot;
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; nEWGe3VUF9R1K7d0SSx4rZRYkYeN849B
</I>&gt;<i> &gt; &gt; &gt; -----------------------------186567636118947579521451609378
</I>&gt;<i> &gt; &gt; &gt; Content-Disposition: form-data; name=&quot;_framed&quot;
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; 1
</I>&gt;<i> &gt; &gt; &gt; -----------------------------186567636118947579521451609378
</I>&gt;<i> &gt; &gt; &gt; Content-Disposition: form-data; name=&quot;_file&quot;;
</I>&gt;<i> &gt; filename=&quot;airween_at_gmail.com.asc&quot;
</I>&gt;<i> &gt; &gt; &gt; Content-Type: text/plain
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; -----BEGIN PGP PUBLIC KEY BLOCK-----
</I>&gt;<i> &gt; &gt; &gt; Version: GnuPG v1
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; mQINBFhwuigBEAC+gnmOXXTEtedn5hqcjLirPM6phHGLdeqVUsD0sRDWFjgcoh7b
</I>&gt;<i> &gt; &gt; &gt; ...
</I>&gt;<i> &gt; &gt; &gt; =G+Dl
</I>&gt;<i> &gt; &gt; &gt; -----END PGP PUBLIC KEY BLOCK-----
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; -----------------------------186567636118947579521451609378
</I>&gt;<i> &gt; &gt; &gt; Content-Disposition: form-data; name=&quot;_search&quot;
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; -----------------------------186567636118947579521451609378--
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; This error occures when I upload the .asc file above, when I try
</I>&gt;<i> &gt; &gt; &gt; to upload a &quot;simple&quot; csv, or png, everything works as well.
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; What should I do? How can I fix this error?
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; Thanks,
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; a.
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; _______________________________________________
</I>&gt;<i> &gt; &gt; &gt; Owasp-modsecurity-core-rule-set mailing list
</I>&gt;<i> &gt; &gt; &gt; <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>
</I>&gt;<i> &gt; &gt; &gt; <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-">https://lists.owasp.org/mailman/listinfo/owasp-</A>
</I>&gt;<i> &gt; modsecurity-core-rule-set
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; --
</I>&gt;<i> &gt; &gt; ModSecurity courses Oct 2017 in London and Zurich
</I>&gt;<i> &gt; &gt; <A HREF="https://www.feistyduck.com/training/modsecurity-training-course">https://www.feistyduck.com/training/modsecurity-training-course</A>
</I>&gt;<i> &gt; &gt; <A HREF="https://www.feistyduck.com/books/modsecurity-handbook/">https://www.feistyduck.com/books/modsecurity-handbook/</A>
</I>&gt;<i> &gt; &gt; mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">christian.folini at netnea.com</A>
</I>&gt;<i> &gt; &gt; twitter: @ChrFolini
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; Owasp-modsecurity-core-rule-set mailing list
</I>&gt;<i> &gt; <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>
</I>&gt;<i> &gt; <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set</A>
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> -- 
</I>&gt;<i> -- 
</I>&gt;<i> Chaim Sanders
</I>&gt;<i> <A HREF="http://www.ChaimSanders.com">http://www.ChaimSanders.com</A>
</I></PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002461.html">[Owasp-modsecurity-core-rule-set] File upload problem
</A></li>
	<LI>Next message: <A HREF="002463.html">[Owasp-modsecurity-core-rule-set] File upload problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2462">[ date ]</a>
              <a href="thread.html#2462">[ thread ]</a>
              <a href="subject.html#2462">[ subject ]</a>
              <a href="author.html#2462">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
