<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Run core rule set on just one page / parameter
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Run%20core%20rule%20set%20on%20just%20one%0A%20page%20/%20parameter&In-Reply-To=%3CCAAO0q_FADMiL-iNHYCDAmE7wMyuGv3Tc%3Dw4jKADB%3DSEyCKG3BQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002437.html">
   <LINK REL="Next"  HREF="002442.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Run core rule set on just one page / parameter</H1>
    <B>Kirk Jackson</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Run%20core%20rule%20set%20on%20just%20one%0A%20page%20/%20parameter&In-Reply-To=%3CCAAO0q_FADMiL-iNHYCDAmE7wMyuGv3Tc%3Dw4jKADB%3DSEyCKG3BQ%40mail.gmail.com%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] Run core rule set on just one page / parameter">kirk at pageofwords.com
       </A><BR>
    <I>Tue Aug 15 09:12:37 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="002437.html">[Owasp-modsecurity-core-rule-set] Run core rule set on just one page / parameter
</A></li>
        <LI>Next message: <A HREF="002442.html">[Owasp-modsecurity-core-rule-set] Run core rule set on just one page / parameter
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2440">[ date ]</a>
              <a href="thread.html#2440">[ thread ]</a>
              <a href="subject.html#2440">[ subject ]</a>
              <a href="author.html#2440">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Great! Thanks Christian!

I did try and figure out what was going on with the higher debug log
levels, but didn't realise that was what was happening.

I think by &quot;steering commando rules&quot; you mean the rules that check which
paranoia level is set, and then jump to the marker at the end of the file?

e.g. SecRule TX:PARANOIA_LEVEL &quot;@lt 1&quot;
&quot;phase:1,id:942011,nolog,pass,skipAfter:END-REQUEST-942-APPLICATION-ATTACK-SQLI&quot;



In the SQLi include file, these rules are all numbered 942011-18, so I
changed the rules to only alter the rules from 942100-942999.

The following config then works!

Include modsecurity/crs-setup.conf
Include crs/*.conf

# Disable CRS's SQLi rules:
SecRuleUpdateTargetByID 942100-942999 &quot;!REQUEST_COOKIES&quot;
SecRuleUpdateTargetByID 942100-942999 &quot;!REQUEST_COOKIES_NAMES&quot;
SecRuleUpdateTargetByID 942100-942999 &quot;!ARGS_NAMES&quot;
SecRuleUpdateTargetByID 942100-942999 &quot;!ARGS&quot;
SecRuleUpdateTargetByID 942100-942999 &quot;!XML&quot;

# Only test SQLi for the SearchTerm parameter
SecRuleUpdateTargetByID 942100-942999 &quot;ARGS:SearchTerm&quot;

After this, the SQLi rules are disabled for all cookies, arguments and XML,
and then only re-enabled for my one parameter name.


Next, I attempted to do this at runtime, so I could apply the rules to only
my particular page:

SecRule REQUEST_FILENAME &quot;@beginsWith /product/search&quot; \
    &quot;id:2011,phase:2,\
        pass,nolog,\
        t:none,t:lowercase,t:normalisePath,\
        ctl:ruleUpdateTargetById=942100-942999;ARGS:SearchTerm&quot;



However, the ctl:ruleUpdateTargetById action doesn't work - I was lead
astray by the Mod Security Handbook, which is a bit out of date (at this
url:
<A HREF="https://www.feistyduck.com/library/modsecurity-handbook-2ed/online/xx1-directives.html#N15992">https://www.feistyduck.com/library/modsecurity-handbook-2ed/online/xx1-directives.html#N15992</A>).
It looks like that got removed:

Note : There was a ctl:ruleUpdateTargetById introduced in 2.6.0 and removed
from the code in 2.7.0. JSON was added as part of v2.8.0-rc1
(from <A HREF="https://github.com/SpiderLabs/ModSecurity/wiki/Reference-Manual#ctl">https://github.com/SpiderLabs/ModSecurity/wiki/Reference-Manual#ctl</A>)


If you have any ideas on how to further restrict it so I can rule the SQLi
rules for only one page + parameter combo, I'm interested to know!

Thanks,

Kirk


On Tue, Aug 15, 2017 at 7:10 PM, Christian Folini &lt;
<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">christian.folini at netnea.com</A>&gt; wrote:

&gt;<i> Kirk,
</I>&gt;<i>
</I>&gt;<i> This is a tricky one. Actually your recipe should work. But then it does
</I>&gt;<i> not. I dug a bit deeper and found out an issue.
</I>&gt;<i>
</I>&gt;<i> SecRuleUpdateTargetByID 942000-942999 &quot;ARGS:SearchTerm&quot;
</I>&gt;<i>
</I>&gt;<i> adds the arg SearchTerm to all rules including steering commando rules
</I>&gt;<i> used for Paranoia Levels. And this seems to f**k them up. At least this
</I>&gt;<i> is my first impression.
</I>&gt;<i>
</I>&gt;<i> Could you try and apply the Update only to those rules that really
</I>&gt;<i> apply and report back?
</I>&gt;<i>
</I>&gt;<i> There might be a deeper issue here, so let's try and work together
</I>&gt;<i> to find a good recipe to solve your use case - which is actually a very
</I>&gt;<i> useful one.
</I>&gt;<i>
</I>&gt;<i> Ahoj,
</I>&gt;<i>
</I>&gt;<i> Christian
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Mon, Aug 14, 2017 at 10:03:15AM +1200, Kirk Jackson wrote:
</I>&gt;<i> &gt; Hi,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I'd like to run the SQLi checks on only the one parameter on my site that
</I>&gt;<i> &gt; is vulnerable to those attacks.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I was wondering if there's a pattern to do this, or if I need to copy the
</I>&gt;<i> &gt; rules from REQUEST-942-APPLICATION-ATTACK-SQLI.conf into my own file,
</I>&gt;<i> and
</I>&gt;<i> &gt; change the variables to my ARGS:ParamName?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I tried doing this, to disable the rules, and then re-enable for just my
</I>&gt;<i> &gt; param, but that didn't work:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; SecRuleUpdateTargetByID 942000-942999 &quot;!REQUEST_COOKIES&quot;
</I>&gt;<i> &gt; SecRuleUpdateTargetByID 942000-942999 &quot;!REQUEST_COOKIES_NAMES&quot;
</I>&gt;<i> &gt; SecRuleUpdateTargetByID 942000-942999 &quot;!ARGS_NAMES&quot;
</I>&gt;<i> &gt; SecRuleUpdateTargetByID 942000-942999 &quot;!ARGS&quot;
</I>&gt;<i> &gt; SecRuleUpdateTargetByID 942000-942999 &quot;!XML&quot;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; SecRuleUpdateTargetByID 942000-942999 &quot;ARGS:SearchTerm&quot;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Many thanks!
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Kirk
</I>&gt;<i>
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; Owasp-modsecurity-core-rule-set mailing list
</I>&gt;<i> &gt; <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>
</I>&gt;<i> &gt; <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> <A HREF="https://www.feistyduck.com/books/modsecurity-handbook/">https://www.feistyduck.com/books/modsecurity-handbook/</A>
</I>&gt;<i> mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">christian.folini at netnea.com</A>
</I>&gt;<i> twitter: @ChrFolini
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20170815/6f8d1896/attachment-0001.html">http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20170815/6f8d1896/attachment-0001.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002437.html">[Owasp-modsecurity-core-rule-set] Run core rule set on just one page / parameter
</A></li>
	<LI>Next message: <A HREF="002442.html">[Owasp-modsecurity-core-rule-set] Run core rule set on just one page / parameter
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2440">[ date ]</a>
              <a href="thread.html#2440">[ thread ]</a>
              <a href="subject.html#2440">[ subject ]</a>
              <a href="author.html#2440">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
