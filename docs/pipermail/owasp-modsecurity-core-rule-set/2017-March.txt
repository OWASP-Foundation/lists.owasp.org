From ehsan.mahdavi at gmail.com  Tue Mar  7 15:27:29 2017
From: ehsan.mahdavi at gmail.com (Ehsan Mahdavi)
Date: Tue, 7 Mar 2017 18:57:29 +0330
Subject: [Owasp-modsecurity-core-rule-set] Rule 951100 is corrupted
Message-ID: <CAC7V=myBM3uy5M2_DY9BnEj5EE8Q3_k-nzTdf-e6po6e3UB2aA@mail.gmail.com>

Hi All
Rule 951100 in CRS 3 is not working.

be careful with that.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20170307/08155a7c/attachment.html>

From christian.folini at netnea.com  Tue Mar  7 16:16:29 2017
From: christian.folini at netnea.com (Christian Folini)
Date: Tue, 7 Mar 2017 17:16:29 +0100
Subject: [Owasp-modsecurity-core-rule-set] Rule 951100 is corrupted
In-Reply-To: <CAC7V=myBM3uy5M2_DY9BnEj5EE8Q3_k-nzTdf-e6po6e3UB2aA@mail.gmail.com>
References: <CAC7V=myBM3uy5M2_DY9BnEj5EE8Q3_k-nzTdf-e6po6e3UB2aA@mail.gmail.com>
Message-ID: <20170307161629.vz6wxedubzgmxojw@leander>

Hi there,

Ooops. What is the problem? Here is the rule in question?

SecRule RESPONSE_BODY "@pmFromFile sql-errors.data" \
        "phase:response,\
        id:951100,\
        rev:'5',\
        ver:'OWASP_CRS/3.0.0',\
        pass,\
        nolog,\
        tag:'application-multi',\
        tag:'language-multi',\
        tag:'platform-multi',\
        tag:'attack-disclosure',\
        setvar:tx.sql_error_match=1,\
        t:none"

Is there something wrong with the mechanism or have you found an
sql-error not being listed in the data file? The latter is very well
possible and we would welcome submissions of additional error strings.

Ahoj,

Christian


On Tue, Mar 07, 2017 at 06:57:29PM +0330, Ehsan Mahdavi wrote:
> Hi All
> Rule 951100 in CRS 3 is not working.
> 
> be careful with that.

> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set


From christian.folini at netnea.com  Tue Mar  7 21:36:59 2017
From: christian.folini at netnea.com (Christian Folini)
Date: Tue, 7 Mar 2017 22:36:59 +0100
Subject: [Owasp-modsecurity-core-rule-set] Rule 951100 is corrupted
In-Reply-To: <CAC7V=myGDmn_WTK3ujzvNsU1G4076y6Fk9hCKB8B_ae4aRT-1Q@mail.gmail.com>
References: <CAC7V=myBM3uy5M2_DY9BnEj5EE8Q3_k-nzTdf-e6po6e3UB2aA@mail.gmail.com>
	<20170307161629.vz6wxedubzgmxojw@leander>
	<CAC7V=myGDmn_WTK3ujzvNsU1G4076y6Fk9hCKB8B_ae4aRT-1Q@mail.gmail.com>
Message-ID: <20170307213659.dz3b7qrfvb3xlifg@leander>

Ehsan,

On Tue, Mar 07, 2017 at 09:43:39PM +0330, Ehsan Mahdavi wrote:
> It does nothing
> It doesn't increment any inbound scores
> So if you use anomaly mechanism nothing will happen.

No, that is not correct.

If you examine it, you will notice that the rule 951100
sets the variable sql_error_match. The remaining rules in
the 951xxx group use this variable and link it to an information
about the DBMS used by the backend.

> On the other hand,  sql-error.data file contains general terms like "error"
> and "warning". If the rule works, it will generate tons of false positives.

Again, this has to be seen in the light of the following rules.
"Error" is not enough. It takes "Error" in combination with a string
like "JET Database Engine". And if you have "Error" in combination
with a DB engine, then I think it is a real positive and the
response should be blocked.

Did I convince you? If not, please explain where I make a mistake
in my thinking. An example response with an error ignored by CRS
(-> false negative) or a false positive would really help.

Ahoj,

Christian



> 
> On Tuesday, March 7, 2017, Christian Folini <christian.folini at netnea.com>
> wrote:
> 
> > Hi there,
> >
> > Ooops. What is the problem? Here is the rule in question?
> >
> > SecRule RESPONSE_BODY "@pmFromFile sql-errors.data" \
> >         "phase:response,\
> >         id:951100,\
> >         rev:'5',\
> >         ver:'OWASP_CRS/3.0.0',\
> >         pass,\
> >         nolog,\
> >         tag:'application-multi',\
> >         tag:'language-multi',\
> >         tag:'platform-multi',\
> >         tag:'attack-disclosure',\
> >         setvar:tx.sql_error_match=1,\
> >         t:none"
> >
> > Is there something wrong with the mechanism or have you found an
> > sql-error not being listed in the data file? The latter is very well
> > possible and we would welcome submissions of additional error strings.
> >
> > Ahoj,
> >
> > Christian
> >
> >
> > On Tue, Mar 07, 2017 at 06:57:29PM +0330, Ehsan Mahdavi wrote:
> > > Hi All
> > > Rule 951100 in CRS 3 is not working.
> > >
> > > be careful with that.
> >
> > > _______________________________________________
> > > Owasp-modsecurity-core-rule-set mailing list
> > > Owasp-modsecurity-core-rule-set at lists.owasp.org <javascript:;>
> > > https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
> >
> > _______________________________________________
> > Owasp-modsecurity-core-rule-set mailing list
> > Owasp-modsecurity-core-rule-set at lists.owasp.org <javascript:;>
> > https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
> >
> 
> 
> -- 
>                     regards
>                  Ehsan.Mahdavi
> PhD candidated for Computer Engineering
>     by Isfahan University of Technology
>         http://emahdavi.ece.iut.ac.ir/

From christian.folini at netnea.com  Fri Mar 10 12:54:36 2017
From: christian.folini at netnea.com (Christian Folini)
Date: Fri, 10 Mar 2017 13:54:36 +0100
Subject: [Owasp-modsecurity-core-rule-set] News from the Core Rules
	(2017-03-10)
Message-ID: <20170310125436.geawxyyb4gqlihs7@leander>


Dear all,

In late 2016 I sent two messages with news from the Core Rule Set
Project.  Lately we had a developer meeting on IRC and we decided to
make this a regular newsletter, aiming for a once a month publication.

What has happened during the last few weeks:

- Project lead Chaim Sanders, Walter Hop and I met on IRC and we decided
  to run regular IRC meetings about CRS. The gatherings are for those
  interested in the development of the project and the rules.
  These meetings will happen once a month on the first Monday at
  20:30 MET (14:30 EST, 19:30 GMT) on Freenode IRC, channel #modsecurity
  The dates for 2017 are thus:
  April 3, 2017, 20:30 MET
  May 1, 2017, 20:30 MET
  June 5, 2017, 20:30 MET
  Jul 3, 2017, 20:30 MET
  Aug 7, 2017, 20:30 MET
  Sep 4, 2017, 20:30 MET
  Oct 2, 2017, 20:30 MET
  Nov 6, 2017, 20:30 MET
  Dec 4, 2017, 20:30 MET

- The weeding out of false positives in v3.0.0 has started. We aim to
  cover the lower paranoia levels as far as possible and issue a 3.0.1
  in the next two months; possibly without closing _all_ known false
  positives.
  https://github.com/SpiderLabs/owasp-modsecurity-crs

- Angelo Conforti published a pair of modsec-replay scripts. The client
  script takes an audit log entry and fires the request against a
  server.  The server script advertises a listener. It looks up the
  requests it receives in the audit log and responds with the
  appropriate response.  This allows for the testing of rule set changes
  with a mock backend with correct responses. The identification of the
  corresponding answer to a request works via a hash submitted as a HTTP
  request header.  Please give it a spin and let us know if it works for
  you.
  https://github.com/angeloxx/modsec-replay

- There is going to be a CRS3 introduction talk at the OWASP AppSecEU
  conference in Belfast. The conference takes place May 11/12, 2017.
  https://2017.appsec.eu

- Chaim also submitted two talks to AppSecEU. But it is not yet sure if
  he is accepted as a speaker or not with one of these submissions.

- Chaim and I (Christian speaking here) will attend the AppSecEU
  conference and we hope to meet other members of the community and Core
  Rule Set users. In fact Chaim and I have never met before, so we have
  something to celebrate after our arrival; likely May 9 or 10.
 
- We also want to use the opportunity and organise a CRS summit at
  AppSecEU.  That is going to be a meeting where we will talk CRS with
  users and ideally also the vendors using ModSecurity Core Rule Set as
  part of their products.  The date is not yet fixed, but May 10 sounds
  like a good choice.  We will try and get in touch with vendors
  individually, but if you read this, then please take note. We want to
  meet you and have a chat over the Core Rule Set and it's future. We
  are interested in your experience, your issues and how you use the
  Core Rule Set. This is not a "We need corporate sponsors" event.  It's
  an event meant to get to know each other, talk CRS and drink a few
  beers afterwards.

- Typo3 security team member Adrian von Arx joined with me to look into
  default Rule Exclusions for Typo3. The idea is to develop a similar
  set of optional Rule Exclusions that we have for Wordpress and Drupal.
  https://www.netnea.com/cms/2017/01/13/starting-to-build-a-set-of-rule-exclusions-or-typo3/

- Damiano Esposito from the University of Applied Sciences in Zurich is
  conducting an extensive number of tests with various Security Scanners
  targetting a vulnerable Application protected by CRS3 at various
  paranoia levels.  The first test runs look promising.  I have written
  a blog post detailing the ModSecurity CRS3 setup.
  https://www.netnea.com/cms/2017/02/24/optimized-lab-setup-to-attack-modsecurity-with-security-sanners/

- In December, I talked about a paywalled Core Rule Set article at
  LinuxWeeklyNews.  Said article is now freely available and brings an
  overview of CRS3 aimed at new users.
  https://lwn.net/Articles/709693/

- We have a lot of open issues on github thanks to dozens of feature
  requests for CRS 3.1 and beyond. This makes it somewhat hard to
  navigate the issues.  In order to help you find your way around, there
  is now a set of shortcuts to individual queries.
  https://www.owasp.org/index.php/Category:OWASP_ModSecurity_Core_Rule_Set_Project#tab=Getting_Involved
  The shortcuts involve:
  - Open Issues 3.0.x
  - False Positives
  - False Negatives
  - Feature Requests for 3.1
  - Published research affecting project
  - Open Issues without a label / tag
  - Open Issues with a label, but without assignee
  - Open Issues before 2015
  - Open Issues before 2016
  - Open Issues before 2017

- And finally, let me remind you of a neat service at netnea.com which
  brings you information about individual rules and links to the
  definition of the rule. Here is an example:
  https://www.netnea.com/crs/949110 
  
  If your browser supports smart bookmarks (Firefox does), then you can
  define one as follows:
  https://www.netnea.com/crs/%s with keyword crs and then call it with
  lookup like "crs 949110" in the address bar of the browser.
  Very helpful and I use this several time as day.
  I also plan to expand the information displayed in this list. What
  are the bits of infos that you think should be included? Please
  respond on the list or in private.


What's coming in the next few weeks:

- Damiano and I hope to give you a sneek preview of some research
  results.
- We're closing false positives based on the issues reported on github.
- More details of the CRS summit at AppSecEU will be defined and
  published.
- Next CRS3 chat: April 3, 2017, 20:30 MET on Freenode IRC, channel
  #modsecurity (14:30 EST, 19:30 GMT) 

So this is it for the first CRS newsletter. If I missed something,
please let me know. Feedback - good and bad - is much appreciated (which
means: If you like this, then please let me know and share 
this message).

Best regards,

Christian Folini, for the OWASP ModSecurity Core Rule Set team

-- 
CRS website: https://www.modsecurity.org/crs
CRS at OWASP: https://www.owasp.org/index.php/Category:OWASP_ModSecurity_Core_Rule_Set_Project
CRS tutorials: https://netnea.com/apache-tutorials

From sheldon.briand at canada.ca  Mon Mar 27 14:28:33 2017
From: sheldon.briand at canada.ca (Briand, Sheldon (NRC/CNRC))
Date: Mon, 27 Mar 2017 14:28:33 +0000
Subject: [Owasp-modsecurity-core-rule-set] Send back the correct
 response code
In-Reply-To: <2650164594ce58895aa7d58a90288b06.squirrel@para.netnea.com>
References: <201702211955.v1LJtFAC003968@lists.owasp.org>
	<20170221202407.GB3060@rufus>
	<20170221203319.46B8440066@mail.netnea.com>
	<20170221203950.GA3540@rufus>
	<20170301191739.116224006B@mail.netnea.com>
	<2650164594ce58895aa7d58a90288b06.squirrel@para.netnea.com>
Message-ID: <431f9211c3f64d8ea43f6ce05168782d@PELEPCDEXC017.birch.int.bell.ca>

Hi,

Still playing with this one.  I can set my status in a rule (based on the backup tomcat status) but ultimately the user sees a 403 no matter what I do.

I'm guess it is because of the default disruptive action when a deny action is in effect.  The default action is to send a 403.  I see in RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf there are ways to change the default action.

Is there a way of saying: if backend_status is XXX then set the SetRuleUpdateActionById to a relevant rule? (Is that the best way to handle what I want to do?) I assume I would do that in the RESPONSE-999-EXCLUSION conf file.

Thanks,
-Sheldon

-----Original Message-----
From: folini at netnea.com [mailto:folini at netnea.com] 
Sent: Wednesday, March 01, 2017 5:28 PM
To: Briand, Sheldon (NRC/CNRC) <sheldon.briand at canada.ca>
Cc: Christian Folini <christian.folini at netnea.com>
Subject: RE: [Owasp-modsecurity-core-rule-set] Send back the correct response code

Hey Sheldon,

Your rule work in phase 4. But in phase 4, the status header is already sent out. If you want to manipulate it, you need to do this in phase 3.

Ahoj,

Christian

> Hi,
>
> Thanks for the suggestions so far.  I haven't managed to make it work 
> and just wanted to see if what I did makes sense.  (BTW backend server 
> is
> tomcat)
>
> I put the following rule in a local.conf in the rules directory:
> SecRule RESPONSE_HEADERS:status "^(.*?)$"
> "phase:3,pass,id:1,setvar:tx.backend_status=%{MATCHED_VAR}"
>
> I changed RESPONSE-959-BLOCKING-EVALUATION.conf:
> SecRule TX:OUTBOUND_ANOMALY_SCORE "@ge 
> %{tx.outbound_anomaly_score_threshold}" \
>   "phase:4,\
>   id:959100,\
>   tag:'anomaly-evaluation',\
>   t:none,\
>   deny,\
>   status:%{TX.backend_status}"
>
> RESPONSE-952-DATA-LEAKAGES-JAVA.conf:
> SecRule RESPONSE_BODY "@pmFromFile java-code-leakages.data" \
>         "phase:4,\
>         rev:'3',\
>         ver:'OWASP_CRS/3.0.0',\
>         maturity:'9',\
>         accuracy:'9',\
>         t:none,\
>         capture,\
>         ctl:auditLogParts=+E,\
>         block,\
>         msg:'Java Source Code Leakage',\
>         logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}:
> %{MATCHED_VAR}',\
>         id:952100,\
>         tag:'application-multi',\
>         tag:'language-java',\
>         tag:'platform-multi',\
>         tag:'attack-disclosure',\
>         tag:'OWASP_CRS/LEAKAGE/SOURCE_CODE_JAVA',\
>         tag:'WASCTC/WASC-13',\
>         tag:'OWASP_TOP_10/A6',\
>         tag:'PCI/6.5.6',\
>         severity:'ERROR',\
>         setvar:'tx.msg=Access denied with code %{tx.backend_status}',\
>         setvar:tx.outbound_anomaly_score=+%{tx.error_anomaly_score},\
>         setvar:tx.anomaly_score=+%{tx.error_anomaly_score},\
>         setvar:tx.%{rule.id}-OWASP_CRS/LEAKAGE/SOURCE_CODE-%{matched_var_name}=%{tx.0}"
>
> I'm seeing errors like this where the status isn't passed:
> Message: Access denied with code 403 (phase 4). Matched phrase 
> "javax.servlet" a t RESPONSE_BODY. [file 
> "/etc/httpd/modsecurity.d/owasp-modsecurity-crs/rules/RES
> PONSE-952-DATA-LEAKAGES-JAVA.conf"] [line "50"] [id "952100"] [rev 
> "3"] [msg "Ja va Source Code Leakage"] [data "Matched Data: 
> javax.servlet found within RESPONS
> E_BODY: <!DOCTYPE html><html><head><title>Apache Tomcat/8.0.41 - Error 
> report</t
> itle><style type=\x22text/css\x22>H1
> {font-family:Tahoma,Arial,sans-serif;color:
> white;background-color:#525D76;font-size:22px;} H2 
> {font-family:Tahoma,Arial,san 
> s-serif;color:white;background-color:#525D76;font-size:16px;} H3 
> {font-family:Ta 
> homa,Arial,sans-serif;color:white;background-color:#525D76;font-size:1
> 4px;}
> BODY
>  {font-family:Tahoma,Arial,sans-serif;color:black;background-..."]
> [severity "ER
> ROR"] [ver "OWASP_CRS/3.0.0"] [maturity "9"] [accuracy "9"] [tag 
> "application-mu lti"] [tag "language-java"] [tag "platform-multi"] 
> [tag "attack-disclosure"] [ta g "OWASP_CRS/LEAKAGE/SOURCE_CODE_JAVA"] 
> [tag "WASCTC/WASC-13"] [tag "OWA
> Message: Warning. Operator GE matched 4 at TX:outbound_anomaly_score.
> [file "/et
> c/httpd/modsecurity.d/owasp-modsecurity-crs/rules/RESPONSE-980-CORRELATION.conf"
> ] [line "82"] [id "980140"] [msg "Outbound Anomaly Score Exceeded 
> (score
> 4): Acc
> ess denied with code "] [tag "event-correlation"]
>
> Thanks!
> -Sheldon
>
> -----Original Message-----
> From: Christian Folini [mailto:christian.folini at netnea.com]
> Sent: Tuesday, February 21, 2017 4:40 PM
> To: Briand, Sheldon (NRC/CNRC) <sheldon.briand at canada.ca>
> Subject: Re: [Owasp-modsecurity-core-rule-set] Send back the correct 
> response code
>
> Hi there,
>
> I see. Now I get you.
>
> Assuming, that the status action accepts dynamic variables as 
> parameters, you could save the status code at the beginning of phase 3 
> and then replace 959100 with a rule with "deny,status:%{TX.backend_status}"
>
> This might work, but I have not tested this.
>
> Ahoj,
>
> Christian
>
> On Tue, Feb 21, 2017 at 08:33:12PM +0000, Briand, Sheldon (NRC/CNRC)
> wrote:
>> Hi Christian,
>>
>> Sorry for not being clear.  I'm fairly new to modsecurity.  I have a 
>> reverse proxy setup.  Let's say that a legitimate request comes in.
>> That request generates an error on the backend server.  I'd like to 
>> return whatever code the backend server would have returned instead 
>> of the modsecurity 403.
>>
>> Thanks,
>> -Sheldon
>>
>> -----Original Message-----
>> From: Christian Folini [mailto:christian.folini at netnea.com]
>> Sent: Tuesday, February 21, 2017 4:24 PM
>> To: Briand, Sheldon (NRC/CNRC) <sheldon.briand at canada.ca>
>> Subject: Re: [Owasp-modsecurity-core-rule-set] Send back the correct 
>> response code
>>
>> Hi Sheldon,
>>
>> Not sure I understand you. What is the "correct" error code in your 
>> question?
>>
>> The incoming requests are blocked in rule 949110. That rule does a 
>> "deny" which defaults to 403. You can update that rule to include a 
>> different status code. If I remember correctly, it is possible to 
>> assign a variable as status code. If not, you would have to juggle a 
>> bit writing rules for individual status codes and control them via 
>> variables or something.
>>
>> Doable, but a bit of work.
>>
>> Ahoj,
>>
>> Christian
>>
>>
>> On Tue, Feb 21, 2017 at 07:55:09PM +0000, Briand, Sheldon (NRC/CNRC)
>> wrote:
>> > Hi,
>> >
>> > I'm wondering how to best setup the CRS 3 rules to allow 
>> > modsecurity
>> to return the correct error code in the response.  The error message 
>> I don't need just the error code that was triggered instead of a 403 
>> every time.  I am running in self-contained mode.  Is this possible?
>> >
>> > Thanks,
>> > -Sheldon
>> >
>> >
>> > Sheldon Briand
>> > Computer Systems and Applications Analyst National Research 
>> > Council/Government of Canada 
>> > Sheldon.briand at canada.ca/<mailto:Sheldon.briand at canada.ca/> Tel:
>> > (902)
>> > 426-1677
>> >
>>
>> > _______________________________________________
>> > Owasp-modsecurity-core-rule-set mailing list 
>> > Owasp-modsecurity-core-rule-set at lists.owasp.org
>> > https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rul
>> > e
>> > -s
>> > et
>>
>



From christian.folini at netnea.com  Tue Mar 28 11:22:33 2017
From: christian.folini at netnea.com (Christian Folini)
Date: Tue, 28 Mar 2017 13:22:33 +0200
Subject: [Owasp-modsecurity-core-rule-set] Send back the correct
 response code
In-Reply-To: <431f9211c3f64d8ea43f6ce05168782d@PELEPCDEXC017.birch.int.bell.ca>
References: <201702211955.v1LJtFAC003968@lists.owasp.org>
	<20170221202407.GB3060@rufus>
	<20170221203319.46B8440066@mail.netnea.com>
	<20170221203950.GA3540@rufus>
	<20170301191739.116224006B@mail.netnea.com>
	<2650164594ce58895aa7d58a90288b06.squirrel@para.netnea.com>
	<431f9211c3f64d8ea43f6ce05168782d@PELEPCDEXC017.birch.int.bell.ca>
Message-ID: <20170328112233.zri2kilshixqlexq@leander>

Sheldon,

The default action does not really matter much in this regard. You
can oversteer it in your rules. I really do not see the issue.

Somebody else understands the problem correctly?

Ahoj,

Christian

On Mon, Mar 27, 2017 at 02:28:33PM +0000, Briand, Sheldon (NRC/CNRC) wrote:
> Hi,
> 
> Still playing with this one.  I can set my status in a rule (based on the backup tomcat status) but ultimately the user sees a 403 no matter what I do.
> 
> I'm guess it is because of the default disruptive action when a deny action is in effect.  The default action is to send a 403.  I see in RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf there are ways to change the default action.
> 
> Is there a way of saying: if backend_status is XXX then set the SetRuleUpdateActionById to a relevant rule? (Is that the best way to handle what I want to do?) I assume I would do that in the RESPONSE-999-EXCLUSION conf file.
> 
> Thanks,
> -Sheldon
> 
> -----Original Message-----
> From: folini at netnea.com [mailto:folini at netnea.com] 
> Sent: Wednesday, March 01, 2017 5:28 PM
> To: Briand, Sheldon (NRC/CNRC) <sheldon.briand at canada.ca>
> Cc: Christian Folini <christian.folini at netnea.com>
> Subject: RE: [Owasp-modsecurity-core-rule-set] Send back the correct response code
> 
> Hey Sheldon,
> 
> Your rule work in phase 4. But in phase 4, the status header is already sent out. If you want to manipulate it, you need to do this in phase 3.
> 
> Ahoj,
> 
> Christian
> 
> > Hi,
> >
> > Thanks for the suggestions so far.  I haven't managed to make it work 
> > and just wanted to see if what I did makes sense.  (BTW backend server 
> > is
> > tomcat)
> >
> > I put the following rule in a local.conf in the rules directory:
> > SecRule RESPONSE_HEADERS:status "^(.*?)$"
> > "phase:3,pass,id:1,setvar:tx.backend_status=%{MATCHED_VAR}"
> >
> > I changed RESPONSE-959-BLOCKING-EVALUATION.conf:
> > SecRule TX:OUTBOUND_ANOMALY_SCORE "@ge 
> > %{tx.outbound_anomaly_score_threshold}" \
> >   "phase:4,\
> >   id:959100,\
> >   tag:'anomaly-evaluation',\
> >   t:none,\
> >   deny,\
> >   status:%{TX.backend_status}"
> >
> > RESPONSE-952-DATA-LEAKAGES-JAVA.conf:
> > SecRule RESPONSE_BODY "@pmFromFile java-code-leakages.data" \
> >         "phase:4,\
> >         rev:'3',\
> >         ver:'OWASP_CRS/3.0.0',\
> >         maturity:'9',\
> >         accuracy:'9',\
> >         t:none,\
> >         capture,\
> >         ctl:auditLogParts=+E,\
> >         block,\
> >         msg:'Java Source Code Leakage',\
> >         logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}:
> > %{MATCHED_VAR}',\
> >         id:952100,\
> >         tag:'application-multi',\
> >         tag:'language-java',\
> >         tag:'platform-multi',\
> >         tag:'attack-disclosure',\
> >         tag:'OWASP_CRS/LEAKAGE/SOURCE_CODE_JAVA',\
> >         tag:'WASCTC/WASC-13',\
> >         tag:'OWASP_TOP_10/A6',\
> >         tag:'PCI/6.5.6',\
> >         severity:'ERROR',\
> >         setvar:'tx.msg=Access denied with code %{tx.backend_status}',\
> >         setvar:tx.outbound_anomaly_score=+%{tx.error_anomaly_score},\
> >         setvar:tx.anomaly_score=+%{tx.error_anomaly_score},\
> >         setvar:tx.%{rule.id}-OWASP_CRS/LEAKAGE/SOURCE_CODE-%{matched_var_name}=%{tx.0}"
> >
> > I'm seeing errors like this where the status isn't passed:
> > Message: Access denied with code 403 (phase 4). Matched phrase 
> > "javax.servlet" a t RESPONSE_BODY. [file 
> > "/etc/httpd/modsecurity.d/owasp-modsecurity-crs/rules/RES
> > PONSE-952-DATA-LEAKAGES-JAVA.conf"] [line "50"] [id "952100"] [rev 
> > "3"] [msg "Ja va Source Code Leakage"] [data "Matched Data: 
> > javax.servlet found within RESPONS
> > E_BODY: <!DOCTYPE html><html><head><title>Apache Tomcat/8.0.41 - Error 
> > report</t
> > itle><style type=\x22text/css\x22>H1
> > {font-family:Tahoma,Arial,sans-serif;color:
> > white;background-color:#525D76;font-size:22px;} H2 
> > {font-family:Tahoma,Arial,san 
> > s-serif;color:white;background-color:#525D76;font-size:16px;} H3 
> > {font-family:Ta 
> > homa,Arial,sans-serif;color:white;background-color:#525D76;font-size:1
> > 4px;}
> > BODY
> >  {font-family:Tahoma,Arial,sans-serif;color:black;background-..."]
> > [severity "ER
> > ROR"] [ver "OWASP_CRS/3.0.0"] [maturity "9"] [accuracy "9"] [tag 
> > "application-mu lti"] [tag "language-java"] [tag "platform-multi"] 
> > [tag "attack-disclosure"] [ta g "OWASP_CRS/LEAKAGE/SOURCE_CODE_JAVA"] 
> > [tag "WASCTC/WASC-13"] [tag "OWA
> > Message: Warning. Operator GE matched 4 at TX:outbound_anomaly_score.
> > [file "/et
> > c/httpd/modsecurity.d/owasp-modsecurity-crs/rules/RESPONSE-980-CORRELATION.conf"
> > ] [line "82"] [id "980140"] [msg "Outbound Anomaly Score Exceeded 
> > (score
> > 4): Acc
> > ess denied with code "] [tag "event-correlation"]
> >
> > Thanks!
> > -Sheldon
> >
> > -----Original Message-----
> > From: Christian Folini [mailto:christian.folini at netnea.com]
> > Sent: Tuesday, February 21, 2017 4:40 PM
> > To: Briand, Sheldon (NRC/CNRC) <sheldon.briand at canada.ca>
> > Subject: Re: [Owasp-modsecurity-core-rule-set] Send back the correct 
> > response code
> >
> > Hi there,
> >
> > I see. Now I get you.
> >
> > Assuming, that the status action accepts dynamic variables as 
> > parameters, you could save the status code at the beginning of phase 3 
> > and then replace 959100 with a rule with "deny,status:%{TX.backend_status}"
> >
> > This might work, but I have not tested this.
> >
> > Ahoj,
> >
> > Christian
> >
> > On Tue, Feb 21, 2017 at 08:33:12PM +0000, Briand, Sheldon (NRC/CNRC)
> > wrote:
> >> Hi Christian,
> >>
> >> Sorry for not being clear.  I'm fairly new to modsecurity.  I have a 
> >> reverse proxy setup.  Let's say that a legitimate request comes in.
> >> That request generates an error on the backend server.  I'd like to 
> >> return whatever code the backend server would have returned instead 
> >> of the modsecurity 403.
> >>
> >> Thanks,
> >> -Sheldon
> >>
> >> -----Original Message-----
> >> From: Christian Folini [mailto:christian.folini at netnea.com]
> >> Sent: Tuesday, February 21, 2017 4:24 PM
> >> To: Briand, Sheldon (NRC/CNRC) <sheldon.briand at canada.ca>
> >> Subject: Re: [Owasp-modsecurity-core-rule-set] Send back the correct 
> >> response code
> >>
> >> Hi Sheldon,
> >>
> >> Not sure I understand you. What is the "correct" error code in your 
> >> question?
> >>
> >> The incoming requests are blocked in rule 949110. That rule does a 
> >> "deny" which defaults to 403. You can update that rule to include a 
> >> different status code. If I remember correctly, it is possible to 
> >> assign a variable as status code. If not, you would have to juggle a 
> >> bit writing rules for individual status codes and control them via 
> >> variables or something.
> >>
> >> Doable, but a bit of work.
> >>
> >> Ahoj,
> >>
> >> Christian
> >>
> >>
> >> On Tue, Feb 21, 2017 at 07:55:09PM +0000, Briand, Sheldon (NRC/CNRC)
> >> wrote:
> >> > Hi,
> >> >
> >> > I'm wondering how to best setup the CRS 3 rules to allow 
> >> > modsecurity
> >> to return the correct error code in the response.  The error message 
> >> I don't need just the error code that was triggered instead of a 403 
> >> every time.  I am running in self-contained mode.  Is this possible?
> >> >
> >> > Thanks,
> >> > -Sheldon
> >> >
> >> >
> >> > Sheldon Briand
> >> > Computer Systems and Applications Analyst National Research 
> >> > Council/Government of Canada 
> >> > Sheldon.briand at canada.ca/<mailto:Sheldon.briand at canada.ca/> Tel:
> >> > (902)
> >> > 426-1677
> >> >
> >>
> >> > _______________________________________________
> >> > Owasp-modsecurity-core-rule-set mailing list 
> >> > Owasp-modsecurity-core-rule-set at lists.owasp.org
> >> > https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rul
> >> > e
> >> > -s
> >> > et
> >>
> >
> 
> 
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set

-- 
https://www.feistyduck.com/training/modsecurity-training-course
mailto:christian.folini at netnea.com
twitter: @ChrFolini

From christian.folini at netnea.com  Fri Mar 31 04:50:11 2017
From: christian.folini at netnea.com (Christian Folini)
Date: Fri, 31 Mar 2017 06:50:11 +0200
Subject: [Owasp-modsecurity-core-rule-set] Up next Monday: CRS chat
Message-ID: <20170331045011.k6z56izlzaqdf3o7@leander>

Hi there,

Next Monday, April 3, we'll do our regular Core Rule Set project chat.
20:30 CET (14:30 EDT, 18:30 GMT) 
on Freenode IRC, channel #modsecurity

The topics will be preparations for the upcoming CRS 3.0.1 release
and anything else that springs to mind. If you have other things to
discuss that interests the whole project then please bring it along
(it might be useful to announce big topics first, though, so people
can make up their mind beforehand).

Cheers,

Christian

-- 
https://www.feistyduck.com/training/modsecurity-training-course
mailto:christian.folini at netnea.com
twitter: @ChrFolini

