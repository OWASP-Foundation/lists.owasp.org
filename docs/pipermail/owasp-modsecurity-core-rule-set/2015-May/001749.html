<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Rule 960009 generates false	positives from my own server IP
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Rule%20960009%20generates%20false%0A%09positives%20from%20my%20own%20server%20IP&In-Reply-To=%3CDUB406-EAS3421D8806F5341ECFDFE0E682C60%40phx.gbl%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001748.html">
   <LINK REL="Next"  HREF="001750.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Rule 960009 generates false	positives from my own server IP</H1>
    <B>Barry Pollard</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Rule%20960009%20generates%20false%0A%09positives%20from%20my%20own%20server%20IP&In-Reply-To=%3CDUB406-EAS3421D8806F5341ECFDFE0E682C60%40phx.gbl%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] Rule 960009 generates false	positives from my own server IP">barry_pollard at hotmail.com
       </A><BR>
    <I>Sat May 16 17:17:07 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="001748.html">[Owasp-modsecurity-core-rule-set] Rule 960009 generates false positives from my own server IP
</A></li>
        <LI>Next message: <A HREF="001750.html">[Owasp-modsecurity-core-rule-set] Rule 960009 generates false positives from my own server IP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1749">[ date ]</a>
              <a href="thread.html#1749">[ thread ]</a>
              <a href="subject.html#1749">[ subject ]</a>
              <a href="author.html#1749">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Sounds like you have a non-standard install. Saying that the before_rules and after_rules files were only example files I made up.

I can't recommend Ivan Ristic's Modsecurity handbook enough available at feistyduck.com. He's the original author of ModSecurity but has since moved on. It's were I learned how to use it. Quite cheap and the install section is available free. Only for old versions so bit out of date but nearly all still relevant. Main thing missing is that id is now mandatory.

I turned 960015 off completely as didn't find it that useful and lots of false positives.

SecRuleRemoveById 960015

Which annoyingly had to be specified AFTER rule 960015 is defined. Or you could use the ctl version, for a rule which will match always, and specify it before.

Finally it sounds like you have SecAuditLog set to On (log everything) rather than DetectionOnly (log only traffic which fails a rule).

Have a good weekend! 

Thanks,
Barry

&gt;<i> On 16 May 2015, at 17:40, Guilherme Y &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">asiayaisa at hotmail.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> Tks so much Barry!
</I>&gt;<i> I totally agree with you that it gets difficult to explain such things to a newbie like me, but I plead you to concede that it is very difficult to understand mod_security OWASP setup because it seems to be very different from what is described in <A HREF="https://github.com/SpiderLabs/ModSecurity/wiki/Reference-Manual#id">https://github.com/SpiderLabs/ModSecurity/wiki/Reference-Manual#id</A> 
</I>&gt;<i> or <A HREF="https://www.trustwave.com/Resources/SpiderLabs-Blog/ModSecurity-Advanced-Topic-of-the-Week--(Updated">https://www.trustwave.com/Resources/SpiderLabs-Blog/ModSecurity-Advanced-Topic-of-the-Week--(Updated</A>)-Exception-Handling/ 
</I>&gt;<i> or from what you describe in your kind message below.
</I>&gt;<i> 
</I>&gt;<i> For instance, my installation has no such file 
</I>&gt;<i> rules/modsecurity_crs_21_protocol_anomalies.conf 
</I>&gt;<i> or conf/modsecurity/crs/ 
</I>&gt;<i> or my_modsecurity_before_rules.conf, 
</I>&gt;<i> or even  Include my_modsecurity_after_rules.conf.
</I>&gt;<i> 
</I>&gt;<i> I only have this folder/files structure:
</I>&gt;<i> 
</I>&gt;<i> /usr/local/apache/conf/modsec_vendor_configs/OWASP
</I>&gt;<i> and then:
</I>&gt;<i> /usr/local/apache/conf/modsec_vendor_configs/OWASP/rules
</I>&gt;<i> /usr/local/apache/conf/modsec_vendor_configs/OWASP/util
</I>&gt;<i> 
</I>&gt;<i> My rules folder have a bunch of files duplicated: each duplicate has the suffix.BAD, like this one exampe:
</I>&gt;<i> REQUEST-13-SCANNER-DETECTION.conf.BAD
</I>&gt;<i> REQUEST-13-SCANNER-DETECTION.conf
</I>&gt;<i> and so on.
</I>&gt;<i> 
</I>&gt;<i> I don't have the faintest idea why it got that way.
</I>&gt;<i> 
</I>&gt;<i> I feel a lack in documentation and I also agree with you that flexibility is a must. But good standards need clear placeholders where all users may easily find where to customize. And definitely there will be always this need for cutomization in a product like firewall rules. 
</I>&gt;<i> 
</I>&gt;<i> Well, those are just facts and feelings to share.
</I>&gt;<i> 
</I>&gt;<i> Anyway, I thank you again very much because your keen observations and one particularly useful suggestion solved my 960009 issue!
</I>&gt;<i> I followed your preference and included the ipmatch directive in modsecurity_crs_10_setup.conf, since it is a &quot;before&quot; kind of tweak.
</I>&gt;<i> (I would say, in my defence, that no user could ever have guessed this by his own, I believe.)
</I>&gt;<i> And it worked like a charm!
</I>&gt;<i> No more false positives from my own server IP and rule 960009!
</I>&gt;<i> I will toast you a beer for that in a short while (because it's Saturday!)!
</I>&gt;<i> So now, the only other false positive filling up my audit log is rule  960015 on Google's IPs! I still couldn't figure out a way to exclude this.I thought of using the same ipmatch directive but Google has so many IPs and they seem to change networks from time to time that it might not be a good idea.
</I>&gt;<i> I would appreciate to know how you guys do this.
</I>&gt;<i> Another thig that intrigues me about mod_security and OWASP is the audit log itself. I log rotate it every night at daily crons, but when I look at the Hits Listin CPanel, under Security Center/Mod_Security/Tools, all hits since the very first day (May 2nd) I installed OWASP are there. I wonder where they keep them because in a short time it will become the largest file in the server! 
</I>&gt;<i> Any tips as where to find this file are welcome!
</I>&gt;<i> 
</I>&gt;<i> Tks a lot Barry!
</I>&gt;<i> And enjoy the weekend!
</I>&gt;<i> Cheers!
</I>&gt;<i> Luiz
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> From: <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">barry_pollard at hotmail.com</A>
</I>&gt;<i> Subject: Re: [Owasp-modsecurity-core-rule-set] Rule 960009 generates false positives from my own server IP
</I>&gt;<i> Date: Sat, 16 May 2015 06:38:19 +0100
</I>&gt;<i> CC: <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">csanders at trustwave.com</A>; <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>
</I>&gt;<i> To: <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">asiayaisa at hotmail.com</A>
</I>&gt;<i> 
</I>&gt;<i> No. Chaim is saying you cannot remove rule 960009 if it's already been defined previously in your config.
</I>&gt;<i> 
</I>&gt;<i> Some overrides need to be defined before the rule they are overriding and some after, depending on what command you use to do the override. It's a bit confusing alright which was why it was discussed to change on the link Chaim gave - though ultimately it looks like they decided to leave as is.
</I>&gt;<i> 
</I>&gt;<i> Anyway, it's important to understand how your rules are loaded. Let's you have something like this in your config:
</I>&gt;<i> 
</I>&gt;<i>    Include modsecurity_crs_10_setup.conf
</I>&gt;<i>    Include rules/*.conf
</I>&gt;<i> 
</I>&gt;<i> Then rule 960009 is defined in rules/modsecurity_crs_21_protocol_anomalies.conf. So you must define your rule, which switches off that rule for certain scenarios, before that file is loaded.
</I>&gt;<i> 
</I>&gt;<i> There are lots of ways to do this. You could change your setup to something like this, for example:
</I>&gt;<i> 
</I>&gt;<i>    Include my_modsecurity_before_rules.conf
</I>&gt;<i>    Include modsecurity_crs_10_setup.conf
</I>&gt;<i>    Include rules/*.conf
</I>&gt;<i>    Include my_modsecurity_after_rules.conf
</I>&gt;<i> 
</I>&gt;<i> Then your new rule should go in the my_modsecurity_before_rules.conf file so it is processed before any of the other rules.
</I>&gt;<i> 
</I>&gt;<i> Or you could add to a rules/modsecurity_crs_15_customrules.conf file, which will automatically be included with above code and, as they are loaded in alphabetical order, this file would be loaded before the rules/modsecurity_crs_21_protocol_anomalies.conf file.
</I>&gt;<i> 
</I>&gt;<i> Point is, that if you add your rule to the my_modsecurity_after_overrides.conf file, in above example, then it won't work as rule 960009 will have already been loaded and will be defined at that stage, so it will be too late so you can't use ctl:ruleRemoveById on it.
</I>&gt;<i> 
</I>&gt;<i> My personal preference is to put any &quot;before&quot; rules and tweaks directly the modsecurity_crs_10_setup.conf file (since you have to edit this file anyway to define your own customisations) and the also have an &quot;after&quot; rules file where any other rules and tweaks are defined. I also don't like * including files as sounds risky to me, so have an individual &quot;Include&quot; line for each rules file I want included, in the order I want it included. So my set up looks something like this:
</I>&gt;<i> 
</I>&gt;<i>    Include conf/modsecurity/modsecurity_crs_10_setup.conf
</I>&gt;<i>    Include conf/modsecurity/crs/base_rules/modsecurity_crs_20_protocol_violations.conf
</I>&gt;<i>    Include conf/modsecurity/crs/base_rules/modsecurity_crs_21_protocol_anomalies.conf
</I>&gt;<i>    ...etc.
</I>&gt;<i>    Include conf/modsecurity/my_custom_rules.conf
</I>&gt;<i> 
</I>&gt;<i> And I make any edits in either modsecurity_crs_10_setup.conf (for tweaks I want before the rest of the rules load) or in my_custom_rules.conf (for tweaks I want after the rest of the rules load). I never edit anything in the conf/modsecurity/crs/ folder which makes it easy to drop a new version of the crs rules in here.
</I>&gt;<i> 
</I>&gt;<i> But it's all a personal preference as to how you set it up. The downside with this flexibility, is that it's difficult to help people like you, when they ask for help without knowing exactly how they've set their own ModSecurity up.
</I>&gt;<i> 
</I>&gt;<i> Thanks,
</I>&gt;<i> Barry
</I>&gt;<i> 
</I>&gt;<i> On 16 May 2015, at 00:53, Guilherme Y &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">asiayaisa at hotmail.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> Tks Chaim!
</I>&gt;<i> But now I really got confused.
</I>&gt;<i> I am tring to use this line:
</I>&gt;<i> 
</I>&gt;<i> SecRule REMOTE_ADDR &quot;@ipMatch 999.99.99.99&quot; &quot;id:1000,phase:2,t:none,pass,ctl:ruleRemoveById=960009&quot; 
</I>&gt;<i> You&#180;re telling me to use this:
</I>&gt;<i> 
</I>&gt;<i> &quot;ctl:ruleRemoveById=960009,id:1000,phase:2,t:none,pass&quot; SecRule REMOTE_ADDR &quot;@ipMatch 999.99.99.99&quot; 
</I>&gt;<i> YIs this right?
</I>&gt;<i> I probably got it all wrong....
</I>&gt;<i> Tks a lot!
</I>&gt;<i> Best regards!
</I>&gt;<i> Luiz
</I>&gt;<i> 
</I>&gt;<i> From: <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">CSanders at trustwave.com</A>
</I>&gt;<i> To: <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">asiayaisa at hotmail.com</A>; <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">barry_pollard at hotmail.com</A>; <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>
</I>&gt;<i> Subject: Re: [Owasp-modsecurity-core-rule-set] Rule 960009 generates false positives from my own server IP
</I>&gt;<i> Date: Fri, 15 May 2015 16:48:07 +0000
</I>&gt;<i> 
</I>&gt;<i> ctl:ruleRemoveById must appear BEFORE the rule in question. Where as SecRuleRemoveByID must appear after. See the excerpt from this issue (<A HREF="https://github.com/SpiderLabs/ModSecurity/issues/209">https://github.com/SpiderLabs/ModSecurity/issues/209</A>). Hope this isn&#8217;t too confusing :)
</I>&gt;<i> 
</I>&gt;<i> From: Guilherme Y &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">asiayaisa at hotmail.com</A>&gt;
</I>&gt;<i> Date: Friday, May 15, 2015 at 10:51 AM
</I>&gt;<i> To: Barry Pollard &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">barry_pollard at hotmail.com</A>&gt;, &quot;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;
</I>&gt;<i> Subject: Re: [Owasp-modsecurity-core-rule-set] Rule 960009 generates false positives from my own server IP
</I>&gt;<i> 
</I>&gt;<i> ctl:ruleRemoveById 
</I>&gt;<i> 
</I>&gt;<i> This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is strictly prohibited. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20150516/c59f1092/attachment-0001.html">http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20150516/c59f1092/attachment-0001.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001748.html">[Owasp-modsecurity-core-rule-set] Rule 960009 generates false positives from my own server IP
</A></li>
	<LI>Next message: <A HREF="001750.html">[Owasp-modsecurity-core-rule-set] Rule 960009 generates false positives from my own server IP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1749">[ date ]</a>
              <a href="thread.html#1749">[ thread ]</a>
              <a href="subject.html#1749">[ subject ]</a>
              <a href="author.html#1749">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
