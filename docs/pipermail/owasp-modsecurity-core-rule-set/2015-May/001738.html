<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Rule 960009 generates false positives from my own server IP
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Rule%20960009%20generates%20false%0A%20positives%20from%20my%20own%20server%20IP&In-Reply-To=%3CDUB116-W101B0B55A161038185BA35282D90%40phx.gbl%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001737.html">
   <LINK REL="Next"  HREF="001740.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Rule 960009 generates false positives from my own server IP</H1>
    <B>Barry Pollard</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Rule%20960009%20generates%20false%0A%20positives%20from%20my%20own%20server%20IP&In-Reply-To=%3CDUB116-W101B0B55A161038185BA35282D90%40phx.gbl%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] Rule 960009 generates false positives from my own server IP">barry_pollard at hotmail.com
       </A><BR>
    <I>Wed May 13 09:07:24 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="001737.html">[Owasp-modsecurity-core-rule-set] Rule 960009 generates false	positives from my own server IP
</A></li>
        <LI>Next message: <A HREF="001740.html">[Owasp-modsecurity-core-rule-set] Rule 960009 generates false positives from my own server IP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1738">[ date ]</a>
              <a href="thread.html#1738">[ thread ]</a>
              <a href="subject.html#1738">[ subject ]</a>
              <a href="author.html#1738">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>That would work though I personally prefer to use @ipMatch which also allows you to match multiple IPs:

SecRule REMOTE_ADDR &quot;@ipMatch&#160;XXX.YYY.Z.WWW XXX.YYY.Z.VVVV&quot;&#160;&#160;&quot;id:1000,phase:2,t:none,pass,nolog,ctl:ruleRemoveById=960009&quot;&#160;

A few other things to note:
1) 960009 is a phase 2 rule and you have specified phase 1 in your rule below. I'm pretty sure that rules cannot see other rules outside of their phase so it needs to be in the same phase. So I've updated this to phase 2 in my version above.
2) Your rule must have it's own id (as of ModSecurity 2.7) so I've given it an id of 1000. Make sure this doesn't clash with any existing rule you have. Principal is anything less than 99,999 are your own use. See here for more info: <A HREF="https://github.com/SpiderLabs/ModSecurity/wiki/Reference-Manual#id">https://github.com/SpiderLabs/ModSecurity/wiki/Reference-Manual#id</A>
3) You could disable ModSecurity completely for internal addresses with a ctl:ruleEngine=off rule. Personally I don't like that as I want them on for testing purposes so we're not caught out with a rule that only runs in production so think just disabling the specific rules is a better option.

However I think it would be good to understand why you need to do this at all.

Rule 960009 checks for requests missing a user agent. All decent browsers send a user agent hence why this rule is in place as the lack of a user agent is probably due to some script or such like, so it is a good rule.

So why are you getting so many requests from internal addresses without a user agent and should you fix that rather than add the above rule to get around that?

I can think of two reasons:

1) Monitoring scripts or tools which are not quite as compliant as web browsers. So perhaps change these to also report the user agent as that could be useful information to know (though with third party tools that might not always be possible).

2) Needlessly connecting to Apache. We use Apache to server up static pages and also in proxy mode to pass dynamic requests on to an application server. After installing mod security and noticing similar to you, we investigated and discovered some of our dynamic applications were needlessly making calls to Apache, just to connect back to the app server again. It was actually better to change them to connect directly to the app server, which resolved the issue, as well as saving network traffic and a (admittedly small amount of) Apache load.

Thanks,
Barry

________________________________
&gt;<i> From: <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">asiayaisa at hotmail.com</A> 
</I>&gt;<i> To: <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A> 
</I>&gt;<i> Date: Tue, 12 May 2015 20:34:22 -0300 
</I>&gt;<i> Subject: [Owasp-modsecurity-core-rule-set] Rule 960009 generates false 
</I>&gt;<i> positives from my own server IP 
</I>&gt;<i> 
</I>&gt;<i> Hi! 
</I>&gt;<i> 
</I>&gt;<i> I don't know if anyone experiences the same issue as us here, but I 
</I>&gt;<i> suppose at least this might contribute to all. 
</I>&gt;<i> 
</I>&gt;<i> I installed OWASP rules on a Centos running 2 Joomla sites with nearly 
</I>&gt;<i> 5,000 unique visitors a day. 
</I>&gt;<i> 
</I>&gt;<i> I was fortunate enough to identify and disable 12 rules that delivered 
</I>&gt;<i> a bunch of false positives (one of them locked down the server when one 
</I>&gt;<i> of us in the team submitted a security scan from CSF/LFD...). 
</I>&gt;<i> 
</I>&gt;<i> So, now it is running fine but one rule still delivers near 1,000 false 
</I>&gt;<i> positives a day and oddly enough having our own server IP as source! 
</I>&gt;<i> 
</I>&gt;<i> And severity level for ALL of the hits are NOTICE. So, this is not so 
</I>&gt;<i> much troublesome, except for the extra load on the server and the log 
</I>&gt;<i> size. I rotate it automatically everynight but it comes out at nearly 
</I>&gt;<i> 0,3 GB as standard size. 
</I>&gt;<i> 
</I>&gt;<i> So, what I am trying to do but don't know exactly how is to implent 
</I>&gt;<i> something like this in a file named modsecurity_crs_15_localrules.conf: 
</I>&gt;<i> 
</I>&gt;<i> SecRule REMOTE_ADDR &quot;@streq XXX.YYY.Z.WWW&quot; 
</I>&gt;&gt;<i> &quot;phase:1,t:none,pass,nolog,ctl:ruleRemoveById=960009&quot; 
</I>&gt;<i> 
</I>&gt;<i> where XXX.YYY.Z.WWW is my server's IP address. 
</I>&gt;<i> 
</I>&gt;<i> Does anyone know if this is correct and if it can actually work to keep 
</I>&gt;<i> my server out of this rule execution? 
</I>&gt;<i> 
</I>&gt;<i> Tks a lot! 
</I>&gt;<i> 
</I>&gt;<i> All the best! 
</I>&gt;<i> Luiz Guilherme 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________ 
</I>&gt;<i> Owasp-modsecurity-core-rule-set mailing list 
</I>&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A> 
</I>&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set</A> 
</I> 		 	   		  
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001737.html">[Owasp-modsecurity-core-rule-set] Rule 960009 generates false	positives from my own server IP
</A></li>
	<LI>Next message: <A HREF="001740.html">[Owasp-modsecurity-core-rule-set] Rule 960009 generates false positives from my own server IP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1738">[ date ]</a>
              <a href="thread.html#1738">[ thread ]</a>
              <a href="subject.html#1738">[ subject ]</a>
              <a href="author.html#1738">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
