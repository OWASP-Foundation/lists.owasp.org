<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] @pmFromFile fails when using IIS along with modsecurity 2.7.0-RC2
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20%40pmFromFile%20fails%20when%20using%0A%20IIS%20along%20with%20modsecurity%202.7.0-RC2&In-Reply-To=%3CCOL002-W1141C87FF8906BB68B4EFF8FCB00%40phx.gbl%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001162.html">
   <LINK REL="Next"  HREF="001161.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] @pmFromFile fails when using IIS along with modsecurity 2.7.0-RC2</H1>
    <B>Bill Roemhild</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20%40pmFromFile%20fails%20when%20using%0A%20IIS%20along%20with%20modsecurity%202.7.0-RC2&In-Reply-To=%3CCOL002-W1141C87FF8906BB68B4EFF8FCB00%40phx.gbl%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] @pmFromFile fails when using IIS along with modsecurity 2.7.0-RC2">consume_ at hotmail.com
       </A><BR>
    <I>Mon Aug 13 14:29:21 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="001162.html">[Owasp-modsecurity-core-rule-set] Using the latest	ModSecurity	Versions
</A></li>
        <LI>Next message: <A HREF="001161.html">[Owasp-modsecurity-core-rule-set] Owasp-Waspy-Awards
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1160">[ date ]</a>
              <a href="thread.html#1160">[ thread ]</a>
              <a href="subject.html#1160">[ subject ]</a>
              <a href="author.html#1160">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I can confirm that setting the App Pool setting of &quot;Enable 32-Bit Applications&quot; to True does work. 
Thanks for your help guys. 
Bill 

From: <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Greg.Wroblewski at microsoft.com</A>
To: <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">BPinto at trustwave.com</A>; <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">consume_ at hotmail.com</A>; <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">RBarnett at trustwave.com</A>
CC: <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>
Subject: RE: [Owasp-modsecurity-core-rule-set] @pmFromFile fails when using IIS along with modsecurity 2.7.0-RC2
Date: Sat, 11 Aug 2012 00:25:30 +0000






Re: [Owasp-modsecurity-core-rule-set] @pmFromFile fails when using IIS along with modsecurity 2.7.0-RC2




Yep, the cleanup list in the pool is broken.
 
This is one of those non-deterministic bugs, you need a little bit of luck to hit it. The thing that worked for me was switching to 32-bit application pool.
 
Greg
 


From: Breno Silva Pinto [mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">BPinto at trustwave.com</A>]


Sent: Friday, August 10, 2012 11:09 AM

To: Greg Wroblewski (SPARROW); Bill Roemhild; Ryan Barnett

Cc: <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>

Subject: Re: [Owasp-modsecurity-core-rule-set] @pmFromFile fails when using IIS along with modsecurity 2.7.0-RC2


 
Maybe for some reason  &quot;c&quot;  == NULL or pointing to a wrong addr ?





On 8/10/12 12:38 PM, &quot;Greg Wroblewski (SPARROW)&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Greg.Wroblewski at microsoft.com</A>&gt; wrote:
I see a problem. Even when permissions are correct, the code reads the file, but then it crashes.

 

Breno,

 

This is all happening in:

 

static
int msre_op_pmFromFile_param_init(msre_rule *rule,
char **error_msg)

 

with crash:

 

&gt;<i>             libapr-1.dll!apr_pool_cleanup_kill(apr_pool_t * p, const void * data, int (void *)* cleanup_fn)  Line 2270             C
</I>
              libapr-1.dll!apr_file_close(apr_file_t * file)  Line 501           C

               ModSecurityIIS.dll!msre_op_pmFromFile_param_init(msre_rule * rule, char * * error_msg)  Line 1384             C

 

Here:

 

  while (c) {

#if APR_POOL_DEBUG

       /* Some cheap loop detection to catch a corrupt list: */

      if (c == c-&gt;next

            || (c-&gt;next &amp;&amp; c == c-&gt;next-&gt;next)

            || (c-&gt;next &amp;&amp; c-&gt;next-&gt;next &amp;&amp; c == c-&gt;next-&gt;next-&gt;next)) {

            abort();

        }

#endif



       if (c-&gt;data == data &amp;&amp; c-&gt;plain_cleanup_fn == cleanup_fn) {  &#231;
  CRASH

 

I cannot figure out what&#8217;s wrong, but I&#8217;ll keep looking.

 

Greg

 



From: Bill Roemhild [mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">consume_ at hotmail.com</A>]


Sent: Friday, August 10, 2012 9:38 AM

To: Greg Wroblewski (SPARROW); Ryan Barnett

Cc: <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>

Subject: RE: [Owasp-modsecurity-core-rule-set] @pmFromFile fails when using IIS along with modsecurity 2.7.0-RC2





Maybe I should be asking if anyone else has been able to get this to work.


 



From: 
<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">consume_ at hotmail.com</A>

To: <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">greg.wroblewski at microsoft.com</A>; 
<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">rbarnett at trustwave.com</A>

Date: Fri, 10 Aug 2012 08:47:39 -0700

CC: <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>

Subject: Re: [Owasp-modsecurity-core-rule-set] @pmFromFile fails when using IIS along with modsecurity 2.7.0-RC2



There is not an entry listed in the event log for a missing file.  

 

I gave &quot;IIS AppPool\DefaultAppPool&quot; full control over the data files as I'm using IIS 7.5. Same result.

 

I also tried adding &quot;Network Service&quot;, even through I'm pretty sure that is wrong. Still no love.



Bill



 



From: 
<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Greg.Wroblewski at microsoft.com</A>

To: <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">RBarnett at trustwave.com</A>; 
<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">consume_ at hotmail.com</A>

CC: <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>

Subject: RE: [Owasp-modsecurity-core-rule-set] @pmFromFile fails when using IIS along with modsecurity 2.7.0-RC2

Date: Thu, 9 Aug 2012 23:21:55 +0000



This is really an APR bug (we should report it or create a workaround), but the problem is in the file permissions. Read access to everyone is not enough, proper ACLs must be set as well.

 

When the file does not exist this error gets logged in the event log:

 

Syntax error in config file c:\inetpub\wwwroot\test.conf, line 47: Error creating rule: Could not open phrase file &quot;c:\inetpub\wwwroot\modsecurity_35_scanners.data&quot;: The system cannot find
 the file specified.

 

So you can see when it&#8217;s a permission issue or a path issue.



Greg





From: Ryan Barnett [mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">RBarnett at trustwave.com</A>]


Sent: Thursday, August 9, 2012 2:45 PM

To: Bill Roemhild

Cc: <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>; Greg Wroblewski (SPARROW)

Subject: Re: [Owasp-modsecurity-core-rule-set] @pmFromFile fails when using IIS along with modsecurity 2.7.0-RC2





You might want to try and specify a full path to the .data file.




--



Ryan Barnett



Researcher Lead



Trustwave - SpiderLabs









On Aug 9, 2012, at 5:39 PM, Bill Roemhild &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">consume_ at hotmail.com</A>&gt; wrote:



I've been playing around with modsecurity 2.7.0-RC2 for IIS along with the OWASP rules.  When running any rule set that calls for a data file through @pmFromFile the application pool crashes.  I've given
 read access to 'Everyone' on the data files being read without success. Anyone else run into this problem?


 

 

Rule:

SecRule REQUEST_HEADERS:User-Agent &quot;@pmFromFile modsecurity_35_scanners.data&quot; \

        &quot;phase:2,rev:'2.2.5',t:none,t:lowercase,block,msg:'Request Indicates a Security Scanner Scanned the Site',id:'990002',tag:'AUTOMATION/SECURITY_SCANNER',tag:'WASCTC/WASC-21',tag:'OWASP_TOP_10/A7',tag:'PCI/6.5.10',severity:'4',setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.warning_anomaly_score},setvar:tx.automation_score=+%{tx.warning_anomaly_score},setvar:tx.%{rule.id}-AUTOMATION/SECURITY_SCANNER-%{matched_var_name}=%{matched_var}&quot;

 

Crash:

w3wp.exe 

   7.5.7601.17514 

   4ce7afa2 

   libapr-1.dll 

   1.4.5.0 

   500eaf34 

   c0000005 

   00000000000099f8 

   1e08 

   01cd7675752af369 

   c:\windows\system32\inetsrv\w3wp.exe 

   C:\Windows\system32\inetsrv\libapr-1.dll 

   b4147ab9-e268-11e1-82b3-4437e66c2115 

 

 

 



_______________________________________________

Owasp-modsecurity-core-rule-set mailing list

<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>

<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set</A>






This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified
 that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its
 entirety, whether in electronic or hard copy format.



_______________________________________________ Owasp-modsecurity-core-rule-set mailing list
<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>

<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set</A>
 



This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient,
 you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy
 the material in its entirety, whether in electronic or hard copy format.
 		 	   		  
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120813/64b4ea60/attachment-0001.html">http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120813/64b4ea60/attachment-0001.html</A>&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001162.html">[Owasp-modsecurity-core-rule-set] Using the latest	ModSecurity	Versions
</A></li>
	<LI>Next message: <A HREF="001161.html">[Owasp-modsecurity-core-rule-set] Owasp-Waspy-Awards
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1160">[ date ]</a>
              <a href="thread.html#1160">[ thread ]</a>
              <a href="subject.html#1160">[ subject ]</a>
              <a href="author.html#1160">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
