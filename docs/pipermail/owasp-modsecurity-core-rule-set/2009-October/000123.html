<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Need a help with sec rule
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20Need%20a%20help%20with%20sec%20rule&In-Reply-To=35dfe7b70910140315v68aee59p5ca2380a7556af6b%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000122.html">
   <LINK REL="Next"  HREF="000119.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Need a help with sec rule</H1>
    <B>Ryan Barnett</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20Need%20a%20help%20with%20sec%20rule&In-Reply-To=35dfe7b70910140315v68aee59p5ca2380a7556af6b%40mail.gmail.com"
       TITLE="[Owasp-modsecurity-core-rule-set] Need a help with sec rule">ryan.barnett at breach.com
       </A><BR>
    <I>Wed Oct 14 09:46:29 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="000122.html">[Owasp-modsecurity-core-rule-set] Need a help with sec rule
</A></li>
        <LI>Next message: <A HREF="000119.html">[Owasp-modsecurity-core-rule-set] Variable to detect HTTPS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#123">[ date ]</a>
              <a href="thread.html#123">[ thread ]</a>
              <a href="subject.html#123">[ subject ]</a>
              <a href="author.html#123">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wednesday 14 October 2009 06:15:11 am unni krishnan wrote:
&gt;<i> I know that the rule is to log when user agent is curl. Here is the debug
</I>&gt;<i> log
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ------------------------------------------------------------------
</I>&gt;<i> sid#9abafc8][rid#9d8b688][/][4] Executing operator &quot;rx&quot; with param
</I>&gt;<i> &quot;(?:\\b(?:(?:indy librar|snoop)y|microsoft url
</I>&gt;<i> control|lynx)\\b|d(?:ownload
</I>&gt;<i> demon|isco)|w(?:3mirror|get)|l(?:ibwww|wp)|p(?:avuk|erl)|cu(?:sto|rl)|big
</I>&gt;<i> brother|autohttp|netants|eCatch)&quot; against REQUEST_HEADERS:User-Agent.
</I>&gt;<i> sid#9abafc8][rid#9d8b688][/][4] Operator completed in 5 usec.
</I>&gt;<i> sid#9abafc8][rid#9d8b688][/][4] Rule returned 1.
</I>&gt;<i> sid#9abafc8][rid#9d8b688][/][4] Recipe: Invoking rule 9a165f8; [file
</I>&gt;<i> &quot;/usr/local/apache/conf/modsec2.user.conf&quot;] [line &quot;59&quot;].
</I>&gt;<i> sid#9abafc8][rid#9d8b688][/][5] Rule 9a165f8: SecRule
</I>&gt;<i> &quot;REQUEST_HEADERS:User-Agent&quot; &quot;!@rx ^apache.*perl&quot;
</I>&gt;<i> &quot;phase:2,deny,log,status:406&quot;
</I>&gt;<i> sid#9abafc8][rid#9d8b688][/][4] Transformation completed in 1 usec.
</I>&gt;<i> sid#9abafc8][rid#9d8b688][/][4] Executing operator &quot;!rx&quot; with param
</I>&gt;<i> &quot;^apache.*perl&quot; against REQUEST_HEADERS:User-Agent.
</I>&gt;<i> sid#9abafc8][rid#9d8b688][/][4] Operator completed in 1 usec.
</I>&gt;<i> sid#9abafc8][rid#9d8b688][/][4] Rule returned 1.
</I>&gt;<i> sid#9abafc8][rid#9d8b688][/][1] Access denied with code 406 (phase 2).
</I>&gt;<i> Match of &quot;rx ^apache.*perl&quot; against &quot;REQUEST_HEADERS:User-Agent&quot;
</I>&gt;<i> required. [file &quot;/usr/local/apache/conf/modsec2.user.conf&quot;] [line
</I>&gt;<i> &quot;58&quot;] [id &quot;990011&quot;] [msg &quot;Request Indicates an automated program
</I>&gt;<i> explored the site&quot;] [severity &quot;NOTICE&quot;]
</I>&gt;<i> ------------------------------------------------------------------
</I>&gt;<i>
</I>&gt;<i> The rule number 59 in the file /usr/local/apache/conf/modsec2.user.conf is
</I>&gt;<i> :
</I>&gt;<i>
</I>&gt;<i> -------------------------------------------------------------------
</I>&gt;<i> SecRule REQUEST_HEADERS:User-Agent &quot;(?:\b(?:(?:indy
</I>&gt;<i> librar|snoop)y|microsoft url control|lynx)\b|d(?:ownload
</I>&gt;<i> demon|isco)|w(?:3mirror|get)|l(?:ibwww|wp)|p(?:avuk|erl)|cu(?:sto|rl)|big
</I>&gt;<i> brother|autohttp|netants|eCatch)&quot; \
</I>&gt;<i>         &quot;chain,log,auditlog,msg:'Request Indicates an automated
</I>&gt;<i> program explored the site',id:'990011',severity:'5'&quot;
</I>&gt;<i> SecRule REQUEST_HEADERS:User-Agent &quot;!^apache.*perl&quot;
</I>&gt;<i> -------------------------------------------------------------------
</I>&gt;<i>
</I>&gt;<i> As you can see there is no deny rule. But the log says that :
</I>&gt;<i>
</I>&gt;<i> --------------------------------------------------------------------
</I>&gt;<i> sid#9abafc8][rid#9d8b688][/][5] Rule 9a165f8: SecRule
</I>&gt;<i> &quot;REQUEST_HEADERS:User-Agent&quot; &quot;!@rx ^apache.*perl&quot;
</I>&gt;<i> &quot;phase:2,deny,log,status:406&quot;
</I>&gt;<i> --------------------------------------------------------------------
</I>&gt;<i>
</I>&gt;<i> I am not able to find the deny line in the rule file. Why is it like
</I>&gt;<i> that. Is there any built-in rule in mod sec ?
</I>&gt;<i>
</I>
Search your rulesets for the SecDefaultAction directive.  It seems as though 
the deny and status code of 403 is being set somewhere else and is inherited 
by this rule as it isn't specifying any disruptive action itself.

&gt;<i> On Wed, Oct 14, 2009 at 12:30 AM, Brian Rectanus
</I>&gt;<i>
</I>&gt;<i> &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Brian.Rectanus at breach.com</A>&gt; wrote:
</I>&gt;<i> &gt; And of course by &quot;perl&quot; I meant &quot;curl&quot;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; cu(?:sto|rl)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; But maybe you meant why is it denied vs just logged?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Look at the debug log (I think level 4 or higher, maybe 5) and it will
</I>&gt;<i> &gt; show you the resolved rule that is being executed.  There may be a value
</I>&gt;<i> &gt; inherited from the default.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; -B
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Brian Rectanus wrote:
</I>&gt;<i> &gt;&gt; The string &quot;perl&quot; is denied.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; p(?:avuk|erl)
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; -B
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; unni krishnan wrote:
</I>&gt;<i> &gt;&gt;&gt; Hi Ryan,
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; Thanks, I am just curious to know. What is the reason that the Curl
</I>&gt;<i> &gt;&gt;&gt; access is denied even though there is no deny rule specified in that
</I>&gt;<i> &gt;&gt;&gt; rule set.
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; On Tue, Oct 13, 2009 at 8:07 PM, Ryan Barnett&lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">ryan.barnett at breach.com</A>&gt;
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; wrote:
</I>&gt;<i> &gt;&gt;&gt;&gt; On Tuesday 13 October 2009 10:02:16 am unni krishnan wrote:
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; Hi,
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; I was going through the security rules in the server and found this :
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; ---------------------------------
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; SecRule REQUEST_HEADERS:User-Agent &quot;(?:\b(?:(?:indy
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; librar|snoop)y|microsoft url control|lynx)\b|d(?:ownload
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; demon|isco)|w(?:3mirror|get)|l(?:ibwww|wp)|p(?:avuk|erl)|cu(?:sto|rl)
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;|big brother|autohttp|netants|eCatch)&quot; \
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; &quot;chain,log,auditlog,msg:'Request Indicates an automated
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; program explored the site',id:'990011',severity:'5'&quot;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; SecRule REQUEST_HEADERS:User-Agent &quot;!^apache.*perl&quot;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; ---------------------------------
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; As per my knowledge, it just logs the message &quot;Request Indicates an
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; automated program explored the site&quot;. But actually it blocks access,
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; when accessing the URL using Curl.
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; ----------------------------------
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; ModSecurity: Access denied with code 406 (phase 2). Match of &quot;rx
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; ^apache.*perl&quot; against &quot;REQUEST_HEADERS:User-Agent&quot; required. [file
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; &quot;/usr/local/apache/conf/modsec2.user.conf&quot;] [line &quot;58&quot;] [id &quot;990011&quot;]
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; [msg &quot;Request Indicates an automated program explored the site&quot;]
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; [severity &quot;NOTICE&quot;] [uri &quot;/&quot;] [unique_id &quot;StSH9EPeHm4AAB3fCZgAAAAE&quot;]
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; ----------------------------------
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; What is the logic behind that ?
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt; These are the older CRS. I suggest that you update to the newer v2 CRS
</I>&gt;<i> &gt;&gt;&gt;&gt; as
</I>&gt;<i> &gt;&gt;&gt;&gt; they using anomaly scoring and it is quite easy to then allow these
</I>&gt;<i> &gt;&gt;&gt;&gt; rules to
</I>&gt;<i> &gt;&gt;&gt;&gt; slightly increase an anomaly score but to not cause a denial on their
</I>&gt;<i> &gt;&gt;&gt;&gt; own.
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt; -Ryan
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; --
</I>&gt;<i> &gt; Brian Rectanus
</I>&gt;<i> &gt; Breach Security
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20091014/15f4d7cf/attachment.html">https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20091014/15f4d7cf/attachment.html</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000122.html">[Owasp-modsecurity-core-rule-set] Need a help with sec rule
</A></li>
	<LI>Next message: <A HREF="000119.html">[Owasp-modsecurity-core-rule-set] Variable to detect HTTPS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#123">[ date ]</a>
              <a href="thread.html#123">[ thread ]</a>
              <a href="subject.html#123">[ subject ]</a>
              <a href="author.html#123">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
