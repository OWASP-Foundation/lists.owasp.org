<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Blocking Apache	dummy	conections
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20Blocking%20Apache%0A%09dummy%09conections&In-Reply-To=245770850910191341t3b142848md21dda0d79f81e7a%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000129.html">
   <LINK REL="Next"  HREF="000132.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Blocking Apache	dummy	conections</H1>
    <B>Ryan Barnett</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20Blocking%20Apache%0A%09dummy%09conections&In-Reply-To=245770850910191341t3b142848md21dda0d79f81e7a%40mail.gmail.com"
       TITLE="[Owasp-modsecurity-core-rule-set] Blocking Apache	dummy	conections">Ryan.Barnett at breach.com
       </A><BR>
    <I>Mon Oct 19 16:46:46 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="000129.html">[Owasp-modsecurity-core-rule-set] Blocking Apache dummy	conections
</A></li>
        <LI>Next message: <A HREF="000132.html">[Owasp-modsecurity-core-rule-set] Blocking Apache dummy	conections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#130">[ date ]</a>
              <a href="thread.html#130">[ thread ]</a>
              <a href="subject.html#130">[ subject ]</a>
              <a href="author.html#130">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The issue seems to be that you have updated the SecDefaultAction to deny and issue a 400 status code.  If you set the SecDefaultAction to block instead of the default of pass, then the rules are essentially working the way they did &gt; v2.  That is if a rule matches it will block.  You need to have the SecDefaultAction set to pass so the block action in each rule will inherit this setting.

In this case, that protocol anomaly rule is triggering and then denying and therefore the other rules (including the local exceptions file) does not get a chance to run.  Try setting the SecDefaultAction back to the default.  You can then control blocking in the 49 enforcement file - based on the anomaly score.

-Ryan
________________________________
From: <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set-bounces at lists.owasp.org</A> [<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set-bounces at lists.owasp.org</A>] On Behalf Of Lucas Ferreira [<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">listas at sapao.net</A>]
Sent: Monday, October 19, 2009 4:41 PM
To: Brian Rectanus
Cc: <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>
Subject: Re: [Owasp-modsecurity-core-rule-set] Blocking Apache dummy conections

Hello Brian,

this file is anebled, but I still get errors like this in the audit log:

--650c7926-A--
[19/Oct/2009:15:05:16 --0200] v-ErhX8AAAEAAEqfn2kAAACn ::1 53272 ::1 80
--650c7926-B--
OPTIONS * HTTP/1.0
User-Agent: mysite (internal dummy connection)

--650c7926-F--
HTTP/1.1 400 Bad Request
Vary: accept-language,accept-charset
Accept-Ranges: bytes
Connection: close
Content-Type: text/html; charset=iso-8859-1
Content-Language: en
Expires: Mon, 19 Oct 2009 17:05:16 GMT

--650c7926-H--
Message:  [file &quot;/etc/httpd/modsecurity.d/optional_rules/modsecurity_crs_21_protocol_anomalies.conf&quot;] [line &quot;35&quot;] [id &quot;960008&quot;] [msg &quot;Re
quest Missing a Host Header&quot;] [severity &quot;WARNING&quot;] [tag &quot;PROTOCOL_VIOLATION/MISSING_HEADER&quot;] Access denied with code 400 (phase 2). Oper
ator EQ matched 0 at REQUEST_HEADERS.
Message:  [file &quot;/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_60_correlation.conf&quot;] [line &quot;41&quot;] [msg &quot;Transactional Anomaly Score
 (score 5): Request Missing a Host Header&quot;] Warning. Operator GE matched 5 at TX:anomaly_score.
Action: Intercepted (phase 2)
Apache-Handler: type-map
Stopwatch: 1255971916688261 2329 (568 1401 -)
Producer: ModSecurity for Apache/2.5.9 (<A HREF="http://www.modsecurity.org/">http://www.modsecurity.org/</A>); core ruleset/2.0.1; core ruleset/2.0.1.&lt;<A HREF="http://2.0.1.">http://2.0.1.</A>&gt;
Server: Apache/2.2.3 (Red Hat)

--650c7926-Z--

Thanks,

Lucas

On Mon, Oct 19, 2009 at 16:22, Brian Rectanus &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Brian.Rectanus at breach.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Brian.Rectanus at breach.com</A>&gt;&gt; wrote:
Lucas Ferreira wrote:
Hello,

I am using CRS 2.0.1 and am getting messagens like these in error_log
several times a day:

Oct 19 15:05:14 server httpd[19282]: [error] [client ::1] ModSecurity:
[file
&quot;/etc/httpd/modsecurity.d/optional_rules/modsecurity_crs_21_protocol_anomalies.conf&quot;]
[line &quot;35&quot;] [id &quot;960008&quot;] [msg &quot;Request Missing a Host Header&quot;]
[severity &quot;WARNING&quot;] [tag &quot;PROTOCOL_VIOLATION/MISSING_HEADER&quot;] Access
denied with code 400 (phase 2). Operator EQ matched 0 at
REQUEST_HEADERS. [hostname &quot;server&quot;] [uri &quot;*&quot;] [unique_id
&quot;v9KnRH8AAAEAAEtS7SUAAACo&quot;]
Oct 19 15:05:14 server httpd[19282]: [error] [client ::1] ModSecurity:
[file
&quot;/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_60_correlation.conf&quot;]
[line &quot;41&quot;] [msg &quot;Transactional Anomaly Score (score 5): Request Missing
a Host Header&quot;] Warning. Operator GE matched 5 at TX:anomaly_score.
[hostname &quot;server&quot;] [uri &quot;/error/HTTP_BAD_REQUEST.html.var&quot;] [unique_id
&quot;v9KnRH8AAAEAAEtS7SUAAACo&quot;]
Oct 19 15:05:15 server httpd[19010]: [error] [client ::1] ModSecurity:
[file
&quot;/etc/httpd/modsecurity.d/optional_rules/modsecurity_crs_21_protocol_anomalies.conf&quot;]
[line &quot;35&quot;] [id &quot;960008&quot;] [msg &quot;Request Missing a Host Header&quot;]
[severity &quot;WARNING&quot;] [tag &quot;PROTOCOL_VIOLATION/MISSING_HEADER&quot;] Access
denied with code 400 (phase 2). Operator EQ matched 0 at
REQUEST_HEADERS. [hostname &quot;server&quot;] [uri &quot;*&quot;] [unique_id
&quot;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">v at HpNH8AAAEAAEpCcrMAAAAe</A>&quot;]
Oct 19 15:05:15 server httpd[19010]: [error] [client ::1] ModSecurity:
[file
&quot;/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_60_correlation.conf&quot;]
[line &quot;41&quot;] [msg &quot;Transactional Anomaly Score (score 5): Request Missing
a Host Header&quot;] Warning. Operator GE matched 5 at TX:anomaly_score.
[hostname &quot;server&quot;] [uri &quot;/error/HTTP_BAD_REQUEST.html.var&quot;] [unique_id
&quot;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">v at HpNH8AAAEAAEpCcrMAAAAe</A>&quot;]
Oct 19 15:05:16 server httpd[19103]: [error] [client ::1] ModSecurity:
[file
&quot;/etc/httpd/modsecurity.d/optional_rules/modsecurity_crs_21_protocol_anomalies.conf&quot;]
[line &quot;35&quot;] [id &quot;960008&quot;] [msg &quot;Request Missing a Host Header&quot;]
[severity &quot;WARNING&quot;] [tag &quot;PROTOCOL_VIOLATION/MISSING_HEADER&quot;] Access
denied with code 400 (phase 2). Operator EQ matched 0 at
REQUEST_HEADERS. [hostname &quot;server&quot;] [uri &quot;*&quot;] [unique_id
&quot;v-ErhX8AAAEAAEqfn2kAAACn&quot;]
Oct 19 15:05:16 server httpd[19103]: [error] [client ::1] ModSecurity:
[file
&quot;/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_60_correlation.conf&quot;]
[line &quot;41&quot;] [msg &quot;Transactional Anomaly Score (score 5): Request Missing
a Host Header&quot;] Warning. Operator GE matched 5 at TX:anomaly_score.
[hostname &quot;server&quot;] [uri &quot;/error/HTTP_BAD_REQUEST.html.var&quot;] [unique_id
&quot;v-ErhX8AAAEAAEqfn2kAAACn&quot;]

In older rule sets, I made some rules to ruleRemoveById in requests from
localhost with the dummy user agent. Is this the best way to go or is
there a more elegant solution?


make sure you have enabled this file which has the exceptions for the dummy connection in it:

base_rules/modsecurity_crs_47_common_exceptions.conf

-B

--
Brian Rectanus
Breach Security



--
If a tree falls in the forest and no one is around to see it, do the other trees make fun of it?
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20091019/c85da6cd/attachment-0001.html">https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20091019/c85da6cd/attachment-0001.html</A> 
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000129.html">[Owasp-modsecurity-core-rule-set] Blocking Apache dummy	conections
</A></li>
	<LI>Next message: <A HREF="000132.html">[Owasp-modsecurity-core-rule-set] Blocking Apache dummy	conections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#130">[ date ]</a>
              <a href="thread.html#130">[ thread ]</a>
              <a href="subject.html#130">[ subject ]</a>
              <a href="author.html#130">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
