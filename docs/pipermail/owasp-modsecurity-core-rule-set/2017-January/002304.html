<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Problem with ModSecurity internal error flagged: TX: MSC_PCRE_LIMITS_EXCEEDED
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Problem%20with%20ModSecurity%0A%20internal%20error%20flagged%3A%20TX%3A%20MSC_PCRE_LIMITS_EXCEEDED&In-Reply-To=%3C20170105055912.GD31102%40elias%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002303.html">
   <LINK REL="Next"  HREF="002305.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Problem with ModSecurity internal error flagged: TX: MSC_PCRE_LIMITS_EXCEEDED</H1>
    <B>Christian Folini</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Problem%20with%20ModSecurity%0A%20internal%20error%20flagged%3A%20TX%3A%20MSC_PCRE_LIMITS_EXCEEDED&In-Reply-To=%3C20170105055912.GD31102%40elias%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] Problem with ModSecurity internal error flagged: TX: MSC_PCRE_LIMITS_EXCEEDED">christian.folini at netnea.com
       </A><BR>
    <I>Thu Jan  5 05:59:12 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="002303.html">[Owasp-modsecurity-core-rule-set] Problem with ModSecurity internal	error flagged: TX: MSC_PCRE_LIMITS_EXCEEDED
</A></li>
        <LI>Next message: <A HREF="002305.html">[Owasp-modsecurity-core-rule-set] CRS3 article on lwn.net
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2304">[ date ]</a>
              <a href="thread.html#2304">[ thread ]</a>
              <a href="subject.html#2304">[ subject ]</a>
              <a href="author.html#2304">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Gessy,

Sorry to hear about your problems. PCRE limit issues are common with the
CRS. They are an inherent problems when using PCRE and not all rules
are optimised to avoid it.

The limit is here to protect you from DoS via Regex (-&gt; REDoS). But in
the default ModSec setting the limit will stop a rule from being
executed. So if an attacker can construct the payload in a way that
fails with a PCRE limit exception - and still work as an exploit on the
backend - he has successfully circumvented one of your rules. Your
defense is raising the PCRE limits. Both, as you did. But this makes you
more vulnerable to REDoS. However in the age of the Mirai botnet,
REDoS might be your least DoS concern, so it is generally OK to
raise the limits to even higher levels. Personally, I run some prod
servers with a limit of 1M.

I investigated this throughly for the 2nd edition of the ModSecurity
Handbook. It was only at 1M that I started to see a performance impact.
You can monitor it fairly easily via the overall duration of the request
or the ModSecurity performance data for phase 2.

With that being said, I suggest you raise some more and then you look
at the rules in question. I would not mind you issuing some tickets
on github with the exact payload and the rules where you ran into
the PCRE limits.

I do not think you should disable the susceptible rules, but it is
generally OK to ignore the PCRE limit alerts. If you stick with the
default setting of ModSec and CRS, the rule is simply aborted and
execution continues with the next rule.

If this is still unclear, then just ask.

Ahoj,

Christian


On Wed, Jan 04, 2017 at 01:52:34PM +0000, Gessy wrote:
&gt;<i> Hi
</I>&gt;<i> Thanks to the community for all support and would like to ask one more
</I>&gt;<i> question
</I>&gt;<i> I used modsecurity with CRS 2.2.5 rules and everything worked as expected.
</I>&gt;<i> I have decided to upgrade to modsecurity 2.9.1 and CRS 3.0.0 by following
</I>&gt;<i> the INSTALL file.
</I>&gt;<i> 
</I>&gt;<i> Then I started having many blocking events with the message &quot;ModSecurity
</I>&gt;<i> internal error flagged: TX: MSC_PCRE_LIMITS_EXCEEDED&quot;
</I>&gt;<i> 
</I>&gt;<i> I googled it and tried the solution
</I>&gt;<i> 
</I>&gt;<i>      SecPcreMatchLimit 150000
</I>&gt;<i>      SecPcreMatchLimitRecursion 150000
</I>&gt;<i> 
</I>&gt;<i> But it did not work and it did not help to further increase the limits
</I>&gt;<i> 
</I>&gt;<i> So I thought about disabling the rule that generates this block but I saw
</I>&gt;<i> that several rules can generate this
</I>&gt;<i> 
</I>&gt;<i> I'm having many events of this mainly with sites that use shibboleth
</I>&gt;<i> authentication and I do not know how to solve it anymore ... Does anyone
</I>&gt;<i> know how to solve this problem?
</I>&gt;<i> 
</I>&gt;<i> Thank you so much!!!
</I>
&gt;<i> _______________________________________________
</I>&gt;<i> Owasp-modsecurity-core-rule-set mailing list
</I>&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>
</I>&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set</A>
</I>

-- 
<A HREF="https://www.feistyduck.com/training/modsecurity-training-course">https://www.feistyduck.com/training/modsecurity-training-course</A>
mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">christian.folini at netnea.com</A>
twitter: @ChrFolini
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002303.html">[Owasp-modsecurity-core-rule-set] Problem with ModSecurity internal	error flagged: TX: MSC_PCRE_LIMITS_EXCEEDED
</A></li>
	<LI>Next message: <A HREF="002305.html">[Owasp-modsecurity-core-rule-set] CRS3 article on lwn.net
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2304">[ date ]</a>
              <a href="thread.html#2304">[ thread ]</a>
              <a href="subject.html#2304">[ subject ]</a>
              <a href="author.html#2304">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
