<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Another bug in 2.0.7
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20Another%20bug%20in%202.0.7&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000423.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Another bug in 2.0.7</H1>
    <B>Josh Gee</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20Another%20bug%20in%202.0.7&In-Reply-To="
       TITLE="[Owasp-modsecurity-core-rule-set] Another bug in 2.0.7">securityadmin at hcjb.org
       </A><BR>
    <I>Thu Jul 22 09:23:38 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="000423.html">[Owasp-modsecurity-core-rule-set] ModSecurity Happy Hour at	Blackhat
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#424">[ date ]</a>
              <a href="thread.html#424">[ thread ]</a>
              <a href="subject.html#424">[ subject ]</a>
              <a href="author.html#424">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I can't seem to understand how, the
modsecurity_crs_21_protocol_anomalies.conf seems to reply 403 Forbidden
if the Accept Header is missing.  The rule that matches falls well below
the anomaly threshold, and yet the 403 error is returned anyway.  I've
enabled the AuditLog, searched the CRS, and I just can't figure out how
this happens. 

The strangest thing is that my DefaultAction for phase:2 is to set
status to 509, not 403, so I'm really confused as to how this behaviour
is happening.

I only discovered this when my podcasts broke.  iTunes (and many other
aggregators) don't send proper Accept Headers, and this rule was
silently throwing them away.

The only thing odd I found about these rules is that they don't have a
pass directive.  Adding this directive seems to make the rule behave as
designed (incrementing the anomaly score, but and allowing the
correlation to the blocking.  Is this the correct fix?

Josh


Here're the relevant rules (as I modified them):

        SecRule &amp;REQUEST_HEADERS:Accept &quot;@eq 0&quot; \
               
&quot;chain,phase:2,rev:'2.0.7',t:none,pass,nolog,auditlog,msg:'Request
Missing an Accept Header',
severity:'2',id:'960015',tag:'PROTOCOL_VIOLATION/MISSING_HEADER',tag:'WASCTC/WASC-21',tag:'OWASP_TOP_10/A7',tag:'PCI/6.5.10'&quot;
                SecRule REQUEST_METHOD &quot;!^OPTIONS$&quot;
&quot;skipAfter:END_ACCEPT_CHECK,t:none,setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.notice_anomaly_score},setvar:tx.protocol_violation_score=+%{tx.notice_anomaly_score},setvar:tx.%{rule.id}-PROTOCOL_VIOLATION/MISSING_HEADER-%{matched_var_name}=%{matched_var}&quot;
        SecRule REQUEST_HEADERS:Accept &quot;^$&quot; \
               
&quot;chain,phase:2,rev:'2.0.7',t:none,pass,nolog,auditlog,msg:'Request Has
an Empty Accept Header',
severity:'2',id:'960021',tag:'PROTOCOL_VIOLATION/MISSING_HEADER'&quot;
                SecRule REQUEST_METHOD &quot;!^OPTIONS$&quot;
&quot;t:none,setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.notice_anomaly_score},setvar:tx.protocol_violation_score=+%{tx.notice_anomaly_score},setvar:tx.%{rule.id}-PROTOCOL_VIOLATION/MISSING_HEADER-%{matched_var_name}=%{matched_var}&quot;


-- 
Joshua Gee
Director of Information Security
------------------------------------------------------------------------
HCJB Global - PO Box 39800 Colorado Springs, CO 80949-9800
Account 110504
------------------------------------------------------------------------

Email: <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">jgee at hcjbtech.org</A>
Phone: UK 1274 721 810
Skype: Gander78

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20100722/67894330/attachment-0001.html">https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20100722/67894330/attachment-0001.html</A> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: Image001.gif
Type: image/gif
Size: 9180 bytes
Desc: not available
Url : <A HREF="https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20100722/67894330/attachment-0001.gif">https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20100722/67894330/attachment-0001.gif</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000423.html">[Owasp-modsecurity-core-rule-set] ModSecurity Happy Hour at	Blackhat
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#424">[ date ]</a>
              <a href="thread.html#424">[ thread ]</a>
              <a href="subject.html#424">[ subject ]</a>
              <a href="author.html#424">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
