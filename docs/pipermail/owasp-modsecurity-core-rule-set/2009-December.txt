From misc.lists at blueyonder.co.uk  Tue Dec  1 15:17:53 2009
From: misc.lists at blueyonder.co.uk (Arthur Dent)
Date: Tue, 01 Dec 2009 20:17:53 +0000
Subject: [Owasp-modsecurity-core-rule-set] Squirrelmail denial
Message-ID: <1259698673.3053.45.camel@localhost>

Hello all,

My small website runs just for me and my family. On the same (Fedora11)
server I run dovecot at squirrelmail. This allows me to access my email
via the web from anywhere.

I use mod security and the crs as installed from Fedora's packages and
this weekend I upgraded to mod_security-2.5.10-2.fc11.i586. Since then I
get denials when accessing my mail with squirrelmail.

This is what appears in the httpd_error log:
[Tue Dec 01 15:56:11 2009] [error] [client 194.154.22.38] ModSecurity: Warning. Operator GE matched 5 at TX:anomaly_score. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_60_correlation.conf"] [line "41"] [msg "Transactional Anomaly Score (score 20): Detects JavaScript array properties and methods"] [hostname "www.mydomain.com"] [uri "/mywm/src/right_main.php"] [unique_id "SxU8m1IrkOUAAAdEOScAAAAH"]
[Tue Dec 01 17:27:13 2009] [error] [client 81.135.116.135] ModSecurity: Warning. Operator GE matched 5 at TX:anomaly_score. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_60_correlation.conf"] [line "41"] [msg "Transactional Anomaly Score (score 30): Request Missing a User Agent Header"] [hostname "www.mydomain.com"] [uri "/error/noindex.html"] [unique_id "SxVR8VIrkOUAAAc8bQUAAAAA"]

What should I do to enable squirrelmail once again?

Thanks in advance...

Mark

-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 197 bytes
Desc: This is a digitally signed message part
Url : https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20091201/b26e6e05/attachment.bin 

From ryan.barnett at breach.com  Tue Dec  1 15:37:37 2009
From: ryan.barnett at breach.com (Ryan Barnett)
Date: Tue, 1 Dec 2009 15:37:37 -0500
Subject: [Owasp-modsecurity-core-rule-set] Squirrelmail denial
In-Reply-To: <1259698673.3053.45.camel@localhost>
References: <1259698673.3053.45.camel@localhost>
Message-ID: <200912011537.37568.ryan.barnett@breach.com>

On Tuesday 01 December 2009 03:17:53 pm Arthur Dent wrote:
> Hello all,
> 
> My small website runs just for me and my family. On the same (Fedora11)
> server I run dovecot at squirrelmail. This allows me to access my email
> via the web from anywhere.
> 
> I use mod security and the crs as installed from Fedora's packages and
> this weekend I upgraded to mod_security-2.5.10-2.fc11.i586. Since then I
> get denials when accessing my mail with squirrelmail.
> 
> This is what appears in the httpd_error log:
> [Tue Dec 01 15:56:11 2009] [error] [client 194.154.22.38] ModSecurity:
>  Warning. Operator GE matched 5 at TX:anomaly_score. [file
>  "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_60_correlation.conf"]
>  [line "41"] [msg "Transactional Anomaly Score (score 20): Detects
>  JavaScript array properties and methods"] [hostname "www.mydomain.com"]
>  [uri "/mywm/src/right_main.php"] [unique_id "SxU8m1IrkOUAAAdEOScAAAAH"]
>  [Tue Dec 01 17:27:13 2009] [error] [client 81.135.116.135] ModSecurity:
>  Warning. Operator GE matched 5 at TX:anomaly_score. [file
>  "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_60_correlation.conf"]
>  [line "41"] [msg "Transactional Anomaly Score (score 30): Request Missing
>  a User Agent Header"] [hostname "www.mydomain.com"] [uri
>  "/error/noindex.html"] [unique_id "SxVR8VIrkOUAAAc8bQUAAAAA"]
> 
> What should I do to enable squirrelmail once again?
> 
> Thanks in advance...
> 
Hey Mark,
These entries in the error_log are the *correlated* events and give you 
details about the overall anomaly score and the last rule match message data.  
In order to identify what individual rules contributed to the anomaly score, 
you will need to review the modsec_audit.log file in Section H.  Once you have 
identified the false positive issues, then you can go to the 48 local 
exceptions file to implement a rule.

Let me know if you need more info.

-Ryan


From misc.lists at blueyonder.co.uk  Tue Dec  1 16:05:41 2009
From: misc.lists at blueyonder.co.uk (Arthur Dent)
Date: Tue, 01 Dec 2009 21:05:41 +0000
Subject: [Owasp-modsecurity-core-rule-set] Squirrelmail denial
In-Reply-To: <200912011537.37568.ryan.barnett@breach.com>
References: <1259698673.3053.45.camel@localhost>
	<200912011537.37568.ryan.barnett@breach.com>
Message-ID: <1259701541.3053.61.camel@localhost>

On Tue, 2009-12-01 at 15:37 -0500, Ryan Barnett wrote:
> On Tuesday 01 December 2009 03:17:53 pm Arthur Dent wrote:

[Snip]
> > 
> > What should I do to enable squirrelmail once again?
> > 
> > Thanks in advance...
> > 
> Hey Mark,
> These entries in the error_log are the *correlated* events and give you 
> details about the overall anomaly score and the last rule match message data.  
> In order to identify what individual rules contributed to the anomaly score, 
> you will need to review the modsec_audit.log file in Section H.  Once you have 
> identified the false positive issues, then you can go to the 48 local 
> exceptions file to implement a rule.
> 
> Let me know if you need more info.
> 
> -Ryan

Hi Ryan, thanks for the offer!

Here are the two most recent Section H's from audit.log. I'm afraid I
can't make head or tail of them... (apologies for the large block of
text):

--2f73da30-H--
Message: Match of "rx ^(?:(?:[a-z]{3,10}\\s+(?:\\w{3,7}?://[\\w\\-\\./]*(?::\\d+)?)?/[^?#]*(?:\\?[^#\\s]*)?(?:#[\\S]*)?|connect (?:\\d{1,3}\\.){3}\\d{1,3}\\.?(?::\\d+)?|options \\*)\\s+[\\w\\./]+|get /[^?#]*(?:\\?[^#\\s]*)?(?:#[\\S]*)?)$" against "REQUEST_LINE" required. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_20_protocol_violations.conf"] [line "21"] [id "960911"] [msg "Invalid HTTP Request Line"] [severity "WARNING"]
Message: Pattern match "^HTTP/0.9$" at REQUEST_PROTOCOL. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_21_protocol_anomalies.conf"] [line "22"] [id "960019"] [msg "HTTP/0.9 Request Detected"] [severity "WARNING"]
Message: Operator EQ matched 0 at REQUEST_HEADERS. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_21_protocol_anomalies.conf"] [line "27"] [id "960008"] [msg "Request Missing a Host Header"] [severity "NOTICE"] [tag "PROTOCOL_VIOLATION/MISSING_HEADER"]
Message: Match of "rx ^OPTIONS$" against "REQUEST_METHOD" required. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_21_protocol_anomalies.conf"] [line "37"] [id "960015"] [msg "Request Missing an Accept Header"] [severity "CRITICAL"] [tag "PROTOCOL_VIOLATION/MISSING_HEADER"]
Message: Operator EQ matched 0 at REQUEST_HEADERS. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_21_protocol_anomalies.conf"] [line "48"] [id "960009"] [msg "Request Missing a User Agent Header"] [severity "NOTICE"] [tag "PROTOCOL_VIOLATION/MISSING_HEADER"]
Message: Match of "rx ^((?:(?:POS|GE)T|OPTIONS|HEAD))$" against "REQUEST_METHOD" required. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_30_http_policy.conf"] [line "30"] [id "960032"] [msg "Method is not allowed by policy"] [severity "CRITICAL"] [tag "POLICY/METHOD_NOT_ALLOWED"]
Message: Warning. Operator GE matched 5 at TX:anomaly_score. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_60_correlation.conf"] [line "41"] [msg "Transactional Anomaly Score (score 30): Request Missing a User Agent Header"]
Action: Intercepted (phase 2)
Stopwatch: 1259688433125290 211710 (36725 65523 -)
Producer: ModSecurity for Apache/2.5.10 (http://www.modsecurity.org/); core ruleset/2.0.2.
Server: Apache/2.2.13 (Fedora)



--9d7a9107-H--
Message: Match of "rx ^OPTIONS$" against "REQUEST_METHOD" required. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_21_protocol_anomalies.conf"] [line "37"] [id "960015"] [msg "Request Missing an Accept Header"] [severity "CRITICAL"] [tag "PROTOCOL_VIOLATION/MISSING_HEADER"]
Message: Pattern match "^[\d.:]+$" at REQUEST_HEADERS:Host. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_21_protocol_anomalies.conf"] [line "62"] [id "960017"] [msg "Host header is a numeric IP address"] [severity "CRITICAL"] [tag "PROTOCOL_VIOLATION/IP_HOST"]
Message: Warning. Operator GE matched 5 at TX:anomaly_score. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_60_correlation.conf"] [line "41"] [msg "Transactional Anomaly Score (score 10): Host header is a numeric IP address"]
Stopwatch: 1259697664049828 126087 (5285 11539 55718)
Producer: ModSecurity for Apache/2.5.10 (http://www.modsecurity.org/); core ruleset/2.0.2.
Server: Apache/2.2.13 (Fedora)

I notice that in one of them there is reference to a numeric IP address.
I have a dynamic IP address so my domain is pointed to that using DYNDNS
and it is redirected to my server using a numeric IP address.

I used to have a modsecurity_crs_21_protocol_anomalies.conf file in
which I had commented out the line:
SecRule REQUEST_HEADERS:Host "^[\d\.]+$" "phase:2,t:none,deny,log,auditlog,status:400,msg:'Host header is a numeric IP address', severity:'2',id:'960017',tag:'PROTOCOL_VIOLATION/IP_HOST'"

I notice that I no longer have
modsecurity_crs_21_protocol_anomalies.conf

But is the numeric IP the only problem?

(and how do I implement a 48 local exception?)

Thanks for your help so far!

Mark


-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 197 bytes
Desc: This is a digitally signed message part
Url : https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20091201/2aa44876/attachment-0001.bin 

From ivan.ristic at gmail.com  Wed Dec  2 05:09:31 2009
From: ivan.ristic at gmail.com (Ivan Ristic)
Date: Wed, 2 Dec 2009 10:09:31 +0000
Subject: [Owasp-modsecurity-core-rule-set] Review of CRS 2.0.3
Message-ID: <1f9222b70912020209w4c9bb588r9120db85b6319d49@mail.gmail.com>

Hi,

I was on a plane a couple of weeks ago, with nothing better to do, so
I took the opportunity to review the Core Rule Set, as bundled with
ModSecurity 2.5.11. It is by no means a comprehensive review, but
perhaps I will make another pass at some point in the future.

Here are my observations:

- Why are there two scripts to interface to ClamAV (in the ModSecurity
distribution)? Any why are they under the rules/ folder, instead in
tools/ -- they can be useful with custom rules too.

- In README
  - Thanks for the mention of Apache Security. I have a book about
ModSecurity itself coming up ;)
  - Reading the installation instructions: I don?t think that rule
sets should have anything to do with ModSecurity configuration. They
just make automated updates impossible. ModSecurity itself should have
a default configuration file and leave it to the users to customise
it.
  - Google Analytics: The requirement to disable the rules in order to
support Google Analytics activation makes the rules a no-go in virtual
hosting environments.
  - About Regular Expressions: The optimisation of regular expressions
should be moved into ModSecurity and made transparent for users.
  - There?s no mention of the optional rules folder; what are those for?

- In modsecurity_crs_20_protocol_violations.conf
  - Typo in the header: "ModSecuirty".
  - There's a TODO entry right below the header, but there are no
instructions to do anything.
  - The rules that check for request body processor errors should not
be here. They should be part of ModSecurity configuration instead.
  - 960012: There is no real reason for ModSecurity 2.x to request
POST request to have C-L.
  - 960013: ?ModSecurity does not support chunked transfer encodings
at this time.? ? this is incorrect.
  - Many of these rules may or may not be doing the right thing, but I
have no way to validate what they are doing. I know I am asking for a
lot, but each rule should provide some reasoning that would help the
users understand why it is important. For example, rule 960021 does
not allow the Expect header to be used with HTTP/1.0 because it is an
HTTP/1.1 feature. But why should you care? Is there a way to abuse the
header in combination with HTTP/1.0?
  - The ?# Check UTF enconding? (sic) does not have an ID. Further, it
makes a global change, which affects all sites and all applications on
the server.
  - Rule 950801:
    - What is utf-8 is used on one script (page) on a site, but not in
another? How will this rule handle it?
    - Request headers never use utf-8 anyway (although you may get
utf-8 in User-Agent or Referer, as you know).
    - Request URIs allow for utf-8 in a general case, even when
applications use something else.
    - I think you only need to check ARGS here.
    - Rule 950116: Can the %u encoding really be used in request
headers? And in XML payloads?

- In crs_21:
  - If I must patch mod_unique_id to make a rule work, shouldn?t that
rule be disabled by default?

- In crs_23:
  - Apache limits shouldn?t be here. That too is part of someone's
configuration.

- In crs_30:
  - ModSecurity does support compressed content. It's true that there
were some problems with getting mod_deflate to run after ModSecurity,
but that should have been fixed.

- In crs_35:
  - Why not use parallel matching to discover bad user agents? It
would be easier to understand and maintain.

- In crs_40:
  - The HTTP Parameter Pollution rule does not have an ID. It?s very
creative in how it uses the rule language, but it warns on any
parameter that occurs more than once (and that is entirely
legitimate).
  - Why does rule 950907 use t:htmlEntityDecode? I would imagine that
transformation is only for attacks against a HTML surface. (The
question applies to many other rules. I also think t:urlDecodeUni is
used too liberally.
  - I see that the rules use ?block?, which is good, but they also use
?status:400?. Why?
  - It would be nice if you could explain how the transaction
variables are used for anomaly scoring and keeping the information on
matched variables around. It takes some deciphering to understand
what?s going on.
  - All the rules use tx.msg?won?t the messages overwrite one another?
That would make the messages emitted from crs_49 inconsistent.

You can tell from the review that I gave up looking into individual
rules at some point. With no documentation in the rules themselves,
the review would have taken days. After my review I have a sense that
the CRS has tremendous value (and an enormous improvement over the
previous version), but that it does not explain what it does. As such,
I can only treat the rules as a black box and hope for the best. The
final verdict to the usefulness can come only from someone using the
rules in production.

-- 
Ivan Ristic
ModSecurity Handbook [https://www.feistyduck.com]
SSL Labs [https://www.ssllabs.com/ssldb/]

From ryan.barnett at breach.com  Wed Dec  2 11:58:15 2009
From: ryan.barnett at breach.com (Ryan Barnett)
Date: Wed, 2 Dec 2009 11:58:15 -0500
Subject: [Owasp-modsecurity-core-rule-set] Review of CRS 2.0.3
In-Reply-To: <1f9222b70912020209w4c9bb588r9120db85b6319d49@mail.gmail.com>
References: <1f9222b70912020209w4c9bb588r9120db85b6319d49@mail.gmail.com>
Message-ID: <200912021158.15272.ryan.barnett@breach.com>

On Wednesday 02 December 2009 05:09:31 am Ivan Ristic wrote:
> Hi,
> 
> I was on a plane a couple of weeks ago, with nothing better to do, so
> I took the opportunity to review the Core Rule Set, as bundled with
> ModSecurity 2.5.11. It is by no means a comprehensive review, but
> perhaps I will make another pass at some point in the future.
> 
> Here are my observations:
> 
> - Why are there two scripts to interface to ClamAV (in the ModSecurity
> distribution)? Any why are they under the rules/ folder, instead in
> tools/ -- they can be useful with custom rules too.
> 
> - In README
>   - Thanks for the mention of Apache Security. I have a book about
> ModSecurity itself coming up ;)
>   - Reading the installation instructions: I don?t think that rule
> sets should have anything to do with ModSecurity configuration. They
> just make automated updates impossible. ModSecurity itself should have
> a default configuration file and leave it to the users to customise
> it.
>   - Google Analytics: The requirement to disable the rules in order to
> support Google Analytics activation makes the rules a no-go in virtual
> hosting environments.
>   - About Regular Expressions: The optimisation of regular expressions
> should be moved into ModSecurity and made transparent for users.
>   - There?s no mention of the optional rules folder; what are those for?
> 
> - In modsecurity_crs_20_protocol_violations.conf
>   - Typo in the header: "ModSecuirty".
>   - There's a TODO entry right below the header, but there are no
> instructions to do anything.
>   - The rules that check for request body processor errors should not
> be here. They should be part of ModSecurity configuration instead.
>   - 960012: There is no real reason for ModSecurity 2.x to request
> POST request to have C-L.
>   - 960013: ?ModSecurity does not support chunked transfer encodings
> at this time.? ? this is incorrect.
>   - Many of these rules may or may not be doing the right thing, but I
> have no way to validate what they are doing. I know I am asking for a
> lot, but each rule should provide some reasoning that would help the
> users understand why it is important. For example, rule 960021 does
> not allow the Expect header to be used with HTTP/1.0 because it is an
> HTTP/1.1 feature. But why should you care? Is there a way to abuse the
> header in combination with HTTP/1.0?
>   - The ?# Check UTF enconding? (sic) does not have an ID. Further, it
> makes a global change, which affects all sites and all applications on
> the server.
>   - Rule 950801:
>     - What is utf-8 is used on one script (page) on a site, but not in
> another? How will this rule handle it?
>     - Request headers never use utf-8 anyway (although you may get
> utf-8 in User-Agent or Referer, as you know).
>     - Request URIs allow for utf-8 in a general case, even when
> applications use something else.
>     - I think you only need to check ARGS here.
>     - Rule 950116: Can the %u encoding really be used in request
> headers? And in XML payloads?
> 
> - In crs_21:
>   - If I must patch mod_unique_id to make a rule work, shouldn?t that
> rule be disabled by default?
> 
> - In crs_23:
>   - Apache limits shouldn?t be here. That too is part of someone's
> configuration.
> 
> - In crs_30:
>   - ModSecurity does support compressed content. It's true that there
> were some problems with getting mod_deflate to run after ModSecurity,
> but that should have been fixed.
> 
> - In crs_35:
>   - Why not use parallel matching to discover bad user agents? It
> would be easier to understand and maintain.
> 
> - In crs_40:
>   - The HTTP Parameter Pollution rule does not have an ID. It?s very
> creative in how it uses the rule language, but it warns on any
> parameter that occurs more than once (and that is entirely
> legitimate).
>   - Why does rule 950907 use t:htmlEntityDecode? I would imagine that
> transformation is only for attacks against a HTML surface. (The
> question applies to many other rules. I also think t:urlDecodeUni is
> used too liberally.
>   - I see that the rules use ?block?, which is good, but they also use
> ?status:400?. Why?
>   - It would be nice if you could explain how the transaction
> variables are used for anomaly scoring and keeping the information on
> matched variables around. It takes some deciphering to understand
> what?s going on.
>   - All the rules use tx.msg?won?t the messages overwrite one another?
> That would make the messages emitted from crs_49 inconsistent.
> 
> You can tell from the review that I gave up looking into individual
> rules at some point. With no documentation in the rules themselves,
> the review would have taken days. After my review I have a sense that
> the CRS has tremendous value (and an enormous improvement over the
> previous version), but that it does not explain what it does. As such,
> I can only treat the rules as a black box and hope for the best. The
> final verdict to the usefulness can come only from someone using the
> rules in production.
> 

Outstanding feedback Ivan!  I agree with your final conclusion and I believe 
that the right course of action is to utilize the OWASP CRS project site for 
the full documentation.  I am planning to update the site with this info... 
when I have time....  Once I start documenting these items, I will ping the 
mail-list so everyone can review, comment and hopefully, join in and replicate 
the process and document stuff themselves.

-Ryan

From john.bhaskar at wipro.com  Thu Dec  3 05:11:27 2009
From: john.bhaskar at wipro.com (john.bhaskar at wipro.com)
Date: Thu, 3 Dec 2009 15:41:27 +0530
Subject: [Owasp-modsecurity-core-rule-set] FW: Requred details for
	mod_security on 64 bit Linux| help
Message-ID: <565EE13E5783404FB19C699AEF735CF014A7A5@MYS-MIA-MSG.wipro.com>

 

Hi

 

I would like to know is there is any separate
mod_security-apache_2.5.11.tar.gz (evolution) need to be downloaded for
64bit Linux environment?

 

Since we are having two types of environment 32  & 64 bit RHEL Linux,
kindly suggest  us further OS dependency in terms of bits for
mod_security.

 

Thanks in advance.

 

Regards

JOhn


Please do not print this email unless it is absolutely necessary. 

The information contained in this electronic message and any attachments to this message are intended for the exclusive use of the addressee(s) and may contain proprietary, confidential or privileged information. If you are not the intended recipient, you should not disseminate, distribute or copy this e-mail. Please notify the sender immediately and destroy all copies of this message and any attachments. 

WARNING: Computer viruses can be transmitted via email. The recipient should check this email and any attachments for the presence of viruses. The company accepts no liability for any damage caused by any virus transmitted by this email. 

www.wipro.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20091203/8f429655/attachment.html 

From misc.lists at blueyonder.co.uk  Thu Dec  3 07:04:24 2009
From: misc.lists at blueyonder.co.uk (Arthur Dent)
Date: Thu, 3 Dec 2009 12:04:24 +0000
Subject: [Owasp-modsecurity-core-rule-set] Squirrelmail denial
In-Reply-To: <1259701541.3053.61.camel@localhost>
References: <1259698673.3053.45.camel@localhost>
	<200912011537.37568.ryan.barnett@breach.com>
	<1259701541.3053.61.camel@localhost>
Message-ID: <20091203120424.GA12196@troodos.org.uk>

On Tue, Dec 01, 2009 at 09:05:41PM +0000, Arthur Dent wrote:
> On Tue, 2009-12-01 at 15:37 -0500, Ryan Barnett wrote:
> > On Tuesday 01 December 2009 03:17:53 pm Arthur Dent wrote:
> 
> [Snip]
> > > 
> > > What should I do to enable squirrelmail once again?
> > > 
> > > Thanks in advance...
> > > 
> > Hey Mark,
> > These entries in the error_log are the *correlated* events and give you 
> > details about the overall anomaly score and the last rule match message data.  
> > In order to identify what individual rules contributed to the anomaly score, 
> > you will need to review the modsec_audit.log file in Section H.  Once you have 
> > identified the false positive issues, then you can go to the 48 local 
> > exceptions file to implement a rule.
> > 
> > Let me know if you need more info.
> > 
> > -Ryan
> 
> Hi Ryan, thanks for the offer!
> 
> Here are the two most recent Section H's from audit.log. I'm afraid I
> can't make head or tail of them... (apologies for the large block of
> text):
> 
> --2f73da30-H--
> Message: Match of "rx ^(?:(?:[a-z]{3,10}\\s+(?:\\w{3,7}?://[\\w\\-\\./]*(?::\\d+)?)?/[^?#]*(?:\\?[^#\\s]*)?(?:#[\\S]*)?|connect (?:\\d{1,3}\\.){3}\\d{1,3}\\.?(?::\\d+)?|options \\*)\\s+[\\w\\./]+|get /[^?#]*(?:\\?[^#\\s]*)?(?:#[\\S]*)?)$" against "REQUEST_LINE" required. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_20_protocol_violations.conf"] [line "21"] [id "960911"] [msg "Invalid HTTP Request Line"] [severity "WARNING"]
> Message: Pattern match "^HTTP/0.9$" at REQUEST_PROTOCOL. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_21_protocol_anomalies.conf"] [line "22"] [id "960019"] [msg "HTTP/0.9 Request Detected"] [severity "WARNING"]
> Message: Operator EQ matched 0 at REQUEST_HEADERS. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_21_protocol_anomalies.conf"] [line "27"] [id "960008"] [msg "Request Missing a Host Header"] [severity "NOTICE"] [tag "PROTOCOL_VIOLATION/MISSING_HEADER"]
> Message: Match of "rx ^OPTIONS$" against "REQUEST_METHOD" required. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_21_protocol_anomalies.conf"] [line "37"] [id "960015"] [msg "Request Missing an Accept Header"] [severity "CRITICAL"] [tag "PROTOCOL_VIOLATION/MISSING_HEADER"]
> Message: Operator EQ matched 0 at REQUEST_HEADERS. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_21_protocol_anomalies.conf"] [line "48"] [id "960009"] [msg "Request Missing a User Agent Header"] [severity "NOTICE"] [tag "PROTOCOL_VIOLATION/MISSING_HEADER"]
> Message: Match of "rx ^((?:(?:POS|GE)T|OPTIONS|HEAD))$" against "REQUEST_METHOD" required. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_30_http_policy.conf"] [line "30"] [id "960032"] [msg "Method is not allowed by policy"] [severity "CRITICAL"] [tag "POLICY/METHOD_NOT_ALLOWED"]
> Message: Warning. Operator GE matched 5 at TX:anomaly_score. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_60_correlation.conf"] [line "41"] [msg "Transactional Anomaly Score (score 30): Request Missing a User Agent Header"]
> Action: Intercepted (phase 2)
> Stopwatch: 1259688433125290 211710 (36725 65523 -)
> Producer: ModSecurity for Apache/2.5.10 (http://www.modsecurity.org/); core ruleset/2.0.2.
> Server: Apache/2.2.13 (Fedora)
> 
> 
> 
> --9d7a9107-H--
> Message: Match of "rx ^OPTIONS$" against "REQUEST_METHOD" required. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_21_protocol_anomalies.conf"] [line "37"] [id "960015"] [msg "Request Missing an Accept Header"] [severity "CRITICAL"] [tag "PROTOCOL_VIOLATION/MISSING_HEADER"]
> Message: Pattern match "^[\d.:]+$" at REQUEST_HEADERS:Host. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_21_protocol_anomalies.conf"] [line "62"] [id "960017"] [msg "Host header is a numeric IP address"] [severity "CRITICAL"] [tag "PROTOCOL_VIOLATION/IP_HOST"]
> Message: Warning. Operator GE matched 5 at TX:anomaly_score. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_60_correlation.conf"] [line "41"] [msg "Transactional Anomaly Score (score 10): Host header is a numeric IP address"]
> Stopwatch: 1259697664049828 126087 (5285 11539 55718)
> Producer: ModSecurity for Apache/2.5.10 (http://www.modsecurity.org/); core ruleset/2.0.2.
> Server: Apache/2.2.13 (Fedora)
> 
> I notice that in one of them there is reference to a numeric IP address.
> I have a dynamic IP address so my domain is pointed to that using DYNDNS
> and it is redirected to my server using a numeric IP address.
> 
> I used to have a modsecurity_crs_21_protocol_anomalies.conf file in
> which I had commented out the line:
> SecRule REQUEST_HEADERS:Host "^[\d\.]+$" "phase:2,t:none,deny,log,auditlog,status:400,msg:'Host header is a numeric IP address', severity:'2',id:'960017',tag:'PROTOCOL_VIOLATION/IP_HOST'"
> 
> I notice that I no longer have
> modsecurity_crs_21_protocol_anomalies.conf
> 
> But is the numeric IP the only problem?
> 
> (and how do I implement a 48 local exception?)
> 
> Thanks for your help so far!

OK forgive my ignorance. I realised soon after I sent this that the structure
and location of the crs had changed and that I do in fact have a
modsecurity_crs_21_protocol_anomalies.conf file - it's just that it's now in a
"base_rules" directory. Sorry. I have commented out the (similar) rule about
numeric IP address, but I am still getting denials with squirrelmail. Any
ideas from the above log info as to what I should change?

Thanks again

Mark

ps

Section H from today's denial (with numeric IP rule commented out):
--22f31753-H--
Message: Pattern match
"([^*:\s\w,.\/?+-]\s*)?(?<![a-z]\s)(?<![a-z\/_@>\-\|])(\s*return\s*)?(?:join|pop|push|reverse|reduce|concat|map|shift|sp?lice|sort|unshift)(?(1)[^\w%"]|(?:\s*[^@\s\w%,.+\-]))"
at REQUEST_URI_RAW. [file
"/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_41_phpids_filters.conf"]
[line "53"] [id "phpids-18"] [msg "Detects JavaScript array properties and
methods"] [data "&sort="] [severity "CRITICAL"] [tag "WEB_ATTACK"]
Message: Warning. Operator GE matched 5 at TX:anomaly_score. [file
"/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_60_correlation.conf"]
[line "41"] [msg "Transactional Anomaly Score (score 20): Detects JavaScript
array properties and methods"]
Action: Intercepted (phase 2)
Apache-Handler: php5-script
Stopwatch: 1259841664114003 27655 (6852 25106 -)
Producer: ModSecurity for Apache/2.5.10 (http://www.modsecurity.org/); core
ruleset/2.0.2.
Server: Apache/2.2.13 (Fedora)



> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 197 bytes
Desc: not available
Url : https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20091203/057141ff/attachment.bin 

From ryan.barnett at breach.com  Thu Dec  3 08:24:32 2009
From: ryan.barnett at breach.com (Ryan Barnett)
Date: Thu, 3 Dec 2009 08:24:32 -0500
Subject: [Owasp-modsecurity-core-rule-set] Squirrelmail denial
In-Reply-To: <20091203120424.GA12196@troodos.org.uk>
References: <1259698673.3053.45.camel@localhost>
	<1259701541.3053.61.camel@localhost>
	<20091203120424.GA12196@troodos.org.uk>
Message-ID: <200912030824.32581.ryan.barnett@breach.com>

On Thursday 03 December 2009 07:04:24 am Arthur Dent wrote:
> On Tue, Dec 01, 2009 at 09:05:41PM +0000, Arthur Dent wrote:
> > On Tue, 2009-12-01 at 15:37 -0500, Ryan Barnett wrote:
> > > On Tuesday 01 December 2009 03:17:53 pm Arthur Dent wrote:
-- SNIP --
> 
> OK forgive my ignorance. I realised soon after I sent this that the
>  structure and location of the crs had changed and that I do in fact have a
> modsecurity_crs_21_protocol_anomalies.conf file - it's just that it's now
>  in a "base_rules" directory. Sorry. I have commented out the (similar)
>  rule about numeric IP address, but I am still getting denials with
>  squirrelmail. Any ideas from the above log info as to what I should
>  change?
> 
> Thanks again
> 
> Mark
> 
> ps
> 
> Section H from today's denial (with numeric IP rule commented out):
> --22f31753-H--
> Message: Pattern match
> "([^*:\s\w,.\/?+-]\s*)?(?<![a-z]\s)(?<![a-z\/_@>\-\|])(\s*return\s*)?(?:joi
> n|pop|push|reverse|reduce|concat|map|shift|sp?lice|sort|unshift)(?(1)[^\w%"
> ]|(?:\s*[^@\s\w%,.+\-]))" at REQUEST_URI_RAW. [file
> "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_41_phpids_filters.conf
> "] [line "53"] [id "phpids-18"] [msg "Detects JavaScript array properties
>  and methods"] [data "&sort="] [severity "CRITICAL"] [tag "WEB_ATTACK"]
>  Message: Warning. Operator GE matched 5 at TX:anomaly_score. [file
>  "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_60_correlation.conf"]
>  [line "41"] [msg "Transactional Anomaly Score (score 20): Detects
>  JavaScript array properties and methods"]
> Action: Intercepted (phase 2)
> Apache-Handler: php5-script
> Stopwatch: 1259841664114003 27655 (6852 25106 -)
> Producer: ModSecurity for Apache/2.5.10 (http://www.modsecurity.org/); core
> ruleset/2.0.2.
> Server: Apache/2.2.13 (Fedora)
> 

Two comments -

1) The rule match above is from the converted PHPIDS filters 
(http://phpids.org/) and it is looking for potentially malicious JS in input.  

2) v2.0.3 of the CRS was recently releases and I see that you are using 
v2.0.2.  I would suggest an upgrade  (see CHANGES listed below).  After the 
upgrade, it you run into this issue again, please send an example of the 
audit_log entry of this request so that we can see the full request.  Based on 
that data, then you can look at implementing an exception.

--------------------------
Version 2.0.4 - 11/30/2009
--------------------------

Improvements:
- Updated converted PHPIDS signatures (https://svn.php-
ids.org/svn/trunk/lib/IDS/default_filter.xml)
- Updated PHPIDS rules logic to first search for payloads in ARGS and then if 
there is no match found
  then search more generically in request_body|request_uri_raw
- Updated PHPIDS rules logic to only set TX variables and to not log.  This 
allows for more clean
  exceptions in the 48 file which can then expire/delete false positive TX 
matches and adjust the
  anomaly scores.  These rules will then inspect for any TX variables in 
phase:5 and create appropriate
  alerts for any variable matches that exist.

Bug Fixes:
- Added Anomaly Score check to the 60 correlation file to recheck the anomaly 
score at the end of
  phase:4 which would allow for blocking based on information leakage issues.



-Ryan


From misc.lists at blueyonder.co.uk  Thu Dec  3 09:19:00 2009
From: misc.lists at blueyonder.co.uk (Arthur Dent)
Date: Thu, 3 Dec 2009 14:19:00 +0000
Subject: [Owasp-modsecurity-core-rule-set] Squirrelmail denial
In-Reply-To: <200912030824.32581.ryan.barnett@breach.com>
References: <1259698673.3053.45.camel@localhost>
	<1259701541.3053.61.camel@localhost>
	<20091203120424.GA12196@troodos.org.uk>
	<200912030824.32581.ryan.barnett@breach.com>
Message-ID: <20091203141900.GA13205@troodos.org.uk>

> 
> Two comments -
> 
> 1) The rule match above is from the converted PHPIDS filters 
> (http://phpids.org/) and it is looking for potentially malicious JS in input.  
> 
> 2) v2.0.3 of the CRS was recently releases and I see that you are using 
> v2.0.2.  I would suggest an upgrade  (see CHANGES listed below).  After the 
> upgrade, it you run into this issue again, please send an example of the 
> audit_log entry of this request so that we can see the full request.  Based on 
> that data, then you can look at implementing an exception.
> 
> --------------------------
> Version 2.0.4 - 11/30/2009
> --------------------------
> 
> Improvements:
> - Updated converted PHPIDS signatures (https://svn.php-
> ids.org/svn/trunk/lib/IDS/default_filter.xml)
> - Updated PHPIDS rules logic to first search for payloads in ARGS and then if 
> there is no match found
>   then search more generically in request_body|request_uri_raw
> - Updated PHPIDS rules logic to only set TX variables and to not log.  This 
> allows for more clean
>   exceptions in the 48 file which can then expire/delete false positive TX 
> matches and adjust the
>   anomaly scores.  These rules will then inspect for any TX variables in 
> phase:5 and create appropriate
>   alerts for any variable matches that exist.
> 
> Bug Fixes:
> - Added Anomaly Score check to the 60 correlation file to recheck the anomaly 
> score at the end of
>   phase:4 which would allow for blocking based on information leakage issues.

Hi - This seems like good advice. The trouble is I have installed ModSec on my
F11 box using Fedora's package management system. Currently this is version
mod_security-2.5.10-2.fc11.i586

Even in the Rawhide (development) repository the version number is the same
(2.5.10-2.fc13). I could of course install from source but, where possible, I
prefer to use the Fedora packages.

My question therefore is - is it possible simply to update the CRS?

If so how?

Thanks for the support!

Mark
  
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 197 bytes
Desc: not available
Url : https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20091203/eb2eb08e/attachment-0001.bin 

From ryan.barnett at breach.com  Thu Dec  3 09:23:24 2009
From: ryan.barnett at breach.com (Ryan Barnett)
Date: Thu, 3 Dec 2009 09:23:24 -0500
Subject: [Owasp-modsecurity-core-rule-set] Squirrelmail denial
In-Reply-To: <20091203141900.GA13205@troodos.org.uk>
References: <1259698673.3053.45.camel@localhost>
	<200912030824.32581.ryan.barnett@breach.com>
	<20091203141900.GA13205@troodos.org.uk>
Message-ID: <200912030923.24565.ryan.barnett@breach.com>

On Thursday 03 December 2009 09:19:00 am Arthur Dent wrote:
> > Two comments -
> >
> > 1) The rule match above is from the converted PHPIDS filters
> > (http://phpids.org/) and it is looking for potentially malicious JS in
> > input.
> >
> > 2) v2.0.3 of the CRS was recently releases and I see that you are using
> > v2.0.2.  I would suggest an upgrade  (see CHANGES listed below).  After
> > the upgrade, it you run into this issue again, please send an example of
> > the audit_log entry of this request so that we can see the full request. 
> > Based on that data, then you can look at implementing an exception.
> >
> > --------------------------
> > Version 2.0.4 - 11/30/2009
> > --------------------------
> >
> > Improvements:
> > - Updated converted PHPIDS signatures (https://svn.php-
> > ids.org/svn/trunk/lib/IDS/default_filter.xml)
> > - Updated PHPIDS rules logic to first search for payloads in ARGS and
> > then if there is no match found
> >   then search more generically in request_body|request_uri_raw
> > - Updated PHPIDS rules logic to only set TX variables and to not log. 
> > This allows for more clean
> >   exceptions in the 48 file which can then expire/delete false positive
> > TX matches and adjust the
> >   anomaly scores.  These rules will then inspect for any TX variables in
> > phase:5 and create appropriate
> >   alerts for any variable matches that exist.
> >
> > Bug Fixes:
> > - Added Anomaly Score check to the 60 correlation file to recheck the
> > anomaly score at the end of
> >   phase:4 which would allow for blocking based on information leakage
> > issues.
> 
> Hi - This seems like good advice. The trouble is I have installed ModSec on
>  my F11 box using Fedora's package management system. Currently this is
>  version mod_security-2.5.10-2.fc11.i586
> 
> Even in the Rawhide (development) repository the version number is the same
> (2.5.10-2.fc13). I could of course install from source but, where possible,
>  I prefer to use the Fedora packages.
> 
> My question therefore is - is it possible simply to update the CRS?
> 
> If so how?
> 

The latest version is always located from the Download link on the project 
site - 
http://www.owasp.org/index.php/Category:OWASP_ModSecurity_Core_Rule_Set_Project#tab=Download

-Ryan 


From s.bhatia at qut.edu.au  Thu Dec  3 21:45:59 2009
From: s.bhatia at qut.edu.au (SAJAL BHATIA)
Date: Fri, 4 Dec 2009 12:45:59 +1000
Subject: [Owasp-modsecurity-core-rule-set] Regarding the core rule set
Message-ID: <EF5541F04426FD40ACD8600636961B470CBF5569D9@QUTEXMBX02.qut.edu.au>

Hi, 

I have installed the Mod Security Module into my Apache2 server using libapache-mod-security. Since I am using Ubuntu distribution it was available through aptitude. Now I want to incorporate the core rule set and test if the installed Mod Security module is working. Can you suggest me the appropriate way to perform these two tasks. 

Awaiting for a prompt response. 

Thanks and Regards 

----
Sajal Bhatia
Research Masters Student
QUT, Brisbane
AUSTRALIA

From misc.lists at blueyonder.co.uk  Fri Dec  4 06:59:42 2009
From: misc.lists at blueyonder.co.uk (Arthur Dent)
Date: Fri, 4 Dec 2009 11:59:42 +0000
Subject: [Owasp-modsecurity-core-rule-set] Squirrelmail denial
In-Reply-To: <200912030923.24565.ryan.barnett@breach.com>
References: <1259698673.3053.45.camel@localhost>
	<200912030824.32581.ryan.barnett@breach.com>
	<20091203141900.GA13205@troodos.org.uk>
	<200912030923.24565.ryan.barnett@breach.com>
Message-ID: <20091204115942.GA20706@troodos.org.uk>

On Thu, Dec 03, 2009 at 09:23:24AM -0500, Ryan Barnett wrote:
> > 
> > My question therefore is - is it possible simply to update the CRS?
> > 
> > If so how?
> > 
> 
> The latest version is always located from the Download link on the project 
> site - 
> http://www.owasp.org/index.php/Category:OWASP_ModSecurity_Core_Rule_Set_Project#tab=Download
> 
Hi Ryan,

CRS v2.0.4 fixed the problem (as far as I have been able to test so far) so a
huge Thank You from me...

Cheers

Mark
 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 197 bytes
Desc: not available
Url : https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20091204/bbec8b33/attachment.bin 

From uchu.1 at gaiahost.coop  Sun Dec  6 13:29:38 2009
From: uchu.1 at gaiahost.coop (Charles Uchu Strader)
Date: Sun, 06 Dec 2009 13:29:38 -0500
Subject: [Owasp-modsecurity-core-rule-set] Theoretical Bot-Infected Users
	and Legitimate Traffic
Message-ID: <4B1BF812.3000906@gaiahost.coop>

Pretty new to mod_security...I've got a theoretical scenario question:

Any thoughts or experience in discovering if a scenario like this can 
cause valid site requests to be blocked?  My concern is related to high 
traffic sites and the potential loss of valid traffic and business to 
the site.

My example would be an end-user of a web site, their browser/computer 
has been infected by some malicious bot.  This bot inserts malicious 
code into the legitimate web traffic of that user, in attempts to hack 
the web sites the user is using, and thus proliferate the malicious code 
more. 

The end-user, going about their normal routine of not keeping fully up 
to date with anti-virus protection continues to go about their routine 
without knowledge of their own infection. 

a) They visit a site with mod_security in place and some of their 
requests are blocked because of the inline bot.    The business 
operating the site loses the traffic and legitimate business.  Customer 
is left confused/frustrated.

b) In a scenario without mod_security in place, but where the 
application itself is hardened against the malicious attempts, the 
request would be fulfilled as the malicious junk would be stripped from 
the request.  The business operating the site gets related legitimate 
traffic and customer is left happy...though still infected.

Thanks,

Charles



From nhamxuannam at yahoo.com  Mon Dec  7 02:47:35 2009
From: nhamxuannam at yahoo.com (Nham Xuan Nam)
Date: Sun, 6 Dec 2009 23:47:35 -0800 (PST)
Subject: [Owasp-modsecurity-core-rule-set] How to log matched rules in core
	ruleset 2.x
Message-ID: <832535.59763.qm@web50103.mail.re2.yahoo.com>

Hi all,

We are currently using modsecuriy with core ruleset 1.6.1 and we want to upgrade our core ruleset to 2.x version. As I know, in this new version, core ruleset uses anomaly_score to detect attacks. When the anomaly_score is higher than a certain value, the request will be deny and the information is logged.

But in this way, the logged information did not show us information about the rules which are matched and contributed to the anomaly score (especially the rule id). This is a very useful information. Currently, we use this logs to do some statistics and other things. Do you know any way to log rule-id of the matched rules to the apache error_log?

Please help me. Thanks in advance.

Nam.



      Get your preferred Email name!
Now you can @ymail.com and @rocketmail.com. 
http://mail.promotions.yahoo.com/newdomains/aa/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20091206/e7f376c2/attachment.html 

From ryan.barnett at breach.com  Mon Dec  7 08:47:26 2009
From: ryan.barnett at breach.com (Ryan Barnett)
Date: Mon, 7 Dec 2009 08:47:26 -0500
Subject: [Owasp-modsecurity-core-rule-set] How to log matched rules in
	core ruleset 2.x
In-Reply-To: <832535.59763.qm@web50103.mail.re2.yahoo.com>
References: <832535.59763.qm@web50103.mail.re2.yahoo.com>
Message-ID: <200912070847.26354.ryan.barnett@breach.com>

On Monday 07 December 2009 02:47:35 am Nham Xuan Nam wrote:
> Hi all,
> 
> We are currently using modsecuriy with core ruleset 1.6.1 and we want to
>  upgrade our core ruleset to 2.x version. As I know, in this new version,
>  core ruleset uses anomaly_score to detect attacks. When the anomaly_score
>  is higher than a certain value, the request will be deny and the
>  information is logged.
> 
> But in this way, the logged information did not show us information about
>  the rules which are matched and contributed to the anomaly score
>  (especially the rule id). This is a very useful information. Currently, we
>  use this logs to do some statistics and other things. Do you know any way
>  to log rule-id of the matched rules to the apache error_log?
> 
> Please help me. Thanks in advance.
> 

If you want to see which rules matched and contributed to the anomaly score 
value, then you need to look at the audit log file.  All of the rules that 
matched will be present under Section H.  One of the goals of CRS v2 was to 
make the alerts less noisy.  Most people just wanted a correlated type of 
event which would tell them what happened.

You bring up a good point though and that is to include more meta-data within 
the correlated event.  Ivan Ristic brought up a similar issue last week in his 
CRS review email and this was that the correlated event msg data is only 
showing the *last* rule msg that triggered.  This is due to the current config 
where a rule match will overwrite the existing msg variable with the current 
one.  A better approach would be too *append* the msg data.  To your point - 
we could also do the same thing with the rule ids.  Basically, we could give 
more meta-data in the correlated event, such as the number of rules that 
matched and their associated rule ids and/or messages.

I will look into this.

-Ryan


From ryan.barnett at breach.com  Mon Dec  7 09:08:51 2009
From: ryan.barnett at breach.com (Ryan Barnett)
Date: Mon, 7 Dec 2009 09:08:51 -0500
Subject: [Owasp-modsecurity-core-rule-set] Theoretical Bot-Infected
	Users and Legitimate Traffic
In-Reply-To: <4B1BF812.3000906@gaiahost.coop>
References: <4B1BF812.3000906@gaiahost.coop>
Message-ID: <200912070908.51068.ryan.barnett@breach.com>

On Sunday 06 December 2009 01:29:38 pm Charles Uchu Strader wrote:
> Pretty new to mod_security...I've got a theoretical scenario question:
> 
> Any thoughts or experience in discovering if a scenario like this can
> cause valid site requests to be blocked?  My concern is related to high
> traffic sites and the potential loss of valid traffic and business to
> the site.
> 
> My example would be an end-user of a web site, their browser/computer
> has been infected by some malicious bot.  This bot inserts malicious
> code into the legitimate web traffic of that user, in attempts to hack
> the web sites the user is using, and thus proliferate the malicious code
> more.
> 
Most bot/malware/mand-in-the-browser code that I have heard of works by 
sending their *own* requests mixed in with the user's legitimate ones.  This 
is very similar to CSRF from the web application's perspective 
(http://www.webappsec.org/lists/websecurity/archive/2007-09/msg00011.html).  
This works since the browser will automatically submit the proper SessionID 
cookie data with the malware request.

This is different, however, then what I believe you proposing that that is that 
the bot is actually manipulating a legit request and adding in additional 
data, which I don't believe really happens in practice. 

> The end-user, going about their normal routine of not keeping fully up
> to date with anti-virus protection continues to go about their routine
> without knowledge of their own infection.
> 
> a) They visit a site with mod_security in place and some of their
> requests are blocked because of the inline bot.    The business
> operating the site loses the traffic and legitimate business.  Customer
> is left confused/frustrated.
> 
As I outlined above, I don't believe that most malware code works like this.  
I believe that the requests sent by the malware are separate requests and in 
this case ModSecurity would block those requests.

> b) In a scenario without mod_security in place, but where the
> application itself is hardened against the malicious attempts, the
> request would be fulfilled as the malicious junk would be stripped from
> the request.  The business operating the site gets related legitimate
> traffic and customer is left happy...though still infected.
> 
The interesting point that I take away from this scenario is that of 
*sanitizing* of request data.  It has been asked many times before if 
ModSecurity can sanitize either inbound or outbound data and the answer is no.  
ModSecurity simply takes a copy of the transactional data and runs its checks 
against it and then a specific action can be applied.  There are some technical 
workarounds for possibly dabbling in this concept however the academic issue 
is that sanitizing of input is dangerous and tough to do correctly.  This type 
of activity should be done inside the app code.

An interesting topic that this does raise is letting a back-end web 
application know that we (the WAF) have identified some anomalous activity and 
that we think that this transaction might be malicious.  One concept that we 
look into further is for the WAF to add additional request headers to the 
inbound transaction (say WAF_Anomaly_Score=45) and this would allow the app 
server to possibly inspect this header data and then factor it into some 
decisions about processing/sanitizing the data.  This idea of data sharing has 
some merit.

-Ryan


From nhamxuannam at yahoo.com  Mon Dec  7 11:55:53 2009
From: nhamxuannam at yahoo.com (Nham Xuan Nam)
Date: Mon, 7 Dec 2009 08:55:53 -0800 (PST)
Subject: [Owasp-modsecurity-core-rule-set] How to log matched rules in
	core ruleset 2.x
In-Reply-To: <200912070847.26354.ryan.barnett@breach.com>
References: <832535.59763.qm@web50103.mail.re2.yahoo.com>
	<200912070847.26354.ryan.barnett@breach.com>
Message-ID: <47309.95956.qm@web50108.mail.re2.yahoo.com>

Hi Ryan,

I also think of using the audit log file but it does not satisfy our situation. I think that the audit log file contains a lot of information and it is only suitable for debugging. Currenly, we are using CRS 1.x which output matched rules in apache error log. Then we use some tools to parse apache error log to do some statistics and monitor activity of the rules (based on the rule id). Unfortunately, CRSv2 is using a different approach and we can't do this anymore.

Anyway, thank a lot for your consideration. I am looking forward to the later version of CRS.

-Nam.




________________________________
From: Ryan Barnett <ryan.barnett at breach.com>
To: owasp-modsecurity-core-rule-set at lists.owasp.org
Cc: Nham Xuan Nam <nhamxuannam at yahoo.com>
Sent: Monday, December 7, 2009 20:47:26
Subject: Re: [Owasp-modsecurity-core-rule-set] How to log matched rules in core ruleset 2.x

On Monday 07 December 2009 02:47:35 am Nham Xuan Nam wrote:
> Hi all,
> 
> We are currently using modsecuriy with core ruleset 1.6.1 and we want to
>  upgrade our core ruleset to 2.x version. As I know, in this new version,
>  core ruleset uses anomaly_score to detect attacks. When the anomaly_score
>  is higher than a certain value, the request will be deny and the
>  information is logged.
> 
> But in this way, the logged information did not show us information about
>  the rules which are matched and contributed to the anomaly score
>  (especially the rule id). This is a very useful information. Currently, we
>  use this logs to do some statistics and other things. Do you know any way
>  to log rule-id of the matched rules to the apache error_log?
> 
> Please help me. Thanks in advance.
> 

If you want to see which rules matched and contributed to the anomaly score 
value, then you need to look at the audit log file.  All of the rules that 
matched will be present under Section H.  One of the goals of CRS v2 was to 
make the alerts less noisy.  Most people just wanted a correlated type of 
event which would tell them what happened.

You bring up a good point though and that is to include more meta-data within 
the correlated event.  Ivan Ristic brought up a similar issue last week in his 
CRS review email and this was that the correlated event msg data is only 
showing the *last* rule msg that triggered.  This is due to the current config 
where a rule match will overwrite the existing msg variable with the current 
one.  A better approach would be too *append* the msg data.  To your point - 
we could also do the same thing with the rule ids.  Basically, we could give 
more meta-data in the correlated event, such as the number of rules that 
matched and their associated rule ids and/or messages.

I will look into this.

-Ryan


      Get your preferred Email name!
Now you can @ymail.com and @rocketmail.com. 
http://mail.promotions.yahoo.com/newdomains/aa/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20091207/e4fa83a6/attachment-0001.html 

From Brian.Rectanus at breach.com  Mon Dec  7 12:27:21 2009
From: Brian.Rectanus at breach.com (Brian Rectanus)
Date: Mon, 07 Dec 2009 09:27:21 -0800
Subject: [Owasp-modsecurity-core-rule-set] Theoretical
 Bot-Infected	Users and Legitimate Traffic
In-Reply-To: <200912070908.51068.ryan.barnett@breach.com>
References: <4B1BF812.3000906@gaiahost.coop>
	<200912070908.51068.ryan.barnett@breach.com>
Message-ID: <4B1D3AF9.2080402@breach.com>



Ryan Barnett wrote:
> On Sunday 06 December 2009 01:29:38 pm Charles Uchu Strader wrote:
>> Pretty new to mod_security...I've got a theoretical scenario question:
>>
>> Any thoughts or experience in discovering if a scenario like this can
>> cause valid site requests to be blocked?  My concern is related to high
>> traffic sites and the potential loss of valid traffic and business to
>> the site.
>>
>> My example would be an end-user of a web site, their browser/computer
>> has been infected by some malicious bot.  This bot inserts malicious
>> code into the legitimate web traffic of that user, in attempts to hack
>> the web sites the user is using, and thus proliferate the malicious code
>> more.
>>
> Most bot/malware/mand-in-the-browser code that I have heard of works by 
> sending their *own* requests mixed in with the user's legitimate ones.  This 
> is very similar to CSRF from the web application's perspective 
> (http://www.webappsec.org/lists/websecurity/archive/2007-09/msg00011.html).  
> This works since the browser will automatically submit the proper SessionID 
> cookie data with the malware request.
> 
> This is different, however, then what I believe you proposing that that is that 
> the bot is actually manipulating a legit request and adding in additional 
> data, which I don't believe really happens in practice. 
> 
>> The end-user, going about their normal routine of not keeping fully up
>> to date with anti-virus protection continues to go about their routine
>> without knowledge of their own infection.
>>
>> a) They visit a site with mod_security in place and some of their
>> requests are blocked because of the inline bot.    The business
>> operating the site loses the traffic and legitimate business.  Customer
>> is left confused/frustrated.
>>
> As I outlined above, I don't believe that most malware code works like this.  
> I believe that the requests sent by the malware are separate requests and in 
> this case ModSecurity would block those requests.
> 
>> b) In a scenario without mod_security in place, but where the
>> application itself is hardened against the malicious attempts, the
>> request would be fulfilled as the malicious junk would be stripped from
>> the request.  The business operating the site gets related legitimate
>> traffic and customer is left happy...though still infected.
>>
> The interesting point that I take away from this scenario is that of 
> *sanitizing* of request data.  It has been asked many times before if 
> ModSecurity can sanitize either inbound or outbound data and the answer is no.  
> ModSecurity simply takes a copy of the transactional data and runs its checks 
> against it and then a specific action can be applied.  There are some technical 
> workarounds for possibly dabbling in this concept however the academic issue 
> is that sanitizing of input is dangerous and tough to do correctly.  This type 
> of activity should be done inside the app code.
> 
> An interesting topic that this does raise is letting a back-end web 
> application know that we (the WAF) have identified some anomalous activity and 
> that we think that this transaction might be malicious.  One concept that we 
> look into further is for the WAF to add additional request headers to the 
> inbound transaction (say WAF_Anomaly_Score=45) and this would allow the app 
> server to possibly inspect this header data and then factor it into some 
> decisions about processing/sanitizing the data.  This idea of data sharing has 
> some merit.

I think that the basic scenario that you propose here is already
happening, but it has nothing to do with ModSecurity.  This is also a
reason that I think many larger sites just choose not to block (or at
least only block under extreme situations).

Consider this, though:

A user/customer is infected with spyware.  This spyware generally slows
things down and often makes the browser unstable (especially with more
than one type of spyware involved).  This spyware can insert ads/links
in pages, record data/login credentials, etc.  It can also attempt
(potentially harmful) requests on the users behalf.  But it can also
render the browser so unstable that a site can no longer be used
reliably.  Because of this, the site loses traffic and thus revenue.  In
addition to this, the site loses face with the customer as, from the
user's perspective, is the fault of the site, not theRyan Barnett
<ryan.barnett at breach.com> browser/spyware.

You can see that you can have the same problems you described, but
without ModSecurity (or any other WAF).  But, there is more to your
scenerio.  With a WAF in place, the site administrator can see into some
of this foul play and hopefully do something about it.  There is nothing
that says that you have to block.  I also think Ryan is correct that by
adding a header or similar, this could add even more value, similar to
how email anti-spam/virus works today.

-B

-- 
Brian Rectanus
Breach Security

From ivan.ristic at gmail.com  Mon Dec  7 15:24:31 2009
From: ivan.ristic at gmail.com (Ivan Ristic)
Date: Mon, 7 Dec 2009 20:24:31 +0000
Subject: [Owasp-modsecurity-core-rule-set] Review of CRS 2.0.3
In-Reply-To: <200912021158.15272.ryan.barnett@breach.com>
References: <1f9222b70912020209w4c9bb588r9120db85b6319d49@mail.gmail.com>
	<200912021158.15272.ryan.barnett@breach.com>
Message-ID: <1f9222b70912071224n7fc9e870ic7807886afa7a2a7@mail.gmail.com>

Another thing: I've noticed that some of the ET rules still have the
snort-style character escaping in them (e.g. | 3d |).

-- 
Ivan Ristic
ModSecurity Handbook [https://www.feistyduck.com]
SSL Labs [https://www.ssllabs.com/ssldb/]

From colin.watson at owasp.org  Tue Dec  8 07:15:32 2009
From: colin.watson at owasp.org (Colin Watson)
Date: Tue, 8 Dec 2009 12:15:32 +0000
Subject: [Owasp-modsecurity-core-rule-set] Theoretical Bot-Infected
	Users and Legitimate Traffic
In-Reply-To: <200912070908.51068.ryan.barnett@breach.com>
References: <4B1BF812.3000906@gaiahost.coop>
	<200912070908.51068.ryan.barnett@breach.com>
Message-ID: <b46e4cdd0912080415u2ed3abc5ve7942c70890bf3d9@mail.gmail.com>

Ryan

There has been a little bit of a discussion about this data sharing:

> An interesting topic that this does raise is letting a back-end web
> application know that we (the WAF) have identified some anomalous activity and
> that we think that this transaction might be malicious. ?One concept that we
> look into further is for the WAF to add additional request headers to the
> inbound transaction (say WAF_Anomaly_Score=45) and this would allow the app
> server to possibly inspect this header data and then factor it into some
> decisions about processing/sanitizing the data. ?This idea of data sharing has
> some merit.

on the OWASP AppSensor mailing list.

  https://lists.owasp.org/pipermail/owasp-appsensor-project/

I mentioned there, the specification for Firefox's Content Security
Policy has a violation report syntax:

  https://wiki.mozilla.org/Security/CSP/Spec#Violation_Report_Syntax

which can be used by the user agent to send an XML report back to the
content provider.  If the application can combine data from multiple
sources (WAF, user agent, XML firewall, OS, etc), the combination of
remote and "local" sensors could be more powerful.  But we'd need a
standard way of doing this... HTTP headers, HTTP requests, syslogs,
????

Colin

From ossec.junkie at gmail.com  Wed Dec  9 02:57:15 2009
From: ossec.junkie at gmail.com (OSSEC junkie)
Date: Tue, 8 Dec 2009 23:57:15 -0800
Subject: [Owasp-modsecurity-core-rule-set] Question about RBL Match for SPAM
	Source Rule
Message-ID: <869a38360912082357h5b5d43bdm20cafd448314efdc@mail.gmail.com>

All:

I am testing out this rule in our environment and wondered if this
rule is a simple add into the /base_rules folder then restart Apache
for this rule to take affect?  I removed the block action right now so
I can gauge the traffic going through and operate in a pass-through
type of configuration but have yet to see any sort of RBL action in
the logs.  Any ideas?  I know we get lots of activity from IP
Addresses that are known bad according to spamhaus.

SecRule &IP:SPAMMER "@eq 0"
"chain,phase:1,t:none,block,nolog,auditlog,msg:'RBL Match for SPAM
Source',tag:'AUTOMATION/MALICIOUS',severity:'2',skipAfter:END_RBL_CHECK"
	SecRule REMOTE_ADDR "@rbl sbl-xbl.spamhaus.org" \
        "t:none,setvar:'tx.msg=%{rule.msg}',setvar:tx.automation_score=+1,setvar:tx.anomaly_score=+20,setvar:'tx.%{rule.id}=%{matched_var_name}=%{matched_var}',setvar:ip.spammer=1,expirevar:ip.spammer=86400"

SecRule IP:SPAMMER "@eq 1"
"phase:1,t:none,block,nolog,auditlog,msg:'RBL Match for SPAM
Source',tag:'AUTOMATION/MALICIOUS',severity:'2',setvar:'tx.msg=%{rule.msg}',setvar:tx.automation_score=+1,setvar:tx.anomaly_score=+20,setvar:'tx.%{rule.id}=%{matched_var_name}=%{matched_var}'"

SecMarker END_RBL_CHECK

Thanks

From ryan.barnett at breach.com  Wed Dec  9 10:46:09 2009
From: ryan.barnett at breach.com (Ryan Barnett)
Date: Wed, 9 Dec 2009 10:46:09 -0500
Subject: [Owasp-modsecurity-core-rule-set] Question about RBL Match for
	SPAM Source Rule
In-Reply-To: <869a38360912082357h5b5d43bdm20cafd448314efdc@mail.gmail.com>
References: <869a38360912082357h5b5d43bdm20cafd448314efdc@mail.gmail.com>
Message-ID: <200912091046.09960.ryan.barnett@breach.com>

On Wednesday 09 December 2009 02:57:15 am OSSEC junkie wrote:
> All:
> 
> I am testing out this rule in our environment and wondered if this
> rule is a simple add into the /base_rules folder then restart Apache
> for this rule to take affect?  

One option would be to simply include the modsecurity_42_comment_spam.conf file 
in you apache config and comment out the other rules in that file that you don't 
want to run.

> I removed the block action right now so
> I can gauge the traffic going through and operate in a pass-through
> type of configuration but have yet to see any sort of RBL action in
> the logs.  Any ideas?  I know we get lots of activity from IP
> Addresses that are known bad according to spamhaus.
> 
> SecRule &IP:SPAMMER "@eq 0"
> "chain,phase:1,t:none,block,nolog,auditlog,msg:'RBL Match for SPAM
> Source',tag:'AUTOMATION/MALICIOUS',severity:'2',skipAfter:END_RBL_CHECK"
> 	SecRule REMOTE_ADDR "@rbl sbl-xbl.spamhaus.org" \
>        
>  "t:none,setvar:'tx.msg=%{rule.msg}',setvar:tx.automation_score=+1,setvar:t
> x.anomaly_score=+20,setvar:'tx.%{rule.id}=%{matched_var_name}=%{matched_var
> }',setvar:ip.spammer=1,expirevar:ip.spammer=86400"
> 
> SecRule IP:SPAMMER "@eq 1"
> "phase:1,t:none,block,nolog,auditlog,msg:'RBL Match for SPAM
> Source',tag:'AUTOMATION/MALICIOUS',severity:'2',setvar:'tx.msg=%{rule.msg}'
> ,setvar:tx.automation_score=+1,setvar:tx.anomaly_score=+20,setvar:'tx.%{rul
> e.id}=%{matched_var_name}=%{matched_var}'"
> 
> SecMarker END_RBL_CHECK
> 
> Thanks

There were a few changes needed for these RBL rules to work as intended.  They 
are fixed in the v2.0.5 update which will be released shortly.

1) The first issue that you seemed to be running into was related to the use of 
the skipAfter action being in the 1st line of a chained rule.  This action 
needed to be moved to the *last* line of the rule so that it would skip to the 
end of this section only *after* performing the RBL check.  This is a similar 
type of gotcha as with the ctl actions as they trigger based on the individual 
rule match and not the entire rule chain.

2) We needed to update the logic of the rules.  The idea was to try and 
minimize the amount of actual RBL checks that are executed (as the majority of 
traffic will be from non-spam sources).  So, we want to run an RBL check once 
per source IP per/day and save the results.  Here is an update ruleset for you 
to test -

SecRule IP:PREVIOUS_RBL_CHECK "@eq 1" 
"phase:1,t:none,pass,nolog,skipAfter:END_RBL_LOOKUP"
  SecRule REMOTE_ADDR "@rbl sbl-xbl.spamhaus.org" 
"phase:1,t:none,block,nolog,auditlog,msg:'RBL Match for SPAM 
Source',tag:'AUTOMATION/MALICIOUS',severity:'2',setvar:'tx.msg=%{rule.msg}',setvar:tx.automation_score=+1,setvar:tx.anomaly_score=+20,setvar:tx.
%{rule.id}-
AUTOMATION/MALICIOUS-%{rule.severity}-%{rule.msg}-%{matched_var_name}=%{matched_var},setvar:ip.spammer=1,expirevar:ip.spammer=86400,setvar:ip.previous_rbl_check=1,expirevar:ip.previous_rbl_check=86400,skipAfter:END_RBL_CHECK"

  SecAction 
"phase:1.t:none,nolog,pass,setvar:ip.previous_rbl_check=1,expirevar:ip.previous_rbl_check=86400"
SecMarker END_RBL_LOOKUP

SecRule IP:SPAMMER "@eq 1" "phase:1,t:none,block,nolog,auditlog,msg:'Request 
from Known SPAM Source (Previous RBL 
Match)',tag:'AUTOMATION/MALICIOUS',severity:'2',setvar:'tx.msg=%{rule.msg}',setvar:tx.automation_score=+1,setvar:tx.anomaly_score=+20,setvar:tx.
%{rule.id}-
AUTOMATION/MALICIOUS-%{rule.severity}-%{rule.msg}-%{matched_var_name}=%{matched_var}"

SecMarker END_RBL_CHECK



From Brian.Rectanus at breach.com  Wed Dec  9 10:50:25 2009
From: Brian.Rectanus at breach.com (Brian Rectanus)
Date: Wed, 09 Dec 2009 07:50:25 -0800
Subject: [Owasp-modsecurity-core-rule-set] Question about RBL Match for
 SPAM	Source Rule
In-Reply-To: <869a38360912082357h5b5d43bdm20cafd448314efdc@mail.gmail.com>
References: <869a38360912082357h5b5d43bdm20cafd448314efdc@mail.gmail.com>
Message-ID: <4B1FC741.6040702@breach.com>

OSSEC junkie wrote:
> All:
> 
> I am testing out this rule in our environment and wondered if this
> rule is a simple add into the /base_rules folder then restart Apache
> for this rule to take affect?  I removed the block action right now so

It is if the file was included (ie you used Include /path/to/*.conf).
But I don't recommend that. Instead I always Include all the files and
comment out the ones I don't want.

> I can gauge the traffic going through and operate in a pass-through
> type of configuration but have yet to see any sort of RBL action in
> the logs.  Any ideas?  I know we get lots of activity from IP
> Addresses that are known bad according to spamhaus.
> 

The IP collection is initialized above this rule
(initcol:IP=%{REMOTE_ADDR} or similar)?

> SecRule &IP:SPAMMER "@eq 0"
> "chain,phase:1,t:none,block,nolog,auditlog,msg:'RBL Match for SPAM
> Source',tag:'AUTOMATION/MALICIOUS',severity:'2',skipAfter:END_RBL_CHECK"
> 	SecRule REMOTE_ADDR "@rbl sbl-xbl.spamhaus.org" \
>         "t:none,setvar:'tx.msg=%{rule.msg}',setvar:tx.automation_score=+1,setvar:tx.anomaly_score=+20,setvar:'tx.%{rule.id}=%{matched_var_name}=%{matched_var}',setvar:ip.spammer=1,expirevar:ip.spammer=86400"

The above should set IP:SPAMMER to 1 if it did not exist for that IP and
was in the RBL.  Although I believe that the skipAfter should be in the
chained rule, not the starter (it may always be firing).  Check the
debug log (level 9 and search for SPAMMER) and see what is up.

> 
> SecRule IP:SPAMMER "@eq 1"
> "phase:1,t:none,block,nolog,auditlog,msg:'RBL Match for SPAM
> Source',tag:'AUTOMATION/MALICIOUS',severity:'2',setvar:'tx.msg=%{rule.msg}',setvar:tx.automation_score=+1,setvar:tx.anomaly_score=+20,setvar:'tx.%{rule.id}=%{matched_var_name}=%{matched_var}'"

Since you used anomaly scoring, make sure it actually exceeded your
threshold or I don't think it will be logged to the error log.

-B

-- 
Brian Rectanus
Breach Security

From ryan.barnett at breach.com  Wed Dec  9 11:00:04 2009
From: ryan.barnett at breach.com (Ryan Barnett)
Date: Wed, 9 Dec 2009 11:00:04 -0500
Subject: [Owasp-modsecurity-core-rule-set]
 =?iso-8859-1?q?Question_about_R?=
 =?iso-8859-1?q?BL_Match_for_SPAM=09Source_Rule?=
In-Reply-To: <4B1FC741.6040702@breach.com>
References: <869a38360912082357h5b5d43bdm20cafd448314efdc@mail.gmail.com>
	<4B1FC741.6040702@breach.com>
Message-ID: <200912091100.04178.ryan.barnett@breach.com>

On Wednesday 09 December 2009 10:50:25 am Brian Rectanus wrote:
> OSSEC junkie wrote:
> > All:
> >
> > I am testing out this rule in our environment and wondered if this
> > rule is a simple add into the /base_rules folder then restart Apache
> > for this rule to take affect?  I removed the block action right now so
> 
> It is if the file was included (ie you used Include /path/to/*.conf).
> But I don't recommend that. Instead I always Include all the files and
> comment out the ones I don't want.
> 
> > I can gauge the traffic going through and operate in a pass-through
> > type of configuration but have yet to see any sort of RBL action in
> > the logs.  Any ideas?  I know we get lots of activity from IP
> > Addresses that are known bad according to spamhaus.
> 
> The IP collection is initialized above this rule
> (initcol:IP=%{REMOTE_ADDR} or similar)?
> 

Both a global and ip collection are initiated at the bottom of the 
modsecurity_crs_10_global_config.conf file.

From ossec.junkie at gmail.com  Wed Dec  9 17:09:56 2009
From: ossec.junkie at gmail.com (OSSEC junkie)
Date: Wed, 9 Dec 2009 14:09:56 -0800
Subject: [Owasp-modsecurity-core-rule-set] Fwd: Question about RBL Match for
	SPAM Source Rule
In-Reply-To: <869a38360912091403w6a96ccd0q796c56281c19d4aa@mail.gmail.com>
References: <869a38360912082357h5b5d43bdm20cafd448314efdc@mail.gmail.com>
	<4B1FC741.6040702@breach.com>
	<200912091100.04178.ryan.barnett@breach.com>
	<869a38360912091403w6a96ccd0q796c56281c19d4aa@mail.gmail.com>
Message-ID: <869a38360912091409y4bab36e0w704dfd084970eb5e@mail.gmail.com>

Thank you both for the feedback, I'm going to tryout the new rule set
right now.  Also, did you ever think about trying to integrate more
RBL features with Project Honeypot?  Also, if you have any
experimental rules, I would be more than happy to help you test them
out.
-


On Wed, Dec 9, 2009 at 8:00 AM, Ryan Barnett <ryan.barnett at breach.com> wrote:
> On Wednesday 09 December 2009 10:50:25 am Brian Rectanus wrote:
>> OSSEC junkie wrote:
>> > All:
>> >
>> > I am testing out this rule in our environment and wondered if this
>> > rule is a simple add into the /base_rules folder then restart Apache
>> > for this rule to take affect? ?I removed the block action right now so
>>
>> It is if the file was included (ie you used Include /path/to/*.conf).
>> But I don't recommend that. Instead I always Include all the files and
>> comment out the ones I don't want.
>>
>> > I can gauge the traffic going through and operate in a pass-through
>> > type of configuration but have yet to see any sort of RBL action in
>> > the logs. ?Any ideas? ?I know we get lots of activity from IP
>> > Addresses that are known bad according to spamhaus.
>>
>> The IP collection is initialized above this rule
>> (initcol:IP=%{REMOTE_ADDR} or similar)?
>>
>
> Both a global and ip collection are initiated at the bottom of the
> modsecurity_crs_10_global_config.conf file.
>

From ossec.junkie at gmail.com  Thu Dec 10 01:46:21 2009
From: ossec.junkie at gmail.com (OSSEC junkie)
Date: Wed, 9 Dec 2009 22:46:21 -0800
Subject: [Owasp-modsecurity-core-rule-set] Question about RBL Match for
	SPAM Source Rule
In-Reply-To: <869a38360912091409y4bab36e0w704dfd084970eb5e@mail.gmail.com>
References: <869a38360912082357h5b5d43bdm20cafd448314efdc@mail.gmail.com>
	<4B1FC741.6040702@breach.com>
	<200912091100.04178.ryan.barnett@breach.com>
	<869a38360912091403w6a96ccd0q796c56281c19d4aa@mail.gmail.com>
	<869a38360912091409y4bab36e0w704dfd084970eb5e@mail.gmail.com>
Message-ID: <869a38360912092246x30c7fff7ie6a99ace82d0e722@mail.gmail.com>

I'm actually getting errors when I attempt to start Apache after
inserting the rules.  I did a straight copy and paste from the example
you gave me into my configuration file and restarted Apache.  The
error is:
Invalid command 'phase:1,t:none,pass,nolog,skipAfter:END_RBL_LOOKUP',
perhaps misspelled or defined by a module not included in the server
configuration

If I wanted to not do anomaly scoring, would this be the proper configuration?

"phase:1,t:none,pass,nolog,skipAfter:END_RBL_LOOKUP"
 SecRule REMOTE_ADDR "@rbl sbl-xbl.spamhaus.org"

 "phase:1,t:none,block,nolog,auditlog,msg:'RBL Match for SPAM
Source',id:'959901',tag:'AUTOMATION/MALICIOUS',logdata:'%{TX.0}',severity:'2'



AUTOMATION/MALICIOUS-%{rule.severity}-%{rule.msg}-%{matched_var_name}=%{matched_var},setvar:ip.spammer=1,expirevar:ip.spammer=86400,setvar:ip.previous_rbl_check=1,expirevar:ip.previous_rbl_check=86400,skipAfter:END_RBL_CHECK"

 SecAction
"phase:1.t:none,nolog,pass,setvar:ip.previous_rbl_check=1,expirevar:ip.previous_rbl_check=86400"
SecMarker END_RBL_LOOKUP

SecRule IP:SPAMMER "@eq 1" "phase:1,t:none,block,nolog,auditlog,msg:'Request
from Known SPAM Source (Previous RBL
Match)',id:'959902',tag:'AUTOMATION/MALICIOUS',logdata:'%{TX.0}',severity:'2'


AUTOMATION/MALICIOUS-%{rule.severity}-%{rule.msg}-%{matched_var_name}=%{matched_var}"

SecMarker END_RBL_CHECK

Any ideas?

Thanks!

From ibeginhere at gmail.com  Thu Dec 10 04:11:53 2009
From: ibeginhere at gmail.com (ll)
Date: Thu, 10 Dec 2009 17:11:53 +0800
Subject: [Owasp-modsecurity-core-rule-set] =?gb2312?b?bm8gcnVsZSBJRCCjvw==?=
Message-ID: <4B20BB59.9030208@gmail.com>

in the newest rule set( modsecurity-crs_2.0.3) ,there are not rule id in

some rule .eg.
SecRule REQUEST_URI_RAW|REQUEST_BODY
"\bon(abort|blur|change|click|dblclick|dragdrop|error|\
focus|keydown|keypress|keyup|load|mousedown|mousemove|mouseout\
|mouseover|mouseup|move|readystatechange|reset|resize|select|submit|unload)\b\W*?="
\
"phase:2,t:none,t:lowercase,block,nolog,auditlog,msg:'XSS Attack
Detected',setvar:'tx.msg=%{rule.msg}',setvar:tx.xss_score=+1,setvar:tx.anomaly_score=+20,setvar:tx.%{rule.id}-WEB_ATTACK/XSS-%{matched_var_name}=%{matched_var}"

In my server ,this is a False Positive for some url.and I want to
disable it for there url.
but there are no rule id,I can't SecRuleRemoveById.




From ryan.barnett at breach.com  Thu Dec 10 09:11:48 2009
From: ryan.barnett at breach.com (Ryan Barnett)
Date: Thu, 10 Dec 2009 09:11:48 -0500
Subject: [Owasp-modsecurity-core-rule-set] =?iso-2022-jp?b?bm8gcnVsZSBJ?=
 =?iso-2022-jp?b?RCAbJEIhKRsoQg==?=
In-Reply-To: <4B20BB59.9030208@gmail.com>
References: <4B20BB59.9030208@gmail.com>
Message-ID: <200912100911.48210.ryan.barnett@breach.com>

On Thursday 10 December 2009 04:11:53 am ll wrote:
> in the newest rule set( modsecurity-crs_2.0.3) ,there are not rule id in
> 
> some rule .eg.
> SecRule REQUEST_URI_RAW|REQUEST_BODY
> "\bon(abort|blur|change|click|dblclick|dragdrop|error|\
> focus|keydown|keypress|keyup|load|mousedown|mousemove|mouseout\
> 
> |mouseover|mouseup|move|readystatechange|reset|resize|select|submit|unload)
> |\b\W*?="
> 
> \
> "phase:2,t:none,t:lowercase,block,nolog,auditlog,msg:'XSS Attack
> Detected',setvar:'tx.msg=%{rule.msg}',setvar:tx.xss_score=+1,setvar:tx.anom
> aly_score=+20,setvar:tx.%{rule.id}-WEB_ATTACK/XSS-%{matched_var_name}=%{mat
> ched_var}"
> 
> In my server ,this is a False Positive for some url.and I want to
> disable it for there url.
> but there are no rule id,I can't SecRuleRemoveById.
> 
> 

We will go back through the rule set to ensure that all rules have a rule id.  
That being said, you can still go to the 48 local exceptions file and add in 
rule there.

If you send an example audit log entry of this false positive, I could send 
you an example exception.

-Ryan

From ryan.barnett at breach.com  Thu Dec 10 10:42:21 2009
From: ryan.barnett at breach.com (Ryan Barnett)
Date: Thu, 10 Dec 2009 10:42:21 -0500
Subject: [Owasp-modsecurity-core-rule-set] Question about RBL Match for
	SPAM Source Rule
In-Reply-To: <869a38360912092246x30c7fff7ie6a99ace82d0e722@mail.gmail.com>
References: <869a38360912082357h5b5d43bdm20cafd448314efdc@mail.gmail.com>
	<869a38360912091409y4bab36e0w704dfd084970eb5e@mail.gmail.com>
	<869a38360912092246x30c7fff7ie6a99ace82d0e722@mail.gmail.com>
Message-ID: <200912101042.21390.ryan.barnett@breach.com>

On Thursday 10 December 2009 01:46:21 am OSSEC junkie wrote:
> I'm actually getting errors when I attempt to start Apache after
> inserting the rules.  I did a straight copy and paste from the example
> you gave me into my configuration file and restarted Apache.  The
> error is:
> Invalid command 'phase:1,t:none,pass,nolog,skipAfter:END_RBL_LOOKUP',
> perhaps misspelled or defined by a module not included in the server
> configuration
> 

I think this is an issue of email munging up the rules formatting.

I will send you a direct email with an attachment of the rules.

-Ryan

From ibeginhere at gmail.com  Thu Dec 10 20:35:21 2009
From: ibeginhere at gmail.com (ll)
Date: Fri, 11 Dec 2009 09:35:21 +0800
Subject: [Owasp-modsecurity-core-rule-set] =?iso-2022-jp?b?bm8gcnVsZSBJ?=
 =?iso-2022-jp?b?RCAgGyRCISkbKEI=?=
In-Reply-To: <200912100911.48210.ryan.barnett@breach.com>
References: <4B20BB59.9030208@gmail.com>
	<200912100911.48210.ryan.barnett@breach.com>
Message-ID: <4B21A1D9.50906@gmail.com>

Yes ,I'm reading the 48 local excetions.but still confuse.here is my
auditlog, thanks your help.I just want to disable this rule for this url
(/news/abc.swf?id=20091211&style=3)
,other website still need to be inspect
--cecdfa17-A--
[10/Dec/2009:16:22:14 +0800] SyCvtdJMQTgAABXDVjcAAAAC 127.0.0.1 60252
127.0.0.1 8000
--cecdfa17-B--
GET /news/abc.swf?id=20091211&style=3 HTTP/1.1
Accept: */*
Referer: http://www.abc.com/news/index.html
Accept-Language: zh-cn
UA-CPU: x86
Accept-Encoding: gzip, deflate
User-Agent: Mozilla/4.0 ()
Host: www.abc.com
Cookie: JSESSIONID=869946B0D9D6C75C3600E22E54A2C172


--cecdfa17-F--
HTTP/1.1 403 Forbidden
Content-Length: 286
Content-Type: text/html; charset=iso-8859-1

--cecdfa17-H--
Message: Access denied with code 403 (phase 2). Operator GE matched 20
at TX:anomaly_score. [file
"/etc/conf/modsecurity-crs_2.0.3/base_rules/modsecurity_crs_49_enforcement.conf"]
[line "25"] [msg "Anomaly Score Exceeded (score 20): XSS Attack Detected"]
Action: Intercepted (phase 2)
Apache-Handler: proxy-server
Stopwatch: 1260433333972585 876832 (6983 798741 -)
Producer: ModSecurity for Apache/2.5.7 (http://www.modsecurity.org/);
core ruleset/2.0.3.
Server: Apache/2.2.11 (Unix) mod_ssl/2.2.11 OpenSSL/0.9.8b
WebApp-Info: "abc" "-" "-"

--cecdfa17-K--
SecAction
"phase:1,t:none,pass,nolog,initcol:global=global,initcol:ip=%{remote_addr}"
SecRule "REQUEST_METHOD" "@rx ^(?:GET|HEAD)$"
"phase:2,chain,t:none,block,nolog,auditlog,status:400,msg:'GET or HEAD
requests with bodies',severity:2,id:960011,tag:PROTOCOL_VIOLATION/EVASION"
SecRule "&REQUEST_HEADERS:Content-Type" "@eq 0"
"phase:2,pass,chain,t:none,nolog,auditlog,msg:'Request Containing
Content, but Missing Content-Type header',id:960904,severity:5"
SecRule "ARGS_NAMES" "@rx .*"
"phase:2,chain,t:none,nolog,auditlog,pass,capture,setvar:tx.arg_name_%{tx.0}=+1,msg:'Possible
HTTP Parameter Pollution Attack: Multiple Parameters with the same Name.'"
SecRule "ARGS_NAMES" "@rx .*"
"phase:2,chain,t:none,nolog,auditlog,pass,capture,setvar:tx.arg_name_%{tx.0}=+1,msg:'Possible
HTTP Parameter Pollution Attack: Multiple Parameters with the same Name.'"
SecRule
"REQUEST_URI|REQUEST_BODY|REQUEST_HEADERS|XML:/*|!REQUEST_HEADERS:Referer"
"@pmFromFile modsecurity_40_generic_attacks.data"
"phase:2,t:none,t:urlDecodeUni,t:htmlEntityDecode,t:compressWhiteSpace,t:lowercase,nolog,pass,setvar:tx.pm_score=+1,setvar:tx.pm_data_%{matched_var_name}=%{matched_var}"
SecRule
"REQUEST_URI|REQUEST_BODY|REQUEST_HEADERS|XML:/*|!REQUEST_HEADERS:Referer"
"@pmFromFile modsecurity_40_generic_attacks.data"
"phase:2,t:none,t:urlDecodeUni,t:htmlEntityDecode,t:compressWhiteSpace,t:lowercase,nolog,pass,setvar:tx.pm_score=+1,setvar:tx.pm_data_%{matched_var_name}=%{matched_var}"
SecRule
"REQUEST_URI|REQUEST_BODY|REQUEST_HEADERS|XML:/*|!REQUEST_HEADERS:Referer"
"@pmFromFile modsecurity_40_generic_attacks.data"
"phase:2,t:none,t:urlDecodeUni,t:htmlEntityDecode,t:compressWhiteSpace,t:lowercase,nolog,pass,setvar:tx.pm_score=+1,setvar:tx.pm_data_%{matched_var_name}=%{matched_var}"
SecRule "&TX:/SQL_INJECTION/" "@eq 0"
"phase:2,t:none,nolog,skipAfter:END_SQL_INJECTION_WEAK"
SecRule
"REQUEST_URI|REQUEST_BODY|REQUEST_HEADERS|XML:/*|!REQUEST_HEADERS:Referer"
"@pm jscript onsubmit copyparentfolder javascript meta onchange onmove
onkeydown onkeyup activexobject onerror onmouseup ecmascript bexpression
onmouseover vbscript: <![cdata[ http: .innerhtml settimeout shell:
onabort asfunction: onkeypress onmousedown onclick .fromcharcode
background-image: .cookie x-javascript ondragdrop onblur mocha:
javascript: onfocus lowsrc getparentfolder onresize @import alert script
onselect onmouseout application onmousemove background .execscript
livescript: vbscript getspecialfolder .addimport iframe onunload
createtextrange <input onload"
"phase:2,t:none,t:urlDecodeUni,t:htmlEntityDecode,t:compressWhiteSpace,t:lowercase,nolog,skip:1,setvar:tx.pm_xss_data_%{matched_var_name}=%{matched_var}"
SecRule "REQUEST_URI_RAW|REQUEST_BODY" "@rx \\bstyle\\b\\W*?="
"phase:2,t:none,t:lowercase,block,nolog,auditlog,ctl:debugLogLevel=9,msg:'XSS
Attack
Detected',setvar:tx.msg=%{rule.msg},setvar:tx.xss_score=+1,setvar:tx.anomaly_score=+20,setvar:tx.%{rule.id}-WEB_ATTACK/XSS-%{matched_var_name}=%{matched_var}"
SecRule "REQUEST_FILENAME" "!@pmFromFile
modsecurity_46_et_sql_injection.data"
"phase:2,nolog,t:none,t:urlDecodeUni,t:htmlEntityDecode,t:normalisePathWin,skipAfter:END_ET_SQLI_RULES"
SecRule "REQUEST_FILENAME" "!@pmFromFile
modsecurity_46_et_web_rules.data"
"phase:2,nolog,t:none,t:urlDecodeUni,t:htmlEntityDecode,t:normalisePathWin,skipAfter:END_SNORT_RULES"
SecRule "TX:ANOMALY_SCORE" "@ge 20"
"phase:2,t:none,log,auditlog,deny,msg:'Anomaly Score Exceeded (score
%{TX.ANOMALY_SCORE}): %{tx.msg}',setvar:tx.inbound_tx_msg=%{tx.msg}"

--cecdfa17-Z--



? 2009-12-10 22:11, Ryan Barnett ??:
> On Thursday 10 December 2009 04:11:53 am ll wrote:
>   
>> in the newest rule set( modsecurity-crs_2.0.3) ,there are not rule id in
>>
>> some rule .eg.
>> SecRule REQUEST_URI_RAW|REQUEST_BODY
>> "\bon(abort|blur|change|click|dblclick|dragdrop|error|\
>> focus|keydown|keypress|keyup|load|mousedown|mousemove|mouseout\
>>
>> |mouseover|mouseup|move|readystatechange|reset|resize|select|submit|unload)
>> |\b\W*?="
>>
>> \
>> "phase:2,t:none,t:lowercase,block,nolog,auditlog,msg:'XSS Attack
>> Detected',setvar:'tx.msg=%{rule.msg}',setvar:tx.xss_score=+1,setvar:tx.anom
>> aly_score=+20,setvar:tx.%{rule.id}-WEB_ATTACK/XSS-%{matched_var_name}=%{mat
>> ched_var}"
>>
>> In my server ,this is a False Positive for some url.and I want to
>> disable it for there url.
>> but there are no rule id,I can't SecRuleRemoveById.
>>
>>
>>     
>
> We will go back through the rule set to ensure that all rules have a rule id.  
> That being said, you can still go to the 48 local exceptions file and add in 
> rule there.
>
> If you send an example audit log entry of this false positive, I could send 
> you an example exception.
>
> -Ryan
>
>   
-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20091211/270c0d75/attachment.html 

From s.bhatia at qut.edu.au  Thu Dec 10 21:57:07 2009
From: s.bhatia at qut.edu.au (SAJAL BHATIA)
Date: Fri, 11 Dec 2009 12:57:07 +1000
Subject: [Owasp-modsecurity-core-rule-set] Some queries regarding core rule
	set
Message-ID: <EF5541F04426FD40ACD8600636961B470CBF5569E0@QUTEXMBX02.qut.edu.au>

Hello, 

I am new to this Mod Security Web Application Firewall and facing some problems. I would be obliged if you can answer some of my queries in detail.

1. How can I change the rules dynamically? 
2. How does Mod Security adapts when one makes changes in the rules set? I mean does it require reloading of the config file or is the apache need to be re-started? 
3. Is it possible to have the information like "the following error in web server access was due to violation of the following rule" some where in the logs formed?
4. Is there any functional diagram where it shows how does mod security fetched the packets from apache server in an embedded mode deployment?

Awaiting for your response at the earliest. 

Thanks and Regards

----
Sajal Bhatia
Research Masters Student
QUT, Brisbane
AUSTRALIA

From dreamice.jiang at gmail.com  Fri Dec 11 01:56:42 2009
From: dreamice.jiang at gmail.com (Junyong Jiang)
Date: Fri, 11 Dec 2009 14:56:42 +0800
Subject: [Owasp-modsecurity-core-rule-set] Some queries regarding core
	rule set
In-Reply-To: <EF5541F04426FD40ACD8600636961B470CBF5569E0@QUTEXMBX02.qut.edu.au>
References: <EF5541F04426FD40ACD8600636961B470CBF5569E0@QUTEXMBX02.qut.edu.au>
Message-ID: <d5dfca260912102256j8afcf60g695eae21eda5a21c@mail.gmail.com>

If you change any of the rule set, you MUST restarting the apache server.
For more information, you can refer to the modsecurity audit log.

2009/12/11 SAJAL BHATIA <s.bhatia at qut.edu.au>

> Hello,
>
> I am new to this Mod Security Web Application Firewall and facing some
> problems. I would be obliged if you can answer some of my queries in detail.
>
> 1. How can I change the rules dynamically?
> 2. How does Mod Security adapts when one makes changes in the rules set? I
> mean does it require reloading of the config file or is the apache need to
> be re-started?
> 3. Is it possible to have the information like "the following error in web
> server access was due to violation of the following rule" some where in the
> logs formed?
> 4. Is there any functional diagram where it shows how does mod security
> fetched the packets from apache server in an embedded mode deployment?
>
> Awaiting for your response at the earliest.
>
> Thanks and Regards
>
> ----
> Sajal Bhatia
> Research Masters Student
> QUT, Brisbane
> AUSTRALIA
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20091211/914fe2fb/attachment.html 

From dreamice.jiang at gmail.com  Fri Dec 11 02:27:20 2009
From: dreamice.jiang at gmail.com (Junyong Jiang)
Date: Fri, 11 Dec 2009 15:27:20 +0800
Subject: [Owasp-modsecurity-core-rule-set] Question about
	REQUEST_HEADERS:Referer
Message-ID: <d5dfca260912102327s2022bce2j6e3c727da0b359b6@mail.gmail.com>

Dear all,

Could you please explain what is the "REQUEST_HEADERS:Referer" mean in the
modsecurity rules? some examples are best! thanks in advance!


alex jiang
2009/12/11
-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20091211/fd3acf8e/attachment.html 

From ryan.barnett at breach.com  Fri Dec 11 09:09:02 2009
From: ryan.barnett at breach.com (Ryan Barnett)
Date: Fri, 11 Dec 2009 09:09:02 -0500
Subject: [Owasp-modsecurity-core-rule-set]
	=?utf-8?q?no_rule_ID_=EF=BC=9F?=
In-Reply-To: <4B21A1D9.50906@gmail.com>
References: <4B20BB59.9030208@gmail.com>
	<200912100911.48210.ryan.barnett@breach.com>
	<4B21A1D9.50906@gmail.com>
Message-ID: <200912110909.02392.ryan.barnett@breach.com>

On Thursday 10 December 2009 08:35:21 pm ll wrote:
> Yes ,I'm reading the 48 local excetions.but still confuse.here is my
>  auditlog, thanks your help.I just want to disable this rule for this url
>  (/news/abc.swf?id=20091211&style=3) ,other website still need to be
>  inspect
> --cecdfa17-A--
> [10/Dec/2009:16:22:14 +0800] SyCvtdJMQTgAABXDVjcAAAAC 127.0.0.1 60252
>  127.0.0.1 8000 --cecdfa17-B--
> GET /news/abc.swf?id=20091211&style=3 HTTP/1.1
> Accept: */*
> Referer: http://www.abc.com/news/index.html
> Accept-Language: zh-cn
> UA-CPU: x86
> Accept-Encoding: gzip, deflate
> User-Agent: Mozilla/4.0 ()
> Host: www.abc.com<http://www.abc.com>
> Cookie: JSESSIONID=869946B0D9D6C75C3600E22E54A2C172
> 
> 

If you look in your debug log when this match occurs, you will see a line like 
this where it is setting the TX variable -

[9] Set variable "tx.-WEB_ATTACK/XSS-REQUEST_URI_RAW" to 
"/news/abc.swf?id=20091211&style=3".

You can now use this TX data to create the following exception rule in the 
modsecurity_crs_48_local_exceptions.conf file (keep in mind that this is a 
chained rule with 2 SecRules and they should be on two lines so make sure to 
correct this if copy/pasting from email) -

SecRule TX:-WEB_ATTACK/XSS-REQUEST_URI_RAW 
"^\/news\/abc\.swf\?id=\d+&style=\d+$" "chain,phase:2,t:none,nolog,pass"
       SecRule MATCHED_VAR_NAME "TX\:(.*)" "capture,t:none,setvar:!tx.
%{tx.1},setvar:tx.anomaly_score=-20"

This will look for this exact TX variable name with a regex for the URI 
payload (which allows for digit payloads both the id and style parameters).  
If there is a match, it will remove this TX variable and decrease the anomaly 
score by 20.  Here is the debug log show the exception in action -


[4] Recipe: Invoking rule b8a6248; [file 
"/usr/local/apache/conf/modsecurity_crs-2.0.4/base_rules/modsecurity_crs_48_local_exceptions.conf"] 
[line "44"].
[5] Rule b8a6248: SecRule "TX:-WEB_ATTACK/XSS-REQUEST_URI_RAW" "@rx 
^\\/news\\/abc\\.swf\\?id=\\d+&style=\\d+$" "phase:2,chain,t:none,nolog,pass"
[4] Transformation completed in 2 usec.
[4] Executing operator "rx" with param 
"^\\/news\\/abc\\.swf\\?id=\\d+&style=\\d+$" against TX:-WEB_ATTACK/XSS-
REQUEST_URI_RAW.
[9] Target value: "/news/abc.swf?id=20091211&style=3"
[4] Operator completed in 6 usec.
[4] Rule returned 1.
[9] Match -> mode NEXT_RULE.
[4] Recipe: Invoking rule b8a6b10; [file 
"/usr/local/apache/conf/modsecurity_crs-2.0.4/base_rules/modsecurity_crs_48_local_exceptions.conf"] 
[line "45"].
[5] Rule b8a6b10: SecRule "MATCHED_VAR_NAME" "@rx TX\\:(.*)" 
"capture,t:none,setvar:!tx.%{tx.1},setvar:tx.anomaly_score=-20"
[4] Transformation completed in 2 usec.
[4] Executing operator "rx" with param "TX\\:(.*)" against MATCHED_VAR_NAME.
[9] Target value: "TX:-WEB_ATTACK/XSS-REQUEST_URI_RAW"
[9] Added regex subexpression to TX.0: TX:-WEB_ATTACK/XSS-REQUEST_URI_RAW
[9] Added regex subexpression to TX.1: -WEB_ATTACK/XSS-REQUEST_URI_RAW
[4] Operator completed in 36 usec.
[9] Setting variable: !tx.%{tx.1}=1
[9] Resolved macro %{tx.1} to "-WEB_ATTACK/XSS-REQUEST_URI_RAW"
[9] Unset variable "tx.-WEB_ATTACK/XSS-REQUEST_URI_RAW".
[9] Setting variable: tx.anomaly_score=-20
[9] Original collection variable: tx.anomaly_score = "20"
[9] Relative change: anomaly_score=20-20
[9] Set variable "tx.anomaly_score" to "0".
[4] Warning. Pattern match "TX\:(.*)" at MATCHED_VAR_NAME. [file 
"/usr/local/apache/conf/modsecurity_crs-2.0.4/base_rules/modsecurity_crs_48_local_exceptions.conf"] 
[line "44"]
[4] Rule returned 1.
[9] Match -> mode NEXT_RULE.

Hope this helps,
Ryan

From Brian.Rectanus at breach.com  Fri Dec 11 11:19:53 2009
From: Brian.Rectanus at breach.com (Brian Rectanus)
Date: Fri, 11 Dec 2009 08:19:53 -0800
Subject: [Owasp-modsecurity-core-rule-set] Question
	about	REQUEST_HEADERS:Referer
In-Reply-To: <d5dfca260912102327s2022bce2j6e3c727da0b359b6@mail.gmail.com>
References: <d5dfca260912102327s2022bce2j6e3c727da0b359b6@mail.gmail.com>
Message-ID: <4B227129.3060600@breach.com>

Junyong Jiang wrote:
> Dear all,
>
> Could you please explain what is the "REQUEST_HEADERS:Referer" mean in
> the modsecurity rules? some examples are best! thanks in advance!
>
>
> alex jiang
> 2009/12/11

REQUEST_HEADER referrs to the HTTP Request Header.  This is the
"Referer" header, which is typically the URL of the page the user was on
when they clicked the request's URL.  See all the header definitions here:

http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html

-B

-- 
Brian Rectanus
Breach Security


From ossec.junkie at gmail.com  Fri Dec 11 17:53:55 2009
From: ossec.junkie at gmail.com (OSSEC junkie)
Date: Fri, 11 Dec 2009 14:53:55 -0800
Subject: [Owasp-modsecurity-core-rule-set] Question about RBL Match for
	SPAM Source Rule
In-Reply-To: <200912101042.21390.ryan.barnett@breach.com>
References: <869a38360912082357h5b5d43bdm20cafd448314efdc@mail.gmail.com>
	<869a38360912091409y4bab36e0w704dfd084970eb5e@mail.gmail.com>
	<869a38360912092246x30c7fff7ie6a99ace82d0e722@mail.gmail.com>
	<200912101042.21390.ryan.barnett@breach.com>
Message-ID: <869a38360912111453x4536b590pd86ad13d3f5e5b9f@mail.gmail.com>

Thank you Ryan for the file.  I confirmed this is working now.  Silly
gmail made my life miserable messing up the formatting of the
configuration.  I have this config working in a pass-through mode
right now just watching the amount of IP's being detected as spam,
it's quite fascinating.  I have a few more questions though:

1) expirevar, is there a max limit that can be set for this?  Right
now for RBL blocking, it's set to 86400 seconds (1 day), is there a
max limit?  Also, if I were to remove the expirevar variable, would
the block be perm?

2) Where are all the IP's being detected being written to?

3) Any thoughts about expending this type of RBL look-up to include
project honeypot?  That solution would offer a wider scope of coverage
than spamhaus currently does but just curious as to what your stance
on this is.

Thanks again for the great config for spamhaus/rbl look-ups.

From ibeginhere at gmail.com  Tue Dec 15 03:42:04 2009
From: ibeginhere at gmail.com (ll)
Date: Tue, 15 Dec 2009 16:42:04 +0800
Subject: [Owasp-modsecurity-core-rule-set]
 =?utf-8?b?bm8gcnVsZSBJRCAg77yf?=
In-Reply-To: <200912110909.02392.ryan.barnett@breach.com>
References: <4B20BB59.9030208@gmail.com>
	<200912100911.48210.ryan.barnett@breach.com>
	<4B21A1D9.50906@gmail.com>
	<200912110909.02392.ryan.barnett@breach.com>
Message-ID: <4B274BDC.3060003@gmail.com>

thank you so much. it's work now .according the example, I have more 
clean understand about the 48_local_exceptions.conf.
BTW, according  to this way to reduce the FALSE positive.I doubt it in 
this situation .the modsecurity protect multiple website .In the A 
website ,the website structure  have some keyword which course the FALSE 
positive easy .but the B website is not. when I want to reduce the FALSE 
positive based the website .how to do in this situation .

? 2009-12-11 22:09, Ryan Barnett ??:
> On Thursday 10 December 2009 08:35:21 pm ll wrote:
>   
>> Yes ,I'm reading the 48 local excetions.but still confuse.here is my
>>  auditlog, thanks your help.I just want to disable this rule for this url
>>  (/news/abc.swf?id=20091211&style=3) ,other website still need to be
>>  inspect
>> --cecdfa17-A--
>> [10/Dec/2009:16:22:14 +0800] SyCvtdJMQTgAABXDVjcAAAAC 127.0.0.1 60252
>>  127.0.0.1 8000 --cecdfa17-B--
>> GET /news/abc.swf?id=20091211&style=3 HTTP/1.1
>> Accept: */*
>> Referer: http://www.abc.com/news/index.html
>> Accept-Language: zh-cn
>> UA-CPU: x86
>> Accept-Encoding: gzip, deflate
>> User-Agent: Mozilla/4.0 ()
>> Host: www.abc.com<http://www.abc.com>
>> Cookie: JSESSIONID=869946B0D9D6C75C3600E22E54A2C172
>>
>>
>>     
>
> If you look in your debug log when this match occurs, you will see a line like 
> this where it is setting the TX variable -
>
> [9] Set variable "tx.-WEB_ATTACK/XSS-REQUEST_URI_RAW" to 
> "/news/abc.swf?id=20091211&style=3".
>
> You can now use this TX data to create the following exception rule in the 
> modsecurity_crs_48_local_exceptions.conf file (keep in mind that this is a 
> chained rule with 2 SecRules and they should be on two lines so make sure to 
> correct this if copy/pasting from email) -
>
> SecRule TX:-WEB_ATTACK/XSS-REQUEST_URI_RAW 
> "^\/news\/abc\.swf\?id=\d+&style=\d+$" "chain,phase:2,t:none,nolog,pass"
>        SecRule MATCHED_VAR_NAME "TX\:(.*)" "capture,t:none,setvar:!tx.
> %{tx.1},setvar:tx.anomaly_score=-20"
>
> This will look for this exact TX variable name with a regex for the URI 
> payload (which allows for digit payloads both the id and style parameters).  
> If there is a match, it will remove this TX variable and decrease the anomaly 
> score by 20.  Here is the debug log show the exception in action -
>
>
> [4] Recipe: Invoking rule b8a6248; [file 
> "/usr/local/apache/conf/modsecurity_crs-2.0.4/base_rules/modsecurity_crs_48_local_exceptions.conf"] 
> [line "44"].
> [5] Rule b8a6248: SecRule "TX:-WEB_ATTACK/XSS-REQUEST_URI_RAW" "@rx 
> ^\\/news\\/abc\\.swf\\?id=\\d+&style=\\d+$" "phase:2,chain,t:none,nolog,pass"
> [4] Transformation completed in 2 usec.
> [4] Executing operator "rx" with param 
> "^\\/news\\/abc\\.swf\\?id=\\d+&style=\\d+$" against TX:-WEB_ATTACK/XSS-
> REQUEST_URI_RAW.
> [9] Target value: "/news/abc.swf?id=20091211&style=3"
> [4] Operator completed in 6 usec.
> [4] Rule returned 1.
> [9] Match -> mode NEXT_RULE.
> [4] Recipe: Invoking rule b8a6b10; [file 
> "/usr/local/apache/conf/modsecurity_crs-2.0.4/base_rules/modsecurity_crs_48_local_exceptions.conf"] 
> [line "45"].
> [5] Rule b8a6b10: SecRule "MATCHED_VAR_NAME" "@rx TX\\:(.*)" 
> "capture,t:none,setvar:!tx.%{tx.1},setvar:tx.anomaly_score=-20"
> [4] Transformation completed in 2 usec.
> [4] Executing operator "rx" with param "TX\\:(.*)" against MATCHED_VAR_NAME.
> [9] Target value: "TX:-WEB_ATTACK/XSS-REQUEST_URI_RAW"
> [9] Added regex subexpression to TX.0: TX:-WEB_ATTACK/XSS-REQUEST_URI_RAW
> [9] Added regex subexpression to TX.1: -WEB_ATTACK/XSS-REQUEST_URI_RAW
> [4] Operator completed in 36 usec.
> [9] Setting variable: !tx.%{tx.1}=1
> [9] Resolved macro %{tx.1} to "-WEB_ATTACK/XSS-REQUEST_URI_RAW"
> [9] Unset variable "tx.-WEB_ATTACK/XSS-REQUEST_URI_RAW".
> [9] Setting variable: tx.anomaly_score=-20
> [9] Original collection variable: tx.anomaly_score = "20"
> [9] Relative change: anomaly_score=20-20
> [9] Set variable "tx.anomaly_score" to "0".
> [4] Warning. Pattern match "TX\:(.*)" at MATCHED_VAR_NAME. [file 
> "/usr/local/apache/conf/modsecurity_crs-2.0.4/base_rules/modsecurity_crs_48_local_exceptions.conf"] 
> [line "44"]
> [4] Rule returned 1.
> [9] Match -> mode NEXT_RULE.
>
> Hope this helps,
> Ryan
>
>   
-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20091215/e49bc052/attachment.html 

From ibeginhere at gmail.com  Tue Dec 15 03:53:32 2009
From: ibeginhere at gmail.com (ll)
Date: Tue, 15 Dec 2009 16:53:32 +0800
Subject: [Owasp-modsecurity-core-rule-set]
 =?utf-8?b?bm8gcnVsZSBJRCAg77yf?=
In-Reply-To: <4B274BDC.3060003@gmail.com>
References: <4B20BB59.9030208@gmail.com>
	<200912100911.48210.ryan.barnett@breach.com>
	<4B21A1D9.50906@gmail.com>
	<200912110909.02392.ryan.barnett@breach.com>
	<4B274BDC.3060003@gmail.com>
Message-ID: <4B274E8C.7070903@gmail.com>

I think I can set a chain rules to estimate the request host first .and 
then do the same thing to pass the FALSE positive . or any other ideas ?

? 2009-12-15 16:42, ll ??:
> thank you so much. it's work now .according the example, I have more 
> clean understand about the 48_local_exceptions.conf.
> BTW, according  to this way to reduce the FALSE positive.I doubt it in 
> this situation .the modsecurity protect multiple website .In the A 
> website ,the website structure  have some keyword which course the 
> FALSE positive easy .but the B website is not. when I want to reduce 
> the FALSE positive based the website .how to do in this situation .
>
> ? 2009-12-11 22:09, Ryan Barnett ??:
>> On Thursday 10 December 2009 08:35:21 pm ll wrote:
>>   
>>> Yes ,I'm reading the 48 local excetions.but still confuse.here is my
>>>  auditlog, thanks your help.I just want to disable this rule for this url
>>>  (/news/abc.swf?id=20091211&style=3) ,other website still need to be
>>>  inspect
>>> --cecdfa17-A--
>>> [10/Dec/2009:16:22:14 +0800] SyCvtdJMQTgAABXDVjcAAAAC 127.0.0.1 60252
>>>  127.0.0.1 8000 --cecdfa17-B--
>>> GET /news/abc.swf?id=20091211&style=3 HTTP/1.1
>>> Accept: */*
>>> Referer: http://www.abc.com/news/index.html
>>> Accept-Language: zh-cn
>>> UA-CPU: x86
>>> Accept-Encoding: gzip, deflate
>>> User-Agent: Mozilla/4.0 ()
>>> Host: www.abc.com<http://www.abc.com>
>>> Cookie: JSESSIONID=869946B0D9D6C75C3600E22E54A2C172
>>>
>>>
>>>     
>>
>> If you look in your debug log when this match occurs, you will see a line like 
>> this where it is setting the TX variable -
>>
>> [9] Set variable "tx.-WEB_ATTACK/XSS-REQUEST_URI_RAW" to 
>> "/news/abc.swf?id=20091211&style=3".
>>
>> You can now use this TX data to create the following exception rule in the 
>> modsecurity_crs_48_local_exceptions.conf file (keep in mind that this is a 
>> chained rule with 2 SecRules and they should be on two lines so make sure to 
>> correct this if copy/pasting from email) -
>>
>> SecRule TX:-WEB_ATTACK/XSS-REQUEST_URI_RAW 
>> "^\/news\/abc\.swf\?id=\d+&style=\d+$" "chain,phase:2,t:none,nolog,pass"
>>        SecRule MATCHED_VAR_NAME "TX\:(.*)" "capture,t:none,setvar:!tx.
>> %{tx.1},setvar:tx.anomaly_score=-20"
>>
>> This will look for this exact TX variable name with a regex for the URI 
>> payload (which allows for digit payloads both the id and style parameters).  
>> If there is a match, it will remove this TX variable and decrease the anomaly 
>> score by 20.  Here is the debug log show the exception in action -
>>
>>
>> [4] Recipe: Invoking rule b8a6248; [file 
>> "/usr/local/apache/conf/modsecurity_crs-2.0.4/base_rules/modsecurity_crs_48_local_exceptions.conf"] 
>> [line "44"].
>> [5] Rule b8a6248: SecRule "TX:-WEB_ATTACK/XSS-REQUEST_URI_RAW" "@rx 
>> ^\\/news\\/abc\\.swf\\?id=\\d+&style=\\d+$" "phase:2,chain,t:none,nolog,pass"
>> [4] Transformation completed in 2 usec.
>> [4] Executing operator "rx" with param 
>> "^\\/news\\/abc\\.swf\\?id=\\d+&style=\\d+$" against TX:-WEB_ATTACK/XSS-
>> REQUEST_URI_RAW.
>> [9] Target value: "/news/abc.swf?id=20091211&style=3"
>> [4] Operator completed in 6 usec.
>> [4] Rule returned 1.
>> [9] Match -> mode NEXT_RULE.
>> [4] Recipe: Invoking rule b8a6b10; [file 
>> "/usr/local/apache/conf/modsecurity_crs-2.0.4/base_rules/modsecurity_crs_48_local_exceptions.conf"] 
>> [line "45"].
>> [5] Rule b8a6b10: SecRule "MATCHED_VAR_NAME" "@rx TX\\:(.*)" 
>> "capture,t:none,setvar:!tx.%{tx.1},setvar:tx.anomaly_score=-20"
>> [4] Transformation completed in 2 usec.
>> [4] Executing operator "rx" with param "TX\\:(.*)" against MATCHED_VAR_NAME.
>> [9] Target value: "TX:-WEB_ATTACK/XSS-REQUEST_URI_RAW"
>> [9] Added regex subexpression to TX.0: TX:-WEB_ATTACK/XSS-REQUEST_URI_RAW
>> [9] Added regex subexpression to TX.1: -WEB_ATTACK/XSS-REQUEST_URI_RAW
>> [4] Operator completed in 36 usec.
>> [9] Setting variable: !tx.%{tx.1}=1
>> [9] Resolved macro %{tx.1} to "-WEB_ATTACK/XSS-REQUEST_URI_RAW"
>> [9] Unset variable "tx.-WEB_ATTACK/XSS-REQUEST_URI_RAW".
>> [9] Setting variable: tx.anomaly_score=-20
>> [9] Original collection variable: tx.anomaly_score = "20"
>> [9] Relative change: anomaly_score=20-20
>> [9] Set variable "tx.anomaly_score" to "0".
>> [4] Warning. Pattern match "TX\:(.*)" at MATCHED_VAR_NAME. [file 
>> "/usr/local/apache/conf/modsecurity_crs-2.0.4/base_rules/modsecurity_crs_48_local_exceptions.conf"] 
>> [line "44"]
>> [4] Rule returned 1.
>> [9] Match -> mode NEXT_RULE.
>>
>> Hope this helps,
>> Ryan
>>
>>   
-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20091215/c4506cc4/attachment.html 

From misc.lists at blueyonder.co.uk  Tue Dec 15 05:28:34 2009
From: misc.lists at blueyonder.co.uk (Arthur Dent)
Date: Tue, 15 Dec 2009 10:28:34 +0000
Subject: [Owasp-modsecurity-core-rule-set] Squid/SquidGuard cgi problem
Message-ID: <1260872914.3072.67.camel@localhost>

Hello all,

I have a small family webserver on which I run ModSec. I also have the
Squid proxy service and squidGuard which redirects attempts to visit
inappropriate websites to a page indicating that the site is blocked.

In the squidGuard setup this is handled by a cgi script
at /var/www/cgi-bin/squidGuard.cgi.

Recently however, the site is blocked, but instead on the nice
informative page my children get the error message "You don't have
permission to access /cgi-bin/squidGuard.cgi on this
server"

Looking into the modsec_audit.log I find this:

=======================8<==================================================

--39048d68-H--
Message: Pattern match "^[\d.:]+$" at REQUEST_HEADERS:Host. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_21_protocol_anomalies.conf"] [line "62"] [id "960017"] [msg "Host header is a numeric IP address"] [severity "CRITICAL"] [tag "PROTOCOL_VIOLATION/IP_HOST"]
Message: Pattern match "^TX:phpids-(\d{1,2})-WEB_ATTACK/INJECTION-(\d)-(.*?)-(.*)$" at MATCHED_VAR_NAME. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_41_phpids_filters.conf"] [line "104"] [id "phpids-61"] [msg "Detects url injections and RFE attempts"] [data "Matched Location: REQUEST_URI_RAW and Matched Payload: /cgi-bin/squidguard.cgi?clientaddr=192.168.2.4&clientname=myserver&clientuser=&clientgroup=kidsspc&targetgroup=porn&url=http://www.playboy.com/favicon.ico"] [severity "CRITICAL"]
Message: Pattern match "^TX:phpids-(\d{1,2})-WEB_ATTACK/INJECTION-(\d)-(.*?)-(.*)$" at MATCHED_VAR_NAME. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_41_phpids_filters.conf"] [line "111"] [id "phpids-20"] [msg "Detects JavaScript language constructs"] [data "Matched Location: REQUEST_URI_RAW and Matched Payload: /cgi-bin/squidguard.cgi?clientaddr=192.168.2.4&clientname=myserver&clientuser=&clientgroup=kidsspc&targetgroup=porn&url=http://www.playboy.com/favicon.ico"] [severity "CRITICAL"]
Message: Pattern match "^TX:phpids-(\d{1,2})-WEB_ATTACK/INJECTION-(\d)-(.*?)-(.*)$" at MATCHED_VAR_NAME. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_41_phpids_filters.conf"] [line "279"] [id "phpids-2"] [msg "Detects JavaScript location/document property access and window access obfuscation"] [data "Matched Location: REQUEST_URI_RAW and Matched Payload: /cgi-bin/squidguard.cgi?clientaddr=192.168.2.4&clientname=myserver&clientuser=&clientgroup=kidsspc&targetgroup=porn&url=http://www.playboy.com/favicon.ico"] [severity "CRITICAL"]
Message: Pattern match "^TX:phpids-(\d{1,2})-WEB_ATTACK/INJECTION-(\d)-(.*?)-(.*)$" at MATCHED_VAR_NAME. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_41_phpids_filters.conf"] [line "391"] [id "phpids-23"] [msg "Detects JavaScript location/document property access and window access obfuscation"] [data "Matched Location: REQUEST_URI_RAW and Matched Payload: /cgi-bin/squidguard.cgi?clientaddr=192.168.2.4&clientname=myserver&clientuser=&clientgroup=kidsspc&targetgroup=porn&url=http://www.playboy.com/favicon.ico"] [severity "CRITICAL"]
Message: Pattern match "^TX:phpids-(\d{1,2})-WEB_ATTACK/INJECTION-(\d)-(.*?)-(.*)$" at MATCHED_VAR_NAME. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_41_phpids_filters.conf"] [line "405"] [id "phpids-6"] [msg "Detects url injections and RFE attempts"] [data "Matched Location: REQUEST_URI_RAW and Matched Payload: /cgi-bin/squidguard.cgi?clientaddr=192.168.2.4&clientname=myserver&clientuser=&clientgroup=kidsspc&targetgroup=porn&url=http://www.playboy.com/favicon.ico"] [severity "CRITICAL"]
Message: Warning. Operator GE matched 5 at TX:anomaly_score. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_60_correlation.conf"] [line "46"] [msg "Transactional Anomaly Score (score 33): Detects JavaScript location/document property access and window access obfuscation"]
Action: Intercepted (phase 2)
Apache-Handler: cgi-script
Stopwatch: 1260872599744514 163713 (69455 135899 -)
Producer: ModSecurity for Apache/2.5.10 (http://www.modsecurity.org/); core ruleset/2.0.2.
Server: Apache/2.2.13 (Fedora)

=======================8<==================================================

Can you help me navigate around this rule (these rules)?

Thanks!

Mark
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 197 bytes
Desc: This is a digitally signed message part
Url : https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20091215/d4d4b92e/attachment-0001.bin 

From misc.lists at blueyonder.co.uk  Tue Dec 15 06:22:18 2009
From: misc.lists at blueyonder.co.uk (Arthur Dent)
Date: Tue, 15 Dec 2009 11:22:18 +0000
Subject: [Owasp-modsecurity-core-rule-set] Squid/SquidGuard cgi problem
In-Reply-To: <1260872914.3072.67.camel@localhost>
References: <1260872914.3072.67.camel@localhost>
Message-ID: <1260876138.3072.73.camel@localhost>

On Tue, 2009-12-15 at 10:28 +0000, Arthur Dent wrote:
> Hello all,
> 
> I have a small family webserver on which I run ModSec. I also have the
> Squid proxy service and squidGuard which redirects attempts to visit
> inappropriate websites to a page indicating that the site is blocked.
> 
> In the squidGuard setup this is handled by a cgi script
> at /var/www/cgi-bin/squidGuard.cgi.
> 
> Recently however, the site is blocked, but instead on the nice
> informative page my children get the error message "You don't have
> permission to access /cgi-bin/squidGuard.cgi on this
> server"
> 
> Looking into the modsec_audit.log I find this:
> 
> =======================8<==================================================
> 
> --39048d68-H--
> Message: Pattern match "^[\d.:]+$" at REQUEST_HEADERS:Host. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_21_protocol_anomalies.conf"] [line "62"] [id "960017"] [msg "Host header is a numeric IP address"] [severity "CRITICAL"] [tag "PROTOCOL_VIOLATION/IP_HOST"]
> Message: Pattern match "^TX:phpids-(\d{1,2})-WEB_ATTACK/INJECTION-(\d)-(.*?)-(.*)$" at MATCHED_VAR_NAME. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_41_phpids_filters.conf"] [line "104"] [id "phpids-61"] [msg "Detects url injections and RFE attempts"] [data "Matched Location: REQUEST_URI_RAW and Matched Payload: /cgi-bin/squidguard.cgi?clientaddr=192.168.2.4&clientname=myserver&clientuser=&clientgroup=kidsspc&targetgroup=porn&url=http://www.playboy.com/favicon.ico"] [severity "CRITICAL"]
> Message: Pattern match "^TX:phpids-(\d{1,2})-WEB_ATTACK/INJECTION-(\d)-(.*?)-(.*)$" at MATCHED_VAR_NAME. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_41_phpids_filters.conf"] [line "111"] [id "phpids-20"] [msg "Detects JavaScript language constructs"] [data "Matched Location: REQUEST_URI_RAW and Matched Payload: /cgi-bin/squidguard.cgi?clientaddr=192.168.2.4&clientname=myserver&clientuser=&clientgroup=kidsspc&targetgroup=porn&url=http://www.playboy.com/favicon.ico"] [severity "CRITICAL"]
> Message: Pattern match "^TX:phpids-(\d{1,2})-WEB_ATTACK/INJECTION-(\d)-(.*?)-(.*)$" at MATCHED_VAR_NAME. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_41_phpids_filters.conf"] [line "279"] [id "phpids-2"] [msg "Detects JavaScript location/document property access and window access obfuscation"] [data "Matched Location: REQUEST_URI_RAW and Matched Payload: /cgi-bin/squidguard.cgi?clientaddr=192.168.2.4&clientname=myserver&clientuser=&clientgroup=kidsspc&targetgroup=porn&url=http://www.playboy.com/favicon.ico"] [severity "CRITICAL"]
> Message: Pattern match "^TX:phpids-(\d{1,2})-WEB_ATTACK/INJECTION-(\d)-(.*?)-(.*)$" at MATCHED_VAR_NAME. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_41_phpids_filters.conf"] [line "391"] [id "phpids-23"] [msg "Detects JavaScript location/document property access and window access obfuscation"] [data "Matched Location: REQUEST_URI_RAW and Matched Payload: /cgi-bin/squidguard.cgi?clientaddr=192.168.2.4&clientname=myserver&clientuser=&clientgroup=kidsspc&targetgroup=porn&url=http://www.playboy.com/favicon.ico"] [severity "CRITICAL"]
> Message: Pattern match "^TX:phpids-(\d{1,2})-WEB_ATTACK/INJECTION-(\d)-(.*?)-(.*)$" at MATCHED_VAR_NAME. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_41_phpids_filters.conf"] [line "405"] [id "phpids-6"] [msg "Detects url injections and RFE attempts"] [data "Matched Location: REQUEST_URI_RAW and Matched Payload: /cgi-bin/squidguard.cgi?clientaddr=192.168.2.4&clientname=myserver&clientuser=&clientgroup=kidsspc&targetgroup=porn&url=http://www.playboy.com/favicon.ico"] [severity "CRITICAL"]
> Message: Warning. Operator GE matched 5 at TX:anomaly_score. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_60_correlation.conf"] [line "46"] [msg "Transactional Anomaly Score (score 33): Detects JavaScript location/document property access and window access obfuscation"]
> Action: Intercepted (phase 2)
> Apache-Handler: cgi-script
> Stopwatch: 1260872599744514 163713 (69455 135899 -)
> Producer: ModSecurity for Apache/2.5.10 (http://www.modsecurity.org/); core ruleset/2.0.2.
> Server: Apache/2.2.13 (Fedora)
> 
> =======================8<==================================================
> 
> Can you help me navigate around this rule (these rules)?
> 
> Thanks!
> 


Please note that in actual fact I am running with CRS 2.0.4

I had updated the CRS base_rules but had forgotten to update
modsecurity_crs_10_config.conf and modsecurity_crs_10_global_config.conf
which I have now just done. Just to prove this here is another extract
from modsec_audit.log:

=======================8<==================================================

--7ea4a061-H--
Message: Pattern match "^[\d.:]+$" at REQUEST_HEADERS:Host. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_21_protocol_anomalies.conf"] [line "62"] [id "960017"] [msg "Host header is a numeric IP address"] [severity "CRITICAL"] [tag "PROTOCOL_VIOLATION/IP_HOST"]
Message: Pattern match "^TX:phpids-(\d{1,2})-WEB_ATTACK/INJECTION-(\d)-(.*?)-(.*)$" at MATCHED_VAR_NAME. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_41_phpids_filters.conf"] [line "104"] [id "phpids-61"] [msg "Detects url injections and RFE attempts"] [data "Matched Location: REQUEST_URI_RAW and Matched Payload: /cgi-bin/squidguard.cgi?clientaddr=192.168.2.4&clientname=myserver&clientuser=&clientgroup=kidsspc&targetgroup=gamessites&url=http://www.habbohotel.com/favicon.ico"] [severity "CRITICAL"]
Message: Pattern match "^TX:phpids-(\d{1,2})-WEB_ATTACK/INJECTION-(\d)-(.*?)-(.*)$" at MATCHED_VAR_NAME. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_41_phpids_filters.conf"] [line "111"] [id "phpids-20"] [msg "Detects JavaScript language constructs"] [data "Matched Location: REQUEST_URI_RAW and Matched Payload: /cgi-bin/squidguard.cgi?clientaddr=192.168.2.4&clientname=myserver&clientuser=&clientgroup=kidsspc&targetgroup=gamessites&url=http://www.habbohotel.com/favicon.ico"] [severity "CRITICAL"]
Message: Pattern match "^TX:phpids-(\d{1,2})-WEB_ATTACK/INJECTION-(\d)-(.*?)-(.*)$" at MATCHED_VAR_NAME. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_41_phpids_filters.conf"] [line "279"] [id "phpids-2"] [msg "Detects JavaScript location/document property access and window access obfuscation"] [data "Matched Location: REQUEST_URI_RAW and Matched Payload: /cgi-bin/squidguard.cgi?clientaddr=192.168.2.4&clientname=myserver&clientuser=&clientgroup=kidsspc&targetgroup=gamessites&url=http://www.habbohotel.com/favicon.ico"] [severity "CRITICAL"]
Message: Pattern match "^TX:phpids-(\d{1,2})-WEB_ATTACK/INJECTION-(\d)-(.*?)-(.*)$" at MATCHED_VAR_NAME. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_41_phpids_filters.conf"] [line "391"] [id "phpids-23"] [msg "Detects JavaScript location/document property access and window access obfuscation"] [data "Matched Location: REQUEST_URI_RAW and Matched Payload: /cgi-bin/squidguard.cgi?clientaddr=192.168.2.4&clientname=myserver&clientuser=&clientgroup=kidsspc&targetgroup=gamessites&url=http://www.habbohotel.com/favicon.ico"] [severity "CRITICAL"]
Message: Pattern match "^TX:phpids-(\d{1,2})-WEB_ATTACK/INJECTION-(\d)-(.*?)-(.*)$" at MATCHED_VAR_NAME. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_41_phpids_filters.conf"] [line "405"] [id "phpids-6"] [msg "Detects url injections and RFE attempts"] [data "Matched Location: REQUEST_URI_RAW and Matched Payload: /cgi-bin/squidguard.cgi?clientaddr=192.168.2.4&clientname=myserver&clientuser=&clientgroup=kidsspc&targetgroup=gamessites&url=http://www.habbohotel.com/favicon.ico"] [severity "CRITICAL"]
Message: Warning. Operator GE matched 5 at TX:anomaly_score. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_60_correlation.conf"] [line "46"] [msg "Transactional Anomaly Score (score 33): Detects JavaScript location/document property access and window access obfuscation"]
Action: Intercepted (phase 2)
Apache-Handler: cgi-script
Stopwatch: 1260875634121468 77367 (8086 68993 -)
Producer: ModSecurity for Apache/2.5.10 (http://www.modsecurity.org/); core ruleset/2.0.4.
Server: Apache/2.2.13 (Fedora)

=======================8<==================================================

It still gives the error...

Thanks again for any help or suggestions.

Mark


-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 197 bytes
Desc: This is a digitally signed message part
Url : https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20091215/77483ae6/attachment.bin 

From ibeginhere at gmail.com  Tue Dec 15 21:53:47 2009
From: ibeginhere at gmail.com (ll)
Date: Wed, 16 Dec 2009 10:53:47 +0800
Subject: [Owasp-modsecurity-core-rule-set] how to turn on the REQUEST_URI_RAW
Message-ID: <4B284BBB.4000501@gmail.com>

I wrote a rule like that
SecRule REQUEST_URI_RAW "http:\/\/(www\.)?abc\.com.*=.*--"
"phase:2,t:none,nolog,ctl:debugLogLevel=9,pass"
and in the debug log
[16/Dec/2009:10:24:31 +0800]
[www.abc.com/sid#a8c1798][rid#af780a8][/zc.asp][5] Rule aee0c78: SecRule
"REQUEST_URI_RAW" "@rx http:\\/\\/(www\\.)?abc\\.com.*=.*--"
"phase:2,t:none,nolog,ctl:debugLogLevel=9,pass"
[16/Dec/2009:10:24:31 +0800]
[www.abc.com/sid#a8c1798][rid#af780a8][/zc.asp][4] Transformation
completed in 2 usec.
[16/Dec/2009:10:24:31 +0800]
[www.abc.com/sid#a8c1798][rid#af780a8][/zc.asp][4] Executing operator
"rx" with param "http:\\/\\/(www\\.)?abc\\.com.*=.*--" against
REQUEST_URI_RAW.
[16/Dec/2009:10:24:31 +0800]
[www.abc.com/sid#a8c1798][rid#af780a8][/zc.asp][9] Target value:
"/zc.asp?infotype=xxxx&title=xxx--xxx--"

why the "Target value" not include the domain name ? In the document ,
REQUEST_URI_RAW
Same as REQUEST_URI but will contain the domain name if it was provided
on the request line (e.g. http://www.example.com/index.php?p=X).
and there are a note
/Please note that anti-evasion transformations are not used on
REQUEST_URI_RAW by default.
/Is it some tuner I need to turn on in other config file ?



-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20091216/b05d6734/attachment.html 

From covici at ccs.covici.com  Wed Dec 16 03:41:43 2009
From: covici at ccs.covici.com (covici at ccs.covici.com)
Date: Wed, 16 Dec 2009 03:41:43 -0500
Subject: [Owasp-modsecurity-core-rule-set] best way to install new core rule
	set and questions
Message-ID: <15562.1260952903@ccs.covici.com>

Hi.  I have been using modsecurity 2.1.4 and the core rules which came
therewith.  I have made several changes to the rules, mostly in
modsecurity_crs_60_custom.conf by removing by id and replacing the
rule.  Now I was thinking of installing the new modsecurity and the new
core rule set -- however I have a few questions on this subject:

1.  Are the id numbers the same, so my custom.conf rules can stay the
same?

2. I was looking on the home page for the core rule set and it said the
latest stable release was 2.0.4, but there seems to be no way to
download the new rule set at all.

3.  Once I install the ruleset, how does the automated update work --
particularly with regard to overwriting changes and how often does it
check for its updates, or do I do this manually?

Well, this should get me started -- any assistance would be appreciated.

-- 
Your life is like a penny.  You're going to lose it.  The question is:
How do
you spend it?

         John Covici
         covici at ccs.covici.com

From ibeginhere at gmail.com  Wed Dec 16 04:51:50 2009
From: ibeginhere at gmail.com (ll)
Date: Wed, 16 Dec 2009 17:51:50 +0800
Subject: [Owasp-modsecurity-core-rule-set] best way to install new core
 rule	set and questions
In-Reply-To: <15562.1260952903@ccs.covici.com>
References: <15562.1260952903@ccs.covici.com>
Message-ID: <4B28ADB6.90302@gmail.com>

good question, I have debug the new rule set a few days.I want a good 
way to update too.
you can download the crs rule set 2.0.4 from here:
http://www.owasp.org/index.php/Category:OWASP_ModSecurity_Core_Rule_Set_Project#tab=Download
as i know ,some rule id doesn't appear in the new rule set.

? 2009-12-16 16:41, covici at ccs.covici.com ??:
> Hi.  I have been using modsecurity 2.1.4 and the core rules which came
> therewith.  I have made several changes to the rules, mostly in
> modsecurity_crs_60_custom.conf by removing by id and replacing the
> rule.  Now I was thinking of installing the new modsecurity and the new
> core rule set -- however I have a few questions on this subject:
>
> 1.  Are the id numbers the same, so my custom.conf rules can stay the
> same?
>
> 2. I was looking on the home page for the core rule set and it said the
> latest stable release was 2.0.4, but there seems to be no way to
> download the new rule set at all.
>
> 3.  Once I install the ruleset, how does the automated update work --
> particularly with regard to overwriting changes and how often does it
> check for its updates, or do I do this manually?
>
> Well, this should get me started -- any assistance would be appreciated.
>
>   


From covici at ccs.covici.com  Wed Dec 16 06:00:01 2009
From: covici at ccs.covici.com (covici at ccs.covici.com)
Date: Wed, 16 Dec 2009 06:00:01 -0500
Subject: [Owasp-modsecurity-core-rule-set] best way to install new core
	rule set and questions
In-Reply-To: <4B28ADB6.90302@gmail.com>
References: <15562.1260952903@ccs.covici.com> <4B28ADB6.90302@gmail.com>
Message-ID: <16745.1260961201@ccs.covici.com>

OK, thanks, I got the download, now await other questions.

ll <ibeginhere at gmail.com> wrote:

> good question, I have debug the new rule set a few days.I want a good
> way to update too.
> you can download the crs rule set 2.0.4 from here:
> http://www.owasp.org/index.php/Category:OWASP_ModSecurity_Core_Rule_Set_Project#tab=Download
> as i know ,some rule id doesn't appear in the new rule set.
> 
> ? 2009-12-16 16:41, covici at ccs.covici.com ??:
> > Hi.  I have been using modsecurity 2.1.4 and the core rules which came
> > therewith.  I have made several changes to the rules, mostly in
> > modsecurity_crs_60_custom.conf by removing by id and replacing the
> > rule.  Now I was thinking of installing the new modsecurity and the new
> > core rule set -- however I have a few questions on this subject:
> >
> > 1.  Are the id numbers the same, so my custom.conf rules can stay the
> > same?
> >
> > 2. I was looking on the home page for the core rule set and it said the
> > latest stable release was 2.0.4, but there seems to be no way to
> > download the new rule set at all.
> >
> > 3.  Once I install the ruleset, how does the automated update work --
> > particularly with regard to overwriting changes and how often does it
> > check for its updates, or do I do this manually?
> >
> > Well, this should get me started -- any assistance would be appreciated.
> >
> >   

-- 
Your life is like a penny.  You're going to lose it.  The question is:
How do
you spend it?

         John Covici
         covici at ccs.covici.com

From ryan.barnett at breach.com  Wed Dec 16 10:29:20 2009
From: ryan.barnett at breach.com (Ryan Barnett)
Date: Wed, 16 Dec 2009 10:29:20 -0500
Subject: [Owasp-modsecurity-core-rule-set] how to turn on the
	REQUEST_URI_RAW
In-Reply-To: <4B284BBB.4000501@gmail.com>
References: <4B284BBB.4000501@gmail.com>
Message-ID: <200912161029.22224.ryan.barnett@breach.com>

On Tuesday 15 December 2009 09:53:47 pm ll wrote:
> I wrote a rule like that
> SecRule REQUEST_URI_RAW
>  "http:\/\/(www\.)?abc\.com.*=.*--"<http:\/\/(www\.)?abc\.com.*=.*-->
>  "phase:2,t:none,nolog,ctl:debugLogLevel=9,pass" and in the debug log
> [16/Dec/2009:10:24:31 +0800]
>  [www.abc.com/sid#a8c1798<http://www.abc.com/sid#a8c1798>][rid#af780a8][/zc
> .asp][5] Rule aee0c78: SecRule "REQUEST_URI_RAW" "@rx
>  http:\\/\\/(www\\.)?abc\\.com.*=.*--"
>  "phase:2,t:none,nolog,ctl:debugLogLevel=9,pass" [16/Dec/2009:10:24:31
>  +0800]
>  [www.abc.com/sid#a8c1798<http://www.abc.com/sid#a8c1798>][rid#af780a8][/zc
> .asp][4] Transformation completed in 2 usec. [16/Dec/2009:10:24:31 +0800]
>  [www.abc.com/sid#a8c1798<http://www.abc.com/sid#a8c1798>][rid#af780a8][/zc
> .asp][4] Executing operator "rx" with param
>  "http:\\/\\/(www\\.)?abc\\.com.*=.*--"<http:\\/\\/(www\\.)?abc\\.com.*=.*-
> -> against REQUEST_URI_RAW. [16/Dec/2009:10:24:31 +0800]
>  [www.abc.com/sid#a8c1798<http://www.abc.com/sid#a8c1798>][rid#af780a8][/zc
> .asp][9] Target value: "/zc.asp?infotype=xxxx&title=xxx--xxx--"
> 
> why the "Target value" not include the  domain name ? 
> In the document ,
> REQUEST_URI_RAW
> Same as REQUEST_URI but will contain the domain name if it was provided on
>  the request line (e.g. http://www.example.com/index.php?p=X). and there
>  are a note
> Please note that anti-evasion transformations are not used on
>  REQUEST_URI_RAW by default. Is it some tuner I need to turn on in other
>  config file ?
> 
The REQUEST_URI_RAW variable will include the domain name *if* the client 
actually included a fully qualified URI in their request (which is technically 
allowed per the HTTP RFC) like this -

GET http://www.example.com/foo.php HTTP/1.1
Host: www.example.com
User-Agent: blah
Accept: */*

While this is legal per the RFC, in practice, the only time that the URI 
normally includes a domain name is if the client is attempting to use the web 
server as a proxy.

For your scenario - I would just use REQUEST_URI.

-Ryan

From ryan.barnett at breach.com  Wed Dec 16 10:41:57 2009
From: ryan.barnett at breach.com (Ryan Barnett)
Date: Wed, 16 Dec 2009 10:41:57 -0500
Subject: [Owasp-modsecurity-core-rule-set] best way to install new core
	rule set and questions
In-Reply-To: <15562.1260952903@ccs.covici.com>
References: <15562.1260952903@ccs.covici.com>
Message-ID: <200912161041.58567.ryan.barnett@breach.com>

On Wednesday 16 December 2009 03:41:43 am covici at ccs.covici.com wrote:
> Hi.  I have been using modsecurity 2.1.4 and the core rules which came
> therewith.  I have made several changes to the rules, mostly in
> modsecurity_crs_60_custom.conf by removing by id and replacing the
> rule.  Now I was thinking of installing the new modsecurity and the new
> core rule set -- however I have a few questions on this subject:
> 
> 1.  Are the id numbers the same, so my custom.conf rules can stay the
> same?
> 
I believe that all of the older rules have kept the same rule IDs, however the 
new CRS v2 allows for different approaches to exceptions rather than the older 
SecRuleRemoveById approach.  Search the mail-list for exception info.  
Specifically, you can add exceptions to the 48 local exceptions conf file.

> 2. I was looking on the home page for the core rule set and it said the
> latest stable release was 2.0.4, but there seems to be no way to
> download the new rule set at all.
>
You seemed to have gotten the info you need - just click on the Download tab 
on the OWASP CRS project site.
 
> 3.  Once I install the ruleset, how does the automated update work --
> particularly with regard to overwriting changes and how often does it
> check for its updates, or do I do this manually?
> 
The ModSecurity source code archive comes with a tool called rules-updater.pl 
which will *allow* automatic downloading of the CRS.  We are actually 
configuring a few things related to the rules repository so the users can 
actually use the rules-updater.pl script and this should be up and running by 
the first of the year.

The other item that we need to address is what Ivan Ristic pointed out 
recently (https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-
set/2009-December/000173.html) and that is that some of the CRS data/files 
really need to be migrated over to the ModSecurity code archive instead.  The 
rules need to be structured in such a way as to allow easy updating and 
automatically overlaying existing CRS directories/files.  We will take a look 
at this and see if we can come up with some options.



From covici at ccs.covici.com  Wed Dec 16 10:49:53 2009
From: covici at ccs.covici.com (covici at ccs.covici.com)
Date: Wed, 16 Dec 2009 10:49:53 -0500
Subject: [Owasp-modsecurity-core-rule-set] best way to install new core
	rule set and questions
In-Reply-To: <200912161041.58567.ryan.barnett@breach.com>
References: <15562.1260952903@ccs.covici.com>
	<200912161041.58567.ryan.barnett@breach.com>
Message-ID: <26854.1260978593@ccs.covici.com>

OK, thanks -- I will check this out.

Ryan Barnett <ryan.barnett at breach.com> wrote:

> On Wednesday 16 December 2009 03:41:43 am covici at ccs.covici.com wrote:
> > Hi.  I have been using modsecurity 2.1.4 and the core rules which came
> > therewith.  I have made several changes to the rules, mostly in
> > modsecurity_crs_60_custom.conf by removing by id and replacing the
> > rule.  Now I was thinking of installing the new modsecurity and the new
> > core rule set -- however I have a few questions on this subject:
> > 
> > 1.  Are the id numbers the same, so my custom.conf rules can stay the
> > same?
> > 
> I believe that all of the older rules have kept the same rule IDs, however the 
> new CRS v2 allows for different approaches to exceptions rather than the older 
> SecRuleRemoveById approach.  Search the mail-list for exception info.  
> Specifically, you can add exceptions to the 48 local exceptions conf file.
> 
> > 2. I was looking on the home page for the core rule set and it said the
> > latest stable release was 2.0.4, but there seems to be no way to
> > download the new rule set at all.
> >
> You seemed to have gotten the info you need - just click on the Download tab 
> on the OWASP CRS project site.
>  
> > 3.  Once I install the ruleset, how does the automated update work --
> > particularly with regard to overwriting changes and how often does it
> > check for its updates, or do I do this manually?
> > 
> The ModSecurity source code archive comes with a tool called rules-updater.pl 
> which will *allow* automatic downloading of the CRS.  We are actually 
> configuring a few things related to the rules repository so the users can 
> actually use the rules-updater.pl script and this should be up and running by 
> the first of the year.
> 
> The other item that we need to address is what Ivan Ristic pointed out 
> recently (https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-
> set/2009-December/000173.html) and that is that some of the CRS data/files 
> really need to be migrated over to the ModSecurity code archive instead.  The 
> rules need to be structured in such a way as to allow easy updating and 
> automatically overlaying existing CRS directories/files.  We will take a look 
> at this and see if we can come up with some options.
> 

-- 
Your life is like a penny.  You're going to lose it.  The question is:
How do
you spend it?

         John Covici
         covici at ccs.covici.com

From ibeginhere at gmail.com  Thu Dec 17 01:28:43 2009
From: ibeginhere at gmail.com (ll)
Date: Thu, 17 Dec 2009 14:28:43 +0800
Subject: [Owasp-modsecurity-core-rule-set] best way to install new core
 rule set and questions
In-Reply-To: <26854.1260978593@ccs.covici.com>
References: <15562.1260952903@ccs.covici.com>	<200912161041.58567.ryan.barnett@breach.com>
	<26854.1260978593@ccs.covici.com>
Message-ID: <4B29CF9B.6010501@gmail.com>

Hopefully , the documents coming soon . and more details about the rule 
introduce .

? 2009-12-16 23:49, covici at ccs.covici.com ??:
> OK, thanks -- I will check this out.
>
> Ryan Barnett <ryan.barnett at breach.com> wrote:
>
>   
>> On Wednesday 16 December 2009 03:41:43 am covici at ccs.covici.com wrote:
>>     
>>> Hi.  I have been using modsecurity 2.1.4 and the core rules which came
>>> therewith.  I have made several changes to the rules, mostly in
>>> modsecurity_crs_60_custom.conf by removing by id and replacing the
>>> rule.  Now I was thinking of installing the new modsecurity and the new
>>> core rule set -- however I have a few questions on this subject:
>>>
>>> 1.  Are the id numbers the same, so my custom.conf rules can stay the
>>> same?
>>>
>>>       
>> I believe that all of the older rules have kept the same rule IDs, however the 
>> new CRS v2 allows for different approaches to exceptions rather than the older 
>> SecRuleRemoveById approach.  Search the mail-list for exception info.  
>> Specifically, you can add exceptions to the 48 local exceptions conf file.
>>
>>     
>>> 2. I was looking on the home page for the core rule set and it said the
>>> latest stable release was 2.0.4, but there seems to be no way to
>>> download the new rule set at all.
>>>
>>>       
>> You seemed to have gotten the info you need - just click on the Download tab 
>> on the OWASP CRS project site.
>>  
>>     
>>> 3.  Once I install the ruleset, how does the automated update work --
>>> particularly with regard to overwriting changes and how often does it
>>> check for its updates, or do I do this manually?
>>>
>>>       
>> The ModSecurity source code archive comes with a tool called rules-updater.pl 
>> which will *allow* automatic downloading of the CRS.  We are actually 
>> configuring a few things related to the rules repository so the users can 
>> actually use the rules-updater.pl script and this should be up and running by 
>> the first of the year.
>>
>> The other item that we need to address is what Ivan Ristic pointed out 
>> recently (https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-
>> set/2009-December/000173.html) and that is that some of the CRS data/files 
>> really need to be migrated over to the ModSecurity code archive instead.  The 
>> rules need to be structured in such a way as to allow easy updating and 
>> automatically overlaying existing CRS directories/files.  We will take a look 
>> at this and see if we can come up with some options.
>>
>>     
>
>   
-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20091217/d82f6d66/attachment.html 

From dreamice.jiang at gmail.com  Thu Dec 17 01:46:22 2009
From: dreamice.jiang at gmail.com (Junyong Jiang)
Date: Thu, 17 Dec 2009 14:46:22 +0800
Subject: [Owasp-modsecurity-core-rule-set] How to check upload files with
	modsecurity rules?
Message-ID: <d5dfca260912162246v31b18411ked28562f2b72d00b@mail.gmail.com>

Dear all,

I want to check the upload files for my website with modsecurity rules. I
use REQUEST_BODY for my purpose but there is not any effect.
my example rule is as follows:
SecRule REQUEST_BODY|REQUEST_LINE "copy" \

 "phase:2,t:lowercase,t:htmlEntityDecode,t:urlDecodeUni,deny,log,status:403,msg:'Upload
file with copy',id:'400124',severity:'2'"
# cat test.txt
copy($_FILES[MyFile][tmp_name],$_FILES[MyFile][name]) ? "Success" : "Fail"

Are there something wrong with my rules?
thanks in advance!
-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20091217/bbc2ce11/attachment.html 

From ibeginhere at gmail.com  Thu Dec 17 02:47:27 2009
From: ibeginhere at gmail.com (ll)
Date: Thu, 17 Dec 2009 15:47:27 +0800
Subject: [Owasp-modsecurity-core-rule-set] the crs_60_correlation.conf
Message-ID: <4B29E20F.6000104@gmail.com>

as before, I know how to pass some rule for the FALSE positive .but I
want to custom some rule in the crs 60.
SecRule &TX:'/AVAILABILITY\\\/APP_NOT_AVAIL/' "@ge 1" \
"chain,phase:5,t:none,log,pass,severity:'1',msg:'Correlated Attack
Attempt Identified: Inbound Attack (%{tx.inbound_tx_msg}) + Outbound
Application Error (%{tx.msg}) - (Transactional Anomaly Score
%{TX.ANOMALY_SCORE})'"
SecRule &TX:'/WEB_ATTACK/' "@ge 1" "t:none,skipAfter:END_CORRELATION"

I don't want the alarm appear in the modsecurity console when it trigger
by one of website protected by modsecurity .
eg: http//www.abc.com/zc.asp?infotype=&title=--xxx
the web side will return 500 status .I don't want this alarm appear in
the modsecurity console.
I try to write the rule in 48_local_exceptions.conf like that

SecRule REQUEST_HEADERS:Host "^(www\.)gdrst\.gov\.cn$"
"chain,phase:5,t:none,nolog,ctl:debugLogLevel=9,pass"
SecRule REQUEST_URI "\.asp\?.*=.*--.*" "chain"
SecRule &TX:'/AVAILABILITY\\\/APP_NOT_AVAIL/' "@ge 1" "chain"
SecRule MATCHED_VAR "(.*)" "capture,t:none,setvar:!tx.%{tx.0},nolog"

in the debug file,it trigger the special url already .and the target
reset to 0 ,not 1.but it's still alarm .how to achieve this object ?
and I notice there are different value between &TX and TX.I don't know
when the "&TX:/AVAILABILITY\/APP_NOT_AVAIL/" value set to 1 in this
translation .I don't know exactly the & means .when it was set .

From chris.datfung at gmail.com  Sun Dec 20 17:20:24 2009
From: chris.datfung at gmail.com (Chris Datfung)
Date: Mon, 21 Dec 2009 00:20:24 +0200
Subject: [Owasp-modsecurity-core-rule-set] rule bypass question
In-Reply-To: <200911301632.26846.ryan.barnett@breach.com>
References: <4c9cc6790911290741m19dc155bk2e23e2e2d6a2cbf6@mail.gmail.com>
	<200911301632.26846.ryan.barnett@breach.com>
Message-ID: <4c9cc6790912201420p15ed41c0he2b6608a6069faf7@mail.gmail.com>

On Mon, Nov 30, 2009 at 11:32 PM, Ryan Barnett <ryan.barnett at breach.com>wrote:


> Hey Chris,

 Please see my other email that I just sent to the list about the new CRS

v2.0.4 as the HTTP Parameter Pollution rule now has a rule id.  With this
> info, you can now add the following example exception rule to the 48 local
> exceptions conf file -
>
> SecRule REQUEST_FILENAME "@streq /VulnScript.php"
> "chain,phase:2,t:none,nolog,pass"
> SecRule TX:/^HPP-1.*ARGS:(foo|bar)/ "." "chain,setvar:tx.hpp-
> counter=+1,setvar:tx.hpp-%{tx.hpp-counter}=%{matched_var_name}"
>        SecRule TX:'/^HPP-/' "^TX:(hpp.*ARGS:(foo|bar))$"
> "capture,setvar:!tx.
> %{tx.1},setvar:tx.anomaly_score=-20"
>

Hi Ryan,

Based on the number of questions to the list regarding the proper way to
create exceptions, more documentation, perhaps a step by step blog post or
something would be really helpful in wrapping my head around this.

In the example above:
1. can you explain the logic in incrementing the tx.hpp-counter and setting
tx.hpp-%{tx.hpp-
    counter}=%{matched_var_name}"

2. can you explain the last SecRule line as well.

3. when using concurrent logging, is there any way (besides for increasing
the debug log
    level) to see the name of the relevant variable set that needs its
anomaly score
    decreased?

Thanks,
 - Chris
-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20091221/73d320f3/attachment.html 

From jnavarro at pedagogiainteractiva.com  Wed Dec 23 06:22:06 2009
From: jnavarro at pedagogiainteractiva.com (Javier Navarro )
Date: Wed, 23 Dec 2009 12:22:06 +0100
Subject: [Owasp-modsecurity-core-rule-set] folder exception
Message-ID: <939E28970A77474DBC6A3C9D7DC3648A0239A028@EXVS01.pro.pinteractiva.local>

Hi,

With the new rules version and modsecurity, it's now possible to do a folder exception for rules?

In the old version:

 

 <LocationMatch "/main/">

   SecFilterRemove 300016 

</LocationMatch>

 

How to do now If I want  something similar now?

 

Thx 

---

Javier Navarro

?rea Tecnologia

 

Pedagogia Interactiva, S.L.

C/Marie Curie s/n 

Parc Tecnol?gic BCNord

08042 Barcelona

T: +34 93 253 91 94 ; F: +34 93 291 76 91 

www.pedagogiainteractiva.com <BLOCKED::http://www.pedagogiainteractiva.com/> 

 

Advert?ncia legal <BLOCKED::http://www.pedagogiainteractiva.com/avis_legal/legal_cat.htm>   /  Advertencia legal <BLOCKED::http://www.pedagogiainteractiva.com/avis_legal/legal_cast.htm>   /  Legal Notice <BLOCKED::http://www.pedagogiainteractiva.com/avis_legal/legal_eng.htm> 

 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20091223/8a63788a/attachment.html 

From chris at jwall.org  Wed Dec 23 06:21:02 2009
From: chris at jwall.org (Christian Bockermann)
Date: Wed, 23 Dec 2009 12:21:02 +0100
Subject: [Owasp-modsecurity-core-rule-set] folder exception
In-Reply-To: <939E28970A77474DBC6A3C9D7DC3648A0239A028@EXVS01.pro.pinteractiva.local>
References: <939E28970A77474DBC6A3C9D7DC3648A0239A028@EXVS01.pro.pinteractiva.local>
Message-ID: <983E4B93-6970-4291-B7D6-570B5B40311C@jwall.org>

Hi Javier,

this should work with ModSecurity 2.x as well.
The command is now called "SecRuleRemoveById":

     <LocationMatch "/main">

        SecRuleRemoveById 300016

     </LocationMatch>


or as part of an action: "ctl:removeRuleById=300016".

But be aware, that LocationMatch-,Location- and Directory-directives are
processed in phase-2. So, if you do want to remove a rule from phase-1 for
a specific URL, you'd need to do something like

       SecRule  REQUEST_URI ^/main/   "phase:1,ctl:removeRuleById=300016"



This might however become obsolete with Ivan's nice patch in 2.6 which 
makes LocationMatch-,Location- and Direcotry-directives available in phase-1
as well.

Regards,

    Chris


Am 23.12.2009 um 12:22 schrieb Javier Navarro:

> Hi,
> With the new rules version and modsecurity, it?s now possible to do a folder exception for rules?
> In the old version:
>  
>  <LocationMatch "/main/">
>    SecFilterRemove 300016
> </LocationMatch>
>  
> How to do now If I want  something similar now?
>  
> Thx
> ---
> Javier Navarro
> ?rea Tecnologia
>  
> Pedagogia Interactiva, S.L.
> C/Marie Curie s/n
> Parc Tecnol?gic BCNord
> 08042 Barcelona
> T: +34 93 253 91 94 ; F: +34 93 291 76 91
> www.pedagogiainteractiva.com
>  
> Advert?ncia legal  /  Advertencia legal  /  Legal Notice
>  
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set


From jnavarro at pedagogiainteractiva.com  Wed Dec 23 07:02:22 2009
From: jnavarro at pedagogiainteractiva.com (Javier Navarro )
Date: Wed, 23 Dec 2009 13:02:22 +0100
Subject: [Owasp-modsecurity-core-rule-set] folder exception
In-Reply-To: <983E4B93-6970-4291-B7D6-570B5B40311C@jwall.org>
References: <939E28970A77474DBC6A3C9D7DC3648A0239A028@EXVS01.pro.pinteractiva.local>
	<983E4B93-6970-4291-B7D6-570B5B40311C@jwall.org>
Message-ID: <939E28970A77474DBC6A3C9D7DC3648A0239A036@EXVS01.pro.pinteractiva.local>

Fast answer! :P
Ok I understand, too many changes on this version (and a little confuse when not have a rule ID).

Thanks...

---
Javier Navarro
?rea?Tecnologia

Pedagogia Interactiva, S.L.
C/Marie Curie s/n 
Parc Tecnol?gic BCNord
08042 Barcelona
T: +34 93 253 91 94 ; F: +34 93 291 76 91 
www.pedagogiainteractiva.com
?
Advert?ncia legal? /? Advertencia legal? /? Legal Notice


-----Original Message-----
From: Christian Bockermann [mailto:chris at jwall.org] 
Sent: mi?rcoles, 23 de diciembre de 2009 12:21
To: Javier Navarro 
Cc: owasp-modsecurity-core-rule-set at lists.owasp.org
Subject: Re: [Owasp-modsecurity-core-rule-set] folder exception

Hi Javier,

this should work with ModSecurity 2.x as well.
The command is now called "SecRuleRemoveById":

     <LocationMatch "/main">

        SecRuleRemoveById 300016

     </LocationMatch>


or as part of an action: "ctl:removeRuleById=300016".

But be aware, that LocationMatch-,Location- and Directory-directives are
processed in phase-2. So, if you do want to remove a rule from phase-1 for
a specific URL, you'd need to do something like

       SecRule  REQUEST_URI ^/main/   "phase:1,ctl:removeRuleById=300016"



This might however become obsolete with Ivan's nice patch in 2.6 which 
makes LocationMatch-,Location- and Direcotry-directives available in phase-1
as well.

Regards,

    Chris


Am 23.12.2009 um 12:22 schrieb Javier Navarro:

> Hi,
> With the new rules version and modsecurity, it's now possible to do a folder exception for rules?
> In the old version:
>  
>  <LocationMatch "/main/">
>    SecFilterRemove 300016
> </LocationMatch>
>  
> How to do now If I want  something similar now?
>  
> Thx
> ---
> Javier Navarro
> ?rea Tecnologia
>  
> Pedagogia Interactiva, S.L.
> C/Marie Curie s/n
> Parc Tecnol?gic BCNord
> 08042 Barcelona
> T: +34 93 253 91 94 ; F: +34 93 291 76 91
> www.pedagogiainteractiva.com
>  
> Advert?ncia legal  /  Advertencia legal  /  Legal Notice
>  
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set


From jnavarro at pedagogiainteractiva.com  Wed Dec 23 07:33:13 2009
From: jnavarro at pedagogiainteractiva.com (Javier Navarro )
Date: Wed, 23 Dec 2009 13:33:13 +0100
Subject: [Owasp-modsecurity-core-rule-set] folder exception
In-Reply-To: <DC8120C9-4067-4FF7-B807-43A8022A7017@jwall.org>
References: <939E28970A77474DBC6A3C9D7DC3648A0239A028@EXVS01.pro.pinteractiva.local>
	<983E4B93-6970-4291-B7D6-570B5B40311C@jwall.org>
	<939E28970A77474DBC6A3C9D7DC3648A0239A036@EXVS01.pro.pinteractiva.local>
	<DC8120C9-4067-4FF7-B807-43A8022A7017@jwall.org>
Message-ID: <939E28970A77474DBC6A3C9D7DC3648A0239A038@EXVS01.pro.pinteractiva.local>

No, we have ModSecurity 2.5.11 with Core rules 2.0.4.
I tested your AuditConsole in preproduction machines when was unestable. This Christmas I'll going to resolve some ModSecurity's problems (in production) and install the AuditConsole.

:)

---
Javier Navarro
?rea?Tecnologia

Pedagogia Interactiva, S.L.
C/Marie Curie s/n 
Parc Tecnol?gic BCNord
08042 Barcelona
T: +34 93 253 91 94 ; F: +34 93 291 76 91 
www.pedagogiainteractiva.com
?
Advert?ncia legal? /? Advertencia legal? /? Legal Notice


-----Original Message-----
From: Christian Bockermann [mailto:chris at jwall.org] 
Sent: mi?rcoles, 23 de diciembre de 2009 12:54
To: Javier Navarro 
Subject: Re: [Owasp-modsecurity-core-rule-set] folder exception


Am 23.12.2009 um 13:02 schrieb Javier Navarro:

> Fast answer! :P

Yes, saw you on my AuditConsole mailing-list and thought I'd provide instant support :)


> Ok I understand, too many changes on this version (and a little confuse when not have a rule ID).
> 

Are you still using ModSecurity 1.x?

Regards,
    Chris

