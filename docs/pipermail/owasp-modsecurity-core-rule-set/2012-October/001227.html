<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] missing httpS match in ET RFI attack rule
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20missing%20httpS%20match%20in%20ET%20RFI%0A%20attack%20rule&In-Reply-To=%3C01987910BF74B341B5890120BCCE77DF034E71%40SKYMB1.trustwave.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001226.html">
   <LINK REL="Next"  HREF="001235.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] missing httpS match in ET RFI attack rule</H1>
    <B>Ryan Barnett</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20missing%20httpS%20match%20in%20ET%20RFI%0A%20attack%20rule&In-Reply-To=%3C01987910BF74B341B5890120BCCE77DF034E71%40SKYMB1.trustwave.com%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] missing httpS match in ET RFI attack rule">RBarnett at trustwave.com
       </A><BR>
    <I>Fri Oct 19 18:05:32 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="001226.html">[Owasp-modsecurity-core-rule-set] missing httpS match in ET RFI	attack rule
</A></li>
        <LI>Next message: <A HREF="001235.html">[Owasp-modsecurity-core-rule-set] missing httpS match in ET RFI attack rule
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1227">[ date ]</a>
              <a href="thread.html#1227">[ thread ]</a>
              <a href="subject.html#1227">[ subject ]</a>
              <a href="author.html#1227">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Jamie,
I agree with your assessment and the need to strengthen the coverage.  We
have a script that auto-converts the ET Snort web signatures from here -
<A HREF="http://rules.emergingthreats.net/open/snort-2.8.4/rules/">http://rules.emergingthreats.net/open/snort-2.8.4/rules/</A> - into the SLR
ModSecurity rules.

Reference blog post -
<A HREF="http://blog.spiderlabs.com/2011/04/modsecurity-advanced-topic-of-the-week-i">http://blog.spiderlabs.com/2011/04/modsecurity-advanced-topic-of-the-week-i</A>
ntegrating-ids-signatures.html

The issue here is that there was not a consistent format used by ET Snort
sig writers.  For good virtual patches, we need mainly need: 1) URI, 2)
Param name - injection point and 3) Attack Category.  With this data, we
can auto-create a pretty good rule.

Let's look at one example. Here is an SQL vuln -
#by tinytwitty
#
alert tcp $EXTERNAL_NET any -&gt; $HTTP_SERVERS $HTTP_PORTS (msg:&quot;ET
WEB_SPECIFIC_APPS GaziYapBoz Game Portal SQL Injection Attempt --
kategori.asp kategori UPDATE&quot;; flow:established,to_server;
uricontent:&quot;/kategori.asp?&quot;; nocase; uricontent:&quot;kategori=&quot;; nocase;
uricontent:&quot;UPDATE&quot;; nocase; pcre:&quot;/UPDATE.+SET/Ui&quot;;
reference:cve,CVE-2007-1410; reference:url,www.milw0rm.com/exploits/3437;
reference:url,doc.emergingthreats.net/2004402;
classtype:web-application-attack; sid:2004402; rev:5;)


We got the needed info:
1) uricontent:&quot;kategori.asp?&quot;
2) uricontent:&quot;kategori=&quot;
3) SQL Injection

With this info, our scripts auto-created this rule -
# (2004402) SpiderLabs Research (SLR) Public Vulns: ET WEB_SPECIFIC_APPS
GaziYapBoz Game Portal SQL Injection Attempt -- kategori.asp kategori
UPDATE
SecRule REQUEST_LINE &quot;@contains /kategori.asp&quot;
&quot;chain,phase:2,block,t:none,t:urlDecodeUni,t:htmlEntityDecode,t:normalisePa
thWin,capture,nolog,auditlog,logdata:'%{TX.0}',severity:'2',id:2004402,rev:
5,msg:'SLR: ET WEB_SPECIFIC_APPS GaziYapBoz Game Portal SQL Injection
Attempt -- kategori.asp kategori
UPDATE',tag:'web-application-attack',tag:'url,www.milw0rm.com/exploits/3437
'&quot;
SecRule &amp;TX:'/SQL_INJECTION.*ARGS:kategori/' &quot;@gt 0&quot;
&quot;ctl:auditLogParts=+E,setvar:'tx.msg=ET WEB_SPECIFIC_APPS GaziYapBoz Game
Portal SQL Injection Attempt -- kategori.asp kategori
UPDATE',setvar:tx.anomaly_score=+%{tx.critical_anomaly_score},setvar:'tx.%{
rule.id}-WEB_ATTACK/SQL_INJECTION-%{matched_var_name}=%{matched_var}'&quot;


The issue with the particular Snort sig that you highlighted is that it
doesn't clearly indicate the injection point/param by using -
uricontent:&quot;param=&quot; syntax.

#Submitted 2006-06-29 by Frank Knobbe
#
alert tcp $EXTERNAL_NET any -&gt; $HTTP_SERVERS $HTTP_PORTS (msg:&quot;ET
WEB_SPECIFIC_APPS GeekLog Remote File Include Vulnerability&quot;;
flow:established,to_server; uricontent:&quot;.php?&quot;; nocase;
uricontent:&quot;_CONF&quot;; nocase; pcre:&quot;/_CONF\[.*\]=(http|ftps?|php)\:\//Ui&quot;;
reference:url,securitydot.net/xpl/exploits/vulnerabilities/articles/1122/ex
ploit.html; reference:url,doc.emergingthreats.net/2002996;
classtype:web-application-attack; sid:2002996; rev:6;)

When we don't get this clean param data, we revert to using the data
provided by the original Snort rule writer.  So, your concerns about the
regex are valid but we currently can't do much about it...


I will try and look at updating our script to better handle these issues.

--
Ryan Barnett
Trustwave SpiderLabs
ModSecurity Project Leader
OWASP ModSecurity CRS Project Leader





On 10/19/12 6:43 AM, &quot;Jamie Riden&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">jamie at honeynet.org</A>&gt; wrote:

&gt;<i>Hi all,
</I>&gt;<i>
</I>&gt;<i>I found one rule which doesn't check for =<A HREF="https://">https://</A> RFI attacks:
</I>&gt;<i>
</I>&gt;<i>./slr_rules/modsecurity_crs_46_slr_et_rfi_attacks.conf
</I>&gt;<i>
</I>&gt;<i>SecRule QUERY_STRING|REQUEST_BODY
</I>&gt;<i>&quot;(?i:_CONF\[.*\]=(http|ftps?|php)\:\/)&quot;
</I>&gt;<i>&quot;ctl:auditLogParts=+E,setvar:'tx.msg=ET WEB_SPECIFIC_APPS GeekLog
</I>&gt;<i>Remote File Include
</I>&gt;<i>Vulnerability',setvar:tx.anomaly_score=+%{tx.critical_anomaly_score},setva
</I>&gt;<i>r:'tx.%{rule.id}-WEB_ATTACK/RFI-%{matched_var_name}=%{matched_var}'&quot;
</I>&gt;<i>
</I>&gt;<i>This should be =(https?|ftps?|php) - same for all PHP remote file
</I>&gt;<i>includes, they're technically possible over any of those protocols.
</I>&gt;<i>
</I>&gt;<i>( For that matter, <A HREF="data://">data://</A> or <A HREF="zlib://">zlib://</A> should be possible too - see
</I>&gt;<i>e.g. <A HREF="http://www.php.net/manual/en/wrappers.data.php">http://www.php.net/manual/en/wrappers.data.php</A> , and
</I>&gt;<i><A HREF="http://www.php.net/manual/en/wrappers.php">http://www.php.net/manual/en/wrappers.php</A>
</I>&gt;<i>
</I>&gt;<i>I have mentioned this to ET's Matt Jonkman in the past, but I gather
</I>&gt;<i>he was worried about the performance hit from checking
</I>&gt;<i>(=data|https?|ftps?|zlib| etc etc) for
</I>&gt;<i>all PHP RFI sigs in Emerging Threats. mod_security may not be so
</I>&gt;<i>sensitive to the extra pattern matches.  Just something to think about
</I>&gt;<i>- I can try for a proof of concept if anyone's interested?)
</I>&gt;<i>
</I>&gt;<i>cheers,
</I>&gt;<i> Jamie
</I>&gt;<i>--
</I>&gt;<i>Jamie Riden / <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">jamie at honeynet.org</A> / <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">jamie.riden at gmail.com</A>
</I>&gt;<i><A HREF="http://uk.linkedin.com/in/jamieriden">http://uk.linkedin.com/in/jamieriden</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>--
</I>&gt;<i>Jamie Riden / <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">jamie at honeynet.org</A> / <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">jamie.riden at gmail.com</A>
</I>&gt;<i><A HREF="http://uk.linkedin.com/in/jamieriden">http://uk.linkedin.com/in/jamieriden</A>
</I>&gt;<i>Jamie Riden / <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">jamie at honeynet.org</A> / <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">jamie.riden at gmail.com</A>
</I>&gt;<i><A HREF="http://uk.linkedin.com/in/jamieriden">http://uk.linkedin.com/in/jamieriden</A>
</I>&gt;<i>Jamie Riden / <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">jamie at honeynet.org</A> / <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">jamie.riden at gmail.com</A>
</I>&gt;<i><A HREF="http://uk.linkedin.com/in/jamieriden">http://uk.linkedin.com/in/jamieriden</A>
</I>&gt;<i>_______________________________________________
</I>&gt;<i>Owasp-modsecurity-core-rule-set mailing list
</I>&gt;<i><A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>
</I>&gt;<i><A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set</A>
</I>&gt;<i>
</I>

________________________________

This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.

</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001226.html">[Owasp-modsecurity-core-rule-set] missing httpS match in ET RFI	attack rule
</A></li>
	<LI>Next message: <A HREF="001235.html">[Owasp-modsecurity-core-rule-set] missing httpS match in ET RFI attack rule
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1227">[ date ]</a>
              <a href="thread.html#1227">[ thread ]</a>
              <a href="subject.html#1227">[ subject ]</a>
              <a href="author.html#1227">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
