<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Anomaly scoring mode no longer blocks only on anomaly_score in CRS 2.2.8 ?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Anomaly%20scoring%20mode%20no%0A%20longer%20blocks%20only%20on%20anomaly_score%20in%20CRS%202.2.8%20%3F&In-Reply-To=%3CCAG6aRdU%3DU7OvtKoqy9rTLRF5T8WG9Y%3DYuQVaTbWd%3DReHPYDpOw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001435.html">
   <LINK REL="Next"  HREF="001437.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Anomaly scoring mode no longer blocks only on anomaly_score in CRS 2.2.8 ?</H1>
    <B>chris derham</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Anomaly%20scoring%20mode%20no%0A%20longer%20blocks%20only%20on%20anomaly_score%20in%20CRS%202.2.8%20%3F&In-Reply-To=%3CCAG6aRdU%3DU7OvtKoqy9rTLRF5T8WG9Y%3DYuQVaTbWd%3DReHPYDpOw%40mail.gmail.com%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] Anomaly scoring mode no longer blocks only on anomaly_score in CRS 2.2.8 ?">chris at derham.me.uk
       </A><BR>
    <I>Thu Aug  8 10:21:53 UTC 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="001435.html">[Owasp-modsecurity-core-rule-set] Anomaly scoring mode no	longer blocks only on anomaly_score in CRS 2.2.8 ?
</A></li>
        <LI>Next message: <A HREF="001437.html">[Owasp-modsecurity-core-rule-set] Anomaly scoring mode no longer blocks only on anomaly_score in CRS 2.2.8 ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1436">[ date ]</a>
              <a href="thread.html#1436">[ thread ]</a>
              <a href="subject.html#1436">[ subject ]</a>
              <a href="author.html#1436">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>All,

Ok I'll have a go at helping out, seeing as  hit the same issue yesterday.

All the mod rules update the ANOMALY_SCORE when something bad is
found. Then in modsecurity_crs_49_inbound_blocking.conf, rule 981175
checks the value of ANOMALY_SCORE against
tx.inbound_anomaly_score_level. The request is blocked if the score is
higher than the score level and ANOMALY_SCORE_BLOCKING is set to on.

So to enable anomaly score blocking when you deploy a new set of CRS
rules, copy modsecurity_crs_10_setup.conf.example and make the
following edits

1) Change SecDefaultAction to &quot;phase:1,pass,log&quot;
2) uncomment 900004 - this turns sets tx.anomaly_score_blocking to on

We wished for different mechanism for blocking, e.g. friendly
&quot;security says you are doing something bad&quot; page, so we edited the4
rules in modsecurity_crs_49_inbound_blocking.conf and
modsecurity_crs_59_outbound_blocking.conf such that they moved from
&quot;...,t:none,deny,msg:....&quot; to from
&quot;...,t:none,deny,status:412,msg:....&quot;. Then we added the following to
apache conf

ErrorDocument 412 /error/securityIssue.html

We tested with an attempted path traversal, and via audit console we
can see that this is blocking using anomaly score detection.

Hope that helps

Thanks

Chris

On Thu, Aug 8, 2013 at 12:19 AM, Ryan Barnett &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">ryan.barnett at owasp.org</A>&gt; wrote:
&gt;<i> FYI I am on vacation and will respond next week. Hopefully someone else can offer advice in my stead.
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Ryan Barnett
</I>&gt;<i> Lead Security Researcher
</I>&gt;<i> Trustwave - SpiderLabs
</I>&gt;<i>
</I>&gt;<i> On Aug 7, 2013, at 11:32 AM, Damien Wyart &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">damien.wyart at gmail.com</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I've not had time to test it myself, but this message seemed a bit
</I>&gt;&gt;<i> annoying and important, so I am surprised there was no &quot;official&quot;
</I>&gt;&gt;<i> response (from Ryan).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Would it be possible to have some opinions on this potential problem?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Many thanks in advance,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Damien
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> In anomaly scoring mode, CRS 2.2.8 no longer blocks based only on tx.anomaly_score
</I>&gt;&gt;&gt;<i> exceeding the tx.inbound_anomaly_score_level.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Example:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> - This rule worked on some previous CRS version. But, in 2.2.8, it does not block based on tx.anomaly_score:
</I>&gt;&gt;&gt;<i> SecRule REQUEST_URI &quot;^/local/modsec/test$&quot; &quot;id:'10999',auditlog,block,msg:'LOCAL: modsec test',setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.critical_anomaly_score}&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> - Appending setvar:'tx.%{rule.id}-local-modsec-test=bad' to the above rule &quot;fixes&quot; that:
</I>&gt;&gt;&gt;<i> SecRule REQUEST_URI &quot;^/local/modsec/test$&quot; &quot;id:'10999',auditlog,block,msg:'LOCAL: modsec test',setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.critical_anomaly_score},setvar:'tx.%{rule.id}-local-modsec-test=bad'&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Here was the mod that changed the behavior to base_rules/modsecurity_crs_49_inbound_blocking.conf:
</I>&gt;&gt;&gt;<i> <A HREF="https://github.com/SpiderLabs/owasp-modsecurity-crs/commit/b054a4d92a00812b031facb3f81dd70e728ae8b3">https://github.com/SpiderLabs/owasp-modsecurity-crs/commit/b054a4d92a00812b031facb3f81dd70e728ae8b3</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> So, is the fact that CRS 2.2.8 now longer really blocks based only
</I>&gt;&gt;&gt;<i> on tx.anomaly_score an unintended consequence ?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Owasp-modsecurity-core-rule-set mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>
</I>&gt;&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set</A>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Owasp-modsecurity-core-rule-set mailing list
</I>&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>
</I>&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set</A>
</I></PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001435.html">[Owasp-modsecurity-core-rule-set] Anomaly scoring mode no	longer blocks only on anomaly_score in CRS 2.2.8 ?
</A></li>
	<LI>Next message: <A HREF="001437.html">[Owasp-modsecurity-core-rule-set] Anomaly scoring mode no longer blocks only on anomaly_score in CRS 2.2.8 ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1436">[ date ]</a>
              <a href="thread.html#1436">[ thread ]</a>
              <a href="subject.html#1436">[ subject ]</a>
              <a href="author.html#1436">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
