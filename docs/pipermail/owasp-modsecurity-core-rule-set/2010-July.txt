From chris.datfung at gmail.com  Thu Jul  1 04:30:39 2010
From: chris.datfung at gmail.com (Chris Datfung)
Date: Thu, 1 Jul 2010 11:30:39 +0300
Subject: [Owasp-modsecurity-core-rule-set] Collection problem in CRS 2.0.7
Message-ID: <AANLkTinDyIeyHCXJXt-rmTaG5aU6_6eP_KD428W-fKlQ@mail.gmail.com>

Since I upgraded to CRS 2.0.7 I see the following message in section H in
the logs:

--cbe3b111-H--
 Message: Asked to set variable "20", but no collection name specified.

Any ideas what's causing this?

Thanks,
Chris
-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20100701/a09a763e/attachment.html 

From ard at 100.pfr.ru  Thu Jul  1 13:11:20 2010
From: ard at 100.pfr.ru (Artyom Davidov)
Date: Thu, 1 Jul 2010 21:11:20 +0400
Subject: [Owasp-modsecurity-core-rule-set] Collection problem in CRS 2.0.7
In-Reply-To: <AANLkTinDyIeyHCXJXt-rmTaG5aU6_6eP_KD428W-fKlQ@mail.gmail.com>
Message-ID: <OFB7CA5250.779C6D56-ONC3257753.005E0CBE-C3257753.005E6C5A@100.pfr.ru>

Hello, Chris!

owasp-modsecurity-core-rule-set-bounces at lists.owasp.org ???????? 
01.07.2010 12:30:39:

> Since I upgraded to CRS 2.0.7 I see the following message in section
> H in the logs:
> 
> --cbe3b111-H--
>  Message: Asked to set variable "20", but no collection name specified.
> 
> Any ideas what's causing this?
> 
> Thanks,
> Chris_______________________________________________

It looks like the same bug that was reported earlier in this list.
You can read that disscussion and solution in list archive by following 
this link:
https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/2010-June/000398.html

wbr
Artyom
-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20100701/e733e9bf/attachment.html 

From oxdef at oxdef.info  Wed Jul  7 11:41:43 2010
From: oxdef at oxdef.info (Taras)
Date: Wed, 7 Jul 2010 19:41:43 +0400
Subject: [Owasp-modsecurity-core-rule-set] "Too many arguments in request in
 default CRS installation" looks like bug in CRS
Message-ID: <20100707194143.87d530ef.oxdef@oxdef.info>


Hi, all!

Debian 5.0 Lenny, ModSecurity Version: 2.5.11 installed from backports
modsecurity-crs_2.0.7
--------------

In default installation I have follow error in log when try to access /index.php?d=11&dfgdfgdg=g

[Wed Jul 07 19:30:44 2010] [error] [client **.**.**.**] ModSecurity: Warning. Operator GE matched 0 at TX:inbound_anomaly_score. [file "/etc/apache2/conf.d/modsecurity_crs/base_rules/modsecurity_crs_60_correlation.conf"] [line "35"] [msg "Inbound Anomaly Score Exceeded (Total Inbound Score: 5, SQLi=, XSS=): Too many arguments in request"] [hostname "******.*****.**"] [uri "/index.php"] [unique_id "TDSdpFf69wEAADdkAA4AAAAA"]

After that I commented line
SecAction "phase:1,t:none,nolog,pass,setvar:tx.max_num_args=255"
in modsecurity_crs_10_config.conf and it is ok and there is no error in log.

How can I correctly limit number of arguments and is there bug in CRS?

-- 
Taras
http://oxdef.info

From ryan.barnett at breach.com  Wed Jul  7 11:47:58 2010
From: ryan.barnett at breach.com (Ryan Barnett)
Date: Wed, 7 Jul 2010 11:47:58 -0400
Subject: [Owasp-modsecurity-core-rule-set] "Too many arguments in
	request in default CRS installation" looks like bug in CRS
In-Reply-To: <20100707194143.87d530ef.oxdef@oxdef.info>
References: <20100707194143.87d530ef.oxdef@oxdef.info>
Message-ID: <201007071147.59059.ryan.barnett@breach.com>

On Wednesday 07 July 2010 11:41:43 Taras wrote:
> Hi, all!
> 
> Debian 5.0 Lenny, ModSecurity Version: 2.5.11 installed from backports
> modsecurity-crs_2.0.7
> --------------
> 
> In default installation I have follow error in log when try to access
> /index.php?d=11&dfgdfgdg=g
> 
> [Wed Jul 07 19:30:44 2010] [error] [client **.**.**.**] ModSecurity:
> Warning. Operator GE matched 0 at TX:inbound_anomaly_score. [file
> "/etc/apache2/conf.d/modsecurity_crs/base_rules/modsecurity_crs_60_correla
> tion.conf"] [line "35"] [msg "Inbound Anomaly Score Exceeded (Total Inbound
> Score: 5, SQLi=, XSS=): Too many arguments in request"] [hostname
> "******.*****.**"] [uri "/index.php"] [unique_id
> "TDSdpFf69wEAADdkAA4AAAAA"]
> 
> After that I commented line
> SecAction "phase:1,t:none,nolog,pass,setvar:tx.max_num_args=255"
> in modsecurity_crs_10_config.conf and it is ok and there is no error in
> log.
> 
> How can I correctly limit number of arguments and is there bug in CRS?

First issue is to actually confirm that your application legitimately uses more then 255 
arguments/parameters in a request.  If so, what you should do is to update the 
tx.max_num_args setting in that line to accommodate the appropriate number.

-Ryan

From oxdef at oxdef.info  Wed Jul  7 14:33:35 2010
From: oxdef at oxdef.info (Taras)
Date: Wed, 07 Jul 2010 22:33:35 +0400
Subject: [Owasp-modsecurity-core-rule-set] "Too many arguments in
 request in default CRS installation" looks like bug in CRS
In-Reply-To: <201007071147.59059.ryan.barnett@breach.com>
References: <20100707194143.87d530ef.oxdef@oxdef.info>
	<201007071147.59059.ryan.barnett@breach.com>
Message-ID: <4C34C87F.6020305@oxdef.info>


Hi, Ryan!

> On Wednesday 07 July 2010 11:41:43 Taras wrote:
>> Hi, all!
>>
>> Debian 5.0 Lenny, ModSecurity Version: 2.5.11 installed from backports
>> modsecurity-crs_2.0.7
>> --------------
>>
>> In default installation I have follow error in log when try to access
>> /index.php?d=11&dfgdfgdg=g
>>
>> [Wed Jul 07 19:30:44 2010] [error] [client **.**.**.**] ModSecurity:
>> Warning. Operator GE matched 0 at TX:inbound_anomaly_score. [file
>> "/etc/apache2/conf.d/modsecurity_crs/base_rules/modsecurity_crs_60_correla
>> tion.conf"] [line "35"] [msg "Inbound Anomaly Score Exceeded (Total Inbound
>> Score: 5, SQLi=, XSS=): Too many arguments in request"] [hostname
>> "******.*****.**"] [uri "/index.php"] [unique_id
>> "TDSdpFf69wEAADdkAA4AAAAA"]
>>
>> After that I commented line
>> SecAction "phase:1,t:none,nolog,pass,setvar:tx.max_num_args=255"
>> in modsecurity_crs_10_config.conf and it is ok and there is no error in
>> log.
>>
>> How can I correctly limit number of arguments and is there bug in CRS?
> 
> First issue is to actually confirm that your application legitimately uses more then 255 
> arguments/parameters in a request.  If so, what you should do is to update the 
> tx.max_num_args setting in that line to accommodate the appropriate number.

My webapp in this case is simple *empty* script /index.php.
Problem is if such line is not commented there is error message in log
when I try to get /index.php with *some* params.

-- 
Taras
http://oxdef.info
----
"Software is like sex: it's better when it's free." - Linus Torvalds

From ryan.barnett at breach.com  Wed Jul  7 15:58:46 2010
From: ryan.barnett at breach.com (Ryan Barnett)
Date: Wed, 7 Jul 2010 15:58:46 -0400
Subject: [Owasp-modsecurity-core-rule-set] "Too many arguments in
	request in default CRS installation" looks like bug in CRS
In-Reply-To: <4C34C87F.6020305@oxdef.info>
References: <20100707194143.87d530ef.oxdef@oxdef.info>
	<201007071147.59059.ryan.barnett@breach.com>
	<4C34C87F.6020305@oxdef.info>
Message-ID: <201007071558.46337.ryan.barnett@breach.com>

On Wednesday 07 July 2010 14:33:35 Taras wrote:
> Hi, Ryan!
> 
> > On Wednesday 07 July 2010 11:41:43 Taras wrote:
> >> Hi, all!
> >> 
> >> Debian 5.0 Lenny, ModSecurity Version: 2.5.11 installed from backports
> >> modsecurity-crs_2.0.7
> >> --------------
> >> 
> >> In default installation I have follow error in log when try to access
> >> /index.php?d=11&dfgdfgdg=g
> >> 
> >> [Wed Jul 07 19:30:44 2010] [error] [client **.**.**.**] ModSecurity:
> >> Warning. Operator GE matched 0 at TX:inbound_anomaly_score. [file
> >> "/etc/apache2/conf.d/modsecurity_crs/base_rules/modsecurity_crs_60_corre
> >> la tion.conf"] [line "35"] [msg "Inbound Anomaly Score Exceeded (Total
> >> Inbound Score: 5, SQLi=, XSS=): Too many arguments in request"]
> >> [hostname "******.*****.**"] [uri "/index.php"] [unique_id
> >> "TDSdpFf69wEAADdkAA4AAAAA"]
> >> 
> >> After that I commented line
> >> SecAction "phase:1,t:none,nolog,pass,setvar:tx.max_num_args=255"
> >> in modsecurity_crs_10_config.conf and it is ok and there is no error in
> >> log.
> >> 
> >> How can I correctly limit number of arguments and is there bug in CRS?
> > 
> > First issue is to actually confirm that your application legitimately
> > uses more then 255 arguments/parameters in a request.  If so, what you
> > should do is to update the tx.max_num_args setting in that line to
> > accommodate the appropriate number.
> 
> My webapp in this case is simple *empty* script /index.php.
> Problem is if such line is not commented there is error message in log
> when I try to get /index.php with *some* params.

I think I found a bug in the 23 file.  The 2nd rule in the chain should have the & before 
the variable as to count the total number of parameter names.  Update it to this -

SecRule &TX:ARG_NAME_LENGTH "@eq 1" 
"chain,phase:2,t:none,pass,nolog,auditlog,msg:'Argument name too 
long',id:'960209',severity:'4',rev:'2.0.6'"
        SecRule &ARGS_NAMES "@gt %{tx.arg_name_length}" 
"t:none,t:length,setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.notice_anomaly_score},setvar:tx.policy_score=+%{tx.notice_anomaly_score},setvar:tx.
%{rule.id}-POLICY/SIZE_LIMIT-%{matched_var_name}=%{matched_var}"



From webappsec at securenet.de  Thu Jul  8 03:39:01 2010
From: webappsec at securenet.de (Achim Hoffmann)
Date: Thu, 8 Jul 2010 09:39:01 +0200 (MEST)
Subject: [Owasp-modsecurity-core-rule-set] (2.0.7) missing
	modsecurity_crs_49_enforcement.conf
Message-ID: <alpine.LNX.2.00.1007080936110.28808@tonga.securenet.de>


is there any reason why modsecurity_crs_49_enforcement.conf is missing
in CRS 2.0.7?

Please apologice if I missed some previous posts about that.

Achim


From webappsec at securenet.de  Thu Jul  8 04:11:17 2010
From: webappsec at securenet.de (Achim Hoffmann)
Date: Thu, 8 Jul 2010 10:11:17 +0200 (MEST)
Subject: [Owasp-modsecurity-core-rule-set] (2.0.7) syntax problem in
	..._41_phpids_filters.conf
Message-ID: <alpine.LNX.2.00.1007081003170.28808@tonga.securenet.de>

in the rules in base_rules/modsecurity_crs_41_phpids_filters.conf we read:

 	SecRule ..... "phase:2, ... ,setvar:%{tx.critical_anomaly_score}, ... "

which results in a Warning message when matched.
I assume that it should be:

 	SecRule ..... "phase:2, ... ,setvar:tx.anomaly_score+=%{tx.critical_anomaly_score} ... "

Achim


From jamuse at gmail.com  Thu Jul  8 04:44:03 2010
From: jamuse at gmail.com (Jamuse)
Date: Thu, 8 Jul 2010 11:44:03 +0300
Subject: [Owasp-modsecurity-core-rule-set] (2.0.7) syntax problem in
	..._41_phpids_filters.conf
In-Reply-To: <alpine.LNX.2.00.1007081003170.28808@tonga.securenet.de>
References: <alpine.LNX.2.00.1007081003170.28808@tonga.securenet.de>
Message-ID: <AANLkTinxZ2XsnuweIugDriHm2SXo-1LEq4nanmQtU2T7@mail.gmail.com>

On Thu, Jul 8, 2010 at 11:11 AM, Achim Hoffmann <webappsec at securenet.de>wrote:

> in the rules in base_rules/modsecurity_crs_41_phpids_filters.conf we read:
>
>        SecRule ..... "phase:2, ... ,setvar:%{tx.critical_anomaly_score},
> ... "
>
> which results in a Warning message when matched.
> I assume that it should be:
>
>        SecRule ..... "phase:2, ...
> ,setvar:tx.anomaly_score+=%{tx.critical_anomaly_score} ... "
>

Correct, there are a lot of these actually. See:

https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/2010-June/000398.html

- J


>
> Achim
>
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20100708/83933842/attachment.html 

From jamuse at gmail.com  Thu Jul  8 04:46:56 2010
From: jamuse at gmail.com (Jamuse)
Date: Thu, 8 Jul 2010 11:46:56 +0300
Subject: [Owasp-modsecurity-core-rule-set] (2.0.7) missing
	modsecurity_crs_49_enforcement.conf
In-Reply-To: <alpine.LNX.2.00.1007080936110.28808@tonga.securenet.de>
References: <alpine.LNX.2.00.1007080936110.28808@tonga.securenet.de>
Message-ID: <AANLkTil-xx2PjNZwEKOHILsOarntYjnl3E4cHHf0SY1n@mail.gmail.com>

On Thu, Jul 8, 2010 at 10:39 AM, Achim Hoffmann <webappsec at securenet.de>wrote:

>
> is there any reason why modsecurity_crs_49_enforcement.conf is missing
> in CRS 2.0.7?
>
> Please apologice if I missed some previous posts about that.
>

Hi Achim,

modsecurity_crs_49_enforcement.conf was replaced with
modsecurity_crs_59_outbound_blocking.conf

- J


> Achim
>
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20100708/5879da95/attachment.html 

From webappsec at securenet.de  Thu Jul  8 06:15:24 2010
From: webappsec at securenet.de (Achim Hoffmann)
Date: Thu, 8 Jul 2010 12:15:24 +0200 (MEST)
Subject: [Owasp-modsecurity-core-rule-set] (2.0.7) missing
 modsecurity_crs_49_enforcement.conf
In-Reply-To: <AANLkTil-xx2PjNZwEKOHILsOarntYjnl3E4cHHf0SY1n@mail.gmail.com>
References: <alpine.LNX.2.00.1007080936110.28808@tonga.securenet.de>
	<AANLkTil-xx2PjNZwEKOHILsOarntYjnl3E4cHHf0SY1n@mail.gmail.com>
Message-ID: <alpine.LNX.2.00.1007081212020.28808@tonga.securenet.de>


On Thu, 8 Jul 2010, Jamuse wrote:
!! On Thu, Jul 8, 2010 at 10:39 AM, Achim Hoffmann <webappsec at securenet.de> wrote:
!! 
!!       is there any reason why modsecurity_crs_49_enforcement.conf is missing
!!       in CRS 2.0.7?
!! 
!!       Please apologice if I missed some previous posts about that.
!! 
!! 
!! Hi Achim,
!! 
!! modsecurity_crs_49_enforcement.conf was replaced with
!! modsecurity_crs_59_outbound_blocking.conf


hmm, modsecurity_crs_59_outbound_blocking.conf does not contain
the scorings as in modsecurity_crs_49_enforcement.conf.
So the current CRS is missing some reliable actions, does it?

Achim


From jamuse at gmail.com  Thu Jul  8 06:21:24 2010
From: jamuse at gmail.com (Jamuse)
Date: Thu, 8 Jul 2010 13:21:24 +0300
Subject: [Owasp-modsecurity-core-rule-set] (2.0.7) missing
	modsecurity_crs_49_enforcement.conf
In-Reply-To: <alpine.LNX.2.00.1007081212020.28808@tonga.securenet.de>
References: <alpine.LNX.2.00.1007080936110.28808@tonga.securenet.de> 
	<AANLkTil-xx2PjNZwEKOHILsOarntYjnl3E4cHHf0SY1n@mail.gmail.com> 
	<alpine.LNX.2.00.1007081212020.28808@tonga.securenet.de>
Message-ID: <AANLkTinxxGB-8CtSRW-q0p6ArgIfQPndsVZAPMivBx2C@mail.gmail.com>

On Thu, Jul 8, 2010 at 1:15 PM, Achim Hoffmann <webappsec at securenet.de>wrote:

>
> hmm, modsecurity_crs_59_outbound_blocking.conf does not contain
> the scorings as in modsecurity_crs_49_enforcement.conf.
> So the current CRS is missing some reliable actions, does it?
>

I'm not sure what you mean by reliable actions, but the 59 file uses the
block action and then inherits the default action set earlier (in the 10
file) by SecDefaultAction.

- J
-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20100708/f306cb04/attachment.html 

From rcbarnett at gmail.com  Thu Jul  8 07:11:24 2010
From: rcbarnett at gmail.com (Ryan Barnett)
Date: Thu, 8 Jul 2010 07:11:24 -0400
Subject: [Owasp-modsecurity-core-rule-set] (2.0.7) missing
	modsecurity_crs_49_enforcement.conf
In-Reply-To: <alpine.LNX.2.00.1007080936110.28808@tonga.securenet.de>
References: <alpine.LNX.2.00.1007080936110.28808@tonga.securenet.de>
Message-ID: <AANLkTin_ipBJO8Y1CEoeLj02plPV2dWRhhQxzeot9gOr@mail.gmail.com>

http://www.owasp.org/index.php/Category:OWASP_ModSecurity_Core_Rule_Set_Project#tab=Documentation

The CRS rules themselves are configured with the pass action, which allows
all the rules to be processed and for the proposed anomaly
scoring/collaborative detection concept to work. The inbound/outbound
anomaly score levels may be set in the modsecurity_crs_10_config.conf file.
These scores will be evaluated in the
modsecurity_crs_49_inbound_blocking.conf and
modsecurity_crs_59_outbound_blocking.conf files.

We got feedback that the name modsecurity_crs_49_enforcement.conf was not
intuitive enough for people to know what the purpose of the file was so we
updated the name to modsecurity_crs_49_inbound_blocking.conf.  We also added
the modsecurity_crs_59_outbound_blocking.conf file to allow for proper
blocking at the end of phase:4 rules.

-Ryan


On Thu, Jul 8, 2010 at 3:39 AM, Achim Hoffmann <webappsec at securenet.de>wrote:

>
> is there any reason why modsecurity_crs_49_enforcement.conf is missing
> in CRS 2.0.7?
>
> Please apologice if I missed some previous posts about that.
>
> Achim
>
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>



-- 
Ryan C. Barnett
SANS Certified Instructor
WASC Web Hacking Incident Database Project Leader
WASC Distributed Open Proxy Honeypot Project Leader
OWASP ModSecurity Core Rule Set Project Leader
http://tacticalwebappsec.blogspot.com/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20100708/c97cdddc/attachment.html 

From webappsec at securenet.de  Thu Jul  8 08:50:29 2010
From: webappsec at securenet.de (Achim Hoffmann)
Date: Thu, 8 Jul 2010 14:50:29 +0200 (MEST)
Subject: [Owasp-modsecurity-core-rule-set] (2.0.7) missing
 modsecurity_crs_49_enforcement.conf
In-Reply-To: <AANLkTin_ipBJO8Y1CEoeLj02plPV2dWRhhQxzeot9gOr@mail.gmail.com>
References: <alpine.LNX.2.00.1007080936110.28808@tonga.securenet.de>
	<AANLkTin_ipBJO8Y1CEoeLj02plPV2dWRhhQxzeot9gOr@mail.gmail.com>
Message-ID: <alpine.LNX.2.00.1007081440320.28808@tonga.securenet.de>

Hi Ryan,

thanks for your feedback.
Some more comments please see inline below.

Achim

On Thu, 8 Jul 2010, Ryan Barnett wrote:

!! http://www.owasp.org/index.php/Category:OWASP_ModSecurity_Core_Rule_Set_Project#tab=Documentat
!! ion
!! The CRS rules themselves are configured with the pass action, which allows all the rules to be
!! processed and for the proposed anomaly scoring/collaborative detection concept to work. The
!! inbound/outbound anomaly score levels may be set in the modsecurity_crs_10_config.conf file.
!! These scores will be evaluated in the modsecurity_crs_49_inbound_blocking.conf and
!! modsecurity_crs_59_outbound_blocking.conf files.

I fully understand the concept how the CRS will behave (at least I guess to do
so :)

!! 
!! We got feedback that the name modsecurity_crs_49_enforcement.conf was not intuitive enough for
!! people to know what the purpose of the file was so we updated the name to
!! modsecurity_crs_49_inbound_blocking.conf. ?We also added the
!! modsecurity_crs_59_outbound_blocking.conf file to allow for proper blocking at the end of
!! phase:4 rules.

My question -better: wondering- was that the enforcment file is missing
*and* the 2 new files do not contain the rules from the older enforcment file.

Said this, I agree that the scoring should be evaluated at the end in a 
single (or two) file.
In practice this adjustment is highly user-definable like the scoring itself
and should be done in a file which will not be overwritten by future updates
of the CRS itself. Hence I'd suggest that these rules are written in a new
file *not located* in the base_rules/ directory.
Does this make sense?
IMHO modsecurity_crs_49_inbound_blocking.conf and 
modsecurity_crs_59_outbound_blocking.conf should not block, but may be used as
example.

!! 
!! -Ryan
!! 
!! 
!! On Thu, Jul 8, 2010 at 3:39 AM, Achim Hoffmann <webappsec at securenet.de> wrote:
!! 
!!       is there any reason why modsecurity_crs_49_enforcement.conf is missing
!!       in CRS 2.0.7?
!! 
!!       Please apologice if I missed some previous posts about that.
!! 
!! Achim
!! 
!! _______________________________________________
!! Owasp-modsecurity-core-rule-set mailing list
!! Owasp-modsecurity-core-rule-set at lists.owasp.org
!! https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
!! 
!! 
!! 
!! 
!! --
!! Ryan C. Barnett
!! SANS Certified Instructor
!! WASC Web Hacking Incident Database Project Leader
!! WASC Distributed Open Proxy Honeypot Project Leader
!! OWASP ModSecurity Core Rule Set Project Leader
!! http://tacticalwebappsec.blogspot.com/
!! 
!! 
!! 

From rcbarnett at gmail.com  Thu Jul  8 09:03:27 2010
From: rcbarnett at gmail.com (Ryan Barnett)
Date: Thu, 8 Jul 2010 09:03:27 -0400
Subject: [Owasp-modsecurity-core-rule-set] (2.0.7) missing
	modsecurity_crs_49_enforcement.conf
In-Reply-To: <alpine.LNX.2.00.1007081440320.28808@tonga.securenet.de>
References: <alpine.LNX.2.00.1007080936110.28808@tonga.securenet.de>
	<AANLkTin_ipBJO8Y1CEoeLj02plPV2dWRhhQxzeot9gOr@mail.gmail.com>
	<alpine.LNX.2.00.1007081440320.28808@tonga.securenet.de>
Message-ID: <201007080903.28203.rcbarnett@gmail.com>

On Thursday 08 July 2010 08:50:29 Achim Hoffmann wrote:
> Hi Ryan,
> 
> thanks for your feedback.
> Some more comments please see inline below.
> 
> Achim
> 
> On Thu, 8 Jul 2010, Ryan Barnett wrote:
> 
> !!
> http://www.owasp.org/index.php/Category:OWASP_ModSecurity_Core_Rule_Set_Pr
> oject#tab=Documentat !! ion
> !! The CRS rules themselves are configured with the pass action, which
> allows all the rules to be !! processed and for the proposed anomaly
> scoring/collaborative detection concept to work. The !! inbound/outbound
> anomaly score levels may be set in the modsecurity_crs_10_config.conf
> file. !! These scores will be evaluated in the
> modsecurity_crs_49_inbound_blocking.conf and !!
> modsecurity_crs_59_outbound_blocking.conf files.
> 
> I fully understand the concept how the CRS will behave (at least I guess to
> do so :)
> 
> !!
> !! We got feedback that the name modsecurity_crs_49_enforcement.conf was
> not intuitive enough for !! people to know what the purpose of the file
> was so we updated the name to !! modsecurity_crs_49_inbound_blocking.conf.
>  We also added the
> !! modsecurity_crs_59_outbound_blocking.conf file to allow for proper
> blocking at the end of !! phase:4 rules.
> 
> My question -better: wondering- was that the enforcment file is missing
> *and* the 2 new files do not contain the rules from the older enforcment
> file.

The files contain similar/updated rules.  The older 49 enforcement file contained a bunch of 
commented out example rules.

> 
> Said this, I agree that the scoring should be evaluated at the end in a
> single (or two) file.
> In practice this adjustment is highly user-definable like the scoring
> itself and should be done in a file which will not be overwritten by
> future updates of the CRS itself. Hence I'd suggest that these rules are
> written in a new file *not located* in the base_rules/ directory.
> Does this make sense?
> IMHO modsecurity_crs_49_inbound_blocking.conf and
> modsecurity_crs_59_outbound_blocking.conf should not block, but may be used
> as example.
> 

This is a good point and it is a similar rationale as to why we renamed and moved the 48 
local exceptions file up to the main dir with the 10 file as to not overwrite a customized 
version.

I think that we do need to review the CRS and take some notes about possible changes to 
make them easier to manage.

-Ryan

> !!
> !! -Ryan
> !!
> !!
> !! On Thu, Jul 8, 2010 at 3:39 AM, Achim Hoffmann <webappsec at securenet.de>
> wrote: !!
> !!       is there any reason why modsecurity_crs_49_enforcement.conf is
> missing !!       in CRS 2.0.7?
> !!
> !!       Please apologice if I missed some previous posts about that.
> !!
> !! Achim
> !!
> !! _______________________________________________
> !! Owasp-modsecurity-core-rule-set mailing list
> !! Owasp-modsecurity-core-rule-set at lists.owasp.org
> !! https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
> !!
> !!
> !!
> !!
> !! --
> !! Ryan C. Barnett
> !! SANS Certified Instructor
> !! WASC Web Hacking Incident Database Project Leader
> !! WASC Distributed Open Proxy Honeypot Project Leader
> !! OWASP ModSecurity Core Rule Set Project Leader
> !! http://tacticalwebappsec.blogspot.com/
> !!
> !!
> !!

From oxdef at oxdef.info  Mon Jul 12 12:02:57 2010
From: oxdef at oxdef.info (Taras)
Date: Mon, 12 Jul 2010 20:02:57 +0400
Subject: [Owasp-modsecurity-core-rule-set] "Too many arguments in
 request in default CRS installation" looks like bug in CRS
In-Reply-To: <201007071558.46337.ryan.barnett@breach.com>
References: <20100707194143.87d530ef.oxdef@oxdef.info>
	<201007071147.59059.ryan.barnett@breach.com>
	<4C34C87F.6020305@oxdef.info>
	<201007071558.46337.ryan.barnett@breach.com>
Message-ID: <20100712200257.19e6da54.oxdef@oxdef.info>

Hi, Ryan!

One more thing:
I looks that also modsecurity is needed to be v2.5.12.
I just has compiled it from sources and it's ok

In CRS config we may see such message:
"...
**MUST HAVE** ModSecurity v2.5.12 or higher to use macro expansion in numeric
operators.  If you have an earlier version, edit the 49/59 files directly to
set the appropriate anomaly score levels.
..."

> > >> 
> > >> Debian 5.0 Lenny, ModSecurity Version: 2.5.11 installed from backports
> > >> modsecurity-crs_2.0.7
> > >> --------------
> > >> 
> > >> In default installation I have follow error in log when try to access
> > >> /index.php?d=11&dfgdfgdg=g
> > >> 
> > >> [Wed Jul 07 19:30:44 2010] [error] [client **.**.**.**] ModSecurity:
> > >> Warning. Operator GE matched 0 at TX:inbound_anomaly_score. [file
> > >> "/etc/apache2/conf.d/modsecurity_crs/base_rules/modsecurity_crs_60_corre
> > >> la tion.conf"] [line "35"] [msg "Inbound Anomaly Score Exceeded (Total
> > >> Inbound Score: 5, SQLi=, XSS=): Too many arguments in request"]
> > >> [hostname "******.*****.**"] [uri "/index.php"] [unique_id
> > >> "TDSdpFf69wEAADdkAA4AAAAA"]
> > >> 
> > >> After that I commented line
> > >> SecAction "phase:1,t:none,nolog,pass,setvar:tx.max_num_args=255"
> > >> in modsecurity_crs_10_config.conf and it is ok and there is no error in
> > >> log.
> > >> 
> > >> How can I correctly limit number of arguments and is there bug in CRS?
> > > 
> > > First issue is to actually confirm that your application legitimately
> > > uses more then 255 arguments/parameters in a request.  If so, what you
> > > should do is to update the tx.max_num_args setting in that line to
> > > accommodate the appropriate number.
> > 
> > My webapp in this case is simple *empty* script /index.php.
> > Problem is if such line is not commented there is error message in log
> > when I try to get /index.php with *some* params.
> 
> I think I found a bug in the 23 file.  The 2nd rule in the chain should have the & before 
> the variable as to count the total number of parameter names.  Update it to this -
> 
> SecRule &TX:ARG_NAME_LENGTH "@eq 1" 
> "chain,phase:2,t:none,pass,nolog,auditlog,msg:'Argument name too 
> long',id:'960209',severity:'4',rev:'2.0.6'"
>         SecRule &ARGS_NAMES "@gt %{tx.arg_name_length}" 
> "t:none,t:length,setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.notice_anomaly_score},setvar:tx.policy_score=+%{tx.notice_anomaly_score},setvar:tx.
> %{rule.id}-POLICY/SIZE_LIMIT-%{matched_var_name}=%{matched_var}"
> 


-- 
Taras
http://oxdef.info

From securityadmin at hcjb.org  Tue Jul 20 06:48:06 2010
From: securityadmin at hcjb.org (Josh Gee)
Date: Tue, 20 Jul 2010 11:48:06 +0100
Subject: [Owasp-modsecurity-core-rule-set] Bug in CRS 2.0.7
	modsecurity_crs_41_phpids_filters.conf
Message-ID: <4C457EE6.2080502@hcjb.org>

As referenced earlier (June 20 by modsec at enosis.com), there is a
setvar error in version 1516 of this file. 

However, the proposed fix does NOT correct the error.  The proposed fix
makes every PHPIDS rule a critical anomaly rule, which does not appear
to be the intent of the PHPIDS rules.  This will cause a lot of false
positives if you are using the correlation rules.

In addition, version 1516 changes the disruptive action of each of these
rules from pass to block.  This interferes with correlation level
behavior. (at least as far as I understand it, please feel free to
correct me if I've got this wrong)

Version 1525 attempts to resolve these issues, but I believe it misses
the true problem with the 1516 version and appears to add a different
version of the same problem.

Version 1525 changed:
setvar:%{tx.critical_anomaly_score}
to:
setvar:tx.%{tx.critical_anomaly_score}

Which appears to throw very similar errors. Looking at previous versions
of this file, it appears to me that the change should be:
setvar:tx.anomaly_score=+n
where n is equal to a weight applied to each PHPIDS rule.

Version 1503 of this file contained the the relative weight of each
PHPIDS rule. Attached is a modified
modsecurity_crs_41_phpids_filters.conf file.  I took the scoring levels
and pass/block action of version 1503 of this file and the actual rules
from the 1516 version. 

This version of the file appears to resolve the false-positives caused
by the recommended changes in the June 20 post, and "plays nice" with
the correlation rules by not forcing every rule to block or exceed the
anomaly score (unless that's the intention of the rule).

I'm open to suggestions and feedback, but I think I've got this issue
resolved, at least until there's an update to the PHPIDS rules.  There
is probably still some work to do on the scripts that convert the PHPIDS
rules into ModSecurity Rules.

-- 
Joshua Gee




-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20100720/394d06b9/attachment-0001.html 
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: modsecurity_crs_41_phpids_filters.conf.modified
Url: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20100720/394d06b9/attachment-0001.pl 

From ryan.barnett at breach.com  Tue Jul 20 08:25:22 2010
From: ryan.barnett at breach.com (Ryan Barnett)
Date: Tue, 20 Jul 2010 08:25:22 -0400
Subject: [Owasp-modsecurity-core-rule-set] Bug in CRS 2.0.7
	modsecurity_crs_41_phpids_filters.conf
In-Reply-To: <4C457EE6.2080502@hcjb.org>
References: <4C457EE6.2080502@hcjb.org>
Message-ID: <201007200825.23259.ryan.barnett@breach.com>

Thanks Josh.  It look as though a search/replace I ran while editing the php converter 
script caused these problems.  I will look at updating the converter again to fix the 
problems you outlined.

-Ryan

On Tuesday 20 July 2010 06:48:06 Josh Gee wrote:
> As referenced earlier (June 20 by modsec at enosis.com), there is a setvar
> error in version 1516 of this file.
> 
> However, the proposed fix does NOT correct the error.  The proposed fix
> makes every PHPIDS rule a critical anomaly rule, which does not appear to
> be the intent of the PHPIDS rules.  This will cause a lot of false
> positives if you are using the correlation rules.
> 
> In addition, version 1516 changes the disruptive action of each of these
> rules from pass to block.  This interferes with correlation level
> behavior. (at least as far as I understand it, please feel free to correct
> me if I've got this wrong)
> 
> Version 1525 attempts to resolve these issues, but I believe it misses the
> true problem with the 1516 version and appears to add a different version
> of the same problem.
> 
> Version 1525 changed:
> setvar:%{tx.critical_anomaly_score}
> to:
> setvar:tx.%{tx.critical_anomaly_score}
> 
> Which appears to throw very similar errors. Looking at previous versions of
> this file, it appears to me that the change should be:
> setvar:tx.anomaly_score=+n
> where n is equal to a weight applied to each PHPIDS rule.
> 
> Version 1503 of this file contained the the relative weight of each PHPIDS
> rule. Attached is a modified modsecurity_crs_41_phpids_filters.conf file. 
> I took the scoring levels and pass/block action of version 1503 of this
> file and the actual rules from the 1516 version.
> 
> This version of the file appears to resolve the false-positives caused by
> the recommended changes in the June 20 post, and "plays nice" with the
> correlation rules by not forcing every rule to block or exceed the anomaly
> score (unless that's the intention of the rule).
> 
> I'm open to suggestions and feedback, but I think I've got this issue
> resolved, at least until there's an update to the PHPIDS rules.  There is
> probably still some work to do on the scripts that convert the PHPIDS
> rules into ModSecurity Rules.
> 
> --
> Joshua Gee

From ryan.barnett at breach.com  Tue Jul 20 09:09:32 2010
From: ryan.barnett at breach.com (Ryan Barnett)
Date: Tue, 20 Jul 2010 09:09:32 -0400
Subject: [Owasp-modsecurity-core-rule-set] ModSecurity Happy Hour at Blackhat
Message-ID: <201007200909.32416.ryan.barnett@breach.com>

For anyone is headed to the Blackhat USA conf in Las Vegas next week, I am pleased to 
announce that Trustwave will be hosting a ModSecurity Happy Hour at Ceasar's Palace!  We 
are looking to hold this on Wed, July 28th (first day of Blackhat Briefings) from either 
4-6pm or 5-7pm.

We are trying to gauge the headcount so If you are going to be at Blackhat and you are 
interested in coming to the happy hour, please shoot me a direct email and let me know 
which of the two timeslost works better for you.

See you all next week!

Cheers,
Ryan Barnett


From ryan.barnett at breach.com  Wed Jul 21 12:58:22 2010
From: ryan.barnett at breach.com (Ryan Barnett)
Date: Wed, 21 Jul 2010 12:58:22 -0400
Subject: [Owasp-modsecurity-core-rule-set] ModSecurity Happy Hour at
	Blackhat
In-Reply-To: <201007200909.32416.ryan.barnett@breach.com>
References: <201007200909.32416.ryan.barnett@breach.com>
Message-ID: <201007211258.22530.ryan.barnett@breach.com>

Here is the official info for the ModSecurity Happy Hour -

http://blog.modsecurity.org/2010/07/modsecurity-happy-hour-black-hat-usa.html

Come on by!

-Ryan

On Tuesday 20 July 2010 09:09:32 Ryan Barnett wrote:
> For anyone is headed to the Blackhat USA conf in Las Vegas next week, I am
> pleased to announce that Trustwave will be hosting a ModSecurity Happy
> Hour at Ceasar's Palace!  We are looking to hold this on Wed, July 28th
> (first day of Blackhat Briefings) from either 4-6pm or 5-7pm.
> 
> We are trying to gauge the headcount so If you are going to be at Blackhat
> and you are interested in coming to the happy hour, please shoot me a
> direct email and let me know which of the two timeslost works better for
> you.
> 
> See you all next week!
> 
> Cheers,
> Ryan Barnett
> 
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20100721/94fec9c1/attachment.html 

From securityadmin at hcjb.org  Thu Jul 22 09:23:38 2010
From: securityadmin at hcjb.org (Josh Gee)
Date: Thu, 22 Jul 2010 14:23:38 +0100
Subject: [Owasp-modsecurity-core-rule-set] Another bug in 2.0.7
Message-ID: <4C48465A.1070402@hcjb.org>

I can't seem to understand how, the
modsecurity_crs_21_protocol_anomalies.conf seems to reply 403 Forbidden
if the Accept Header is missing.  The rule that matches falls well below
the anomaly threshold, and yet the 403 error is returned anyway.  I've
enabled the AuditLog, searched the CRS, and I just can't figure out how
this happens. 

The strangest thing is that my DefaultAction for phase:2 is to set
status to 509, not 403, so I'm really confused as to how this behaviour
is happening.

I only discovered this when my podcasts broke.  iTunes (and many other
aggregators) don't send proper Accept Headers, and this rule was
silently throwing them away.

The only thing odd I found about these rules is that they don't have a
pass directive.  Adding this directive seems to make the rule behave as
designed (incrementing the anomaly score, but and allowing the
correlation to the blocking.  Is this the correct fix?

Josh


Here're the relevant rules (as I modified them):

        SecRule &REQUEST_HEADERS:Accept "@eq 0" \
               
"chain,phase:2,rev:'2.0.7',t:none,pass,nolog,auditlog,msg:'Request
Missing an Accept Header',
severity:'2',id:'960015',tag:'PROTOCOL_VIOLATION/MISSING_HEADER',tag:'WASCTC/WASC-21',tag:'OWASP_TOP_10/A7',tag:'PCI/6.5.10'"
                SecRule REQUEST_METHOD "!^OPTIONS$"
"skipAfter:END_ACCEPT_CHECK,t:none,setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.notice_anomaly_score},setvar:tx.protocol_violation_score=+%{tx.notice_anomaly_score},setvar:tx.%{rule.id}-PROTOCOL_VIOLATION/MISSING_HEADER-%{matched_var_name}=%{matched_var}"
        SecRule REQUEST_HEADERS:Accept "^$" \
               
"chain,phase:2,rev:'2.0.7',t:none,pass,nolog,auditlog,msg:'Request Has
an Empty Accept Header',
severity:'2',id:'960021',tag:'PROTOCOL_VIOLATION/MISSING_HEADER'"
                SecRule REQUEST_METHOD "!^OPTIONS$"
"t:none,setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.notice_anomaly_score},setvar:tx.protocol_violation_score=+%{tx.notice_anomaly_score},setvar:tx.%{rule.id}-PROTOCOL_VIOLATION/MISSING_HEADER-%{matched_var_name}=%{matched_var}"


-- 
Joshua Gee
Director of Information Security
------------------------------------------------------------------------
HCJB Global - PO Box 39800 Colorado Springs, CO 80949-9800
Account 110504
------------------------------------------------------------------------

Email: jgee at hcjbtech.org
Phone: UK 1274 721 810
Skype: Gander78

-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20100722/67894330/attachment-0001.html 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: Image001.gif
Type: image/gif
Size: 9180 bytes
Desc: not available
Url : https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20100722/67894330/attachment-0001.gif 

