<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Modsecurity and fail2ban
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Modsecurity%20and%20fail2ban&In-Reply-To=%3C4847D093-8A53-44BE-A8A6-0694227CC0B7%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002558.html">
   <LINK REL="Next"  HREF="002560.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Modsecurity and fail2ban</H1>
    <B>spartantri at gmail.com</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Modsecurity%20and%20fail2ban&In-Reply-To=%3C4847D093-8A53-44BE-A8A6-0694227CC0B7%40gmail.com%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] Modsecurity and fail2ban">spartantri at gmail.com
       </A><BR>
    <I>Wed May  2 18:16:43 UTC 2018</I>
    <P><UL>
        <LI>Previous message: <A HREF="002558.html">[Owasp-modsecurity-core-rule-set] Modsecurity and fail2ban
</A></li>
        <LI>Next message: <A HREF="002560.html">[Owasp-modsecurity-core-rule-set] XML Parsing Question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2559">[ date ]</a>
              <a href="thread.html#2559">[ thread ]</a>
              <a href="subject.html#2559">[ subject ]</a>
              <a href="author.html#2559">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Bill,

It may not be the best idea to ban clients just based into a single log entry, a single failed request that trigger a false positive may cause a lot of issues, for example with some proxies adding cookies with json content which often cause a false positive not because of the client but because of the added cookie.

You may better track client ip in persistent collections to track users which have caused X critical requests to then log that and use that alert instead for blocking with fail to ban.

As for the regex, copy the message from the log and paste it as target string into regex101.com (sanitize it first!) so you can see with colors if you got the match you want.

This assumes you receive direct connections from end users, all clients using NAT (e.g. corporate clients) may look in the logs as a single client and blocking it will block all those clients.

Cheers!

Enviado desde mi iPhone

&gt;<i> El 2 may 2018, a las 12:54, Bill Miller &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">wbmilleriii at comcast.net</A>&gt; escribi&#243;:
</I>&gt;<i> 
</I>&gt;<i> I've attempted to set up fail2ban to ban attackers that trigger modsecurity rules.  But fail2ban is....failing to ban them.  I get plenty of bans based on apache-auth and fakegooglebot rules, but never on modsecurity.
</I>&gt;<i> 
</I>&gt;<i> My original filter in apache-modsecurity.conf looked like this (I believe this was the default)
</I>&gt;<i> 
</I>&gt;<i> failregex = ^%(_apache_error_client)s ModSecurity:  (\[.*?\] )*Access denied with code [45]\d\d.*$
</I>&gt;<i> 
</I>&gt;<i> After noticing that nothing got banned, based on a post in Server Fault I changed it to
</I>&gt;<i> 
</I>&gt;<i> failregex = ^%(_apache_error_client)s .*ModSecurity:  (\[.*?\] )*Access denied with code [45]\d\d.*$
</I>&gt;<i> 
</I>&gt;<i> But still nothing.
</I>&gt;<i> 
</I>&gt;<i> Has anyone tried this, and gotten it to work? (I am pretty ignorant of regex's and have just been looking for a canned solution).
</I>&gt;<i> 
</I>&gt;<i> Thanks in advance.
</I>&gt;<i> 
</I>&gt;<i> Bill
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Owasp-modsecurity-core-rule-set mailing list
</I>&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>
</I>&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set</A>
</I></PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002558.html">[Owasp-modsecurity-core-rule-set] Modsecurity and fail2ban
</A></li>
	<LI>Next message: <A HREF="002560.html">[Owasp-modsecurity-core-rule-set] XML Parsing Question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2559">[ date ]</a>
              <a href="thread.html#2559">[ thread ]</a>
              <a href="subject.html#2559">[ subject ]</a>
              <a href="author.html#2559">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
