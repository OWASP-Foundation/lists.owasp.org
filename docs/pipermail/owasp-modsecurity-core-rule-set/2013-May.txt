From amber at creativecollab.co  Tue May  7 07:17:38 2013
From: amber at creativecollab.co (Amber)
Date: Tue, 7 May 2013 01:17:38 -0600
Subject: [Owasp-modsecurity-core-rule-set] CRS Installation Confusion
Message-ID: <000001ce4af2$f53fe730$dfbfb590$@creativecollab.co>

The server in question is a cPanel server.  ModSecurity is installed (via
EasyApache) and it is using default cPanel rules for mod_security; which are
found via WHM>Plugins>Mod Security Edit Config tool and correlate to the
file modsec2.user.conf

 

I installed the core ruleset (all subfolders/files such as base_rules,
activated_rules, etc) distributed by OWASP to
/usr/local/apache/conf/modsec_crs/

I copied the modsecurity_crs_10_setup.conf.example to
modsecurity_crs_10_setup.conf.



However I'm now a bit confused by what appears to be the lack of clear
instructions.

It says to create the symlinks then to add the following to
/etc/httpd/conf/httpd.conf or in my case usr/local/apache/conf/httpd.conf (I
think):



Code (changed from conf/crs to conf/modsec_crs):

 

<IfModule security2_module>

    Include conf/modsec_crs/modsecurity_crs_10_setup.conf

    Include conf/modsec_crs/activated_rules/*.conf

</IfModule>

 

Finish by restarting Apache.

 

However, what about the original default cPanel rules that are found in the
modsec2.user.conf file?  Should all the entries in there be deleted.  If I
don't do anything about that file will the rules in it conflict with these
OWASP rules?  Should the contents of the modsecurity_crs_10_setup.conf be
instead copied into the modsec2.user.conf file?

 

The reason for asking is that I was reading the following and it seemed
quite a bit different than the OWASP install instructions (mind you it
references the Atomicorp rules) but they use the modsec2.user.conf:
http://www.webhostingtalk.com/showpost.php?p=8368162
<http://www.webhostingtalk.com/showpost.php?p=8368162&postcount=8>
&postcount=8.  I've also seen reference to using a similar method for the
GotRoot rules: http://puntapirata.com/How-to-Install-ModSec-Rules.php

After restarting Apache how can we check if the rules are in effect?  There
isn't a SecRuleEngine in the crs_10 config but it is ON in the mod_sec
config file.  Will there be any indication in WHM that the rules are in
effect?

 

Additionally since I had to create the modsec_rules folder do I need to set
any permissions on that folder?

 

Any help would be appreciated.
Thanks.

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20130507/c83aef1e/attachment.html>

From darknovanick at gmail.com  Tue May  7 17:36:47 2013
From: darknovanick at gmail.com (Nick)
Date: Tue, 7 May 2013 12:36:47 -0500
Subject: [Owasp-modsecurity-core-rule-set] DoS Protection Problem
In-Reply-To: <CA+Qch=Lw-jPOh2UROW_8249iOxrSWFVB7EfY+f8ZO5-iDf4nVQ@mail.gmail.com>
References: <CA+Qch=Lw-jPOh2UROW_8249iOxrSWFVB7EfY+f8ZO5-iDf4nVQ@mail.gmail.com>
Message-ID: <CA+Qch=KfhTV==vMEooj20ty4x+56yKBVGQtLbZFH8Kv=oiw_fQ@mail.gmail.com>

I've been experimenting with this modsecurity_crs_11_dos_protection.conf
ruleset more. An outline of how it seems to work:

- Every non-image request increments the ip.dos_counter counter.
- If that counter is > tx.dos_counter_threshold, it increments
ip.dos_burst_counter, sets an expiration time on ip.dos_burst_counter, and
clears ip.dos_counter
- If ip.dos_burst_counter > ip.dos_burst_threshold, it blocks the request
until tx.dos_block_timeout seconds elapses

The rational behind the burst counter seems to be because mod_security
expiration doesn't work based on the FIRST write to a variable, it works
based on the most recent write. In my case, I'm using a time slice of 60
seconds, but if a bot requests a page every 10 seconds for hours it will
never expire ip_dos_counter, the only time that will happen is if they
don't do any requests for 60 seconds. So, this burst counter is designed to
try to get around this problem by waiting until the dos_counter is over the
threshold (which doesn't really prove anything about how fast requests were
being made, only that the user has done a bunch of requests without
pausing) and then it increments the burst counter which has an expiration
time (in my case, 60 seconds) and clears out the dos_counter. So, if the
dos counter gets up to the threshold AGAIN, then it knows that those
requests really all have come in the past 60 seconds, so it knows that the
user is requesting too quickly.

Great in theory, but this is broken.

The problem scenario:

- A bot (bingbot in my case) has been requesting pages for the past hour.
Averaging one or two requests per second. Nothing to worry about.
- The dos_counter is over the threshold because it has been submitting
requests for a long time without pausing
- Sometimes it submits 2-4 requests virtually simultaneously (on the same
second in the log)
- It submits 2 or more requests simultaneously. For EACH REQUEST,
mod_security sees that ip_dos_counter is over the threshold, so each
request increments ip_dos_burst_counter. bingbot is now blocked.

So this is an example where the bot was blocked even though it was
operating at a far slower rate than the DoS settings specify. If those 2
requests would have been spaced apart by a second, it would not have been
blocked. But, by submitting requests very close together, a bot can be
blocked without really submitting that many requests very quickly. This is
happening on my server at least every day.

I am new to mod_security so I'm still learning exactly how these rules
work, but are there any solutions to this problem? The way this rule is set
up, it seems to be operating on the principle that the rule is atomic when
it clearly isn't. If dos_counter would be cleared before the burst counter
is incremented, this problem wouldn't exist.

I'm also unclear on how this is coordinated across the multiple apache
processes. I understand this to be a collection, which resides on disk, so
I'm not sure when mod_security writes this information to disk.

Does anyone have any pointers for where to look, or a different DoS ruleset
to try?

Or is DoS protection not something that is possible with mod_security, and
I need another module? I don't need anything fancy, I just want to be able
to limit an IP address to a certain number of requests within a time
period. Thanks,

Nick


On Mon, Apr 29, 2013 at 12:49 PM, Nick <darknovanick at gmail.com> wrote:

> Hello,
>
> I've been setting up mod_security and enabled
> the modsecurity_crs_11_dos_protection.conf rule. This is mod_security 2.6.8
> and CRS version 2.2.5.
>
> I have initialized the settings with:
> SecAction \
>   "id:'900015', \
>   phase:1, \
>   t:none, \
>   setvar:'tx.dos_burst_time_slice=60', \
>   setvar:'tx.dos_counter_threshold=300', \
>   setvar:'tx.dos_block_timeout=600', \
>   nolog, \
>   pass"
>
> This works and it is blocking some very aggressive bots the way it should.
> But there is a problem. I have occasionally been getting lines like this in
> the log:
>
> Warning. Operator GE matched 2 at IP:dos_burst_counter. [file
> "/etc/httpd/modsecurity.d/activated_rules/modsecurity_crs_11_dos_protection.conf"]
> [line "44"] [id "981049"] [msg "Potential Denial of Service (DoS) Attack
> from 65.55.24.236 - # of Request Bursts: 3"]
>
> This bot was actually bingbot. I am new to mod_security, but my
> understanding of my settings is that it shouldn't block until a bot has
> requested 300 pages in 60 seconds.
>
> When I check the logs I see that IP 65.55.24.236 has requested 313 pages
> in 1 hour. In the 60 seconds before the DoS block happening, this IP only
> requested 6 pages. This block obviously shouldn't be happening.
>
> I am grossly misunderstanding something, or what can I do to fix this?
> Thanks,
>
> Nick
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20130507/a8a5ea37/attachment.html>

From huynhnhatvu1992 at gmail.com  Tue May  7 18:08:14 2013
From: huynhnhatvu1992 at gmail.com (Vu Huynh)
Date: Wed, 8 May 2013 01:08:14 +0700
Subject: [Owasp-modsecurity-core-rule-set] Could you please help me check
	this
Message-ID: <CABjXspC=DGjeAUcdQRJ96FsZicQ4vYO8V9Ok4tS+XVPQMh-9Lw@mail.gmail.com>

Dear Admin Owasp.org

My name's Vu I had install ModSecurity on my VPS but when I test it don't
run could you please help me check this

This is step that I install:
First I dowload modsecurity and install it:

wget
http://www.modsecurity.org/tarball/2.7.3/modsecurity-apache_2.7.3.tar.gz
tar -xzvf modsecurity-apache_2.7.3.tar.gz
cd modsecurity-apache_2.7.3
./configure
make make install

then I dowload OWASP Mod_Security Core Rule Set from here:
https://codeload.github.com/SpiderLabs/owasp-modsecurity-crs/zip/master
I unzip "owasp-modsecurity-crs-master.zip"
Rename folder "owasp-modsecurity-crs-master" to "modsecurity-crs"
Rename "modsecurity-crs/modsecurity_crs_10_setup.conf.example" to
"modsecurity-crs/modsecurity_crs_10_setup.conf"
Upload folder "modsecurity-crs" to /etc/httpd

then I load it by copy this:

<IfModule security2_module>
LoadFile /usr/local/lib/libxml2.so
LoadFile /usr/local/lib/liblua5.1.so
LoadModule security2_module /usr/local/lib/mod_security2.so
Include /etc/httpd/conf/modsecurity.conf
    Include /etc/httpd/modsecurity-crs/modsecurity_crs_10_config.conf
    Include /etc/httpd/modsecurity-crs/base_rules/*.conf
</IfModule>

to the end of /etc/httpd/conf/httpd.conf
and restart httpd by command: service httpd restart

I had installed:
"mod_uniqueid"
"libapr and libapr-util"
"libpcre"
"libxml2"
"liblua v5.1"

the last I test it by add this:

<IfModule security2_module>

# Bat che do loc cua Modsecurity
SecRuleEngine On
# Thiet lap action mac dinh
SecDefaultAction "phase:2,deny,log,status:404"

# rule thu nghiem block tat ca request co uri chua "hacker"
SecRule REQUEST_URI "hacker"

</IfModule>

to the end of /etc/httpd/conf/modsecurity.conf
and restart httpd
I access to http://cuviver.com/hacker.html it load code normal it don't
return to 404 not found
can you help me check the step install is that true?
I use centos 6 64bit with Directadmin Control
I had attached http.config and modsecurity.conf
I'm looking forward to hearing from you soon

Thanks and Best Regards
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20130508/b53492a9/attachment.html>

From michael.haas10 at gmail.com  Tue May  7 20:56:17 2013
From: michael.haas10 at gmail.com (Michael Haas)
Date: Tue, 7 May 2013 22:56:17 +0200
Subject: [Owasp-modsecurity-core-rule-set] Could you please help me
	check this
In-Reply-To: <CABjXspC=DGjeAUcdQRJ96FsZicQ4vYO8V9Ok4tS+XVPQMh-9Lw@mail.gmail.com>
References: <CABjXspC=DGjeAUcdQRJ96FsZicQ4vYO8V9Ok4tS+XVPQMh-9Lw@mail.gmail.com>
Message-ID: <CAFW5hxCiVm0Q=CoMDWXMPejrG1Ct2u5sX=RTvZGu45Ye+Ua6Yg@mail.gmail.com>

Do you see in the error log that mod_security is started?
You load the mod_security module in an ifmodule which checks if the module
is loaded i don't think that's possible.


2013/5/7 Vu Huynh <huynhnhatvu1992 at gmail.com>

> Dear Admin Owasp.org
>
> My name's Vu I had install ModSecurity on my VPS but when I test it don't
> run could you please help me check this
>
> This is step that I install:
> First I dowload modsecurity and install it:
>
> wget
> http://www.modsecurity.org/tarball/2.7.3/modsecurity-apache_2.7.3.tar.gz
> tar -xzvf modsecurity-apache_2.7.3.tar.gz
> cd modsecurity-apache_2.7.3
> ./configure
> make make install
>
> then I dowload OWASP Mod_Security Core Rule Set from here:
> https://codeload.github.com/SpiderLabs/owasp-modsecurity-crs/zip/master
> I unzip "owasp-modsecurity-crs-master.zip"
> Rename folder "owasp-modsecurity-crs-master" to "modsecurity-crs"
> Rename "modsecurity-crs/modsecurity_crs_10_setup.conf.example" to
> "modsecurity-crs/modsecurity_crs_10_setup.conf"
> Upload folder "modsecurity-crs" to /etc/httpd
>
> then I load it by copy this:
>
> <IfModule security2_module>
> LoadFile /usr/local/lib/libxml2.so
> LoadFile /usr/local/lib/liblua5.1.so
>  LoadModule security2_module /usr/local/lib/mod_security2.so
> Include /etc/httpd/conf/modsecurity.conf
>     Include /etc/httpd/modsecurity-crs/modsecurity_crs_10_config.conf
>     Include /etc/httpd/modsecurity-crs/base_rules/*.conf
> </IfModule>
>
> to the end of /etc/httpd/conf/httpd.conf
> and restart httpd by command: service httpd restart
>
> I had installed:
> "mod_uniqueid"
> "libapr and libapr-util"
> "libpcre"
> "libxml2"
> "liblua v5.1"
>
> the last I test it by add this:
>
> <IfModule security2_module>
>
> # Bat che do loc cua Modsecurity
> SecRuleEngine On
> # Thiet lap action mac dinh
> SecDefaultAction "phase:2,deny,log,status:404"
>
> # rule thu nghiem block tat ca request co uri chua "hacker"
> SecRule REQUEST_URI "hacker"
>
> </IfModule>
>
> to the end of /etc/httpd/conf/modsecurity.conf
> and restart httpd
> I access to http://cuviver.com/hacker.html it load code normal it don't
> return to 404 not found
> can you help me check the step install is that true?
> I use centos 6 64bit with Directadmin Control
> I had attached http.config and modsecurity.conf
> I'm looking forward to hearing from you soon
>
> Thanks and Best Regards
>
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20130507/6436521e/attachment-0001.html>

From jamuse at owasp.org  Mon May 13 13:01:44 2013
From: jamuse at owasp.org (Josh Amishav-Zlatin)
Date: Mon, 13 May 2013 16:01:44 +0300
Subject: [Owasp-modsecurity-core-rule-set] ModSecurity Training
Message-ID: <CAC+O4mH_92D7QKZVKPPn2FWyr6xyYbmwd4f9Tj0kzSJq=bCJ4A@mail.gmail.com>

Hi everyone,

Just a reminder that there are two weeks left to sign up for the upcoming
ModSecurity training at BlackHat Vegas this summer at the regular rate:
http://www.blackhat.com/us-13/training/tactical-defense-with-modSecurity.html

The class is focused on managing ModSecurity with a strong emphasis on web
app defense skills.

Hope to see you there!

--
 - Josh
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20130513/a82c1b03/attachment.html>

From john at lynch2.com  Thu May 23 21:01:23 2013
From: john at lynch2.com (John McGowan)
Date: Thu, 23 May 2013 16:01:23 -0500
Subject: [Owasp-modsecurity-core-rule-set] best practice for managing crs
	customizations in a multiserver environment
Message-ID: <CAAr79n7-t5=LY4-OKHNc-Ko6fgUpLUmgeh-Hn2uDS3ZSgA7yfQ@mail.gmail.com>

I'm running an application with mod_security as a host based firewall.
 I've successfully gotten the CRS installed and have come across my
first false positive that I now need to handle.  I have a couple
hurdles to deal with if I'm going to be making changes to the CRS to
deal with any false positives I run into.  The first issue, is that I
of course want to be able to easily update CRS in the future, so I'm
concerned about making changes to the CRS files that may conflict with
future updates.  The second is that my application runs on a scalable
array of servers, so changing the files on one server isn't really an
option anyway.

ideally I'd like to have a file of "exceptions" installed on each
server when the server starts up,  that is loaded in addition to all
the default rules, without having to modify those files.  Then all I
have to do is manage the script that creates that exception file.

Is this technique possible with mod_security + crs?



/John

From john at lynch2.com  Thu May 23 21:21:29 2013
From: john at lynch2.com (John McGowan)
Date: Thu, 23 May 2013 16:21:29 -0500
Subject: [Owasp-modsecurity-core-rule-set] best practice for managing
 crs customizations in a multiserver environment
In-Reply-To: <CAAr79n7-t5=LY4-OKHNc-Ko6fgUpLUmgeh-Hn2uDS3ZSgA7yfQ@mail.gmail.com>
References: <CAAr79n7-t5=LY4-OKHNc-Ko6fgUpLUmgeh-Hn2uDS3ZSgA7yfQ@mail.gmail.com>
Message-ID: <CAAr79n5dSq-8xT3UL=XM_CndXDXVGxg6HzZMFoFZRcjd7piwWQ@mail.gmail.com>

I apologize for the quick post to the mailing list.

I found this blog posting, and I'm going through it now.  :)

http://blog.spiderlabs.com/2011/08/modsecurity-advanced-topic-of-the-week-exception-handling.html

On Thu, May 23, 2013 at 4:10 PM, John McGowan <john at lynch2.com> wrote:
> I'm running an application with mod_security as a host based firewall.
>  I've successfully gotten the CRS installed and have come across my
> first false positive that I now need to handle.  I have a couple
> hurdles to deal with if I'm going to be making changes to the CRS to
> deal with any false positives I run into.  The first issue, is that I
> of course want to be able to easily update CRS in the future, so I'm
> concerned about making changes to the CRS files that may conflict with
> future updates.  The second is that my application runs on a scalable
> array of servers, so changing the files on one server isn't really an
> option anyway.
>
> ideally I'd like to have a file of "exceptions" installed on each
> server when the server starts up,  that is loaded in addition to all
> the default rules, without having to modify those files.  Then all I
> have to do is manage the script that creates that exception file.
>
> Is this technique possible with mod_security + crs?
>
>
>
> /John
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set



-- 
John McGowan

Lynch2
792 West Bartlett Road
Bartlett, Illinois 60103

www.lynch2.com
w:847-608-6900 Ext 4110

From one2net at gmail.com  Thu May 30 14:52:42 2013
From: one2net at gmail.com (ONE2NET)
Date: Thu, 30 May 2013 16:52:42 +0200
Subject: [Owasp-modsecurity-core-rule-set] ModSecurity:
	collections_remove_stale: Failed deleting collection
Message-ID: <CAD+qZx7w96bd2gHuhdeWPUCemnNYfK9GV-XDQ7fXgEXd5WpD3w@mail.gmail.com>

Hello

Looking at our error_log, I noticed several entries with the following
alert log:

"ModSecurity: collections_remove_stale: Failed deleting collection"

Anyone could advise about the meaning of the above and how to avoid such errors?

Thanks a lot

Pierre

