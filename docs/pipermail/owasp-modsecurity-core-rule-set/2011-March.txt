From RBarnett at trustwave.com  Wed Mar  2 08:26:06 2011
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Wed, 2 Mar 2011 07:26:06 -0600
Subject: [Owasp-modsecurity-core-rule-set] [mod-security-users]
 Announcing Release of OWASP ModSecurity CRS v2.1.2
In-Reply-To: <C98302B1.1A1AD%rbarnett@trustwave.com>
Message-ID: <C993AF7D.1B2C9%rbarnett@trustwave.com>

Has anyone had a chance to try out the new profiling rules?  I am
interested to hear feedback.

-Ryan



On 2/17/11 4:52 PM, "Ryan Barnett" <RBarnett at trustwave.com> wrote:

>Hello everyone,
>I am pleased to announce the release of the OWASP ModSecurity Core Rule
>Set (CRS) v2.1.2.  This is a significant update as we have added a couple
>very important capabilities.
>
>CHANGE LOG -
>--------------------------
>Version 2.1.2 - 02/17/2011
>--------------------------
>
>Improvements:
>- Added experimental real-time application profiling ruleset.
>- Added experimental Lua script for profiling the # of page scripts,
>iframes, etc..
>  which will help to identify successful XSS attacks and planting of
>malware links.
>- Added new CSRF detection rule which will trigger if a subsequent
>request comes too
>  quickly (need to use the Ignore Static Content rules).
>
>Bug Fixes:
>- Added missing " in the skipAfter SecAction in the CC Detection rule set
>
>--------------------------
>DOWNLOADING
>--------------------------
>Manual Downloading:
>You can always download the latest CRS version here -
>https://sourceforge.net/projects/mod-security/files/modsecurity-crs/0-CURR
>ENT/
>
>Automated Downloading:
>Use the rules-updater.pl script in the CRS /util directory
>
># Get a list of what the repository contains:
>$ ./rules-updater.pl -rhttp://www.modsecurity.org/autoupdate/repository/
>-l
>
>Repository: http://www.modsecurity.org/autoupdate/repository
>
>modsecurity-crs {
>          2.0.0: modsecurity-crs_2.0.0.zip
>          2.0.1: modsecurity-crs_2.0.1.zip
>          2.0.2: modsecurity-crs_2.0.2.zip
>          2.0.3: modsecurity-crs_2.0.3.zip
>          2.0.4: modsecurity-crs_2.0.4.zip
>          2.0.5: modsecurity-crs_2.0.5.zip
>          2.0.6: modsecurity-crs_2.0.6.zip
>          2.0.7: modsecurity-crs_2.0.7.zip
>          2.0.8: modsecurity-crs_2.0.8.zip
>          2.0.9: modsecurity-crs_2.0.9.zip
>          2.0.9: modsecurity-crs_2.0.10.zip
>          2.1.0: modsecurity-crs_2.1.0.zip
>          2.1.1: modsecurity-crs_2.1.1.zip
>          2.1.2: modsecurity-crs_2.1.2.zip
>}
>
># Get the latest stable version of "modsecurity-crs":
>$ ./rules-updater.pl -rhttp://www.modsecurity.org/autoupdate/repository/
>-prules -Smodsecurity-crs
>Fetching: modsecurity-crs/modsecurity-crs_2.1.2.zip ...
>$ ls -R rules
>modsecurity-crs
>
>rules/modsecurity-crs:
>modsecurity-crs_2.1.2.zip    modsecurity-crs_2.1.2.zip.sig
>
>--
>Ryan Barnett
>Senior Security Researcher
>Trustwave - SpiderLabs
>
>________________________________
>This transmission may contain information that is privileged,
>confidential, and/or exempt from disclosure under applicable law. If you
>are not the intended recipient, you are hereby notified that any
>disclosure, copying, distribution, or use of the information contained
>herein (including any reliance thereon) is STRICTLY PROHIBITED. If you
>received this transmission in error, please immediately contact the
>sender and destroy the material in its entirety, whether in electronic or
>hard copy format.
>
>
>--------------------------------------------------------------------------
>----
>The ultimate all-in-one performance toolkit: Intel(R) Parallel Studio XE:
>Pinpoint memory and threading errors before they happen.
>Find and fix more than 250 security defects in the development cycle.
>Locate bottlenecks in serial and parallel code that limit performance.
>http://p.sf.net/sfu/intel-dev2devfeb
>_______________________________________________
>mod-security-users mailing list
>mod-security-users at lists.sourceforge.net
>https://lists.sourceforge.net/lists/listinfo/mod-security-users
>Commercial ModSecurity Appliances, Rule Sets and Support:
>http://www.modsecurity.org/breach/index.html
>



From rbarnett at trustwave.com  Wed Mar  2 14:13:07 2011
From: rbarnett at trustwave.com (Ryan Barnett (JIRA))
Date: Wed, 2 Mar 2011 13:13:07 -0600 (CST)
Subject: [Owasp-modsecurity-core-rule-set] [JIRA] Resolved: (CORERULES-45)
 Hard coded anomaly scores in modsecurity_crs_41_phpids_filters.conf
Message-ID: <8452705.169.1299093187981.JavaMail.root@modsec-apps.colo.breach.com>


     [ https://www.modsecurity.org/tracker/browse/CORERULES-45?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel ]

Ryan Barnett resolved CORERULES-45.
-----------------------------------

    Resolution: Won't Fix

The advanced filters file (which is the converted PHPIDS filters) is using hard coded anomaly score values as the PHPIDS team has good weighting for their scores for severity.  The macro expanded anomaly scores in the 10 config file have been changed so that the numbers are on a more similar scale as the PHPIDS rules.

> Hard coded anomaly scores in modsecurity_crs_41_phpids_filters.conf
> -------------------------------------------------------------------
>
>                 Key: CORERULES-45
>                 URL: https://www.modsecurity.org/tracker/browse/CORERULES-45
>             Project: Core Rules
>          Issue Type: Improvement
>      Security Level: Normal
>    Affects Versions: 2.0.6
>         Environment: All
>            Reporter: Thomas
>            Assignee: Ryan Barnett
>
> In modsecurity_crs_41_phpids_filters.conf tx.anomaly_score values are incremented by hard coded values, bypassing "Anomaly Scoring Severity Levels" in modsecurity_crs_10_config.conf

-- 
This message is automatically generated by JIRA.
-
If you think it was sent incorrectly contact one of the administrators: https://www.modsecurity.org/tracker/secure/Administrators.jspa
-
For more information on JIRA, see: http://www.atlassian.com/software/jira

        


From rbarnett at trustwave.com  Wed Mar  2 14:25:07 2011
From: rbarnett at trustwave.com (Ryan Barnett (JIRA))
Date: Wed, 2 Mar 2011 13:25:07 -0600 (CST)
Subject: [Owasp-modsecurity-core-rule-set] [JIRA] Resolved: (CORERULES-52)
	JIRA Bug
Message-ID: <5895249.203.1299093907523.JavaMail.root@modsec-apps.colo.breach.com>


     [ https://www.modsecurity.org/tracker/browse/CORERULES-52?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel ]

Ryan Barnett resolved CORERULES-52.
-----------------------------------

    Resolution: Fixed

Should be fixed now - we had to change the Security Level setting on default tickets to be "Normal" vs "New" which will cause the ticket to be viewed only by Admins.

> JIRA Bug
> --------
>
>                 Key: CORERULES-52
>                 URL: https://www.modsecurity.org/tracker/browse/CORERULES-52
>             Project: Core Rules
>          Issue Type: Bug
>      Security Level: Normal
>            Reporter: Nebojsa Simic
>            Assignee: Ryan Barnett
>            Priority: Low
>
> Ryan Barnett resolved CORERULES-49 as a duplicate from https://www.modsecurity.org/tracker/browse/CORERULES-48, when I try to look at the given URL I get:
> PERMISSION VIOLATION
> It seems that you have tried to perform an operation which you are not permitted to perform.
> If you think this message is wrong, please consult your administrators about getting the necessary permissions. 
> The link to administrators shows no contact data.

-- 
This message is automatically generated by JIRA.
-
If you think it was sent incorrectly contact one of the administrators: https://www.modsecurity.org/tracker/secure/Administrators.jspa
-
For more information on JIRA, see: http://www.atlassian.com/software/jira

        


From rbarnett at trustwave.com  Wed Mar  2 14:25:10 2011
From: rbarnett at trustwave.com (Ryan Barnett (JIRA))
Date: Wed, 2 Mar 2011 13:25:10 -0600 (CST)
Subject: [Owasp-modsecurity-core-rule-set] [JIRA] Resolved: (CORERULES-48)
	bug in setting anomaly value
Message-ID: <18994843.236.1299093910722.JavaMail.root@modsec-apps.colo.breach.com>


     [ https://www.modsecurity.org/tracker/browse/CORERULES-48?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel ]

Ryan Barnett resolved CORERULES-48.
-----------------------------------

    Resolution: Fixed

> bug in setting anomaly value
> ----------------------------
>
>                 Key: CORERULES-48
>                 URL: https://www.modsecurity.org/tracker/browse/CORERULES-48
>             Project: Core Rules
>          Issue Type: Bug
>      Security Level: Normal
>          Components: Configuration
>    Affects Versions: 2.0.7
>         Environment: CentOS 5.5, httpd-2.2.3-43.el5.centos, mod_security-2.5.12-1.el5, CRS 2.0.7
>            Reporter: brian roller
>            Assignee: Ryan Barnett
>
> Most (if not all) of the rules in modsecurity_crs_41_phpids_filters.conf appear to be attempting to modify the anomaly score with "setvar:%{tx.critical_anomaly_score}".  Presumably this should be something like "setvar:tx.anomaly_score=+%{tx.critical_anomaly_score}"?

-- 
This message is automatically generated by JIRA.
-
If you think it was sent incorrectly contact one of the administrators: https://www.modsecurity.org/tracker/secure/Administrators.jspa
-
For more information on JIRA, see: http://www.atlassian.com/software/jira

        


From rbarnett at trustwave.com  Wed Mar  2 14:35:08 2011
From: rbarnett at trustwave.com (Ryan Barnett (JIRA))
Date: Wed, 2 Mar 2011 13:35:08 -0600 (CST)
Subject: [Owasp-modsecurity-core-rule-set] [JIRA] Resolved: (CORERULES-64)
 Add "Toata dragostea" scanner to modsecurity_35_bad_robots.data file
Message-ID: <399588.260.1299094508115.JavaMail.root@modsec-apps.colo.breach.com>


     [ https://www.modsecurity.org/tracker/browse/CORERULES-64?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel ]

Ryan Barnett resolved CORERULES-64.
-----------------------------------

    Resolution: Fixed

Added to CRS v2.1.3

> Add "Toata dragostea" scanner to modsecurity_35_bad_robots.data file
> --------------------------------------------------------------------
>
>                 Key: CORERULES-64
>                 URL: https://www.modsecurity.org/tracker/browse/CORERULES-64
>             Project: Core Rules
>          Issue Type: New Feature
>      Security Level: Normal
>            Reporter: Jamuse
>            Assignee: Ryan Barnett
>
> Can you add the following User-Agent string to modsecurity_35_bad_robots.data:
> Toata dragostea mea pentru diavola

-- 
This message is automatically generated by JIRA.
-
If you think it was sent incorrectly contact one of the administrators: https://www.modsecurity.org/tracker/secure/Administrators.jspa
-
For more information on JIRA, see: http://www.atlassian.com/software/jira

        


From rbarnett at trustwave.com  Wed Mar  2 14:39:07 2011
From: rbarnett at trustwave.com (Ryan Barnett (JIRA))
Date: Wed, 2 Mar 2011 13:39:07 -0600 (CST)
Subject: [Owasp-modsecurity-core-rule-set] [JIRA] Resolved: (CORERULES-65)
 SVN repository (rev 1571) duplicate file name causes checkout problem on
 Windows platform
Message-ID: <7757066.284.1299094747651.JavaMail.root@modsec-apps.colo.breach.com>


     [ https://www.modsecurity.org/tracker/browse/CORERULES-65?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel ]

Ryan Barnett resolved CORERULES-65.
-----------------------------------

    Resolution: Fixed

Removed runAV.pl from SVN

> SVN repository (rev 1571) duplicate file name causes checkout problem on Windows platform
> -----------------------------------------------------------------------------------------
>
>                 Key: CORERULES-65
>                 URL: https://www.modsecurity.org/tracker/browse/CORERULES-65
>             Project: Core Rules
>          Issue Type: Bug
>      Security Level: Normal
>    Affects Versions: 2.0.6
>         Environment: Windows (all)
>            Reporter: Thomas
>            Assignee: Ryan Barnett
>
> https://mod-security.svn.sourceforge.net/svnroot/mod-security/crs/trunk/util/ contains runav.pl and runAV.pl which causes checkout proplems on Windows platforms

-- 
This message is automatically generated by JIRA.
-
If you think it was sent incorrectly contact one of the administrators: https://www.modsecurity.org/tracker/secure/Administrators.jspa
-
For more information on JIRA, see: http://www.atlassian.com/software/jira

        


From mcm8 at cdc.gov  Tue Mar  8 14:59:08 2011
From: mcm8 at cdc.gov (Mirabito, Massimo (Max) (CDC/OID/OD) (CTR))
Date: Tue, 8 Mar 2011 19:59:08 +0000
Subject: [Owasp-modsecurity-core-rule-set] Rule Set is being violated on
 modsecurity_crs_41_phpids_converter.conf line 70
In-Reply-To: <4ACE4D561D68644483BFF6D8FF278BC90677D1@EMBX-CHAM4.cdc.gov>
References: <4ACE4D561D68644483BFF6D8FF278BC906779B@EMBX-CHAM4.cdc.gov>
	<4ACE4D561D68644483BFF6D8FF278BC90677D1@EMBX-CHAM4.cdc.gov>
Message-ID: <4ACE4D561D68644483BFF6D8FF278BC90677FE@EMBX-CHAM4.cdc.gov>

Dear All

We are having difficulty with one of our applications as it appears that mod_security is blocking some of the content thinking that it is a vulnerability.
We are running Apache version 2.2 with mod_security version 2.05


The url that is giving us problems is as follows:
https://myserver.com/MYAPP/nt/chart/run.do?t=tcg&m=cot/trend&f=png&r=3&y=2005+to+2009&d=labels_x:[2005,2006,2007,2008,2009,-8.88888888E8,2015];tlabels_x:[2005,2006,2007,2008,2009];g:[[89.690721649,86.746987952,91.946308725,90,85.135135135,-8.88888888E8,null],[90,85,87,89,90,-8.88888888E8,null],[83.209136562,83.894290701,84.484373669,81.189229619,64.743991641,-8.88888888E8,null],[null,null,null,null,null,-8.88888888E8,93]];t:[[194,166,149,150,148],[184,155,144,141,130],[174,144,137,135,126],[10,11,5,9,18]]&c=0+0+0+0+1&rid=1<https://myserver.com/MYAPP/nt/chart/run.do?t=tcg&m=cot/trend&f=png&r=3&y=2005+to+2009&d=labels_x:%5b2005,2006,2007,2008,2009,-8.88888888E8,2015%5d;tlabels_x:%5b2005,2006,2007,2008,2009%5d;g:%5b%5b89.690721649,86.746987952,91.946308725,90,85.135135135,-8.88888888E8,null%5d,%5b90,85,87,89,90,-8.88888888E8,null%5d,%5b83.209136562,83.894290701,84.484373669,81.189229619,64.743991641,-8.88888888E8,null%5d,%5bnull,null,null,null,null,-8.88888888E8,93%5d%5d;t:%5b%5b194,166,149,150,148%5d,%5b184,155,144,141,130%5d,%5b174,144,137,135,126%5d,%5b10,11,5,9,18%5d%5d&c=0+0+0+0+1&rid=1>

The peculiar thing is that a similar url runs properly, see below
https:// myserver.com/MYAPP/nt/chart/run.do? t=pct&m=cot/outcomes&f=png&r=3&y=2009&d=p:[[148,100],[126,85.135135135],[4,2.7027027027],[0,0],[2,1.3513513514],[1,0.6756756757],[15,10.135135135]]&&rid=1

The logs show the following rule being violated:
Message: Pattern match "(?:[\d+-=\/\* ]+(?:\s?,\s?[\d+-=\/\* ]+)){4,}" at ARGS:d. [file "C:/Apache2.2/conf/mod_security/base_rules/modsecurity_crs_41_phpids_converter.conf"] [line "70"] [id "973016"] [msg "Basic Charcode Pattern Found"] [data "2005,2006,2007,2008,2009,-8.88888888e3"]

The rule in question is located in modsecurity_crs_41_phpids_converter.conf  - line 70
SecRule ARGS|ARGS_NAMES|XML:/* "(?:[\d+-=\/\* ]+(?:\s?,\s?[\d+-=\/\* ]+)){4,}" "skip:1,phase:2,capture,t:none,t:urlDecodeUni,t:htmlEntityDecode,t:compressWhiteSpace,t:lowercase,ctl:auditLogParts=+E,pass,nolog,auditlog,msg:'Basic Charcode Pattern Found',id:'973016',tag:'WEB_ATTACK/EVASION',logdata:'%{TX.0}',severity:'4',setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.warning_anomaly_score},setvar:tx.%{rule.id}-WEB_ATTACK/EVASION-%{matched_var_name}=%{tx.0}"

My coworker discovered that if we modify a portion of the rule then we are able to run the application properly. In particular if we modify {4} to {10}  then things begin working
SecRule ARGS|ARGS_NAMES|XML:/* "(?:[\d+-=\/\* ]+(?:\s?,\s?[\d+-=\/\* ]+)){4,}" ...... TO ....... SecRule ARGS|ARGS_NAMES|XML:/* "(?:[\d+-=\/\* ]+(?:\s?,\s?[\d+-=\/\* ]+)){10,}"

We are concerned that by making this change we either inadvertently make our security weaker or break other things. So we are wondering if the rule has an inherit problem and is there a way to either resolve it or by pass it or any other best practice.


Any feedback is greatly appreciated

Thanks,

Max







-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20110308/0c278901/attachment.html 

From adtantan at paydq.com  Tue Mar  8 15:18:57 2011
From: adtantan at paydq.com (Abdellah Tantan)
Date: Tue, 8 Mar 2011 14:18:57 -0600
Subject: [Owasp-modsecurity-core-rule-set] modsecurity logs managment tool
In-Reply-To: <4ACE4D561D68644483BFF6D8FF278BC90677FE@EMBX-CHAM4.cdc.gov>
References: <4ACE4D561D68644483BFF6D8FF278BC906779B@EMBX-CHAM4.cdc.gov>	<4ACE4D561D68644483BFF6D8FF278BC90677D1@EMBX-CHAM4.cdc.gov>
	<4ACE4D561D68644483BFF6D8FF278BC90677FE@EMBX-CHAM4.cdc.gov>
Message-ID: <013601cbddce$0f03a650$2d0af2f0$@com>

I am not sure if this is the right mailing list for these questions. 

 

What's the best tool to manage modsecurity logs? Keeping in mind that
performance is a concern. 

 

Is there any good article of how to configure  modsecurity for better
performance?

 

Thanks

 

Abdellah

 

 

From: owasp-modsecurity-core-rule-set-bounces at lists.owasp.org
[mailto:owasp-modsecurity-core-rule-set-bounces at lists.owasp.org] On Behalf
Of Mirabito, Massimo (Max) (CDC/OID/OD) (CTR)
Sent: Tuesday, March 08, 2011 1:59 PM
To: 'owasp-modsecurity-core-rule-set at lists.owasp.org'
Cc: Wang, Silver (CDC/OID/OD) (CTR)
Subject: [Owasp-modsecurity-core-rule-set] Rule Set is being violated on
modsecurity_crs_41_phpids_converter.conf line 70

 

Dear All

 

We are having difficulty with one of our applications as it appears that
mod_security is blocking some of the content thinking that it is a
vulnerability.

We are running Apache version 2.2 with mod_security version 2.05

 

 

The url that is giving us problems is as follows:

https://myserver.com/MYAPP/nt/chart/run.do?t=tcg&m=cot/trend&f=png&r=3&y=200
5+to+2009&d=labels_x:[2005,2006,2007,2008,2009,-8.88888888E8,2015];tlabels_x
:[2005,2006,2007,2008,2009];g:[[89.690721649,86.746987952,91.946308725,90,85
.135135135,-8.88888888E8,null],[90,85,87,89,90,-8.88888888E8,null],[83.20913
6562,83.894290701,84.484373669,81.189229619,64.743991641,-8.88888888E8,null]
,[null,null,null,null,null,-8.88888888E8,93]];t:[[194,166,149,150,148],[184,
155,144,141,130],[174,144,137,135,126],[10,11,5,9,18]]&c=0+0+0+0+1&rid=1

 

The peculiar thing is that a similar url runs properly, see below

https:// myserver.com/MYAPP/nt/chart/run.do?
t=pct&m=cot/outcomes&f=png&r=3&y=2009&d=p:[[148,100],[126,85.135135135],[4,2
.7027027027],[0,0],[2,1.3513513514],[1,0.6756756757],[15,10.135135135]]&&rid
=1

 

The logs show the following rule being violated:

Message: Pattern match "(?:[\d+-=\/\* ]+(?:\s?,\s?[\d+-=\/\* ]+)){4,}" at
ARGS:d. [file
"C:/Apache2.2/conf/mod_security/base_rules/modsecurity_crs_41_phpids_convert
er.conf"] [line "70"] [id "973016"] [msg "Basic Charcode Pattern Found"]
[data "2005,2006,2007,2008,2009,-8.88888888e3"]

 

The rule in question is located in modsecurity_crs_41_phpids_converter.conf
- line 70

SecRule ARGS|ARGS_NAMES|XML:/* "(?:[\d+-=\/\* ]+(?:\s?,\s?[\d+-=\/\*
]+)){4,}"
"skip:1,phase:2,capture,t:none,t:urlDecodeUni,t:htmlEntityDecode,t:compressW
hiteSpace,t:lowercase,ctl:auditLogParts=+E,pass,nolog,auditlog,msg:'Basic
Charcode Pattern
Found',id:'973016',tag:'WEB_ATTACK/EVASION',logdata:'%{TX.0}',severity:'4',s
etvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.warning_anomaly_sco
re},setvar:tx.%{rule.id}-WEB_ATTACK/EVASION-%{matched_var_name}=%{tx.0}"

 

My coworker discovered that if we modify a portion of the rule then we are
able to run the application properly. In particular if we modify {4} to {10}
then things begin working

SecRule ARGS|ARGS_NAMES|XML:/* "(?:[\d+-=\/\* ]+(?:\s?,\s?[\d+-=\/\*
]+)){4,}" .. TO ... SecRule ARGS|ARGS_NAMES|XML:/* "(?:[\d+-=\/\*
]+(?:\s?,\s?[\d+-=\/\* ]+)){10,}"

 

We are concerned that by making this change we either inadvertently make our
security weaker or break other things. So we are wondering if the rule has
an inherit problem and is there a way to either resolve it or by pass it or
any other best practice.

 

 

Any feedback is greatly appreciated

 

Thanks,

 

Max 

 

 

 

 

 

 

 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20110308/2fe15e0a/attachment-0001.html 

From RBarnett at trustwave.com  Tue Mar  8 15:38:14 2011
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Tue, 8 Mar 2011 14:38:14 -0600
Subject: [Owasp-modsecurity-core-rule-set] modsecurity logs managment
 tool
In-Reply-To: <013601cbddce$0f03a650$2d0af2f0$@com>
References: <4ACE4D561D68644483BFF6D8FF278BC906779B@EMBX-CHAM4.cdc.gov>
	<4ACE4D561D68644483BFF6D8FF278BC90677D1@EMBX-CHAM4.cdc.gov>
	<4ACE4D561D68644483BFF6D8FF278BC90677FE@EMBX-CHAM4.cdc.gov>
	<013601cbddce$0f03a650$2d0af2f0$@com>
Message-ID: <AC176F8B-AFE8-4CDF-870F-AA57343566D2@trustwave.com>

The mod-security-users list would be the best place for this question -

http://lists.sourceforge.net/lists/listinfo/mod-security-users

That being said - Chris Bockermann's AuditConsole is probably the best free tool out there right now - <http://jwall.org/web/audit/console/index.jsp> http://jwall.org/web/audit/console/index.jsp


On Mar 8, 2011, at 12:18 PM, "Abdellah Tantan" <adtantan at paydq.com<mailto:adtantan at paydq.com>> wrote:

I am not sure if this is the right mailing list for these questions.

What?s the best tool to manage modsecurity logs? Keeping in mind that performance is a concern.

Is there any good article of how to configure  modsecurity for better performance?

Thanks

Abdellah


From: owasp-modsecurity-core-rule-set-bounces at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set-bounces at lists.owasp.org> [mailto:owasp-modsecurity-core-rule-set-bounces at lists.owasp.org] On Behalf Of Mirabito, Massimo (Max) (CDC/OID/OD) (CTR)
Sent: Tuesday, March 08, 2011 1:59 PM
To: 'owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>'
Cc: Wang, Silver (CDC/OID/OD) (CTR)
Subject: [Owasp-modsecurity-core-rule-set] Rule Set is being violated on modsecurity_crs_41_phpids_converter.conf line 70

Dear All

We are having difficulty with one of our applications as it appears that mod_security is blocking some of the content thinking that it is a vulnerability.
We are running Apache version 2.2 with mod_security version 2.05


The url that is giving us problems is as follows:
<https://myserver.com/MYAPP/nt/chart/run.do?t=tcg&m=cot/trend&f=png&r=3&y=2005+to+2009&d=labels_x:%5b2005,2006,2007,2008,2009,-8.88888888E8,2015%5d;tlabels_x:%5b2005,2006,2007,2008,2009%5d;g:%5b%5b89.690721649,86.746987952,91.946308725,90,85.135135135,-8.88888888E8,null%5d,%5b90,85,87,89,90,-8.88888888E8,null%5d,%5b83.209136562,83.894290701,84.484373669,81.189229619,64.743991641,-8.88888888E8,null%5d,%5bnull,null,null,null,null,-8.88888888E8,93%5d%5d;t:%5b%5b194,166,149,150,148%5d,%5b184,155,144,141,130%5d,%5b174,144,137,135,126%5d,%5b10,11,5,9,18%5d%5d&c=0+0+0+0+1&rid=1>https://myserver.com/MYAPP/nt/chart/run.do?t=tcg&m=cot/trend&f=png&r=3&y=2005+to+2009&d=labels_x:[2005,2006,2007,2008,2009,-8.88888888E8,2015];tlabels_x:[2005,2006,2007,2008,2009];g:[[89.690721649,86.746987952,91.946308725,90,85.135135135,-8.88888888E8,null],[90,85,87,89,90,-8.88888888E8,null],[83.209136562,83.894290701,84.484373669,81.189229619,64.743991641,-8.88888888E8,null],[null,null,null,null,null,-8.88888888E8,93]];t:[[194,166,149,150,148],[184,155,144,141,130],[174,144,137,135,126],[10,11,5,9,18]]&c=0+0+0+0+1&rid=1

The peculiar thing is that a similar url runs properly, see below
https:// myserver.com/MYAPP/nt/chart/run.do?<http://myserver.com/MYAPP/nt/chart/run.do?> t=pct&m=cot/outcomes&f=png&r=3&y=2009&d=p:[[148,100],[126,85.135135135],[4,2.7027027027],[0,0],[2,1.3513513514],[1,0.6756756757],[15,10.135135135]]&&rid=1

The logs show the following rule being violated:
Message: Pattern match "(?:[\d+-=\/\* ]+(?:\s?,\s?[\d+-=\/\* ]+)){4,}" at ARGS:d. [file "C:/Apache2.2/conf/mod_security/base_rules/modsecurity_crs_41_phpids_converter.conf"] [line "70"] [id "973016"] [msg "Basic Charcode Pattern Found"] [data "2005,2006,2007,2008,2009,-8.88888888e3"]

The rule in question is located in modsecurity_crs_41_phpids_converter.conf  - line 70
SecRule ARGS|ARGS_NAMES|XML:/* "(?:[\d+-=\/\* ]+(?:\s?,\s?[\d+-=\/\* ]+)){4,}" "skip:1,phase:2,capture,t:none,t:urlDecodeUni,t:htmlEntityDecode,t:compressWhiteSpace,t:lowercase,ctl:auditLogParts=+E,pass,nolog,auditlog,msg:'Basic Charcode Pattern Found',id:'973016',tag:'WEB_ATTACK/EVASION',logdata:'%{TX.0}',severity:'4',setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.warning_anomaly_score},setvar:tx.%{rule.id}-WEB_ATTACK/EVASION-%{matched_var_name}=%{tx.0}"

My coworker discovered that if we modify a portion of the rule then we are able to run the application properly. In particular if we modify {4} to {10}  then things begin working
SecRule ARGS|ARGS_NAMES|XML:/* "(?:[\d+-=\/\* ]+(?:\s?,\s?[\d+-=\/\* ]+)){4,}" ?? TO ??. SecRule ARGS|ARGS_NAMES|XML:/* "(?:[\d+-=\/\* ]+(?:\s?,\s?[\d+-=\/\* ]+)){10,}"

We are concerned that by making this change we either inadvertently make our security weaker or break other things. So we are wondering if the rule has an inherit problem and is there a way to either resolve it or by pass it or any other best practice.


Any feedback is greatly appreciated

Thanks,

Max







_______________________________________________
Owasp-modsecurity-core-rule-set mailing list
Owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:Owasp-modsecurity-core-rule-set at lists.owasp.org>
https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set

From jamuse at gmail.com  Tue Mar  8 15:45:48 2011
From: jamuse at gmail.com (Josh Amishav-Zlatin)
Date: Tue, 8 Mar 2011 22:45:48 +0200
Subject: [Owasp-modsecurity-core-rule-set] Rule Set is being violated on
 modsecurity_crs_41_phpids_converter.conf line 70
In-Reply-To: <4ACE4D561D68644483BFF6D8FF278BC90677FE@EMBX-CHAM4.cdc.gov>
References: <4ACE4D561D68644483BFF6D8FF278BC906779B@EMBX-CHAM4.cdc.gov>
	<4ACE4D561D68644483BFF6D8FF278BC90677D1@EMBX-CHAM4.cdc.gov>
	<4ACE4D561D68644483BFF6D8FF278BC90677FE@EMBX-CHAM4.cdc.gov>
Message-ID: <AANLkTi=4j2G=cNUxrfLKHLBx3Aeo73Tn=vvbqpEQMKKp@mail.gmail.com>

On Tue, Mar 8, 2011 at 9:59 PM, Mirabito, Massimo (Max) (CDC/OID/OD)
(CTR) <mcm8 at cdc.gov> wrote:
> Dear All
>
>
>
> We are having difficulty with one of our applications as it appears that
> mod_security is blocking some of the content thinking that it is a
> vulnerability.
>
> We are running Apache version 2.2 with mod_security version 2.05
>
>
>
>
>
> The url that is giving us problems is as follows:
>
> https://myserver.com/MYAPP/nt/chart/run.do?t=tcg&m=cot/trend&f=png&r=3&y=2005+to+2009&d=labels_x:[2005,2006,2007,2008,2009,-8.88888888E8,2015];tlabels_x:[2005,2006,2007,2008,2009];g:[[89.690721649,86.746987952,91.946308725,90,85.135135135,-8.88888888E8,null],[90,85,87,89,90,-8.88888888E8,null],[83.209136562,83.894290701,84.484373669,81.189229619,64.743991641,-8.88888888E8,null],[null,null,null,null,null,-8.88888888E8,93]];t:[[194,166,149,150,148],[184,155,144,141,130],[174,144,137,135,126],[10,11,5,9,18]]&c=0+0+0+0+1&rid=1
>
>
>
> The peculiar thing is that a similar url runs properly, see below
>
> https:// myserver.com/MYAPP/nt/chart/run.do?
> t=pct&m=cot/outcomes&f=png&r=3&y=2009&d=p:[[148,100],[126,85.135135135],[4,2.7027027027],[0,0],[2,1.3513513514],[1,0.6756756757],[15,10.135135135]]&&rid=1
>
>
>
> The logs show the following rule being violated:
>
> Message: Pattern match "(?:[\d+-=\/\* ]+(?:\s?,\s?[\d+-=\/\* ]+)){4,}" at
> ARGS:d. [file
> "C:/Apache2.2/conf/mod_security/base_rules/modsecurity_crs_41_phpids_converter.conf"]
> [line "70"] [id "973016"] [msg "Basic Charcode Pattern Found"] [data
> "2005,2006,2007,2008,2009,-8.88888888e3"]
>
>
>
> The rule in question is located in modsecurity_crs_41_phpids_converter.conf
> ?- line 70
>
> SecRule ARGS|ARGS_NAMES|XML:/* "(?:[\d+-=\/\* ]+(?:\s?,\s?[\d+-=\/\*
> ]+)){4,}"
> "skip:1,phase:2,capture,t:none,t:urlDecodeUni,t:htmlEntityDecode,t:compressWhiteSpace,t:lowercase,ctl:auditLogParts=+E,pass,nolog,auditlog,msg:'Basic
> Charcode Pattern
> Found',id:'973016',tag:'WEB_ATTACK/EVASION',logdata:'%{TX.0}',severity:'4',setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.warning_anomaly_score},setvar:tx.%{rule.id}-WEB_ATTACK/EVASION-%{matched_var_name}=%{tx.0}"
>
>
>
> My coworker discovered that if we modify a portion of the rule then we are
> able to run the application properly. In particular if we modify {4} to {10}
> ?then things begin working
>
> SecRule ARGS|ARGS_NAMES|XML:/* "(?:[\d+-=\/\* ]+(?:\s?,\s?[\d+-=\/\*
> ]+)){4,}" ?? TO ??. SecRule ARGS|ARGS_NAMES|XML:/* "(?:[\d+-=\/\*
> ]+(?:\s?,\s?[\d+-=\/\* ]+)){10,}"
>
>
>
> We are concerned that by making this change we either inadvertently make our
> security weaker or break other things. So we are wondering if the rule has
> an inherit problem and is there a way to either resolve it or by pass it or
> any other best practice.

Hi Mirabito,

Earlier versions of the PHP IDS rules were false positive prone. That
ruleset has subsequently been converted to Lua. Consider upgrading the
core rule set or disabling that rule for the effected script.

--
 - Josh

From mcm8 at cdc.gov  Wed Mar  9 13:21:01 2011
From: mcm8 at cdc.gov (Mirabito, Massimo (Max) (CDC/OID/OD) (CTR))
Date: Wed, 9 Mar 2011 18:21:01 +0000
Subject: [Owasp-modsecurity-core-rule-set] Rule Set is being violated on
 modsecurity_crs_41_phpids_converter.conf line 70
In-Reply-To: <AANLkTi=4j2G=cNUxrfLKHLBx3Aeo73Tn=vvbqpEQMKKp@mail.gmail.com>
References: <4ACE4D561D68644483BFF6D8FF278BC906779B@EMBX-CHAM4.cdc.gov>
	<4ACE4D561D68644483BFF6D8FF278BC90677D1@EMBX-CHAM4.cdc.gov>
	<4ACE4D561D68644483BFF6D8FF278BC90677FE@EMBX-CHAM4.cdc.gov>
	<AANLkTi=4j2G=cNUxrfLKHLBx3Aeo73Tn=vvbqpEQMKKp@mail.gmail.com>
Message-ID: <4ACE4D561D68644483BFF6D8FF278BC9068147@EMBX-CHAM4.cdc.gov>

Josh,

Just wanted to drop a note and let you know that we upgraded to 2.05.13 and all looks good now.

Thanks 
Max

-----Original Message-----
From: Josh Amishav-Zlatin [mailto:jamuse at gmail.com] 
Sent: Tuesday, March 08, 2011 15:46
To: Mirabito, Massimo (Max) (CDC/OID/OD) (CTR)
Cc: owasp-modsecurity-core-rule-set at lists.owasp.org; Wang, Silver (CDC/OID/OD) (CTR)
Subject: Re: [Owasp-modsecurity-core-rule-set] Rule Set is being violated on modsecurity_crs_41_phpids_converter.conf line 70

On Tue, Mar 8, 2011 at 9:59 PM, Mirabito, Massimo (Max) (CDC/OID/OD)
(CTR) <mcm8 at cdc.gov> wrote:
> Dear All
>
>
>
> We are having difficulty with one of our applications as it appears that
> mod_security is blocking some of the content thinking that it is a
> vulnerability.
>
> We are running Apache version 2.2 with mod_security version 2.05
>
>
>
>
>
> The url that is giving us problems is as follows:
>
> https://myserver.com/MYAPP/nt/chart/run.do?t=tcg&m=cot/trend&f=png&r=3&y=2005+to+2009&d=labels_x:[2005,2006,2007,2008,2009,-8.88888888E8,2015];tlabels_x:[2005,2006,2007,2008,2009];g:[[89.690721649,86.746987952,91.946308725,90,85.135135135,-8.88888888E8,null],[90,85,87,89,90,-8.88888888E8,null],[83.209136562,83.894290701,84.484373669,81.189229619,64.743991641,-8.88888888E8,null],[null,null,null,null,null,-8.88888888E8,93]];t:[[194,166,149,150,148],[184,155,144,141,130],[174,144,137,135,126],[10,11,5,9,18]]&c=0+0+0+0+1&rid=1
>
>
>
> The peculiar thing is that a similar url runs properly, see below
>
> https:// myserver.com/MYAPP/nt/chart/run.do?
> t=pct&m=cot/outcomes&f=png&r=3&y=2009&d=p:[[148,100],[126,85.135135135],[4,2.7027027027],[0,0],[2,1.3513513514],[1,0.6756756757],[15,10.135135135]]&&rid=1
>
>
>
> The logs show the following rule being violated:
>
> Message: Pattern match "(?:[\d+-=\/\* ]+(?:\s?,\s?[\d+-=\/\* ]+)){4,}" at
> ARGS:d. [file
> "C:/Apache2.2/conf/mod_security/base_rules/modsecurity_crs_41_phpids_converter.conf"]
> [line "70"] [id "973016"] [msg "Basic Charcode Pattern Found"] [data
> "2005,2006,2007,2008,2009,-8.88888888e3"]
>
>
>
> The rule in question is located in modsecurity_crs_41_phpids_converter.conf
> ?- line 70
>
> SecRule ARGS|ARGS_NAMES|XML:/* "(?:[\d+-=\/\* ]+(?:\s?,\s?[\d+-=\/\*
> ]+)){4,}"
> "skip:1,phase:2,capture,t:none,t:urlDecodeUni,t:htmlEntityDecode,t:compressWhiteSpace,t:lowercase,ctl:auditLogParts=+E,pass,nolog,auditlog,msg:'Basic
> Charcode Pattern
> Found',id:'973016',tag:'WEB_ATTACK/EVASION',logdata:'%{TX.0}',severity:'4',setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.warning_anomaly_score},setvar:tx.%{rule.id}-WEB_ATTACK/EVASION-%{matched_var_name}=%{tx.0}"
>
>
>
> My coworker discovered that if we modify a portion of the rule then we are
> able to run the application properly. In particular if we modify {4} to {10}
> ?then things begin working
>
> SecRule ARGS|ARGS_NAMES|XML:/* "(?:[\d+-=\/\* ]+(?:\s?,\s?[\d+-=\/\*
> ]+)){4,}" ?? TO ??. SecRule ARGS|ARGS_NAMES|XML:/* "(?:[\d+-=\/\*
> ]+(?:\s?,\s?[\d+-=\/\* ]+)){10,}"
>
>
>
> We are concerned that by making this change we either inadvertently make our
> security weaker or break other things. So we are wondering if the rule has
> an inherit problem and is there a way to either resolve it or by pass it or
> any other best practice.

Hi Mirabito,

Earlier versions of the PHP IDS rules were false positive prone. That
ruleset has subsequently been converted to Lua. Consider upgrading the
core rule set or disabling that rule for the effected script.

--
 - Josh

From chumleyr at edaptivesys.com  Wed Mar  9 13:55:09 2011
From: chumleyr at edaptivesys.com (Robert Chumley)
Date: Wed, 9 Mar 2011 18:55:09 +0000
Subject: [Owasp-modsecurity-core-rule-set] Core ruleset issue
Message-ID: <FEE4A5A1A005AD4186083840AA17C8FA555B44C2@EX01.escorp.local>

Hello,
We are currently testing mod security and found this problem with a SQL Injection rule..

What:
Modsecurity_crs_41_sql_injection_attacks

Rule:
SecRule REQUEST_FILENAME|ARGS_NAMES|ARGS|XML:/* "\b(\d+) ?(?:=|<>|<=>|<|>|!=) ?\1\b|[\'\"\`\?\'\'](\d+)[\'\"\`\?\'\'] ?(?:=|<>|<=>|<|>|!=) ?[\'\"\`\?\'\']\2\b|[\'\"\`\?\\'](\w+)[\'\"\`\?\'\'] ?(?:=|<>|<=>|<|>|!=) ?[\'\"\`\?\'\']\3\b|([\'\"\;\`\?\'\']*)?\s+(and|or)\s+([\s\'\"\`\?\'\']*)?\w+([\s\'\"\`\?\'\']*)?[=<>!]*([\s\'\"\`\?\'\']*)?\w+([\s\'\"\`\?\'\']*)?" \
                       "phase:2,rev:'2.1.1',capture,multiMatch,t:none,t:urlDecodeUni,t:htmlEntityDecode,t:replaceComments,t:compressWhiteSpace,t:lowercase,ctl:auditLogParts=+E,block,msg:'SQL Injection Attack',id:'950901',logdata:'%{TX.0}',severity:'2',setvar:'tx.msg=%{rule.msg}',setvar:tx.sql_injection_score=+%{tx.critical_anomaly_score},setvar:tx.anomaly_score=+%{tx.critical_anomaly_score},setvar:tx.%{rule.id}-WEB_ATTACK/SQL_INJECTION-%{matched_var_name}=%{tx.0}"

Problem:
This rule blocks when anything with "a or b" or "a and b" (without the quotes), is used in a field.


Robert Chumley  |  Edaptive Systems<http://www.edaptivesys.com/>
400 Red Brook Blvd, Ste 220, Owings Mills, MD 21117
O: 410.327.3366 x176  |  C: 410-725-1295  |  chumleyr at edaptivesys.com<mailto:keckm at edaptivesys.com>

The contents of this e-mail and any attachments are intended solely for the use of the named addressee(s) and may contain confidential and/or privileged information. Any unauthorized use, copying, disclosure, or distribution of the contents of this e-mail is strictly prohibited by the sender and may be unlawful. If you are not the intended recipient, please notify the sender immediately and delete this email. Thank you.

-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20110309/94356cea/attachment.html 

From stephensant at gmail.com  Thu Mar 10 00:12:59 2011
From: stephensant at gmail.com (Steve Sant)
Date: Thu, 10 Mar 2011 05:12:59 +0000 (UTC)
Subject: [Owasp-modsecurity-core-rule-set]
	=?utf-8?q?Call_for_Assistance?=
	=?utf-8?q?=3A=09ModSecurity/CRS_Event_Data_Statistics?=
References: <C8CFB635.1480E%rbarnett@trustwave.com>
Message-ID: <loom.20110310T061031-83@post.gmane.org>


Do you still require these reports? I can send them in regularly f you like.

Just tried to email some to security at modsecurity.com but got bounced.

Steve


From RBarnett at trustwave.com  Thu Mar 10 07:27:32 2011
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Thu, 10 Mar 2011 06:27:32 -0600
Subject: [Owasp-modsecurity-core-rule-set] Call for
	Assistance:	ModSecurity/CRS Event Data Statistics
In-Reply-To: <loom.20110310T061031-83@post.gmane.org>
References: <C8CFB635.1480E%rbarnett@trustwave.com>
	<loom.20110310T061031-83@post.gmane.org>
Message-ID: <B0E2125D-BEFF-4BA4-B42B-708FC2769BBF@trustwave.com>

Thanks for bringing this up again!  Yes, I think it would be great if we had a central repo of this collaborative logging data from the community. 

I have some ideas for hosting this logging service on the ModSecurity site. I will get back with the list soon with some info. 

By the way - the email you sent bounced because it is . org instead of . com. 

On Mar 10, 2011, at 12:15 AM, "Steve Sant" <stephensant at gmail.com> wrote:

> 
> Do you still require these reports? I can send them in regularly f you like.
> 
> Just tried to email some to security at modsecurity.com but got bounced.
> 
> Steve
> 
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
> 


From RBarnett at trustwave.com  Thu Mar 10 15:09:33 2011
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Thu, 10 Mar 2011 14:09:33 -0600
Subject: [Owasp-modsecurity-core-rule-set] Announcing ModSecurity
	Documentation Wiki
Message-ID: <C99E9A2D.1B99A%rbarnett@trustwave.com>

Hello everyone,
Hopefully this will come as good news to you all. We are in the process of migrating the ModSecurity documentation from our static website out to a Wiki hosted by SourceForge -
https://sourceforge.net/apps/mediawiki/mod-security/

We have initially migrated over the Reference Manual, FAQ and Roadmap data.  The data on the Wiki will always be the most update-to-date.  As a matter of fact, the new Reference Manual data on the wiki lists some of the new features that have just been added into the 2.6.0 SVN trunk version.  Of particular note is a new feature called SecRuleUpdateTargetById (along with the ctl:ruleUpdateTargetById action) -
https://sourceforge.net/apps/mediawiki/mod-security/index.php?title=Reference_Manual#SecRuleUpdateTargetById

This new feature will really help with handling exceptions as you can now dynamically update the variable target lists!  This means that you can easily specify ARGS that you want to exclude from inspection for certain ruleIDs.

Anyways, we are hoping that this new Wiki-based documentation site will be helpful to you all.  Not just for providing the most current information but also for allow the community more access to helping with documentation.  So if you find any issues with the documentation or would like to improve it, then just create a free SourceForge account and you edit it yourself.  :)

Cheers,
Ryan


From adtantan at paydq.com  Tue Mar 15 14:38:42 2011
From: adtantan at paydq.com (Abdellah Tantan)
Date: Tue, 15 Mar 2011 13:38:42 -0500
Subject: [Owasp-modsecurity-core-rule-set] Questions about modsecurity rules
In-Reply-To: <loom.20110310T061031-83@post.gmane.org>
References: <C8CFB635.1480E%rbarnett@trustwave.com>
	<loom.20110310T061031-83@post.gmane.org>
Message-ID: <00c801cbe340$36ab28f0$a4017ad0$@com>


Hi, 

Although I have read mod_security book by Ivan Restic, I feel I am still
very new to Mod_Security. I am wondering why sending a simple request
triggered all these rules (see raw data bellow)? if the request was marked
as critical, why it was not blocked? Any help to understand this is
appreciated, 

This is my main configuration file

SecComponentSignature "core ruleset/2.1.1"
SecRuleEngine On
SecDefaultAction "phase:2,pass,nolog,auditlog"
SecAction "phase:1,t:none,nolog,pass,setvar:tx.anomaly_score_blocking=on"
SecAction "phase:1,t:none,nolog,pass, \
setvar:tx.critical_anomaly_score=5, \
setvar:tx.error_anomaly_score=4, \
setvar:tx.warning_anomaly_score=3, \
setvar:tx.notice_anomaly_score=2"
SecAction
"phase:1,t:none,nolog,pass,setvar:tx.inbound_anomaly_score_level=5"
SecAction
"phase:1,t:none,nolog,pass,setvar:tx.outbound_anomaly_score_level=4"


raw data bellow.


--342fe054-A--
[15/Mar/2011:13:23:56 --0500] iAJfIgoAygIAAGstEDsAAAAC 66.37.224.199 52567
10.0.202.2 80
--342fe054-B--
GET /lpandl/images/buttons/login.gif HTTP/1.1
Host: 98.142.93.2
User-Agent: Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US; rv:1.9.2.15)
Gecko/20110303 Firefox/3.6.15
Accept: image/png,image/*;q=0.8,*/*;q=0.5
Accept-Language: en-us,en;q=0.5
Accept-Encoding: gzip,deflate
Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7
Connection: keep-alive
Referer:
https://98.142.93.2/lpandl/Logon.do;jsessionid=2D2A0F2EC20B323DEFE7901DB4800
52E
Cookie: JSESSIONID=2D2A0F2EC20B323DEFE7901DB480052E
X-Forwarded-For: 66.37.224.199
Front-End-Https: On

--342fe054-E--

--342fe054-F--
HTTP/1.1 200 OK
ETag: W/"929-1272484876000"
Last-Modified: Wed, 28 Apr 2010 20:01:16 GMT
Content-Length: 929
Connection: close
Content-Type: image/gif

--342fe054-H--
Message: Warning. Match of "within %{tx.allowed_methods}" against
"REQUEST_METHOD" required. [file
"/etc/httpd/conf/modsecurity/rules/base_rules/modsecurity_crs_30_http_policy
.conf"] [line "30"] [id "960032"] [msg "Method is not allowed by policy"]
[data "GET"] [severity "CRITICAL"] [tag "POLICY/METHOD_NOT_ALLOWED"] [tag
"WASCTC/WASC-15"] [tag "OWASP_TOP_10/A6"] [tag "OWASP_AppSensor/RE1"] [tag
"PCI/12.1"]
Message: Warning. Match of "within %{tx.allowed_http_versions}" against
"REQUEST_PROTOCOL" required. [file
"/etc/httpd/conf/modsecurity/rules/base_rules/modsecurity_crs_30_http_policy
.conf"] [line "77"] [id "960034"] [msg "HTTP protocol version is not allowed
by policy"] [data "HTTP/1.1"] [severity "CRITICAL"] [tag
"POLICY/PROTOCOL_NOT_ALLOWED"] [tag "WASCTC/WASC-21"] [tag
"OWASP_TOP_10/A6"] [tag "PCI/6.5.10"]
Apache-Handler: jakarta-servlet
Stopwatch: 1300213436407586 8794 (450 5600 -)
Response-Body-Transformed: Dechunked
Producer: ModSecurity for Apache/2.5.12 (http://www.modsecurity.org/).
Server: Apache/2.2.3 (CentOS)

--342fe054-K--
SecRule "REQUEST_METHOD" "@rx ^(?:GET|HEAD)$"
"phase:1,log,auditlog,chain,rev:2.1.1,t:none,block,msg:'GET or HEAD requests
with
bodies',severity:2,id:960011,tag:PROTOCOL_VIOLATION/EVASION,tag:WASCTC/WASC-
21,tag:OWASP_TOP_10/A7,tag:PCI/6.5.10,tag:http://www.w3.org/Protocols/rfc261
6/rfc2616-sec4.html#sec4.3"
SecRule "REQUEST_METHOD" "!@rx ^OPTIONS$"
"phase:2,log,auditlog,chain,rev:2.1.1,t:none,block,msg:'Request Missing an
Accept
Header',severity:2,id:960015,tag:PROTOCOL_VIOLATION/MISSING_HEADER_ACCEPT,ta
g:WASCTC/WASC-21,tag:OWASP_TOP_10/A7,tag:PCI/6.5.10"
SecRule "&REQUEST_HEADERS:Content-Type" "@eq 0"
"phase:2,log,auditlog,chain,rev:2.1.1,t:none,block,msg:'Request Containing
Content, but Missing Content-Type header',id:960904,severity:5"
SecRule "REQUEST_METHOD" "!@within %{tx.allowed_methods}"
"phase:2,log,auditlog,t:none,block,msg:'Method is not allowed by
policy',severity:2,id:960032,tag:POLICY/METHOD_NOT_ALLOWED,tag:WASCTC/WASC-1
5,tag:OWASP_TOP_10/A6,tag:OWASP_AppSensor/RE1,tag:PCI/12.1,logdata:%{matched
_var},setvar:tx.msg=%{rule.msg},setvar:tx.anomaly_score=+%{tx.warning_anomal
y_score},setvar:tx.policy_score=+%{tx.warning_anomaly_score},setvar:tx.%{rul
e.id}-POLICY/METHOD_NOT_ALLOWED-%{matched_var_name}=%{matched_var}"
SecRule "REQUEST_PROTOCOL" "!@within %{tx.allowed_http_versions}"
"phase:2,log,auditlog,t:none,block,msg:'HTTP protocol version is not allowed
by
policy',severity:2,id:960034,tag:POLICY/PROTOCOL_NOT_ALLOWED,tag:WASCTC/WASC
-21,tag:OWASP_TOP_10/A6,tag:PCI/6.5.10,logdata:%{matched_var},setvar:tx.msg=
%{rule.msg},setvar:tx.anomaly_score=+%{tx.warning_anomaly_score},setvar:tx.p
olicy_score=+%{tx.warning_anomaly_score},setvar:tx.%{rule.id}-POLICY/PROTOCO
L_NOT_ALLOWED-%{matched_var_name}=%{matched_var}"
SecRule "REQUEST_BASENAME" "@rx \\.(.*)$"
"phase:2,log,auditlog,chain,capture,setvar:tx.extension=.%{tx.1}/,t:none,t:u
rlDecodeUni,t:lowercase,block,msg:'URL file extension is restricted by
policy',severity:2,id:960035,tag:POLICY/EXT_RESTRICTED,tag:WASCTC/WASC-15,ta
g:OWASP_TOP_10/A7,tag:PCI/6.5.10,logdata:%{TX.0}"
SecRule "REQUEST_HEADERS_NAMES" "@rx ^(.*)$"
"phase:2,log,auditlog,chain,t:none,block,msg:'HTTP header is restricted by
policy',id:960038,tag:POLICY/HEADER_RESTRICTED,tag:POLICY/FILES_NOT_ALLOWED,
tag:WASCTC/WASC-21,tag:OWASP_TOP_10/A7,tag:PCI/12.1,tag:WASCTC/WASC-15,tag:O
WASP_TOP_10/A7,tag:PCI/12.1,severity:4,logdata:%{matched_var},capture,setvar
:tx.header_name='/%{tx.0}/'"
SecRule "REQUEST_HEADERS_NAMES" "@rx ^(.*)$"
"phase:2,log,auditlog,chain,t:none,block,msg:'HTTP header is restricted by
policy',id:960038,tag:POLICY/HEADER_RESTRICTED,tag:POLICY/FILES_NOT_ALLOWED,
tag:WASCTC/WASC-21,tag:OWASP_TOP_10/A7,tag:PCI/12.1,tag:WASCTC/WASC-15,tag:O
WASP_TOP_10/A7,tag:PCI/12.1,severity:4,logdata:%{matched_var},capture,setvar
:tx.header_name='/%{tx.0}/'"
SecRule "REQUEST_HEADERS_NAMES" "@rx ^(.*)$"
"phase:2,log,auditlog,chain,t:none,block,msg:'HTTP header is restricted by
policy',id:960038,tag:POLICY/HEADER_RESTRICTED,tag:POLICY/FILES_NOT_ALLOWED,
tag:WASCTC/WASC-21,tag:OWASP_TOP_10/A7,tag:PCI/12.1,tag:WASCTC/WASC-15,tag:O
WASP_TOP_10/A7,tag:PCI/12.1,severity:4,logdata:%{matched_var},capture,setvar
:tx.header_name='/%{tx.0}/'"
SecRule "REQUEST_HEADERS_NAMES" "@rx ^(.*)$"
"phase:2,log,auditlog,chain,t:none,block,msg:'HTTP header is restricted by
policy',id:960038,tag:POLICY/HEADER_RESTRICTED,tag:POLICY/FILES_NOT_ALLOWED,
tag:WASCTC/WASC-21,tag:OWASP_TOP_10/A7,tag:PCI/12.1,tag:WASCTC/WASC-15,tag:O
WASP_TOP_10/A7,tag:PCI/12.1,severity:4,logdata:%{matched_var},capture,setvar
:tx.header_name='/%{tx.0}/'"
SecRule "REQUEST_HEADERS_NAMES" "@rx ^(.*)$"
"phase:2,log,auditlog,chain,t:none,block,msg:'HTTP header is restricted by
policy',id:960038,tag:POLICY/HEADER_RESTRICTED,tag:POLICY/FILES_NOT_ALLOWED,
tag:WASCTC/WASC-21,tag:OWASP_TOP_10/A7,tag:PCI/12.1,tag:WASCTC/WASC-15,tag:O
WASP_TOP_10/A7,tag:PCI/12.1,severity:4,logdata:%{matched_var},capture,setvar
:tx.header_name='/%{tx.0}/'"
SecRule "REQUEST_HEADERS_NAMES" "@rx ^(.*)$"
"phase:2,log,auditlog,chain,t:none,block,msg:'HTTP header is restricted by
policy',id:960038,tag:POLICY/HEADER_RESTRICTED,tag:POLICY/FILES_NOT_ALLOWED,
tag:WASCTC/WASC-21,tag:OWASP_TOP_10/A7,tag:PCI/12.1,tag:WASCTC/WASC-15,tag:O
WASP_TOP_10/A7,tag:PCI/12.1,severity:4,logdata:%{matched_var},capture,setvar
:tx.header_name='/%{tx.0}/'"
SecRule "REQUEST_HEADERS_NAMES" "@rx ^(.*)$"
"phase:2,log,auditlog,chain,t:none,block,msg:'HTTP header is restricted by
policy',id:960038,tag:POLICY/HEADER_RESTRICTED,tag:POLICY/FILES_NOT_ALLOWED,
tag:WASCTC/WASC-21,tag:OWASP_TOP_10/A7,tag:PCI/12.1,tag:WASCTC/WASC-15,tag:O
WASP_TOP_10/A7,tag:PCI/12.1,severity:4,logdata:%{matched_var},capture,setvar
:tx.header_name='/%{tx.0}/'"
SecRule "REQUEST_HEADERS_NAMES" "@rx ^(.*)$"
"phase:2,log,auditlog,chain,t:none,block,msg:'HTTP header is restricted by
policy',id:960038,tag:POLICY/HEADER_RESTRICTED,tag:POLICY/FILES_NOT_ALLOWED,
tag:WASCTC/WASC-21,tag:OWASP_TOP_10/A7,tag:PCI/12.1,tag:WASCTC/WASC-15,tag:O
WASP_TOP_10/A7,tag:PCI/12.1,severity:4,logdata:%{matched_var},capture,setvar
:tx.header_name='/%{tx.0}/'"
SecRule "REQUEST_HEADERS_NAMES" "@rx ^(.*)$"
"phase:2,log,auditlog,chain,t:none,block,msg:'HTTP header is restricted by
policy',id:960038,tag:POLICY/HEADER_RESTRICTED,tag:POLICY/FILES_NOT_ALLOWED,
tag:WASCTC/WASC-21,tag:OWASP_TOP_10/A7,tag:PCI/12.1,tag:WASCTC/WASC-15,tag:O
WASP_TOP_10/A7,tag:PCI/12.1,severity:4,logdata:%{matched_var},capture,setvar
:tx.header_name='/%{tx.0}/'"
SecRule "REQUEST_HEADERS_NAMES" "@rx ^(.*)$"
"phase:2,log,auditlog,chain,t:none,block,msg:'HTTP header is restricted by
policy',id:960038,tag:POLICY/HEADER_RESTRICTED,tag:POLICY/FILES_NOT_ALLOWED,
tag:WASCTC/WASC-21,tag:OWASP_TOP_10/A7,tag:PCI/12.1,tag:WASCTC/WASC-15,tag:O
WASP_TOP_10/A7,tag:PCI/12.1,severity:4,logdata:%{matched_var},capture,setvar
:tx.header_name='/%{tx.0}/'"
SecRule "REQUEST_HEADERS_NAMES" "@rx ^(.*)$"
"phase:2,log,auditlog,chain,t:none,block,msg:'HTTP header is restricted by
policy',id:960038,tag:POLICY/HEADER_RESTRICTED,tag:POLICY/FILES_NOT_ALLOWED,
tag:WASCTC/WASC-21,tag:OWASP_TOP_10/A7,tag:PCI/12.1,tag:WASCTC/WASC-15,tag:O
WASP_TOP_10/A7,tag:PCI/12.1,severity:4,logdata:%{matched_var},capture,setvar
:tx.header_name='/%{tx.0}/'"
SecRule "RESPONSE_BODY" "!@pm iframe"
"phase:4,auditlog,rev:2.1.1,t:none,capture,t:urlDecodeUni,t:htmlEntityDecode
,t:lowercase,nolog,skipAfter:END_IFRAME_CHECK"
SecRule "RESPONSE_BODY" "!@pmFromFile modsecurity_50_outbound.data"
"phase:4,auditlog,rev:2.1.1,t:none,capture,t:urlDecodeUni,t:htmlEntityDecode
,nolog,skipAfter:END_OUTBOUND_CHECK"

--342fe054-Z--




From RBarnett at trustwave.com  Tue Mar 15 14:56:05 2011
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Tue, 15 Mar 2011 13:56:05 -0500
Subject: [Owasp-modsecurity-core-rule-set] Questions about modsecurity
 rules
In-Reply-To: <00c801cbe340$36ab28f0$a4017ad0$@com>
Message-ID: <C9A52B3B.1BF80%rbarnett@trustwave.com>


On 3/15/11 2:38 PM, "Abdellah Tantan" <adtantan at paydq.com> wrote:

>
>Hi,
>
>Although I have read mod_security book by Ivan Restic, I feel I am still
>very new to Mod_Security.

Ivan's book is very good for understanding how ModSecurity works however
it does not covert rulesets such as the OWASP ModSecurity CRS.  Have you
read the project documentation?
http://www.owasp.org/index.php/Category:OWASP_ModSecurity_Core_Rule_Set_Pro
ject#tab=Documentation
>

I also suggest that you review the comments in the
modsecurity_crs_10_config.conf file as it outlines what each section does
and the rationale.


>I am wondering why sending a simple request
>triggered all these rules (see raw data bellow)?
>if the request was marked
>as critical, why it was not blocked? Any help to understand this is
>appreciated,
>
>This is my main configuration file
>
>SecComponentSignature "core ruleset/2.1.1"
>SecRuleEngine On
>SecDefaultAction "phase:2,pass,nolog,auditlog"
>SecAction "phase:1,t:none,nolog,pass,setvar:tx.anomaly_score_blocking=on"
>SecAction "phase:1,t:none,nolog,pass, \
>setvar:tx.critical_anomaly_score=5, \
>setvar:tx.error_anomaly_score=4, \
>setvar:tx.warning_anomaly_score=3, \
>setvar:tx.notice_anomaly_score=2"
>SecAction
>"phase:1,t:none,nolog,pass,setvar:tx.inbound_anomaly_score_level=5"
>SecAction
>"phase:1,t:none,nolog,pass,setvar:tx.outbound_anomaly_score_level=4"

In the modsecurity_crs_10_config.conf file, you have the following section
for HTTP Policy settings -

#
# -=[ HTTP Policy Settings ]=-
#
# Set the following policy settings here and they will be propagated to
the 30 rules
# file (modsecurity_crs_30_http_policy.conf) by using macro expansion.
# If you run into false positves, you can adjust the settings here.
#
SecAction "phase:1,t:none,nolog,pass, \
setvar:'tx.allowed_methods=GET HEAD POST OPTIONS', \
setvar:'tx.allowed_request_content_type=application/x-www-form-urlencoded
multipart/form-data text/xml application/xml application/x-amf', \
setvar:'tx.allowed_http_versions=HTTP/0.9 HTTP/1.0 HTTP/1.1', \
setvar:'tx.restricted_extensions=.asa/ .asax/ .ascx/ .axd/ .backup/ .bak/
.bat/ .cdx/ .cer/ .cfg/ .cmd/ .com/ .config/ .conf/ .cs/ .csproj/ .csr/
.dat/ .db/ .dbf/ .dll/ .dos/ .htr/ .htw/ .ida/ .idc/ .idq/ .inc/ .ini/
.key/ .licx/ .lnk/ .log/ .mdb/ .old/ .pass/ .pdb/ .pol/ .printer/ .pwd/
.resources/ .resx/ .sql/ .sys/ .vb/ .vbs/ .vbproj/ .vsdisco/ .webinfo/
.xsd/ .xsx/', \
setvar:'tx.restricted_headers=/Proxy-Connection/ /Lock-Token/
/Content-Range/ /Translate/ /via/ /if/'"


This is where you define the proper allowed http request methods for your
site.  One this is done, the rules in the
modsecurity_crs_30_http_policy.conf file enforces it using macro expansion
to inherit the settings you set in the 10 file -

# allow request methods
#
# TODO Most applications only use GET, HEAD, and POST request
#      methods. If that is not the case with your environment, you are
advised
#      to edit the line or uncomment it.
#
SecRule REQUEST_METHOD "!@within %{tx.allowed_methods}"
"phase:2,t:none,block,msg:'Method is not allowed by policy',
severity:'2',id:'960032',tag:'POLICY/METHOD_NOT_ALLOWED',tag:'WASCTC/WASC-1
5',tag:'OWASP_TOP_10/A6',tag:'OWASP_AppSensor/RE1',tag:'PCI/12.1',logdata:'
%{matched_var}',setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.w
arning_anomaly_score},setvar:tx.policy_score=+%{tx.warning_anomaly_score},s
etvar:tx.%{rule.id}-POLICY/METHOD_NOT_ALLOWED-%{matched_var_name}=%{matched
_var}"


In your case, since you were not using the full
modsecurity_crs_10_config.conf file, you had not defined these TX settings
and thus the 30 file rule matched.


Also - to your question about why this was not blocked, it looks like you
aren't using the modsecurity_49_inbound_blocking.conf file.

-Ryan


>
>
>raw data bellow.
>
>
>--342fe054-A--
>[15/Mar/2011:13:23:56 --0500] iAJfIgoAygIAAGstEDsAAAAC 66.37.224.199 52567
>10.0.202.2 80
>--342fe054-B--
>GET /lpandl/images/buttons/login.gif HTTP/1.1
>Host: 98.142.93.2
>User-Agent: Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US; rv:1.9.2.15)
>Gecko/20110303 Firefox/3.6.15
>Accept: image/png,image/*;q=0.8,*/*;q=0.5
>Accept-Language: en-us,en;q=0.5
>Accept-Encoding: gzip,deflate
>Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7
>Connection: keep-alive
>Referer:
>https://98.142.93.2/lpandl/Logon.do;jsessionid=2D2A0F2EC20B323DEFE7901DB48
>00
>52E
>Cookie: JSESSIONID=2D2A0F2EC20B323DEFE7901DB480052E
>X-Forwarded-For: 66.37.224.199
>Front-End-Https: On
>
>--342fe054-E--
>
>--342fe054-F--
>HTTP/1.1 200 OK
>ETag: W/"929-1272484876000"
>Last-Modified: Wed, 28 Apr 2010 20:01:16 GMT
>Content-Length: 929
>Connection: close
>Content-Type: image/gif
>
>--342fe054-H--
>Message: Warning. Match of "within %{tx.allowed_methods}" against
>"REQUEST_METHOD" required. [file
>"/etc/httpd/conf/modsecurity/rules/base_rules/modsecurity_crs_30_http_poli
>cy
>.conf"] [line "30"] [id "960032"] [msg "Method is not allowed by policy"]
>[data "GET"] [severity "CRITICAL"] [tag "POLICY/METHOD_NOT_ALLOWED"] [tag
>"WASCTC/WASC-15"] [tag "OWASP_TOP_10/A6"] [tag "OWASP_AppSensor/RE1"] [tag
>"PCI/12.1"]
>Message: Warning. Match of "within %{tx.allowed_http_versions}" against
>"REQUEST_PROTOCOL" required. [file
>"/etc/httpd/conf/modsecurity/rules/base_rules/modsecurity_crs_30_http_poli
>cy
>.conf"] [line "77"] [id "960034"] [msg "HTTP protocol version is not
>allowed
>by policy"] [data "HTTP/1.1"] [severity "CRITICAL"] [tag
>"POLICY/PROTOCOL_NOT_ALLOWED"] [tag "WASCTC/WASC-21"] [tag
>"OWASP_TOP_10/A6"] [tag "PCI/6.5.10"]
>Apache-Handler: jakarta-servlet
>Stopwatch: 1300213436407586 8794 (450 5600 -)
>Response-Body-Transformed: Dechunked
>Producer: ModSecurity for Apache/2.5.12 (http://www.modsecurity.org/).
>Server: Apache/2.2.3 (CentOS)
>
>--342fe054-K--
>SecRule "REQUEST_METHOD" "@rx ^(?:GET|HEAD)$"
>"phase:1,log,auditlog,chain,rev:2.1.1,t:none,block,msg:'GET or HEAD
>requests
>with
>bodies',severity:2,id:960011,tag:PROTOCOL_VIOLATION/EVASION,tag:WASCTC/WAS
>C-
>21,tag:OWASP_TOP_10/A7,tag:PCI/6.5.10,tag:http://www.w3.org/Protocols/rfc2
>61
>6/rfc2616-sec4.html#sec4.3"
>SecRule "REQUEST_METHOD" "!@rx ^OPTIONS$"
>"phase:2,log,auditlog,chain,rev:2.1.1,t:none,block,msg:'Request Missing an
>Accept
>Header',severity:2,id:960015,tag:PROTOCOL_VIOLATION/MISSING_HEADER_ACCEPT,
>ta
>g:WASCTC/WASC-21,tag:OWASP_TOP_10/A7,tag:PCI/6.5.10"
>SecRule "&REQUEST_HEADERS:Content-Type" "@eq 0"
>"phase:2,log,auditlog,chain,rev:2.1.1,t:none,block,msg:'Request Containing
>Content, but Missing Content-Type header',id:960904,severity:5"
>SecRule "REQUEST_METHOD" "!@within %{tx.allowed_methods}"
>"phase:2,log,auditlog,t:none,block,msg:'Method is not allowed by
>policy',severity:2,id:960032,tag:POLICY/METHOD_NOT_ALLOWED,tag:WASCTC/WASC
>-1
>5,tag:OWASP_TOP_10/A6,tag:OWASP_AppSensor/RE1,tag:PCI/12.1,logdata:%{match
>ed
>_var},setvar:tx.msg=%{rule.msg},setvar:tx.anomaly_score=+%{tx.warning_anom
>al
>y_score},setvar:tx.policy_score=+%{tx.warning_anomaly_score},setvar:tx.%{r
>ul
>e.id}-POLICY/METHOD_NOT_ALLOWED-%{matched_var_name}=%{matched_var}"
>SecRule "REQUEST_PROTOCOL" "!@within %{tx.allowed_http_versions}"
>"phase:2,log,auditlog,t:none,block,msg:'HTTP protocol version is not
>allowed
>by
>policy',severity:2,id:960034,tag:POLICY/PROTOCOL_NOT_ALLOWED,tag:WASCTC/WA
>SC
>-21,tag:OWASP_TOP_10/A6,tag:PCI/6.5.10,logdata:%{matched_var},setvar:tx.ms
>g=
>%{rule.msg},setvar:tx.anomaly_score=+%{tx.warning_anomaly_score},setvar:tx
>.p
>olicy_score=+%{tx.warning_anomaly_score},setvar:tx.%{rule.id}-POLICY/PROTO
>CO
>L_NOT_ALLOWED-%{matched_var_name}=%{matched_var}"
>SecRule "REQUEST_BASENAME" "@rx \\.(.*)$"
>"phase:2,log,auditlog,chain,capture,setvar:tx.extension=.%{tx.1}/,t:none,t
>:u
>rlDecodeUni,t:lowercase,block,msg:'URL file extension is restricted by
>policy',severity:2,id:960035,tag:POLICY/EXT_RESTRICTED,tag:WASCTC/WASC-15,
>ta
>g:OWASP_TOP_10/A7,tag:PCI/6.5.10,logdata:%{TX.0}"
>SecRule "REQUEST_HEADERS_NAMES" "@rx ^(.*)$"
>"phase:2,log,auditlog,chain,t:none,block,msg:'HTTP header is restricted by
>policy',id:960038,tag:POLICY/HEADER_RESTRICTED,tag:POLICY/FILES_NOT_ALLOWE
>D,
>tag:WASCTC/WASC-21,tag:OWASP_TOP_10/A7,tag:PCI/12.1,tag:WASCTC/WASC-15,tag
>:O
>WASP_TOP_10/A7,tag:PCI/12.1,severity:4,logdata:%{matched_var},capture,setv
>ar
>:tx.header_name='/%{tx.0}/'"
>SecRule "REQUEST_HEADERS_NAMES" "@rx ^(.*)$"
>"phase:2,log,auditlog,chain,t:none,block,msg:'HTTP header is restricted by
>policy',id:960038,tag:POLICY/HEADER_RESTRICTED,tag:POLICY/FILES_NOT_ALLOWE
>D,
>tag:WASCTC/WASC-21,tag:OWASP_TOP_10/A7,tag:PCI/12.1,tag:WASCTC/WASC-15,tag
>:O
>WASP_TOP_10/A7,tag:PCI/12.1,severity:4,logdata:%{matched_var},capture,setv
>ar
>:tx.header_name='/%{tx.0}/'"
>SecRule "REQUEST_HEADERS_NAMES" "@rx ^(.*)$"
>"phase:2,log,auditlog,chain,t:none,block,msg:'HTTP header is restricted by
>policy',id:960038,tag:POLICY/HEADER_RESTRICTED,tag:POLICY/FILES_NOT_ALLOWE
>D,
>tag:WASCTC/WASC-21,tag:OWASP_TOP_10/A7,tag:PCI/12.1,tag:WASCTC/WASC-15,tag
>:O
>WASP_TOP_10/A7,tag:PCI/12.1,severity:4,logdata:%{matched_var},capture,setv
>ar
>:tx.header_name='/%{tx.0}/'"
>SecRule "REQUEST_HEADERS_NAMES" "@rx ^(.*)$"
>"phase:2,log,auditlog,chain,t:none,block,msg:'HTTP header is restricted by
>policy',id:960038,tag:POLICY/HEADER_RESTRICTED,tag:POLICY/FILES_NOT_ALLOWE
>D,
>tag:WASCTC/WASC-21,tag:OWASP_TOP_10/A7,tag:PCI/12.1,tag:WASCTC/WASC-15,tag
>:O
>WASP_TOP_10/A7,tag:PCI/12.1,severity:4,logdata:%{matched_var},capture,setv
>ar
>:tx.header_name='/%{tx.0}/'"
>SecRule "REQUEST_HEADERS_NAMES" "@rx ^(.*)$"
>"phase:2,log,auditlog,chain,t:none,block,msg:'HTTP header is restricted by
>policy',id:960038,tag:POLICY/HEADER_RESTRICTED,tag:POLICY/FILES_NOT_ALLOWE
>D,
>tag:WASCTC/WASC-21,tag:OWASP_TOP_10/A7,tag:PCI/12.1,tag:WASCTC/WASC-15,tag
>:O
>WASP_TOP_10/A7,tag:PCI/12.1,severity:4,logdata:%{matched_var},capture,setv
>ar
>:tx.header_name='/%{tx.0}/'"
>SecRule "REQUEST_HEADERS_NAMES" "@rx ^(.*)$"
>"phase:2,log,auditlog,chain,t:none,block,msg:'HTTP header is restricted by
>policy',id:960038,tag:POLICY/HEADER_RESTRICTED,tag:POLICY/FILES_NOT_ALLOWE
>D,
>tag:WASCTC/WASC-21,tag:OWASP_TOP_10/A7,tag:PCI/12.1,tag:WASCTC/WASC-15,tag
>:O
>WASP_TOP_10/A7,tag:PCI/12.1,severity:4,logdata:%{matched_var},capture,setv
>ar
>:tx.header_name='/%{tx.0}/'"
>SecRule "REQUEST_HEADERS_NAMES" "@rx ^(.*)$"
>"phase:2,log,auditlog,chain,t:none,block,msg:'HTTP header is restricted by
>policy',id:960038,tag:POLICY/HEADER_RESTRICTED,tag:POLICY/FILES_NOT_ALLOWE
>D,
>tag:WASCTC/WASC-21,tag:OWASP_TOP_10/A7,tag:PCI/12.1,tag:WASCTC/WASC-15,tag
>:O
>WASP_TOP_10/A7,tag:PCI/12.1,severity:4,logdata:%{matched_var},capture,setv
>ar
>:tx.header_name='/%{tx.0}/'"
>SecRule "REQUEST_HEADERS_NAMES" "@rx ^(.*)$"
>"phase:2,log,auditlog,chain,t:none,block,msg:'HTTP header is restricted by
>policy',id:960038,tag:POLICY/HEADER_RESTRICTED,tag:POLICY/FILES_NOT_ALLOWE
>D,
>tag:WASCTC/WASC-21,tag:OWASP_TOP_10/A7,tag:PCI/12.1,tag:WASCTC/WASC-15,tag
>:O
>WASP_TOP_10/A7,tag:PCI/12.1,severity:4,logdata:%{matched_var},capture,setv
>ar
>:tx.header_name='/%{tx.0}/'"
>SecRule "REQUEST_HEADERS_NAMES" "@rx ^(.*)$"
>"phase:2,log,auditlog,chain,t:none,block,msg:'HTTP header is restricted by
>policy',id:960038,tag:POLICY/HEADER_RESTRICTED,tag:POLICY/FILES_NOT_ALLOWE
>D,
>tag:WASCTC/WASC-21,tag:OWASP_TOP_10/A7,tag:PCI/12.1,tag:WASCTC/WASC-15,tag
>:O
>WASP_TOP_10/A7,tag:PCI/12.1,severity:4,logdata:%{matched_var},capture,setv
>ar
>:tx.header_name='/%{tx.0}/'"
>SecRule "REQUEST_HEADERS_NAMES" "@rx ^(.*)$"
>"phase:2,log,auditlog,chain,t:none,block,msg:'HTTP header is restricted by
>policy',id:960038,tag:POLICY/HEADER_RESTRICTED,tag:POLICY/FILES_NOT_ALLOWE
>D,
>tag:WASCTC/WASC-21,tag:OWASP_TOP_10/A7,tag:PCI/12.1,tag:WASCTC/WASC-15,tag
>:O
>WASP_TOP_10/A7,tag:PCI/12.1,severity:4,logdata:%{matched_var},capture,setv
>ar
>:tx.header_name='/%{tx.0}/'"
>SecRule "REQUEST_HEADERS_NAMES" "@rx ^(.*)$"
>"phase:2,log,auditlog,chain,t:none,block,msg:'HTTP header is restricted by
>policy',id:960038,tag:POLICY/HEADER_RESTRICTED,tag:POLICY/FILES_NOT_ALLOWE
>D,
>tag:WASCTC/WASC-21,tag:OWASP_TOP_10/A7,tag:PCI/12.1,tag:WASCTC/WASC-15,tag
>:O
>WASP_TOP_10/A7,tag:PCI/12.1,severity:4,logdata:%{matched_var},capture,setv
>ar
>:tx.header_name='/%{tx.0}/'"
>SecRule "RESPONSE_BODY" "!@pm iframe"
>"phase:4,auditlog,rev:2.1.1,t:none,capture,t:urlDecodeUni,t:htmlEntityDeco
>de
>,t:lowercase,nolog,skipAfter:END_IFRAME_CHECK"
>SecRule "RESPONSE_BODY" "!@pmFromFile modsecurity_50_outbound.data"
>"phase:4,auditlog,rev:2.1.1,t:none,capture,t:urlDecodeUni,t:htmlEntityDeco
>de
>,nolog,skipAfter:END_OUTBOUND_CHECK"
>
>--342fe054-Z--
>
>
>
>_______________________________________________
>Owasp-modsecurity-core-rule-set mailing list
>Owasp-modsecurity-core-rule-set at lists.owasp.org
>https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>


This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.


From colin.watson at owasp.org  Wed Mar 16 05:21:00 2011
From: colin.watson at owasp.org (Colin Watson)
Date: Wed, 16 Mar 2011 09:21:00 +0000
Subject: [Owasp-modsecurity-core-rule-set] Announcing: Real-time
 Application Profiling Ruleset
In-Reply-To: <C983F4AE.1A245%rbarnett@trustwave.com>
References: <AANLkTik96s2gP+8v1CjBSPG3kT=XpKt3D0YG14KzNtwp@mail.gmail.com>
	<C983F4AE.1A245%rbarnett@trustwave.com>
Message-ID: <AANLkTim5f9pqNFNH9kqqVCnT93OYRK-72Y-8F9_UcF0C@mail.gmail.com>

Ryan

I have implemented the experimental rules on a couple of servers, one
in a production environment.  Having read the blog post at:

  http://blog.spiderlabs.com/2011/02/modsecurity-advanced-topic-of-the-week-real-time-application-profiling.html

and your reply to Lucas in this thread, I have some additional
comments.  None of these are meant to criticise the excellent work so
far, and may well reflect ideas the team already has, or are just
restating concepts in related work from Ivan Ristic, Ofer Shezaf and
Christian Bockermann.  Some of these are of course just a dream wish
list.  Anyway here goes...

Configuration
---------------

C1: I had to create an empty "modsecurity_40_profiler_ignore.data" for
the rules to work "as is" i.e. this file is not in the CRS 2.1.2
distribution.  Is the syntax of this file one URL per line?

C2: Apart from ignoring certain URLs, could we specify some parameters
to ignore (on some URLs) and on some HTTP methods?  i.e. ignore params
if GET, but enforce if POST.

C3: Could the thresholds (50 and 100) be set near the top of the rule
file, instead of within the SecAction of Step 1?

C4: Thresholds per host/site?

C5: Some application owners may know all the allowable entry
points.... it would be fantastic to have a way of defining that
profile (in XML?) which the CRS profiler could
   i) use as a base starting point, or
   ii) use as a mandatory profile, or
   iii) use to compare against when reporting discrepancies.
  This would also help to group similar URLs (e.g. paths when URL
rewriting is in use).

C6: Ability to modify model in C5 in real time (e.g. as URLs are added
created when writing a new blog post, or pages are added in a CMS)

C7: Ability for model in C5 to have the idea of "strict" and
"allowable" parameter value definitions.  Example 1: we might want a
phone number to be all numbers and spaces, but let's not get too upset
with hyphens and parentheses.  Example 2: A trailing line break on a
password could just be from copy & paste, not an attack.  So the
profiler would then need to report whether a parameter value just met
the allowable format, or failed that too.

Method
----------

M1: Accessing the same URL on multiple virtual hosts, using the same
instance of ModSecurity (and with the same web browser) seems to
create an aggregated profile rather than a profile per host (but I may
be wrong):

  http://www.example1.com/profiler.txt?site=2
  http://www.example2com/profiler.txt?site=1&day=wednesday

  Is there a way to profile each host separately?

M2: Could (or Is?) the HTTP method be part of the profile so there
could be different parameters for GET and POST for example.

M3: Further data types (bit, SQL types, UUID, lists of integers, etc),
and perhaps user-definable data types - both of these would be of more
use if C5 is implemented.

M4: Ability to allow null values for parameters e.g. normally 0 or 1
but could be NULL

M5: Build result into anomaly scoring.

Data Storage
-------------------

D1: Do you have any references for the format of this file, and of the
profiler key records, so we can try to extract data and convert it
into other formats?

Syndication of result
------------------------------

S1: Could the "result" be added as another X-WAF-... header

S2: This one isn't Profiling-specific, but currently the X-WAF-
headers are added to the request... could there be a method to pass
data on by URL (e.g. like CSP reporting mechanism), so that say even
if something is blocked it is possible to inform other devices of the
event?  The data sent could be configurable, but might include what's
currently in the X-WAF- headers, plus the original header content.


Colin



On 18 February 2011 15:11, Ryan Barnett <RBarnett at trustwave.com> wrote:
>
> On 2/18/11 9:52 AM, "Lucas Ferreira" <listas at sapao.net> wrote:
>
>>Hello Ryan,
>>
>>after reading your blog post, I still have some doubts:
>>
>>How does the profiling work with regard to restarting the web server?
>>Are the collections saved to disk?
>
> Yes - the data is saved to persistent storage files on disk. ?This would
> keep the data across Apache restarts.
>
>>
>>How can the administrator restart the profiling process? Is it
>>possible to selectively restart profiling based on host, URL or other
>>application identifier?
>
> Great question. ?We actually were talking a bit about some options for
> profile management. ?One option that we are thinking of would be to use
> dynamic updates based on access requests from "trusted" clients. ?Take a
> look at the previous blog post on GeoIP data where we talk about dynamic
> updates -
> http://blog.spiderlabs.com/2010/10/detecting-malice-with-modsecurity-geoloc
> ation-data.html
>
> The idea would be that if you wanted to remove/relearn a profile for a
> URL, you could have an authorized client send a specific request to that
> URL. ?Based on the source IP, UA + Parameter (maybe
> ?relearn_profile=true), then the saved resource collection data for that
> URL would be removed and the relearning would commence. ?There are some
> other ideas that we we need to test which could possibly include tracking
> an increase in alerts across multiple clients as this might indicate an
> application change and could initiate an auto-relearn.
>
> This is something that we are planning to add in future versions.
>
> Please keep the comments coming! ?We want people to test so that we can
> improve the capabilities.
>
> Cheers,
> Ryan
>
>>
>>Thanks,
>>
>>Lucas
>>
>>On Thu, Feb 17, 2011 at 16:27, Ryan Barnett <RBarnett at trustwave.com>
>>wrote:
>>> Hello everyone,
>>> This email will most likely come as very welcomed news to most of you.
>>>We have just released a ruleset to the OWASP CRS that implements a basic
>>>framework for real-time application profiling -
>>>
>>>http://blog.spiderlabs.com/2011/02/modsecurity-advanced-topic-of-the-week
>>>-real-time-application-profiling.html
>>>
>>> This initial version of the rules has the ability to profile and
>>>enforce the following on a per-resource basis:
>>>
>>> ?* ? Request Method(s)
>>> ?* ? Number of Parameters
>>> ?* ? Parameter Names
>>> ?* ? Parameter Length Ranges
>>> ?* ? Parameter Types - numeric or alpha
>>>
>>> Please test out this ruleset and provide feedback on the OWASP CRS
>>>mail-list.
>>>
>>> Cheers,
>>> Ryan
>>>
>>>
>>> ________________________________
>>> This transmission may contain information that is privileged,
>>>confidential, and/or exempt from disclosure under applicable law. If you
>>>are not the intended recipient, you are hereby notified that any
>>>disclosure, copying, distribution, or use of the information contained
>>>herein (including any reliance thereon) is STRICTLY PROHIBITED. If you
>>>received this transmission in error, please immediately contact the
>>>sender and destroy the material in its entirety, whether in electronic
>>>or hard copy format.
>>>
>>> _______________________________________________
>>> Owasp-modsecurity-core-rule-set mailing list
>>> Owasp-modsecurity-core-rule-set at lists.owasp.org
>>> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>>>
>>
>>
>>
>>--
>>Homo sapiens non urinat in ventum.
>>
>
>
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>

From dreamice.jiang at gmail.com  Thu Mar 17 01:37:30 2011
From: dreamice.jiang at gmail.com (dreamice)
Date: Thu, 17 Mar 2011 13:37:30 +0800
Subject: [Owasp-modsecurity-core-rule-set] RESPONSE_CONTENT_LENGTH and
	RESPONSE_HEADERS:Content-Length not work
Message-ID: <AANLkTi=+ghv8ddHFyn+zRFD6a2kYjwoT1+vfeUvtCR7O@mail.gmail.com>

Dear all,

I tested the var RESPONSE_CONTENT_LENGTH and RESPONSE_HEADERS:Content-Length
in phase 3, but it seems that they do not work well.
rules like:
SecRule REQUEST_HEADERS:Content-Length "@gt 150"
"phase:1,t:none,deny,log,auditlog'"
SecRule RESPONSE_HEADERS:Content-Length "@gt 150"
"phase:3,t:none,pass,log,auditlog"

the response content length is  more than 150 bytes, but the rule get no
effects.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20110317/f44e738b/attachment.html 

From RBarnett at trustwave.com  Thu Mar 17 04:45:17 2011
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Thu, 17 Mar 2011 03:45:17 -0500
Subject: [Owasp-modsecurity-core-rule-set] RESPONSE_CONTENT_LENGTH and
 RESPONSE_HEADERS:Content-Length not work
In-Reply-To: <AANLkTi=+ghv8ddHFyn+zRFD6a2kYjwoT1+vfeUvtCR7O@mail.gmail.com>
References: <AANLkTi=+ghv8ddHFyn+zRFD6a2kYjwoT1+vfeUvtCR7O@mail.gmail.com>
Message-ID: <CC79F222-EF31-480C-BDD3-02653038DED1@trustwave.com>

Can you show an audit log entry?

On Mar 17, 2011, at 1:37 AM, dreamice <dreamice.jiang at gmail.com> wrote:

> Dear all,
>
> I tested the var RESPONSE_CONTENT_LENGTH and RESPONSE_HEADERS:Content-Length in phase 3, but it seems that they do not work well.
> rules like:
> SecRule REQUEST_HEADERS:Content-Length "@gt 150" "phase:1,t:none,deny,log,auditlog'"
> SecRule RESPONSE_HEADERS:Content-Length "@gt 150" "phase:3,t:none,pass,log,auditlog"
>
> the response content length is  more than 150 bytes, but the rule get no effects.
>
>
>
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set

This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.


From RBarnett at trustwave.com  Thu Mar 17 17:19:00 2011
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Thu, 17 Mar 2011 16:19:00 -0500
Subject: [Owasp-modsecurity-core-rule-set] ModSecurity Advanced Topic of the
	Week: Malware Link Detection
Message-ID: <C9A7F302.1C18D%rbarnett@trustwave.com>

I just posted a blog post outlining a really cool new feature in ModSecurity v2.6 (which is available in SVN trunk if you want to try it out) -

http://blog.spiderlabs.com/2011/03/modsecurity-advanced-topic-of-the-week-malware-link-detection.html

-Ryan

________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.


From RBarnett at trustwave.com  Fri Mar 18 09:36:48 2011
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Fri, 18 Mar 2011 08:36:48 -0500
Subject: [Owasp-modsecurity-core-rule-set] Announcing: Real-time
 Application Profiling Ruleset
In-Reply-To: <AANLkTim5f9pqNFNH9kqqVCnT93OYRK-72Y-8F9_UcF0C@mail.gmail.com>
Message-ID: <C9A8C846.1C1DE%rbarnett@trustwave.com>


On 3/16/11 5:21 AM, "Colin Watson" <colin.watson at owasp.org> wrote:

>Ryan
>
>I have implemented the experimental rules on a couple of servers, one
>in a production environment.

Does it seem to be working as expected?

>Having read the blog post at:
>
>
>http://blog.spiderlabs.com/2011/02/modsecurity-advanced-topic-of-the-week-
>real-time-application-profiling.html
>
>and your reply to Lucas in this thread, I have some additional
>comments.  None of these are meant to criticise the excellent work so
>far, and may well reflect ideas the team already has, or are just
>restating concepts in related work from Ivan Ristic, Ofer Shezaf and
>Christian Bockermann.  Some of these are of course just a dream wish
>list.  Anyway here goes...

Feedback is always welcome!  This version of the rules was merely the
first step.  There are many improvements that we can make.

>
>Configuration
>---------------
>
>C1: I had to create an empty "modsecurity_40_profiler_ignore.data" for
>the rules to work "as is" i.e. this file is not in the CRS 2.1.2
>distribution.

Ah right.  I will update the comment text for "Ignore Resource" in the
file that if the file is not present that you have to create one.  I guess
we could have the default also be that these two SecRules are commented
out by default.  If a user wants to ignore profiling/enforcement for
certain resources, then they can uncomment these lines and then create the
.data file.

>Is the syntax of this file one URL per line?

Yes - see the Notes section of @pmFromFile -
http://sourceforge.net/apps/mediawiki/mod-security/index.php?title=Referenc
e_Manual#pmFromFile

>
>C2: Apart from ignoring certain URLs, could we specify some parameters
>to ignore (on some URLs) and on some HTTP methods?  i.e. ignore params
>if GET, but enforce if POST.

In ModSecurity v2.6 (available in trunk) we added the
SecRuleUpdateTargetById (and ctl:ruleUpdateTargetById) -
http://sourceforge.net/apps/mediawiki/mod-security/index.php?title=Referenc
e_Manual#SecRuleUpdateTargetById

This capability will allow you to create chained rules with the
ctl:ruleUpdateTargetById to dynamically exclude ARGS from validation.

Of course in looking at these rules, we do need to assign rule IDs to them
for this to work.

>
>C3: Could the thresholds (50 and 100) be set near the top of the rule
>file, instead of within the SecAction of Step 1?

Well, it is the first configurable setting in the file.  What issue would
this solve?  We want to try and keep consistency with the CRS banner info
at the top and then I wanted to have a small intro section of text about
the detection.

>
>C4: Thresholds per host/site?
>
>C5: Some application owners may know all the allowable entry
>points.... it would be fantastic to have a way of defining that
>profile (in XML?) which the CRS profiler could
>   i) use as a base starting point, or
>   ii) use as a mandatory profile, or
>   iii) use to compare against when reporting discrepancies.
>  This would also help to group similar URLs (e.g. paths when URL
>rewriting is in use).

So if an organization actually had an XML map/profile of their entry
points right?  Hmm, you know what would be cool is to have something
similar to @validateSchema but called something like @validateProfile.
This would be able to parse an XML file that defines the allowable site
tree profile and then block/alert when request data that doesn't match.
That would be pretty cool.  :)  I guess the next step would be to come to
an agreed upon Site profile schema.  I think this is where your references
to Ivan's Recipes (http://www.modsecurity.org/projects/ppr/) and Chris
Bockermann's Web Profiles (http://jwall.org/web/policy/index.jsp) comes in
as we would need a standard method of defining an app profile.

>
>C6: Ability to modify model in C5 in real time (e.g. as URLs are added
>created when writing a new blog post, or pages are added in a CMS)

Agreed.  The way it is implemented currently with the CRS profiler rules,
however, is on a per-resource basis anyways.  So if you have a new
resource that is dynamically created by a CMS then it will begin to be
profiled.

>
>C7: Ability for model in C5 to have the idea of "strict" and
>"allowable" parameter value definitions.  Example 1: we might want a
>phone number to be all numbers and spaces, but let's not get too upset
>with hyphens and parentheses.  Example 2: A trailing line break on a
>password could just be from copy & paste, not an attack.  So the
>profiler would then need to report whether a parameter value just met
>the allowable format, or failed that too.

This is referencing the AppSensor model of categorizing the event as
either Suspicious or Malicious.  As you can see in the rules, I have
mapped each rule to the corresponding AppSensor Detection point.  For
example -
tag:'OWASP_AppSensor/RE1'

My view is that these profiler rules only identify Suspicious events as
they don't match an expected learned profile.  In order to determine
Malicious events, the CRS should be run in Anomaly Scoring Mode
(http://blog.spiderlabs.com/2010/11/advanced-topic-of-the-week-traditional-
vs-anomaly-scoring-detection-modes.html) so that the transaction continues
into the other blacklist CRS rules to verify if there are XSS, SQLi attack
payloads, etc...  The profiler rules will increase an anomaly score and it
is set at a slightly lower severity level than attack rules (that have a
critical level) -

setvar:tx.profiler_score=+%{tx.error_anomaly_score}

>
>Method
>----------
>
>M1: Accessing the same URL on multiple virtual hosts, using the same
>instance of ModSecurity (and with the same web browser) seems to
>create an aggregated profile rather than a profile per host (but I may
>be wrong):
>
>  http://www.example1.com/profiler.txt?site=2
>  http://www.example2com/profiler.txt?site=1&day=wednesday
>
>  Is there a way to profile each host separately?

Good point - I think that we need to expand the RESOURCE collection data
so that it can utilize the SecWebAppId directive data in the same way that
the setsid does so the collections are per-site.

>
>M2: Could (or Is?) the HTTP method be part of the profile so there
>could be different parameters for GET and POST for example.

I see your point as there may be different parameters that are valid based
on the Request Method.  We could do that with a new SecAction line at the
beginning like this -

SecAction
"phase:1,t:none,nolog,pass,initcol:resource=%{REQUEST_FILENAME}_%{REQUEST_M
ETHOD},setvar:resource.pattern_threshold=50,setvar:resource.confidence_coun
ter_threshold=100"

The only issue I see is if a client sends a request to a resource with a
different REQUEST_METHOD, then it will create its own resource collection.
 So how would we validate which request methods are valid/allowed?  I
guess we could rely upon the app's response (HTTP Status Code of 405 -
Method Not Allowed) to let us know if the request was valid in this case
and then remove the collection.

>
>M3: Further data types (bit, SQL types, UUID, lists of integers, etc),
>and perhaps user-definable data types - both of these would be of more
>use if C5 is implemented.

I have a long list of other parameter types to add but I wanted to this
framework out for testing.

>
>M4: Ability to allow null values for parameters e.g. normally 0 or 1
>but could be NULL

Yeah, the RegEx length range checks are a but crude... Do you mean that a
param payload could be:

- foo.php?param=1
- foo.php?param=0
- foo.php?param

In these cases, the parameter named "param" might match both of these
length checks -

SecRule ARGS "^0$"
"phase:5,t:none,t:length,nolog,pass,setvar:resource.args_length_check0_%{ma
tched_var_name}=+1"
SecRule ARGS "^[1-5]$"
"phase:5,t:none,t:length,nolog,pass,setvar:resource.args_length_check1_%{ma
tched_var_name}=+1"


And then added to either the resource.args_length_check0_enforce or
resource.args_length_check1_enforce variable lists for enforcement.  It
would depend upon how often the param was empty/NULL.

>
>M5: Build result into anomaly scoring.

You mean something more than what is already there?  We already have two
levels of anomaly scoring built it -

- Contribution to the overall anomaly score
setvar:tx.anomaly_score=+%{tx.error_anomaly_score}

- Contribution to a "profiler" anomaly score which would allow a user to
add custom blocking level just for profiler check scores.
setvar:tx.profiler_score=+%{tx.error_anomaly_score}

>
>Data Storage
>-------------------
>
>D1: Do you have any references for the format of this file, and of the
>profiler key records, so we can try to extract data and convert it
>into other formats?

You mean the data stored in the RESOURCE collections?  If so, I would
recommend using Christian Bockermann's jwall-tools java app so you can
view collection data outside of the Debug log -
https://www.jwall.org/tools/jwall-tools.jsp.  Perhaps Chris could update
the tools to extract RESOURCE collection data and translate it to an XML
profile.

Another cool idea would be for the jwall-tools to be able to actually
manipulate the RESOURCE collection data!  That would allow for some manual
tweaking of a profile rather than having to just delete and relearn it.

>
>Syndication of result
>------------------------------
>
>S1: Could the "result" be added as another X-WAF-... Header

They should already be added to the default list of match events.  But if
you want a separate one, we could do that.

>
>S2: This one isn't Profiling-specific, but currently the X-WAF-
>headers are added to the request... could there be a method to pass
>data on by URL (e.g. like CSP reporting mechanism), so that say even
>if something is blocked it is possible to inform other devices of the
>event?  The data sent could be configurable, but might include what's
>currently in the X-WAF- headers, plus the original header content.

Just so I understand - we would block the original request but then send a
new HTTP request out from the WAF to other security devices with the X-WAF
data as URL parameters?  You should be able to do that by using the
"exec:" action and just write a script that will use something like
curl/wget to send the HTTP request and populate the data you need.  I will
test this out.

Thanks for the awesome feedback Colin!

-Ryan


>
>
>Colin
>
>
>
>On 18 February 2011 15:11, Ryan Barnett <RBarnett at trustwave.com> wrote:
>>
>> On 2/18/11 9:52 AM, "Lucas Ferreira" <listas at sapao.net> wrote:
>>
>>>Hello Ryan,
>>>
>>>after reading your blog post, I still have some doubts:
>>>
>>>How does the profiling work with regard to restarting the web server?
>>>Are the collections saved to disk?
>>
>> Yes - the data is saved to persistent storage files on disk.  This would
>> keep the data across Apache restarts.
>>
>>>
>>>How can the administrator restart the profiling process? Is it
>>>possible to selectively restart profiling based on host, URL or other
>>>application identifier?
>>
>> Great question.  We actually were talking a bit about some options for
>> profile management.  One option that we are thinking of would be to use
>> dynamic updates based on access requests from "trusted" clients.  Take a
>> look at the previous blog post on GeoIP data where we talk about dynamic
>> updates -
>>
>>http://blog.spiderlabs.com/2010/10/detecting-malice-with-modsecurity-geol
>>oc
>> ation-data.html
>>
>> The idea would be that if you wanted to remove/relearn a profile for a
>> URL, you could have an authorized client send a specific request to that
>> URL.  Based on the source IP, UA + Parameter (maybe
>> ?relearn_profile=true), then the saved resource collection data for that
>> URL would be removed and the relearning would commence.  There are some
>> other ideas that we we need to test which could possibly include
>>tracking
>> an increase in alerts across multiple clients as this might indicate an
>> application change and could initiate an auto-relearn.
>>
>> This is something that we are planning to add in future versions.
>>
>> Please keep the comments coming!  We want people to test so that we can
>> improve the capabilities.
>>
>> Cheers,
>> Ryan
>>
>>>
>>>Thanks,
>>>
>>>Lucas
>>>
>>>On Thu, Feb 17, 2011 at 16:27, Ryan Barnett <RBarnett at trustwave.com>
>>>wrote:
>>>> Hello everyone,
>>>> This email will most likely come as very welcomed news to most of you.
>>>>We have just released a ruleset to the OWASP CRS that implements a
>>>>basic
>>>>framework for real-time application profiling -
>>>>
>>>>http://blog.spiderlabs.com/2011/02/modsecurity-advanced-topic-of-the-we
>>>>ek
>>>>-real-time-application-profiling.html
>>>>
>>>> This initial version of the rules has the ability to profile and
>>>>enforce the following on a per-resource basis:
>>>>
>>>>  *   Request Method(s)
>>>>  *   Number of Parameters
>>>>  *   Parameter Names
>>>>  *   Parameter Length Ranges
>>>>  *   Parameter Types - numeric or alpha
>>>>
>>>> Please test out this ruleset and provide feedback on the OWASP CRS
>>>>mail-list.
>>>>
>>>> Cheers,
>>>> Ryan
>>>>
>>>>
>>>> ________________________________
>>>> This transmission may contain information that is privileged,
>>>>confidential, and/or exempt from disclosure under applicable law. If
>>>>you
>>>>are not the intended recipient, you are hereby notified that any
>>>>disclosure, copying, distribution, or use of the information contained
>>>>herein (including any reliance thereon) is STRICTLY PROHIBITED. If you
>>>>received this transmission in error, please immediately contact the
>>>>sender and destroy the material in its entirety, whether in electronic
>>>>or hard copy format.
>>>>
>>>> _______________________________________________
>>>> Owasp-modsecurity-core-rule-set mailing list
>>>> Owasp-modsecurity-core-rule-set at lists.owasp.org
>>>>
>>>>https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-se
>>>>t
>>>>
>>>
>>>
>>>
>>>--
>>>Homo sapiens non urinat in ventum.
>>>
>>
>>
>> _______________________________________________
>> Owasp-modsecurity-core-rule-set mailing list
>> Owasp-modsecurity-core-rule-set at lists.owasp.org
>> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>>
>_______________________________________________
>Owasp-modsecurity-core-rule-set mailing list
>Owasp-modsecurity-core-rule-set at lists.owasp.org
>https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>


This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.


From owasp at yonahruss.com  Sun Mar 20 05:51:31 2011
From: owasp at yonahruss.com (Yonah Russ)
Date: Sun, 20 Mar 2011 11:51:31 +0200
Subject: [Owasp-modsecurity-core-rule-set] CRS 2.1.1 Brute Force rules not
	blocking requests
Message-ID: <AANLkTin913rNZx5cr+OrmgK-PPMHAh5_z_oekOhQhkNL@mail.gmail.com>

Hi,

I'm using 2.5.13 with CRS 2.1.1
I've configured the following:

SecAction "phase:1,t:none,nolog,pass, \
setvar:'tx.brute_force_protected_urls=/protected_url /protected_url2', \
setvar:'tx.brute_force_burst_time_slice=60', \
setvar:'tx.brute_force_counter_threshold=5', \
setvar:'tx.brute_force_block_timeout=300'"

When I test, all the requests get through and not even a message in the logs
:(
Here is an excerpt from the debug log:
...
[20/Mar/2011:09:15:56 +0000] [
www.site.com/sid#12b7778][rid#19211a0][/protected_url][9] Setting variable:
tx.brute_force_protected_urls=/protected_url /protected_url2
[20/Mar/2011:09:15:56 +0000] [
www.site.com/sid#12b7778][rid#19211a0][/protected_url][9] Set variable
"tx.brute_force_protected_urls" to "/protected_url /protected_url2".
[20/Mar/2011:09:15:56 +0000] [
www.site.com/sid#12b7778][rid#19211a0][/protected_url][9] Setting variable:
tx.brute_force_burst_time_slice=60
[20/Mar/2011:09:15:56 +0000] [
www.site.com/sid#12b7778][rid#19211a0][/protected_url][9] Set variable
"tx.brute_force_burst_time_slice" to "60".
[20/Mar/2011:09:15:56 +0000] [
www.site.com/sid#12b7778][rid#19211a0][/protected_url][9] Setting variable:
tx.brute_force_counter_threshold=5
[20/Mar/2011:09:15:56 +0000] [
www.site.com/sid#12b7778][rid#19211a0][/protected_url][9] Set variable
"tx.brute_force_counter_threshold" to "5".
[20/Mar/2011:09:15:56 +0000] [
www.site.com/sid#12b7778][rid#19211a0][/protected_url][9] Setting variable:
tx.brute_force_block_timeout=300
[20/Mar/2011:09:15:56 +0000] [
www.site.com/sid#12b7778][rid#19211a0][/protected_url][9] Set variable
"tx.brute_force_block_timeout" to "300".
...
[20/Mar/2011:09:15:56 +0000] [
www.site.com/sid#12b7778][rid#19211a0][/protected_url][4] Creating
collection (name "global", key "global").
[20/Mar/2011:09:15:56 +0000] [
www.site.com/sid#12b7778][rid#19211a0][/protected_url][9] Recorded original
collection variable: global.UPDATE_COUNTER = "0"
[20/Mar/2011:09:15:56 +0000] [
www.site.com/sid#12b7778][rid#19211a0][/protected_url][4] Added collection
"global" to the list.
[20/Mar/2011:09:15:56 +0000] [
www.site.com/sid#12b7778][rid#19211a0][/protected_url][9] Resolved macro
%{remote_addr} to: 192.168.1.1
[20/Mar/2011:09:15:56 +0000] [
www.site.com/sid#12b7778][rid#19211a0][/protected_url][9] Resolved macro
%{tx.ua_hash} to: 3dcbbff145dcf13aa6287b931eb296b39b7541ee
[20/Mar/2011:09:15:56 +0000] [
www.site.com/sid#12b7778][rid#19211a0][/protected_url][9] Read variable:
name "__expire_KEY", value "1300615158".
[20/Mar/2011:09:15:56 +0000] [
www.site.com/sid#12b7778][rid#19211a0][/protected_url][9] Read variable:
name "KEY", value "192.168.1.1_3dcbbff145dcf13aa6287b931eb296b39b7541ee".
[20/Mar/2011:09:15:56 +0000] [
www.site.com/sid#12b7778][rid#19211a0][/protected_url][9] Read variable:
name "TIMEOUT", value "3600".
[20/Mar/2011:09:15:56 +0000] [
www.site.com/sid#12b7778][rid#19211a0][/protected_url][9] Read variable:
name "__key", value "192.168.1.1_3dcbbff145dcf13aa6287b931eb296b39b7541ee".
[20/Mar/2011:09:15:56 +0000] [
www.site.com/sid#12b7778][rid#19211a0][/protected_url][9] Read variable:
name "__name", value "ip".
[20/Mar/2011:09:15:56 +0000] [
www.site.com/sid#12b7778][rid#19211a0][/protected_url][9] Read variable:
name "CREATE_TIME", value "1300607334".
[20/Mar/2011:09:15:56 +0000] [
www.site.com/sid#12b7778][rid#19211a0][/protected_url][9] Read variable:
name "UPDATE_COUNTER", value "75".
[20/Mar/2011:09:15:56 +0000] [
www.site.com/sid#12b7778][rid#19211a0][/protected_url][9] Read variable:
name "dos_counter", value "75".
[20/Mar/2011:09:15:56 +0000] [
www.site.com/sid#12b7778][rid#19211a0][/protected_url][9] Read variable:
name "LAST_UPDATE_TIME", value "1300611558".
[20/Mar/2011:09:15:56 +0000] [
www.site.com/sid#12b7778][rid#19211a0][/protected_url][4] Retrieved
collection (name "ip", key
"192.168.1.1_3dcbbff145dcf13aa6287b931eb296b39b7541ee").
[20/Mar/2011:09:15:56 +0000] [
www.site.com/sid#12b7778][rid#19211a0][/protected_url][9] Recorded original
collection variable: ip.UPDATE_COUNTER = "75"
[20/Mar/2011:09:15:56 +0000] [
www.site.com/sid#12b7778][rid#19211a0][/protected_url][4] Added collection
"ip" to the list.
...
[20/Mar/2011:09:15:56 +0000] [
www.site.com/sid#12b7778][rid#19211a0][/protected_url][5] Rule 240d78:
SecRule "IP:BRUTE_FORCE_BLOCK" "@eq 1"
"phase:1,log,noauditlog,chain,block,msg:'Brute Force Attack Identified from
%{remote_addr} (%{tx.brute_force_block_counter} hits since last
alert)',setvar:ip.brute_force_block_counter=+1"
[20/Mar/2011:09:15:56 +0000] [
www.site.com/sid#12b7778][rid#19211a0][/protected_url][4] Rule returned 0.
[20/Mar/2011:09:15:56 +0000] [
www.site.com/sid#12b7778][rid#19211a0][/protected_url][9] No match, chained
-> mode NEXT_CHAIN.
[20/Mar/2011:09:15:56 +0000] [
www.site.com/sid#12b7778][rid#19211a0][/protected_url][4] Recipe: Invoking
rule 244cd8; [file
"/opt/www/conf/modsecurity_crs/base_rules/modsecurity_crs_11_brute_force.conf"]
[line "27"].
[20/Mar/2011:09:15:56 +0000] [
www.site.com/sid#12b7778][rid#19211a0][/protected_url][5] Rule 244cd8:
SecRule "IP:BRUTE_FORCE_BLOCK" "@eq 1"
"phase:1,noauditlog,block,nolog,setvar:ip.brute_force_block_counter=+1"
[20/Mar/2011:09:15:56 +0000] [
www.site.com/sid#12b7778][rid#19211a0][/protected_url][4] Rule returned 0.
[20/Mar/2011:09:15:56 +0000] [
www.site.com/sid#12b7778][rid#19211a0][/protected_url][9] No match, not
chained -> mode NEXT_RULE.
[20/Mar/2011:09:15:56 +0000] [
www.site.com/sid#12b7778][rid#19211a0][/protected_url][4] Recipe: Invoking
rule 250338; [file
"/opt/www/conf/modsecurity_crs/base_rules/modsecurity_crs_11_dos_protection.conf"]
[line "11"].
[20/Mar/2011:09:15:56 +0000] [
www.site.com/sid#12b7778][rid#19211a0][/protected_url][5] Rule 250338:
SecRule "IP:DOS_BLOCK" "@eq 1"
"phase:1,log,noauditlog,chain,drop,msg:'Denial of Service (DoS) Attack
Identified from %{remote_addr} (%{tx.dos_block_counter} hits since last
alert)',setvar:ip.dos_block_counter=+1"
[20/Mar/2011:09:15:56 +0000] [
www.site.com/sid#12b7778][rid#19211a0][/protected_url][4] Rule returned 0.

>From what I can see, the request never hits the section of rules which
should start counting the requests to the protected url. Instead, it skips
to the next ruleset?
Thanks in advance,
Yonah
-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20110320/a1284287/attachment.html 

From RBarnett at trustwave.com  Sun Mar 20 09:56:04 2011
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Sun, 20 Mar 2011 08:56:04 -0500
Subject: [Owasp-modsecurity-core-rule-set] CRS 2.1.1 Brute Force rules
 not blocking requests
In-Reply-To: <AANLkTin913rNZx5cr+OrmgK-PPMHAh5_z_oekOhQhkNL@mail.gmail.com>
References: <AANLkTin913rNZx5cr+OrmgK-PPMHAh5_z_oekOhQhkNL@mail.gmail.com>
Message-ID: <D2DE2415-CDD2-4B24-8E22-C5EE345C8115@trustwave.com>

Are your protected URLs that you define in the 10 file setvars full paths to the login page(s)?  The check in the brute force file checks these variables against the REQUEST_FILENAME of the current transaction. You sanitized your example configs (/protected_url) so I am not sure if you defined a filename or a directory.

An audit log entry would help.

On Mar 20, 2011, at 5:51 AM, Yonah Russ <owasp at yonahruss.com<mailto:owasp at yonahruss.com>> wrote:

Hi,

I'm using 2.5.13 with CRS 2.1.1
I've configured the following:

SecAction "phase:1,t:none,nolog,pass, \
setvar:'tx.brute_force_protected_urls=/protected_url /protected_url2', \
setvar:'tx.brute_force_burst_time_slice=60', \
setvar:'tx.brute_force_counter_threshold=5', \
setvar:'tx.brute_force_block_timeout=300'"

When I test, all the requests get through and not even a message in the logs :(
Here is an excerpt from the debug log:
...
[20/Mar/2011:09:15:56 +0000] [<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Setting variable: tx.brute_force_protected_urls=/protected_url /protected_url2
[20/Mar/2011:09:15:56 +0000] [<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Set variable "tx.brute_force_protected_urls" to "/protected_url /protected_url2".
[20/Mar/2011:09:15:56 +0000] [<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Setting variable: tx.brute_force_burst_time_slice=60
[20/Mar/2011:09:15:56 +0000] [<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Set variable "tx.brute_force_burst_time_slice" to "60".
[20/Mar/2011:09:15:56 +0000] [<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Setting variable: tx.brute_force_counter_threshold=5
[20/Mar/2011:09:15:56 +0000] [<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Set variable "tx.brute_force_counter_threshold" to "5".
[20/Mar/2011:09:15:56 +0000] [<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Setting variable: tx.brute_force_block_timeout=300
[20/Mar/2011:09:15:56 +0000] [<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Set variable "tx.brute_force_block_timeout" to "300".
...
[20/Mar/2011:09:15:56 +0000] [<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Creating collection (name "global", key "global").
[20/Mar/2011:09:15:56 +0000] [<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Recorded original collection variable: global.UPDATE_COUNTER = "0"
[20/Mar/2011:09:15:56 +0000] [<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Added collection "global" to the list.
[20/Mar/2011:09:15:56 +0000] [<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Resolved macro %{remote_addr} to: 192.168.1.1
[20/Mar/2011:09:15:56 +0000] [<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Resolved macro %{tx.ua_hash} to: 3dcbbff145dcf13aa6287b931eb296b39b7541ee
[20/Mar/2011:09:15:56 +0000] [<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read variable: name "__expire_KEY", value "1300615158".
[20/Mar/2011:09:15:56 +0000] [<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read variable: name "KEY", value "192.168.1.1_3dcbbff145dcf13aa6287b931eb296b39b7541ee".
[20/Mar/2011:09:15:56 +0000] [<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read variable: name "TIMEOUT", value "3600".
[20/Mar/2011:09:15:56 +0000] [<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read variable: name "__key", value "192.168.1.1_3dcbbff145dcf13aa6287b931eb296b39b7541ee".
[20/Mar/2011:09:15:56 +0000] [<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read variable: name "__name", value "ip".
[20/Mar/2011:09:15:56 +0000] [<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read variable: name "CREATE_TIME", value "1300607334".
[20/Mar/2011:09:15:56 +0000] [<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read variable: name "UPDATE_COUNTER", value "75".
[20/Mar/2011:09:15:56 +0000] [<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read variable: name "dos_counter", value "75".
[20/Mar/2011:09:15:56 +0000] [<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read variable: name "LAST_UPDATE_TIME", value "1300611558".
[20/Mar/2011:09:15:56 +0000] [<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Retrieved collection (name "ip", key "192.168.1.1_3dcbbff145dcf13aa6287b931eb296b39b7541ee").
[20/Mar/2011:09:15:56 +0000] [<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Recorded original collection variable: ip.UPDATE_COUNTER = "75"
[20/Mar/2011:09:15:56 +0000] [<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Added collection "ip" to the list.
...
[20/Mar/2011:09:15:56 +0000] [<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>www.site.com/sid#12b7778][rid#19211a0][/protected_url][5<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>] Rule 240d78: SecRule "IP:BRUTE_FORCE_BLOCK" "@eq 1" "phase:1,log,noauditlog,chain,block,msg:'Brute Force Attack Identified from %{remote_addr} (%{tx.brute_force_block_counter} hits since last alert)',setvar:ip.brute_force_block_counter=+1"
[20/Mar/2011:09:15:56 +0000] [<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Rule returned 0.
[20/Mar/2011:09:15:56 +0000] [<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] No match, chained -> mode NEXT_CHAIN.
[20/Mar/2011:09:15:56 +0000] [<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Recipe: Invoking rule 244cd8; [file "/opt/www/conf/modsecurity_crs/base_rules/modsecurity_crs_11_brute_force.conf"] [line "27"].
[20/Mar/2011:09:15:56 +0000] [<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>www.site.com/sid#12b7778][rid#19211a0][/protected_url][5<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>] Rule 244cd8: SecRule "IP:BRUTE_FORCE_BLOCK" "@eq 1" "phase:1,noauditlog,block,nolog,setvar:ip.brute_force_block_counter=+1"
[20/Mar/2011:09:15:56 +0000] [<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Rule returned 0.
[20/Mar/2011:09:15:56 +0000] [<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] No match, not chained -> mode NEXT_RULE.
[20/Mar/2011:09:15:56 +0000] [<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Recipe: Invoking rule 250338; [file "/opt/www/conf/modsecurity_crs/base_rules/modsecurity_crs_11_dos_protection.conf"] [line "11"].
[20/Mar/2011:09:15:56 +0000] [<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>www.site.com/sid#12b7778][rid#19211a0][/protected_url][5<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>] Rule 250338: SecRule "IP:DOS_BLOCK" "@eq 1" "phase:1,log,noauditlog,chain,drop,msg:'Denial of Service (DoS) Attack Identified from %{remote_addr} (%{tx.dos_block_counter} hits since last alert)',setvar:ip.dos_block_counter=+1"
[20/Mar/2011:09:15:56 +0000] [<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Rule returned 0.

From what I can see, the request never hits the section of rules which should start counting the requests to the protected url. Instead, it skips to the next ruleset?
Thanks in advance,
Yonah

_______________________________________________
Owasp-modsecurity-core-rule-set mailing list
Owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:Owasp-modsecurity-core-rule-set at lists.owasp.org>
https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set

________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.

From owasp at yonahruss.com  Sun Mar 20 13:40:57 2011
From: owasp at yonahruss.com (Yonah Russ)
Date: Sun, 20 Mar 2011 19:40:57 +0200
Subject: [Owasp-modsecurity-core-rule-set] CRS 2.1.1 Brute Force rules
 not blocking requests
In-Reply-To: <D2DE2415-CDD2-4B24-8E22-C5EE345C8115@trustwave.com>
References: <AANLkTin913rNZx5cr+OrmgK-PPMHAh5_z_oekOhQhkNL@mail.gmail.com>
	<D2DE2415-CDD2-4B24-8E22-C5EE345C8115@trustwave.com>
Message-ID: <AANLkTinn_kEYvZbkoyNGsN2eMshasXephNt7T2-_n-SL@mail.gmail.com>

Hi,

The short answer is that there are are no directories defined - just full
paths.

The long answer is that there are also no actual filenames- the requests are
handled by a content engine doing friendly urls. The defined urls are the
friendly ones- so apache gets a request for www.site.com/protected_url and
uses mod_rewrite to send it to engine.php - Does that make a difference for
REQUEST_FILENAME?

Thanks,
Yonah


On Sun, Mar 20, 2011 at 3:56 PM, Ryan Barnett <RBarnett at trustwave.com>wrote:

> Are your protected URLs that you define in the 10 file setvars full paths
> to the login page(s)?  The check in the brute force file checks these
> variables against the REQUEST_FILENAME of the current transaction. You
> sanitized your example configs (/protected_url) so I am not sure if you
> defined a filename or a directory.
>
> An audit log entry would help.
>
> On Mar 20, 2011, at 5:51 AM, Yonah Russ <owasp at yonahruss.com<mailto:
> owasp at yonahruss.com>> wrote:
>
> Hi,
>
> I'm using 2.5.13 with CRS 2.1.1
> I've configured the following:
>
> SecAction "phase:1,t:none,nolog,pass, \
> setvar:'tx.brute_force_protected_urls=/protected_url /protected_url2', \
> setvar:'tx.brute_force_burst_time_slice=60', \
> setvar:'tx.brute_force_counter_threshold=5', \
> setvar:'tx.brute_force_block_timeout=300'"
>
> When I test, all the requests get through and not even a message in the
> logs :(
> Here is an excerpt from the debug log:
> ...
> [20/Mar/2011:09:15:56 +0000] [<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Setting
> variable: tx.brute_force_protected_urls=/protected_url /protected_url2
> [20/Mar/2011:09:15:56 +0000] [<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Set
> variable "tx.brute_force_protected_urls" to "/protected_url
> /protected_url2".
> [20/Mar/2011:09:15:56 +0000] [<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Setting
> variable: tx.brute_force_burst_time_slice=60
> [20/Mar/2011:09:15:56 +0000] [<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Set
> variable "tx.brute_force_burst_time_slice" to "60".
> [20/Mar/2011:09:15:56 +0000] [<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Setting
> variable: tx.brute_force_counter_threshold=5
> [20/Mar/2011:09:15:56 +0000] [<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Set
> variable "tx.brute_force_counter_threshold" to "5".
> [20/Mar/2011:09:15:56 +0000] [<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Setting
> variable: tx.brute_force_block_timeout=300
> [20/Mar/2011:09:15:56 +0000] [<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Set
> variable "tx.brute_force_block_timeout" to "300".
> ...
> [20/Mar/2011:09:15:56 +0000] [<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Creating
> collection (name "global", key "global").
> [20/Mar/2011:09:15:56 +0000] [<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Recorded
> original collection variable: global.UPDATE_COUNTER = "0"
> [20/Mar/2011:09:15:56 +0000] [<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Added
> collection "global" to the list.
> [20/Mar/2011:09:15:56 +0000] [<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Resolved
> macro %{remote_addr} to: 192.168.1.1
> [20/Mar/2011:09:15:56 +0000] [<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Resolved
> macro %{tx.ua_hash} to: 3dcbbff145dcf13aa6287b931eb296b39b7541ee
> [20/Mar/2011:09:15:56 +0000] [<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read
> variable: name "__expire_KEY", value "1300615158".
> [20/Mar/2011:09:15:56 +0000] [<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read
> variable: name "KEY", value
> "192.168.1.1_3dcbbff145dcf13aa6287b931eb296b39b7541ee".
> [20/Mar/2011:09:15:56 +0000] [<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read
> variable: name "TIMEOUT", value "3600".
> [20/Mar/2011:09:15:56 +0000] [<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read
> variable: name "__key", value
> "192.168.1.1_3dcbbff145dcf13aa6287b931eb296b39b7541ee".
> [20/Mar/2011:09:15:56 +0000] [<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read
> variable: name "__name", value "ip".
> [20/Mar/2011:09:15:56 +0000] [<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read
> variable: name "CREATE_TIME", value "1300607334".
> [20/Mar/2011:09:15:56 +0000] [<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read
> variable: name "UPDATE_COUNTER", value "75".
> [20/Mar/2011:09:15:56 +0000] [<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read
> variable: name "dos_counter", value "75".
> [20/Mar/2011:09:15:56 +0000] [<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read
> variable: name "LAST_UPDATE_TIME", value "1300611558".
> [20/Mar/2011:09:15:56 +0000] [<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>]
> Retrieved collection (name "ip", key
> "192.168.1.1_3dcbbff145dcf13aa6287b931eb296b39b7541ee").
> [20/Mar/2011:09:15:56 +0000] [<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Recorded
> original collection variable: ip.UPDATE_COUNTER = "75"
> [20/Mar/2011:09:15:56 +0000] [<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Added
> collection "ip" to the list.
> ...
> [20/Mar/2011:09:15:56 +0000] [<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][5<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>] Rule
> 240d78: SecRule "IP:BRUTE_FORCE_BLOCK" "@eq 1"
> "phase:1,log,noauditlog,chain,block,msg:'Brute Force Attack Identified from
> %{remote_addr} (%{tx.brute_force_block_counter} hits since last
> alert)',setvar:ip.brute_force_block_counter=+1"
> [20/Mar/2011:09:15:56 +0000] [<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Rule
> returned 0.
> [20/Mar/2011:09:15:56 +0000] [<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] No
> match, chained -> mode NEXT_CHAIN.
> [20/Mar/2011:09:15:56 +0000] [<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Recipe:
> Invoking rule 244cd8; [file
> "/opt/www/conf/modsecurity_crs/base_rules/modsecurity_crs_11_brute_force.conf"]
> [line "27"].
> [20/Mar/2011:09:15:56 +0000] [<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][5<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>] Rule
> 244cd8: SecRule "IP:BRUTE_FORCE_BLOCK" "@eq 1"
> "phase:1,noauditlog,block,nolog,setvar:ip.brute_force_block_counter=+1"
> [20/Mar/2011:09:15:56 +0000] [<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Rule
> returned 0.
> [20/Mar/2011:09:15:56 +0000] [<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] No
> match, not chained -> mode NEXT_RULE.
> [20/Mar/2011:09:15:56 +0000] [<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Recipe:
> Invoking rule 250338; [file
> "/opt/www/conf/modsecurity_crs/base_rules/modsecurity_crs_11_dos_protection.conf"]
> [line "11"].
> [20/Mar/2011:09:15:56 +0000] [<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][5<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>] Rule
> 250338: SecRule "IP:DOS_BLOCK" "@eq 1"
> "phase:1,log,noauditlog,chain,drop,msg:'Denial of Service (DoS) Attack
> Identified from %{remote_addr} (%{tx.dos_block_counter} hits since last
> alert)',setvar:ip.dos_block_counter=+1"
> [20/Mar/2011:09:15:56 +0000] [<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Rule
> returned 0.
>
> From what I can see, the request never hits the section of rules which
> should start counting the requests to the protected url. Instead, it skips
> to the next ruleset?
> Thanks in advance,
> Yonah
>
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:
> Owasp-modsecurity-core-rule-set at lists.owasp.org>
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>
> ________________________________
> This transmission may contain information that is privileged, confidential,
> and/or exempt from disclosure under applicable law. If you are not the
> intended recipient, you are hereby notified that any disclosure, copying,
> distribution, or use of the information contained herein (including any
> reliance thereon) is STRICTLY PROHIBITED. If you received this transmission
> in error, please immediately contact the sender and destroy the material in
> its entirety, whether in electronic or hard copy format.
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20110320/8a6274b0/attachment-0001.html 

From RBarnett at trustwave.com  Sun Mar 20 16:26:35 2011
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Sun, 20 Mar 2011 15:26:35 -0500
Subject: [Owasp-modsecurity-core-rule-set] CRS 2.1.1 Brute Force rules
 not blocking requests
In-Reply-To: <AANLkTinn_kEYvZbkoyNGsN2eMshasXephNt7T2-_n-SL@mail.gmail.com>
References: <AANLkTin913rNZx5cr+OrmgK-PPMHAh5_z_oekOhQhkNL@mail.gmail.com>
	<D2DE2415-CDD2-4B24-8E22-C5EE345C8115@trustwave.com>
	<AANLkTinn_kEYvZbkoyNGsN2eMshasXephNt7T2-_n-SL@mail.gmail.com>
Message-ID: <78F150E6-842C-428B-80DE-74334F8DAF88@trustwave.com>

The brute force rules that count the # of requests and set the block variable actually run in phase 5 logging.  The section of the debug log you showed was from phase 1 where it is deciding to block or not.  Please check later on in the debug log to see how these rules are working.

On Mar 20, 2011, at 1:40 PM, Yonah Russ <owasp at yonahruss.com<mailto:owasp at yonahruss.com>> wrote:

Hi,

The short answer is that there are are no directories defined - just full paths.

The long answer is that there are also no actual filenames- the requests are handled by a content engine doing friendly urls. The defined urls are the friendly ones- so apache gets a request for <http://www.site.com/protected_url> www.site.com/protected_url<http://www.site.com/protected_url> and uses mod_rewrite to send it to engine.php - Does that make a difference for REQUEST_FILENAME?

Thanks,
Yonah


On Sun, Mar 20, 2011 at 3:56 PM, Ryan Barnett <<mailto:RBarnett at trustwave.com>RBarnett at trustwave.com<mailto:RBarnett at trustwave.com>> wrote:
Are your protected URLs that you define in the 10 file setvars full paths to the login page(s)?  The check in the brute force file checks these variables against the REQUEST_FILENAME of the current transaction. You sanitized your example configs (/protected_url) so I am not sure if you defined a filename or a directory.

An audit log entry would help.

On Mar 20, 2011, at 5:51 AM, Yonah Russ <<mailto:owasp at yonahruss.com>owasp at yonahruss.com<mailto:owasp at yonahruss.com><mailto:<mailto:owasp at yonahruss.com>owasp at yonahruss.com<mailto:owasp at yonahruss.com>>> wrote:

Hi,

I'm using 2.5.13 with CRS 2.1.1
I've configured the following:

SecAction "phase:1,t:none,nolog,pass, \
setvar:'tx.brute_force_protected_urls=/protected_url /protected_url2', \
setvar:'tx.brute_force_burst_time_slice=60', \
setvar:'tx.brute_force_counter_threshold=5', \
setvar:'tx.brute_force_block_timeout=300'"

When I test, all the requests get through and not even a message in the logs :(
Here is an excerpt from the debug log:
...
[20/Mar/2011:09:15:56 +0000] [<<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Setting variable: tx.brute_force_protected_urls=/protected_url /protected_url2
[20/Mar/2011:09:15:56 +0000] [<<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Set variable "tx.brute_force_protected_urls" to "/protected_url /protected_url2".
[20/Mar/2011:09:15:56 +0000] [<<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Setting variable: tx.brute_force_burst_time_slice=60
[20/Mar/2011:09:15:56 +0000] [<<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Set variable "tx.brute_force_burst_time_slice" to "60".
[20/Mar/2011:09:15:56 +0000] [<<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Setting variable: tx.brute_force_counter_threshold=5
[20/Mar/2011:09:15:56 +0000] [<<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Set variable "tx.brute_force_counter_threshold" to "5".
[20/Mar/2011:09:15:56 +0000] [<<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Setting variable: tx.brute_force_block_timeout=300
[20/Mar/2011:09:15:56 +0000] [<<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Set variable "tx.brute_force_block_timeout" to "300".
...
[20/Mar/2011:09:15:56 +0000] [<<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Creating collection (name "global", key "global").
[20/Mar/2011:09:15:56 +0000] [<<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Recorded original collection variable: global.UPDATE_COUNTER = "0"
[20/Mar/2011:09:15:56 +0000] [<<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Added collection "global" to the list.
[20/Mar/2011:09:15:56 +0000] [<<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Resolved macro %{remote_addr} to: 192.168.1.1
[20/Mar/2011:09:15:56 +0000] [<<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Resolved macro %{tx.ua_hash} to: 3dcbbff145dcf13aa6287b931eb296b39b7541ee
[20/Mar/2011:09:15:56 +0000] [<<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read variable: name "__expire_KEY", value "1300615158".
[20/Mar/2011:09:15:56 +0000] [<<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read variable: name "KEY", value "192.168.1.1_3dcbbff145dcf13aa6287b931eb296b39b7541ee".
[20/Mar/2011:09:15:56 +0000] [<<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read variable: name "TIMEOUT", value "3600".
[20/Mar/2011:09:15:56 +0000] [<<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read variable: name "__key", value "192.168.1.1_3dcbbff145dcf13aa6287b931eb296b39b7541ee".
[20/Mar/2011:09:15:56 +0000] [<<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read variable: name "__name", value "ip".
[20/Mar/2011:09:15:56 +0000] [<<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read variable: name "CREATE_TIME", value "1300607334".
[20/Mar/2011:09:15:56 +0000] [<<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read variable: name "UPDATE_COUNTER", value "75".
[20/Mar/2011:09:15:56 +0000] [<<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read variable: name "dos_counter", value "75".
[20/Mar/2011:09:15:56 +0000] [<<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read variable: name "LAST_UPDATE_TIME", value "1300611558".
[20/Mar/2011:09:15:56 +0000] [<<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Retrieved collection (name "ip", key "192.168.1.1_3dcbbff145dcf13aa6287b931eb296b39b7541ee").
[20/Mar/2011:09:15:56 +0000] [<<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Recorded original collection variable: ip.UPDATE_COUNTER = "75"
[20/Mar/2011:09:15:56 +0000] [<<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Added collection "ip" to the list.
...
[20/Mar/2011:09:15:56 +0000] [<<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5><http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>www.site.com/sid#12b7778][rid#19211a0][/protected_url][5<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5><<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>] Rule 240d78: SecRule "IP:BRUTE_FORCE_BLOCK" "@eq 1" "phase:1,log,noauditlog,chain,block,msg:'Brute Force Attack Identified from %{remote_addr} (%{tx.brute_force_block_counter} hits since last alert)',setvar:ip.brute_force_block_counter=+1"
[20/Mar/2011:09:15:56 +0000] [<<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Rule returned 0.
[20/Mar/2011:09:15:56 +0000] [<<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] No match, chained -> mode NEXT_CHAIN.
[20/Mar/2011:09:15:56 +0000] [<<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Recipe: Invoking rule 244cd8; [file "/opt/www/conf/modsecurity_crs/base_rules/modsecurity_crs_11_brute_force.conf"] [line "27"].
[20/Mar/2011:09:15:56 +0000] [<<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5><http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>www.site.com/sid#12b7778][rid#19211a0][/protected_url][5<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5><<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>] Rule 244cd8: SecRule "IP:BRUTE_FORCE_BLOCK" "@eq 1" "phase:1,noauditlog,block,nolog,setvar:ip.brute_force_block_counter=+1"
[20/Mar/2011:09:15:56 +0000] [<<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Rule returned 0.
[20/Mar/2011:09:15:56 +0000] [<<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] No match, not chained -> mode NEXT_RULE.
[20/Mar/2011:09:15:56 +0000] [<<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Recipe: Invoking rule 250338; [file "/opt/www/conf/modsecurity_crs/base_rules/modsecurity_crs_11_dos_protection.conf"] [line "11"].
[20/Mar/2011:09:15:56 +0000] [<<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5><http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>www.site.com/sid#12b7778][rid#19211a0][/protected_url][5<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5><<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>] Rule 250338: SecRule "IP:DOS_BLOCK" "@eq 1" "phase:1,log,noauditlog,chain,drop,msg:'Denial of Service (DoS) Attack Identified from %{remote_addr} (%{tx.dos_block_counter} hits since last alert)',setvar:ip.dos_block_counter=+1"
[20/Mar/2011:09:15:56 +0000] [<<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><<http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Rule returned 0.

>From what I can see, the request never hits the section of rules which should start counting the requests to the protected url. Instead, it skips to the next ruleset?
Thanks in advance,
Yonah

_______________________________________________
Owasp-modsecurity-core-rule-set mailing list
<mailto:Owasp-modsecurity-core-rule-set at lists.owasp.org>Owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:Owasp-modsecurity-core-rule-set at lists.owasp.org><mailto:<mailto:Owasp-modsecurity-core-rule-set at lists.owasp.org>Owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:Owasp-modsecurity-core-rule-set at lists.owasp.org>>
<https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set>https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set

________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.

_______________________________________________
Owasp-modsecurity-core-rule-set mailing list
Owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:Owasp-modsecurity-core-rule-set at lists.owasp.org>
https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set

________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.

From colin.watson at owasp.org  Mon Mar 21 05:08:49 2011
From: colin.watson at owasp.org (Colin Watson)
Date: Mon, 21 Mar 2011 09:08:49 +0000
Subject: [Owasp-modsecurity-core-rule-set] Announcing: Real-time
 Application Profiling Ruleset
In-Reply-To: <C9A8C846.1C1DE%rbarnett@trustwave.com>
References: <AANLkTim5f9pqNFNH9kqqVCnT93OYRK-72Y-8F9_UcF0C@mail.gmail.com>
	<C9A8C846.1C1DE%rbarnett@trustwave.com>
Message-ID: <AANLkTi=GV-7GsiE11ye8zU+34VV9=dXWBsKpGagb7F5m@mail.gmail.com>

Ryan

Comments inline.  If we need to discuss any of these further (and most
don't), perhaps we should start separate threads?

On 18 March 2011 13:36, Ryan Barnett <RBarnett at trustwave.com> wrote:
>
> On 3/16/11 5:21 AM, "Colin Watson" <colin.watson at owasp.org> wrote:
>
>>Ryan
>>
>>I have implemented the experimental rules on a couple of servers, one
>>in a production environment.
>
> Does it seem to be working as expected?

I should have said so - yes it works as expected.


>>Having read the blog post at:
>>
>>
>>http://blog.spiderlabs.com/2011/02/modsecurity-advanced-topic-of-the-week-
>>real-time-application-profiling.html
>>
>>and your reply to Lucas in this thread, I have some additional
>>comments. ?None of these are meant to criticise the excellent work so
>>far, and may well reflect ideas the team already has, or are just
>>restating concepts in related work from Ivan Ristic, Ofer Shezaf and
>>Christian Bockermann. ?Some of these are of course just a dream wish
>>list. ?Anyway here goes...
>
> Feedback is always welcome! ?This version of the rules was merely the
> first step. ?There are many improvements that we can make.
>
>>
>>Configuration
>>---------------
>>
>>C1: I had to create an empty "modsecurity_40_profiler_ignore.data" for
>>the rules to work "as is" i.e. this file is not in the CRS 2.1.2
>>distribution.
>
> Ah right. ?I will update the comment text for "Ignore Resource" in the
> file that if the file is not present that you have to create one. ?I guess
> we could have the default also be that these two SecRules are commented
> out by default. ?If a user wants to ignore profiling/enforcement for
> certain resources, then they can uncomment these lines and then create the
> .data file.
>
>>Is the syntax of this file one URL per line?
>
> Yes - see the Notes section of @pmFromFile -
> http://sourceforge.net/apps/mediawiki/mod-security/index.php?title=Referenc
> e_Manual#pmFromFile

Great thanks, I should have looked there.


>>C2: Apart from ignoring certain URLs, could we specify some parameters
>>to ignore (on some URLs) and on some HTTP methods? ?i.e. ignore params
>>if GET, but enforce if POST.
>
> In ModSecurity v2.6 (available in trunk) we added the
> SecRuleUpdateTargetById (and ctl:ruleUpdateTargetById) -
> http://sourceforge.net/apps/mediawiki/mod-security/index.php?title=Referenc
> e_Manual#SecRuleUpdateTargetById
>
> This capability will allow you to create chained rules with the
> ctl:ruleUpdateTargetById to dynamically exclude ARGS from validation.
>
> Of course in looking at these rules, we do need to assign rule IDs to them
> for this to work.

Noted, thanks.


>>
>>C3: Could the thresholds (50 and 100) be set near the top of the rule
>>file, instead of within the SecAction of Step 1?
>
> Well, it is the first configurable setting in the file. ?What issue would
> this solve? ?We want to try and keep consistency with the CRS banner info
> at the top and then I wanted to have a small intro section of text about
> the detection.

You're probably right... they are not that difficult to find/set.


>>
>>C4: Thresholds per host/site?
>>
>>C5: Some application owners may know all the allowable entry
>>points.... it would be fantastic to have a way of defining that
>>profile (in XML?) which the CRS profiler could
>> ? i) use as a base starting point, or
>> ? ii) use as a mandatory profile, or
>> ? iii) use to compare against when reporting discrepancies.
>> ?This would also help to group similar URLs (e.g. paths when URL
>>rewriting is in use).
>
> So if an organization actually had an XML map/profile of their entry
> points right? ?Hmm, you know what would be cool is to have something
> similar to @validateSchema but called something like @validateProfile.
> This would be able to parse an XML file that defines the allowable site
> tree profile and then block/alert when request data that doesn't match.
> That would be pretty cool. ?:)

Yes it would.  Even on complex sites, it might be possible for source
code scanning tools to identify all the entry points (and types), and
they might be able to export a profile.

I currently export sets of ModSecurity rules to do this for one site
where the entry points are defined in a database.  But it's not very
efficient, and a profile schema/processor would be better.

The specified profile could also be used to compare against the
learned profile to look for gaps and discrepancies.


>I guess the next step would be to come to
> an agreed upon Site profile schema. ?I think this is where your references
> to Ivan's Recipes (http://www.modsecurity.org/projects/ppr/) and Chris
> Bockermann's Web Profiles (http://jwall.org/web/policy/index.jsp) comes in
> as we would need a standard method of defining an app profile.

Yes, that would be the way forward - maybe a separate project?


>>
>>C6: Ability to modify model in C5 in real time (e.g. as URLs are added
>>created when writing a new blog post, or pages are added in a CMS)
>
> Agreed. ?The way it is implemented currently with the CRS profiler rules,
> however, is on a per-resource basis anyways. ?So if you have a new
> resource that is dynamically created by a CMS then it will begin to be
> profiled.
>
>>
>>C7: Ability for model in C5 to have the idea of "strict" and
>>"allowable" parameter value definitions. ?Example 1: we might want a
>>phone number to be all numbers and spaces, but let's not get too upset
>>with hyphens and parentheses. ?Example 2: A trailing line break on a
>>password could just be from copy & paste, not an attack. ?So the
>>profiler would then need to report whether a parameter value just met
>>the allowable format, or failed that too.
>
> This is referencing the AppSensor model of categorizing the event as
> either Suspicious or Malicious. ?As you can see in the rules, I have
> mapped each rule to the corresponding AppSensor Detection point. ?For
> example -
> tag:'OWASP_AppSensor/RE1'
>
> My view is that these profiler rules only identify Suspicious events as
> they don't match an expected learned profile. ?In order to determine
> Malicious events, the CRS should be run in Anomaly Scoring Mode
> (http://blog.spiderlabs.com/2010/11/advanced-topic-of-the-week-traditional-
> vs-anomaly-scoring-detection-modes.html) so that the transaction continues
> into the other blacklist CRS rules to verify if there are XSS, SQLi attack
> payloads, etc... ?The profiler rules will increase an anomaly score and it
> is set at a slightly lower severity level than attack rules (that have a
> critical level) -
>
> setvar:tx.profiler_score=+%{tx.error_anomaly_score}

Of course if the profile was defined, rather than learned, we could be
more definitive about malicious vs. suspicious.  But we'd also have to
take into account non-malicious URL requests (e.g.
http://www.clerkendweller.com/2010/10/26/Benign-Unexpected-URLs-Part-1-Missing-Files
) giving a softer edge to the application's profile.


>>
>>Method
>>----------
>>
>>M1: Accessing the same URL on multiple virtual hosts, using the same
>>instance of ModSecurity (and with the same web browser) seems to
>>create an aggregated profile rather than a profile per host (but I may
>>be wrong):
>>
>> ?http://www.example1.com/profiler.txt?site=2
>> ?http://www.example2com/profiler.txt?site=1&day=wednesday
>>
>> ?Is there a way to profile each host separately?
>
> Good point - I think that we need to expand the RESOURCE collection data
> so that it can utilize the SecWebAppId directive data in the same way that
> the setsid does so the collections are per-site.

Noted.


>>
>>M2: Could (or Is?) the HTTP method be part of the profile so there
>>could be different parameters for GET and POST for example.
>
> I see your point as there may be different parameters that are valid based
> on the Request Method. ?We could do that with a new SecAction line at the
> beginning like this -
>
> SecAction
> "phase:1,t:none,nolog,pass,initcol:resource=%{REQUEST_FILENAME}_%{REQUEST_M
> ETHOD},setvar:resource.pattern_threshold=50,setvar:resource.confidence_coun
> ter_threshold=100"
>
> The only issue I see is if a client sends a request to a resource with a
> different REQUEST_METHOD, then it will create its own resource collection.
> ?So how would we validate which request methods are valid/allowed? ?I
> guess we could rely upon the app's response (HTTP Status Code of 405 -
> Method Not Allowed) to let us know if the request was valid in this case
> and then remove the collection.

Yes there are difficulties with this, and I don't have good answers
for profiling.


>>
>>M3: Further data types (bit, SQL types, UUID, lists of integers, etc),
>>and perhaps user-definable data types - both of these would be of more
>>use if C5 is implemented.
>
> I have a long list of other parameter types to add but I wanted to this
> framework out for testing.

Yes, I guessed so!


>>
>>M4: Ability to allow null values for parameters e.g. normally 0 or 1
>>but could be NULL
>
> Yeah, the RegEx length range checks are a but crude... Do you mean that a
> param payload could be:
>
> - foo.php?param=1
> - foo.php?param=0
> - foo.php?param

Yes, and

- foo.php?param=

in case that's different from your last example.

> In these cases, the parameter named "param" might match both of these
> length checks -
>
> SecRule ARGS "^0$"
> "phase:5,t:none,t:length,nolog,pass,setvar:resource.args_length_check0_%{ma
> tched_var_name}=+1"
> SecRule ARGS "^[1-5]$"
> "phase:5,t:none,t:length,nolog,pass,setvar:resource.args_length_check1_%{ma
> tched_var_name}=+1"
>
>
> And then added to either the resource.args_length_check0_enforce or
> resource.args_length_check1_enforce variable lists for enforcement. ?It
> would depend upon how often the param was empty/NULL.


>>
>>M5: Build result into anomaly scoring.
>
> You mean something more than what is already there? ?We already have two
> levels of anomaly scoring built it -
>
> - Contribution to the overall anomaly score
> setvar:tx.anomaly_score=+%{tx.error_anomaly_score}
>
> - Contribution to a "profiler" anomaly score which would allow a user to
> add custom blocking level just for profiler check scores.
> setvar:tx.profiler_score=+%{tx.error_anomaly_score}

No, you are correct - this is sufficient as it is.


>>
>>Data Storage
>>-------------------
>>
>>D1: Do you have any references for the format of this file, and of the
>>profiler key records, so we can try to extract data and convert it
>>into other formats?
>
> You mean the data stored in the RESOURCE collections? ?If so, I would
> recommend using Christian Bockermann's jwall-tools java app so you can
> view collection data outside of the Debug log -
> https://www.jwall.org/tools/jwall-tools.jsp. ?Perhaps Chris could update
> the tools to extract RESOURCE collection data and translate it to an XML
> profile.
>
> Another cool idea would be for the jwall-tools to be able to actually
> manipulate the RESOURCE collection data! ?That would allow for some manual
> tweaking of a profile rather than having to just delete and relearn it.

That's sounds interesting, I'll take a look.


>>
>>Syndication of result
>>------------------------------
>>
>>S1: Could the "result" be added as another X-WAF-... Header
>
> They should already be added to the default list of match events. ?But if
> you want a separate one, we could do that.

Thinking to the future, there may be more information we want to send
regarding the Profiler findings (actual parameter results, comparison
to learned profile, comparison to defined profile).  Therefore a
separate item now might be of use (as well)?


>>
>>S2: This one isn't Profiling-specific, but currently the X-WAF-
>>headers are added to the request... could there be a method to pass
>>data on by URL (e.g. like CSP reporting mechanism), so that say even
>>if something is blocked it is possible to inform other devices of the
>>event? ?The data sent could be configurable, but might include what's
>>currently in the X-WAF- headers, plus the original header content.
>
> Just so I understand - we would block the original request but then send a
> new HTTP request out from the WAF to other security devices with the X-WAF
> data as URL parameters?

Yes, but also even if ModSecurity doesn't block... potentially for all
requests.  The HTTP requests might be to a different host/port than
the application being protected.

> ?You should be able to do that by using the
> "exec:" action and just write a script that will use something like
> curl/wget to send the HTTP request and populate the data you need. ?I will
> test this out.

That sounds like the way.

Regards

Colin

From owasp at yonahruss.com  Mon Mar 21 07:05:11 2011
From: owasp at yonahruss.com (Yonah Russ)
Date: Mon, 21 Mar 2011 13:05:11 +0200
Subject: [Owasp-modsecurity-core-rule-set] CRS 2.1.1 Brute Force rules
 not blocking requests
In-Reply-To: <78F150E6-842C-428B-80DE-74334F8DAF88@trustwave.com>
References: <AANLkTin913rNZx5cr+OrmgK-PPMHAh5_z_oekOhQhkNL@mail.gmail.com>
	<D2DE2415-CDD2-4B24-8E22-C5EE345C8115@trustwave.com>
	<AANLkTinn_kEYvZbkoyNGsN2eMshasXephNt7T2-_n-SL@mail.gmail.com>
	<78F150E6-842C-428B-80DE-74334F8DAF88@trustwave.com>
Message-ID: <AANLkTikwH0f0SdkOeHJS-v2uvxr1bmgnxvTzY8_Gr1pX@mail.gmail.com>

(repost with zipped logs)
Hi,

I went looking for more related log messages and at first I didn't find any,
so I disabled all the rule sets except the brute force rules, cleared the
logs,  and I see something strange.

I only made one request to the 'friendly url' /protected/url but when the
debug log hits the logging phase the request(?) changes to the actual file
name of the content engine (/engine.php):
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][4<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B4>]
Recipe: Invoking rule 167a60; [file "/opt/www/conf/modsecurity_
crs/base_rules/modsecurity_crs_11_brute_force.conf"] [line "22"].
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][5<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B5>]
Rule 167a60: SecRule "IP:BRUTE_FORCE_BLOCK" "@eq 1"
"phase:1,log,noauditlog,chain,block,msg:'Brute Force Attack Identified from
%{remote_addr} (%{tx.brute_force_block_counter} hits since last
alert)',setvar:ip.brute_force_block_counter=+1"
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][4<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B4>]
Rule returned 0.
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][9<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B9>]
No match, chained -> mode NEXT_CHAIN.
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][4<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B4>]
Recipe: Invoking rule 1699a0; [file
"/opt/www/conf/modsecurity_crs/base_rules/modsecurity_crs_11_brute_force.conf"]
[line "27"].
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][5<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B5>]
Rule 1699a0: SecRule "IP:BRUTE_FORCE_BLOCK" "@eq 1"
"phase:1,noauditlog,block,nolog,setvar:ip.brute_force_block_counter=+1"
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][4<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B4>]
Rule returned 0.
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][9<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B9>]
No match, not chained -> mode NEXT_RULE.
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][4<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B4>]
PdfProtect: Not enabled here.
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][4<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B4>]
Second phase starting (dcfg e5e10).
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][4<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B4>]
Input filter: This request does not have a body.
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][4<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B4>]
Time #1: 36569
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][4<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B4>]
Starting phase REQUEST_BODY.
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][9<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B9>]
This phase consists of 1 rule(s).
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][4<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B4>]
Time #2: 36917
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][4<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B4>]
Hook insert_filter: Adding PDF XSS protection output filter (r 368d68).
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][4<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B4>]
Hook insert_filter: Adding output filter (r 368d68).
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][4<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B4>]
Initialising logging.
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][4<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B4>]
Starting phase LOGGING.
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][9<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B9>]
This phase consists of 7 rule(s).
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][4<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B4>]
Recipe: Invoking rule 16c0f0; [file
"/opt/www/conf/modsecurity_crs/base_rules/modsecurity_crs_11_brute_force.conf"]
[line "37"].
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][5<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B5>]
Rule 16c0f0: SecRule "&TX:BRUTE_FORCE_PROTECTED_URLS" "@eq 0"
"phase:5,noauditlog,t:none,nolog,skipAfter:END_BRUTE_FORCE_PROTECTION_CHECKS"
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][4<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B4>]
Transformation completed in 7 usec.
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][4<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B4>]
Executing operator "eq" with param "0" against
&TX:BRUTE_FORCE_PROTECTED_URLS.
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][9<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B9>]
Target value: "1"
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][4<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B4>]
Operator completed in 12 usec.
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][4<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B4>]
Rule returned 0.
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][9<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B9>]
No match, not chained -> mode NEXT_RULE.
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][4<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B4>]
Recipe: Invoking rule 16c9f8; [file
"/opt/www/conf/modsecurity_crs/base_rules/modsecurity_crs_11_brute_force.conf"]
[line "38"].
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][5<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B5>]
Rule 16c9f8: SecRule "REQUEST_FILENAME" "!@within
%{tx.brute_force_protected_urls}"
"phase:5,noauditlog,t:none,nolog,skipAfter:END_BRUTE_FORCE_PROTECTION_CHECKS"
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][4<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B4>]
Transformation completed in 4 usec.
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][4<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B4>]
Executing operator "!within" with param "%{tx.brute_force_protected_urls}"
against REQUEST_FILENAME.
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][9<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B9>]
Target value: "/engine.php"
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][9<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B9>]
Resolved macro %{tx.brute_force_protected_urls} to: /protected/url
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][4<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B4>]
Operator completed in 593 usec.
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][4<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B4>]
Warning. Match of "within %{tx.brute_force_protected_urls}" against
"REQUEST_FILENAME" required. [file
"/opt/www/conf/modsecurity_crs/base_rules/modsecurity_crs_11_brute_force.conf"]
[line "38"]
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][4<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B4>]
Rule returned 1.
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][9<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B9>]
Skipping after rule 16c9f8 id="END_BRUTE_FORCE_PROTECTION_CHECKS" -> mode
SKIP_RULES.
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][9<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B9>]
Current rule is id="(null)" [chained 0] is trying to find the
SecMarker="END_BRUTE_FORCE_PROTECTION_CHECKS" [stater 0]
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][9<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B9>]
Current rule is id="(null)" [chained 0] is trying to find the
SecMarker="END_BRUTE_FORCE_PROTECTION_CHECKS" [stater 0]
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][9<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B9>]
Current rule is id="(null)" [chained 0] is trying to find the
SecMarker="END_BRUTE_FORCE_PROTECTION_CHECKS" [stater 0]
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][9<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B9>]
Current rule is id="(null)" [chained 0] is trying to find the
SecMarker="END_BRUTE_FORCE_PROTECTION_CHECKS" [stater 0]
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][9<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B9>]
Found rule 176a48 id="END_BRUTE_FORCE_PROTECTION_CHECKS".
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][4<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B4>]
Continuing execution after rule id="END_BRUTE_FORCE_PROTECTION_CHECKS".
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][4<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B4>]
Audit log: Logging this transaction.
[21/Mar/2011:09:35:58 +0000] [
192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][9<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B9>]
Audit Log: Writing 256 bytes to primary concurrent index


I've attached the sanitized debug and audit logs for the request.

Also- here is the rewrite rule which sends friendly-url requests to the
content engine:
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^(.*)$ /engine.php?q=$1 [L,QSA]

Thanks,
Yonah


On Sun, Mar 20, 2011 at 10:26 PM, Ryan Barnett <RBarnett at trustwave.com>wrote:

> The brute force rules that count the # of requests and set the block
> variable actually run in phase 5 logging.  The section of the debug log you
> showed was from phase 1 where it is deciding to block or not.  Please check
> later on in the debug log to see how these rules are working.
>
> On Mar 20, 2011, at 1:40 PM, Yonah Russ <owasp at yonahruss.com<mailto:
> owasp at yonahruss.com>> wrote:
>
> Hi,
>
> The short answer is that there are are no directories defined - just full
> paths.
>
> The long answer is that there are also no actual filenames- the requests
> are handled by a content engine doing friendly urls. The defined urls are
> the friendly ones- so apache gets a request for <
> http://www.site.com/protected_url> www.site.com/protected_url<
> http://www.site.com/protected_url> and uses mod_rewrite to send it to
> engine.php - Does that make a difference for REQUEST_FILENAME?
>
> Thanks,
> Yonah
>
>
> On Sun, Mar 20, 2011 at 3:56 PM, Ryan Barnett <<mailto:
> RBarnett at trustwave.com>RBarnett at trustwave.com<mailto:
> RBarnett at trustwave.com>> wrote:
> Are your protected URLs that you define in the 10 file setvars full paths
> to the login page(s)?  The check in the brute force file checks these
> variables against the REQUEST_FILENAME of the current transaction. You
> sanitized your example configs (/protected_url) so I am not sure if you
> defined a filename or a directory.
>
> An audit log entry would help.
>
> On Mar 20, 2011, at 5:51 AM, Yonah Russ <<mailto:owasp at yonahruss.com>
> owasp at yonahruss.com<mailto:owasp at yonahruss.com><mailto:<mailto:
> owasp at yonahruss.com>owasp at yonahruss.com<mailto:owasp at yonahruss.com>>>
> wrote:
>
> Hi,
>
> I'm using 2.5.13 with CRS 2.1.1
> I've configured the following:
>
> SecAction "phase:1,t:none,nolog,pass, \
> setvar:'tx.brute_force_protected_urls=/protected_url /protected_url2', \
> setvar:'tx.brute_force_burst_time_slice=60', \
> setvar:'tx.brute_force_counter_threshold=5', \
> setvar:'tx.brute_force_block_timeout=300'"
>
> When I test, all the requests get through and not even a message in the
> logs :(
> Here is an excerpt from the debug log:
> ...
> [20/Mar/2011:09:15:56 +0000] [<<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Setting
> variable: tx.brute_force_protected_urls=/protected_url /protected_url2
> [20/Mar/2011:09:15:56 +0000] [<<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Set
> variable "tx.brute_force_protected_urls" to "/protected_url
> /protected_url2".
> [20/Mar/2011:09:15:56 +0000] [<<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Setting
> variable: tx.brute_force_burst_time_slice=60
> [20/Mar/2011:09:15:56 +0000] [<<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Set
> variable "tx.brute_force_burst_time_slice" to "60".
> [20/Mar/2011:09:15:56 +0000] [<<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Setting
> variable: tx.brute_force_counter_threshold=5
> [20/Mar/2011:09:15:56 +0000] [<<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Set
> variable "tx.brute_force_counter_threshold" to "5".
> [20/Mar/2011:09:15:56 +0000] [<<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Setting
> variable: tx.brute_force_block_timeout=300
> [20/Mar/2011:09:15:56 +0000] [<<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Set
> variable "tx.brute_force_block_timeout" to "300".
> ...
> [20/Mar/2011:09:15:56 +0000] [<<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Creating
> collection (name "global", key "global").
> [20/Mar/2011:09:15:56 +0000] [<<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Recorded
> original collection variable: global.UPDATE_COUNTER = "0"
> [20/Mar/2011:09:15:56 +0000] [<<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Added
> collection "global" to the list.
> [20/Mar/2011:09:15:56 +0000] [<<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Resolved
> macro %{remote_addr} to: 192.168.1.1
> [20/Mar/2011:09:15:56 +0000] [<<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Resolved
> macro %{tx.ua_hash} to: 3dcbbff145dcf13aa6287b931eb296b39b7541ee
> [20/Mar/2011:09:15:56 +0000] [<<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read
> variable: name "__expire_KEY", value "1300615158".
> [20/Mar/2011:09:15:56 +0000] [<<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read
> variable: name "KEY", value
> "192.168.1.1_3dcbbff145dcf13aa6287b931eb296b39b7541ee".
> [20/Mar/2011:09:15:56 +0000] [<<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read
> variable: name "TIMEOUT", value "3600".
> [20/Mar/2011:09:15:56 +0000] [<<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read
> variable: name "__key", value
> "192.168.1.1_3dcbbff145dcf13aa6287b931eb296b39b7541ee".
> [20/Mar/2011:09:15:56 +0000] [<<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read
> variable: name "__name", value "ip".
> [20/Mar/2011:09:15:56 +0000] [<<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read
> variable: name "CREATE_TIME", value "1300607334".
> [20/Mar/2011:09:15:56 +0000] [<<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read
> variable: name "UPDATE_COUNTER", value "75".
> [20/Mar/2011:09:15:56 +0000] [<<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read
> variable: name "dos_counter", value "75".
> [20/Mar/2011:09:15:56 +0000] [<<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read
> variable: name "LAST_UPDATE_TIME", value "1300611558".
> [20/Mar/2011:09:15:56 +0000] [<<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>]
> Retrieved collection (name "ip", key
> "192.168.1.1_3dcbbff145dcf13aa6287b931eb296b39b7541ee").
> [20/Mar/2011:09:15:56 +0000] [<<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Recorded
> original collection variable: ip.UPDATE_COUNTER = "75"
> [20/Mar/2011:09:15:56 +0000] [<<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Added
> collection "ip" to the list.
> ...
> [20/Mar/2011:09:15:56 +0000] [<<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5><
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][5<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5><<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>] Rule
> 240d78: SecRule "IP:BRUTE_FORCE_BLOCK" "@eq 1"
> "phase:1,log,noauditlog,chain,block,msg:'Brute Force Attack Identified from
> %{remote_addr} (%{tx.brute_force_block_counter} hits since last
> alert)',setvar:ip.brute_force_block_counter=+1"
> [20/Mar/2011:09:15:56 +0000] [<<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Rule
> returned 0.
> [20/Mar/2011:09:15:56 +0000] [<<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] No
> match, chained -> mode NEXT_CHAIN.
> [20/Mar/2011:09:15:56 +0000] [<<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Recipe:
> Invoking rule 244cd8; [file
> "/opt/www/conf/modsecurity_crs/base_rules/modsecurity_crs_11_brute_force.conf"]
> [line "27"].
> [20/Mar/2011:09:15:56 +0000] [<<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5><
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][5<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5><<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>] Rule
> 244cd8: SecRule "IP:BRUTE_FORCE_BLOCK" "@eq 1"
> "phase:1,noauditlog,block,nolog,setvar:ip.brute_force_block_counter=+1"
> [20/Mar/2011:09:15:56 +0000] [<<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Rule
> returned 0.
> [20/Mar/2011:09:15:56 +0000] [<<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] No
> match, not chained -> mode NEXT_RULE.
> [20/Mar/2011:09:15:56 +0000] [<<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Recipe:
> Invoking rule 250338; [file
> "/opt/www/conf/modsecurity_crs/base_rules/modsecurity_crs_11_dos_protection.conf"]
> [line "11"].
> [20/Mar/2011:09:15:56 +0000] [<<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5><
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][5<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5><<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>] Rule
> 250338: SecRule "IP:DOS_BLOCK" "@eq 1"
> "phase:1,log,noauditlog,chain,drop,msg:'Denial of Service (DoS) Attack
> Identified from %{remote_addr} (%{tx.dos_block_counter} hits since last
> alert)',setvar:ip.dos_block_counter=+1"
> [20/Mar/2011:09:15:56 +0000] [<<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><<
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Rule
> returned 0.
>
> >From what I can see, the request never hits the section of rules which
> should start counting the requests to the protected url. Instead, it skips
> to the next ruleset?
> Thanks in advance,
> Yonah
>
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> <mailto:Owasp-modsecurity-core-rule-set at lists.owasp.org>
> Owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:
> Owasp-modsecurity-core-rule-set at lists.owasp.org><mailto:<mailto:
> Owasp-modsecurity-core-rule-set at lists.owasp.org>
> Owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:
> Owasp-modsecurity-core-rule-set at lists.owasp.org>>
> <https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set>
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>
> ________________________________
> This transmission may contain information that is privileged, confidential,
> and/or exempt from disclosure under applicable law. If you are not the
> intended recipient, you are hereby notified that any disclosure, copying,
> distribution, or use of the information contained herein (including any
> reliance thereon) is STRICTLY PROHIBITED. If you received this transmission
> in error, please immediately contact the sender and destroy the material in
> its entirety, whether in electronic or hard copy format.
>
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:
> Owasp-modsecurity-core-rule-set at lists.owasp.org>
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>
> ________________________________
> This transmission may contain information that is privileged, confidential,
> and/or exempt from disclosure under applicable law. If you are not the
> intended recipient, you are hereby notified that any disclosure, copying,
> distribution, or use of the information contained herein (including any
> reliance thereon) is STRICTLY PROHIBITED. If you received this transmission
> in error, please immediately contact the sender and destroy the material in
> its entirety, whether in electronic or hard copy format.
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20110321/d3489ebe/attachment-0001.html 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: logs.zip
Type: application/zip
Size: 4502 bytes
Desc: not available
Url : https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20110321/d3489ebe/attachment-0001.zip 

From owasp at yonahruss.com  Mon Mar 21 07:14:50 2011
From: owasp at yonahruss.com (Yonah Russ)
Date: Mon, 21 Mar 2011 13:14:50 +0200
Subject: [Owasp-modsecurity-core-rule-set] CRS 2.1.1 Brute Force rules
 not blocking requests
In-Reply-To: <AANLkTik7Li2vvntrOqNZP82q97+F6udFiX2jvd0E2b51@mail.gmail.com>
References: <AANLkTin913rNZx5cr+OrmgK-PPMHAh5_z_oekOhQhkNL@mail.gmail.com>
	<D2DE2415-CDD2-4B24-8E22-C5EE345C8115@trustwave.com>
	<AANLkTinn_kEYvZbkoyNGsN2eMshasXephNt7T2-_n-SL@mail.gmail.com>
	<78F150E6-842C-428B-80DE-74334F8DAF88@trustwave.com>
	<AANLkTikwH0f0SdkOeHJS-v2uvxr1bmgnxvTzY8_Gr1pX@mail.gmail.com>
	<AANLkTik7Li2vvntrOqNZP82q97+F6udFiX2jvd0E2b51@mail.gmail.com>
Message-ID: <AANLkTiksCPVy37J=YG5Xejj0q2UeU+U4G3yqr0Krwyow@mail.gmail.com>

I've done some more digging and found the following.

If I move the phase 5 rules in the brute force rule set to phase 1, then the
rules almost work.

There is an additional incompatibility with the anomaly based scoring/block
mode since the brute force rules use block instead of drop.
The dos protection rules use drop which I think is more appropriate although
a combination of both raising the anomaly level and dropping the request
might be appropriate.

What do you suggest?
Thanks,
Yonah



> On Mon, Mar 21, 2011 at 1:05 PM, Yonah Russ <owasp at yonahruss.com> wrote:
>
>> (repost with zipped logs)
>>
>> Hi,
>>
>> I went looking for more related log messages and at first I didn't find
>> any, so I disabled all the rule sets except the brute force rules, cleared
>> the logs,  and I see something strange.
>>
>> I only made one request to the 'friendly url' /protected/url but when the
>> debug log hits the logging phase the request(?) changes to the actual file
>> name of the content engine (/engine.php):
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][4<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B4>]
>> Recipe: Invoking rule 167a60; [file "/opt/www/conf/modsecurity_
>>  crs/base_rules/modsecurity_crs_11_brute_force.conf"] [line "22"].
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][5<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B5>]
>> Rule 167a60: SecRule "IP:BRUTE_FORCE_BLOCK" "@eq 1"
>> "phase:1,log,noauditlog,chain,block,msg:'Brute Force Attack Identified from
>> %{remote_addr} (%{tx.brute_force_block_counter} hits since last
>> alert)',setvar:ip.brute_force_block_counter=+1"
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][4<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B4>]
>> Rule returned 0.
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][9<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B9>]
>> No match, chained -> mode NEXT_CHAIN.
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][4<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B4>]
>> Recipe: Invoking rule 1699a0; [file
>> "/opt/www/conf/modsecurity_crs/base_rules/modsecurity_crs_11_brute_force.conf"]
>> [line "27"].
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][5<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B5>]
>> Rule 1699a0: SecRule "IP:BRUTE_FORCE_BLOCK" "@eq 1"
>> "phase:1,noauditlog,block,nolog,setvar:ip.brute_force_block_counter=+1"
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][4<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B4>]
>> Rule returned 0.
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][9<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B9>]
>> No match, not chained -> mode NEXT_RULE.
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][4<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B4>]
>> PdfProtect: Not enabled here.
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][4<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B4>]
>> Second phase starting (dcfg e5e10).
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][4<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B4>]
>> Input filter: This request does not have a body.
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][4<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B4>]
>> Time #1: 36569
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][4<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B4>]
>> Starting phase REQUEST_BODY.
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][9<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B9>]
>> This phase consists of 1 rule(s).
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][4<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B4>]
>> Time #2: 36917
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][4<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B4>]
>> Hook insert_filter: Adding PDF XSS protection output filter (r 368d68).
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][4<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B4>]
>> Hook insert_filter: Adding output filter (r 368d68).
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#368d68][/protected/url][4<http://192.168.1.10/sid#1cc6e0][rid%23368d68%5D%5B/protected/url%5D%5B4>]
>> Initialising logging.
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][4<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B4>]
>> Starting phase LOGGING.
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][9<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B9>]
>> This phase consists of 7 rule(s).
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][4<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B4>]
>> Recipe: Invoking rule 16c0f0; [file
>> "/opt/www/conf/modsecurity_crs/base_rules/modsecurity_crs_11_brute_force.conf"]
>> [line "37"].
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][5<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B5>]
>> Rule 16c0f0: SecRule "&TX:BRUTE_FORCE_PROTECTED_URLS" "@eq 0"
>> "phase:5,noauditlog,t:none,nolog,skipAfter:END_BRUTE_FORCE_PROTECTION_CHECKS"
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][4<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B4>]
>> Transformation completed in 7 usec.
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][4<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B4>]
>> Executing operator "eq" with param "0" against
>> &TX:BRUTE_FORCE_PROTECTED_URLS.
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][9<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B9>]
>> Target value: "1"
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][4<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B4>]
>> Operator completed in 12 usec.
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][4<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B4>]
>> Rule returned 0.
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][9<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B9>]
>> No match, not chained -> mode NEXT_RULE.
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][4<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B4>]
>> Recipe: Invoking rule 16c9f8; [file
>> "/opt/www/conf/modsecurity_crs/base_rules/modsecurity_crs_11_brute_force.conf"]
>> [line "38"].
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][5<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B5>]
>> Rule 16c9f8: SecRule "REQUEST_FILENAME" "!@within
>> %{tx.brute_force_protected_urls}"
>> "phase:5,noauditlog,t:none,nolog,skipAfter:END_BRUTE_FORCE_PROTECTION_CHECKS"
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][4<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B4>]
>> Transformation completed in 4 usec.
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][4<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B4>]
>> Executing operator "!within" with param "%{tx.brute_force_protected_urls}"
>> against REQUEST_FILENAME.
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][9<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B9>]
>> Target value: "/engine.php"
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][9<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B9>]
>> Resolved macro %{tx.brute_force_protected_urls} to: /protected/url
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][4<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B4>]
>> Operator completed in 593 usec.
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][4<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B4>]
>> Warning. Match of "within %{tx.brute_force_protected_urls}" against
>> "REQUEST_FILENAME" required. [file
>> "/opt/www/conf/modsecurity_crs/base_rules/modsecurity_crs_11_brute_force.conf"]
>> [line "38"]
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][4<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B4>]
>> Rule returned 1.
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][9<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B9>]
>> Skipping after rule 16c9f8 id="END_BRUTE_FORCE_PROTECTION_CHECKS" -> mode
>> SKIP_RULES.
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][9<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B9>]
>> Current rule is id="(null)" [chained 0] is trying to find the
>> SecMarker="END_BRUTE_FORCE_PROTECTION_CHECKS" [stater 0]
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][9<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B9>]
>> Current rule is id="(null)" [chained 0] is trying to find the
>> SecMarker="END_BRUTE_FORCE_PROTECTION_CHECKS" [stater 0]
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][9<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B9>]
>> Current rule is id="(null)" [chained 0] is trying to find the
>> SecMarker="END_BRUTE_FORCE_PROTECTION_CHECKS" [stater 0]
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][9<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B9>]
>> Current rule is id="(null)" [chained 0] is trying to find the
>> SecMarker="END_BRUTE_FORCE_PROTECTION_CHECKS" [stater 0]
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][9<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B9>]
>> Found rule 176a48 id="END_BRUTE_FORCE_PROTECTION_CHECKS".
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][4<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B4>]
>> Continuing execution after rule id="END_BRUTE_FORCE_PROTECTION_CHECKS".
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][4<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B4>]
>> Audit log: Logging this transaction.
>> [21/Mar/2011:09:35:58 +0000] [
>> 192.168.1.10/sid#1cc6e0][rid#382e88][/engine.php][9<http://192.168.1.10/sid#1cc6e0][rid%23382e88%5D%5B/engine.php%5D%5B9>]
>> Audit Log: Writing 256 bytes to primary concurrent index
>>
>>
>> I've attached the sanitized debug and audit logs for the request.
>>
>> Also- here is the rewrite rule which sends friendly-url requests to the
>> content engine:
>>     RewriteCond %{REQUEST_FILENAME} !-f
>>     RewriteRule ^(.*)$ /engine.php?q=$1 [L,QSA]
>>
>> Thanks,
>> Yonah
>>
>>
>> On Sun, Mar 20, 2011 at 10:26 PM, Ryan Barnett <RBarnett at trustwave.com>wrote:
>>
>>> The brute force rules that count the # of requests and set the block
>>> variable actually run in phase 5 logging.  The section of the debug log you
>>> showed was from phase 1 where it is deciding to block or not.  Please check
>>> later on in the debug log to see how these rules are working.
>>>
>>> On Mar 20, 2011, at 1:40 PM, Yonah Russ <owasp at yonahruss.com<mailto:
>>> owasp at yonahruss.com>> wrote:
>>>
>>> Hi,
>>>
>>> The short answer is that there are are no directories defined - just full
>>> paths.
>>>
>>> The long answer is that there are also no actual filenames- the requests
>>> are handled by a content engine doing friendly urls. The defined urls are
>>> the friendly ones- so apache gets a request for <
>>> http://www.site.com/protected_url> www.site.com/protected_url<
>>> http://www.site.com/protected_url> and uses mod_rewrite to send it to
>>> engine.php - Does that make a difference for REQUEST_FILENAME?
>>>
>>> Thanks,
>>> Yonah
>>>
>>>
>>> On Sun, Mar 20, 2011 at 3:56 PM, Ryan Barnett <<mailto:
>>> RBarnett at trustwave.com>RBarnett at trustwave.com<mailto:
>>> RBarnett at trustwave.com>> wrote:
>>> Are your protected URLs that you define in the 10 file setvars full paths
>>> to the login page(s)?  The check in the brute force file checks these
>>> variables against the REQUEST_FILENAME of the current transaction. You
>>> sanitized your example configs (/protected_url) so I am not sure if you
>>> defined a filename or a directory.
>>>
>>> An audit log entry would help.
>>>
>>> On Mar 20, 2011, at 5:51 AM, Yonah Russ <<mailto:owasp at yonahruss.com>
>>> owasp at yonahruss.com<mailto:owasp at yonahruss.com><mailto:<mailto:
>>> owasp at yonahruss.com>owasp at yonahruss.com<mailto:owasp at yonahruss.com>>>
>>> wrote:
>>>
>>> Hi,
>>>
>>> I'm using 2.5.13 with CRS 2.1.1
>>> I've configured the following:
>>>
>>> SecAction "phase:1,t:none,nolog,pass, \
>>> setvar:'tx.brute_force_protected_urls=/protected_url /protected_url2', \
>>> setvar:'tx.brute_force_burst_time_slice=60', \
>>> setvar:'tx.brute_force_counter_threshold=5', \
>>> setvar:'tx.brute_force_block_timeout=300'"
>>>
>>> When I test, all the requests get through and not even a message in the
>>> logs :(
>>> Here is an excerpt from the debug log:
>>> ...
>>> [20/Mar/2011:09:15:56 +0000] [<<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid%2319211a0%5D%5B/protected_url%5D%5B9>
>>> <http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>]
>>> Setting variable: tx.brute_force_protected_urls=/protected_url
>>> /protected_url2
>>> [20/Mar/2011:09:15:56 +0000] [<<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid%2319211a0%5D%5B/protected_url%5D%5B9>
>>> <http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Set
>>> variable "tx.brute_force_protected_urls" to "/protected_url
>>> /protected_url2".
>>> [20/Mar/2011:09:15:56 +0000] [<<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid%2319211a0%5D%5B/protected_url%5D%5B9>
>>> <http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>]
>>> Setting variable: tx.brute_force_burst_time_slice=60
>>> [20/Mar/2011:09:15:56 +0000] [<<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid%2319211a0%5D%5B/protected_url%5D%5B9>
>>> <http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Set
>>> variable "tx.brute_force_burst_time_slice" to "60".
>>> [20/Mar/2011:09:15:56 +0000] [<<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid%2319211a0%5D%5B/protected_url%5D%5B9>
>>> <http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>]
>>> Setting variable: tx.brute_force_counter_threshold=5
>>> [20/Mar/2011:09:15:56 +0000] [<<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid%2319211a0%5D%5B/protected_url%5D%5B9>
>>> <http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Set
>>> variable "tx.brute_force_counter_threshold" to "5".
>>> [20/Mar/2011:09:15:56 +0000] [<<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid%2319211a0%5D%5B/protected_url%5D%5B9>
>>> <http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>]
>>> Setting variable: tx.brute_force_block_timeout=300
>>> [20/Mar/2011:09:15:56 +0000] [<<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid%2319211a0%5D%5B/protected_url%5D%5B9>
>>> <http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Set
>>> variable "tx.brute_force_block_timeout" to "300".
>>> ...
>>> [20/Mar/2011:09:15:56 +0000] [<<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
>>> www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<http://www.site.com/sid#12b7778][rid%2319211a0%5D%5B/protected_url%5D%5B4>
>>> <http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>]
>>> Creating collection (name "global", key "global").
>>> [20/Mar/2011:09:15:56 +0000] [<<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid%2319211a0%5D%5B/protected_url%5D%5B9>
>>> <http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>]
>>> Recorded original collection variable: global.UPDATE_COUNTER = "0"
>>> [20/Mar/2011:09:15:56 +0000] [<<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
>>> www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<http://www.site.com/sid#12b7778][rid%2319211a0%5D%5B/protected_url%5D%5B4>
>>> <http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Added
>>> collection "global" to the list.
>>> [20/Mar/2011:09:15:56 +0000] [<<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid%2319211a0%5D%5B/protected_url%5D%5B9>
>>> <http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>]
>>> Resolved macro %{remote_addr} to: 192.168.1.1
>>> [20/Mar/2011:09:15:56 +0000] [<<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid%2319211a0%5D%5B/protected_url%5D%5B9>
>>> <http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>]
>>> Resolved macro %{tx.ua_hash} to: 3dcbbff145dcf13aa6287b931eb296b39b7541ee
>>> [20/Mar/2011:09:15:56 +0000] [<<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid%2319211a0%5D%5B/protected_url%5D%5B9>
>>> <http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read
>>> variable: name "__expire_KEY", value "1300615158".
>>> [20/Mar/2011:09:15:56 +0000] [<<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid%2319211a0%5D%5B/protected_url%5D%5B9>
>>> <http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read
>>> variable: name "KEY", value
>>> "192.168.1.1_3dcbbff145dcf13aa6287b931eb296b39b7541ee".
>>> [20/Mar/2011:09:15:56 +0000] [<<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid%2319211a0%5D%5B/protected_url%5D%5B9>
>>> <http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read
>>> variable: name "TIMEOUT", value "3600".
>>> [20/Mar/2011:09:15:56 +0000] [<<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid%2319211a0%5D%5B/protected_url%5D%5B9>
>>> <http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read
>>> variable: name "__key", value
>>> "192.168.1.1_3dcbbff145dcf13aa6287b931eb296b39b7541ee".
>>> [20/Mar/2011:09:15:56 +0000] [<<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid%2319211a0%5D%5B/protected_url%5D%5B9>
>>> <http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read
>>> variable: name "__name", value "ip".
>>> [20/Mar/2011:09:15:56 +0000] [<<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid%2319211a0%5D%5B/protected_url%5D%5B9>
>>> <http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read
>>> variable: name "CREATE_TIME", value "1300607334".
>>> [20/Mar/2011:09:15:56 +0000] [<<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid%2319211a0%5D%5B/protected_url%5D%5B9>
>>> <http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read
>>> variable: name "UPDATE_COUNTER", value "75".
>>> [20/Mar/2011:09:15:56 +0000] [<<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid%2319211a0%5D%5B/protected_url%5D%5B9>
>>> <http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read
>>> variable: name "dos_counter", value "75".
>>> [20/Mar/2011:09:15:56 +0000] [<<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid%2319211a0%5D%5B/protected_url%5D%5B9>
>>> <http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] Read
>>> variable: name "LAST_UPDATE_TIME", value "1300611558".
>>> [20/Mar/2011:09:15:56 +0000] [<<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
>>> www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<http://www.site.com/sid#12b7778][rid%2319211a0%5D%5B/protected_url%5D%5B4>
>>> <http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>]
>>> Retrieved collection (name "ip", key
>>> "192.168.1.1_3dcbbff145dcf13aa6287b931eb296b39b7541ee").
>>> [20/Mar/2011:09:15:56 +0000] [<<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid%2319211a0%5D%5B/protected_url%5D%5B9>
>>> <http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>]
>>> Recorded original collection variable: ip.UPDATE_COUNTER = "75"
>>> [20/Mar/2011:09:15:56 +0000] [<<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
>>> www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<http://www.site.com/sid#12b7778][rid%2319211a0%5D%5B/protected_url%5D%5B4>
>>> <http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Added
>>> collection "ip" to the list.
>>> ...
>>> [20/Mar/2011:09:15:56 +0000] [<<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5><
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>
>>> www.site.com/sid#12b7778][rid#19211a0][/protected_url][5<http://www.site.com/sid#12b7778][rid%2319211a0%5D%5B/protected_url%5D%5B5>
>>> <http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5><<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>] Rule
>>> 240d78: SecRule "IP:BRUTE_FORCE_BLOCK" "@eq 1"
>>> "phase:1,log,noauditlog,chain,block,msg:'Brute Force Attack Identified from
>>> %{remote_addr} (%{tx.brute_force_block_counter} hits since last
>>> alert)',setvar:ip.brute_force_block_counter=+1"
>>> [20/Mar/2011:09:15:56 +0000] [<<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
>>> www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<http://www.site.com/sid#12b7778][rid%2319211a0%5D%5B/protected_url%5D%5B4>
>>> <http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Rule
>>> returned 0.
>>> [20/Mar/2011:09:15:56 +0000] [<<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid%2319211a0%5D%5B/protected_url%5D%5B9>
>>> <http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] No
>>> match, chained -> mode NEXT_CHAIN.
>>> [20/Mar/2011:09:15:56 +0000] [<<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
>>> www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<http://www.site.com/sid#12b7778][rid%2319211a0%5D%5B/protected_url%5D%5B4>
>>> <http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>]
>>> Recipe: Invoking rule 244cd8; [file
>>> "/opt/www/conf/modsecurity_crs/base_rules/modsecurity_crs_11_brute_force.conf"]
>>> [line "27"].
>>> [20/Mar/2011:09:15:56 +0000] [<<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5><
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>
>>> www.site.com/sid#12b7778][rid#19211a0][/protected_url][5<http://www.site.com/sid#12b7778][rid%2319211a0%5D%5B/protected_url%5D%5B5>
>>> <http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5><<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>] Rule
>>> 244cd8: SecRule "IP:BRUTE_FORCE_BLOCK" "@eq 1"
>>> "phase:1,noauditlog,block,nolog,setvar:ip.brute_force_block_counter=+1"
>>> [20/Mar/2011:09:15:56 +0000] [<<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
>>> www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<http://www.site.com/sid#12b7778][rid%2319211a0%5D%5B/protected_url%5D%5B4>
>>> <http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Rule
>>> returned 0.
>>> [20/Mar/2011:09:15:56 +0000] [<<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> www.site.com/sid#12b7778][rid#19211a0][/protected_url][9<http://www.site.com/sid#12b7778][rid%2319211a0%5D%5B/protected_url%5D%5B9>
>>> <http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9><<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][9>] No
>>> match, not chained -> mode NEXT_RULE.
>>> [20/Mar/2011:09:15:56 +0000] [<<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
>>> www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<http://www.site.com/sid#12b7778][rid%2319211a0%5D%5B/protected_url%5D%5B4>
>>> <http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>]
>>> Recipe: Invoking rule 250338; [file
>>> "/opt/www/conf/modsecurity_crs/base_rules/modsecurity_crs_11_dos_protection.conf"]
>>> [line "11"].
>>> [20/Mar/2011:09:15:56 +0000] [<<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5><
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>
>>> www.site.com/sid#12b7778][rid#19211a0][/protected_url][5<http://www.site.com/sid#12b7778][rid%2319211a0%5D%5B/protected_url%5D%5B5>
>>> <http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5><<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][5>] Rule
>>> 250338: SecRule "IP:DOS_BLOCK" "@eq 1"
>>> "phase:1,log,noauditlog,chain,drop,msg:'Denial of Service (DoS) Attack
>>> Identified from %{remote_addr} (%{tx.dos_block_counter} hits since last
>>> alert)',setvar:ip.dos_block_counter=+1"
>>> [20/Mar/2011:09:15:56 +0000] [<<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
>>> www.site.com/sid#12b7778][rid#19211a0][/protected_url][4<http://www.site.com/sid#12b7778][rid%2319211a0%5D%5B/protected_url%5D%5B4>
>>> <http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4><<
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>
>>> http://www.site.com/sid#12b7778][rid#19211a0][/protected_url][4>] Rule
>>> returned 0.
>>>
>>> >From what I can see, the request never hits the section of rules which
>>> should start counting the requests to the protected url. Instead, it skips
>>> to the next ruleset?
>>> Thanks in advance,
>>> Yonah
>>>
>>> _______________________________________________
>>> Owasp-modsecurity-core-rule-set mailing list
>>> <mailto:Owasp-modsecurity-core-rule-set at lists.owasp.org>
>>> Owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:
>>> Owasp-modsecurity-core-rule-set at lists.owasp.org><mailto:<mailto:
>>> Owasp-modsecurity-core-rule-set at lists.owasp.org>
>>> Owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:
>>> Owasp-modsecurity-core-rule-set at lists.owasp.org>>
>>> <
>>> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>>> >
>>> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>>>
>>> ________________________________
>>> This transmission may contain information that is privileged,
>>> confidential, and/or exempt from disclosure under applicable law. If you are
>>> not the intended recipient, you are hereby notified that any disclosure,
>>> copying, distribution, or use of the information contained herein (including
>>> any reliance thereon) is STRICTLY PROHIBITED. If you received this
>>> transmission in error, please immediately contact the sender and destroy the
>>> material in its entirety, whether in electronic or hard copy format.
>>>
>>> _______________________________________________
>>> Owasp-modsecurity-core-rule-set mailing list
>>> Owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:
>>> Owasp-modsecurity-core-rule-set at lists.owasp.org>
>>> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>>>
>>> ________________________________
>>> This transmission may contain information that is privileged,
>>> confidential, and/or exempt from disclosure under applicable law. If you are
>>> not the intended recipient, you are hereby notified that any disclosure,
>>> copying, distribution, or use of the information contained herein (including
>>> any reliance thereon) is STRICTLY PROHIBITED. If you received this
>>> transmission in error, please immediately contact the sender and destroy the
>>> material in its entirety, whether in electronic or hard copy format.
>>>
>>
>>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20110321/58b846b2/attachment-0001.html 

From rbarnett at trustwave.com  Mon Mar 21 14:12:28 2011
From: rbarnett at trustwave.com (Ryan Barnett (JIRA))
Date: Mon, 21 Mar 2011 12:12:28 -0600 (CST)
Subject: [Owasp-modsecurity-core-rule-set] [JIRA] Resolved: (CORERULES-67)
	Unique Request ID
Message-ID: <19657128.137.1300731148919.JavaMail.root@modsec-apps.colo.breach.com>


     [ https://www.modsecurity.org/tracker/browse/CORERULES-67?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel ]

Ryan Barnett resolved CORERULES-67.
-----------------------------------

    Resolution: Fixed

A new variable that holds the mod_uniqueid data (UNIQUE_ID) was created for v2.6 -

https://www.modsecurity.org/tracker/browse/MODSEC-212

> Unique Request ID
> -----------------
>
>                 Key: CORERULES-67
>                 URL: https://www.modsecurity.org/tracker/browse/CORERULES-67
>             Project: Core Rules
>          Issue Type: Improvement
>      Security Level: Normal
>         Environment: All
>            Reporter: Colin Watson
>            Assignee: Ryan Barnett
>            Priority: Wish
>
> Could ModSecurity CRS create a unique (sequential?) ID for each and every request per virtual host/site, and add this to the X-WAF headers?  This could then be used as a request identifier to correlate information in ModSecurity logs and actions, with other security event data (e.g. in application logs) where there may be more than one event per request.
> The IDs would be needed for static as well as dynamic content requests, whether or not there was some sort of error, or not.  For example, a not found error for an image file, and a page request using an unsupported request method, would both have IDs.

-- 
This message is automatically generated by JIRA.
-
If you think it was sent incorrectly contact one of the administrators: https://www.modsecurity.org/tracker/secure/Administrators.jspa
-
For more information on JIRA, see: http://www.atlassian.com/software/jira

        


From RBarnett at trustwave.com  Wed Mar 30 10:37:10 2011
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Wed, 30 Mar 2011 09:37:10 -0500
Subject: [Owasp-modsecurity-core-rule-set] ModSecurity Update: Increasing
	Community Involvement
Message-ID: <C9B8B856.1CDB2%rbarnett@trustwave.com>

Greetings everyone,
Trustwave has some big news today for the ModSecurity Project:
http://blog.spiderlabs.com/2011/03/modsecurity-update-increasing-community-involvement.html

The most important news is that we are changing from the GPLv2 license to the Apache Software v2 License.  This will allow for wider adoption and development of ModSecurity.

Check out our updated homepage - http://www.modsecurity.org/ - which also now includes a link to a page for Developers (http://www.modsecurity.org/developers/).  If you would like to contribute code/enhancements to ModSecurity please sign up for the Developers mail-list (http://lists.sourceforge.net/lists/listinfo/mod-security-developers) and send us a note.

Cheers,
Ryan


From brectanu at gmail.com  Wed Mar 30 11:43:24 2011
From: brectanu at gmail.com (Brian Rectanus)
Date: Wed, 30 Mar 2011 08:43:24 -0700
Subject: [Owasp-modsecurity-core-rule-set] ModSecurity Update:
 Increasing Community Involvement
In-Reply-To: <C9B8B856.1CDB2%rbarnett@trustwave.com>
References: <C9B8B856.1CDB2%rbarnett@trustwave.com>
Message-ID: <AANLkTik+-Aa3n8f-bYHTiQZkiNF4S0GQiTHzVChW7yqW@mail.gmail.com>

This is great news!

Thanks Ryan.

-B

On Wed, Mar 30, 2011 at 7:37 AM, Ryan Barnett <RBarnett at trustwave.com> wrote:
> Greetings everyone,
> Trustwave has some big news today for the ModSecurity Project:
> http://blog.spiderlabs.com/2011/03/modsecurity-update-increasing-community-involvement.html
>
> The most important news is that we are changing from the GPLv2 license to the Apache Software v2 License. ?This will allow for wider adoption and development of ModSecurity.
>
> Check out our updated homepage - http://www.modsecurity.org/ - which also now includes a link to a page for Developers (http://www.modsecurity.org/developers/). ?If you would like to contribute code/enhancements to ModSecurity please sign up for the Developers mail-list (http://lists.sourceforge.net/lists/listinfo/mod-security-developers) and send us a note.
>
> Cheers,
> Ryan
>
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>

From ivan.ristic at gmail.com  Wed Mar 30 11:47:54 2011
From: ivan.ristic at gmail.com (Ivan Ristic)
Date: Wed, 30 Mar 2011 16:47:54 +0100
Subject: [Owasp-modsecurity-core-rule-set] ModSecurity Update:
 Increasing Community Involvement
In-Reply-To: <AANLkTik+-Aa3n8f-bYHTiQZkiNF4S0GQiTHzVChW7yqW@mail.gmail.com>
References: <C9B8B856.1CDB2%rbarnett@trustwave.com>
	<AANLkTik+-Aa3n8f-bYHTiQZkiNF4S0GQiTHzVChW7yqW@mail.gmail.com>
Message-ID: <AANLkTi=Wyd6EfNe-sELEa+rR4sE-+-SmCH6EGZmOC=ot@mail.gmail.com>

This is truly fantastic news for the community. Well done Ryan, Breno,
and Trustwave.

On a personal note, my eyes are all watery! :)


On Wed, Mar 30, 2011 at 4:43 PM, Brian Rectanus <brectanu at gmail.com> wrote:
> This is great news!
>
> Thanks Ryan.
>
> -B
>
> On Wed, Mar 30, 2011 at 7:37 AM, Ryan Barnett <RBarnett at trustwave.com> wrote:
>> Greetings everyone,
>> Trustwave has some big news today for the ModSecurity Project:
>> http://blog.spiderlabs.com/2011/03/modsecurity-update-increasing-community-involvement.html
>>
>> The most important news is that we are changing from the GPLv2 license to the Apache Software v2 License. ?This will allow for wider adoption and development of ModSecurity.
>>
>> Check out our updated homepage - http://www.modsecurity.org/ - which also now includes a link to a page for Developers (http://www.modsecurity.org/developers/). ?If you would like to contribute code/enhancements to ModSecurity please sign up for the Developers mail-list (http://lists.sourceforge.net/lists/listinfo/mod-security-developers) and send us a note.
>>
>> Cheers,
>> Ryan
>>
>> _______________________________________________
>> Owasp-modsecurity-core-rule-set mailing list
>> Owasp-modsecurity-core-rule-set at lists.owasp.org
>> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>>
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>



-- 
Ivan Risti?

From RBarnett at trustwave.com  Wed Mar 30 15:30:36 2011
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Wed, 30 Mar 2011 14:30:36 -0500
Subject: [Owasp-modsecurity-core-rule-set] ModSecurity Advanced Topic of the
 Week: New Community Contribution - cmdLine Transformation Function
Message-ID: <C9B8FD1C.1CE8C%rbarnett@trustwave.com>

http://blog.spiderlabs.com/2011/03/modsecurity-advanced-topic-of-the-week-new-community-contribution-cmdline.html

Thanks goes to Marc Stern for developing this enhancement!

I am going to have to update the CRS command injection rules to use this :)

--
Ryan Barnett


________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.


From ivan.ristic at gmail.com  Wed Mar 30 17:08:08 2011
From: ivan.ristic at gmail.com (Ivan Ristic)
Date: Wed, 30 Mar 2011 22:08:08 +0100
Subject: [Owasp-modsecurity-core-rule-set] ModSecurity Update:
 Increasing Community Involvement
In-Reply-To: <C9B8B856.1CDB2%rbarnett@trustwave.com>
References: <C9B8B856.1CDB2%rbarnett@trustwave.com>
Message-ID: <AANLkTimFneVka=HG-weNO-Y+o=ev1QPz+kBeX0wbTn8V@mail.gmail.com>

Ryan,

Will you also change the licence of the Core Rules?


On Wed, Mar 30, 2011 at 3:37 PM, Ryan Barnett <RBarnett at trustwave.com> wrote:
> Greetings everyone,
> Trustwave has some big news today for the ModSecurity Project:
> http://blog.spiderlabs.com/2011/03/modsecurity-update-increasing-community-involvement.html
>
> The most important news is that we are changing from the GPLv2 license to the Apache Software v2 License. ?This will allow for wider adoption and development of ModSecurity.
>
> Check out our updated homepage - http://www.modsecurity.org/ - which also now includes a link to a page for Developers (http://www.modsecurity.org/developers/). ?If you would like to contribute code/enhancements to ModSecurity please sign up for the Developers mail-list (http://lists.sourceforge.net/lists/listinfo/mod-security-developers) and send us a note.
>
> Cheers,
> Ryan
>
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>



-- 
Ivan Risti?

From RBarnett at trustwave.com  Wed Mar 30 17:17:21 2011
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Wed, 30 Mar 2011 16:17:21 -0500
Subject: [Owasp-modsecurity-core-rule-set] ModSecurity Update:
 Increasing Community Involvement
In-Reply-To: <AANLkTimFneVka=HG-weNO-Y+o=ev1QPz+kBeX0wbTn8V@mail.gmail.com>
Message-ID: <C9B91610.1CEBC%rbarnett@trustwave.com>


On 3/30/11 5:08 PM, "Ivan Ristic" <ivan.ristic at gmail.com> wrote:

>Ryan,
>
>Will you also change the licence of the Core Rules?

We are looking into it.

-Ryan



>
>
>On Wed, Mar 30, 2011 at 3:37 PM, Ryan Barnett <RBarnett at trustwave.com>
>wrote:
>> Greetings everyone,
>> Trustwave has some big news today for the ModSecurity Project:
>>
>>http://blog.spiderlabs.com/2011/03/modsecurity-update-increasing-communit
>>y-involvement.html
>>
>> The most important news is that we are changing from the GPLv2 license
>>to the Apache Software v2 License.  This will allow for wider adoption
>>and development of ModSecurity.
>>
>> Check out our updated homepage - http://www.modsecurity.org/ - which
>>also now includes a link to a page for Developers
>>(http://www.modsecurity.org/developers/).  If you would like to
>>contribute code/enhancements to ModSecurity please sign up for the
>>Developers mail-list
>>(http://lists.sourceforge.net/lists/listinfo/mod-security-developers)
>>and send us a note.
>>
>> Cheers,
>> Ryan
>>
>> _______________________________________________
>> Owasp-modsecurity-core-rule-set mailing list
>> Owasp-modsecurity-core-rule-set at lists.owasp.org
>> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>>
>
>
>
>--
>Ivan Risti?
>


This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.


From RBarnett at trustwave.com  Wed Mar 30 17:56:14 2011
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Wed, 30 Mar 2011 16:56:14 -0500
Subject: [Owasp-modsecurity-core-rule-set] ModSecurity Update:
 Increasing Community Involvement
In-Reply-To: <AANLkTimFneVka=HG-weNO-Y+o=ev1QPz+kBeX0wbTn8V@mail.gmail.com>
Message-ID: <C9B91EFD.1CEC7%rbarnett@trustwave.com>



On 3/30/11 5:08 PM, "Ivan Ristic" <ivan.ristic at gmail.com> wrote:

>Ryan,
>
>Will you also change the licence of the Core Rules?

I was discussing this with the OWASP Global Project Committee today.
Looks like we will be moving the CRS to ASLv2 as well.  We will let the
mail-list know when this is finalized.

-Ryan

>
>
>On Wed, Mar 30, 2011 at 3:37 PM, Ryan Barnett <RBarnett at trustwave.com>
>wrote:
>> Greetings everyone,
>> Trustwave has some big news today for the ModSecurity Project:
>>
>>http://blog.spiderlabs.com/2011/03/modsecurity-update-increasing-communit
>>y-involvement.html
>>
>> The most important news is that we are changing from the GPLv2 license
>>to the Apache Software v2 License.  This will allow for wider adoption
>>and development of ModSecurity.
>>
>> Check out our updated homepage - http://www.modsecurity.org/ - which
>>also now includes a link to a page for Developers
>>(http://www.modsecurity.org/developers/).  If you would like to
>>contribute code/enhancements to ModSecurity please sign up for the
>>Developers mail-list
>>(http://lists.sourceforge.net/lists/listinfo/mod-security-developers)
>>and send us a note.
>>
>> Cheers,
>> Ryan
>>
>> _______________________________________________
>> Owasp-modsecurity-core-rule-set mailing list
>> Owasp-modsecurity-core-rule-set at lists.owasp.org
>> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>>
>
>
>
>--
>Ivan Risti?
>


This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.


