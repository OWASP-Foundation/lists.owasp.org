<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Lua nil value error
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20Lua%20nil%20value%20error&In-Reply-To=CAD9D773.398A1%25rbarnett%40trustwave.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000913.html">
   <LINK REL="Next"  HREF="000915.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Lua nil value error</H1>
    <B>Ross Lawrie</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20Lua%20nil%20value%20error&In-Reply-To=CAD9D773.398A1%25rbarnett%40trustwave.com"
       TITLE="[Owasp-modsecurity-core-rule-set] Lua nil value error">ross at sentrypayments.com
       </A><BR>
    <I>Fri Nov  4 18:41:45 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="000913.html">[Owasp-modsecurity-core-rule-set] Lua nil value error
</A></li>
        <LI>Next message: <A HREF="000915.html">[Owasp-modsecurity-core-rule-set] Lua nil value error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#914">[ date ]</a>
              <a href="thread.html#914">[ thread ]</a>
              <a href="subject.html#914">[ subject ]</a>
              <a href="author.html#914">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, 2011-11-04 at 16:58 -0500, Ryan Barnett wrote:
&gt;<i> On 11/4/11 4:29 PM, &quot;Ross Lawrie&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">ross at sentrypayments.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> &gt;Hi,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;I've done some searches hoping to find some help, and while I did find a
</I>&gt;<i> &gt;reference to the same error earlier in the list, I didn't see a clear
</I>&gt;<i> &gt;solution - or at least one that seemed clear to me.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;I'm looking at getting ModSecurity upgraded on our web server, using
</I>&gt;<i> &gt;2.6.2 with the 2.2.0 CRS. What I'm encountering is a Lua error that has
</I>&gt;<i> &gt;me confused.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;  Message: Lua: Script execution failed: attempt to call a nil value
</I>&gt;<i> &gt;  Message: Rule processing failed.
</I>&gt;<i> 
</I>&gt;<i> Do you happen to have Selinux running?  I believe I ran into this recently
</I>&gt;<i> as well with a Lua script.  Although I had set OS level permissions which
</I>&gt;<i> allowed my Apache user to read/execute the Lua scripts, the Selinux
</I>&gt;<i> permissions were not set correctly and I got a similar error message.  If
</I>&gt;<i> this is the case, then you will want to execute the chcon command to set
</I>&gt;<i> appropriate context for the Lua scripts/directory to allow the httpd
</I>&gt;<i> process to read/execute it.   See a similar post here -
</I>&gt;<i> <A HREF="http://permalink.gmane.org/gmane.comp.apache.mod-security.user/7268">http://permalink.gmane.org/gmane.comp.apache.mod-security.user/7268</A>
</I>&gt;<i> 
</I>&gt;<i> -Ryan
</I>
Hi Ryan,

Thanks for the reply, unfortunately selinux is not active on the machine
in question. Events are successfully going to our SecAuditLogStorageDir,
so I believe the permissions are okay on it.

I've increased the SecDebugLogLevel to 9, and I think this is the
relevant entries from the resulting log, not sure if it's of any help:

[04/Nov/2011:15:31:43 --0700]
[xxxxxxxxx.xxx/sid#36acbf0][rid#3ad72f0][/xxxxxx.cgi][4] Recipe:
Invoking rule 2ccfde8; [file
&quot;/usr/local/apache/conf/modsecurity-crs_2.2.0/activated_rules/modsecurity_crs_41_advanced_filters.conf&quot;] [line &quot;17&quot;].
[04/Nov/2011:15:31:43 --0700]
[xxxxxxxxx.xxx/sid#36acbf0][rid#3ad72f0][/xxxxxx.cgi][5] Rule 2ccfde8:
SecRuleScript &quot;@&quot; &quot;phase:2,log,t:none,pass&quot;
[04/Nov/2011:15:31:43 --0700]
[xxxxxxxxx.xxx/sid#36acbf0][rid#3ad72f0][/xxxxxx.cgi][8] Lua: Executing
script: /usr/local/apache/conf/modsecurity-crs_2.2.0/activated_rules/../lua/advanced_filter_converter.lua
[04/Nov/2011:15:31:43 --0700]
[xxxxxxxxx.xxx/sid#36acbf0][rid#3ad72f0][/xxxxxx.cgi][1] Lua: Script
execution failed: attempt to call a nil value
[04/Nov/2011:15:31:43 --0700]
[xxxxxxxxx.xxx/sid#36acbf0][rid#3ad72f0][/xxxxxx.cgi][4] Rule returned
-1.
[04/Nov/2011:15:31:43 --0700]
[xxxxxxxxx.xxx/sid#36acbf0][rid#3ad72f0][/xxxxxx.cgi][1] Rule processing
failed.
[04/Nov/2011:15:31:43 --0700]
[xxxxxxxxx.xxx/sid#36acbf0][rid#3ad72f0][/xxxxxx.cgi][9] Rule failed,
not chained -&gt; mode NEXT_RULE.

Ross.




&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;This is an installation on a Debian 5.0.9 server, I believe that the
</I>&gt;<i> &gt;necessary requirements are installed:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;libapr1            : 1.2.12-5+lenny4
</I>&gt;<i> &gt;libapr1-dev        : 1.2.12-5+lenny4
</I>&gt;<i> &gt;libaprutil1        : 1.2.12+dfsg-8+lenny5
</I>&gt;<i> &gt;libaprutil1-dev    : 1.2.12+dfsg-8+lenny5
</I>&gt;<i> &gt;lua5.1             : 5.1.3-1
</I>&gt;<i> &gt;liblua5.1-0        : 5.1.3-1
</I>&gt;<i> &gt;liblua5.1-0-dev    : 5.1.3-1
</I>&gt;<i> &gt;libpcre3           : 7.6-2.1
</I>&gt;<i> &gt;libpcre3-dev       : 7.6-2.1
</I>&gt;<i> &gt;libxml2            : 2.6.32.dfsg-5+lenny4
</I>&gt;<i> &gt;libxml2-dev        : 2.6.32.dfsg-5+lenny4
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;Apache 2.2.21 is installed from source using the following configure:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;./configure \
</I>&gt;<i> &gt;--prefix=/usr/local/apache \
</I>&gt;<i> &gt;--disable-userdir \
</I>&gt;<i> &gt;--enable-rewrite \
</I>&gt;<i> &gt;--enable-so \
</I>&gt;<i> &gt;--enable-status \
</I>&gt;<i> &gt;--enable-info \
</I>&gt;<i> &gt;--enable-ssl \
</I>&gt;<i> &gt;--enable-cgi \
</I>&gt;<i> &gt;--enable-unique-id \
</I>&gt;<i> &gt;--enable-mime-magic \
</I>&gt;<i> &gt;--with-included-apr \
</I>&gt;<i> &gt;--with-pcre=/usr/bin/pcre-config \
</I>&gt;<i> &gt;--enable-deflate \
</I>&gt;<i> &gt;--enable-expires \
</I>&gt;<i> &gt;--enable-headers
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;ModSecurity 2.6.2 is installed with the following configure:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;./configure \
</I>&gt;<i> &gt;--with-apxs=/usr/local/apache/bin/apxs \
</I>&gt;<i> &gt;--with-apr=/usr/local/apache/bin/apr-1-config
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;I've only made minor path changes to the ModSecurity config, and a few
</I>&gt;<i> &gt;rule rewrites for some false positives in the CRS configuration.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;I'm assuming this is a result of
</I>&gt;<i> &gt;modsecurity_crs_41_advanced_filters.conf somehow, but I'm not entirely
</I>&gt;<i> &gt;sure how -- or whether this is necessary, or purely optional (although
</I>&gt;<i> &gt;it's part of the base_rules).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;Appreciate any help or suggestions that anyone can give.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;Ross.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;_______________________________________________
</I>&gt;<i> &gt;Owasp-modsecurity-core-rule-set mailing list
</I>&gt;<i> &gt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>
</I>&gt;<i> &gt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set</A>
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
</I>&gt;<i> 
</I>

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000913.html">[Owasp-modsecurity-core-rule-set] Lua nil value error
</A></li>
	<LI>Next message: <A HREF="000915.html">[Owasp-modsecurity-core-rule-set] Lua nil value error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#914">[ date ]</a>
              <a href="thread.html#914">[ thread ]</a>
              <a href="subject.html#914">[ subject ]</a>
              <a href="author.html#914">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
