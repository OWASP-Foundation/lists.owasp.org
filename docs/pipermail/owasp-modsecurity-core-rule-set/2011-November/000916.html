<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Lua nil value error
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20Lua%20nil%20value%20error&In-Reply-To=CAD9E5C9.398AD%25rbarnett%40trustwave.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000915.html">
   <LINK REL="Next"  HREF="000917.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Lua nil value error</H1>
    <B>Ross Lawrie</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20Lua%20nil%20value%20error&In-Reply-To=CAD9E5C9.398AD%25rbarnett%40trustwave.com"
       TITLE="[Owasp-modsecurity-core-rule-set] Lua nil value error">ross at sentrypayments.com
       </A><BR>
    <I>Tue Nov  8 11:59:28 EST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="000915.html">[Owasp-modsecurity-core-rule-set] Lua nil value error
</A></li>
        <LI>Next message: <A HREF="000917.html">[Owasp-modsecurity-core-rule-set] Lua nil value error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#916">[ date ]</a>
              <a href="thread.html#916">[ thread ]</a>
              <a href="subject.html#916">[ subject ]</a>
              <a href="author.html#916">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, 2011-11-04 at 17:57 -0500, Ryan Barnett wrote:
&gt;<i> On 11/4/11 6:41 PM, &quot;Ross Lawrie&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">ross at sentrypayments.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> &gt;On Fri, 2011-11-04 at 16:58 -0500, Ryan Barnett wrote:
</I>&gt;<i> &gt;&gt; On 11/4/11 4:29 PM, &quot;Ross Lawrie&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">ross at sentrypayments.com</A>&gt; wrote:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; &gt;Hi,
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;I've done some searches hoping to find some help, and while I did find
</I>&gt;<i> &gt;&gt;a
</I>&gt;<i> &gt;&gt; &gt;reference to the same error earlier in the list, I didn't see a clear
</I>&gt;<i> &gt;&gt; &gt;solution - or at least one that seemed clear to me.
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;I'm looking at getting ModSecurity upgraded on our web server, using
</I>&gt;<i> &gt;&gt; &gt;2.6.2 with the 2.2.0 CRS. What I'm encountering is a Lua error that has
</I>&gt;<i> &gt;&gt; &gt;me confused.
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;  Message: Lua: Script execution failed: attempt to call a nil value
</I>&gt;<i> &gt;&gt; &gt;  Message: Rule processing failed.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Do you happen to have Selinux running?  I believe I ran into this
</I>&gt;<i> &gt;&gt;recently
</I>&gt;<i> &gt;&gt; as well with a Lua script.  Although I had set OS level permissions
</I>&gt;<i> &gt;&gt;which
</I>&gt;<i> &gt;&gt; allowed my Apache user to read/execute the Lua scripts, the Selinux
</I>&gt;<i> &gt;&gt; permissions were not set correctly and I got a similar error message.
</I>&gt;<i> &gt;&gt;If
</I>&gt;<i> &gt;&gt; this is the case, then you will want to execute the chcon command to set
</I>&gt;<i> &gt;&gt; appropriate context for the Lua scripts/directory to allow the httpd
</I>&gt;<i> &gt;&gt; process to read/execute it.   See a similar post here -
</I>&gt;<i> &gt;&gt; <A HREF="http://permalink.gmane.org/gmane.comp.apache.mod-security.user/7268">http://permalink.gmane.org/gmane.comp.apache.mod-security.user/7268</A>
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; -Ryan
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;Hi Ryan,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;Thanks for the reply, unfortunately selinux is not active on the machine
</I>&gt;<i> &gt;in question. Events are successfully going to our SecAuditLogStorageDir,
</I>&gt;<i> &gt;so I believe the permissions are okay on it.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;I've increased the SecDebugLogLevel to 9, and I think this is the
</I>&gt;<i> &gt;relevant entries from the resulting log, not sure if it's of any help:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;[04/Nov/2011:15:31:43 --0700]
</I>&gt;<i> &gt;[xxxxxxxxx.xxx/sid#36acbf0][rid#3ad72f0][/xxxxxx.cgi][4] Recipe:
</I>&gt;<i> &gt;Invoking rule 2ccfde8; [file
</I>&gt;<i> &gt;&quot;/usr/local/apache/conf/modsecurity-crs_2.2.0/activated_rules/modsecurity_
</I>&gt;<i> &gt;crs_41_advanced_filters.conf&quot;] [line &quot;17&quot;].
</I>&gt;<i> &gt;[04/Nov/2011:15:31:43 --0700]
</I>&gt;<i> &gt;[xxxxxxxxx.xxx/sid#36acbf0][rid#3ad72f0][/xxxxxx.cgi][5] Rule 2ccfde8:
</I>&gt;<i> &gt;SecRuleScript &quot;@&quot; &quot;phase:2,log,t:none,pass&quot;
</I>&gt;<i> &gt;[04/Nov/2011:15:31:43 --0700]
</I>&gt;<i> &gt;[xxxxxxxxx.xxx/sid#36acbf0][rid#3ad72f0][/xxxxxx.cgi][8] Lua: Executing
</I>&gt;<i> &gt;script:
</I>&gt;<i> &gt;/usr/local/apache/conf/modsecurity-crs_2.2.0/activated_rules/../lua/advanc
</I>&gt;<i> &gt;ed_filter_converter.lua
</I>&gt;<i> &gt;[04/Nov/2011:15:31:43 --0700]
</I>&gt;<i> &gt;[xxxxxxxxx.xxx/sid#36acbf0][rid#3ad72f0][/xxxxxx.cgi][1] Lua: Script
</I>&gt;<i> &gt;execution failed: attempt to call a nil value
</I>&gt;<i> &gt;[04/Nov/2011:15:31:43 --0700]
</I>&gt;<i> &gt;[xxxxxxxxx.xxx/sid#36acbf0][rid#3ad72f0][/xxxxxx.cgi][4] Rule returned
</I>&gt;<i> &gt;-1.
</I>&gt;<i> &gt;[04/Nov/2011:15:31:43 --0700]
</I>&gt;<i> &gt;[xxxxxxxxx.xxx/sid#36acbf0][rid#3ad72f0][/xxxxxx.cgi][1] Rule processing
</I>&gt;<i> &gt;failed.
</I>&gt;<i> &gt;[04/Nov/2011:15:31:43 --0700]
</I>&gt;<i> &gt;[xxxxxxxxx.xxx/sid#36acbf0][rid#3ad72f0][/xxxxxx.cgi][9] Rule failed,
</I>&gt;<i> &gt;not chained -&gt; mode NEXT_RULE.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;Ross.
</I>&gt;<i> 
</I>&gt;<i> Update the path to Lua in the advanced_filter_converter.lua script to
</I>&gt;<i> ensure it matches where the lua binary is installed on your system.  See
</I>&gt;<i> if that helps.
</I>&gt;<i> 
</I>&gt;<i> -Ryan
</I>
Ryan,

This did help a little, the path was in need of updating, so I made that
change, but the problem persisted. This lead me to try running the lua
scripts from the command line which resulted in &quot;module 'rex_pcre' not
found&quot;. I'm wondering if anyone is aware of a Debian (lenny) rex_pcre
package, or an easy way to install it - I've been struggling with the
source from <A HREF="http://luaforge.net/projects/lrexlib/">http://luaforge.net/projects/lrexlib/</A> with little luck so
far (it's looking like some issues on amd64, but I'm not certain).

Appreciate any pointers that anyone might have.

Ross.



&gt;<i> 
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;This is an installation on a Debian 5.0.9 server, I believe that the
</I>&gt;<i> &gt;&gt; &gt;necessary requirements are installed:
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;libapr1            : 1.2.12-5+lenny4
</I>&gt;<i> &gt;&gt; &gt;libapr1-dev        : 1.2.12-5+lenny4
</I>&gt;<i> &gt;&gt; &gt;libaprutil1        : 1.2.12+dfsg-8+lenny5
</I>&gt;<i> &gt;&gt; &gt;libaprutil1-dev    : 1.2.12+dfsg-8+lenny5
</I>&gt;<i> &gt;&gt; &gt;lua5.1             : 5.1.3-1
</I>&gt;<i> &gt;&gt; &gt;liblua5.1-0        : 5.1.3-1
</I>&gt;<i> &gt;&gt; &gt;liblua5.1-0-dev    : 5.1.3-1
</I>&gt;<i> &gt;&gt; &gt;libpcre3           : 7.6-2.1
</I>&gt;<i> &gt;&gt; &gt;libpcre3-dev       : 7.6-2.1
</I>&gt;<i> &gt;&gt; &gt;libxml2            : 2.6.32.dfsg-5+lenny4
</I>&gt;<i> &gt;&gt; &gt;libxml2-dev        : 2.6.32.dfsg-5+lenny4
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;Apache 2.2.21 is installed from source using the following configure:
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;./configure \
</I>&gt;<i> &gt;&gt; &gt;--prefix=/usr/local/apache \
</I>&gt;<i> &gt;&gt; &gt;--disable-userdir \
</I>&gt;<i> &gt;&gt; &gt;--enable-rewrite \
</I>&gt;<i> &gt;&gt; &gt;--enable-so \
</I>&gt;<i> &gt;&gt; &gt;--enable-status \
</I>&gt;<i> &gt;&gt; &gt;--enable-info \
</I>&gt;<i> &gt;&gt; &gt;--enable-ssl \
</I>&gt;<i> &gt;&gt; &gt;--enable-cgi \
</I>&gt;<i> &gt;&gt; &gt;--enable-unique-id \
</I>&gt;<i> &gt;&gt; &gt;--enable-mime-magic \
</I>&gt;<i> &gt;&gt; &gt;--with-included-apr \
</I>&gt;<i> &gt;&gt; &gt;--with-pcre=/usr/bin/pcre-config \
</I>&gt;<i> &gt;&gt; &gt;--enable-deflate \
</I>&gt;<i> &gt;&gt; &gt;--enable-expires \
</I>&gt;<i> &gt;&gt; &gt;--enable-headers
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;ModSecurity 2.6.2 is installed with the following configure:
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;./configure \
</I>&gt;<i> &gt;&gt; &gt;--with-apxs=/usr/local/apache/bin/apxs \
</I>&gt;<i> &gt;&gt; &gt;--with-apr=/usr/local/apache/bin/apr-1-config
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;I've only made minor path changes to the ModSecurity config, and a few
</I>&gt;<i> &gt;&gt; &gt;rule rewrites for some false positives in the CRS configuration.
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;I'm assuming this is a result of
</I>&gt;<i> &gt;&gt; &gt;modsecurity_crs_41_advanced_filters.conf somehow, but I'm not entirely
</I>&gt;<i> &gt;&gt; &gt;sure how -- or whether this is necessary, or purely optional (although
</I>&gt;<i> &gt;&gt; &gt;it's part of the base_rules).
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;Appreciate any help or suggestions that anyone can give.
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;Ross.
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;_______________________________________________
</I>&gt;<i> &gt;&gt; &gt;Owasp-modsecurity-core-rule-set mailing list
</I>&gt;<i> &gt;&gt; &gt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set</A>
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; This transmission may contain information that is privileged,
</I>&gt;<i> &gt;&gt;confidential, and/or exempt from disclosure under applicable law. If you
</I>&gt;<i> &gt;&gt;are not the intended recipient, you are hereby notified that any
</I>&gt;<i> &gt;&gt;disclosure, copying, distribution, or use of the information contained
</I>&gt;<i> &gt;&gt;herein (including any reliance thereon) is STRICTLY PROHIBITED. If you
</I>&gt;<i> &gt;&gt;received this transmission in error, please immediately contact the
</I>&gt;<i> &gt;&gt;sender and destroy the material in its entirety, whether in electronic
</I>&gt;<i> &gt;&gt;or hard copy format.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
</I>&gt;<i> 
</I>

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000915.html">[Owasp-modsecurity-core-rule-set] Lua nil value error
</A></li>
	<LI>Next message: <A HREF="000917.html">[Owasp-modsecurity-core-rule-set] Lua nil value error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#916">[ date ]</a>
              <a href="thread.html#916">[ thread ]</a>
              <a href="subject.html#916">[ subject ]</a>
              <a href="author.html#916">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
