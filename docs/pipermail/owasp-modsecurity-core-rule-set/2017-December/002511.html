<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Setting tx.anomaly_score before including crs-setup.conf somehow works, should it?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Setting%20tx.anomaly_score%0A%20before%20including%20crs-setup.conf%20somehow%20works%2C%20should%20it%3F&In-Reply-To=%3C20171204134749.6s2yfds4dsw22rkk%40leander%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002510.html">
   <LINK REL="Next"  HREF="002512.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Setting tx.anomaly_score before including crs-setup.conf somehow works, should it?</H1>
    <B>Christian Folini</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Setting%20tx.anomaly_score%0A%20before%20including%20crs-setup.conf%20somehow%20works%2C%20should%20it%3F&In-Reply-To=%3C20171204134749.6s2yfds4dsw22rkk%40leander%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] Setting tx.anomaly_score before including crs-setup.conf somehow works, should it?">christian.folini at netnea.com
       </A><BR>
    <I>Mon Dec  4 13:47:49 UTC 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="002510.html">[Owasp-modsecurity-core-rule-set] Setting tx.anomaly_score before including crs-setup.conf somehow works, should it?
</A></li>
        <LI>Next message: <A HREF="002512.html">[Owasp-modsecurity-core-rule-set] Setting tx.anomaly_score before including crs-setup.conf somehow works, should it?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2511">[ date ]</a>
              <a href="thread.html#2511">[ thread ]</a>
              <a href="subject.html#2511">[ subject ]</a>
              <a href="author.html#2511">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Cristian,

No, this works perfectly. Let me tell you why:

The crs-setup.conf does not actually set the threshold. Instead the
REQUEST-901 initialization file sets the threshold to the default value
if it is not set.

You are setting the anomaly score in your rule file in modsecurity, so no
need to set it to the default during the initialization.

This is very close to what I personally favor: Setting it in the server
config and not in an include. That way the threshold is always in plane sight.
Same for paranoia level btw.

Ahoj,

Christian


On Mon, Dec 04, 2017 at 02:21:39PM +0100, Cristian Mammoli wrote:
&gt;<i> Hi, I'm using CRS 3.0.2 on ModSec 2.9.2
</I>&gt;<i> 
</I>&gt;<i> I'm including crs like this:
</I>&gt;<i> 
</I>&gt;<i> [<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">root at waf01</A> ~]# tail -n 3 /etc/httpd/conf.d/000_mod_security.conf
</I>&gt;<i> IncludeOptional /etc/httpd/modsecurity.d/*.conf
</I>&gt;<i> IncludeOptional /etc/httpd/crs/crs-setup.conf
</I>&gt;<i> IncludeOptional /etc/httpd/crs/rules/*.conf
</I>&gt;<i> 
</I>&gt;<i> I'm using rules in modsecurity.d/ for custom rules and so on
</I>&gt;<i> I would expect that setting tx.anomaly_score in a rule file in modsecurity.d
</I>&gt;<i> would make no sense, since the var get reset in
</I>&gt;<i> crs/rules/REQUEST-901-INITIALIZATION.conf (901200) which gets loaded AFTER
</I>&gt;<i> my rules.
</I>&gt;<i> 
</I>&gt;<i> But it somehow works, for example this rule in
</I>&gt;<i> modsecurity.d/local_rules.conf
</I>&gt;<i> 
</I>&gt;<i> # Spamhaus XBL (scoring)
</I>&gt;<i> SecRule REMOTE_ADDR &quot;@rbl xbl.spamhaus.org&quot; \
</I>&gt;<i>   &quot;msg:'Client IP in xbl.spamhaus.org.',\
</I>&gt;<i>   severity:'CRITICAL',\
</I>&gt;<i>   id:10003,\
</I>&gt;<i>   phase:request,\
</I>&gt;<i>   pass,\
</I>&gt;<i>   t:none,\
</I>&gt;<i>   tag:'application-multi',\
</I>&gt;<i>   tag:'language-multi',\
</I>&gt;<i>   tag:'platform-multi',\
</I>&gt;<i>   tag:'attack-reputation-ip',\
</I>&gt;<i>   setvar:'tx.msg=%{rule.msg}',\
</I>&gt;<i>   setvar:tx.anomaly_score=+10,\
</I>&gt;<i> setvar:tx.%{rule.id}-AUTOMATION/MALICIOUS-%{matched_var_name}=%{matched_var}
</I>&gt;<i> 
</I>&gt;<i> The additional 10 points get counted in the final TX:inbound_anomaly_score
</I>&gt;<i> and causes the request to be rejected.
</I>&gt;<i> 
</I>&gt;<i> This is _exactly_ what I want :) But as far as I understand it shouldn't
</I>&gt;<i> work or I don't get in which order the rules are included and evaluated
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Owasp-modsecurity-core-rule-set mailing list
</I>&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>
</I>&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set</A>
</I>
-- 
<A HREF="https://www.feistyduck.com/training/modsecurity-training-course">https://www.feistyduck.com/training/modsecurity-training-course</A>
<A HREF="https://www.feistyduck.com/books/modsecurity-handbook/">https://www.feistyduck.com/books/modsecurity-handbook/</A>
mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">christian.folini at netnea.com</A>
twitter: @ChrFolini
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002510.html">[Owasp-modsecurity-core-rule-set] Setting tx.anomaly_score before including crs-setup.conf somehow works, should it?
</A></li>
	<LI>Next message: <A HREF="002512.html">[Owasp-modsecurity-core-rule-set] Setting tx.anomaly_score before including crs-setup.conf somehow works, should it?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2511">[ date ]</a>
              <a href="thread.html#2511">[ thread ]</a>
              <a href="subject.html#2511">[ subject ]</a>
              <a href="author.html#2511">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
