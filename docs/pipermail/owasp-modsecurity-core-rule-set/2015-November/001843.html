<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Rules 981172 and 981173 in 3.0.0
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Rules%20981172%20and%20981173%20in%0A%203.0.0&In-Reply-To=%3C20151124093345.GA3657%40elias%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001842.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Rules 981172 and 981173 in 3.0.0</H1>
    <B>Christian Folini</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Rules%20981172%20and%20981173%20in%0A%203.0.0&In-Reply-To=%3C20151124093345.GA3657%40elias%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] Rules 981172 and 981173 in 3.0.0">christian.folini at netnea.com
       </A><BR>
    <I>Tue Nov 24 09:33:45 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="001842.html">[Owasp-modsecurity-core-rule-set] Rules 981172 and 981173 in 3.0.0
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1843">[ date ]</a>
              <a href="thread.html#1843">[ thread ]</a>
              <a href="subject.html#1843">[ subject ]</a>
              <a href="author.html#1843">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Chaim,

I have not heard from you, but thought about this some more.
The paranoia-rules in the 2.9.x line don't go out of my head.

Why don't we introduce setvar:tx.paranoia with with an integer
indicating the paranoia level?

Starting paranoia=1, 981172/3 would be enabled. With 2, new rules with
even stricter limits are executed etc.

That way, the mechanism is completely open to host additional strict
rules where the danger of false positives is higher than with the
standard rules. The default is 0.

If I do not hear from you, I will write a pull request implementing
this idea for 3.0.0-dev.

Ahoj,

Christian


On Fri, Nov 20, 2015 at 03:20:30PM +0100, Christian Folini wrote:
&gt;<i> Hello Chaim,
</I>&gt;<i> 
</I>&gt;<i> Thank you for your swift response. I am glad to find an open hear for
</I>&gt;<i> my concern.
</I>&gt;<i> 
</I>&gt;<i> You are talking about a flag to be set in id:900024, right?
</I>&gt;<i> So that would be 
</I>&gt;<i> setvar:tx.strictsqlichecks=1
</I>&gt;<i> ?
</I>&gt;<i> 
</I>&gt;<i> And 981173 would be more or less (halfway rewritten for 3.0.0, NOT
</I>&gt;<i> TESTED) the following?
</I>&gt;<i> SecRule ARGS_NAMES|ARGS|XML:/* &quot;([\~\!\@\#\$\%\^\&amp;\*\(\)\-\+\=\{\}\[\]\|\:\;\&quot;\'\&#180;\&#8217;\&#8216;\`\&lt;\&gt;].*?){4,}&quot; \
</I>&gt;<i> 	&quot;msg:'Restricted SQL Character Anomaly Detection Alert - Total # of special characters exceeded',\
</I>&gt;<i> 	phase:2,\
</I>&gt;<i> 	id:'981173',\
</I>&gt;<i> 	rev:'2',\
</I>&gt;<i> 	ver:'OWASP_CRS/2.2.9',\
</I>&gt;<i> 	maturity:'9',\
</I>&gt;<i> 	accuracy:'8',\
</I>&gt;<i> 	t:none,\
</I>&gt;<i> 	t:urlDecodeUni,\
</I>&gt;<i> 	block,\
</I>&gt;<i> 	capture,\
</I>&gt;<i> 	tag:'OWASP_CRS/WEB_ATTACK/SQL_INJECTION',\
</I>&gt;<i> 	setvar:tx.anomaly_score=+%{tx.warning_anomaly_score},\
</I>&gt;<i> 	setvar:tx.sql_injection_score=+1,\
</I>&gt;<i> 	setvar:'tx.msg=%{rule.msg}',\
</I>&gt;<i> 	setvar:tx.%{rule.id}-OWASP_CRS/WEB_ATTACK/RESTRICTED_SQLI_CHARS-%{matched_var_name}=%{tx.0},\
</I>&gt;<i> 	logdata:'Matched Data: %{TX.1} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
</I>&gt;<i> 	chain&quot;
</I>&gt;<i> 	SecRule	TX:strictsqlichecks &quot;@eq 1&quot; &quot;t:none,chain&quot;
</I>&gt;<i> 		SecRule &lt;PSEUDO: Handle UUID false positives&gt;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> In the 2.x.x version, there are the optional and the base_rules. Now it
</I>&gt;<i> is all in the same folder. But that's a design decision, right?
</I>&gt;<i> 
</I>&gt;<i> But then, the way the rules in RESPONSE-51-DATA-LEAKAGES-SQL.conf are
</I>&gt;<i> written, the rules are executed for every request, but alerts are only
</I>&gt;<i> triggered if the tx.flag variables are set. Why did you construct it
</I>&gt;<i> with that pattern?
</I>&gt;<i> 
</I>&gt;<i> In the end, I don't mind too much. As long as 98117[23] come along into
</I>&gt;<i> 3.0.0. However given the wide scope of the strings triggering the rules,
</I>&gt;<i> the name could be a bit wider than strictsqlichecks. How about 
</I>&gt;<i> strictfreetextcheck
</I>&gt;<i> strictevasionchecks
</I>&gt;<i> strictinjectionchecks
</I>&gt;<i> 
</I>&gt;<i> Additional idea:
</I>&gt;<i> Why not define it as an integer value defaulting to 1. You can raise it
</I>&gt;<i> to 2 or 3 or event 4. With 2 981173 is enabled as is. When you raise the
</I>&gt;<i> integer value to 3, a new rule is enabled, that sets an even lower limit
</I>&gt;<i> of special characters etc.
</I>&gt;<i> 
</I>&gt;<i> What do you think?
</I>&gt;<i> 
</I>&gt;<i> Best,
</I>&gt;<i> 
</I>&gt;<i> Christian
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> On Thu, Nov 19, 2015 at 07:50:33PM +0000, Chaim Sanders wrote:
</I>&gt;<i> &gt; Hey Christian,
</I>&gt;<i> &gt; You hit the nail RIGHT on the head when you described why I allowed that previous pull to go through, it was because we don't see them in the 3.x ruleset so it seemed a minor fix to appease the given issue. Your fix is certainly more elegant.
</I>&gt;<i> &gt; I am more than willing to accept a pull request for these in 3.x however I would say that we would probably surround them with option var checks that would by default be disabled such as (EnableStricterSQLChecks). If we do this we get the best of both worlds in terms of security minded folks like yourself who don't mind customizing rules and people just running the rules. We see this approach taken elsewhere in CRS (see the database specific rules) and it puts more emphasis on configuration, which I think is nice for newer folks. What do you think about that?
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; I will say that when we push these rules historically to new clients (who aren't willing to change their code) these rules VERY VERY frequently required changing and this is why we chose to remove them from 3.x thinking that @detectXSS would pick up some of the slack.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; I do appreciate that you kept track of this :)
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; -----Original Message-----
</I>&gt;<i> &gt; From: <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set-bounces at lists.owasp.org</A> [mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set-bounces at lists.owasp.org</A>] On Behalf Of Christian Folini
</I>&gt;<i> &gt; Sent: Thursday, November 19, 2015 5:13 AM
</I>&gt;<i> &gt; To: <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>
</I>&gt;<i> &gt; Subject: [Owasp-modsecurity-core-rule-set] Rules 981172 and 981173 in 3.0.0
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Hi there,
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; The rule 981173 was recently updated in the 2.9 core rule branch to reduce the uuid induced false positives for the rule.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Uuids are indeed a major source of false positives on this rule, also in installations I know.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; The said update pulled in a request which raised the limit of acceptable number of special characters from 3 to 4. This is the rule as it stands now with &quot;{5,}&quot; meaning an alert is triggered when
</I>&gt;<i> &gt; 5 special chars are detected.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; <A HREF="http://scanmail.trustwave.com/?c=4062&amp;d=habN1ipw_me0uz_Jn7rWtjU8vrdSXYQXySS7s9Jh8Q&amp;s=5&amp;u=https%3a%2f%2fgithub%2ecom%2fSpiderLabs%2fowasp-modsecurity-crs%2fpull%2f263">http://scanmail.trustwave.com/?c=4062&amp;d=habN1ipw_me0uz_Jn7rWtjU8vrdSXYQXySS7s9Jh8Q&amp;s=5&amp;u=https%3a%2f%2fgithub%2ecom%2fSpiderLabs%2fowasp-modsecurity-crs%2fpull%2f263</A>
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; SecRule ARGS_NAMES|ARGS|XML:/* &quot;([\~\!\@\#\$\%\^\&amp;\*\(\)\-\+\=\{\}\[\]\|\:\;\&quot;\'\&#180;\&#8217;\&#8216;\`\&lt;\&gt;].*?){5,}&quot; &quot;phase:2,t:none,t:urlDecodeUni,block,id:'981173',rev:'2',ver:'OWASP_CRS/2.2.9',maturity:'9',accuracy:'8',msg:'Restricted SQL Character Anomaly Detection Alert - Total # of special characters exceeded',capture,logdata:'Matched Data: %{TX.1} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',tag:'OWASP_CRS/WEB_ATTACK/SQL_INJECTION',setvar:tx.anomaly_score=+%{tx.warning_anomaly_score},setvar:tx.sql_injection_score=+1,setvar:'tx.msg=%{rule.msg}',setvar:tx.%{rule.id}-OWASP_CRS/WEB_ATTACK/RESTRICTED_SQLI_CHARS-%{matched_var_name}=%{tx.0}&quot;
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; I think coping with the uuid problem is a good idea. But raising the limit seems a poor handling of the false positives, when a whitelisting of the uuid pattern like
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; [0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}
</I>&gt;<i> &gt; or simpler
</I>&gt;<i> &gt; ^[0-9a-f-]{36}$
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; would have been enough.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; It's true, that 981173 and it's ally 981172 are gone with the upcoming
</I>&gt;<i> &gt; 3.0.0 release. So maybe this little update is not very significant.
</I>&gt;<i> &gt; But I think it is.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; And I think 981173 and 981172 should stay. Not only because of SQLi, But because they are the guardsmen doing a lot of dirty work for many installations beyond SQLi. In many, many occasions, when there is something amiss with a request, 981172 and 73 will issue an alert.
</I>&gt;<i> &gt; The false positive rate is high, I admit. But in my experience, many attackers managed to evade most other rules, but these two guardsmen still alerted. Remember 981173 used to alert on the occurrence of 4 special characters in a parameter. So I would argue, that the false negative rate of 981172 and 981173 is lower than with other rules.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; The two rules come with an anomaly score of &quot;warning&quot;. That's fair given the high false positive rate and still enough to examine their alarms.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; So I propose to include them into 3.0.0 as well. I think there is still some room in REQUEST-42-APPLICATION-ATTACK-SQLI.conf for these two guys. I plan to issue a pull request to accomplish this.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; It will take some feedback for this proposal to go through. So please give me some. Maybe we can improve the rules before the said pull request.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Best,
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Christian Folini
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; --
</I>&gt;<i> &gt; The most dangerous thought that you can have as a creative person is to think that you know what you're doing. Because once you think you know what you're doing you stop looking around for other ways of doing things and you stop being able to see other ways of doing things.
</I>&gt;<i> &gt; You become blind.
</I>&gt;<i> &gt; -- Bret Victor
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; Owasp-modsecurity-core-rule-set mailing list <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>
</I>&gt;<i> &gt; <A HREF="http://scanmail.trustwave.com/?c=4062&amp;d=habN1ipw_me0uz_Jn7rWtjU8vrdSXYQXySa869E7_w&amp;s=5&amp;u=https%3a%2f%2flists%2eowasp%2eorg%2fmailman%2flistinfo%2fowasp-modsecurity-core-rule-set">http://scanmail.trustwave.com/?c=4062&amp;d=habN1ipw_me0uz_Jn7rWtjU8vrdSXYQXySa869E7_w&amp;s=5&amp;u=https%3a%2f%2flists%2eowasp%2eorg%2fmailman%2flistinfo%2fowasp-modsecurity-core-rule-set</A>
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; ________________________________
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is strictly prohibited. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
</I>&gt;<i> 
</I>&gt;<i> -- 
</I>&gt;<i> Christian Folini
</I>&gt;<i> Ringstrasse 2
</I>&gt;<i> CH-3639 Kiesen
</I>&gt;<i> +41 (0)31 301 60 71 (H)
</I>&gt;<i> +41 (0)79 220 23 76 (M)
</I>&gt;<i> mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">christian.folini at netnea.com</A> (Business)
</I>&gt;<i> mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">christian.folini at time-machine.ch</A> (Private)
</I>&gt;<i> <A HREF="http://www.christian-folini.ch">http://www.christian-folini.ch</A>
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Owasp-modsecurity-core-rule-set mailing list
</I>&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>
</I>&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set</A>
</I></PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001842.html">[Owasp-modsecurity-core-rule-set] Rules 981172 and 981173 in 3.0.0
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1843">[ date ]</a>
              <a href="thread.html#1843">[ thread ]</a>
              <a href="subject.html#1843">[ subject ]</a>
              <a href="author.html#1843">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
