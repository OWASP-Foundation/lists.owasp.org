<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] CSRF Attack Detected - Invalid Token
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20CSRF%20Attack%20Detected%20-%0A%20Invalid%20Token&In-Reply-To=%3CDUB119-W326C848024A833E1C740682730%40phx.gbl%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002144.html">
   <LINK REL="Next"  HREF="002146.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] CSRF Attack Detected - Invalid Token</H1>
    <B>Barry Pollard</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20CSRF%20Attack%20Detected%20-%0A%20Invalid%20Token&In-Reply-To=%3CDUB119-W326C848024A833E1C740682730%40phx.gbl%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] CSRF Attack Detected - Invalid Token">barry_pollard at hotmail.com
       </A><BR>
    <I>Thu May 12 09:01:53 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="002144.html">[Owasp-modsecurity-core-rule-set] CSRF Attack Detected - Invalid Token
</A></li>
        <LI>Next message: <A HREF="002146.html">[Owasp-modsecurity-core-rule-set] CSRF Attack Detected - Invalid Token
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2145">[ date ]</a>
              <a href="thread.html#2145">[ thread ]</a>
              <a href="subject.html#2145">[ subject ]</a>
              <a href="author.html#2145">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Dauto (and Christian),
I had a look at this rule before and am not a fan.
CSRF_TOKEN's should come from the app in my mind and not the WAF. However ModSecurity does have a method of using them, which is an interesting proof of concept, but I think it's flaky for a number of reasons.
The way it works is it uses collections to store the CSRF_TOKEN. Rule 981145 uses content injection to inject a bit of Javascript to set the CSRF token on any URLs or forms for any HTML pages requested and when the subsequent request comes in after rule 981144 compares the CSRF_TOKEN in the collection and rejects any requests without a valid token. The below rule is firing because it didn't match.
It's an interesting idea, and would work in certain scenarios, but I can see multiple issues with it. For a start when first turning it on none of the current messages will have CSRF tokens so need to think about how to deploy, and the content injection concept has multiple issues in my mind, but for me the biggest issues is with collections.
Collections is, IMHO, one of the weak points of ModSecurity. As soon as you get any volume of traffic Modsecurity struggles to cope with the file based SDBM format it uses to hold collections. I (and lots of others) see multiple issues with managing collections, from alerts like &quot;collections_remove_stale: Failed deleting collection&quot; to collections growing massively in size unless periodically deleted, to collections not working across multiple instances of Apache/ModSecurity without a complicated sharing mechanism...etc.
Maybe this will be improved in ModSecurity v3 which might have memcache based collections rather than disk based collections but for now, collections cannot really be relied upon in my view (though others may disagree). They are fine (just!) for rate limiting (where missing an odd update or read of collection doesn't matter too much as, in worst case you just don't block until a little later), but cannot be used when you need to reply on them. And CSRF_TOKEN's need to reply on them or they reject messages. Hoping it is fixed in v3 as reliable collections open up a wealth of opportunities like this CSRF implementation (though still wouldn't recommend it for CSRF for other reasons mentioned briefly above).
Anyway for now I don't recommend using this (or most of the optional rules to be honest).
Thanks,Barry

 		 	   		  
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20160512/8f2f5426/attachment.html">http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20160512/8f2f5426/attachment.html</A>&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002144.html">[Owasp-modsecurity-core-rule-set] CSRF Attack Detected - Invalid Token
</A></li>
	<LI>Next message: <A HREF="002146.html">[Owasp-modsecurity-core-rule-set] CSRF Attack Detected - Invalid Token
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2145">[ date ]</a>
              <a href="thread.html#2145">[ thread ]</a>
              <a href="subject.html#2145">[ subject ]</a>
              <a href="author.html#2145">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
