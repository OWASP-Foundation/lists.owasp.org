<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] CSRF Attack Detected - Invalid Token
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20CSRF%20Attack%20Detected%20-%0A%20Invalid%20Token&In-Reply-To=%3C10F5694F-41AA-4E46-A7F2-CC40FE286331%40owasp.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002146.html">
   <LINK REL="Next"  HREF="002149.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] CSRF Attack Detected - Invalid Token</H1>
    <B>Ryan Barnett</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20CSRF%20Attack%20Detected%20-%0A%20Invalid%20Token&In-Reply-To=%3C10F5694F-41AA-4E46-A7F2-CC40FE286331%40owasp.org%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] CSRF Attack Detected - Invalid Token">ryan.barnett at owasp.org
       </A><BR>
    <I>Thu May 12 12:44:06 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="002146.html">[Owasp-modsecurity-core-rule-set] CSRF Attack Detected - Invalid Token
</A></li>
        <LI>Next message: <A HREF="002149.html">[Owasp-modsecurity-core-rule-set] arg name not resolving for large	post value
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2147">[ date ]</a>
              <a href="thread.html#2147">[ thread ]</a>
              <a href="subject.html#2147">[ subject ]</a>
              <a href="author.html#2147">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey everyone,
Thought I would come &quot;out the shadows&quot; and comment on this topic since I was the one who created those CSRF rules -
These are definitely PoC level rules.  They were intended to show ModSecurity&#8217;s content injection capabilities and this was just one use-case.
The actual JS code that is injected (<A HREF="https://github.com/SpiderLabs/owasp-modsecurity-crs/blob/master/optional_rules/modsecurity_crs_43_csrf_protection.conf#L42-L107">https://github.com/SpiderLabs/owasp-modsecurity-crs/blob/master/optional_rules/modsecurity_crs_43_csrf_protection.conf#L42-L107</A>) is adapted from the older OWASP CSRFGuard code and it has limitations in its ability to properly modify all DOM elements to add the CSRF token.  There is newer code available for that project that addresses some of these limitations - <A HREF="https://github.com/esheri3/OWASP-CSRFGuard/blob/master/csrfguard/src/main/resources/csrfguard.js">https://github.com/esheri3/OWASP-CSRFGuard/blob/master/csrfguard/src/main/resources/csrfguard.js</A>
If you want to still try and use this &#8211; you probably want to modify which URLs are enforcing this logic as currently it is matching all - <A HREF="https://github.com/SpiderLabs/owasp-modsecurity-crs/blob/master/optional_rules/modsecurity_crs_43_csrf_protection.conf#L30">https://github.com/SpiderLabs/owasp-modsecurity-crs/blob/master/optional_rules/modsecurity_crs_43_csrf_protection.conf#L30</A>
In addition to also requiring that the session hijacking conf file is activated - <A HREF="https://github.com/SpiderLabs/owasp-modsecurity-crs/blob/master/optional_rules/modsecurity_crs_16_session_hijacking.conf#L44-L45">https://github.com/SpiderLabs/owasp-modsecurity-crs/blob/master/optional_rules/modsecurity_crs_16_session_hijacking.conf#L44-L45</A> &#8211; you also should activate the Ignore Static Content conf file so that you aren&#8217;t triggering alerts for request to static image files, etc.. - <A HREF="https://github.com/SpiderLabs/owasp-modsecurity-crs/blob/master/optional_rules/modsecurity_crs_10_ignore_static.conf">https://github.com/SpiderLabs/owasp-modsecurity-crs/blob/master/optional_rules/modsecurity_crs_10_ignore_static.conf</A>
You might also want to try to use the @rsub approach mentioned at the bottom of this blog post - <A HREF="https://www.trustwave.com/Resources/SpiderLabs-Blog/Detecting-Malice-with-ModSecurity--(Updated">https://www.trustwave.com/Resources/SpiderLabs-Blog/Detecting-Malice-with-ModSecurity--(Updated</A>)-CSRF-Attacks/.  This will modify the FORM HTML and inject the token directly into it vs. appending a bunch of JS and then having it modify the DOM.
Now, if I were to try to tackle CSRF today in ModSecurity, I would use the RSUB approach (above) along with JS append to implement the Double-Submit Cookie anti-CSRF approach - <A HREF="http://appsandsecurity.blogspot.com/2012/01/stateless-csrf-protection.html.">http://appsandsecurity.blogspot.com/2012/01/stateless-csrf-protection.html.</A>  The advantage to this approach is that it is &#8220;stateless&#8221; meaning that you won&#8217;t have to use ModSecurity&#8217;s SDBM persistent storage.  If you are injecting the same anti-CSRF token value as BOTH a hidden FORM param and as a new Cookie value then all ModSecurity WAF has to do is make sure that URLs that you want to protect (e.g. - POST requests to URL /checkout, etc&#8230;) have BOTH the CSRF param and cookie and that they BOTH match each other.
One last comment &#8211; Perfection is the Enemy of Good.  While anti-CSRF tokens are sexy don&#8217;t sleep on good old Referer Enforcement checks.  If you have a workflow that follows a strict path and you want to prevent CSRF attacks, you can simply craft up some SecRules that check the Method + URL + Referer(s) and block ones that are: 1) Missing Referer, 2) Coming from off-domain, or 3) Not coming from your on-domain approved Referer page list.
Hope this info helps.
Ryan


From:  &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set-bounces at lists.owasp.org</A>&gt; on behalf of Christian Folini &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">christian.folini at netnea.com</A>&gt;
Date:  Thursday, May 12, 2016 at 5:20 AM
To:  Barry Pollard &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">barry_pollard at hotmail.com</A>&gt;
Cc:  &quot;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;
Subject:  Re: [Owasp-modsecurity-core-rule-set] CSRF Attack Detected - Invalid Token

Barry,

On Thu, May 12, 2016 at 10:01:53AM +0100, Barry Pollard wrote:
 I had a look at this rule before and am not a fan.  
 CSRF_TOKEN's
 should come from the app in my mind and not the WAF. However
 ModSecurity does have a method of using them, which is an interesting
 proof of concept, but I think it's flaky for a number of reasons.

Thank you for sharing your experience / observations. This was exactly 
my impression of this rule as well.

I have sites in production that use persistent collections and
prepend/append constructs. But the scope is very limited and none
is high traffic.

So yes, this can be made to work, but it's a road that is rarely
travelled. It's kind of adventurous. 

Ahoj,

Christian

-- 
If you have men who will only come if they know there is a good road, 
I don't want them. I want men who will come if there is no road at all.
-- David Livingstone
_______________________________________________
Owasp-modsecurity-core-rule-set mailing list
<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>
<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set</A>


-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20160512/960aa497/attachment.html">http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20160512/960aa497/attachment.html</A>&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002146.html">[Owasp-modsecurity-core-rule-set] CSRF Attack Detected - Invalid Token
</A></li>
	<LI>Next message: <A HREF="002149.html">[Owasp-modsecurity-core-rule-set] arg name not resolving for large	post value
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2147">[ date ]</a>
              <a href="thread.html#2147">[ thread ]</a>
              <a href="subject.html#2147">[ subject ]</a>
              <a href="author.html#2147">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
