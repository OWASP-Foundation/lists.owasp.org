<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] DoS Protection Problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20DoS%20Protection%20Problem&In-Reply-To=%3CCA%2BQch%3DKfhTV%3D%3DvMEooj20ty4x%2B56yKBVGQtLbZFH8Kv%3Doiw_fQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001387.html">
   <LINK REL="Next"  HREF="001389.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] DoS Protection Problem</H1>
    <B>Nick</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20DoS%20Protection%20Problem&In-Reply-To=%3CCA%2BQch%3DKfhTV%3D%3DvMEooj20ty4x%2B56yKBVGQtLbZFH8Kv%3Doiw_fQ%40mail.gmail.com%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] DoS Protection Problem">darknovanick at gmail.com
       </A><BR>
    <I>Tue May  7 17:36:47 UTC 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="001387.html">[Owasp-modsecurity-core-rule-set] CRS Installation Confusion
</A></li>
        <LI>Next message: <A HREF="001389.html">[Owasp-modsecurity-core-rule-set] Could you please help me check	this
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1388">[ date ]</a>
              <a href="thread.html#1388">[ thread ]</a>
              <a href="subject.html#1388">[ subject ]</a>
              <a href="author.html#1388">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I've been experimenting with this modsecurity_crs_11_dos_protection.conf
ruleset more. An outline of how it seems to work:

- Every non-image request increments the ip.dos_counter counter.
- If that counter is &gt; tx.dos_counter_threshold, it increments
ip.dos_burst_counter, sets an expiration time on ip.dos_burst_counter, and
clears ip.dos_counter
- If ip.dos_burst_counter &gt; ip.dos_burst_threshold, it blocks the request
until tx.dos_block_timeout seconds elapses

The rational behind the burst counter seems to be because mod_security
expiration doesn't work based on the FIRST write to a variable, it works
based on the most recent write. In my case, I'm using a time slice of 60
seconds, but if a bot requests a page every 10 seconds for hours it will
never expire ip_dos_counter, the only time that will happen is if they
don't do any requests for 60 seconds. So, this burst counter is designed to
try to get around this problem by waiting until the dos_counter is over the
threshold (which doesn't really prove anything about how fast requests were
being made, only that the user has done a bunch of requests without
pausing) and then it increments the burst counter which has an expiration
time (in my case, 60 seconds) and clears out the dos_counter. So, if the
dos counter gets up to the threshold AGAIN, then it knows that those
requests really all have come in the past 60 seconds, so it knows that the
user is requesting too quickly.

Great in theory, but this is broken.

The problem scenario:

- A bot (bingbot in my case) has been requesting pages for the past hour.
Averaging one or two requests per second. Nothing to worry about.
- The dos_counter is over the threshold because it has been submitting
requests for a long time without pausing
- Sometimes it submits 2-4 requests virtually simultaneously (on the same
second in the log)
- It submits 2 or more requests simultaneously. For EACH REQUEST,
mod_security sees that ip_dos_counter is over the threshold, so each
request increments ip_dos_burst_counter. bingbot is now blocked.

So this is an example where the bot was blocked even though it was
operating at a far slower rate than the DoS settings specify. If those 2
requests would have been spaced apart by a second, it would not have been
blocked. But, by submitting requests very close together, a bot can be
blocked without really submitting that many requests very quickly. This is
happening on my server at least every day.

I am new to mod_security so I'm still learning exactly how these rules
work, but are there any solutions to this problem? The way this rule is set
up, it seems to be operating on the principle that the rule is atomic when
it clearly isn't. If dos_counter would be cleared before the burst counter
is incremented, this problem wouldn't exist.

I'm also unclear on how this is coordinated across the multiple apache
processes. I understand this to be a collection, which resides on disk, so
I'm not sure when mod_security writes this information to disk.

Does anyone have any pointers for where to look, or a different DoS ruleset
to try?

Or is DoS protection not something that is possible with mod_security, and
I need another module? I don't need anything fancy, I just want to be able
to limit an IP address to a certain number of requests within a time
period. Thanks,

Nick


On Mon, Apr 29, 2013 at 12:49 PM, Nick &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">darknovanick at gmail.com</A>&gt; wrote:

&gt;<i> Hello,
</I>&gt;<i>
</I>&gt;<i> I've been setting up mod_security and enabled
</I>&gt;<i> the modsecurity_crs_11_dos_protection.conf rule. This is mod_security 2.6.8
</I>&gt;<i> and CRS version 2.2.5.
</I>&gt;<i>
</I>&gt;<i> I have initialized the settings with:
</I>&gt;<i> SecAction \
</I>&gt;<i>   &quot;id:'900015', \
</I>&gt;<i>   phase:1, \
</I>&gt;<i>   t:none, \
</I>&gt;<i>   setvar:'tx.dos_burst_time_slice=60', \
</I>&gt;<i>   setvar:'tx.dos_counter_threshold=300', \
</I>&gt;<i>   setvar:'tx.dos_block_timeout=600', \
</I>&gt;<i>   nolog, \
</I>&gt;<i>   pass&quot;
</I>&gt;<i>
</I>&gt;<i> This works and it is blocking some very aggressive bots the way it should.
</I>&gt;<i> But there is a problem. I have occasionally been getting lines like this in
</I>&gt;<i> the log:
</I>&gt;<i>
</I>&gt;<i> Warning. Operator GE matched 2 at IP:dos_burst_counter. [file
</I>&gt;<i> &quot;/etc/httpd/modsecurity.d/activated_rules/modsecurity_crs_11_dos_protection.conf&quot;]
</I>&gt;<i> [line &quot;44&quot;] [id &quot;981049&quot;] [msg &quot;Potential Denial of Service (DoS) Attack
</I>&gt;<i> from 65.55.24.236 - # of Request Bursts: 3&quot;]
</I>&gt;<i>
</I>&gt;<i> This bot was actually bingbot. I am new to mod_security, but my
</I>&gt;<i> understanding of my settings is that it shouldn't block until a bot has
</I>&gt;<i> requested 300 pages in 60 seconds.
</I>&gt;<i>
</I>&gt;<i> When I check the logs I see that IP 65.55.24.236 has requested 313 pages
</I>&gt;<i> in 1 hour. In the 60 seconds before the DoS block happening, this IP only
</I>&gt;<i> requested 6 pages. This block obviously shouldn't be happening.
</I>&gt;<i>
</I>&gt;<i> I am grossly misunderstanding something, or what can I do to fix this?
</I>&gt;<i> Thanks,
</I>&gt;<i>
</I>&gt;<i> Nick
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20130507/a8a5ea37/attachment.html">http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20130507/a8a5ea37/attachment.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001387.html">[Owasp-modsecurity-core-rule-set] CRS Installation Confusion
</A></li>
	<LI>Next message: <A HREF="001389.html">[Owasp-modsecurity-core-rule-set] Could you please help me check	this
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1388">[ date ]</a>
              <a href="thread.html#1388">[ thread ]</a>
              <a href="subject.html#1388">[ subject ]</a>
              <a href="author.html#1388">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
