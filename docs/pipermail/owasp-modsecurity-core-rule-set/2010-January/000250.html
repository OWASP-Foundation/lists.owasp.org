<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] More Squirrelmail Denials
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20More%20Squirrelmail%20Denials&In-Reply-To=1263384655.5661.12.camel%40localhost">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000249.html">
   <LINK REL="Next"  HREF="000251.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] More Squirrelmail Denials</H1>
    <B>Ryan Barnett</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20More%20Squirrelmail%20Denials&In-Reply-To=1263384655.5661.12.camel%40localhost"
       TITLE="[Owasp-modsecurity-core-rule-set] More Squirrelmail Denials">ryan.barnett at breach.com
       </A><BR>
    <I>Wed Jan 13 10:54:22 EST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="000249.html">[Owasp-modsecurity-core-rule-set] More Squirrelmail Denials
</A></li>
        <LI>Next message: <A HREF="000251.html">[Owasp-modsecurity-core-rule-set] More Squirrelmail Denials
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#250">[ date ]</a>
              <a href="thread.html#250">[ thread ]</a>
              <a href="subject.html#250">[ subject ]</a>
              <a href="author.html#250">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wednesday 13 January 2010 07:10:55 am Arthur Dent wrote:
&gt;<i> On Mon, 2010-01-11 at 22:22 +0000, Arthur Dent wrote:
</I>&gt;<i> &gt; On Wed, 2010-01-06 at 09:57 +0000, Arthur Dent wrote:
</I>&gt;<i> &gt; &gt; Hello all,
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Following a previous thread in which I described some denials related
</I>&gt;<i> &gt; &gt; to my squirrelmail web mail implementation (which were partially solved
</I>&gt;<i> &gt; &gt; by an upgrade to CRS 2.0.4) I still have some outstanding issues...
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Firstly, accessing squirrelmail is fine, but trying to read an
</I>&gt;<i> &gt; &gt; individual email causes the following:
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; --501b5102-H--
</I>&gt;<i> &gt; &gt; Message: Pattern match
</I>&gt;<i> &gt; &gt; &quot;^TX:phpids-(\d{1,2})-WEB_ATTACK/INJECTION-(\d)-(.*?)-(.*)$&quot; at
</I>&gt;<i> &gt; &gt; MATCHED_VAR_NAME. [file
</I>&gt;<i> &gt; &gt; &quot;/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_41_phpids_filters.
</I>&gt;<i> &gt; &gt;conf&quot;] [line &quot;62&quot;] [id &quot;phpids-18&quot;] [msg &quot;Detects JavaScript array
</I>&gt;<i> &gt; &gt; properties and methods&quot;] [data &quot;Matched Location: REQUEST_URI_RAW and
</I>&gt;<i> &gt; &gt; Matched Payload:
</I>&gt;<i> &gt; &gt; /mywm/src/right_main.php?pg_showall=0&amp;sort=0&amp;startmessage=1&amp;mailbox=fd/
</I>&gt;<i> &gt; &gt;flr&quot;] [severity &quot;CRITICAL&quot;] Message: Pattern match
</I>&gt;<i> &gt; &gt; &quot;^TX:phpids-(\d{1,2})-WEB_ATTACK/INJECTION-(\d)-(.*?)-(.*)$&quot; at
</I>&gt;<i> &gt; &gt; MATCHED_VAR_NAME. [file
</I>&gt;<i> &gt; &gt; &quot;/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_41_phpids_filters.
</I>&gt;<i> &gt; &gt;conf&quot;] [line &quot;293&quot;] [id &quot;phpids-1&quot;] [msg &quot;Detects JavaScript array
</I>&gt;<i> &gt; &gt; properties and methods&quot;] [data &quot;Matched Location: REQUEST_URI_RAW and
</I>&gt;<i> &gt; &gt; Matched Payload:
</I>&gt;<i> &gt; &gt; /mywm/src/right_main.php?pg_showall=0&amp;sort=0&amp;startmessage=1&amp;mailbox=fd/
</I>&gt;<i> &gt; &gt;flr&quot;] [severity &quot;CRITICAL&quot;] Message: Warning. Operator GE matched 5 at
</I>&gt;<i> &gt; &gt; TX:anomaly_score. [file
</I>&gt;<i> &gt; &gt; &quot;/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_60_correlation.con
</I>&gt;<i> &gt; &gt;f&quot;] [line &quot;46&quot;] [msg &quot;Transactional Anomaly Score (score 8): Detects
</I>&gt;<i> &gt; &gt; JavaScript array properties and methods&quot;] Apache-Handler: php5-script
</I>&gt;<i> &gt; &gt; Stopwatch: 1261498951073512 929285 (5949 35341 892372)
</I>&gt;<i> &gt; &gt; Response-Body-Transformed: Dechunked
</I>&gt;<i> &gt; &gt; Producer: ModSecurity for Apache/2.5.10 (<A HREF="http://www.modsecurity.org/">http://www.modsecurity.org/</A>);
</I>&gt;<i> &gt; &gt; core ruleset/2.0.4. Server: Apache/2.2.13 (Fedora)
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Secondly, attempting to add a new identity to my user within SM is
</I>&gt;<i> &gt; &gt; outright blocked and gives the following:
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; --f71bbe54-H--
</I>&gt;<i> &gt; &gt; Message: Pattern match
</I>&gt;<i> &gt; &gt; &quot;^TX:phpids-(\d{1,2})-WEB_ATTACK/INJECTION-(\d)-(.*?)-(.*)$&quot; at
</I>&gt;<i> &gt; &gt; MATCHED_VAR_NAME. [file
</I>&gt;<i> &gt; &gt; &quot;/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_41_phpids_filters.
</I>&gt;<i> &gt; &gt;conf&quot;] [line &quot;300&quot;] [id &quot;phpids-30&quot;] [msg &quot;Detects common XSS
</I>&gt;<i> &gt; &gt; concatenation patterns 1/2&quot;] [data &quot;Matched Location:
</I>&gt;<i> &gt; &gt; ARGS_NAMES:smaction[save][1] and Matched Payload: smaction[save][1]&quot;]
</I>&gt;<i> &gt; &gt; [severity &quot;CRITICAL&quot;] Message: Pattern match
</I>&gt;<i> &gt; &gt; &quot;^TX:phpids-(\d{1,2})-WEB_ATTACK/INJECTION-(\d)-(.*?)-(.*)$&quot; at
</I>&gt;<i> &gt; &gt; MATCHED_VAR_NAME. [file
</I>&gt;<i> &gt; &gt; &quot;/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_41_phpids_filters.
</I>&gt;<i> &gt; &gt;conf&quot;] [line &quot;412&quot;] [id &quot;phpids-3&quot;] [msg &quot;Detects common XSS
</I>&gt;<i> &gt; &gt; concatenation patterns 1/2&quot;] [data &quot;Matched Location:
</I>&gt;<i> &gt; &gt; ARGS_NAMES:smaction[save][1] and Matched Payload: smaction[save][1]&quot;]
</I>&gt;<i> &gt; &gt; [severity &quot;CRITICAL&quot;] Message: Warning. Operator GE matched 5 at
</I>&gt;<i> &gt; &gt; TX:anomaly_score. [file
</I>&gt;<i> &gt; &gt; &quot;/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_60_correlation.con
</I>&gt;<i> &gt; &gt;f&quot;] [line &quot;46&quot;] [msg &quot;Transactional Anomaly Score (score 36): Detects
</I>&gt;<i> &gt; &gt; common XSS concatenation patterns 1/2&quot;] Action: Intercepted (phase 2)
</I>&gt;<i> &gt; &gt; Apache-Handler: php5-script
</I>&gt;<i> &gt; &gt; Stopwatch: 1262715119800440 148552 (17244* 143302 -)
</I>&gt;<i> &gt; &gt; Producer: ModSecurity for Apache/2.5.10 (<A HREF="http://www.modsecurity.org/">http://www.modsecurity.org/</A>);
</I>&gt;<i> &gt; &gt; core ruleset/2.0.4. Server: Apache/2.2.13 (Fedora)
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; I notice that they are similar, but not identical.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; What steps should I take to get this application working properly?
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Thanks in advance for any help / guidance...
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Mark
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I am still no nearer solving this. Any ideas? (gentle bump!)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Mark
</I>&gt;<i> 
</I>&gt;<i> Am I asking this question in the wrong way, or have I not provided
</I>&gt;<i> sufficient information?
</I>&gt;<i> 
</I>&gt;<i> Hoping for some guidance...
</I>&gt;<i> 
</I>
Hey Mark,
Sorry for the delay.  

There is always a delicate balance between false negatives and false positives with 
developing these rules :(    If you look in the CHANGES file for the 2.0.2/2.0.3 updates, 
we were addressing false negative/bypass issues that were reported to us.  We chose to 
become a bit more aggressive in our detection.  While our updates helped to address those 
issues, they result in a higher false positive rate.  The main issue here is when we are 
applying these negative security regexs to an unparsed variable such as REQUEST_URI_RAW or 
REQUEST_BODY.  This data is essentially a blob of text and includes the = character for 
separating the parameter name from the parameter payload.  This results in a higher number 
of matches.  We are going to keep on tweaking these rules however as I am sure we do 
better.

Now, for your specific issue, what you want to do is to add some exceptions to the 48 local 
exceptions file.  Take a look at some of the examples in the file.  What you want to do is 
to create rules that will inspect the saved TX variable data from these PHPIDS rules that 
triggered.  If these exact matches occur, then you want to remove them and adjust the 
anomaly score.  Looks like there are 4 different phpids rule matches -
phpids-18
phpids-1
phpids-30
phpids-3

I tested your payloads with my current (newer) phpids filter file and only the phpids-18 and 
phpids-30 rules matched.  I believe that the other two matches will be fixed with the 
updated phpids filter in CRS 2.0.5.

Here are some examples (untested) based on the error_log snippets you showed above for 
phpids-18 and phpids-30 matches -

SecRule TX:'/PHPIDS-18-(.*)REQUEST_URI_RAW/' &quot;@contains &amp;sort=&quot; 
&quot;chain,phase:2,t:none,nolog,pass&quot;
       SecRule MATCHED_VAR_NAME &quot;TX\:(.*)&quot; &quot;capture,t:none,setvar:!tx.
%{tx.1},setvar:tx.anomaly_score=-4&quot;

SecRule &quot;TX:PHPIDS-30-WEB_ATTACK/INJECTION-2-Detects common XSS concatenation patterns 
1/2-ARGS_NAMES:smaction[save][1]&quot; &quot;@contains ][&quot; &quot;chain,phase:2,t:none,nolog,pass&quot;
       SecRule MATCHED_VAR_NAME &quot;TX\:(.*)&quot; &quot;capture,t:none,setvar:!tx.
%{tx.1},setvar:tx.anomaly_score=-4&quot;


Let me know if these help.
Ryan
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20100113/33713524/attachment-0001.html">https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20100113/33713524/attachment-0001.html</A> 
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000249.html">[Owasp-modsecurity-core-rule-set] More Squirrelmail Denials
</A></li>
	<LI>Next message: <A HREF="000251.html">[Owasp-modsecurity-core-rule-set] More Squirrelmail Denials
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#250">[ date ]</a>
              <a href="thread.html#250">[ thread ]</a>
              <a href="subject.html#250">[ subject ]</a>
              <a href="author.html#250">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
