<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] CRS v3.0.0-dev: Pull Request 255: Header Injection / More Request Smuggling
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20CRS%20v3.0.0-dev%3A%20Pull%20Request%20255%3A%0A%20Header%20Injection%20/%20More%20Request%20Smuggling&In-Reply-To=%3C20150921122641.GA29606%40elias%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001827.html">
   <LINK REL="Next"  HREF="001833.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] CRS v3.0.0-dev: Pull Request 255: Header Injection / More Request Smuggling</H1>
    <B>Christian Folini</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20CRS%20v3.0.0-dev%3A%20Pull%20Request%20255%3A%0A%20Header%20Injection%20/%20More%20Request%20Smuggling&In-Reply-To=%3C20150921122641.GA29606%40elias%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] CRS v3.0.0-dev: Pull Request 255: Header Injection / More Request Smuggling">christian.folini at time-machine.ch
       </A><BR>
    <I>Mon Sep 21 12:26:41 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="001827.html">[Owasp-modsecurity-core-rule-set] From 2.2.X to 3.0.0 (was: Re: Owasp-modsecurity-core-rule-set Digest, Vol 77, Issue 5)
</A></li>
        <LI>Next message: <A HREF="001833.html">[Owasp-modsecurity-core-rule-set] A Set of Performance Rules
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1832">[ date ]</a>
              <a href="thread.html#1832">[ thread ]</a>
              <a href="subject.html#1832">[ subject ]</a>
              <a href="author.html#1832">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Dear all,

After last week's complaints, it seems only fair and suitable to
follow up and contribute to the project. Here we go with something
that has been in my drawer for too long.

The core rules have strong sides and weaker spots. One spot that I think is not
very well developed is the whole http request splitting and header injection
field. I have been bitten twice and decided to act and develop a set of new
rules that would cover this attack vector in a generic way with the goal
to bring these rules into the core rules.

Achim Hoffmann joined me on this little project and while I coordinated
a big test run, he wrote most of the rules / regular expressions.

A generic attack / a prepared link which will result in a transparent
redirect to an evil site in case the handler action.do is vulnerable.
<A HREF="https://www.example.com/smartapp/action.do?param1=file&amp;file=foo.txt%0D%0ARefresh:%201;%20url=http://www.evilsite.com&amp;file_type=txt">https://www.example.com/smartapp/action.do?param1=file&amp;file=foo.txt%0D%0ARefresh:%201;%20url=http://www.evilsite.com&amp;file_type=txt</A>

This may sound foolish, but I have had two customers falling for
this sort of weakness.

In the stable Core-Rules, ModSecurity will only trigger
981173 : Restricted SQL Character Anomaly Detection Alert - Total # of special characters exceeded
In fact this rule is a false positive, as this is no SQL injection
going on, but at least it gave us a hint something is amiss.
981173 will result in a score of 5 points. In many if not most
installations, a score of 5 is below the threshold / limit
defined and the attack will thus pass the WAF.

In the v3.0.0 dev branch, things are not much better with
950907 Remote Command Execution (RCE) Attempt 
bring triggered.

The attack does a CR/LF and then brings an http response header.
Both in a query string to be sent as part of a request. This should
be quite easy to detect actually, and I think it can be done in a
very generic way. Detecting and blocking results in a successful
mitigation of the attack.

So this pull request vs. v.3.0.0-dev extends the existing protocol
attacks, that are listed in REQUEST-21-PROTOCOL-ATTACK.conf. In fact
the existing 3 rules are fairly similar to the new ones I am proposing
together with Achim, so there is a fair bit of redundancy (which adds
to the score, which makes blocking all the more likely).

Please see 
<A HREF="https://github.com/SpiderLabs/owasp-modsecurity-crs/pull/255">https://github.com/SpiderLabs/owasp-modsecurity-crs/pull/255</A>
for the rules, more detailed description and an assessment of the
false positive rates for the various rules. 4 of them do quite OK
in this regard. 950917 has a different milage though. It brings far
more false positives and pushing it into an area of optional paranoid
qould make sense, I guess.

I would appreciate, if you could review the pull request and
include it in the dev version 3.0.0. Obviously, I am open to
update the rules, if you have any suggestions.

Best regards,

Christian Folini


-- 
It's when they say 2 + 2 = 5 that I begin to argue.
-- Eric Pepke
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001827.html">[Owasp-modsecurity-core-rule-set] From 2.2.X to 3.0.0 (was: Re: Owasp-modsecurity-core-rule-set Digest, Vol 77, Issue 5)
</A></li>
	<LI>Next message: <A HREF="001833.html">[Owasp-modsecurity-core-rule-set] A Set of Performance Rules
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1832">[ date ]</a>
              <a href="thread.html#1832">[ thread ]</a>
              <a href="subject.html#1832">[ subject ]</a>
              <a href="author.html#1832">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
