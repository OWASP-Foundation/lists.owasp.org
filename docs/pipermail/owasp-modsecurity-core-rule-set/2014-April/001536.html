<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] &quot;multiple URL encoding&quot; matching unexpectedly
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20%22multiple%20URL%20encoding%22%0A%20matching%20unexpectedly&In-Reply-To=%3CCF6DA6B7.ECBCF%25rbarnett%40trustwave.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001535.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] &quot;multiple URL encoding&quot; matching unexpectedly</H1>
    <B>Ryan Barnett</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20%22multiple%20URL%20encoding%22%0A%20matching%20unexpectedly&In-Reply-To=%3CCF6DA6B7.ECBCF%25rbarnett%40trustwave.com%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] &quot;multiple URL encoding&quot; matching unexpectedly">RBarnett at trustwave.com
       </A><BR>
    <I>Fri Apr 11 18:04:59 UTC 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="001535.html">[Owasp-modsecurity-core-rule-set] &quot;multiple URL encoding&quot; matching unexpectedly
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1536">[ date ]</a>
              <a href="thread.html#1536">[ thread ]</a>
              <a href="subject.html#1536">[ subject ]</a>
              <a href="author.html#1536">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This regex was modified a long time ago to help prevent false positives when the @validateUrlEncoding operator was used - <A HREF="https://github.com/SpiderLabs/ModSecurity/wiki/Reference-Manual#validateUrlEncoding">https://github.com/SpiderLabs/ModSecurity/wiki/Reference-Manual#validateUrlEncoding</A>

Without this &#8211; the operator would throw errors when it saw any % sign with other chars after it other than the normal ranges.

We will look to improve it for CRS v3.0.0.

Ryan Barnett
Lead Security Researcher, SpiderLabs

Trustwave | SMART SECURITY ON DEMAND
www.trustwave.com&lt;<A HREF="http://www.trustwave.com/">http://www.trustwave.com/</A>&gt;

From: Ty &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">ty733420 at gmail.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">ty733420 at gmail.com</A>&gt;&gt;
Date: Tuesday, April 1, 2014 11:17 AM
To: &quot;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&gt;
Subject: [Owasp-modsecurity-core-rule-set] &quot;multiple URL encoding&quot; matching unexpectedly

I know this rule (950109) has been brought up on this list before because posters were confused by its behavior for various reasons.  I'm also by something very specific about it and so I'll get right to the point:

If this string (before URL encoding) appears in a parameter, the rule matches:

hello%0dworld

Which is expected, and I understand (percent followed by two potentially hex characters).  What I don't understand is why this string:

hello%world

also causes the rule to match, and I don't understand that (the following characters are not hexadecimal).  Looking at the regex, it would appear it's been written to look specifically for hex characters (and their unicode equivalent):

SecRule ARGS &quot;\%((?!$|\W)|[0-9a-fA-F]{2}|u[0-9a-fA-F]{4})&quot; \

But clearly it matches non-hex characters as well.  Am I misunderstanding how the rule should work, or is there a problem with the rule's regex?

Thanks,
Ty


________________________________

This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is strictly prohibited. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20140411/8b5c3c8a/attachment.html">http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20140411/8b5c3c8a/attachment.html</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001535.html">[Owasp-modsecurity-core-rule-set] &quot;multiple URL encoding&quot; matching unexpectedly
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1536">[ date ]</a>
              <a href="thread.html#1536">[ thread ]</a>
              <a href="subject.html#1536">[ subject ]</a>
              <a href="author.html#1536">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
