<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Paranoia Mode: Controversial candidate 958977 / 933110 and 958979 / 933120 (PHP Injection Attacks)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Paranoia%20Mode%3A%20Controversial%0A%20candidate%20958977%20/%20933110%20and%20958979%20/%20933120%20%28PHP%20Injection%20Attacks%29&In-Reply-To=%3CD2DCD071.1752C%25csanders%40trustwave.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001901.html">
   <LINK REL="Next"  HREF="001909.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Paranoia Mode: Controversial candidate 958977 / 933110 and 958979 / 933120 (PHP Injection Attacks)</H1>
    <B>Chaim Sanders</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Paranoia%20Mode%3A%20Controversial%0A%20candidate%20958977%20/%20933110%20and%20958979%20/%20933120%20%28PHP%20Injection%20Attacks%29&In-Reply-To=%3CD2DCD071.1752C%25csanders%40trustwave.com%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] Paranoia Mode: Controversial candidate 958977 / 933110 and 958979 / 933120 (PHP Injection Attacks)">CSanders at trustwave.com
       </A><BR>
    <I>Sun Feb  7 15:46:32 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="001901.html">[Owasp-modsecurity-core-rule-set] Paranoia Mode: Controversial	candidate 958977 / 933110 and 958979 / 933120 (PHP Injection	Attacks)
</A></li>
        <LI>Next message: <A HREF="001909.html">[Owasp-modsecurity-core-rule-set] Paranoia Mode: Controversial candidate 958977 / 933110 and 958979 / 933120 (PHP Injection Attacks)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1904">[ date ]</a>
              <a href="thread.html#1904">[ thread ]</a>
              <a href="subject.html#1904">[ subject ]</a>
              <a href="author.html#1904">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I like the ideas. The first thing I&#8217;d note is that individuals are free to
exclude or remove entire files so as long as the PHP file is named
REQUEST-XYZ-PHP-XYZ people running ASP should get this hint (hopefully)
this is why we name them in this way. In terms of splitting the files, I
most certainly agree with the &#8216;critical&#8217;. Again I caution against
splitting data files TOO finely as it will get confusing to support your
own instance but this is just a minor issue. As for those parenthesis. You
are right and this is actually my fault. I added them to prevent false
positives being reported commonly on Cpanel.

On 2/7/16, 8:58 AM,
&quot;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set-bounces at lists.owasp.org</A> on behalf of
Walter Hop&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set-bounces at lists.owasp.org</A> on
behalf of <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">modsec at spam.lifeforms.nl</A>&gt; wrote:

&gt;<i>On 02 Feb 2016, at 09:25, Christian Folini &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">christian.folini at netnea.com</A>&gt;
</I>&gt;<i>wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Like the previous post on 950907 / 932100, this is controversial because
</I>&gt;&gt;<i> of possible false positives due to a data file with strings:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i><A HREF="http://scanmail.trustwave.com/?c=4062&amp;d=7tO31v4ao2_NNeZ84J8wNSWydu00_AAPk">http://scanmail.trustwave.com/?c=4062&amp;d=7tO31v4ao2_NNeZ84J8wNSWydu00_AAPk</A>
</I>&gt;&gt;<i>vSmewhU_w&amp;s=5&amp;u=https%3a%2f%2fraw%2egithubusercontent%2ecom%2fSpiderLabs%
</I>&gt;&gt;<i>2fowasp-modsecurity-crs%2fv3%2e0%2e0-rc1%2frules%2fphp-function-names%2ed
</I>&gt;&gt;<i>ata
</I>&gt;&gt;<i>
</I>&gt;&gt;<i><A HREF="http://scanmail.trustwave.com/?c=4062&amp;d=7tO31v4ao2_NNeZ84J8wNSWydu00_AAPk">http://scanmail.trustwave.com/?c=4062&amp;d=7tO31v4ao2_NNeZ84J8wNSWydu00_AAPk</A>
</I>&gt;&gt;<i>qKjKQ1VqQ&amp;s=5&amp;u=https%3a%2f%2fraw%2egithubusercontent%2ecom%2fSpiderLabs%
</I>&gt;&gt;<i>2fowasp-modsecurity-crs%2fv3%2e0%2e0-rc1%2frules%2fphp-config-directives%
</I>&gt;&gt;<i>2edata
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Could these files be split in the manner explained in the message
</I>&gt;&gt;<i> before?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> After all, this rule scans input against strings like
</I>&gt;&gt;<i> dl, eval, exec, from, precision.
</I>&gt;<i>
</I>&gt;<i>I would advocate the same separation as in my previous post re
</I>&gt;<i>os-commands.
</I>&gt;<i>But we need a little more firepower for PHP in my opinion.
</I>&gt;<i>A detailed approach could go like this...
</I>&gt;<i>
</I>&gt;<i>1) Have the user indicate with setvar if they want to protect PHP, and
</I>&gt;<i>predicate the rules on that. All the non PHP shops will be solved from FP
</I>&gt;<i>instantly!
</I>&gt;<i>
</I>&gt;<i>2) We need to review the current data file:
</I>&gt;<i>- I&#8217;m missing some stuff there that I see in the wild every day such as:
</I>&gt;<i>gzinflate, gzdecode, gzuncompress, strrev, zlib_decode&#8230;
</I>&gt;<i>- I also see in some cases the parenthesis is added, like: /file(/ and
</I>&gt;<i>/assert(/. This seems easy to evade. In PHP, calling &#8220;assert      ($foo)&#8221;
</I>&gt;<i>or &#8220;assert\t\t\t($foo)&#8221; is just as valid. In this case, it was probably
</I>&gt;<i>done because those terms lead to FP. If so, we might move super common
</I>&gt;<i>terms with relatively low attacker interest, like assert, to the paranoid
</I>&gt;<i>list. But, in any case they should become more robust regexps like
</I>&gt;<i>&#8220;\bfile\s*(&#8220;.
</I>&gt;<i>
</I>&gt;<i>3) Separate the data file. Start with a small
</I>&gt;<i>&#8220;php-commands-critical.data&#8221; list. This should contain the usual suspects
</I>&gt;<i>used for:
</I>&gt;<i>- obfuscation: base64_decode, gzdecode, etc...
</I>&gt;<i>- execution: passthru, proc_open, shell_exec, call_user_func,
</I>&gt;<i>require_once, include_once...
</I>&gt;<i>- IO: file_get_contents, file_put_contents, fopen, fwrite...
</I>&gt;<i>- environment inspection and setting: error_reporting, function_exists,
</I>&gt;<i>ini_set, auto_prepend_file, sys_get_temp_dir...
</I>&gt;<i>
</I>&gt;<i>If any of those strings is present, it&#8217;s certainly an attack, except for
</I>&gt;<i>that single person who runs a PHP-related wiki. The list should only
</I>&gt;<i>contain the real red flags, don&#8217;t try to cleverly prevent FP using
</I>&gt;<i>complex regexps, and cannot contain any common English words (so
</I>&gt;<i>unfortunately &#8220;require&#8221; and &#8220;include&#8221; are off limits...)
</I>&gt;<i>
</I>&gt;<i>4) Other functions could go in &#8220;php-commands-functions.data&#8221;. This list
</I>&gt;<i>would be small and contain only *proper functions* having PHP syntax
</I>&gt;<i>&#8220;function()&#8221; and have names often used in natural text. To prevent FP we
</I>&gt;<i>look for the parenthesis. Let&#8217;s take example &#8220;system&#8221;, this is often
</I>&gt;<i>found in natural text, but an attacker wants to do &#8220;system(&#8220; so they need
</I>&gt;<i>parentheses and a word boundary at the start. So a regexp might look like
</I>&gt;<i>&quot;\bsystem\s*\(&#8220;. Because we have the regexp, FP is lowered. It would
</I>&gt;<i>still match stuff like &#8220;F*ck the system (yeah yeah)&#8221;
</I>&gt;<i>
</I>&gt;<i>5) Other PHP related terms could stay in &#8220;php-commands-common.data&#8221;. This
</I>&gt;<i>would list the PHP commands and terms of lesser interest.
</I>&gt;<i>
</I>&gt;<i>6) We&#8217;ll have to review if there are terms which are so common in natural
</I>&gt;<i>text that they&#8217;ll have to be moved to &#8220;php-commands-paranoid.data&#8221;. I
</I>&gt;<i>think this list might be as small as possible. Maybe stuff like &#8220;dl&#8221;,
</I>&gt;<i>&#8220;require&#8221;, &#8220;include&#8221;. It&#8217;s still likely to produce FP...
</I>&gt;<i>
</I>&gt;<i>7) String matching for PHP functions is not powerful enough. We need
</I>&gt;<i>generic rules that prevent PHP evasion. I don&#8217;t remember seeing this in
</I>&gt;<i>the wild, but an easy way to evade textual signature matches would be PHP
</I>&gt;<i>variable functions
</I>&gt;<i>(<A HREF="http://scanmail.trustwave.com/?c=4062&amp;d=7tO31v4ao2_NNeZ84J8wNSWydu00_AAPk">http://scanmail.trustwave.com/?c=4062&amp;d=7tO31v4ao2_NNeZ84J8wNSWydu00_AAPk</A>
</I>&gt;<i>vCjeQMDpQ&amp;s=5&amp;u=http%3a%2f%2fphp%2enet%2fmanual%2fen%2ffunctions%2evariabl
</I>&gt;<i>e-functions%2ephp%29 For instance, you can do the following to get around
</I>&gt;<i>the CRS:
</I>&gt;<i>
</I>&gt;<i>$aB_4c = 'fil' . 'e_get' . '_contents';
</I>&gt;<i>$aB_4c('...');
</I>&gt;<i>
</I>&gt;<i>So we want a generic signature to detect variable function call syntax.
</I>&gt;<i>Fortunately its syntax is very uncommon in natural text, so I&#8217;d advocate
</I>&gt;<i>putting this rule in normal mode.
</I>&gt;<i>
</I>&gt;<i>Anyway my &#8364;0.02 or maybe a bit more :)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>_______________________________________________
</I>&gt;<i>Owasp-modsecurity-core-rule-set mailing list
</I>&gt;<i><A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>
</I>&gt;<i><A HREF="http://scanmail.trustwave.com/?c=4062&amp;d=7tO31v4ao2_NNeZ84J8wNSWydu00_AAPkq">http://scanmail.trustwave.com/?c=4062&amp;d=7tO31v4ao2_NNeZ84J8wNSWydu00_AAPkq</A>
</I>&gt;<i>emcgoEpA&amp;s=5&amp;u=https%3a%2f%2flists%2eowasp%2eorg%2fmailman%2flistinfo%2fow
</I>&gt;<i>asp-modsecurity-core-rule-set
</I>

________________________________

This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is strictly prohibited. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
</PRE>

































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001901.html">[Owasp-modsecurity-core-rule-set] Paranoia Mode: Controversial	candidate 958977 / 933110 and 958979 / 933120 (PHP Injection	Attacks)
</A></li>
	<LI>Next message: <A HREF="001909.html">[Owasp-modsecurity-core-rule-set] Paranoia Mode: Controversial candidate 958977 / 933110 and 958979 / 933120 (PHP Injection Attacks)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1904">[ date ]</a>
              <a href="thread.html#1904">[ thread ]</a>
              <a href="subject.html#1904">[ subject ]</a>
              <a href="author.html#1904">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
