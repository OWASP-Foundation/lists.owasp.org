<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Paranoia Mode: Controversial	candidate 958977 / 933110 and 958979 / 933120 (PHP Injection	Attacks)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Paranoia%20Mode%3A%20Controversial%0A%09candidate%20958977%20/%20933110%20and%20958979%20/%20933120%20%28PHP%20Injection%0A%09Attacks%29&In-Reply-To=%3C54703590-4F48-4A1B-9271-E1E29A45FE39%40spam.lifeforms.nl%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001887.html">
   <LINK REL="Next"  HREF="001904.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Paranoia Mode: Controversial	candidate 958977 / 933110 and 958979 / 933120 (PHP Injection	Attacks)</H1>
    <B>Walter Hop</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Paranoia%20Mode%3A%20Controversial%0A%09candidate%20958977%20/%20933110%20and%20958979%20/%20933120%20%28PHP%20Injection%0A%09Attacks%29&In-Reply-To=%3C54703590-4F48-4A1B-9271-E1E29A45FE39%40spam.lifeforms.nl%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] Paranoia Mode: Controversial	candidate 958977 / 933110 and 958979 / 933120 (PHP Injection	Attacks)">modsec at spam.lifeforms.nl
       </A><BR>
    <I>Sun Feb  7 13:58:32 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="001887.html">[Owasp-modsecurity-core-rule-set] Paranoia Mode: Controversial candidate 958977 / 933110 and 958979 / 933120 (PHP Injection Attacks)
</A></li>
        <LI>Next message: <A HREF="001904.html">[Owasp-modsecurity-core-rule-set] Paranoia Mode: Controversial candidate 958977 / 933110 and 958979 / 933120 (PHP Injection Attacks)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1901">[ date ]</a>
              <a href="thread.html#1901">[ thread ]</a>
              <a href="subject.html#1901">[ subject ]</a>
              <a href="author.html#1901">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 02 Feb 2016, at 09:25, Christian Folini &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">christian.folini at netnea.com</A>&gt; wrote:
&gt;<i> 
</I>&gt;<i> Like the previous post on 950907 / 932100, this is controversial because
</I>&gt;<i> of possible false positives due to a data file with strings:
</I>&gt;<i> <A HREF="https://raw.githubusercontent.com/SpiderLabs/owasp-modsecurity-crs/v3.0.0-rc1/rules/php-function-names.data">https://raw.githubusercontent.com/SpiderLabs/owasp-modsecurity-crs/v3.0.0-rc1/rules/php-function-names.data</A>
</I>&gt;<i> <A HREF="https://raw.githubusercontent.com/SpiderLabs/owasp-modsecurity-crs/v3.0.0-rc1/rules/php-config-directives.data">https://raw.githubusercontent.com/SpiderLabs/owasp-modsecurity-crs/v3.0.0-rc1/rules/php-config-directives.data</A>
</I>&gt;<i> 
</I>&gt;<i> Could these files be split in the manner explained in the message
</I>&gt;<i> before?
</I>&gt;<i> 
</I>&gt;<i> After all, this rule scans input against strings like
</I>&gt;<i> dl, eval, exec, from, precision.
</I>
I would advocate the same separation as in my previous post re os-commands.
But we need a little more firepower for PHP in my opinion.
A detailed approach could go like this...

1) Have the user indicate with setvar if they want to protect PHP, and predicate the rules on that. All the non PHP shops will be solved from FP instantly!

2) We need to review the current data file:
- I&#8217;m missing some stuff there that I see in the wild every day such as: gzinflate, gzdecode, gzuncompress, strrev, zlib_decode&#8230;
- I also see in some cases the parenthesis is added, like: /file(/ and /assert(/. This seems easy to evade. In PHP, calling &#8220;assert      ($foo)&#8221; or &#8220;assert\t\t\t($foo)&#8221; is just as valid. In this case, it was probably done because those terms lead to FP. If so, we might move super common terms with relatively low attacker interest, like assert, to the paranoid list. But, in any case they should become more robust regexps like &#8220;\bfile\s*(&#8220;.

3) Separate the data file. Start with a small &#8220;php-commands-critical.data&#8221; list. This should contain the usual suspects used for:
- obfuscation: base64_decode, gzdecode, etc...
- execution: passthru, proc_open, shell_exec, call_user_func, require_once, include_once...
- IO: file_get_contents, file_put_contents, fopen, fwrite...
- environment inspection and setting: error_reporting, function_exists, ini_set, auto_prepend_file, sys_get_temp_dir...

If any of those strings is present, it&#8217;s certainly an attack, except for that single person who runs a PHP-related wiki. The list should only contain the real red flags, don&#8217;t try to cleverly prevent FP using complex regexps, and cannot contain any common English words (so unfortunately &#8220;require&#8221; and &#8220;include&#8221; are off limits...)

4) Other functions could go in &#8220;php-commands-functions.data&#8221;. This list would be small and contain only *proper functions* having PHP syntax &#8220;function()&#8221; and have names often used in natural text. To prevent FP we look for the parenthesis. Let&#8217;s take example &#8220;system&#8221;, this is often found in natural text, but an attacker wants to do &#8220;system(&#8220; so they need parentheses and a word boundary at the start. So a regexp might look like &quot;\bsystem\s*\(&#8220;. Because we have the regexp, FP is lowered. It would still match stuff like &#8220;F*ck the system (yeah yeah)&#8221; 

5) Other PHP related terms could stay in &#8220;php-commands-common.data&#8221;. This would list the PHP commands and terms of lesser interest.

6) We&#8217;ll have to review if there are terms which are so common in natural text that they&#8217;ll have to be moved to &#8220;php-commands-paranoid.data&#8221;. I think this list might be as small as possible. Maybe stuff like &#8220;dl&#8221;, &#8220;require&#8221;, &#8220;include&#8221;. It&#8217;s still likely to produce FP...

7) String matching for PHP functions is not powerful enough. We need generic rules that prevent PHP evasion. I don&#8217;t remember seeing this in the wild, but an easy way to evade textual signature matches would be PHP variable functions (<A HREF="http://php.net/manual/en/functions.variable-functions.php">http://php.net/manual/en/functions.variable-functions.php</A>). For instance, you can do the following to get around the CRS:

$aB_4c = 'fil' . 'e_get' . '_contents';
$aB_4c('...'); 

So we want a generic signature to detect variable function call syntax. Fortunately its syntax is very uncommon in natural text, so I&#8217;d advocate putting this rule in normal mode.

Anyway my &#8364;0.02 or maybe a bit more :)


</PRE>

































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001887.html">[Owasp-modsecurity-core-rule-set] Paranoia Mode: Controversial candidate 958977 / 933110 and 958979 / 933120 (PHP Injection Attacks)
</A></li>
	<LI>Next message: <A HREF="001904.html">[Owasp-modsecurity-core-rule-set] Paranoia Mode: Controversial candidate 958977 / 933110 and 958979 / 933120 (PHP Injection Attacks)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1901">[ date ]</a>
              <a href="thread.html#1901">[ thread ]</a>
              <a href="subject.html#1901">[ subject ]</a>
              <a href="author.html#1901">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
