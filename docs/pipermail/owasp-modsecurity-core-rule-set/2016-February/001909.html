<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Paranoia Mode: Controversial candidate 958977 / 933110 and 958979 / 933120 (PHP Injection Attacks)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Paranoia%20Mode%3A%20Controversial%0A%20candidate%20958977%20/%20933110%20and%20958979%20/%20933120%20%28PHP%20Injection%20Attacks%29&In-Reply-To=%3C20160207201206.GD30297%40elias%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001904.html">
   <LINK REL="Next"  HREF="001948.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Paranoia Mode: Controversial candidate 958977 / 933110 and 958979 / 933120 (PHP Injection Attacks)</H1>
    <B>Christian Folini</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Paranoia%20Mode%3A%20Controversial%0A%20candidate%20958977%20/%20933110%20and%20958979%20/%20933120%20%28PHP%20Injection%20Attacks%29&In-Reply-To=%3C20160207201206.GD30297%40elias%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] Paranoia Mode: Controversial candidate 958977 / 933110 and 958979 / 933120 (PHP Injection Attacks)">christian.folini at netnea.com
       </A><BR>
    <I>Sun Feb  7 20:12:06 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="001904.html">[Owasp-modsecurity-core-rule-set] Paranoia Mode: Controversial candidate 958977 / 933110 and 958979 / 933120 (PHP Injection Attacks)
</A></li>
        <LI>Next message: <A HREF="001948.html">[Owasp-modsecurity-core-rule-set] Paranoia Mode: Controversial candidate 958977 / 933110 and 958979 / 933120 (PHP Injection Attacks)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1909">[ date ]</a>
              <a href="thread.html#1909">[ thread ]</a>
              <a href="subject.html#1909">[ subject ]</a>
              <a href="author.html#1909">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

Your ideas are extremely valuable Walter. And even if I do not agree 
with your solutions to the letter, I love the fact that we are having
technical discussions on the merit of individual rules.

Chaim seems to be on the same page with me on the idea of
environment-specific rules and how to handle the enabling / disabling.

And then the problem of the granularity of the files. There is a
danger in overengineering things and making the configuration / tuning
too complex. In that light, I think splitting makes sense, but
ideally, we end up with 

xxx-standard.data
xxx-paranoia.data

However, you have a point that you can not alter the contents of these 
data files afterwards in a local setup in a safe way. So disabling Windows 
commands won't work unless we add specific data files with their own
rules, which can then be disabled.

I am really torn here.

In my stated fear of overloading the paranoia project / pull request,
I would appreciate to handle the big updates to individual rules
in separate pull requests - if possible. If it has to be, we include it.

Ahoj,

Christian


On Sun, Feb 07, 2016 at 03:46:32PM +0000, Chaim Sanders wrote:
&gt;<i> I like the ideas. The first thing I&#8217;d note is that individuals are free to
</I>&gt;<i> exclude or remove entire files so as long as the PHP file is named
</I>&gt;<i> REQUEST-XYZ-PHP-XYZ people running ASP should get this hint (hopefully)
</I>&gt;<i> this is why we name them in this way. In terms of splitting the files, I
</I>&gt;<i> most certainly agree with the &#8216;critical&#8217;. Again I caution against
</I>&gt;<i> splitting data files TOO finely as it will get confusing to support your
</I>&gt;<i> own instance but this is just a minor issue. As for those parenthesis. You
</I>&gt;<i> are right and this is actually my fault. I added them to prevent false
</I>&gt;<i> positives being reported commonly on Cpanel.
</I>&gt;<i> 
</I>&gt;<i> On 2/7/16, 8:58 AM,
</I>&gt;<i> &quot;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set-bounces at lists.owasp.org</A> on behalf of
</I>&gt;<i> Walter Hop&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set-bounces at lists.owasp.org</A> on
</I>&gt;<i> behalf of <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">modsec at spam.lifeforms.nl</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> &gt;On 02 Feb 2016, at 09:25, Christian Folini &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">christian.folini at netnea.com</A>&gt;
</I>&gt;<i> &gt;wrote:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Like the previous post on 950907 / 932100, this is controversial because
</I>&gt;<i> &gt;&gt; of possible false positives due to a data file with strings:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;<A HREF="http://scanmail.trustwave.com/?c=4062&amp;d=7tO31v4ao2_NNeZ84J8wNSWydu00_AAPk">http://scanmail.trustwave.com/?c=4062&amp;d=7tO31v4ao2_NNeZ84J8wNSWydu00_AAPk</A>
</I>&gt;<i> &gt;&gt;vSmewhU_w&amp;s=5&amp;u=https%3a%2f%2fraw%2egithubusercontent%2ecom%2fSpiderLabs%
</I>&gt;<i> &gt;&gt;2fowasp-modsecurity-crs%2fv3%2e0%2e0-rc1%2frules%2fphp-function-names%2ed
</I>&gt;<i> &gt;&gt;ata
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;<A HREF="http://scanmail.trustwave.com/?c=4062&amp;d=7tO31v4ao2_NNeZ84J8wNSWydu00_AAPk">http://scanmail.trustwave.com/?c=4062&amp;d=7tO31v4ao2_NNeZ84J8wNSWydu00_AAPk</A>
</I>&gt;<i> &gt;&gt;qKjKQ1VqQ&amp;s=5&amp;u=https%3a%2f%2fraw%2egithubusercontent%2ecom%2fSpiderLabs%
</I>&gt;<i> &gt;&gt;2fowasp-modsecurity-crs%2fv3%2e0%2e0-rc1%2frules%2fphp-config-directives%
</I>&gt;<i> &gt;&gt;2edata
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Could these files be split in the manner explained in the message
</I>&gt;<i> &gt;&gt; before?
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; After all, this rule scans input against strings like
</I>&gt;<i> &gt;&gt; dl, eval, exec, from, precision.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;I would advocate the same separation as in my previous post re
</I>&gt;<i> &gt;os-commands.
</I>&gt;<i> &gt;But we need a little more firepower for PHP in my opinion.
</I>&gt;<i> &gt;A detailed approach could go like this...
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;1) Have the user indicate with setvar if they want to protect PHP, and
</I>&gt;<i> &gt;predicate the rules on that. All the non PHP shops will be solved from FP
</I>&gt;<i> &gt;instantly!
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;2) We need to review the current data file:
</I>&gt;<i> &gt;- I&#8217;m missing some stuff there that I see in the wild every day such as:
</I>&gt;<i> &gt;gzinflate, gzdecode, gzuncompress, strrev, zlib_decode&#8230;
</I>&gt;<i> &gt;- I also see in some cases the parenthesis is added, like: /file(/ and
</I>&gt;<i> &gt;/assert(/. This seems easy to evade. In PHP, calling &#8220;assert      ($foo)&#8221;
</I>&gt;<i> &gt;or &#8220;assert\t\t\t($foo)&#8221; is just as valid. In this case, it was probably
</I>&gt;<i> &gt;done because those terms lead to FP. If so, we might move super common
</I>&gt;<i> &gt;terms with relatively low attacker interest, like assert, to the paranoid
</I>&gt;<i> &gt;list. But, in any case they should become more robust regexps like
</I>&gt;<i> &gt;&#8220;\bfile\s*(&#8220;.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;3) Separate the data file. Start with a small
</I>&gt;<i> &gt;&#8220;php-commands-critical.data&#8221; list. This should contain the usual suspects
</I>&gt;<i> &gt;used for:
</I>&gt;<i> &gt;- obfuscation: base64_decode, gzdecode, etc...
</I>&gt;<i> &gt;- execution: passthru, proc_open, shell_exec, call_user_func,
</I>&gt;<i> &gt;require_once, include_once...
</I>&gt;<i> &gt;- IO: file_get_contents, file_put_contents, fopen, fwrite...
</I>&gt;<i> &gt;- environment inspection and setting: error_reporting, function_exists,
</I>&gt;<i> &gt;ini_set, auto_prepend_file, sys_get_temp_dir...
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;If any of those strings is present, it&#8217;s certainly an attack, except for
</I>&gt;<i> &gt;that single person who runs a PHP-related wiki. The list should only
</I>&gt;<i> &gt;contain the real red flags, don&#8217;t try to cleverly prevent FP using
</I>&gt;<i> &gt;complex regexps, and cannot contain any common English words (so
</I>&gt;<i> &gt;unfortunately &#8220;require&#8221; and &#8220;include&#8221; are off limits...)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;4) Other functions could go in &#8220;php-commands-functions.data&#8221;. This list
</I>&gt;<i> &gt;would be small and contain only *proper functions* having PHP syntax
</I>&gt;<i> &gt;&#8220;function()&#8221; and have names often used in natural text. To prevent FP we
</I>&gt;<i> &gt;look for the parenthesis. Let&#8217;s take example &#8220;system&#8221;, this is often
</I>&gt;<i> &gt;found in natural text, but an attacker wants to do &#8220;system(&#8220; so they need
</I>&gt;<i> &gt;parentheses and a word boundary at the start. So a regexp might look like
</I>&gt;<i> &gt;&quot;\bsystem\s*\(&#8220;. Because we have the regexp, FP is lowered. It would
</I>&gt;<i> &gt;still match stuff like &#8220;F*ck the system (yeah yeah)&#8221;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;5) Other PHP related terms could stay in &#8220;php-commands-common.data&#8221;. This
</I>&gt;<i> &gt;would list the PHP commands and terms of lesser interest.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;6) We&#8217;ll have to review if there are terms which are so common in natural
</I>&gt;<i> &gt;text that they&#8217;ll have to be moved to &#8220;php-commands-paranoid.data&#8221;. I
</I>&gt;<i> &gt;think this list might be as small as possible. Maybe stuff like &#8220;dl&#8221;,
</I>&gt;<i> &gt;&#8220;require&#8221;, &#8220;include&#8221;. It&#8217;s still likely to produce FP...
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;7) String matching for PHP functions is not powerful enough. We need
</I>&gt;<i> &gt;generic rules that prevent PHP evasion. I don&#8217;t remember seeing this in
</I>&gt;<i> &gt;the wild, but an easy way to evade textual signature matches would be PHP
</I>&gt;<i> &gt;variable functions
</I>&gt;<i> &gt;(<A HREF="http://scanmail.trustwave.com/?c=4062&amp;d=7tO31v4ao2_NNeZ84J8wNSWydu00_AAPk">http://scanmail.trustwave.com/?c=4062&amp;d=7tO31v4ao2_NNeZ84J8wNSWydu00_AAPk</A>
</I>&gt;<i> &gt;vCjeQMDpQ&amp;s=5&amp;u=http%3a%2f%2fphp%2enet%2fmanual%2fen%2ffunctions%2evariabl
</I>&gt;<i> &gt;e-functions%2ephp%29 For instance, you can do the following to get around
</I>&gt;<i> &gt;the CRS:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;$aB_4c = 'fil' . 'e_get' . '_contents';
</I>&gt;<i> &gt;$aB_4c('...');
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;So we want a generic signature to detect variable function call syntax.
</I>&gt;<i> &gt;Fortunately its syntax is very uncommon in natural text, so I&#8217;d advocate
</I>&gt;<i> &gt;putting this rule in normal mode.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;Anyway my &#8364;0.02 or maybe a bit more :)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;_______________________________________________
</I>&gt;<i> &gt;Owasp-modsecurity-core-rule-set mailing list
</I>&gt;<i> &gt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>
</I>&gt;<i> &gt;<A HREF="http://scanmail.trustwave.com/?c=4062&amp;d=7tO31v4ao2_NNeZ84J8wNSWydu00_AAPkq">http://scanmail.trustwave.com/?c=4062&amp;d=7tO31v4ao2_NNeZ84J8wNSWydu00_AAPkq</A>
</I>&gt;<i> &gt;emcgoEpA&amp;s=5&amp;u=https%3a%2f%2flists%2eowasp%2eorg%2fmailman%2flistinfo%2fow
</I>&gt;<i> &gt;asp-modsecurity-core-rule-set
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ________________________________
</I>&gt;<i> 
</I>&gt;<i> This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is strictly prohibited. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Owasp-modsecurity-core-rule-set mailing list
</I>&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>
</I>&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set</A>
</I>
-- 
mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">christian.folini at netnea.com</A>
<A HREF="http://www.christian-folini.ch">http://www.christian-folini.ch</A>
twitter: @ChrFolini
</PRE>





























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001904.html">[Owasp-modsecurity-core-rule-set] Paranoia Mode: Controversial candidate 958977 / 933110 and 958979 / 933120 (PHP Injection Attacks)
</A></li>
	<LI>Next message: <A HREF="001948.html">[Owasp-modsecurity-core-rule-set] Paranoia Mode: Controversial candidate 958977 / 933110 and 958979 / 933120 (PHP Injection Attacks)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1909">[ date ]</a>
              <a href="thread.html#1909">[ thread ]</a>
              <a href="subject.html#1909">[ subject ]</a>
              <a href="author.html#1909">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
