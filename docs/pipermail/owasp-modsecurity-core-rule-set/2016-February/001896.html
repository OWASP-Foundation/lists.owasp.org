<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Phase request
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Phase%20request&In-Reply-To=%3C20160204195633.GA19405%40elias%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001895.html">
   <LINK REL="Next"  HREF="001916.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Phase request</H1>
    <B>Christian Folini</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Phase%20request&In-Reply-To=%3C20160204195633.GA19405%40elias%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] Phase request">christian.folini at time-machine.ch
       </A><BR>
    <I>Thu Feb  4 19:56:33 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="001895.html">[Owasp-modsecurity-core-rule-set] Phase request
</A></li>
        <LI>Next message: <A HREF="001916.html">[Owasp-modsecurity-core-rule-set] Phase request
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1896">[ date ]</a>
              <a href="thread.html#1896">[ thread ]</a>
              <a href="subject.html#1896">[ subject ]</a>
              <a href="author.html#1896">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Aymeric,

On Thu, Feb 04, 2016 at 10:29:44AM +0000, CHAIB Aymeric (MORPHO) wrote:
&gt;<i> I noticed that the version 3 of CRS ruleset sometimes transforms the rule phase: from phase:1 (v2.2.9) to phase:request. But phase:request just translates to phase:2 (request body) and, if I understand the phase processing correctly, requests that do not contain a body will not be checked against phase:2 rules. (Well, this is what I observe in my debugging logs. Don't know if it is the ModSecurity standard behavior or if it comes from my implementation.)
</I>
It's a bit different.

Traditionally ModSec has 5 phases:
1 
2 
3 
4
5

5 is the logging phase when the request is already over.
3 and 4 are the response header and response body phases.

With 1 and 2 things are more complicated.

1 used to be the phase running after the requests headers
where received. But then people constantly complained the
rules in containers as directory / location would simply 
be ignored (container springing into action only when the
request body was received). So Ivan Risti&#263; (somebody correct 
me if it was not him) gave up and pushed phase 1 on the same 
apache hook as phase 2.

This means, that phase 1 runs on the same apache hook
as phase 2. But phase 1 runs before phase 2. (which is
a neat detail for some of the more adventurous rule
contructs).

The method (or the fact that a request has a body or not)
is irrelevant for the phases. Phase 2 happens no matter
if there is a body or not.

If you are not happy with the merging of phase 1 and phase
2, then you can compile ModSec with the option
--enable-request-early. That is a good practice in my eyes.
For it allows you to block a request _before_ you
start to receive the request body. This could come to your 
advantage in special situations like the prevention of
file uploads etc.

Lately, some of the phases received an alias:
 2 - request
 4 - response
 5 - logging

But that's just an alias.

Hope this helps. So it was a conscious move, but that does not
mean that I think the general shift of rules onto phase 2 was
a very good idea.

Ahoj,

Christian




&gt;<i> 
</I>&gt;<i> A typical example is the rule id 960911 (REQUEST-20-PROTOCOL-ENFORCEMENT) which validates the HTTP request line: it seems to me that it should be validated for requests including those without body, but the phase is now phase:request on CRS v3.
</I>&gt;<i> 
</I>&gt;<i> Besides, there are a lot of other examples in REQUEST-21-PROTOCOL-ATTACK where it seems to me that the rules should be put on phase:1. (E.g. smuggling, response splitting.)
</I>&gt;<i> The same applies to REQUEST-10-IP-REPUTATION.
</I>&gt;<i> 
</I>&gt;<i> Do I miss something ? Is this a conscious choice ?
</I>&gt;<i> Thanks for enlightening me.
</I>&gt;<i> 
</I>&gt;<i> Regards,
</I>&gt;<i> Aymeric Chaib
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> &quot; This e-mail and any attached documents may contain confidential or proprietary information. If you are not the intended recipient, you are notified that any dissemination, copying of this e-mail and any attachments thereto or use of their contents by any means whatsoever is strictly prohibited. If you have received this e-mail in error, please advise the sender immediately and delete this e-mail and all attached documents from your computer system.&quot;
</I>&gt;<i> #
</I>
&gt;<i> _______________________________________________
</I>&gt;<i> Owasp-modsecurity-core-rule-set mailing list
</I>&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>
</I>&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set</A>
</I>
</PRE>


































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001895.html">[Owasp-modsecurity-core-rule-set] Phase request
</A></li>
	<LI>Next message: <A HREF="001916.html">[Owasp-modsecurity-core-rule-set] Phase request
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1896">[ date ]</a>
              <a href="thread.html#1896">[ thread ]</a>
              <a href="subject.html#1896">[ subject ]</a>
              <a href="author.html#1896">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
