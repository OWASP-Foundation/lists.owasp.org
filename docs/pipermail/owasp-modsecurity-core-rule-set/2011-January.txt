From RBarnett at trustwave.com  Mon Jan  3 09:48:03 2011
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Mon, 3 Jan 2011 08:48:03 -0600
Subject: [Owasp-modsecurity-core-rule-set] ModSecurity/Rules User Forums on
	SourceForge
Message-ID: <C93E2875.16A6F%rbarnett@trustwave.com>

Happy New Year to Everyone!

Just wanted to let everyone know that we have setup some User Forums on SourceForge so that the community can have another mechanism to discuss issues (besides only the email lists).  Here is the link to the Rules Forum -
http://sourceforge.net/projects/mod-security/forums/forum/1298046

Hope you find these useful.

-Ryan



From scastle at bouldercounty.org  Mon Jan  3 15:35:19 2011
From: scastle at bouldercounty.org (Castle, Shane)
Date: Mon, 3 Jan 2011 13:35:19 -0700
Subject: [Owasp-modsecurity-core-rule-set] librabot: block or permit?
Message-ID: <6009E57E59F29A43B7460CE724C42DF1028C220E@EVS1B.boco.co.boulder.co.us>

I've been blocking librabot if it appears in the user-agent. Info online
is sketchy about whether or not librabot is bad; one person claimed that
it did not honor robots.txt, and another at Microsoft said that it
wasn't anything of theirs, in spite of the Microsoft reference (see
request snippet below). The connecting addresses often don't resolve at
all (i.e., no PTR records in DNS).

So is there any consensus on whether or not it should be blocked? My
conclusion so far is that I should continue to block it.

Part of request:
   From: librabot at microsoft.com
   User-Agent: librabot/2.0 (+http://academic.research.microsoft.com/)

-- 
Shane Castle
Data Security Mgr, Boulder County IT
CISSP GSEC GCIH



From JM9991 at att.com  Mon Jan  3 17:53:59 2011
From: JM9991 at att.com (MARTIN, JASON (ATTSI))
Date: Mon, 3 Jan 2011 14:53:59 -0800
Subject: [Owasp-modsecurity-core-rule-set] librabot: block or permit?
In-Reply-To: <6009E57E59F29A43B7460CE724C42DF1028C220E@EVS1B.boco.co.boulder.co.us>
References: <6009E57E59F29A43B7460CE724C42DF1028C220E@EVS1B.boco.co.boulder.co.us>
Message-ID: <5889717B8EF90049926E1B6B68E220140EECA2AB@BD01MSXMB018.US.Cingular.Net>

Did librabot hit your site, and did it do anything unusual or abusive?

-Jason Martin

-----Original Message-----
From: owasp-modsecurity-core-rule-set-bounces at lists.owasp.org
[mailto:owasp-modsecurity-core-rule-set-bounces at lists.owasp.org] On
Behalf Of Castle, Shane
Sent: Monday, January 03, 2011 12:35 PM
To: owasp-modsecurity-core-rule-set at lists.owasp.org
Subject: [Owasp-modsecurity-core-rule-set] librabot: block or permit?

I've been blocking librabot if it appears in the user-agent. Info online
is sketchy about whether or not librabot is bad; one person claimed that
it did not honor robots.txt, and another at Microsoft said that it
wasn't anything of theirs, in spite of the Microsoft reference (see
request snippet below). The connecting addresses often don't resolve at
all (i.e., no PTR records in DNS).

So is there any consensus on whether or not it should be blocked? My
conclusion so far is that I should continue to block it.

Part of request:
   From: librabot at microsoft.com
   User-Agent: librabot/2.0 (+http://academic.research.microsoft.com/)

-- 
Shane Castle
Data Security Mgr, Boulder County IT
CISSP GSEC GCIH


_______________________________________________
Owasp-modsecurity-core-rule-set mailing list
Owasp-modsecurity-core-rule-set at lists.owasp.org
https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set

From scastle at bouldercounty.org  Mon Jan  3 18:17:19 2011
From: scastle at bouldercounty.org (Castle, Shane)
Date: Mon, 3 Jan 2011 16:17:19 -0700
Subject: [Owasp-modsecurity-core-rule-set] librabot: block or permit?
In-Reply-To: <5889717B8EF90049926E1B6B68E220140EECA2AB@BD01MSXMB018.US.Cingular.Net>
References: <6009E57E59F29A43B7460CE724C42DF1028C220E@EVS1B.boco.co.boulder.co.us>
	<5889717B8EF90049926E1B6B68E220140EECA2AB@BD01MSXMB018.US.Cingular.Net>
Message-ID: <6009E57E59F29A43B7460CE724C42DF1028C2353@EVS1B.boco.co.boulder.co.us>

Well, it's been trying to crawl us; after about the first week I decided
to add a rule on the WAF to block it:

SecRule REQUEST_HEADERS:User-Agent "librabot" \
   "log,deny,auditlog,phase:2,status:404,t:lowercase,\
t:replaceNulls,t:compressWhitespace,tag:'AUTOMATION/MALICIOUS',\
severity:2,msg:'librabot User Agent String Detected'"

Can't say that I've actually seen anything outright malicious, but it
sure looks like a duck...

-- 
Shane Castle
Data Security Mgr, Boulder County IT
CISSP GSEC GCIH


-----Original Message-----
From: MARTIN, JASON (ATTSI) [mailto:JM9991 at att.com] 
Sent: Monday, January 03, 2011 15:54
To: Castle, Shane; owasp-modsecurity-core-rule-set at lists.owasp.org
Subject: RE: [Owasp-modsecurity-core-rule-set] librabot: block or
permit?

Did librabot hit your site, and did it do anything unusual or abusive?

-Jason Martin

-----Original Message-----
From: owasp-modsecurity-core-rule-set-bounces at lists.owasp.org
[mailto:owasp-modsecurity-core-rule-set-bounces at lists.owasp.org] On
Behalf Of Castle, Shane
Sent: Monday, January 03, 2011 12:35 PM
To: owasp-modsecurity-core-rule-set at lists.owasp.org
Subject: [Owasp-modsecurity-core-rule-set] librabot: block or permit?

I've been blocking librabot if it appears in the user-agent. Info online
is sketchy about whether or not librabot is bad; one person claimed that
it did not honor robots.txt, and another at Microsoft said that it
wasn't anything of theirs, in spite of the Microsoft reference (see
request snippet below). The connecting addresses often don't resolve at
all (i.e., no PTR records in DNS).

So is there any consensus on whether or not it should be blocked? My
conclusion so far is that I should continue to block it.

Part of request:
   From: librabot at microsoft.com
   User-Agent: librabot/2.0 (+http://academic.research.microsoft.com/)

-- 
Shane Castle
Data Security Mgr, Boulder County IT
CISSP GSEC GCIH


_______________________________________________
Owasp-modsecurity-core-rule-set mailing list
Owasp-modsecurity-core-rule-set at lists.owasp.org
https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set

From dyioulos at firstbhph.com  Tue Jan  4 15:01:56 2011
From: dyioulos at firstbhph.com (Dimitri Yioulos)
Date: Tue, 4 Jan 2011 15:01:56 -0500
Subject: [Owasp-modsecurity-core-rule-set] Anomoly Scoring Detection Mode
	not working
Message-ID: <201101041501.56766.dyioulos@firstbhph.com>

All,

After having read 
http://blog.spiderlabs.com/2010/11/advanced-topic-of-the-week-traditional-vs-anomaly-scoring-detection-modes.html, 
I decided to give Anomoly Scoring Detection Mode 
a try.  So, I set the following in 
modsecurity_crs_10_config.conf:

SecDefaultAction "phase:2,pass,log"

and

SecAction "phase:1,t:none,nolog,pass,setvar:tx.anomaly_score_blocking=on"

and restarted Apache.  With that done, I tried to 
reach our Web site, and was promptly met by the 
Apache test page.  Once I set 
modsecurity_crs_10_config.conf to Traditional 
Detection Mode, I was again able to reach our Web 
site.

Did I forget something in setting up Anomoly 
Scoring Detection Mode, or misconfigure 
something?

Thanks.

Dimitri

-- 
This message has been scanned for viruses and
dangerous content by MailScanner, and is
believed to be clean.


From jamuse at gmail.com  Tue Jan  4 15:21:41 2011
From: jamuse at gmail.com (Jamuse)
Date: Tue, 4 Jan 2011 22:21:41 +0200
Subject: [Owasp-modsecurity-core-rule-set] Anomoly Scoring Detection
 Mode not working
In-Reply-To: <201101041501.56766.dyioulos@firstbhph.com>
References: <201101041501.56766.dyioulos@firstbhph.com>
Message-ID: <AANLkTikLiwb9EY_Xe9_CsY5t+x1Ln3bX03U2Qt_TvV63@mail.gmail.com>

On Tue, Jan 4, 2011 at 10:01 PM, Dimitri Yioulos <dyioulos at firstbhph.com> wrote:
>
> Did I forget something in setting up Anomoly
> Scoring Detection Mode, or misconfigure
> something?

Hi Dimitri,

What do the logs say?

--
 - Josh

From dyioulos at firstbhph.com  Tue Jan  4 15:46:13 2011
From: dyioulos at firstbhph.com (Dimitri Yioulos)
Date: Tue, 4 Jan 2011 15:46:13 -0500
Subject: [Owasp-modsecurity-core-rule-set] Anomoly Scoring Detection
	Mode not working
In-Reply-To: <AANLkTikLiwb9EY_Xe9_CsY5t+x1Ln3bX03U2Qt_TvV63@mail.gmail.com>
References: <201101041501.56766.dyioulos@firstbhph.com>
	<AANLkTikLiwb9EY_Xe9_CsY5t+x1Ln3bX03U2Qt_TvV63@mail.gmail.com>
Message-ID: <201101041546.13834.dyioulos@firstbhph.com>

On Tuesday 04 January 2011 3:21:41 pm you wrote:
> On Tue, Jan 4, 2011 at 10:01 PM, Dimitri Yioulos 
<dyioulos at firstbhph.com> wrote:
> > Did I forget something in setting up Anomoly
> > Scoring Detection Mode, or misconfigure
> > something?
>
> Hi Dimitri,
>
> What do the logs say?
>
> --
>  - Josh


Josh,

I'm not great at deciphering the log messages that 
modsec generates. ?I think I've captured some 
relevant data, and put it here:

http://pastebin.com/kCQ9i8p4

Dimitri

-- 
This message has been scanned for viruses and
dangerous content by MailScanner, and is
believed to be clean.


From RBarnett at trustwave.com  Tue Jan  4 16:03:31 2011
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Tue, 4 Jan 2011 15:03:31 -0600
Subject: [Owasp-modsecurity-core-rule-set] Anomoly Scoring Detection
 Mode not working
In-Reply-To: <201101041546.13834.dyioulos@firstbhph.com>
References: <201101041501.56766.dyioulos@firstbhph.com>
	<AANLkTikLiwb9EY_Xe9_CsY5t+x1Ln3bX03U2Qt_TvV63@mail.gmail.com>
	<201101041546.13834.dyioulos@firstbhph.com>
Message-ID: <09B610B0-BA5F-486C-B858-FA8B175CFBA6@trustwave.com>

The alerts say that there was a user-agent string match (mozilla 4.0( ) with the comment spam rules.  This match raised the tx.inbound_anomaly_score to 3. What do you have this value set to in the 10 config file?  By default the blocking level is 5. 

--
Ryan Barnett


On Jan 4, 2011, at 3:46 PM, Dimitri Yioulos <dyioulos at firstbhph.com> wrote:

> On Tuesday 04 January 2011 3:21:41 pm you wrote:
>> On Tue, Jan 4, 2011 at 10:01 PM, Dimitri Yioulos 
> <dyioulos at firstbhph.com> wrote:
>>> Did I forget something in setting up Anomoly
>>> Scoring Detection Mode, or misconfigure
>>> something?
>> 
>> Hi Dimitri,
>> 
>> What do the logs say?
>> 
>> --
>> - Josh
> 
> 
> Josh,
> 
> I'm not great at deciphering the log messages that 
> modsec generates.  I think I've captured some 
> relevant data, and put it here:
> 
> http://pastebin.com/kCQ9i8p4
> 
> Dimitri
> 
> -- 
> This message has been scanned for viruses and
> dangerous content by MailScanner, and is
> believed to be clean.
> 
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set


From dyioulos at firstbhph.com  Tue Jan  4 16:22:20 2011
From: dyioulos at firstbhph.com (Dimitri Yioulos)
Date: Tue, 4 Jan 2011 16:22:20 -0500
Subject: [Owasp-modsecurity-core-rule-set] Anomoly Scoring Detection
	Mode not working
In-Reply-To: <09B610B0-BA5F-486C-B858-FA8B175CFBA6@trustwave.com>
References: <201101041501.56766.dyioulos@firstbhph.com>
	<201101041546.13834.dyioulos@firstbhph.com>
	<09B610B0-BA5F-486C-B858-FA8B175CFBA6@trustwave.com>
Message-ID: <201101041622.21524.dyioulos@firstbhph.com>

The value in the 10 config file is the default:

SecAction "phase:1,t:none,nolog,pass,setvar:tx.inbound_anomaly_score_level=5"
SecAction "phase:1,t:none,nolog,pass,setvar:tx.outbound_anomaly_score_level=4"

Dimitri


On Tuesday 04 January 2011 4:03:31 pm Ryan Barnett 
wrote:
> The alerts say that there was a user-agent
> string match (mozilla 4.0( ) with the comment
> spam rules.  This match raised the
> tx.inbound_anomaly_score to 3. What do you have
> this value set to in the 10 config file?  By
> default the blocking level is 5.
>
> --
> Ryan Barnett
>
> On Jan 4, 2011, at 3:46 PM, Dimitri Yioulos 
<dyioulos at firstbhph.com> wrote:
> > On Tuesday 04 January 2011 3:21:41 pm you 
wrote:
> >> On Tue, Jan 4, 2011 at 10:01 PM, Dimitri
> >> Yioulos
> >
> > <dyioulos at firstbhph.com> wrote:
> >>> Did I forget something in setting up
> >>> Anomoly Scoring Detection Mode, or
> >>> misconfigure something?
> >>
> >> Hi Dimitri,
> >>
> >> What do the logs say?
> >>
> >> --
> >> - Josh
> >
> > Josh,
> >
> > I'm not great at deciphering the log messages
> > that modsec generates.  I think I've captured
> > some relevant data, and put it here:
> >
> > http://pastebin.com/kCQ9i8p4
> >
> > Dimitri
> >
> > --
> > This message has been scanned for viruses and
> > dangerous content by MailScanner, and is
> > believed to be clean.
> >
> > _____________________________________________
> >__ Owasp-modsecurity-core-rule-set mailing
> > list
> > Owasp-modsecurity-core-rule-set at lists.owasp.o
> >rg
> > https://lists.owasp.org/mailman/listinfo/owas
> >p-modsecurity-core-rule-set



-- 
This message has been scanned for viruses and
dangerous content by MailScanner, and is
believed to be clean.


From tplatt at LCE.com  Tue Jan  4 16:27:34 2011
From: tplatt at LCE.com (Todd Platt)
Date: Tue, 4 Jan 2011 16:27:34 -0500
Subject: [Owasp-modsecurity-core-rule-set] SecRequestBodyLimit parameter
In-Reply-To: <201101041501.56766.dyioulos@firstbhph.com>
References: <201101041501.56766.dyioulos@firstbhph.com>
Message-ID: <0077FC548936B3418B2814159696352A0AB6DA43@lceex01.LCE.com>

All,

I have a question about setting the SecRequestBodyLimit parameter.
Currently, we have 2 web servers on different networks that has mod
security running.  One server has the SecRequestBodyLimit parameter set
in the mod_security.conf file and the other server has it defined in
modsecurity_crs_10_config.conf.  Does it matter which file defines the
SecRequestBodyLimit parameter?  Does either location make the load on
the servers less? What is the default value for this parameter if none
is specified? We are trying to get a control of the size of attachments
that are uploaded to our portal.

Thanks

Todd Platt
tplatt at lce.com


From dyioulos at firstbhph.com  Thu Jan  6 10:24:41 2011
From: dyioulos at firstbhph.com (Dimitri Yioulos)
Date: Thu, 6 Jan 2011 10:24:41 -0500
Subject: [Owasp-modsecurity-core-rule-set] Anomoly Scoring Detection
	Mode not working
In-Reply-To: <201101041622.21524.dyioulos@firstbhph.com>
References: <201101041501.56766.dyioulos@firstbhph.com>
	<09B610B0-BA5F-486C-B858-FA8B175CFBA6@trustwave.com>
	<201101041622.21524.dyioulos@firstbhph.com>
Message-ID: <201101061024.42998.dyioulos@firstbhph.com>

All,

Anything more on this?

Thanks.

Dimitri


On Tuesday 04 January 2011 4:22:20 pm Dimitri 
Yioulos wrote:
> The value in the 10 config file is the default:
>
> SecAction
> "phase:1,t:none,nolog,pass,setvar:tx.inbound_an
>omaly_score_level=5" SecAction
> "phase:1,t:none,nolog,pass,setvar:tx.outbound_a
>nomaly_score_level=4"
>
> Dimitri
>
>
> On Tuesday 04 January 2011 4:03:31 pm Ryan
> Barnett
>
> wrote:
> > The alerts say that there was a user-agent
> > string match (mozilla 4.0( ) with the comment
> > spam rules.  This match raised the
> > tx.inbound_anomaly_score to 3. What do you
> > have this value set to in the 10 config file?
> >  By default the blocking level is 5.
> >
> > --
> > Ryan Barnett
> >
> > On Jan 4, 2011, at 3:46 PM, Dimitri Yioulos
>
> <dyioulos at firstbhph.com> wrote:
> > > On Tuesday 04 January 2011 3:21:41 pm you
>
> wrote:
> > >> On Tue, Jan 4, 2011 at 10:01 PM, Dimitri
> > >> Yioulos
> > >
> > > <dyioulos at firstbhph.com> wrote:
> > >>> Did I forget something in setting up
> > >>> Anomoly Scoring Detection Mode, or
> > >>> misconfigure something?
> > >>
> > >> Hi Dimitri,
> > >>
> > >> What do the logs say?
> > >>
> > >> --
> > >> - Josh
> > >
> > > Josh,
> > >
> > > I'm not great at deciphering the log
> > > messages that modsec generates.  I think
> > > I've captured some relevant data, and put
> > > it here:
> > >
> > > http://pastebin.com/kCQ9i8p4
> > >
> > > Dimitri
> > >
> > > --
> > > This message has been scanned for viruses
> > > and dangerous content by MailScanner, and
> > > is believed to be clean.
> > >
> > > ___________________________________________
> > >__ __ Owasp-modsecurity-core-rule-set
> > > mailing list
> > > Owasp-modsecurity-core-rule-set at lists.owasp
> > >.o rg
> > > https://lists.owasp.org/mailman/listinfo/ow
> > >as p-modsecurity-core-rule-set



-- 
This message has been scanned for viruses and
dangerous content by MailScanner, and is
believed to be clean.


From RBarnett at trustwave.com  Thu Jan  6 16:15:50 2011
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Thu, 6 Jan 2011 15:15:50 -0600
Subject: [Owasp-modsecurity-core-rule-set] Anomoly Scoring Detection
 Mode not working
In-Reply-To: <201101061024.42998.dyioulos@firstbhph.com>
Message-ID: <C94B99D9.171AD%rbarnett@trustwave.com>

Ok, I think I found Dimitri's issue.  I am sending this out the list so
others are aware.

Dimitri sent me an audit log file and it showed that is using ModSecurity
v2.5.9.  The macro expansions used in the 49 inbound blocking file use
features of ModSecurity v2.5.12 and greater.  This is listed in the
modsecurity_crs_10_config.conf.example file -


#
# -=[ Anomaly Scoring Threshold Levels ]=-
#
# These variables are used in macro expansion in the 49 inbound blocking
and 59
# outbound blocking files.
#
# **MUST HAVE** ModSecurity v2.5.12 or higher to use macro expansion in
numeric
# operators.  If you have an earlier version, edit the 49/59 files
directly to
# set the appropriate anomaly score levels.
#
# You should set the score to the proper threshold you would prefer. If
set to "5"
# it will work similarly to previous Mod CRS rules and will create an
event in the error_log
# file if there are any rules that match.  If you would like to lessen the
number of events
# generated in the error_log file, you should increase the anomaly score
threshold to
# something like "20".  This would only generate an event in the error_log
file if
# there are multiple lower severity rule matches or if any 1 higher
severity item matches.
#
SecAction 
"phase:1,t:none,nolog,pass,setvar:tx.inbound_anomaly_score_level=5"
SecAction 
"phase:1,t:none,nolog,pass,setvar:tx.outbound_anomaly_score_level=4"



This means that for Dimitri's install, the following part of the chained
rule in the modsecurity_crs_49_inbound_blocking.conf file is not doing
macro expansion to properly evaluate the tx.inbound_anomaly_score_level
against the @ge operator -

SecRule TX:ANOMALY_SCORE "@ge %{tx.inbound_anomaly_score_level}"


So, Dimitri - you have two options:

1) Upgrade ModSecurity to the latest version (recommended), or
2) As the comments say above, if you can't upgrade, you need to edit the
49 file and change the rule so that it doesn't use macro expansion -

SecRule TX:ANOMALY_SCORE "@ge 5"

Hope this helps,
Ryan


On 1/6/11 10:24 AM, "Dimitri Yioulos" <dyioulos at firstbhph.com> wrote:

>All,
>
>Anything more on this?
>
>Thanks.
>
>Dimitri
>
>
>On Tuesday 04 January 2011 4:22:20 pm Dimitri
>Yioulos wrote:
>> The value in the 10 config file is the default:
>>
>> SecAction
>> "phase:1,t:none,nolog,pass,setvar:tx.inbound_an
>>omaly_score_level=5" SecAction
>> "phase:1,t:none,nolog,pass,setvar:tx.outbound_a
>>nomaly_score_level=4"
>>
>> Dimitri
>>
>>
>> On Tuesday 04 January 2011 4:03:31 pm Ryan
>> Barnett
>>
>> wrote:
>> > The alerts say that there was a user-agent
>> > string match (mozilla 4.0( ) with the comment
>> > spam rules.  This match raised the
>> > tx.inbound_anomaly_score to 3. What do you
>> > have this value set to in the 10 config file?
>> >  By default the blocking level is 5.
>> >
>> > --
>> > Ryan Barnett
>> >
>> > On Jan 4, 2011, at 3:46 PM, Dimitri Yioulos
>>
>> <dyioulos at firstbhph.com> wrote:
>> > > On Tuesday 04 January 2011 3:21:41 pm you
>>
>> wrote:
>> > >> On Tue, Jan 4, 2011 at 10:01 PM, Dimitri
>> > >> Yioulos
>> > >
>> > > <dyioulos at firstbhph.com> wrote:
>> > >>> Did I forget something in setting up
>> > >>> Anomoly Scoring Detection Mode, or
>> > >>> misconfigure something?
>> > >>
>> > >> Hi Dimitri,
>> > >>
>> > >> What do the logs say?
>> > >>
>> > >> --
>> > >> - Josh
>> > >
>> > > Josh,
>> > >
>> > > I'm not great at deciphering the log
>> > > messages that modsec generates.  I think
>> > > I've captured some relevant data, and put
>> > > it here:
>> > >
>> > > http://pastebin.com/kCQ9i8p4
>> > >
>> > > Dimitri
>> > >
>> > > --
>> > > This message has been scanned for viruses
>> > > and dangerous content by MailScanner, and
>> > > is believed to be clean.
>> > >
>> > > ___________________________________________
>> > >__ __ Owasp-modsecurity-core-rule-set
>> > > mailing list
>> > > Owasp-modsecurity-core-rule-set at lists.owasp
>> > >.o rg
>> > > https://lists.owasp.org/mailman/listinfo/ow
>> > >as p-modsecurity-core-rule-set
>
>
>
>-- 
>This message has been scanned for viruses and
>dangerous content by MailScanner, and is
>believed to be clean.
>
>_______________________________________________
>Owasp-modsecurity-core-rule-set mailing list
>Owasp-modsecurity-core-rule-set at lists.owasp.org
>https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>



From dyioulos at firstbhph.com  Thu Jan  6 17:21:16 2011
From: dyioulos at firstbhph.com (Dimitri Yioulos)
Date: Thu, 6 Jan 2011 17:21:16 -0500
Subject: [Owasp-modsecurity-core-rule-set] Anomoly Scoring Detection
	Mode not working
In-Reply-To: <C94B99D9.171AD%rbarnett@trustwave.com>
References: <C94B99D9.171AD%rbarnett@trustwave.com>
Message-ID: <201101061721.17243.dyioulos@firstbhph.com>

Ah, so I still can't read :-) .  Ryan, so sorry 
for any unnecessary grief.

The only reason I haven't upgraded to a later 
version of modsecurity is that I run into lua 
problems on my  CentOS 4.8-based Web server if I 
do (lua-5.0.2 is the last RPM-based version that 
I can use the doesn't break stuff and, iirc, 
ModSecurity v2.5.12 and greater needs lua-5.1x).

That said, I edited 
modsecurity_crs_49_inbound_blocking.conf, as per 
Ryan's instructions, and we're all good.

If I might I one more question, having edited the 
file, what is the effect of not doing macro 
expansion?  How much does it "weaken" the rule?

My sincere thanks, once again, for your help Ryan.

Dimitri


On Thursday 06 January 2011 4:15:50 pm Ryan 
Barnett wrote:
> Ok, I think I found Dimitri's issue.  I am
> sending this out the list so others are aware.
>
> Dimitri sent me an audit log file and it showed
> that is using ModSecurity v2.5.9.  The macro
> expansions used in the 49 inbound blocking file
> use features of ModSecurity v2.5.12 and
> greater.  This is listed in the
> modsecurity_crs_10_config.conf.example file -
>
>
> #
> # -=[ Anomaly Scoring Threshold Levels ]=-
> #
> # These variables are used in macro expansion
> in the 49 inbound blocking and 59
> # outbound blocking files.
> #
> # **MUST HAVE** ModSecurity v2.5.12 or higher
> to use macro expansion in numeric
> # operators.  If you have an earlier version,
> edit the 49/59 files directly to
> # set the appropriate anomaly score levels.
> #
> # You should set the score to the proper
> threshold you would prefer. If set to "5"
> # it will work similarly to previous Mod CRS
> rules and will create an event in the error_log
> # file if there are any rules that match.  If
> you would like to lessen the number of events
> # generated in the error_log file, you should
> increase the anomaly score threshold to
> # something like "20".  This would only
> generate an event in the error_log file if
> # there are multiple lower severity rule
> matches or if any 1 higher severity item
> matches.
> #
> SecAction
> "phase:1,t:none,nolog,pass,setvar:tx.inbound_an
>omaly_score_level=5" SecAction
> "phase:1,t:none,nolog,pass,setvar:tx.outbound_a
>nomaly_score_level=4"
>
>
>
> This means that for Dimitri's install, the
> following part of the chained rule in the
> modsecurity_crs_49_inbound_blocking.conf file
> is not doing macro expansion to properly
> evaluate the tx.inbound_anomaly_score_level
> against the @ge operator -
>
> SecRule TX:ANOMALY_SCORE "@ge
> %{tx.inbound_anomaly_score_level}"
>
>
> So, Dimitri - you have two options:
>
> 1) Upgrade ModSecurity to the latest version
> (recommended), or 2) As the comments say above,
> if you can't upgrade, you need to edit the 49
> file and change the rule so that it doesn't use
> macro expansion -
>
> SecRule TX:ANOMALY_SCORE "@ge 5"
>
> Hope this helps,
> Ryan
>
> On 1/6/11 10:24 AM, "Dimitri Yioulos" 
<dyioulos at firstbhph.com> wrote:
> >All,
> >
> >Anything more on this?
> >
> >Thanks.
> >
> >Dimitri
> >
> >
> >On Tuesday 04 January 2011 4:22:20 pm Dimitri
> >
> >Yioulos wrote:
> >> The value in the 10 config file is the
> >> default:
> >>
> >> SecAction
> >> "phase:1,t:none,nolog,pass,setvar:tx.inbound
> >>_an omaly_score_level=5" SecAction
> >> "phase:1,t:none,nolog,pass,setvar:tx.outboun
> >>d_a nomaly_score_level=4"
> >>
> >> Dimitri
> >>
> >>
> >> On Tuesday 04 January 2011 4:03:31 pm Ryan
> >> Barnett
> >>
> >> wrote:
> >> > The alerts say that there was a user-agent
> >> > string match (mozilla 4.0( ) with the
> >> > comment spam rules.  This match raised the
> >> > tx.inbound_anomaly_score to 3. What do you
> >> > have this value set to in the 10 config
> >> > file? By default the blocking level is 5.
> >> >
> >> > --
> >> > Ryan Barnett
> >> >
> >> > On Jan 4, 2011, at 3:46 PM, Dimitri
> >> > Yioulos
> >>
> >> <dyioulos at firstbhph.com> wrote:
> >> > > On Tuesday 04 January 2011 3:21:41 pm
> >> > > you
> >>
> >> wrote:
> >> > >> On Tue, Jan 4, 2011 at 10:01 PM,
> >> > >> Dimitri Yioulos
> >> > >
> >> > > <dyioulos at firstbhph.com> wrote:
> >> > >>> Did I forget something in setting up
> >> > >>> Anomoly Scoring Detection Mode, or
> >> > >>> misconfigure something?
> >> > >>
> >> > >> Hi Dimitri,
> >> > >>
> >> > >> What do the logs say?
> >> > >>
> >> > >> --
> >> > >> - Josh
> >> > >
> >> > > Josh,
> >> > >
> >> > > I'm not great at deciphering the log
> >> > > messages that modsec generates.  I think
> >> > > I've captured some relevant data, and
> >> > > put it here:
> >> > >
> >> > > http://pastebin.com/kCQ9i8p4
> >> > >
> >> > > Dimitri
> >> > >
> >> > > --
> >> > > This message has been scanned for
> >> > > viruses and dangerous content by
> >> > > MailScanner, and is believed to be
> >> > > clean.
> >> > >
> >> > > ________________________________________
> >> > >___ __ __ Owasp-modsecurity-core-rule-set
> >> > > mailing list
> >> > > Owasp-modsecurity-core-rule-set at lists.ow
> >> > >asp .o rg
> >> > > https://lists.owasp.org/mailman/listinfo
> >> > >/ow as p-modsecurity-core-rule-set
> >
> >--
> >This message has been scanned for viruses and
> >dangerous content by MailScanner, and is
> >believed to be clean.
> >
> >______________________________________________
> >_ Owasp-modsecurity-core-rule-set mailing list
> > Owasp-modsecurity-core-rule-set at lists.owasp.o
> >rg
> > https://lists.owasp.org/mailman/listinfo/owas
> >p-modsecurity-core-rule-set



-- 
This message has been scanned for viruses and
dangerous content by MailScanner, and is
believed to be clean.


From superpizza at bigfoot.com  Wed Jan 12 05:42:17 2011
From: superpizza at bigfoot.com (Superpizza)
Date: Wed, 12 Jan 2011 11:42:17 +0100
Subject: [Owasp-modsecurity-core-rule-set] Brute force against single client
Message-ID: <AANLkTin-4LHYE0pUvgAV0T0EaG2W+MtOijY_vhWsMoAj@mail.gmail.com>

Hi everyone.
I was wondering about setting up a brute force protection against a single
client (browser).
It happens I manage a busy site, and a I've got a bunch of customers
coming to me through large proxies.
This means I can't simply ban an IP
(as dictated by current brute force rule in 2.1.1),
 but I'd like to stop a single client
(likely a script mimicking a real browser).

I thought about setting up a global collection
 populated by hashing a cookie (different value for each customer).
Something like:

SecRule REQUEST_COOKIES_NAMES:JSESSIONID "^(.*)$"
"phase:1,t:none,pass,nolog,t:sha1,t:hexEncode,setvar: `
tx.cookie_hash=%{matched_var}"

SecAction
"phase:1,t:none,pass,nolog,initcol:global=global,initcol: \
ip=%{tx.cookie_hash}"

I could then try to modify the rules present in
modsecurity_crs_11_brute_force.conf to evaluate that variable.
Any suggestion?

Regards, Luca

From chris at jwall.org  Wed Jan 12 07:09:05 2011
From: chris at jwall.org (Christian Bockermann)
Date: Wed, 12 Jan 2011 13:09:05 +0100
Subject: [Owasp-modsecurity-core-rule-set] Brute force against single
	client
In-Reply-To: <AANLkTin-4LHYE0pUvgAV0T0EaG2W+MtOijY_vhWsMoAj@mail.gmail.com>
References: <AANLkTin-4LHYE0pUvgAV0T0EaG2W+MtOijY_vhWsMoAj@mail.gmail.com>
Message-ID: <2DFA61DA-1133-4FD3-A90D-4C29A9D95F08@jwall.org>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Hi Luca,

I've done some previous stuff on request-limitting a client, eg by IP adress.
The same concept can be modified to use an arbitrary client identifier, e.g.
by its session id.

You may want to have a look at 

	https://secure.jwall.org/blog/2009/07/19/1248004300834.html

Recently I had a conversation about this issue with another guy on the list.
Based on that I started implementing a test-suite to evaluate a rule-set for
this case.
If you're interested in trying that out, then drop me a line.

Best regards,
     Chris


Am 12.01.2011 um 11:42 schrieb Superpizza:

> Hi everyone.
> I was wondering about setting up a brute force protection against a single
> client (browser).
> It happens I manage a busy site, and a I've got a bunch of customers
> coming to me through large proxies.
> This means I can't simply ban an IP
> (as dictated by current brute force rule in 2.1.1),
> but I'd like to stop a single client
> (likely a script mimicking a real browser).
> 
> I thought about setting up a global collection
> populated by hashing a cookie (different value for each customer).
> Something like:
> 
> SecRule REQUEST_COOKIES_NAMES:JSESSIONID "^(.*)$"
> "phase:1,t:none,pass,nolog,t:sha1,t:hexEncode,setvar: `
> tx.cookie_hash=%{matched_var}"
> 
> SecAction
> "phase:1,t:none,pass,nolog,initcol:global=global,initcol: \
> ip=%{tx.cookie_hash}"
> 
> I could then try to modify the rules present in
> modsecurity_crs_11_brute_force.conf to evaluate that variable.
> Any suggestion?
> 
> Regards, Luca
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.8 (Darwin)

iD8DBQFNLZnhpc5/RcXDlTwRAj+qAJ4qQXcIvQamR18iZDWNSM0H2wYenQCcCMJU
yMt9tKaIzNdpKaaF17djIBA=
=wlDi
-----END PGP SIGNATURE-----

From rcbarnett at gmail.com  Wed Jan 12 09:11:19 2011
From: rcbarnett at gmail.com (Ryan Barnett)
Date: Wed, 12 Jan 2011 09:11:19 -0500
Subject: [Owasp-modsecurity-core-rule-set] Brute force against single
 client
In-Reply-To: <AANLkTin-4LHYE0pUvgAV0T0EaG2W+MtOijY_vhWsMoAj@mail.gmail.com>
Message-ID: <C9531CA4.17541%rcbarnett@gmail.com>

On 1/12/11 5:42 AM, "Superpizza" <superpizza at bigfoot.com> wrote:

>Hi everyone.
>I was wondering about setting up a brute force protection against a single
>client (browser).
>It happens I manage a busy site, and a I've got a bunch of customers
>coming to me through large proxies.
>This means I can't simply ban an IP
>(as dictated by current brute force rule in 2.1.1),

Are you referring to the experimental Brute Force Detection rules -
http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/exper
imental_rules/modsecurity_crs_11_brute_force.conf

If so, keep in mind that the IP collection it is using is taken from the
modsecurity_crs_10_config.conf file and the key we use is a combination of
the IP address and a hash of the User-Agent value -

#
# -=[ Global and IP Collections ]=-
#
# Create both Global and IP collections for rules to use
# There are some CRS rules that assume that these two collections
# have already been initiated.
#
SecRule REQUEST_HEADERS:User-Agent "^(.*)$"
"phase:1,t:none,pass,nolog,t:sha1,t:hexEncode,setvar:tx.ua_hash=%{matched_v
ar}"
SecAction 
"phase:1,t:none,pass,nolog,initcol:global=global,initcol:ip=%{remote_addr}_
%{tx.ua_hash}"


This should help to make the collections a bit more unique even if users
are sharing open proxies.


> but I'd like to stop a single client
>(likely a script mimicking a real browser).
>
>I thought about setting up a global collection
> populated by hashing a cookie (different value for each customer).
>Something like:
>
>SecRule REQUEST_COOKIES_NAMES:JSESSIONID "^(.*)$"

If you want to capture the "value* of the JSESSIONID, you should use -
REQUEST_COOKIES:JSESSIONID as the variable.

-Ryan

>"phase:1,t:none,pass,nolog,t:sha1,t:hexEncode,setvar: `
>tx.cookie_hash=%{matched_var}"
>
>SecAction
>"phase:1,t:none,pass,nolog,initcol:global=global,initcol: \
>ip=%{tx.cookie_hash}"
>
>I could then try to modify the rules present in
>modsecurity_crs_11_brute_force.conf to evaluate that variable.
>Any suggestion?
>
>Regards, Luca
>_______________________________________________
>Owasp-modsecurity-core-rule-set mailing list
>Owasp-modsecurity-core-rule-set at lists.owasp.org
>https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set



From tplatt at LCE.com  Wed Jan 12 09:33:47 2011
From: tplatt at LCE.com (Todd Platt)
Date: Wed, 12 Jan 2011 09:33:47 -0500
Subject: [Owasp-modsecurity-core-rule-set] SecRequestBodyLimit parameter
In-Reply-To: <C9531CA4.17541%rcbarnett@gmail.com>
References: <AANLkTin-4LHYE0pUvgAV0T0EaG2W+MtOijY_vhWsMoAj@mail.gmail.com>
	<C9531CA4.17541%rcbarnett@gmail.com>
Message-ID: <0077FC548936B3418B2814159696352A0AC69947@lceex01.LCE.com>

All,

I have a question about setting the SecRequestBodyLimit parameter.
Currently, we have 2 web servers on different networks that has mod
security running.  One server has the SecRequestBodyLimit parameter set
in the mod_security.conf file and the other server has it defined in
modsecurity_crs_10_config.conf.  Does it matter which file defines the
SecRequestBodyLimit parameter?  Does either location make the load on
the servers less? What is the default value for this parameter if none
is specified? We are trying to get a control of the size of attachments
that are uploaded to our portal.

Thanks

Todd Platt
Cell: 843.513.2413
SPAWAR: 843.218.3720
tplatt at lce.com
todd.platt at us.army.mil
todd.platt at us.army.smil.mil

From yersinia.spiros at gmail.com  Wed Jan 12 12:29:09 2011
From: yersinia.spiros at gmail.com (yersinia)
Date: Wed, 12 Jan 2011 18:29:09 +0100
Subject: [Owasp-modsecurity-core-rule-set] SecRequestBodyLimit parameter
In-Reply-To: <0077FC548936B3418B2814159696352A0AC69947@lceex01.LCE.com>
References: <AANLkTin-4LHYE0pUvgAV0T0EaG2W+MtOijY_vhWsMoAj@mail.gmail.com>
	<C9531CA4.17541%rcbarnett@gmail.com>
	<0077FC548936B3418B2814159696352A0AC69947@lceex01.LCE.com>
Message-ID: <AANLkTikCVw5QZEuVKma9Ciyt=VA0hJnMnNwJx=Cm34F2@mail.gmail.com>

On Wed, Jan 12, 2011 at 3:33 PM, Todd Platt <tplatt at lce.com> wrote:

> All,
>
> I have a question about setting the SecRequestBodyLimit parameter.
> Currently, we have 2 web servers on different networks that has mod
> security running.  One server has the SecRequestBodyLimit parameter set
> in the mod_security.conf file and the other server has it defined in
> modsecurity_crs_10_config.conf.  Does it matter which file defines the
> SecRequestBodyLimit parameter?  Does either location make the load on
> the servers less?


No difference for the load. I prefer to put such definition in
modsecurity_localrules.conf.
This because if you install mod_security with the package manager of your
distro if is possible
that an update overwrite the mod_security.conf, for example.




> What is the default value for this parameter if none
> is specified? We are trying to get a control of the size of attachments
> that are uploaded to our portal.
>
> The default of SecRequestBodyLimit is 131072KB: There is an hard limit of
1GB.

hth
-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20110112/84486ce5/attachment.html 

From RBarnett at trustwave.com  Tue Jan 18 11:37:12 2011
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Tue, 18 Jan 2011 10:37:12 -0600
Subject: [Owasp-modsecurity-core-rule-set] [mod-security-users] The
	application is not available??
In-Reply-To: <OF8C5A0848.F27579E4-ON4825781C.00535835-4825781C.005477D1@jetco.com.hk>
References: <OF8C5A0848.F27579E4-ON4825781C.00535835-4825781C.005477D1@jetco.com.hk>
Message-ID: <8A5DEBAF-10FC-466E-A37D-CE9064BAF17E@trustwave.com>

That alert message means that the application generated a 500 level response code status. ModSecurity identified the status code and triggered a 403 code instead. The rationale for this is to hide errors from clients. 

By the way, I suggest that you upgrade both ModSecurity (v2.5.13) and the CRS (v2.1.1). 

--
Ryan Barnett


On Jan 18, 2011, at 10:48 AM, "jaylam at jetco.com.hk" <jaylam at jetco.com.hk> wrote:

> 
> Hi all,
> 
> I am using ModSecurity 2.5.12 and rule set 2.0.5.
> 
> I always got an Access denied by "The application is not available" which
> is a rule in modsecurity_crs_50_outbound.conf.
> But i have no idea what is the root cause.
> I wonder what does "The application is not available" mean?
> 
> Here is my audit log:
> 
> --0d946668-A--
> [14/Jan/2011:17:25:34 +0800] TTAWjX8AAAEAABnc54IAAAAa 202.74.105.113 57023
> 192.168.200.208 7900
> --0d946668-B--
> POST /abc/login HTTP/1.1
> Host: www.abc.com:7900
> User-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-GB; rv:1.9.2.13)
> Gecko/20101203 Firefox/3.6.13
> Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
> Accept-Language: en-gb,en;q=0.5
> Accept-Encoding: gzip,deflate
> Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7
> Keep-Alive: 115
> Connection: keep-alive
> Referer: https://www.abc.com:7900/abc/abc.jsp?from=index.html
> Cookie: JSESSIONID=0s000egfiufJPdDWiKYvMc_pfuVvs5cp3eprm
> Content-Type: application/x-www-form-urlencoded
> Content-Length: 16
> 
> --0d946668-C--
> javaversion=1.6.0
> --0d946668-F--
> HTTP/1.1 403 Forbidden
> $WSEP:
> Content-Length: 592
> Connection: close
> Content-Type: text/html; charset=ISO-8859-1
> Content-Language: en-US
> 
> --0d946668-E--
> 
> --0d946668-H--
> Message: Access denied with code 403 (phase 4). Operator GE matched 30 at
> TX:outbound_anomaly_score. [file
> "/usr/local/apache/conf/modsecurity/base_rules/modsecurity_crs_59_outbound_blocking.conf"]
> [line "23"] [msg "Outbound Anomaly Score Exceeded (score 30):
> The application is not available"]
> Action: Intercepted (phase 4)
> Stopwatch: 12949971335994583 105228 (489* 3294 -)
> Response-Body-Transformed: Dechunked
> Producer: ModSecurity for Apache/2.5.12 (http://www.modsecurity.org/); core
> ruleset/2.0.5.
> Server: Apache/2.2.16 (Unix) mod_ssl/2.2.16 OpenSSL/1.0.0a
> 
> --0d946668-Z--
> 
> 
> Many Thanks!!
> Jay
> This e-mail is intended solely for the addressee.  If you have received
> this e-mail in error, please notify the sender by reply e-mail and
> immediately delete it from your system.
> 
> 
> ------------------------------------------------------------------------------
> Protect Your Site and Customers from Malware Attacks
> Learn about various malware tactics and how to avoid them. Understand 
> malware threats, the impact they can have on your business, and how you 
> can protect your company and customers by using code signing.
> http://p.sf.net/sfu/oracle-sfdevnl
> _______________________________________________
> mod-security-users mailing list
> mod-security-users at lists.sourceforge.net
> https://lists.sourceforge.net/lists/listinfo/mod-security-users
> Commercial ModSecurity Appliances, Rule Sets and Support:
> http://www.modsecurity.org/breach/index.html
> 


From dreamice.jiang at gmail.com  Wed Jan 19 09:17:43 2011
From: dreamice.jiang at gmail.com (dreamice)
Date: Wed, 19 Jan 2011 22:17:43 +0800
Subject: [Owasp-modsecurity-core-rule-set] Can set each single virtual host
	with a rule set?
Message-ID: <AANLkTimXqO+HvygtSvWc+bC6-+YpNf748u3LD-nBuspW@mail.gmail.com>

Dear all,

I have the requirements as follows:
The Web Server has a single IP address, but have a lot of virtual hosts. For
example, the Web Server IP address is 192.168.1.100, and the virtual hosts
are:www.a.com, www.b.com and www.c.com.

I want to set up a proxy apache server to protect the  "Web Server", and
each virtual host should set up a single modsecurity rule set.

How can I configure my apache proxy server to proxy for the virtual hosts
with a single rule set for each other?
www.a.com --- rule set a
www.b.com --- rule set b
www.c.com --- rule set c

Thanks in advance!

Best wishes!
-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20110119/54d76687/attachment.html 

From jamuse at gmail.com  Wed Jan 19 09:26:17 2011
From: jamuse at gmail.com (Jamuse)
Date: Wed, 19 Jan 2011 16:26:17 +0200
Subject: [Owasp-modsecurity-core-rule-set] Can set each single virtual
 host with a rule set?
In-Reply-To: <AANLkTimXqO+HvygtSvWc+bC6-+YpNf748u3LD-nBuspW@mail.gmail.com>
References: <AANLkTimXqO+HvygtSvWc+bC6-+YpNf748u3LD-nBuspW@mail.gmail.com>
Message-ID: <AANLkTik6o7XXDssSx3ZRzpn7s9W6__VbFrQQWwW6Jheg@mail.gmail.com>

On Wed, Jan 19, 2011 at 4:17 PM, dreamice <dreamice.jiang at gmail.com> wrote:
> Dear all,
>
> I have the requirements as follows:
> The Web Server has a single IP address, but have a lot of virtual hosts. For
> example, the Web Server IP address is 192.168.1.100, and the virtual hosts
> are:www.a.com, www.b.com and www.c.com.
>
> I want to set up a proxy apache server to protect the ?"Web Server", and
> each virtual host should set up a single modsecurity rule set.
>
> How can I configure my apache proxy server to proxy for the virtual hosts
> with a single rule set for each other?

Hi,

You can simply use an Include statement within the virtual host
configuration that points to the ruleset to want to apply for each
domain. For example:

<VirtualHost *:80>
  ServerName www.a.com
  ...
  Include /opt/modsecurity/etc/www.a.com/RuleSetA.conf
  ...
</VirtualHost>

--
 - Josh

From RBarnett at trustwave.com  Sat Jan 22 00:14:17 2011
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Fri, 21 Jan 2011 23:14:17 -0600
Subject: [Owasp-modsecurity-core-rule-set] Jira Outage
Message-ID: <5213282C-2257-4A66-997A-B3120DB3E6D9@trustwave.com>

We are in the process of migrating our ModSecurity servers to a new location. During this time, the Jira app maybe down. 

I will send a note when it is back online. 

--
Ryan Barnett



From RBarnett at trustwave.com  Mon Jan 24 08:42:50 2011
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Mon, 24 Jan 2011 07:42:50 -0600
Subject: [Owasp-modsecurity-core-rule-set] Jira Outage
In-Reply-To: <5213282C-2257-4A66-997A-B3120DB3E6D9@trustwave.com>
Message-ID: <C962EBCE.17DFB%rbarnett@trustwave.com>

We have migrated over all of our servers to their new location and
everything should now be operational.  If you run into any issues please
let me know.


-Ryan


On 1/22/11 12:14 AM, "Ryan Barnett" <RBarnett at trustwave.com> wrote:

>We are in the process of migrating our ModSecurity servers to a new
>location. During this time, the Jira app maybe down.
>
>I will send a note when it is back online.
>
>--
>Ryan Barnett
>



From klaubert at gmail.com  Mon Jan 24 08:48:58 2011
From: klaubert at gmail.com (Klaubert Herr da Silveira)
Date: Mon, 24 Jan 2011 11:48:58 -0200
Subject: [Owasp-modsecurity-core-rule-set] 960032 vs. 960010
Message-ID: <AANLkTik5aHc2ApzwetODfy9D6kCLrG2vuoMqc5MpzVg6@mail.gmail.com>

Hi,

Just for my clarification, on "core ruleset/2.1.1", I saw that 960032 are
using "tx.allowed_methods", configured from modsecurity_crs_10_config.conf.

REQUEST_METHOD "!@within %{tx.allowed_methods}" ...

But 960010 are not:
REQUEST_METHOD REQUEST_METHOD "!^(?:GET|HEAD|PROPFIND|OPTIONS)$"

Don't should 960010 use "tx.allowed_methods" too?

Best regards,

Klaubert
-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20110124/424e23b4/attachment.html 

From RBarnett at trustwave.com  Mon Jan 24 09:16:01 2011
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Mon, 24 Jan 2011 08:16:01 -0600
Subject: [Owasp-modsecurity-core-rule-set] 960032 vs. 960010
In-Reply-To: <AANLkTik5aHc2ApzwetODfy9D6kCLrG2vuoMqc5MpzVg6@mail.gmail.com>
Message-ID: <C962F31A.17E04%rbarnett@trustwave.com>



From:  Klaubert Herr da Silveira <klaubert at gmail.com>
Date:  Mon, 24 Jan 2011 07:48:58 -0600
To:  "owasp-modsecurity-core-rule-set at lists.owasp.org"
<owasp-modsecurity-core-rule-set at lists.owasp.org>
Subject:  [Owasp-modsecurity-core-rule-set] 960032 vs. 960010


>Hi, 
>
>Just for my clarification, on "core ruleset/2.1.1", I saw that 960032 are
>using "tx.allowed_methods", configured from
>modsecurity_crs_10_config.conf.
>
>REQUEST_METHOD "!@within %{tx.allowed_methods}" ...
>
>But 960010 are not:
>REQUEST_METHOD REQUEST_METHOD "!^(?:GET|HEAD|PROPFIND|OPTIONS)$"
>
>Don't should 960010 use "tx.allowed_methods" too?


It probably could however these two rules are looking for different issues.

- 960032 is looking only at the allowed Request Methods as defined by the
Admin
- 960010 is looking, instead, at the allowed Content-Types.  The reason
that the Request Method check is there is to weed out false positives as
we don't even want to look at the Content-Type header if the request is
using one of these Request Methods.  This check was added due to strange
mobile device requests.

-Ryan



From securityadmin at hcjb.org  Tue Jan 25 10:57:23 2011
From: securityadmin at hcjb.org (Josh Gee)
Date: Tue, 25 Jan 2011 15:57:23 +0000
Subject: [Owasp-modsecurity-core-rule-set] Trouble with 950901
Message-ID: <4D3EF2E3.6080003@hcjb.org>

This SQL Injection rule is causing me serious headaches.  It has a lot
of false positives, and it always matches twice, once with the case it
finds, and once after it lower-cases the values.  This makes it very
hard to write an exception for.

It seems to be so crude as to match the word "and" in just about any
context that includes white space.  It matches in filenames (which is
not too bad), URLs, and even standard HTML form values.

For now I've commented it out completely because in Anomaly Scoring mode
I couldn't manage to write an exception that would turn it off.

Any ideas for a better solution?

Josh


From RBarnett at trustwave.com  Tue Jan 25 11:02:53 2011
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Tue, 25 Jan 2011 10:02:53 -0600
Subject: [Owasp-modsecurity-core-rule-set] Trouble with 950901
In-Reply-To: <4D3EF2E3.6080003@hcjb.org>
Message-ID: <C9645E1F.17F19%rbarnett@trustwave.com>


On 1/25/11 10:57 AM, "Josh Gee" <securityadmin at hcjb.org> wrote:

>This SQL Injection rule is causing me serious headaches.  It has a lot
>of false positives, and it always matches twice, once with the case it
>finds, and once after it lower-cases the values.  This makes it very
>hard to write an exception for.
>
>It seems to be so crude as to match the word "and" in just about any
>context that includes white space.  It matches in filenames (which is
>not too bad), URLs, and even standard HTML form values.
>
>For now I've commented it out completely because in Anomaly Scoring mode
>I couldn't manage to write an exception that would turn it off.
>
>Any ideas for a better solution?

Josh,
Could you send an audit log entry of a false positive match?  It would
help with an exception.

-Ryan



From apache-lists at riggs.me  Tue Jan 25 12:04:53 2011
From: apache-lists at riggs.me (Jim Riggs)
Date: Tue, 25 Jan 2011 11:04:53 -0600
Subject: [Owasp-modsecurity-core-rule-set] Trouble with 950901
In-Reply-To: <4D3EF2E3.6080003@hcjb.org>
References: <4D3EF2E3.6080003@hcjb.org>
Message-ID: <638B65B0-4B6A-483C-A733-63B64612F998@riggs.me>

On Jan 25, 2011, at 9:57 AM, Josh Gee wrote:

> This SQL Injection rule is causing me serious headaches.  It has a lot
> of false positives, and it always matches twice, once with the case it
> finds, and once after it lower-cases the values.  This makes it very
> hard to write an exception for.
> 
> It seems to be so crude as to match the word "and" in just about any
> context that includes white space.  It matches in filenames (which is
> not too bad), URLs, and even standard HTML form values.
> 
> For now I've commented it out completely because in Anomaly Scoring mode
> I couldn't manage to write an exception that would turn it off.
> 
> Any ideas for a better solution?

We have had some major issues with this one too and had to disable it.  Can you not just do a `SecRuleRemoveById 950901' in your 48 local exceptions file?  That's what I did, and I believe it to be working.


From mlavi at sgi.com  Tue Jan 25 16:51:34 2011
From: mlavi at sgi.com (Mark Lavi)
Date: Tue, 25 Jan 2011 15:51:34 -0600
Subject: [Owasp-modsecurity-core-rule-set] [mod-security-users]
	mod_security - how to use for master thesis?
In-Reply-To: <AANLkTikJE0NFsiChk7bBrMm-UiF4NB81RAvfbvoi=vJp@mail.gmail.com>
References: <AANLkTikJE0NFsiChk7bBrMm-UiF4NB81RAvfbvoi=vJp@mail.gmail.com>
Message-ID: <074F0C4BE8F9FB4CB1410BF8D1E10B5401234514@CF--AMER002E--3.americas.sgi.com>

>I'd rather not focus on this particular tool, but create some system
that would secure for example some specific kinds of websites.
 
Agreed, you should be applying your thoughts to the arena of "web
application security," where mod_security is your method of
implementing/testing/analyzing your particular focus.
 
>Are there any tools that help organising, applying mod security rules?
Is it needed? What could make it more research-like? Any hints please?
 
The iterations of the CRS are a pain since they can change a bit with
each release, but that is the nature of their maturity. They are hard to
understand since they aren't documented in detail.
 
You know, the webgoat project (a kind of web app honey pot at
http://www.owasp.org/index.php/Category:OWASP_WebGoat_Project
<blocked::http://www.owasp.org/index.php/Category:OWASP_WebGoat_Project>
and I seem to recall another one used by Google) being protected by
mod_security would be an ideal way to document (and do unit testing on)
the CRS. I don't know if that is how the CRS is tested and benchmarked?
 
I would have to say that the LUA scripting engine would be also be an
ideal place to insert your value or hypothesis with or without using the
CRS since mod_security is an incredible auditing tool:
 
- test out new, hypothesized attacks and create an algorithmic or
heuristic response to log/drop the attacks in LUA/custom rules/etc.
- attach mod_security to a Bayesian filter
(http://en.wikipedia.org/wiki/Bayesian_filter) and apply email like
tactics to web traffic/attacks

Mark Lavi
Senior Web Producer

sgi

46600 Landing Parkway
Fremont, CA 94538
(510) 933-5234 direct
mlavi at sgi.com <blocked::mailto:mlavi at sgi.com>  
www.sgi.com <blocked::http://www.sgi.com/> 

 

________________________________

From: Pawel Duda [mailto:thekradox at gmail.com] 
Sent: Friday, January 21, 2011 12:46 PM
To: mod-security-users at lists.sourceforge.net
Subject: [mod-security-users] mod_security - how to use for master
thesis?


Hi, I've been playing with mod_security for some time and I'd like
somehow to use it in my master thesis. I don't know exactly how this
work could be more interesting than describing what mod_security does,
what kind of web attacks can be prevented using it, what are other
functions of it (like analysing if the requests are really HTTP,
analysing XML). I'd rather not focus on this particular tool, but create
some system that would secure for example some specific kinds of
websites. Are there any tools that help organising, applying mod
security rules? Is it needed? What could make it more reaserch-like? Any
hints please?

-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20110125/3e74178f/attachment.html 

From RBarnett at trustwave.com  Tue Jan 25 17:02:48 2011
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Tue, 25 Jan 2011 16:02:48 -0600
Subject: [Owasp-modsecurity-core-rule-set] [mod-security-users]
 mod_security - how to use for master thesis?
In-Reply-To: <074F0C4BE8F9FB4CB1410BF8D1E10B5401234514@CF--AMER002E--3.americas.sgi.com>
References: <AANLkTikJE0NFsiChk7bBrMm-UiF4NB81RAvfbvoi=vJp@mail.gmail.com>
	<074F0C4BE8F9FB4CB1410BF8D1E10B5401234514@CF--AMER002E--3.americas.sgi.com>
Message-ID: <0E824289-4892-4AAF-AE4C-78711AF52DB1@trustwave.com>

Mark,
To your last comment - one of my todo research items is to use bogofilter in Lua to do Bayesian analysis.  There are some interesting capabilities. We would need to be able train the classifier on "good" transactions and then maybe run different attack tools and classify them as "bad". The trick would then be to find the ideal Ham/Spam threshold for live analysis.

--
Ryan Barnett


On Jan 25, 2011, at 4:51 PM, "Mark Lavi" <mlavi at sgi.com<mailto:mlavi at sgi.com>> wrote:

>I'd rather not focus on this particular tool, but create some system that would secure for example some specific kinds of websites.

Agreed, you should be applying your thoughts to the arena of "web application security," where mod_security is your method of implementing/testing/analyzing your particular focus.

>Are there any tools that help organising, applying mod security rules? Is it needed? What could make it more research-like? Any hints please?

The iterations of the CRS are a pain since they can change a bit with each release, but that is the nature of their maturity. They are hard to understand since they aren't documented in detail.

You know, the webgoat project (a kind of web app honey pot at <blocked::http://www.owasp.org/index.php/Category:OWASP_WebGoat_Project> http://www.owasp.org/index.php/Category:OWASP_WebGoat_Project and I seem to recall another one used by Google) being protected by mod_security would be an ideal way to document (and do unit testing on) the CRS. I don't know if that is how the CRS is tested and benchmarked?

I would have to say that the LUA scripting engine would be also be an ideal place to insert your value or hypothesis with or without using the CRS since mod_security is an incredible auditing tool:

- test out new, hypothesized attacks and create an algorithmic or heuristic response to log/drop the attacks in LUA/custom rules/etc.
- attach mod_security to a Bayesian filter (<http://en.wikipedia.org/wiki/Bayesian_filter>http://en.wikipedia.org/wiki/Bayesian_filter) and apply email like tactics to web traffic/attacks

Mark Lavi
Senior Web Producer

sgi

46600 Landing Parkway
Fremont, CA 94538
(510) 933-5234 direct
<blocked::mailto:mlavi at sgi.com>mlavi at sgi.com<mailto:mlavi at sgi.com>
<blocked::http://www.sgi.com/>www.sgi.com<http://www.sgi.com>



________________________________
From: Pawel Duda [mailto:thekradox at gmail.com]
Sent: Friday, January 21, 2011 12:46 PM
To: <mailto:mod-security-users at lists.sourceforge.net> mod-security-users at lists.sourceforge.net<mailto:mod-security-users at lists.sourceforge.net>
Subject: [mod-security-users] mod_security - how to use for master thesis?

Hi, I've been playing with mod_security for some time and I'd like somehow to use it in my master thesis. I don't know exactly how this work could be more interesting than describing what mod_security does, what kind of web attacks can be prevented using it, what are other functions of it (like analysing if the requests are really HTTP, analysing XML). I'd rather not focus on this particular tool, but create some system that would secure for example some specific kinds of websites. Are there any tools that help organising, applying mod security rules? Is it needed? What could make it more reaserch-like? Any hints please?
_______________________________________________
Owasp-modsecurity-core-rule-set mailing list
Owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:Owasp-modsecurity-core-rule-set at lists.owasp.org>
https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set

From owasp at yonahruss.com  Wed Jan 26 03:27:12 2011
From: owasp at yonahruss.com (Yonah Russ)
Date: Wed, 26 Jan 2011 10:27:12 +0200
Subject: [Owasp-modsecurity-core-rule-set] ip collection does not exist
Message-ID: <AANLkTiknUif9C6-UEiM=-hseduoFUPEpf_ygyxs5QZJn@mail.gmail.com>

Hi,

I'm running Mod_Security 2.5.13 with CRS 2.1.1
I have copied the following rules into the base_rules directory:
modsecurity_crs_11_dos_protection.conf
modsecurity_crs_11_slow_dos_protection.conf

I've uncommented the following section in  modsecurity_crs_10_config.conf
SecAction "phase:1,t:none,nolog,pass, \
setvar:'tx.dos_burst_time_slice=60', \
setvar:'tx.dos_counter_threshold=100', \
setvar:'tx.dos_block_timeout=600'"

In the debug log I get the error: Could not set variable "ip.dos_counter" as
the collection does not exist.

Here is the level 9 debug up to that point (some details obfuscated)

[26/Jan/2011:08:18:13 +0000] [
192.168.1.1/sid#9caf8][rid#1630cf0][/index.php][4<http://192.168.1.1/sid#9caf8][rid%231630cf0%5D%5B/index.php%5D%5B4>]
Initialising transaction (txid TT-YxKwVByQAAC6ZJSEAAAAC).
[26/Jan/2011:08:18:13 +0000] [
192.168.1.1/sid#9caf8][rid#1630cf0][/index.php][4<http://192.168.1.1/sid#9caf8][rid%231630cf0%5D%5B/index.php%5D%5B4>]
Transaction context created (dcfg de7f0).
[26/Jan/2011:08:18:13 +0000] [
192.168.1.1/sid#9caf8][rid#1630cf0][/index.php][4<http://192.168.1.1/sid#9caf8][rid%231630cf0%5D%5B/index.php%5D%5B4>]
Processing disabled, skipping (hook request_early).
[26/Jan/2011:08:18:13 +0000] [
192.168.1.1/sid#9caf8][rid#1630cf0][/index.php][4<http://192.168.1.1/sid#9caf8][rid%231630cf0%5D%5B/index.php%5D%5B4>]
PdfProtect: Not enabled here.
[26/Jan/2011:08:18:13 +0000] [
192.168.1.1/sid#9caf8][rid#1630cf0][/index.php][4<http://192.168.1.1/sid#9caf8][rid%231630cf0%5D%5B/index.php%5D%5B4>]
Processing disabled, skipping (hook request_late).
[26/Jan/2011:08:18:13 +0000] [
192.168.1.1/sid#9caf8][rid#1630cf0][/index.php][4<http://192.168.1.1/sid#9caf8][rid%231630cf0%5D%5B/index.php%5D%5B4>]
Hook insert_filter: Adding PDF XSS protection output filter (r 1630cf0).
[26/Jan/2011:08:18:13 +0000] [
192.168.1.1/sid#9caf8][rid#1630cf0][/index.php][4<http://192.168.1.1/sid#9caf8][rid%231630cf0%5D%5B/index.php%5D%5B4>]
Hook insert_filter: Processing disabled, skipping.
[26/Jan/2011:08:18:13 +0000] [
192.168.1.1/sid#9caf8][rid#1630cf0][/index.php][4<http://192.168.1.1/sid#9caf8][rid%231630cf0%5D%5B/index.php%5D%5B4>]
Initialising logging.
[26/Jan/2011:08:18:13 +0000] [
192.168.1.1/sid#9caf8][rid#1630cf0][/index.php][4<http://192.168.1.1/sid#9caf8][rid%231630cf0%5D%5B/index.php%5D%5B4>]
Starting phase LOGGING.
[26/Jan/2011:08:18:13 +0000] [
192.168.1.1/sid#9caf8][rid#1630cf0][/index.php][9<http://192.168.1.1/sid#9caf8][rid%231630cf0%5D%5B/index.php%5D%5B9>]
This phase consists of 40 rule(s).
[26/Jan/2011:08:18:13 +0000] [
192.168.1.1/sid#9caf8][rid#1630cf0][/index.php][4<http://192.168.1.1/sid#9caf8][rid%231630cf0%5D%5B/index.php%5D%5B4>]
Recipe: Invoking rule 256478; [file
"/var/www/conf/modsecurity_crs/base_rules/modsecurity_crs_11_dos_protection.conf"]
[line "24"].
[26/Jan/2011:08:18:13 +0000] [
192.168.1.1/sid#9caf8][rid#1630cf0][/index.php][5<http://192.168.1.1/sid#9caf8][rid%231630cf0%5D%5B/index.php%5D%5B5>]
Rule 256478: SecRule "IP:DOS_BLOCK" "@eq 1"
"phase:5,noauditlog,t:none,nolog,skipAfter:END_DOS_PROTECTION_CHECKS"
[26/Jan/2011:08:18:13 +0000] [
192.168.1.1/sid#9caf8][rid#1630cf0][/index.php][4<http://192.168.1.1/sid#9caf8][rid%231630cf0%5D%5B/index.php%5D%5B4>]
Rule returned 0.
[26/Jan/2011:08:18:13 +0000] [
192.168.1.1/sid#9caf8][rid#1630cf0][/index.php][9<http://192.168.1.1/sid#9caf8][rid%231630cf0%5D%5B/index.php%5D%5B9>]
No match, not chained -> mode NEXT_RULE.
[26/Jan/2011:08:18:13 +0000] [
192.168.1.1/sid#9caf8][rid#1630cf0][/index.php][4<http://192.168.1.1/sid#9caf8][rid%231630cf0%5D%5B/index.php%5D%5B4>]
Recipe: Invoking rule 256c28; [file
"/var/www/conf/modsecurity_crs/base_rules/modsecurity_crs_11_dos_protection.conf"]
[line "30"].
[26/Jan/2011:08:18:13 +0000] [
192.168.1.1/sid#9caf8][rid#1630cf0][/index.php][5<http://192.168.1.1/sid#9caf8][rid%231630cf0%5D%5B/index.php%5D%5B5>]
Rule 256c28: SecRule "REQUEST_BASENAME" "!@rx
\\.(jpe?g|png|gif|js|css|ico)$"
"phase:5,noauditlog,t:none,nolog,pass,setvar:ip.dos_counter=+1"
[26/Jan/2011:08:18:13 +0000] [
192.168.1.1/sid#9caf8][rid#1630cf0][/index.php][4<http://192.168.1.1/sid#9caf8][rid%231630cf0%5D%5B/index.php%5D%5B4>]
Transformation completed in 7 usec.
[26/Jan/2011:08:18:13 +0000] [
192.168.1.1/sid#9caf8][rid#1630cf0][/index.php][4<http://192.168.1.1/sid#9caf8][rid%231630cf0%5D%5B/index.php%5D%5B4>]
Executing operator "!rx" with param "\\.(jpe?g|png|gif|js|css|ico)$" against
REQUEST_BASENAME.
[26/Jan/2011:08:18:13 +0000] [
192.168.1.1/sid#9caf8][rid#1630cf0][/index.php][9<http://192.168.1.1/sid#9caf8][rid%231630cf0%5D%5B/index.php%5D%5B9>]
Target value: "index.php"
[26/Jan/2011:08:18:13 +0000] [
192.168.1.1/sid#9caf8][rid#1630cf0][/index.php][6<http://192.168.1.1/sid#9caf8][rid%231630cf0%5D%5B/index.php%5D%5B6>]
Ignoring regex captures since "capture" action is not enabled.
[26/Jan/2011:08:18:13 +0000] [
192.168.1.1/sid#9caf8][rid#1630cf0][/index.php][4<http://192.168.1.1/sid#9caf8][rid%231630cf0%5D%5B/index.php%5D%5B4>]
Operator completed in 189 usec.
[26/Jan/2011:08:18:13 +0000] [
192.168.1.1/sid#9caf8][rid#1630cf0][/index.php][9<http://192.168.1.1/sid#9caf8][rid%231630cf0%5D%5B/index.php%5D%5B9>]
Setting variable: ip.dos_counter=+1
[26/Jan/2011:08:18:13 +0000] [
192.168.1.1/sid#9caf8][rid#1630cf0][/index.php][3<http://192.168.1.1/sid#9caf8][rid%231630cf0%5D%5B/index.php%5D%5B3>]
Could not set variable "ip.dos_counter" as the collection does not exist.

Any ideas?
Thanks,
Yonah
-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20110126/9f8601e9/attachment-0001.html 

From chris at riverstyx.net  Wed Jan 26 19:37:57 2011
From: chris at riverstyx.net (Chris Swanson)
Date: Wed, 26 Jan 2011 16:37:57 -0800
Subject: [Owasp-modsecurity-core-rule-set] Modsecurity crs 2.1.1
	41_advanced_filters & Lua issue
Message-ID: <1296088677.3142.14.camel@chris-desktop>

Hi, we're having a hard time with the new update(s) and Lua in our
testing environment. Here's the error we're seeing in Audit Console,
this is opening up a single transaction: 

Unknown  | Lua: Script execution failed: attempt to call a nil value
Unknown  | Rule processing failed.


This is happening with modsecurity 2.5.13 and modsec CRS 2.1.1 on our
Debian 5 servers, apache is configured with:

./configure --prefix=/usr/local/apache --disable-userdir
--enable-rewrite --enable-so --enable-info --enable-status --enable-ssl
--enable-cgi --enable-unique-id --enable-mime-magic --with-included-apr
--with-pcre=/usr/bin/pcre-config --enable-deflate --enable-expires
--enable-headers

modsecuirty cofigured with:

./configure --with-apxs=/usr/local/apache/bin/apxs
--with-apr=/usr/local/apache/bin/apr-1-config


I've narrowed it down to the include in our http.conf for
modsecurity_crs_41_advanced_filters.conf, which was previously working
as the phpids rules. Even further, by commenting out this section at the
top of the 41_advanced_filters file everything works fine:

# Lua script to normalize input payloads
# Based on PHPIDS Converter.php code
# Reference the following whitepaper -
# http://docs.google.com/Doc?id=dd7x5smw_17g9cnx2cn 
# 
SecRuleScript ../lua/advanced_filter_converter.lua "phase:2,t:none,pass"
SecRule TX:/centrifuge_ratio/ ".*"
"phase:2,t:none,log,capture,msg:'Centrifuge Threshold Alert - Ratio
Value is: %{tx.0}'"


Here is the modsecurity includes in our http.conf

#modsecurity Rules
Include conf/modsecurity.conf
Include conf/modsecurity-crs_2.1.1/*.conf
Include
conf/modsecurity-crs_2.1.1/experimental_rules/modsecurity_crs_41_advanced_filters.conf
Include
conf/modsecurity-crs_2.1.1/optional_rules/modsecurity_crs_25_cc_known.conf
Include conf/modsecurity-crs_2.1.1/base_rules/*conf


With the same setup and versions Modsecurity/Apache, CRS 2.0.10 worked
perfectly. We could move forward without Lua functionally, but I'm lost
as to why such a big addition would be broken from the get-go. Haven't
been able to find anyone posting with a similar issue so any help would
be greatly appreciated.


Thanks,
-Chris


From RBarnett at trustwave.com  Thu Jan 27 10:17:03 2011
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Thu, 27 Jan 2011 09:17:03 -0600
Subject: [Owasp-modsecurity-core-rule-set] Modsecurity crs 2.1.1
 41_advanced_filters & Lua issue
In-Reply-To: <1296088677.3142.14.camel@chris-desktop>
Message-ID: <C966F360.18137%rbarnett@trustwave.com>


On 1/26/11 7:37 PM, "Chris Swanson" <chris at riverstyx.net> wrote:

>Hi, we're having a hard time with the new update(s) and Lua in our
>testing environment. Here's the error we're seeing in Audit Console,
>this is opening up a single transaction:
>
>Unknown  | Lua: Script execution failed: attempt to call a nil value
>Unknown  | Rule processing failed.

A couple questions -

1) Did you modify the path to Lua in the script to point to your local
version?
2) Did you install the additional bitop Lua module?
http://bitop.luajit.org/
   It is specified at the top of the script in a require statement.  This
is needed for the Octal to Decimal conversions.
3) What was the request that triggered this error?


>
>
>This is happening with modsecurity 2.5.13 and modsec CRS 2.1.1 on our
>Debian 5 servers, apache is configured with:
>
>./configure --prefix=/usr/local/apache --disable-userdir
>--enable-rewrite --enable-so --enable-info --enable-status --enable-ssl
>--enable-cgi --enable-unique-id --enable-mime-magic --with-included-apr
>--with-pcre=/usr/bin/pcre-config --enable-deflate --enable-expires
>--enable-headers
>
>modsecuirty cofigured with:
>
>./configure --with-apxs=/usr/local/apache/bin/apxs
>--with-apr=/usr/local/apache/bin/apr-1-config
>
>
>I've narrowed it down to the include in our http.conf for
>modsecurity_crs_41_advanced_filters.conf, which was previously working
>as the phpids rules.
>Even further, by commenting out this section at the
>top of the 41_advanced_filters file everything works fine:
>
># Lua script to normalize input payloads
># Based on PHPIDS Converter.php code
># Reference the following whitepaper -
># http://docs.google.com/Doc?id=dd7x5smw_17g9cnx2cn
># 
>SecRuleScript ../lua/advanced_filter_converter.lua "phase:2,t:none,pass"

You can still run it in this manner but since it will NOT be normalizing
data in the same way as PHPIDS, there will be a higher % of false
positives/false negatives.


>SecRule TX:/centrifuge_ratio/ ".*"
>"phase:2,t:none,log,capture,msg:'Centrifuge Threshold Alert - Ratio
>Value is: %{tx.0}'"
>
>
>Here is the modsecurity includes in our http.conf
>
>#modsecurity Rules
>Include conf/modsecurity.conf
>Include conf/modsecurity-crs_2.1.1/*.conf
>Include
>conf/modsecurity-crs_2.1.1/experimental_rules/modsecurity_crs_41_advanced_
>filters.conf
>Include
>conf/modsecurity-crs_2.1.1/optional_rules/modsecurity_crs_25_cc_known.conf
>Include conf/modsecurity-crs_2.1.1/base_rules/*conf
>
>
>With the same setup and versions Modsecurity/Apache, CRS 2.0.10 worked
>perfectly. We could move forward without Lua functionally, but I'm lost
>as to why such a big addition would be broken from the get-go.

We did put this in the experimental directory after all ;)  Seriously, we
need more people to field test this new, advanced functionality.  I
applaud you for jumping in!  Don't give up on it, hopefully we can get it
working for you.

-Ryan

>Haven't
>been able to find anyone posting with a similar issue so any help would
>be greatly appreciated.
>
>
>Thanks,
>-Chris
>
>_______________________________________________
>Owasp-modsecurity-core-rule-set mailing list
>Owasp-modsecurity-core-rule-set at lists.owasp.org
>https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>



From RBarnett at trustwave.com  Thu Jan 27 12:34:42 2011
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Thu, 27 Jan 2011 11:34:42 -0600
Subject: [Owasp-modsecurity-core-rule-set] New Blog Post - Advanced Topic of
 the Week: Generic Attack Payload Detection
Message-ID: <C96716E2.18182%rbarnett@trustwave.com>

http://blog.spiderlabs.com/2011/01/advanced-topic-of-the-week-generic-attack-payload-detection.html

-Ryan


From chris at riverstyx.net  Thu Jan 27 13:19:11 2011
From: chris at riverstyx.net (Chris Swanson)
Date: Thu, 27 Jan 2011 10:19:11 -0800
Subject: [Owasp-modsecurity-core-rule-set] Modsecurity crs 2.1.1
 41_advanced_filters & Lua issue
In-Reply-To: <C966F360.18137%rbarnett@trustwave.com>
References: <C966F360.18137%rbarnett@trustwave.com>
Message-ID: <1296152351.3142.43.camel@chris-desktop>

Hey Ryan, thanks for the quick response.

> A couple questions -
> 
> 1) Did you modify the path to Lua in the script to point to your local
> version?
> 2) Did you install the additional bitop Lua module?
> http://bitop.luajit.org/
>    It is specified at the top of the script in a require statement.
> This
> is needed for the Octal to Decimal conversions.

I was missing Bitop, I've installed it from source, changed the install
path for Debian, and I believe it's working as we can run the included
bitbench.lua with no errors. The Lua problem still exists.

> 3) What was the request that triggered this error?

It triggers on any request, the one I've been using the most is
accessing the page via IP instead of hostname, here's a breakdown of all
the information regarding the request:

----------------------


Alert Messages:
The following messages have been raised for this event:
        Severity
        Rule ID
        Message
UNKNOWN

Lua: Script execution
failed: attempt to call
a nil value
Rule-Message:

UNKNOWN

Rule processing failed.
Rule-Message:



Rules Section

The following rules have been fired for this event:
SecAction phase:1 t:none nolog pass setvar:tx.anomaly_score_blocking=on
SecAction phase:1 t:none nolog pass setvar:tx.critical_anomaly_score=5
setvar:tx.error_anomaly_score=4 setvar:tx.warning_anomaly_score=3
setvar:tx.notice_anomaly_score=2
SecAction phase:1 t:none nolog pass
setvar:tx.inbound_anomaly_score_level=5
SecAction phase:1 t:none nolog pass
setvar:tx.outbound_anomaly_score_level=4
SecAction phase:1 t:none nolog pass setvar:tx.paranoid_mode=0
SecAction phase:1 t:none nolog pass setvar:tx.max_num_args=255
SecAction phase:1 t:none nolog pass setvar:'tx.allowed_methods=GET HEAD
POST OPTIONS'
setvar:'tx.allowed_request_content_type=application/x-www-form-urlencoded multipart/form-data text/xml application/xml application/x-amf' setvar:'tx.allowed_http_versions=HTTP/0.9 HTTP/1.0 HTTP/1.1' setvar:'tx.restricted_extensions=.asa/ .asax/ .ascx/ .axd/ .backup/ .bak/ .bat/ .cdx/ .cer/ .cfg/ .cmd/ .com/ .config/ .conf/ .cs/ .csproj/ .csr/ .dat/ .db/ .dbf/ .dll/ .dos/ .htr/ .htw/ .ida/ .idc/ .idq/ .inc/ .ini/ .key/ .licx/ .lnk/ .log/ .mdb/ .old/ .pass/ .pdb/ .pol/ .printer/ .pwd/ .resources/ .resx/ .sql/ .sys/ .vb/ .vbs/ .vbproj/ .vsdisco/ .webinfo/ .xsd/ .xsx/' setvar:'tx.restricted_headers=/Lock-Token/ /Content-Range/ /Translate/ /via/ /if/'
SecRule REQUEST_HEADERS:User-Agent @rx ^(.*)$ phase:1 t:none pass nolog
t:sha1 t:hexEncode setvar:tx.ua_hash=%{matched_var}
SecAction phase:1 t:none pass nolog initcol:global=global initcol:ip=
%{remote_addr}_%{tx.ua_hash}
SecAction phase:4 t:none nolog skipAfter:END_KNOWN_CC_OUTBOUND_CHECK\


Request

GET / HTTP/1.1
Host:
172.16.100.191
Connection:
keep-alive
Accept:
application/xml,application/xhtml
+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
User-Agent:
Mozilla/5.0 (X11; U; Linux x86_64;
en-US) AppleWebKit/534.10 (KHTML,
like Gecko) Chrome/8.0.552.200
Safari/534.10
Accept-Encoding:
gzip,deflate,sdch
Accept-Language:
en-US,en;q=0.8
Accept-Charset:
ISO-8859-1,utf-8;q=0.7,*;q=0.3


----------------------

> You can still run it in this manner but since it will NOT be
> normalizing
> data in the same way as PHPIDS, there will be a higher % of false
> positives/false negatives.
> We did put this in the experimental directory after all ;) 

True enough!

>  Seriously, we
> need more people to field test this new, advanced functionality.  I
> applaud you for jumping in!  Don't give up on it, hopefully we can get
> it
> working for you.
> 
> -Ryan

Glad we can help out, we will keep on it until it's resolved.

-Chris
-------------- next part --------------
An HTML attachment was scrubbed...
URL: https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20110127/c764b4fa/attachment.html 

From RBarnett at trustwave.com  Fri Jan 28 10:07:04 2011
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Fri, 28 Jan 2011 09:07:04 -0600
Subject: [Owasp-modsecurity-core-rule-set] SourceForge SVN Site Down Due to
	Attack
Message-ID: <C96845C8.18278%rbarnett@trustwave.com>

In case you haven't heard, SourceForge was attacked yesterday - http://sourceforge.net/apps/wordpress/sourceforge/2011/01/27/sourceforge-net-attack-update/.  Details are sketchy but in the meantime, the SVN site is unavailable.  This means that you can not checkout/sync ModSecurity/CRS data right now.  We will monitor any developments and let you know when the sites are back online.

-Ryan


