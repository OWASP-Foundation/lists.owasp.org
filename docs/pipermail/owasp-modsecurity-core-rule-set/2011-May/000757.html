<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] [Mod-security-developers] CRS DoS protection &amp; x-forwarded-for header
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20%5BMod-security-developers%5D%20CRS%0A%20DoS%20protection%20%26%20x-forwarded-for%20header&In-Reply-To=538135.39824.qm%40web37604.mail.mud.yahoo.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000764.html">
   <LINK REL="Next"  HREF="000758.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] [Mod-security-developers] CRS DoS protection &amp; x-forwarded-for header</H1>
    <B>Ryan Barnett</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20%5BMod-security-developers%5D%20CRS%0A%20DoS%20protection%20%26%20x-forwarded-for%20header&In-Reply-To=538135.39824.qm%40web37604.mail.mud.yahoo.com"
       TITLE="[Owasp-modsecurity-core-rule-set] [Mod-security-developers] CRS DoS protection &amp; x-forwarded-for header">RBarnett at trustwave.com
       </A><BR>
    <I>Thu May  5 10:46:15 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="000764.html">[Owasp-modsecurity-core-rule-set] how to get the description of each rule..
</A></li>
        <LI>Next message: <A HREF="000758.html">[Owasp-modsecurity-core-rule-set] Testing Custom Rules
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#757">[ date ]</a>
              <a href="thread.html#757">[ thread ]</a>
              <a href="subject.html#757">[ subject ]</a>
              <a href="author.html#757">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>FYI - updated the CRS 10 config file to add in this logic and uploaded it to SVN -
<A HREF="http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/modsecurity_crs_10_config.conf.example?revision=1772">http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/modsecurity_crs_10_config.conf.example?revision=1772</A>

#
# -=[ Global and IP Collections ]=-
#
# Create both Global and IP collections for rules to use
# There are some CRS rules that assume that these two collections
# have already been initiated.
#
SecRule REQUEST_HEADERS:User-Agent &quot;^(.*)$&quot; &quot;phase:1,id:'981217',t:none,pass,nolog,t:sha1,t:hexEncode,setvar:tx.ua_hash=%{matched_var}&quot;
SecRule REQUEST_HEADERS:x-forwarded-for &quot;^\b(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})\b&quot; &quot;phase:1,id:'981225',t:none,pass,nolog,capture,setvar:tx.real_ip=%{tx.1}&quot;
SecRule &amp;TX:REAL_IP &quot;!@eq 0&quot; &quot;phase:1,id:'981226',t:none,pass,nolog,initcol:global=global,initcol:ip=%{tx.real_ip}_%{tx.ua_hash}&quot;
SecRule &amp;TX:REAL_IP &quot;@eq 0&quot;  &quot;phase:1,id:'981218',t:none,pass,nolog,initcol:global=global,initcol:ip=%{remote_addr}_%{tx.ua_hash}&quot;

The new rules will grab the first IP address listed in an X-Forwared-For header and use that for the IP collection key.  If X-Forwarded-For is not present, then it will use REMOTE_ADDR.

Thanks for the suggestion!

-Ryan


On 4/28/11 8:19 PM, &quot;Oleg Gryb&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">oleg_gryb at yahoo.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">oleg_gryb at yahoo.com</A>&gt;&gt; wrote:

I've just realized that there might be a problem with relying on that header: if
an attacker intentionally sends different random IPs in there, DoS protection
can be efficiently by-passed. In my case it should not happen, because an LB is
the one who adds the header, but in general we should warn engineers about the
possible exploit.


Actually, even in LB case: if a request has already had the header, LB will
create a new one with the existing value appended to the client IP:

x-forwarded-for: real-client-ip, whatever-client-sent-to-LB

It means that we would need to rely on the the first IP in the list, everything
else should be considered as untrusted.

Thanks,
Oleg.


----- Original Message ----
From: Ryan Barnett &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">RBarnett at trustwave.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">RBarnett at trustwave.com</A>&gt;&gt;
To: Oleg Gryb &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">oleg at gryb.info</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">oleg at gryb.info</A>&gt;&gt;; &quot;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">mod-security-developers at lists.sourceforge.net</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">mod-security-developers at lists.sourceforge.net</A>&gt;&quot;
&lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">mod-security-developers at lists.sourceforge.net</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">mod-security-developers at lists.sourceforge.net</A>&gt;&gt;
Cc: &quot;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&quot;
&lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&gt;
Sent: Thu, April 28, 2011 4:41:14 PM
Subject: Re: [Mod-security-developers] CRS DoS protection &amp; x-forwarded-for
header
Thanks for the updates Oleg!  This will certainly be a useful update  to
not only the DoS rules buy any rules that will be based on the client  IP.
I will actually go back to check other uses of REMOTE_ADDR and see if  we
can swap it for tx.real_ip instead.
I will add this to the CRS  v2.2.0 that I am working on.
For future reference - here is the OWASP CRS  mail-list -
<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set</A>
--
Ryan  Barnett
Senior Security Researcher
Trustwave -  SpiderLabs
On 4/28/11 7:32 PM, &quot;Oleg Gryb&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">oleg_gryb at yahoo.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">oleg_gryb at yahoo.com</A>&gt;&gt;  wrote:
&gt;<i>I'm not sure if I can discuss CRS rules here. If not, please  let me know
</I>&gt;<i>what
</I>&gt;<i>the right place is. I want to suggest an  improvement to DoS protection in
</I>&gt;<i>CRS
</I>&gt;<i>2.1.2. The problem is that  enterprise applications usually run behind
</I>&gt;<i>load
</I>&gt;<i>balancers, so  relying on remote_addr doesn't make too much sense, because
</I>&gt;<i>you'll
</I>&gt;<i>always have an LB's IP in there.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>My improved  rules (attached)  check for x-forwarded-for header and if
</I>&gt;<i>it's
</I>&gt;<i>present, this IP will be used to initialize IP collection. If it's  not
</I>&gt;<i>then the
</I>&gt;<i>old logic will be used.
</I>&gt;<i>
</I>&gt;<i>It would be  great if we can include this improvement to the next  CRS
</I>&gt;<i>release.
</I>&gt;<i>
</I>&gt;<i>Thanks,
</I>&gt;<i>Oleg.
</I>------------------------------------------------------------------------------
WhatsUp  Gold - Download Free Network Management Software
The most intuitive,  comprehensive, and cost-effective network
management toolset available  today.  Delivers lowest initial
acquisition cost and overall TCO of any  competing  solution.
<A HREF="http://p.sf.net/sfu/whatsupgold-sd">http://p.sf.net/sfu/whatsupgold-sd</A>
_______________________________________________
mod-security-developers  mailing list
<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">mod-security-developers at lists.sourceforge.net</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">mod-security-developers at lists.sourceforge.net</A>&gt;
<A HREF="https://lists.sourceforge.net/lists/listinfo/mod-security-developers">https://lists.sourceforge.net/lists/listinfo/mod-security-developers</A>
ModSecurity  Services from Trustwave's SpiderLabs:
<A HREF="https://www.trustwave.com/spiderLabs.php">https://www.trustwave.com/spiderLabs.php</A>

------------------------------------------------------------------------------
WhatsUp Gold - Download Free Network Management Software
The most intuitive, comprehensive, and cost-effective network
management toolset available today.  Delivers lowest initial
acquisition cost and overall TCO of any competing solution.
<A HREF="http://p.sf.net/sfu/whatsupgold-sd">http://p.sf.net/sfu/whatsupgold-sd</A>
_______________________________________________
mod-security-developers mailing list
<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">mod-security-developers at lists.sourceforge.net</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">mod-security-developers at lists.sourceforge.net</A>&gt;
<A HREF="https://lists.sourceforge.net/lists/listinfo/mod-security-developers">https://lists.sourceforge.net/lists/listinfo/mod-security-developers</A>
ModSecurity Services from Trustwave's SpiderLabs:
<A HREF="https://www.trustwave.com/spiderLabs.php">https://www.trustwave.com/spiderLabs.php</A>



________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.

</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000764.html">[Owasp-modsecurity-core-rule-set] how to get the description of each rule..
</A></li>
	<LI>Next message: <A HREF="000758.html">[Owasp-modsecurity-core-rule-set] Testing Custom Rules
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#757">[ date ]</a>
              <a href="thread.html#757">[ thread ]</a>
              <a href="subject.html#757">[ subject ]</a>
              <a href="author.html#757">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
