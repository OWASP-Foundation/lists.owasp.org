<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Joomla jforms issue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20Joomla%20jforms%20issue&In-Reply-To=00163646bc7027269e04a29b7c3e%40google.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000765.html">
   <LINK REL="Next"  HREF="000767.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Joomla jforms issue</H1>
    <B>Ryan Barnett</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=%5BOwasp-modsecurity-core-rule-set%5D%20Joomla%20jforms%20issue&In-Reply-To=00163646bc7027269e04a29b7c3e%40google.com"
       TITLE="[Owasp-modsecurity-core-rule-set] Joomla jforms issue">RBarnett at trustwave.com
       </A><BR>
    <I>Fri May  6 09:38:54 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="000765.html">[Owasp-modsecurity-core-rule-set] Joomla jforms issue
</A></li>
        <LI>Next message: <A HREF="000767.html">[Owasp-modsecurity-core-rule-set] Rule Updates Are Coming!
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#766">[ date ]</a>
              <a href="thread.html#766">[ thread ]</a>
              <a href="subject.html#766">[ subject ]</a>
              <a href="author.html#766">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>What does the debug log show when you run these checks?

Try this -

SecRule &quot;TX:'/tx.900030-Detects\s(.*)-ARGS_NAMES:jform/'&quot; &quot;@contains ][&quot; &quot;chain,phase:2,t:none,nolog,pass&quot;
SecRule MATCHED_VAR_NAME &quot;TX\:(.*)&quot; &quot;capture,t:none,setvar:!tx.%{tx.1},setvar:tx.anomaly_score=-4&quot;

-Ryan

From: &quot;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">hendrikdm at gmail.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">hendrikdm at gmail.com</A>&gt;&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">hendrikdm at gmail.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">hendrikdm at gmail.com</A>&gt;&gt;
Date: Fri, 6 May 2011 08:29:53 -0500
To: &quot;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&gt;
Subject: [Owasp-modsecurity-core-rule-set] Joomla jforms issue

Good day,

I have a problem with a site that is currently running joomla 1.6.0, when working in the admin panel.

The site gives false positives on the below rule in: modsecurity_crs_41_phpids_filters.conf

SecRule ARGS|ARGS_NAMES|XML:/* &quot;(?:=\s*\w+\s*\+\s*\&quot;)|(?:\+=\s*\(\s\&quot;)|(?:!+\s*[\d.,]+\w?\d*\s*\?)|(?:=\s*\[s*\])|(?:\&quot;\s*\+\s*\&quot;)|(?:[^\s]\[\s*\d+\s*\]\s*[;+])|(?:\&quot;\s*[&amp;|]+\s*\&quot;)|(?:\/\s*\?\s*\&quot;)|(?:\
/\s*\)\s*\[)|(?:\d\?.+:\d)|(?:]\s*\[\W*\w)|(?:[^\s]\s*=\s*\/)&quot; &quot;phase:2,capture,t:none,t:cssDecode,t:jsDecode,t:htmlEntityDecode,t:replaceComments,t:compressWhiteSpace,t:lowercase,ctl:auditLogParts=+E,b
lock,nolog,auditlog,msg:'Detects common XSS concatenation patterns 1/2',id:'900030',tag:'WEB_ATTACK/XSS',tag:'WEB_ATTACK/CSRF',tag:'WEB_ATTACK/ID',tag:'WEB_ATTACK/RFE',logdata:'%{TX.0}',severity:'2',set
var:'tx.msg=%{rule.id}-%{rule.msg}',setvar:tx.anomaly_score=+4,setvar:tx.%{tx.msg}-WEB_ATTACK/INJECTION-%{matched_var_name}=%{tx.0}&quot;

The reason for the matching seems to be the posting of the data once the particular article has been updated, some snippets of the audit log for this site:

Message: Pattern match &quot;(?:=\s*\w+\s*\+\s*&quot;)|(?:\+=\s*\(\s&quot;)|(?:!+\s*[\d.,]+\w?\d*\s*\?)|(?:=\s*\[s*\])|(?:&quot;\s*\+\s*&quot;)|(?:[^\s]\[\s*\d+\s*\]\s*[;+])|(?:&quot;\s*[&amp;|]+\s*&quot;)|(?:\/\s*\?\s*&quot;)|(?:\/\s*\)\s*\[)|(?:\d\?.+:\d)|(?:]\s*\[\W*\w)|(?:[^\s]\s*=\s*\/)&quot; at ARGS_NAMES:jform[rules][core.edit][6]. [file &quot;/usr/local/etc/apache22/Includes/mod_security2/base_rules/modsecurity_crs_41_phpids_filters.conf&quot;] [line &quot;205&quot;] [id &quot;900030&quot;] [msg &quot;Detects common XSS concatenation patterns 1/2&quot;] [data &quot;][c&quot;] [severity &quot;CRITICAL&quot;] [tag &quot;WEB_ATTACK/XSS&quot;] [tag &quot;WEB_ATTACK/CSRF&quot;] [tag &quot;WEB_ATTACK/ID&quot;] [tag &quot;WEB_ATTACK/RFE&quot;]

Message: Pattern match &quot;(?:=\s*\w+\s*\+\s*&quot;)|(?:\+=\s*\(\s&quot;)|(?:!+\s*[\d.,]+\w?\d*\s*\?)|(?:=\s*\[s*\])|(?:&quot;\s*\+\s*&quot;)|(?:[^\s]\[\s*\d+\s*\]\s*[;+])|(?:&quot;\s*[&amp;|]+\s*&quot;)|(?:\/\s*\?\s*&quot;)|(?:\/\s*\)\s*\[)|(?:\d\?.+:\d)|(?:]\s*\[\W*\w)|(?:[^\s]\s*=\s*\/)&quot; at ARGS_NAMES:jform[rules][core.edit.state][6]. [file &quot;/usr/local/etc/apache22/Includes/mod_security2/base_rules/modsecurity_crs_41_phpids_filters.conf&quot;] [line &quot;205&quot;] [id &quot;900030&quot;] [msg &quot;Detects common XSS concatenation patterns 1/2&quot;] [data &quot;][c&quot;] [severity &quot;CRITICAL&quot;] [tag &quot;WEB_ATTACK/XSS&quot;] [tag &quot;WEB_ATTACK/CSRF&quot;] [tag &quot;WEB_ATTACK/ID&quot;] [tag &quot;WEB_ATTACK/RFE&quot;]

Message: Pattern match &quot;(?:=\s*\w+\s*\+\s*&quot;)|(?:\+=\s*\(\s&quot;)|(?:!+\s*[\d.,]+\w?\d*\s*\?)|(?:=\s*\[s*\])|(?:&quot;\s*\+\s*&quot;)|(?:[^\s]\[\s*\d+\s*\]\s*[;+])|(?:&quot;\s*[&amp;|]+\s*&quot;)|(?:\/\s*\?\s*&quot;)|(?:\/\s*\)\s*\[)|(?:\d\?.+:\d)|(?:]\s*\[\W*\w)|(?:[^\s]\s*=\s*\/)&quot; at ARGS_NAMES:jform[rules][core.delete][7]. [file &quot;/usr/local/etc/apache22/Includes/mod_security2/base_rules/modsecurity_crs_41_phpids_filters.conf&quot;] [line &quot;205&quot;] [id &quot;900030&quot;] [msg &quot;Detects common XSS concatenation patterns 1/2&quot;] [data &quot;][c&quot;] [severity &quot;CRITICAL&quot;] [tag &quot;WEB_ATTACK/XSS&quot;] [tag &quot;WEB_ATTACK/CSRF&quot;] [tag &quot;WEB_ATTACK/ID&quot;] [tag &quot;WEB_ATTACK/RFE&quot;]

Message: Pattern match &quot;(?:=\s*\w+\s*\+\s*&quot;)|(?:\+=\s*\(\s&quot;)|(?:!+\s*[\d.,]+\w?\d*\s*\?)|(?:=\s*\[s*\])|(?:&quot;\s*\+\s*&quot;)|(?:[^\s]\[\s*\d+\s*\]\s*[;+])|(?:&quot;\s*[&amp;|]+\s*&quot;)|(?:\/\s*\?\s*&quot;)|(?:\/\s*\)\s*\[)|(?:\d\?.+:\d)|(?:]\s*\[\W*\w)|(?:[^\s]\s*=\s*\/)&quot; at ARGS_NAMES:jform[rules][core.edit][7]. [file &quot;/usr/local/etc/apache22/Includes/mod_security2/base_rules/modsecurity_crs_41_phpids_filters.conf&quot;] [line &quot;205&quot;] [id &quot;900030&quot;] [msg &quot;Detects common XSS concatenation patterns 1/2&quot;] [data &quot;][c&quot;] [severity &quot;CRITICAL&quot;] [tag &quot;WEB_ATTACK/XSS&quot;] [tag &quot;WEB_ATTACK/CSRF&quot;] [tag &quot;WEB_ATTACK/ID&quot;] [tag &quot;WEB_ATTACK/RFE&quot;]

Message: Pattern match &quot;(?:=\s*\w+\s*\+\s*&quot;)|(?:\+=\s*\(\s&quot;)|(?:!+\s*[\d.,]+\w?\d*\s*\?)|(?:=\s*\[s*\])|(?:&quot;\s*\+\s*&quot;)|(?:[^\s]\[\s*\d+\s*\]\s*[;+])|(?:&quot;\s*[&amp;|]+\s*&quot;)|(?:\/\s*\?\s*&quot;)|(?:\/\s*\)\s*\[)|(?:\d\?.+:\d)|(?:]\s*\[\W*\w)|(?:[^\s]\s*=\s*\/)&quot; at ARGS_NAMES:jform[rules][core.edit.state][7]. [file &quot;/usr/local/etc/apache22/Includes/mod_security2/base_rules/modsecurity_crs_41_phpids_filters.conf&quot;] [line &quot;205&quot;] [id &quot;900030&quot;] [msg &quot;Detects common XSS concatenation patterns 1/2&quot;] [data &quot;][c&quot;] [severity &quot;CRITICAL&quot;] [tag &quot;WEB_ATTACK/XSS&quot;] [tag &quot;WEB_ATTACK/CSRF&quot;] [tag &quot;WEB_ATTACK/ID&quot;] [tag &quot;WEB_ATTACK/RFE&quot;]

Message: Pattern match &quot;(?:=\s*\w+\s*\+\s*&quot;)|(?:\+=\s*\(\s&quot;)|(?:!+\s*[\d.,]+\w?\d*\s*\?)|(?:=\s*\[s*\])|(?:&quot;\s*\+\s*&quot;)|(?:[^\s]\[\s*\d+\s*\]\s*[;+])|(?:&quot;\s*[&amp;|]+\s*&quot;)|(?:\/\s*\?\s*&quot;)|(?:\/\s*\)\s*\[)|(?:\d\?.+:\d)|(?:]\s*\[\W*\w)|(?:[^\s]\s*=\s*\/)&quot; at ARGS_NAMES:jform[rules][core.delete][2]. [file &quot;/usr/local/etc/apache22/Includes/mod_security2/base_rules/modsecurity_crs_41_phpids_filters.conf&quot;] [line &quot;205&quot;] [id &quot;900030&quot;] [msg &quot;Detects common XSS concatenation patterns 1/2&quot;] [data &quot;][c&quot;] [severity &quot;CRITICAL&quot;] [tag &quot;WEB_ATTACK/XSS&quot;] [tag &quot;WEB_ATTACK/CSRF&quot;] [tag &quot;WEB_ATTACK/ID&quot;] [tag &quot;WEB_ATTACK/RFE&quot;]

Seeing that the rule set the variable I wanted to matched based on that variable:
[06/May/2011:14:18:50 +0200] [/sid#809b82900][rid#81de4e0a8][/administrator/index.php][9] Set variable &quot;tx.900030-Detects common XSS concatenation patterns 1/2-WEB_ATTACK/INJECTION-ARGS_NAMES:jform[attribs][show_icons]&quot; to &quot;][s&quot;.

I used a combination of resources from the below sites to create the correct rule structure:
<A HREF="https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/2010-January/000257.html">https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/2010-January/000257.html</A>
<A HREF="http://www.modsecurity.org/blog/archives/2007/12/using_transacti.html">http://www.modsecurity.org/blog/archives/2007/12/using_transacti.html</A>

The file that I used for my rule is:
modsecurity_crs_48_local_exceptions.conf

The rules are as follows.

1) SecRule TX:&quot;/tx.900030-Detects\s(.*)-ARGS_NAMES:jform/&quot; &quot;@contains ][&quot; &quot;chain,phase:2,t:none,ctl:auditLogParts=+E,block,nolog,auditlog,msg:'Fix false positive',pass&quot;
SecRule MATCHED_VAR_NAME &quot;TX\:(.*)&quot; &quot;capture,t:none,setvar:!tx.%{tx.1},setvar:tx.anomaly_score=-4&quot;

2) SecRule TX:&quot;/tx.900030-Detects\s(.*)-ARGS_NAMES:jform/&quot; &quot;@contains ][&quot; &quot;capture,t:none,setvar:!tx.%{tx.1},setvar:tx.anomaly_score=-4&quot;

3) SecRule TX:'/tx.900030-Detects(.*)-ARGS_NAMES:jform/' &quot;@contains ][&quot; &quot;capture,t:none,setvar:!tx.%{tx.1},setvar:tx.anomaly_score=-4&quot; #### This rule did not want to work with the single quotes.

&gt;<i>From what I have tested so far, the regex should works for all variants of the variables set, however the anomaly score does not decrease, and from what I could see in both the audit and debug logs it does not look like it follows the logic as I understand it, so either the regex is incorrect or I am placing it in the incorrect file, but then why would it then work when I remove the rule in the same file using SecRuleRemoveById.
</I>
Some of the variants, there are currently 55.
tx.900030-Detects common XSS concatenation patterns 1/2-WEB_ATTACK/INJECTION-ARGS_NAMES:jform[attribs][show_item_navigation]
tx.900030-Detects common XSS concatenation patterns 1/2-WEB_ATTACK/INJECTION-ARGS_NAMES:jform[attribs][show_icons]
tx.900030-Detects common XSS concatenation patterns 1/2-WEB_ATTACK/INJECTION-ARGS_NAMES:jform[attribs][show_print_icon]
tx.900030-Detects common XSS concatenation patterns 1/2-WEB_ATTACK/INJECTION-ARGS_NAMES:jform[attribs][show_email_icon]
tx.900030-Detects common XSS concatenation patterns 1/2-WEB_ATTACK/INJECTION-ARGS_NAMES:jform[attribs][show_vote]
tx.900030-Detects common XSS concatenation patterns 1/2-WEB_ATTACK/INJECTION-ARGS_NAMES:jform[attribs][show_hits]
tx.900030-Detects common XSS concatenation patterns 1/2-WEB_ATTACK/INJECTION-ARGS_NAMES:jform[attribs][show_noauth]
tx.900030-Detects common XSS concatenation patterns 1/2-WEB_ATTACK/INJECTION-ARGS_NAMES:jform[attribs][alternative_readmore]
tx.900030-Detects common XSS concatenation patterns 1/2-WEB_ATTACK/INJECTION-ARGS_NAMES:jform[attribs][article_layout]
tx.900030-Detects common XSS concatenation patterns 1/2-WEB_ATTACK/INJECTION-ARGS_NAMES:jform[metadata][robots]
tx.900030-Detects common XSS concatenation patterns 1/2-WEB_ATTACK/INJECTION-ARGS_NAMES:jform[metadata][author]
tx.900030-Detects common XSS concatenation patterns 1/2-WEB_ATTACK/INJECTION-ARGS_NAMES:jform[metadata][rights]
tx.900030-Detects common XSS concatenation patterns 1/2-WEB_ATTACK/INJECTION-ARGS_NAMES:jform[metadata][xreference]
tx.900030-Detects common XSS concatenation patterns 1/2-WEB_ATTACK/INJECTION-ARGS_NAMES:jform[rules][core.delete][1]
tx.900030-Detects common XSS concatenation patterns 1/2-WEB_ATTACK/INJECTION-ARGS_NAMES:jform[rules][core.edit][1]
tx.900030-Detects common XSS concatenation patterns 1/2-WEB_ATTACK/INJECTION-ARGS_NAMES:jform[rules][core.edit.state][1]
tx.900030-Detects common XSS concatenation patterns 1/2-WEB_ATTACK/INJECTION-ARGS_NAMES:jform[rules][core.delete][6]
tx.900030-Detects common XSS concatenation patterns 1/2-WEB_ATTACK/INJECTION-ARGS_NAMES:jform[rules][core.edit][6]
tx.900030-Detects common XSS concatenation patterns 1/2-WEB_ATTACK/INJECTION-ARGS_NAMES:jform[rules][core.edit.state][6]
tx.900030-Detects common XSS concatenation patterns 1/2-WEB_ATTACK/INJECTION-ARGS_NAMES:jform[rules][core.delete][7]
tx.900030-Detects common XSS concatenation patterns 1/2-WEB_ATTACK/INJECTION-ARGS_NAMES:jform[rules][core.edit][7]
tx.900030-Detects common XSS concatenation patterns 1/2-WEB_ATTACK/INJECTION-ARGS_NAMES:jform[rules][core.edit.state][7]
tx.900030-Detects common XSS concatenation patterns 1/2-WEB_ATTACK/INJECTION-ARGS_NAMES:jform[rules][core.delete][2]
tx.900030-Detects common XSS concatenation patterns 1/2-WEB_ATTACK/INJECTION-ARGS_NAMES:jform[rules][core.edit][2]

________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000765.html">[Owasp-modsecurity-core-rule-set] Joomla jforms issue
</A></li>
	<LI>Next message: <A HREF="000767.html">[Owasp-modsecurity-core-rule-set] Rule Updates Are Coming!
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#766">[ date ]</a>
              <a href="thread.html#766">[ thread ]</a>
              <a href="subject.html#766">[ subject ]</a>
              <a href="author.html#766">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
