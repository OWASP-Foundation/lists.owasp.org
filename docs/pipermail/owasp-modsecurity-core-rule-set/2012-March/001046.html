<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] CRS 2.2.4 Rules 981220 and 981222	Puzzle
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20CRS%202.2.4%20Rules%20981220%20and%20981222%0A%09Puzzle&In-Reply-To=%3C6BCDC45EEA955145BD59DFFC6C4E6DA21F059776%40CEXMB001.nmes.lcl%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001045.html">
   <LINK REL="Next"  HREF="001047.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] CRS 2.2.4 Rules 981220 and 981222	Puzzle</H1>
    <B>Owens, Mike, DoIT</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20CRS%202.2.4%20Rules%20981220%20and%20981222%0A%09Puzzle&In-Reply-To=%3C6BCDC45EEA955145BD59DFFC6C4E6DA21F059776%40CEXMB001.nmes.lcl%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] CRS 2.2.4 Rules 981220 and 981222	Puzzle">Mike.Owens at state.nm.us
       </A><BR>
    <I>Wed Mar 28 15:27:50 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="001045.html">[Owasp-modsecurity-core-rule-set] Should not the following being blocked by default?
</A></li>
        <LI>Next message: <A HREF="001047.html">[Owasp-modsecurity-core-rule-set] CRS 2.2.4 Rules freaking out on	Magento
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1046">[ date ]</a>
              <a href="thread.html#1046">[ thread ]</a>
              <a href="subject.html#1046">[ subject ]</a>
              <a href="author.html#1046">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I have encountered a puzzle involving rules 981220 and 981222. The two rules are testing for the presence of a default charset being sent either in the Content-type response header or a meta tag in the response body. The rules themselves inspect the RESPONSE_CONTENT_TYPE (Apache internal area) rather than the Content-type header per se.

In my audit log, I have a case where the Content-type response header is &quot;text/html; charset=utf-8&quot;, but the log entry reports that the RESPONSE_CONTENT_TYPE contains on &quot;text/html&quot;. This causes the two rules to fire.

My question is, why does ModSecurity show a difference betweent the Content-type header and the RESPONSE_CONTENT_TYPE area?

Here's a typical audit log entry (identifying data replaced with &quot;***&quot;):

--4b594116-A--
[28/Mar/2012:09:02:46 --0600] T3MoFn8AAAEAACg91mkAAADM *** 30254 ***
--4b594116-B--
GET / HTTP/1.1
User-Agent: Mozilla/4.0 (compatible MSIE 6.0 Windows NT 5.1
Connection: close
Host: ***
Accept: text/html

--4b594116-F--
HTTP/1.1 200 OK
Last-Modified: Tue, 06 Oct 2009 14:45:37 GMT
ETag: &quot;198-4754548896640&quot;
Accept-Ranges: bytes
Content-Length: 408
Connection: close
Content-Type: text/html; charset=utf-8

--4b594116-H--
Message: Warning. Match of &quot;rx (?i:(&lt;meta.*?(content|value)=\&quot;text/html;\\s?charset=|&lt;\\?xml.*?encoding=))&quot; against &quot;RESPONSE_BODY&quot; required. [file &quot;/usr/local/apache/conf/site-conf/modsecurity/activated_rules/modsecurity_crs_55_application_defects.conf&quot;] [line &quot;23&quot;] [id &quot;981220&quot;] [msg &quot;[Watcher Check] No charset was specified in the HTTP Content-Type header nor the HTML content's meta tag.&quot;] [data &quot;Content-Type Response Header: text/html&quot;] [tag &quot;WASCTC/WASC-15&quot;] [tag &quot;APP_DEFECT/MISCONFIGURATION&quot;] [tag &quot;<A HREF="http://code.google.com/p/browsersec/wiki/Part2#Content_handling_mechanisms">http://code.google.com/p/browsersec/wiki/Part2#Content_handling_mechanisms</A>&quot;]
Message: Warning. Match of &quot;rx (&lt;meta.*?(content|value)=\&quot;text/html;\\s?charset=utf-8|&lt;\\?xml.*?encoding=\&quot;utf-8\&quot;)&quot; against &quot;RESPONSE_BODY&quot; required. [file &quot;/usr/local/apache/conf/site-conf/modsecurity/activated_rules/modsecurity_crs_55_application_defects.conf&quot;] [line &quot;36&quot;] [id &quot;981222&quot;] [msg &quot;[Watcher Check]  The charset specified was not utf-8 in the HTTP Content-Type header nor the HTML content's meta tag.&quot;] [data &quot;Content-Type Response Header: text/html&quot;] [tag &quot;WASCTC/WASC-15&quot;] [tag &quot;MISCONFIGURATION&quot;] [tag &quot;<A HREF="http://websecuritytool.codeplex.com/wikipage?title=Checks#charset-not-utf8">http://websecuritytool.codeplex.com/wikipage?title=Checks#charset-not-utf8</A>&quot;]
Stopwatch: 1332946966251284 24295 (- - -)
Stopwatch2: 1332946966251284 24295; combined=7754, p1=1161, p2=4497, p3=48, p4=298, p5=1545, sr=344, sw=205, l=0, gc=0
Producer: ModSecurity for Apache/2.6.5 (<A HREF="http://www.modsecurity.org/">http://www.modsecurity.org/</A>); core ruleset/2.2.4.
Server: 
Sanitised-Request-Headers: &quot;Authorization&quot;.

--4b594116-Z--

My setup, in case that helps:

Red Hat Enterprise Linux; kernel 2.6.18-274.el5 #1 SMP Fri Jul 8 17:36:59 EDT 2011 x86_64 x86_64 x86_64 GNU/Linux
Apache 2.4.1
ModSecurity 2.6.5
ModSecurity CRS 2.2.4

--
Michael Owens &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">mike.owens at state.nm.us</A>&gt;

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001045.html">[Owasp-modsecurity-core-rule-set] Should not the following being blocked by default?
</A></li>
	<LI>Next message: <A HREF="001047.html">[Owasp-modsecurity-core-rule-set] CRS 2.2.4 Rules freaking out on	Magento
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1046">[ date ]</a>
              <a href="thread.html#1046">[ thread ]</a>
              <a href="subject.html#1046">[ subject ]</a>
              <a href="author.html#1046">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
