<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] Mod security is not detecting double header's
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Mod%20security%20is%20not%20detecting%0A%20double%20header%27s&In-Reply-To=%3CCB765C91.44E2A%25rbarnett%40trustwave.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001024.html">
   <LINK REL="Next"  HREF="001020.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] Mod security is not detecting double header's</H1>
    <B>Ryan Barnett</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20Mod%20security%20is%20not%20detecting%0A%20double%20header%27s&In-Reply-To=%3CCB765C91.44E2A%25rbarnett%40trustwave.com%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] Mod security is not detecting double header's">RBarnett at trustwave.com
       </A><BR>
    <I>Fri Mar  2 16:18:43 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="001024.html">[Owasp-modsecurity-core-rule-set] Mod security is not detecting double header's
</A></li>
        <LI>Next message: <A HREF="001020.html">[Owasp-modsecurity-core-rule-set] [Rule Update - Discussion Thread]	IP Reputation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1025">[ date ]</a>
              <a href="thread.html#1025">[ thread ]</a>
              <a href="subject.html#1025">[ subject ]</a>
              <a href="author.html#1025">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The rules work the same whether the port is 80 or 443.  There must be something else going.  I see you are using jakarta-servlet.  Perhaps this handler is working differently for HTTPS traffic.

--
Ryan Barnett
Trustwave SpiderLabs
ModSecurity Project Leader
OWASP ModSecurity CRS Project Leader

From: Gagandeep Singh &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">gagandeepsohi at gmail.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">gagandeepsohi at gmail.com</A>&gt;&gt;
Date: Fri, 2 Mar 2012 05:53:15 -0600
To: Ryan Barnett &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">rbarnett at trustwave.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">rbarnett at trustwave.com</A>&gt;&gt;, &quot;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&gt;
Subject: Re: [Owasp-modsecurity-core-rule-set] Mod security is not detecting double header's

We have validated that Apache Include directives is in the core directives. When we are trying a SQL injection on HTTPS it detects the attack and throws an exception.This means  mod-security and CRS is working for HTTPS as well.

In case of double header this is not working for HTTPS. Do we need to make any changes in rule set?

Regards
Gagandeep

On Thu, Mar 1, 2012 at 6:40 PM, Ryan Barnett &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">RBarnett at trustwave.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">RBarnett at trustwave.com</A>&gt;&gt; wrote:
How do you have the CRS conf files activated in Apache for the port 80 server?  If you are using Apache Includes, then you should include them also within your HTTPS/443 vhost container.

The other option is, if you want to run the CRS for all HTTP and HTTPS sites, is to specify the Apache Include directives in the core directives location instead of further down within specific vhost containers.  This will propagate to all vhosts.

--
Ryan Barnett
Trustwave SpiderLabs
ModSecurity Project Leader
OWASP ModSecurity CRS Project Leader

From: Gagandeep Singh &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">gagandeepsohi at gmail.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">gagandeepsohi at gmail.com</A>&gt;&gt;
Date: Thu, 1 Mar 2012 18:03:47 +0000
To: &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&gt;, Ryan Barnett &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">ryan.barnett at owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">ryan.barnett at owasp.org</A>&gt;&gt;
Subject: Re: [Owasp-modsecurity-core-rule-set] Mod security is not detecting double header's

Thanks Ryan for your help,

FURTHER ISSUE-  its working for HTTP and we got the below response. Our issue is with  HTTPS  as well, this rule is not working for https. Our client has raised a concern for HTTPS. Could you please advise what we can do to enable this for HTTPS as well.


Message: Warning. Pattern match &quot;[\n\r](?:content-(type|length)|set-cookie|location):&quot; at REQUEST_FILENAME. [file &quot;/etc/httpd/modsecurity.d/modsecurity_localrules.conf&quot;] [line &quot;4&quot;] [id &quot;950910&quot;] [rev &quot;2.2.4&quot;] [msg &quot;HTTP Response Splitting Attack&quot;] [data &quot;\x0alocation:&quot;] [severity &quot;ALERT&quot;]
Message: Warning. Pattern match &quot;[\n\r](?:content-(type|length)|set-cookie|location):&quot; at REQUEST_FILENAME. [file &quot;/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_40_generic_attacks.conf&quot;] [line &quot;139&quot;] [id &quot;950910&quot;] [rev &quot;2.2.4&quot;] [msg &quot;HTTP Response Splitting Attack&quot;] [data &quot;\x0alocation:&quot;] [severity &quot;CRITICAL&quot;]
Message: Access denied with code 403 (phase 2). [file &quot;/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_49_enforcement.conf&quot;] [line &quot;25&quot;] [msg &quot;Anomaly Score Exceeded (score 40): HTTP Response Splitting Attack&quot;]
Action: Intercepted (phase 2)
Apache-Handler: jakarta-servlet
Stopwatch: 1330624314422822 1653262 (1471 1258692 -)
Producer: ModSecurity for Apache/2.5.12 (<A HREF="http://www.modsecurity.org/">http://www.modsecurity.org/</A>); core ruleset/2.0.5.&lt;<A HREF="http://2.0.5.">http://2.0.5.</A>&gt;






On Thu, Mar 1, 2012 at 5:25 PM, Ryan Barnett &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">ryan.barnett at owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">ryan.barnett at owasp.org</A>&gt;&gt; wrote:
I have pushed CRS v2.2.4 out to SVN and you can access the updated rule file here -
<A HREF="http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/base_rules/modsecurity_crs_40_generic_attacks.conf?revision=1900">http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/base_rules/modsecurity_crs_40_generic_attacks.conf?revision=1900</A>

Here is the updated rule -

SecRule REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_FILENAME|ARGS_NAMES|ARGS|XML:/* &quot;[\n\r](?:content-(type|length)|set-cookie|location):&quot; \
        &quot;phase:2,rev:'2.2.4',t:none,t:lowercase,capture,ctl:auditLogParts=+E,block,msg:'HTTP Response Splitting Attack',id:'950910',logdata:'%{TX.0}',severity:'2',setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.critical_anomaly_score},setvar:tx.response_splitting_score=+%{tx.critical_anomaly_score},setvar:tx.%{rule.id&lt;<A HREF="http://rule.id">http://rule.id</A>&gt;}-WEB_ATTACK/RESPONSE_SPLITTING-%{matched_var_name}=%{tx.0}&quot;

-Ryan

From: Gagandeep Singh &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">gagandeepsohi at gmail.com</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">gagandeepsohi at gmail.com</A>&gt;&gt;
Date: Thu, 1 Mar 2012 17:15:36 +0000
To: &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;&gt;
Subject: [Owasp-modsecurity-core-rule-set] Mod security is not detecting double header's

Hi

We have configured modsecurity apache_2.6.3 and its working fine for most of the cases but we have identified a special attack which is causing a double header injection to the site.

Example :-
 <A HREF="https://www.XYZ.com/%0d%0aLocation:http://www.google.com&lt;https://www.xyz.com/%0d%0aLocation:http://www.google.com">https://www.XYZ.com/%0d%0aLocation:http://www.google.com&lt;https://www.xyz.com/%0d%0aLocation:http://www.google.com</A>&gt;
 Note - XYZ is any site.

This generates a Duplicate headers error page which is shown below-

Duplicate headers received from the server

The response from the server contained duplicate headers. This problem is generally the result of a misconfigured website or proxy. Only the website or proxy administrator can fix this issue.

 Error 350 (net::ERR_RESPONSE_HEADERS_MULTIPLE_LOCATION): Multiple Location headers received. This is disallowed to protect against HTTP response-splitting attacks.


As per the discussion with Bren we came to know that this will be fixed in CRS 2.2.4 but we need this urgently, Is it possible to get the rule for above issue so we can apply the patch for the time being and will apply 2.2.4 soon as it becomes available.

Could you please also assist on this, what configuration changes are required to handle this?

Regards
Gagandeep Singh  Sohi
_______________________________________________ Owasp-modsecurity-core-rule-set mailing list <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>&lt;mailto:<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>&gt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set</A>



--
Regards,
Gagandeep Singh Sohi
9717920072


________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.



--
Regards,
Gagandeep Singh Sohi
9717920072


________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120302/8acac9f3/attachment.html">http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120302/8acac9f3/attachment.html</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001024.html">[Owasp-modsecurity-core-rule-set] Mod security is not detecting double header's
</A></li>
	<LI>Next message: <A HREF="001020.html">[Owasp-modsecurity-core-rule-set] [Rule Update - Discussion Thread]	IP Reputation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1025">[ date ]</a>
              <a href="thread.html#1025">[ thread ]</a>
              <a href="subject.html#1025">[ subject ]</a>
              <a href="author.html#1025">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
