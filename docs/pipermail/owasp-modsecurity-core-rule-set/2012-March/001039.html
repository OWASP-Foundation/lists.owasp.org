<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-modsecurity-core-rule-set] anomaly score not calculated ?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20anomaly%20score%20not%20calculated%20%3F&In-Reply-To=%3CCB8CA782.46ABB%25rbarnett%40trustwave.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001038.html">
   <LINK REL="Next"  HREF="001040.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-modsecurity-core-rule-set] anomaly score not calculated ?</H1>
    <B>Ryan Barnett</B> 
    <A HREF="mailto:owasp-modsecurity-core-rule-set%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-modsecurity-core-rule-set%5D%20anomaly%20score%20not%20calculated%20%3F&In-Reply-To=%3CCB8CA782.46ABB%25rbarnett%40trustwave.com%3E"
       TITLE="[Owasp-modsecurity-core-rule-set] anomaly score not calculated ?">RBarnett at trustwave.com
       </A><BR>
    <I>Mon Mar 19 13:15:08 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="001038.html">[Owasp-modsecurity-core-rule-set] anomaly score not calculated ?
</A></li>
        <LI>Next message: <A HREF="001040.html">[Owasp-modsecurity-core-rule-set] anomaly score not calculated ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1039">[ date ]</a>
              <a href="thread.html#1039">[ thread ]</a>
              <a href="subject.html#1039">[ subject ]</a>
              <a href="author.html#1039">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Mark,

I would suggest that you use the latest CRS version as there are other
bugs that we have fixed.

Looking at the example audit log entry you provided, that message &quot;Host
header is a numeric IP address&quot; only results in a NOTICE level anomaly
score increase - setvar:tx.anomaly_score=+%{tx.notice_anomaly_score}

Here is the complete rule -

SecRule REQUEST_HEADERS:Host &quot;^[\d.:]+$&quot;
&quot;phase:2,rev:'2.0.10',t:none,block,msg:'Host header is a numeric IP
address',
severity:'2',id:'960017',tag:'PROTOCOL_VIOLATION/IP_HOST',tag:'WASCTC/WASC-
21',tag:'OWASP_TOP_10/A7',tag:'PCI/6.5.10',tag:'<A HREF="http://technet.microsoft.co">http://technet.microsoft.co</A>
m/en-us/magazine/2005.01.hackerbasher.aspx',setvar:'tx.msg=%{rule.msg}',set
var:tx.anomaly_score=+%{tx.notice_anomaly_score},setvar:tx.policy_score=+%{
tx.notice_anomaly_score},setvar:tx.%{rule.id}-POLICY/IP_HOST-%{matched_var_
name}=%{matched_var}'&quot;

So, when this transaction gets to the 40 Inbound Blocking file this
ruleset is processed -

# Alert and Block based on Anomaly Scores
#
SecRule TX:ANOMALY_SCORE &quot;@gt 0&quot; \
    &quot;chain,phase:2,t:none,deny,log,msg:'Inbound Anomaly Score Exceeded
(Total Score: %{TX.ANOMALY_SCORE}, SQLi=%{TX.SQL_INJECTION_SCORE},
XSS=%{TX.XSS_SCORE}): Last Matched Message: %{tx.msg}',logdata:'Last
Matched Data:
%{matched_var}',setvar:tx.inbound_tx_msg=%{tx.msg},setvar:tx.inbound_anomal
y_score=%{tx.anomaly_score}&quot;
  SecRule TX:ANOMALY_SCORE &quot;@ge %{tx.inbound_anomaly_score_level}&quot; chain
    SecRule TX:ANOMALY_SCORE_BLOCKING &quot;@streq on&quot; chain
      SecRule TX:/^\d/ &quot;(.*)&quot;


Section K of your audit log shows that the first SecRule matches -

SecRule &quot;TX:ANOMALY_SCORE&quot; &quot;@gt 0&quot;
&quot;phase:2,chain,t:none,deny,log,msg:'Inbound Anomaly Score Exceeded (Total
Score: %{TX.ANOMALY_SCORE}, SQLi=%{TX.SQL_INJECTION_SCORE},
XSS=%{TX.XSS_SCORE}): Last Matched Message: %{tx.msg}',logdata:'Last
Matched
Data:
%{matched_var}',setvar:tx.inbound_tx_msg=%{tx.msg},setvar:tx.inbound_anomal
y
_score=%{tx.anomaly_score}&quot;


But, then it gets to the second SecRule that checks that the anomaly score
if @ge your tx.inbound_anomaly_score_level, it doesn't match.  This is
because the only 1 rule with the NOTICE level matched.  The bottom line is
that this transaction's anomaly score was below your blocking threshold.

Hope this helps,
Ryan



On 3/19/12 8:16 AM, &quot;Mark Boos (IntCom)&quot; &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">mark at intcom.nl</A>&gt; wrote:

&gt;<i>Hi,
</I>&gt;<i>
</I>&gt;<i>An introduction: I use ModSecurity for 5 weeks now, on a relatively quiet
</I>&gt;<i>internet server. I am not a very experienced ModSecurity user, but the
</I>&gt;<i>traditional score installation worked just fine. I hope you forgive me my
</I>&gt;<i>shortcomings in knowledge.
</I>&gt;<i>
</I>&gt;<i>I have a problem with the anomaly method: there are warnings and critical
</I>&gt;<i>errors in the log files, but it seems no action is being taken after the
</I>&gt;<i>maximum score (5) is exceeded.
</I>&gt;<i>
</I>&gt;<i>Installation:
</I>&gt;<i>- Debian stable with apache 2.2.16
</I>&gt;<i>- libapache-mod-security 2.5.12-1
</I>&gt;<i>- crs_2.0.10 rule files (downloaded because the latest and greatest
</I>&gt;<i>crs_2.2.3 didnt work either)
</I>&gt;<i>*modsecurity_crs_20_protocol_violations.conf
</I>&gt;<i>*modsecurity_crs_21_protocol_anomalies.conf
</I>&gt;<i>*modsecurity_crs_23_request_limits.conf
</I>&gt;<i>*modsecurity_crs_35_bad_robots.conf
</I>&gt;<i>*modsecurity_crs_40_generic_attacks.conf
</I>&gt;<i>*modsecurity_crs_45_trojans.conf
</I>&gt;<i>*modsecurity_crs_49_inbound_blocking.conf
</I>&gt;<i>*modsecurity_crs_59_outbound_blocking.conf
</I>&gt;<i>*modsecurity_crs_60_correlation.conf
</I>&gt;<i>- latest slr
</I>&gt;<i>*modsecurity_slr_10_ip_reputation.conf
</I>&gt;<i>*modsecurity_slr_46_joomla_attacks.conf
</I>&gt;<i>
</I>&gt;<i>In modsecurity_crs_10_config.conf the anomaly configuration:
</I>&gt;<i>----------------------------------------------------------------------
</I>&gt;<i>SecDefaultAction &quot;phase:2,pass,log&quot;
</I>&gt;<i>
</I>&gt;<i>SecAction &quot;phase:1,t:none,nolog,pass, \
</I>&gt;<i>setvar:tx.critical_anomaly_score=5, \
</I>&gt;<i>setvar:tx.error_anomaly_score=4, \
</I>&gt;<i>setvar:tx.warning_anomaly_score=3, \
</I>&gt;<i>setvar:tx.notice_anomaly_score=2&quot;
</I>&gt;<i>
</I>&gt;<i>SecAction
</I>&gt;<i>&quot;phase:1,t:none,nolog,pass,setvar:tx.inbound_anomaly_score_level=5&quot;
</I>&gt;<i>SecAction
</I>&gt;<i>&quot;phase:1,t:none,nolog,pass,setvar:tx.outbound_anomaly_score_level=4&quot;
</I>&gt;<i>
</I>&gt;<i>SecAction &quot;phase:1,t:none,nolog,pass,setvar:tx.anomaly_score_blocking=on&quot;
</I>&gt;<i>----------------------------------------------------------------------
</I>&gt;<i>
</I>&gt;<i>This results in mod-security audit log for example:
</I>&gt;<i>----------------------------------------------------------------------
</I>&gt;<i>--f3f66479-A--
</I>&gt;<i>[15/Mar/2012:13:08:09 +0100] T2HbqX8AAAEAAEXDCtoAAAAG 93.94.***.** 43988
</I>&gt;<i>95.142.***.** 80
</I>&gt;<i>--f3f66479-B--
</I>&gt;<i>GET /translators.html HTTP/1.1
</I>&gt;<i>TE: deflate,gzip;q=0.3
</I>&gt;<i>Keep-Alive: 300
</I>&gt;<i>Connection: Keep-Alive, TE
</I>&gt;<i>Host: 95.142.165.25
</I>&gt;<i>User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; MSIE 5.5; Windows NT 5.1)
</I>&gt;<i>Opera 7.01 [en]
</I>&gt;<i>
</I>&gt;<i>--f3f66479-F--
</I>&gt;<i>HTTP/1.1 404 Not Found
</I>&gt;<i>Vary: Accept-Encoding
</I>&gt;<i>Content-Length: 214
</I>&gt;<i>Keep-Alive: timeout=15, max=100
</I>&gt;<i>Connection: Keep-Alive
</I>&gt;<i>Content-Type: text/html; charset=iso-8859-1
</I>&gt;<i>
</I>&gt;<i>--f3f66479-H--
</I>&gt;<i>Message: Warning. Pattern match &quot;^[\d.:]+$&quot; at REQUEST_HEADERS:Host. [file
</I>&gt;<i>&quot;/etc/apache2/mod-security/activated_rules/modsecurity_crs_21_protocol_ano
</I>&gt;<i>ma
</I>&gt;<i>lies.conf&quot;] [line &quot;97&quot;] [id &quot;960017&quot;] [rev &quot;2.0.10&quot;] [msg &quot;Host header is
</I>&gt;<i>a
</I>&gt;<i>numeric IP address&quot;] [severity &quot;CRITICAL&quot;] [tag
</I>&gt;<i>&quot;PROTOCOL_VIOLATION/IP_HOST&quot;] [tag &quot;WASCTC/WASC-21&quot;] [tag
</I>&gt;<i>&quot;OWASP_TOP_10/A7&quot;]
</I>&gt;<i>[tag &quot;PCI/6.5.10&quot;] [tag
</I>&gt;<i>&quot;<A HREF="http://technet.microsoft.com/en-us/magazine/2005.01.hackerbasher.aspx">http://technet.microsoft.com/en-us/magazine/2005.01.hackerbasher.aspx</A>&quot;]
</I>&gt;<i>Apache-Error: [file &quot;/tmp/buildd/apache2-2.2.16/server/core.c&quot;] [line
</I>&gt;<i>3648]
</I>&gt;<i>[level 3] File does not exist:
</I>&gt;<i>/var/www/vhosts/intcom.nl/httpdocs/translators.html
</I>&gt;<i>Stopwatch: 1331813289736227 5847 (554 5505 -)
</I>&gt;<i>Producer: ModSecurity for Apache/2.5.12 (<A HREF="http://www.modsecurity.org/">http://www.modsecurity.org/</A>);
</I>&gt;<i>core
</I>&gt;<i>ruleset/2.0.10.
</I>&gt;<i>Server: Apache/2.2.16 (Debian) PHP/5.3.3-7+squeeze8 with Suhosin-Patch
</I>&gt;<i>mod_ssl/2.2.16 OpenSSL/0.9.8o
</I>&gt;<i>
</I>&gt;<i>--f3f66479-K--
</I>&gt;<i>SecAction
</I>&gt;<i>&quot;phase:1,t:none,nolog,pass,setvar:tx.critical_anomaly_score=5,setvar:tx.er
</I>&gt;<i>ro
</I>&gt;<i>r_anomaly_score=4,setvar:tx.warning_anomaly_score=3,setvar:tx.notice_anoma
</I>&gt;<i>ly
</I>&gt;<i>_score=2&quot;
</I>&gt;<i>SecAction
</I>&gt;<i>&quot;phase:1,t:none,nolog,pass,setvar:tx.inbound_anomaly_score_level=5&quot;
</I>&gt;<i>SecAction
</I>&gt;<i>&quot;phase:1,t:none,nolog,pass,setvar:tx.outbound_anomaly_score_level=4&quot;
</I>&gt;<i>SecAction &quot;phase:1,t:none,nolog,pass,setvar:tx.anomaly_score_blocking=on&quot;
</I>&gt;<i>SecRule &quot;REQUEST_METHOD&quot; &quot;@rx ^(?:GET|HEAD)$&quot;
</I>&gt;<i>&quot;phase:1,log,chain,rev:2.0.10,t:none,block,msg:'GET or HEAD requests with
</I>&gt;<i>bodies',severity:2,id:960011,tag:PROTOCOL_VIOLATION/EVASION,tag:WASCTC/WAS
</I>&gt;<i>C-
</I>&gt;<i>21,tag:OWASP_TOP_10/A7,tag:PCI/6.5.10,tag:<A HREF="http://www.w3.org/Protocols/rfc2">http://www.w3.org/Protocols/rfc2</A>
</I>&gt;<i>61
</I>&gt;<i>6/rfc2616-sec4.html#sec4.3&quot;
</I>&gt;<i>SecRule &quot;REMOTE_ADDR&quot; &quot;@rx .*&quot;
</I>&gt;<i>&quot;phase:1,chain,t:none,log,block,id:2200000,msg:'SLR: Client IP in
</I>&gt;<i>Blacklist.',tag:AUTOMATION/MALICIOUS,setvar:tx.ip_blacklist=/%{matched_var
</I>&gt;<i>}/
</I>&gt;<i>&quot;
</I>&gt;<i>SecRule &quot;REQUEST_METHOD&quot; &quot;!@rx ^OPTIONS$&quot;
</I>&gt;<i>&quot;phase:2,log,chain,rev:2.0.10,t:none,block,msg:'Request Missing an Accept
</I>&gt;<i>Header',severity:2,id:960015,tag:PROTOCOL_VIOLATION/MISSING_HEADER_ACCEPT,
</I>&gt;<i>ta
</I>&gt;<i>g:WASCTC/WASC-21,tag:OWASP_TOP_10/A7,tag:PCI/6.5.10&quot;
</I>&gt;<i>SecRule &quot;&amp;REQUEST_HEADERS:Content-Type&quot; &quot;@eq 0&quot;
</I>&gt;<i>&quot;phase:2,log,chain,rev:2.0.10,t:none,block,msg:'Request Containing
</I>&gt;<i>Content,
</I>&gt;<i>but Missing Content-Type header',id:960904,severity:5&quot;
</I>&gt;<i>SecRule &quot;REQUEST_HEADERS:Host&quot; &quot;@rx ^[\\d.:]+$&quot;
</I>&gt;<i>&quot;phase:2,log,rev:2.0.10,t:none,block,msg:'Host header is a numeric IP
</I>&gt;<i>address',severity:2,id:960017,tag:PROTOCOL_VIOLATION/IP_HOST,tag:WASCTC/WA
</I>&gt;<i>SC
</I>&gt;<i>-21,tag:OWASP_TOP_10/A7,tag:PCI/6.5.10,tag:<A HREF="http://technet.microsoft.com/en">http://technet.microsoft.com/en</A>
</I>&gt;<i>-u
</I>&gt;<i>s/magazine/2005.01.hackerbasher.aspx,setvar:tx.msg=%{rule.msg},setvar:tx.a
</I>&gt;<i>no
</I>&gt;<i>maly_score=+%{tx.notice_anomaly_score},setvar:tx.policy_score=+%{tx.notice
</I>&gt;<i>_a
</I>&gt;<i>nomaly_score},setvar:tx.%{rule.id}-POLICY/IP_HOST-%{matched_var_name}=%{ma
</I>&gt;<i>tc
</I>&gt;<i>hed_var}'&quot;
</I>&gt;<i>SecRule &quot;TX:ANOMALY_SCORE&quot; &quot;@gt 0&quot;
</I>&gt;<i>&quot;phase:2,chain,t:none,deny,log,msg:'Inbound Anomaly Score Exceeded (Total
</I>&gt;<i>Score: %{TX.ANOMALY_SCORE}, SQLi=%{TX.SQL_INJECTION_SCORE},
</I>&gt;<i>XSS=%{TX.XSS_SCORE}): Last Matched Message: %{tx.msg}',logdata:'Last
</I>&gt;<i>Matched
</I>&gt;<i>Data:
</I>&gt;<i>%{matched_var}',setvar:tx.inbound_tx_msg=%{tx.msg},setvar:tx.inbound_anoma
</I>&gt;<i>ly
</I>&gt;<i>_score=%{tx.anomaly_score}&quot;
</I>&gt;<i>SecRule &quot;TX:INBOUND_ANOMALY_SCORE&quot; &quot;@gt 0&quot;
</I>&gt;<i>&quot;phase:5,chain,t:none,log,noauditlog,skipAfter:END_CORRELATION,msg:'Inboun
</I>&gt;<i>d
</I>&gt;<i>Anomaly Score (Total Inbound Score: %{TX.INBOUND_ANOMALY_SCORE},
</I>&gt;<i>SQLi=%{TX.SQL_INJECTION_SCORE}, XSS=%{TX.XSS_SCORE}):
</I>&gt;<i>%{tx.inbound_tx_msg}'&quot;
</I>&gt;<i>
</I>&gt;<i>--f3f66479-Z--
</I>&gt;<i>
</I>&gt;<i>----------------------------------------------------------------------
</I>&gt;<i>
</I>&gt;<i>It looks like the variables aren't being filled ?
</I>&gt;<i>
</I>&gt;<i>Thank you for your time.
</I>&gt;<i>
</I>&gt;<i>Regards
</I>&gt;<i>Mark
</I>&gt;<i>
</I>&gt;<i>_______________________________________________
</I>&gt;<i>Owasp-modsecurity-core-rule-set mailing list
</I>&gt;<i><A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">Owasp-modsecurity-core-rule-set at lists.owasp.org</A>
</I>&gt;<i><A HREF="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set</A>
</I>&gt;<i>
</I>

This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001038.html">[Owasp-modsecurity-core-rule-set] anomaly score not calculated ?
</A></li>
	<LI>Next message: <A HREF="001040.html">[Owasp-modsecurity-core-rule-set] anomaly score not calculated ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1039">[ date ]</a>
              <a href="thread.html#1039">[ thread ]</a>
              <a href="subject.html#1039">[ subject ]</a>
              <a href="author.html#1039">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set">More information about the Owasp-modsecurity-core-rule-set
mailing list</a><br>
</body></html>
