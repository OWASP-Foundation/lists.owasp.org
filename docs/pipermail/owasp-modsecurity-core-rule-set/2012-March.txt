From gagandeepsohi at gmail.com  Thu Mar  1 17:15:36 2012
From: gagandeepsohi at gmail.com (Gagandeep Singh)
Date: Thu, 1 Mar 2012 17:15:36 +0000
Subject: [Owasp-modsecurity-core-rule-set] Mod security is not detecting
	double header's
In-Reply-To: <CA+VXBus=R68b4j1iqje6VFPi8atiOGG3F05pjXqLQ2BC7x9Rgw@mail.gmail.com>
References: <CA+VXBuvWVWg4sXdWZE3bedW3tgKhigizmqD6HQM1_HtvscV9Kw@mail.gmail.com>
	<CB74FB35.44BBF%rbarnett@trustwave.com>
	<CA+VXBus=R68b4j1iqje6VFPi8atiOGG3F05pjXqLQ2BC7x9Rgw@mail.gmail.com>
Message-ID: <CA+VXBuur0YH80_-DxEE=VWy_RUbhWA2VMpLj7fE-KnANZP34-Q@mail.gmail.com>

Hi

We have configured modsecurity apache_2.6.3 and its working fine for most
of the cases but we have identified a special attack which is causing a
double header injection to the site.

Example :-
 https://www.XYZ.com/%0d%0aLocation:http://www.google.com<https://www.xyz.com/%0d%0aLocation:http://www.google.com>
 Note - XYZ is any site.

This generates a Duplicate headers error page which is shown below-

Duplicate headers received from the server
>


> The response from the server contained duplicate headers. This problem is
> generally the result of a misconfigured website or proxy. Only the website
> or proxy administrator can fix this issue.
>


>  Error 350 (net::ERR_RESPONSE_HEADERS_MULTIPLE_LOCATION): Multiple
> Location headers received. This is disallowed to protect against HTTP
> response-splitting attacks.



As per the discussion with Bren we came to know that this will be fixed in
CRS 2.2.4 but we need this urgently, Is it possible to get the rule for
above issue so we can apply the patch for the time being and will apply
2.2.4 soon as it becomes available.

Could you please also assist on this, what configuration changes are
required to handle this?

Regards
Gagandeep Singh  Sohi
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120301/c7328cde/attachment.html>

From ryan.barnett at owasp.org  Thu Mar  1 17:25:25 2012
From: ryan.barnett at owasp.org (Ryan Barnett)
Date: Thu, 01 Mar 2012 12:25:25 -0500
Subject: [Owasp-modsecurity-core-rule-set] Mod security is not detecting
 double header's
In-Reply-To: <CA+VXBuur0YH80_-DxEE=VWy_RUbhWA2VMpLj7fE-KnANZP34-Q@mail.gmail.com>
Message-ID: <CB751AF2.44BE1%ryan.barnett@owasp.org>

I have pushed CRS v2.2.4 out to SVN and you can access the updated rule file
here -
http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/base_r
ules/modsecurity_crs_40_generic_attacks.conf?revision=1900

Here is the updated rule -
SecRule 
REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_FILENAME|ARGS_NAMES|ARGS|XML:/
* "[\n\r](?:content-(type|length)|set-cookie|location):" \
        
"phase:2,rev:'2.2.4',t:none,t:lowercase,capture,ctl:auditLogParts=+E,block,m
sg:'HTTP Response Splitting
Attack',id:'950910',logdata:'%{TX.0}',severity:'2',setvar:'tx.msg=%{rule.msg
}',setvar:tx.anomaly_score=+%{tx.critical_anomaly_score},setvar:tx.response_
splitting_score=+%{tx.critical_anomaly_score},setvar:tx.%{rule.id}-WEB_ATTAC
K/RESPONSE_SPLITTING-%{matched_var_name}=%{tx.0}"
-Ryan

From:  Gagandeep Singh <gagandeepsohi at gmail.com>
Date:  Thu, 1 Mar 2012 17:15:36 +0000
To:  <owasp-modsecurity-core-rule-set at lists.owasp.org>
Subject:  [Owasp-modsecurity-core-rule-set] Mod security is not detecting
double header's

> Hi 
> 
> We have configured modsecurity apache_2.6.3 and its working fine for most of
> the cases but we have identified a special attack which is causing a double
> header injection to the site.
> 
> Example :-
>  https://www.XYZ.com/%0d%0aLocation:http://www.google.com
>  Note - XYZ is any site.
> 
> This generates a Duplicate headers error page which is shown below-
> 
>>> Duplicate headers received from the server
>>  
>>> The response from the server contained duplicate headers. This problem is
>>> generally the result of a misconfigured website or proxy. Only the website
>>> or proxy administrator can fix this issue.
>>  
>>>  Error 350 (net::ERR_RESPONSE_HEADERS_MULTIPLE_LOCATION): Multiple Location
>>> headers received. This is disallowed to protect against HTTP
>>> response-splitting attacks.
> 
> 
> As per the discussion with Bren we came to know that this will be fixed in CRS
> 2.2.4 but we need this urgently, Is it possible to get the rule for above
> issue so we can apply the patch for the time being and will apply 2.2.4 soon
> as it becomes available.
> 
> Could you please also assist on this, what configuration changes are required
> to handle this?
> 
> Regards
> Gagandeep Singh  Sohi
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set


-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120301/1dca5858/attachment.html>

From RBarnett at trustwave.com  Thu Mar  1 17:57:25 2012
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Thu, 1 Mar 2012 11:57:25 -0600
Subject: [Owasp-modsecurity-core-rule-set] [Rule Update - Discussion Thread]
	IP Reputation
Message-ID: <CB7522B5.44C15%rbarnett@trustwave.com>

The first bit of data that we have about the client is their IP address (either directly or through X-Forwarded-For headers).  Before processing any actual HTTP data, we should apply some IP Reputation Checks.  I am thinking of adding in a template rules file that will be executed before the normal modsecurity_crs_20_protocol_violations.conf file.  This file will hold the various @rbl checks and the user can select which remote RBL they want to query.

We do have 1 @rbl check in the optional_rules/modsecurity_crs_42_comment_spam.conf file but I believe that this should be expanded to query other public RBLs for web-attacker traffic.

###############################
SecRule IP:PREVIOUS_RBL_CHECK "@eq 1" "phase:1,id:'981137',t:none,pass,nolog,skipAfter:END_RBL_LOOKUP"
  SecRule REMOTE_ADDR "@rbl sbl-xbl.spamhaus.org" "phase:1,id:'981138',t:none,pass,nolog,auditlog,msg:'RBL Match for SPAM Source',tag:'AUTOMATION/MALICIOUS',severity:'2',setvar:'tx.msg=%{rule.msg}',setvar:tx.automation_score=+%{tx.warning_anomaly_score},setvar:tx.anomaly_score=+%{tx.warning_anomaly_score},setvar:tx.%{rule.id}-AUTOMATION/MALICIOUS-%{matched_var_name}=%{matched_var},setvar:ip.spammer=1,expirevar:ip.spammer=86400,setvar:ip.previous_rbl_check=1,expirevar:ip.previous_rbl_check=86400,skipAfter:END_RBL_CHECK"

  SecAction "phase:1,id:'981139',t:none,nolog,pass,setvar:ip.previous_rbl_check=1,expirevar:ip.previous_rbl_check=86400"
SecMarker END_RBL_LOOKUP
###############################

These rules will query one of the spamhaus RBLs and it will then save the results in the IP persistent storage so it only does an actual DNS lookup once/day to help reduce any perf  hit.

How many people are currently using @rbl checks with ModSecurity?
Would you be interested in using it if this feature was added to the CRS?

Let me know what you think.

--
Ryan Barnett
Trustwave SpiderLabs
ModSecurity Project Leader
OWASP ModSecurity CRS Project Leader

________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120301/26025b93/attachment-0001.html>

From gagandeepsohi at gmail.com  Thu Mar  1 18:03:47 2012
From: gagandeepsohi at gmail.com (Gagandeep Singh)
Date: Thu, 1 Mar 2012 18:03:47 +0000
Subject: [Owasp-modsecurity-core-rule-set] Mod security is not detecting
 double header's
In-Reply-To: <CB751AF2.44BE1%ryan.barnett@owasp.org>
References: <CA+VXBuur0YH80_-DxEE=VWy_RUbhWA2VMpLj7fE-KnANZP34-Q@mail.gmail.com>
	<CB751AF2.44BE1%ryan.barnett@owasp.org>
Message-ID: <CA+VXBuvEUsSXsR5oHjX1JCyN+r2gMk+UUD1y-Zy+oBugD-tMXA@mail.gmail.com>

Thanks Ryan for your help,

FURTHER ISSUE-  its working for HTTP and we got the below response. Our
issue is with  HTTPS  as well, this rule is not working for https. Our
client has raised a concern for HTTPS. Could you please advise what we can
do to enable this for HTTPS as well.


Message: Warning. Pattern match
"[\n\r](?:content-(type|length)|set-cookie|location):" at REQUEST_FILENAME.
[file "/etc/httpd/modsecurity.d/modsecurity_localrules.conf"] [line "4"]
[id "950910"] [rev "2.2.4"] [msg "HTTP Response Splitting Attack"] [data
"\x0alocation:"] [severity "ALERT"]
Message: Warning. Pattern match
"[\n\r](?:content-(type|length)|set-cookie|location):" at REQUEST_FILENAME.
[file
"/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_40_generic_attacks.conf"]
[line "139"] [id "950910"] [rev "2.2.4"] [msg "HTTP Response Splitting
Attack"] [data "\x0alocation:"] [severity "CRITICAL"]
Message: Access denied with code 403 (phase 2). [file
"/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_49_enforcement.conf"]
[line "25"] [msg "Anomaly Score Exceeded (score 40): HTTP Response
Splitting Attack"]
Action: Intercepted (phase 2)
Apache-Handler: jakarta-servlet
Stopwatch: 1330624314422822 1653262 (1471 1258692 -)
Producer: ModSecurity for Apache/2.5.12 (http://www.modsecurity.org/); core
ruleset/2.0.5.






On Thu, Mar 1, 2012 at 5:25 PM, Ryan Barnett <ryan.barnett at owasp.org> wrote:

> I have pushed CRS v2.2.4 out to SVN and you can access the updated rule
> file here -
>
> http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/base_rules/modsecurity_crs_40_generic_attacks.conf?revision=1900
>
> Here is the updated rule -
>
> SecRule REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_FILENAME|ARGS_NAMES|ARGS|XML:/* "[\n\r](?:content-(type|length)|set-cookie|location):" \
>         "phase:2,rev:'2.2.4',t:none,t:lowercase,capture,ctl:auditLogParts=+E,block,msg:'HTTP Response Splitting Attack',id:'950910',logdata:'%{TX.0}',severity:'2',setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.critical_anomaly_score},setvar:tx.response_splitting_score=+%{tx.critical_anomaly_score},setvar:tx.%{rule.id}-WEB_ATTACK/RESPONSE_SPLITTING-%{matched_var_name}=%{tx.0}"
>
> -Ryan
>
> From: Gagandeep Singh <gagandeepsohi at gmail.com>
> Date: Thu, 1 Mar 2012 17:15:36 +0000
> To: <owasp-modsecurity-core-rule-set at lists.owasp.org>
> Subject: [Owasp-modsecurity-core-rule-set] Mod security is not detecting
> double header's
>
> Hi
>
> We have configured modsecurity apache_2.6.3 and its working fine for most
> of the cases but we have identified a special attack which is causing a
> double header injection to the site.
>
> Example :-
>  https://www.XYZ.com/%0d%0aLocation:http://www.google.com<https://www.xyz.com/%0d%0aLocation:http://www.google.com>
>  Note - XYZ is any site.
>
> This generates a Duplicate headers error page which is shown below-
>
> Duplicate headers received from the server
>>
>
>
>> The response from the server contained duplicate headers. This problem is
>> generally the result of a misconfigured website or proxy. Only the website
>> or proxy administrator can fix this issue.
>>
>
>
>>  Error 350 (net::ERR_RESPONSE_HEADERS_MULTIPLE_LOCATION): Multiple
>> Location headers received. This is disallowed to protect against HTTP
>> response-splitting attacks.
>
>
>
> As per the discussion with Bren we came to know that this will be fixed in
> CRS 2.2.4 but we need this urgently, Is it possible to get the rule for
> above issue so we can apply the patch for the time being and will apply
> 2.2.4 soon as it becomes available.
>
> Could you please also assist on this, what configuration changes are
> required to handle this?
>
> Regards
> Gagandeep Singh  Sohi
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>
>


-- 
*Regards,
**Gagandeep Singh Sohi*
*9717920072*
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120301/61ca2f98/attachment.html>

From RBarnett at trustwave.com  Thu Mar  1 18:40:23 2012
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Thu, 1 Mar 2012 12:40:23 -0600
Subject: [Owasp-modsecurity-core-rule-set] Mod security is not detecting
 double header's
In-Reply-To: <CA+VXBuvEUsSXsR5oHjX1JCyN+r2gMk+UUD1y-Zy+oBugD-tMXA@mail.gmail.com>
Message-ID: <CB752C40.44C23%ryan.barnett@owasp.org>

How do you have the CRS conf files activated in Apache for the port 80 server?  If you are using Apache Includes, then you should include them also within your HTTPS/443 vhost container.

The other option is, if you want to run the CRS for all HTTP and HTTPS sites, is to specify the Apache Include directives in the core directives location instead of further down within specific vhost containers.  This will propagate to all vhosts.

--
Ryan Barnett
Trustwave SpiderLabs
ModSecurity Project Leader
OWASP ModSecurity CRS Project Leader

From: Gagandeep Singh <gagandeepsohi at gmail.com<mailto:gagandeepsohi at gmail.com>>
Date: Thu, 1 Mar 2012 18:03:47 +0000
To: <owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>>, Ryan Barnett <ryan.barnett at owasp.org<mailto:ryan.barnett at owasp.org>>
Subject: Re: [Owasp-modsecurity-core-rule-set] Mod security is not detecting double header's

Thanks Ryan for your help,

FURTHER ISSUE-  its working for HTTP and we got the below response. Our issue is with  HTTPS  as well, this rule is not working for https. Our client has raised a concern for HTTPS. Could you please advise what we can do to enable this for HTTPS as well.


Message: Warning. Pattern match "[\n\r](?:content-(type|length)|set-cookie|location):" at REQUEST_FILENAME. [file "/etc/httpd/modsecurity.d/modsecurity_localrules.conf"] [line "4"] [id "950910"] [rev "2.2.4"] [msg "HTTP Response Splitting Attack"] [data "\x0alocation:"] [severity "ALERT"]
Message: Warning. Pattern match "[\n\r](?:content-(type|length)|set-cookie|location):" at REQUEST_FILENAME. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_40_generic_attacks.conf"] [line "139"] [id "950910"] [rev "2.2.4"] [msg "HTTP Response Splitting Attack"] [data "\x0alocation:"] [severity "CRITICAL"]
Message: Access denied with code 403 (phase 2). [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_49_enforcement.conf"] [line "25"] [msg "Anomaly Score Exceeded (score 40): HTTP Response Splitting Attack"]
Action: Intercepted (phase 2)
Apache-Handler: jakarta-servlet
Stopwatch: 1330624314422822 1653262 (1471 1258692 -)
Producer: ModSecurity for Apache/2.5.12 (http://www.modsecurity.org/); core ruleset/2.0.5.<http://2.0.5.>






On Thu, Mar 1, 2012 at 5:25 PM, Ryan Barnett <ryan.barnett at owasp.org<mailto:ryan.barnett at owasp.org>> wrote:
I have pushed CRS v2.2.4 out to SVN and you can access the updated rule file here -
http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/base_rules/modsecurity_crs_40_generic_attacks.conf?revision=1900

Here is the updated rule -

SecRule REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_FILENAME|ARGS_NAMES|ARGS|XML:/* "[\n\r](?:content-(type|length)|set-cookie|location):" \
        "phase:2,rev:'2.2.4',t:none,t:lowercase,capture,ctl:auditLogParts=+E,block,msg:'HTTP Response Splitting Attack',id:'950910',logdata:'%{TX.0}',severity:'2',setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.critical_anomaly_score},setvar:tx.response_splitting_score=+%{tx.critical_anomaly_score},setvar:tx.%{rule.id<http://rule.id>}-WEB_ATTACK/RESPONSE_SPLITTING-%{matched_var_name}=%{tx.0}"

-Ryan

From: Gagandeep Singh <gagandeepsohi at gmail.com<mailto:gagandeepsohi at gmail.com>>
Date: Thu, 1 Mar 2012 17:15:36 +0000
To: <owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>>
Subject: [Owasp-modsecurity-core-rule-set] Mod security is not detecting double header's

Hi

We have configured modsecurity apache_2.6.3 and its working fine for most of the cases but we have identified a special attack which is causing a double header injection to the site.

Example :-
 https://www.XYZ.com/%0d%0aLocation:http://www.google.com<https://www.xyz.com/%0d%0aLocation:http://www.google.com>
 Note - XYZ is any site.

This generates a Duplicate headers error page which is shown below-

Duplicate headers received from the server

The response from the server contained duplicate headers. This problem is generally the result of a misconfigured website or proxy. Only the website or proxy administrator can fix this issue.

 Error 350 (net::ERR_RESPONSE_HEADERS_MULTIPLE_LOCATION): Multiple Location headers received. This is disallowed to protect against HTTP response-splitting attacks.


As per the discussion with Bren we came to know that this will be fixed in CRS 2.2.4 but we need this urgently, Is it possible to get the rule for above issue so we can apply the patch for the time being and will apply 2.2.4 soon as it becomes available.

Could you please also assist on this, what configuration changes are required to handle this?

Regards
Gagandeep Singh  Sohi
_______________________________________________ Owasp-modsecurity-core-rule-set mailing list Owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:Owasp-modsecurity-core-rule-set at lists.owasp.org>https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set



--
Regards,
Gagandeep Singh Sohi
9717920072


________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120301/4891aa1e/attachment-0001.html>

From RBarnett at trustwave.com  Fri Mar  2 02:23:04 2012
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Thu, 1 Mar 2012 20:23:04 -0600
Subject: [Owasp-modsecurity-core-rule-set] IP White-list Best Practice
In-Reply-To: <CAOXGsbKN6ma-g-F2RgE8yPU1QuaSEDvwm+ZZ6976FULrTbCLdQ@mail.gmail.com>
References: <CAOXGsbKN6ma-g-F2RgE8yPU1QuaSEDvwm+ZZ6976FULrTbCLdQ@mail.gmail.com>
Message-ID: <D736DB68-57C7-4389-996E-D6A8EFA48E3C@trustwave.com>

The 1st option doen't do what you think.  The pass action only applies to the current rule.  You would want to use allow instead.  I prefer the 2nd option as it will work even if the SecRuleEngine is DetectionOnly (whereas the allow action would not execute).

Ryan

On Feb 29, 2012, at 1:28 PM, Matt Thomas <matt at betweenbrain.com<mailto:matt at betweenbrain.com>> wrote:

Hi Folks,

I was wondering what the best method for white-listing an IP is? In this case, I need to allow PayPal's IPN to be exempt.

At http://permalink.gmane.org/gmane.comp.apache.mod-security.user/8735 I see a couple of methods mentioned:

SecRule REMOTE_ADDR "@streq 127.0.0.1" "phase:1,t:none,nolog,pass"
SecRule REMOTE_ADDE "@streq 192.168.10.1" "phase:1,ctl:ruleEngine=Off,msg:'Turning off rule-engine for IP %{REMOTE_ADDR}'"

Is using "pass" better than "ctl:ruleEngine=Off". I also see "allow" being used at http://serversitters.com/mod-security-whitelist-ip.html

Thanks!

Best,

Matt Thomas
Founder betweenbrain<http://betweenbrain.com/>?
Lead Developer Construct Template Development Framework<http://construct-framework.com/>
Phone: 203.632.9322
Twitter: @betweenbrain
Github: https://github.com/betweenbrain

_______________________________________________
Owasp-modsecurity-core-rule-set mailing list
Owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:Owasp-modsecurity-core-rule-set at lists.owasp.org>
https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set

________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120301/dda7923f/attachment.html>

From gagandeepsohi at gmail.com  Fri Mar  2 11:53:15 2012
From: gagandeepsohi at gmail.com (Gagandeep Singh)
Date: Fri, 2 Mar 2012 11:53:15 +0000
Subject: [Owasp-modsecurity-core-rule-set] Mod security is not detecting
 double header's
In-Reply-To: <CB752C40.44C23%ryan.barnett@owasp.org>
References: <CA+VXBuvEUsSXsR5oHjX1JCyN+r2gMk+UUD1y-Zy+oBugD-tMXA@mail.gmail.com>
	<CB752C40.44C23%ryan.barnett@owasp.org>
Message-ID: <CA+VXBuuU5b5v8otd=DE=6xQdSGYcsOTm_DdbY=nWkhtUMOpvAw@mail.gmail.com>

We have validated that Apache Include directives is in the core directives.
When we are trying a* SQL injection* on HTTPS it detects the attack and
throws an exception.This means  mod-security and CRS is working for HTTPS
as well.

In case of double header this is not working for HTTPS. Do we need to make
any changes in rule set?

Regards
Gagandeep

On Thu, Mar 1, 2012 at 6:40 PM, Ryan Barnett <RBarnett at trustwave.com> wrote:

>  How do you have the CRS conf files activated in Apache for the port 80
> server?  If you are using Apache Includes, then you should include them
> also within your HTTPS/443 vhost container.
>
>  The other option is, if you want to run the CRS for all HTTP and HTTPS
> sites, is to specify the Apache Include directives in the core directives
> location instead of further down within specific vhost containers.  This
> will propagate to all vhosts.
>
>   --
> Ryan Barnett
> Trustwave SpiderLabs
> ModSecurity Project Leader
> OWASP ModSecurity CRS Project Leader
>
>   From: Gagandeep Singh <gagandeepsohi at gmail.com>
> Date: Thu, 1 Mar 2012 18:03:47 +0000
> To: <owasp-modsecurity-core-rule-set at lists.owasp.org>, Ryan Barnett <
> ryan.barnett at owasp.org>
> Subject: Re: [Owasp-modsecurity-core-rule-set] Mod security is not
> detecting double header's
>
>  Thanks Ryan for your help,
>
>  FURTHER ISSUE-  its working for HTTP and we got the below response. Our
> issue is with  HTTPS  as well, this rule is not working for https. Our
> client has raised a concern for HTTPS. Could you please advise what we can
> do to enable this for HTTPS as well.
>
>
>  Message: Warning. Pattern match
> "[\n\r](?:content-(type|length)|set-cookie|location):" at REQUEST_FILENAME.
> [file "/etc/httpd/modsecurity.d/modsecurity_localrules.conf"] [line "4"]
> [id "950910"] [rev "2.2.4"] [msg "HTTP Response Splitting Attack"] [data
> "\x0alocation:"] [severity "ALERT"]
> Message: Warning. Pattern match
> "[\n\r](?:content-(type|length)|set-cookie|location):" at REQUEST_FILENAME.
> [file
> "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_40_generic_attacks.conf"]
> [line "139"] [id "950910"] [rev "2.2.4"] [msg "HTTP Response Splitting
> Attack"] [data "\x0alocation:"] [severity "CRITICAL"]
> Message: Access denied with code 403 (phase 2). [file
> "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_49_enforcement.conf"]
> [line "25"] [msg "Anomaly Score Exceeded (score 40): HTTP Response
> Splitting Attack"]
> Action: Intercepted (phase 2)
> Apache-Handler: jakarta-servlet
> Stopwatch: 1330624314422822 1653262 (1471 1258692 -)
> Producer: ModSecurity for Apache/2.5.12 (http://www.modsecurity.org/);
> core ruleset/2.0.5.
>
>
>
>
>
>
> On Thu, Mar 1, 2012 at 5:25 PM, Ryan Barnett <ryan.barnett at owasp.org>wrote:
>
>>  I have pushed CRS v2.2.4 out to SVN and you can access the updated rule
>> file here -
>>
>> http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/base_rules/modsecurity_crs_40_generic_attacks.conf?revision=1900
>>
>>  Here is the updated rule -
>>
>> SecRule REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_FILENAME|ARGS_NAMES|ARGS|XML:/* "[\n\r](?:content-(type|length)|set-cookie|location):" \
>>         "phase:2,rev:'2.2.4',t:none,t:lowercase,capture,ctl:auditLogParts=+E,block,msg:'HTTP Response Splitting Attack',id:'950910',logdata:'%{TX.0}',severity:'2',setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.critical_anomaly_score},setvar:tx.response_splitting_score=+%{tx.critical_anomaly_score},setvar:tx.%{rule.id}-WEB_ATTACK/RESPONSE_SPLITTING-%{matched_var_name}=%{tx.0}"
>>
>>  -Ryan
>>
>>   From: Gagandeep Singh <gagandeepsohi at gmail.com>
>> Date: Thu, 1 Mar 2012 17:15:36 +0000
>> To: <owasp-modsecurity-core-rule-set at lists.owasp.org>
>> Subject: [Owasp-modsecurity-core-rule-set] Mod security is not detecting
>> double header's
>>
>>   Hi
>>
>>  We have configured modsecurity apache_2.6.3 and its working fine for
>> most of the cases but we have identified a special attack which is causing
>> a double header injection to the site.
>>
>> Example :-
>>  https://www.XYZ.com/%0d%0aLocation:http://www.google.com<https://www.xyz.com/%0d%0aLocation:http://www.google.com>
>>  Note - XYZ is any site.
>>
>>  This generates a Duplicate headers error page which is shown below-
>>
>>   Duplicate headers received from the server
>>>
>>
>>
>>> The response from the server contained duplicate headers. This problem
>>> is generally the result of a misconfigured website or proxy. Only the
>>> website or proxy administrator can fix this issue.
>>>
>>
>>
>>>  Error 350 (net::ERR_RESPONSE_HEADERS_MULTIPLE_LOCATION): Multiple
>>> Location headers received. This is disallowed to protect against HTTP
>>> response-splitting attacks.
>>
>>
>>
>>  As per the discussion with Bren we came to know that this will be fixed
>> in CRS 2.2.4 but we need this urgently, Is it possible to get the rule for
>> above issue so we can apply the patch for the time being and will apply
>> 2.2.4 soon as it becomes available.
>>
>>  Could you please also assist on this, what configuration changes are
>> required to handle this?
>>
>>  Regards
>> Gagandeep Singh  Sohi
>>  _______________________________________________
>> Owasp-modsecurity-core-rule-set mailing list
>> Owasp-modsecurity-core-rule-set at lists.owasp.org
>> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>>
>>
>
>
>  --
> *Regards,
> **Gagandeep Singh Sohi*
> *9717920072*
>
>
> ------------------------------
> This transmission may contain information that is privileged,
> confidential, and/or exempt from disclosure under applicable law. If you
> are not the intended recipient, you are hereby notified that any
> disclosure, copying, distribution, or use of the information contained
> herein (including any reliance thereon) is STRICTLY PROHIBITED. If you
> received this transmission in error, please immediately contact the sender
> and destroy the material in its entirety, whether in electronic or hard
> copy format.
>



-- 
*Regards,
**Gagandeep Singh Sohi*
*9717920072*
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120302/f16e0aed/attachment-0001.html>

From RBarnett at trustwave.com  Fri Mar  2 16:18:43 2012
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Fri, 2 Mar 2012 10:18:43 -0600
Subject: [Owasp-modsecurity-core-rule-set] Mod security is not detecting
 double header's
In-Reply-To: <CA+VXBuuU5b5v8otd=DE=6xQdSGYcsOTm_DdbY=nWkhtUMOpvAw@mail.gmail.com>
Message-ID: <CB765C91.44E2A%rbarnett@trustwave.com>

The rules work the same whether the port is 80 or 443.  There must be something else going.  I see you are using jakarta-servlet.  Perhaps this handler is working differently for HTTPS traffic.

--
Ryan Barnett
Trustwave SpiderLabs
ModSecurity Project Leader
OWASP ModSecurity CRS Project Leader

From: Gagandeep Singh <gagandeepsohi at gmail.com<mailto:gagandeepsohi at gmail.com>>
Date: Fri, 2 Mar 2012 05:53:15 -0600
To: Ryan Barnett <rbarnett at trustwave.com<mailto:rbarnett at trustwave.com>>, "owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>" <owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>>
Subject: Re: [Owasp-modsecurity-core-rule-set] Mod security is not detecting double header's

We have validated that Apache Include directives is in the core directives. When we are trying a SQL injection on HTTPS it detects the attack and throws an exception.This means  mod-security and CRS is working for HTTPS as well.

In case of double header this is not working for HTTPS. Do we need to make any changes in rule set?

Regards
Gagandeep

On Thu, Mar 1, 2012 at 6:40 PM, Ryan Barnett <RBarnett at trustwave.com<mailto:RBarnett at trustwave.com>> wrote:
How do you have the CRS conf files activated in Apache for the port 80 server?  If you are using Apache Includes, then you should include them also within your HTTPS/443 vhost container.

The other option is, if you want to run the CRS for all HTTP and HTTPS sites, is to specify the Apache Include directives in the core directives location instead of further down within specific vhost containers.  This will propagate to all vhosts.

--
Ryan Barnett
Trustwave SpiderLabs
ModSecurity Project Leader
OWASP ModSecurity CRS Project Leader

From: Gagandeep Singh <gagandeepsohi at gmail.com<mailto:gagandeepsohi at gmail.com>>
Date: Thu, 1 Mar 2012 18:03:47 +0000
To: <owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>>, Ryan Barnett <ryan.barnett at owasp.org<mailto:ryan.barnett at owasp.org>>
Subject: Re: [Owasp-modsecurity-core-rule-set] Mod security is not detecting double header's

Thanks Ryan for your help,

FURTHER ISSUE-  its working for HTTP and we got the below response. Our issue is with  HTTPS  as well, this rule is not working for https. Our client has raised a concern for HTTPS. Could you please advise what we can do to enable this for HTTPS as well.


Message: Warning. Pattern match "[\n\r](?:content-(type|length)|set-cookie|location):" at REQUEST_FILENAME. [file "/etc/httpd/modsecurity.d/modsecurity_localrules.conf"] [line "4"] [id "950910"] [rev "2.2.4"] [msg "HTTP Response Splitting Attack"] [data "\x0alocation:"] [severity "ALERT"]
Message: Warning. Pattern match "[\n\r](?:content-(type|length)|set-cookie|location):" at REQUEST_FILENAME. [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_40_generic_attacks.conf"] [line "139"] [id "950910"] [rev "2.2.4"] [msg "HTTP Response Splitting Attack"] [data "\x0alocation:"] [severity "CRITICAL"]
Message: Access denied with code 403 (phase 2). [file "/etc/httpd/modsecurity.d/base_rules/modsecurity_crs_49_enforcement.conf"] [line "25"] [msg "Anomaly Score Exceeded (score 40): HTTP Response Splitting Attack"]
Action: Intercepted (phase 2)
Apache-Handler: jakarta-servlet
Stopwatch: 1330624314422822 1653262 (1471 1258692 -)
Producer: ModSecurity for Apache/2.5.12 (http://www.modsecurity.org/); core ruleset/2.0.5.<http://2.0.5.>






On Thu, Mar 1, 2012 at 5:25 PM, Ryan Barnett <ryan.barnett at owasp.org<mailto:ryan.barnett at owasp.org>> wrote:
I have pushed CRS v2.2.4 out to SVN and you can access the updated rule file here -
http://mod-security.svn.sourceforge.net/viewvc/mod-security/crs/trunk/base_rules/modsecurity_crs_40_generic_attacks.conf?revision=1900

Here is the updated rule -

SecRule REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_FILENAME|ARGS_NAMES|ARGS|XML:/* "[\n\r](?:content-(type|length)|set-cookie|location):" \
        "phase:2,rev:'2.2.4',t:none,t:lowercase,capture,ctl:auditLogParts=+E,block,msg:'HTTP Response Splitting Attack',id:'950910',logdata:'%{TX.0}',severity:'2',setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.critical_anomaly_score},setvar:tx.response_splitting_score=+%{tx.critical_anomaly_score},setvar:tx.%{rule.id<http://rule.id>}-WEB_ATTACK/RESPONSE_SPLITTING-%{matched_var_name}=%{tx.0}"

-Ryan

From: Gagandeep Singh <gagandeepsohi at gmail.com<mailto:gagandeepsohi at gmail.com>>
Date: Thu, 1 Mar 2012 17:15:36 +0000
To: <owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>>
Subject: [Owasp-modsecurity-core-rule-set] Mod security is not detecting double header's

Hi

We have configured modsecurity apache_2.6.3 and its working fine for most of the cases but we have identified a special attack which is causing a double header injection to the site.

Example :-
 https://www.XYZ.com/%0d%0aLocation:http://www.google.com<https://www.xyz.com/%0d%0aLocation:http://www.google.com>
 Note - XYZ is any site.

This generates a Duplicate headers error page which is shown below-

Duplicate headers received from the server

The response from the server contained duplicate headers. This problem is generally the result of a misconfigured website or proxy. Only the website or proxy administrator can fix this issue.

 Error 350 (net::ERR_RESPONSE_HEADERS_MULTIPLE_LOCATION): Multiple Location headers received. This is disallowed to protect against HTTP response-splitting attacks.


As per the discussion with Bren we came to know that this will be fixed in CRS 2.2.4 but we need this urgently, Is it possible to get the rule for above issue so we can apply the patch for the time being and will apply 2.2.4 soon as it becomes available.

Could you please also assist on this, what configuration changes are required to handle this?

Regards
Gagandeep Singh  Sohi
_______________________________________________ Owasp-modsecurity-core-rule-set mailing list Owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:Owasp-modsecurity-core-rule-set at lists.owasp.org>https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set



--
Regards,
Gagandeep Singh Sohi
9717920072


________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.



--
Regards,
Gagandeep Singh Sohi
9717920072


________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120302/8acac9f3/attachment.html>

From matt at betweenbrain.com  Fri Mar  2 12:52:41 2012
From: matt at betweenbrain.com (Matt Thomas)
Date: Fri, 2 Mar 2012 07:52:41 -0500
Subject: [Owasp-modsecurity-core-rule-set] IP White-list Best Practice
In-Reply-To: <D736DB68-57C7-4389-996E-D6A8EFA48E3C@trustwave.com>
References: <CAOXGsbKN6ma-g-F2RgE8yPU1QuaSEDvwm+ZZ6976FULrTbCLdQ@mail.gmail.com>
	<D736DB68-57C7-4389-996E-D6A8EFA48E3C@trustwave.com>
Message-ID: <CAOXGsbKG9K0WMWOgLhLyReVpxZuaiMB73JqqexsabHq8uuXmfA@mail.gmail.com>

Thanks Ryan! That is great to know.

Best,

Matt Thomas
Founder betweenbrain <http://betweenbrain.com/>?
Lead Developer Construct Template Development
Framework<http://construct-framework.com/>
Phone: 203.632.9322
Twitter: @betweenbrain
Github: https://github.com/betweenbrain



On Thu, Mar 1, 2012 at 9:23 PM, Ryan Barnett <RBarnett at trustwave.com> wrote:

>  The 1st option doen't do what you think.  The pass action only applies
> to the current rule.  You would want to use allow instead.  I prefer the
> 2nd option as it will work even if the SecRuleEngine is DetectionOnly
> (whereas the allow action would not execute).
>
>  Ryan
>
>
> On Feb 29, 2012, at 1:28 PM, Matt Thomas <matt at betweenbrain.com> wrote:
>
>   Hi Folks,
>
>  I was wondering what the best method for white-listing an IP is? In this
> case, I need to allow PayPal's IPN to be exempt.
>
>  At http://permalink.gmane.org/gmane.comp.apache.mod-security.user/8735 I
> see a couple of methods mentioned:
>
>   SecRule REMOTE_ADDR "@streq 127.0.0.1" "phase:1,t:none,nolog,pass"
>> SecRule REMOTE_ADDE "@streq 192.168.10.1"
>> "phase:1,ctl:ruleEngine=Off,msg:'Turning off rule-engine for IP
>> %{REMOTE_ADDR}'"
>
>
>  Is using "pass" better than "ctl:ruleEngine=Off". I also see "allow"
> being used at http://serversitters.com/mod-security-whitelist-ip.html
>
>  Thanks!
>
> Best,
>
> Matt Thomas
> Founder betweenbrain <http://betweenbrain.com/>?
> Lead Developer Construct Template Development Framework<http://construct-framework.com/>
> Phone: 203.632.9322
> Twitter: @betweenbrain
>  Github: https://github.com/betweenbrain
>
>   _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>
>
> ------------------------------
> This transmission may contain information that is privileged,
> confidential, and/or exempt from disclosure under applicable law. If you
> are not the intended recipient, you are hereby notified that any
> disclosure, copying, distribution, or use of the information contained
> herein (including any reliance thereon) is STRICTLY PROHIBITED. If you
> received this transmission in error, please immediately contact the sender
> and destroy the material in its entirety, whether in electronic or hard
> copy format.
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120302/6efcdaf7/attachment-0001.html>

From RBarnett at trustwave.com  Wed Mar  7 18:08:49 2012
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Wed, 7 Mar 2012 12:08:49 -0600
Subject: [Owasp-modsecurity-core-rule-set] [Rule Update - Discussion
 Thread] Rule ACCURACY and MATURITY
In-Reply-To: <CAAxdBBn56p5M_QZbfYGn7871HAcv2Cfq4Msfb0YLoAyWTgViDQ@mail.gmail.com>
Message-ID: <CB7D0C19.453C8%rbarnett@trustwave.com>

Thinking about this a bit more.  While this is a good approach, we will
most likely do it, I think that we should make a rule that only rules with
the highest accuracy/maturity are added to the base_rules directory rules
files.  Users should be able to quickly Include all the base rules and be
assured that the rules are strong.

Any rules with lower accuracy/maturity will be placed in the
experimental_rules directory.  Once we have better tested them, then they
can have their accuracy/maturity tag meta-data updated and then be moved
into the base_rules directory.

--

Ryan Barnett
Trustwave SpiderLabs
ModSecurity Project Leader
OWASP ModSecurity CRS Project Leader




On 2/13/12 3:24 PM, "Colin Watson" <colin.watson at owasp.org> wrote:

>Recording maturity and accuracy would be a useful classification, but
>I see that accuracy will depend on context. Still, it might be useful
>to be able to only include anomaly scoring values from rules that
>surpass certain maturity and/or accuracy thresholds, plus the ability
>to force include and force exclude additional rules.
>
>Colin
>
>On 13 February 2012 18:15, Ryan Barnett <RBarnett at trustwave.com> wrote:
>> We previously introduced this concept -
>>
>>https://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/2011-Ma
>>y/000773.html
>>
>> The idea is to designate both MATURITY and ACCURACY levels of each
>>rule.  The benefits of this approach are obvious as users would then be
>>able to easily disable entire groups of rules by using
>>SecRuleRemoveByTag.
>>
>> The issue I see are that we, SpiderLabs, have absolutely no insight
>>into how these rules are working in your environments.  The only way
>>that we know that a particular rule is not working well is -
>>
>>  1.  If you send a note to the mail-list.  We do have a mail-list setup
>>just for reporting false positives -
>>https://lists.sourceforge.net/lists/listinfo/mod-security-report-false-po
>>sitives.  I guess we need to be more vigilant in redirecting FP emails
>>to that list instead.
>>  2.  If you open a JIRA ticket for the CRS -
>>https://www.modsecurity.org/tracker/browse/CORERULES
>>
>> We need help from the community in reporting back accuracy issues with
>>rules.  If you have any good ideas for getting details on false
>>positives let me know.
>>
>> --
>> Ryan Barnett
>> Trustwave SpiderLabs
>> ModSecurity Project Leader
>> OWASP ModSecurity CRS Project Leader
>>
>> ________________________________
>> This transmission may contain information that is privileged,
>>confidential, and/or exempt from disclosure under applicable law. If you
>>are not the intended recipient, you are hereby notified that any
>>disclosure, copying, distribution, or use of the information contained
>>herein (including any reliance thereon) is STRICTLY PROHIBITED. If you
>>received this transmission in error, please immediately contact the
>>sender and destroy the material in its entirety, whether in electronic
>>or hard copy format.
>>
>> _______________________________________________
>> Owasp-modsecurity-core-rule-set mailing list
>> Owasp-modsecurity-core-rule-set at lists.owasp.org
>> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>


This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.


From RBarnett at trustwave.com  Wed Mar  7 20:31:15 2012
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Wed, 7 Mar 2012 14:31:15 -0600
Subject: [Owasp-modsecurity-core-rule-set] OWASP AppSecDC 2012 Conference
Message-ID: <CB7D2FC3.45460%rbarnett@trustwave.com>

I wanted to pass along this OWASP announcement to the lists - http://owasp.blogspot.com/2012/03/owasp-appsec-dc-2012.html

There are three ModSecurity related items at AppSecDC -

 1.  Virtual Patching Workshop ? this is a 2 day training session that I will be running where we will be covering various virtual patching topics and also work extensively in hands-on labs using ModSecurity to help mitigate vulnerabilities found in the OWASP Broken Web Application Project.  Training details here: https://www.owasp.org/index.php/OWASP_AppSec_DC_2012/Training/Virtual_Patching_Workshop.  Registration is here: http://www.regonline.com/builder/site/Default.aspx?EventID=1021433
 2.  Web Application Defense with Bayesian Attack Analysis ? this is a talk I am giving that demonstrates how to use the OSBF-Lua Bayesian Classifier module to add in bayesian analysis to ModSecurity to help detect web attacks.  https://www.owasp.org/index.php/OWASP_AppSec_DC_2012/Web_Application_Defense_with_Bayesian_Attack_Analysis
 3.  Dynamic DAST/WAF Integration ? this is another talk I am giving that will demonstrate a working PoC integration between ModSecurity and the Arachni Scanner RPC service (www.arachni-scanner.com).  In the integration, ModSecurity can pass URL+Param+Cookie data to Arachni in real-time using the Lua API for targeted, on-demand assessments of resources.  ModSecurity will then check back in with Arachni to pull scan reports and save any vulnerability data to the RESOURCE collection for each URL.  With this vulnerability intelligence, we can then become more aggressive in blocking attacks targeting known vulnerable vectors.

I hope to see some of you at AppSecDC!

Cheers.

--
Ryan Barnett
Trustwave SpiderLabs
ModSecurity Project Leader
OWASP ModSecurity CRS Project Leader

________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120307/5953d816/attachment.html>

From RBarnett at trustwave.com  Wed Mar  7 18:42:22 2012
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Wed, 7 Mar 2012 12:42:22 -0600
Subject: [Owasp-modsecurity-core-rule-set] [Rule Update - Discussion Thread]
	Rule Performance
Message-ID: <CB7D163D.4542C%rbarnett@trustwave.com>

We will be reviewing each regular expression for performance as well.  Specifically, there are a number of 3rd party signatures that we imported (from phpids) that have "greedy" regexs.  This is the cause of most of the PCRE recursions errors that users are seeing from the SQLi attack rules.  We will be be reviewing and updated all regexs.

--
Ryan Barnett
Trustwave SpiderLabs
ModSecurity Project Leader
OWASP ModSecurity CRS Project Leader

________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120307/9a0727af/attachment.html>

From RBarnett at trustwave.com  Tue Mar 13 19:49:03 2012
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Tue, 13 Mar 2012 14:49:03 -0500
Subject: [Owasp-modsecurity-core-rule-set] [Rule Update - Discussion Thread]
	Updated Rule Formatting
Message-ID: <CB851CEF.45B8F%rbarnett@trustwave.com>

I am working on updating the current CRS SecRule formatting.  The idea is
to make the rules easier to read and understand what is happening, for
example to quickly understand the ACTION line data.

The format is updated to:

1) Separate the VARIABLE OPERATOR and ACTION sections from each other by
using the Apache \ line continuation character.
2) The 1st ACTION line starts with the rule ID.  This makes it easier to
find rules of interest.
3) The end of the 1st ACTION line lists any disruptive actions.
4) Transformation functions have their own line
5) Tags have their own line
6) Meta-actions (such as setvars) have their own line
7) Also including example attack payloads that are detected by the
OPERATOR to help understand what the regex is looking form

Please review/comment on the updated format below.  I would like to start
updating the CRS rules to use this format for the 3.0 version.

Thanks.


--
Ryan Barnett
Trustwave SpiderLabsModSecurity Project Leader
OWASP ModSecurity CRS Project Leader



#####################################
#
# Example Payloads Detected:
# -------------------------
# ' or 1=1#
# ') or ('1'='1--
# 1 OR \'1\'!=0
# aaa\' or (1)=(1) #!asd
# aaa\' OR (1) IS NOT NULL #!asd
# ' =+ '
# asd' =- (-'asd') -- -a
# aa" =+ - "0
# asd"or-1="-1
# asd"or!1="!1
# asd"or!(1)="1
# asd" or ascii(1)="49
# asd' or md5(5)^'1
# \"asd" or 1="1
# ' or id= 1 having 1 #1 !
# ' or id= 2-1 having 1 #1 !
# aa'or BINARY 1= '1
# aa'like-'aa
# -------------------------
#

SecRule
REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_FILENAME|ARGS_NAMES|ARGS|XML:
/* \
\
"(?i)(?i:\d[\"'`???]\s+[\"'`???]\s+\d)|(?:^admin\s*?[\"'`???]|(\/\*)+[\"'`
???]+\s?(?:--|#|\/\*|{)?)|(?:[\"'`???]\s*?(x?or|div|like|between|and)[\w\s-
]+\s*?[+<>=(),-]\s*?[\d\"'`???])|(?:[\"'`???]\s*?[^\w\s]?=\s*?[\"'`???])|(?
:[\"'`???]\W*?[+=]+\W*?[\"'`???])|(?:[\"'`???]\s*?[!=|][\d\s!=+-]+.*?[\"'`
???(].*?$)|(?:[\"'`???]\s*?[!=|][\d\s!=]+.*?\d+$)|(?:[\"'`???]\s*?like\W+[\
w\"'`???(])|(?:\sis\s*?0\W)|(?:where\s[\s\w\.,-]+\s=)|(?:[\"'`???][<>~]+[\"
'`???])" \
\
"id:'981244',msg:'Detects basic SQL authentication bypass attempts
1/3',logdata:'%{TX.0}',severity:'2',phase:2,capture,block, \
t:none,t:urlDecodeUni, \
tag:'WEB_ATTACK/SQLI', \
setvar:'tx.msg=%{rule.id}-%{rule.msg}', \
setvar:'tx.%{tx.msg}-WEB_ATTACK/SQLI-%{matched_var_name}=%{tx.0}' \
setvar:tx.sql_injection_score=+1, \
setvar:tx.anomaly_score=+%{tx.critical_anomaly_score}"






This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.


From klaubert at gmail.com  Tue Mar 13 23:35:52 2012
From: klaubert at gmail.com (Klaubert Herr da Silveira)
Date: Tue, 13 Mar 2012 20:35:52 -0300
Subject: [Owasp-modsecurity-core-rule-set] [Rule Update - Discussion
 Thread] Updated Rule Formatting
In-Reply-To: <CB851CEF.45B8F%rbarnett@trustwave.com>
References: <CB851CEF.45B8F%rbarnett@trustwave.com>
Message-ID: <CAFoCuZrYZk=Hp1Znm48c5n9Cs2UpxOOCLiNKxB9GqUWREOCF9w@mail.gmail.com>

Ryan,

it will be more clear to check these diferent aspects of the rule, action,
tags, variables, etc. Sounds good to me, this way you are swapping the very
long lines by a long file... More humam readable :)

Klaubert




On Tue, Mar 13, 2012 at 4:49 PM, Ryan Barnett <RBarnett at trustwave.com>wrote:

> I am working on updating the current CRS SecRule formatting.  The idea is
> to make the rules easier to read and understand what is happening, for
> example to quickly understand the ACTION line data.
>
> The format is updated to:
>
> 1) Separate the VARIABLE OPERATOR and ACTION sections from each other by
> using the Apache \ line continuation character.
> 2) The 1st ACTION line starts with the rule ID.  This makes it easier to
> find rules of interest.
> 3) The end of the 1st ACTION line lists any disruptive actions.
> 4) Transformation functions have their own line
> 5) Tags have their own line
> 6) Meta-actions (such as setvars) have their own line
> 7) Also including example attack payloads that are detected by the
> OPERATOR to help understand what the regex is looking form
>
> Please review/comment on the updated format below.  I would like to start
> updating the CRS rules to use this format for the 3.0 version.
>
> Thanks.
>
>
> --
> Ryan Barnett
> Trustwave SpiderLabsModSecurity Project Leader
> OWASP ModSecurity CRS Project Leader
>
>
>
> #####################################
> #
> # Example Payloads Detected:
> # -------------------------
> # ' or 1=1#
> # ') or ('1'='1--
> # 1 OR \'1\'!=0
> # aaa\' or (1)=(1) #!asd
> # aaa\' OR (1) IS NOT NULL #!asd
> # ' =+ '
> # asd' =- (-'asd') -- -a
> # aa" =+ - "0
> # asd"or-1="-1
> # asd"or!1="!1
> # asd"or!(1)="1
> # asd" or ascii(1)="49
> # asd' or md5(5)^'1
> # \"asd" or 1="1
> # ' or id= 1 having 1 #1 !
> # ' or id= 2-1 having 1 #1 !
> # aa'or BINARY 1= '1
> # aa'like-'aa
> # -------------------------
> #
>
> SecRule
> REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_FILENAME|ARGS_NAMES|ARGS|XML:
> /* \
> \
> "(?i)(?i:\d[\"'`???]\s+[\"'`???]\s+\d)|(?:^admin\s*?[\"'`???]|(\/\*)+[\"'`
> ???]+\s?(?:--|#|\/\*|{)?)|(?:[\"'`???]\s*?(x?or|div|like|between|and)[\w\s-
> ]+\s*?[+<>=(),-]\s*?[\d\"'`???])|(?:[\"'`???]\s*?[^\w\s]?=\s*?[\"'`???])|(?
> :[\"'`???]\W*?[+=]+\W*?[\"'`???])|(?:[\"'`???]\s*?[!=|][\d\s!=+-]+.*?[\"'`
> ???(].*?$)|(?:[\"'`???]\s*?[!=|][\d\s!=]+.*?\d+$)|(?:[\"'`???]\s*?like\W+[\
> w\"'`???(])|(?:\sis\s*?0\W)|(?:where\s[\s\w\.,-]+\s=)|(?:[\"'`???][<>~]+[\"
> '`???])" \
> \
> "id:'981244',msg:'Detects basic SQL authentication bypass attempts
> 1/3',logdata:'%{TX.0}',severity:'2',phase:2,capture,block, \
> t:none,t:urlDecodeUni, \
> tag:'WEB_ATTACK/SQLI', \
> setvar:'tx.msg=%{rule.id}-%{rule.msg}', \
> setvar:'tx.%{tx.msg}-WEB_ATTACK/SQLI-%{matched_var_name}=%{tx.0}' \
> setvar:tx.sql_injection_score=+1, \
> setvar:tx.anomaly_score=+%{tx.critical_anomaly_score}"
>
>
>
>
>
>
> This transmission may contain information that is privileged,
> confidential, and/or exempt from disclosure under applicable law. If you
> are not the intended recipient, you are hereby notified that any
> disclosure, copying, distribution, or use of the information contained
> herein (including any reliance thereon) is STRICTLY PROHIBITED. If you
> received this transmission in error, please immediately contact the sender
> and destroy the material in its entirety, whether in electronic or hard
> copy format.
>
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120313/e899d41f/attachment.html>

From matt at betweenbrain.com  Wed Mar 14 03:36:32 2012
From: matt at betweenbrain.com (Matt Thomas)
Date: Tue, 13 Mar 2012 23:36:32 -0400
Subject: [Owasp-modsecurity-core-rule-set] [Rule Update - Discussion
 Thread] Updated Rule Formatting
In-Reply-To: <CB851CEF.45B8F%rbarnett@trustwave.com>
References: <CB851CEF.45B8F%rbarnett@trustwave.com>
Message-ID: <CAOXGsbLBce44zssxqbfMLsoUQ1sNwx=3mUT5n38XdfmQhUo0fg@mail.gmail.com>

Ryan,

This looks great! I'm a big fan of human readable code, and this will be
important as users need to analyze false positives. I like it.

Just curious, could this have any impact on performance?

Best,

Matt Thomas
Founder betweenbrain <http://betweenbrain.com/>?
Lead Developer Construct Template Development
Framework<http://construct-framework.com/>
Phone: 203.632.9322
Twitter: @betweenbrain
Github: https://github.com/betweenbrain



On Tue, Mar 13, 2012 at 3:49 PM, Ryan Barnett <RBarnett at trustwave.com>wrote:

> I am working on updating the current CRS SecRule formatting.  The idea is
> to make the rules easier to read and understand what is happening, for
> example to quickly understand the ACTION line data.
>
> The format is updated to:
>
> 1) Separate the VARIABLE OPERATOR and ACTION sections from each other by
> using the Apache \ line continuation character.
> 2) The 1st ACTION line starts with the rule ID.  This makes it easier to
> find rules of interest.
> 3) The end of the 1st ACTION line lists any disruptive actions.
> 4) Transformation functions have their own line
> 5) Tags have their own line
> 6) Meta-actions (such as setvars) have their own line
> 7) Also including example attack payloads that are detected by the
> OPERATOR to help understand what the regex is looking form
>
> Please review/comment on the updated format below.  I would like to start
> updating the CRS rules to use this format for the 3.0 version.
>
> Thanks.
>
>
> --
> Ryan Barnett
> Trustwave SpiderLabsModSecurity Project Leader
> OWASP ModSecurity CRS Project Leader
>
>
>
> #####################################
> #
> # Example Payloads Detected:
> # -------------------------
> # ' or 1=1#
> # ') or ('1'='1--
> # 1 OR \'1\'!=0
> # aaa\' or (1)=(1) #!asd
> # aaa\' OR (1) IS NOT NULL #!asd
> # ' =+ '
> # asd' =- (-'asd') -- -a
> # aa" =+ - "0
> # asd"or-1="-1
> # asd"or!1="!1
> # asd"or!(1)="1
> # asd" or ascii(1)="49
> # asd' or md5(5)^'1
> # \"asd" or 1="1
> # ' or id= 1 having 1 #1 !
> # ' or id= 2-1 having 1 #1 !
> # aa'or BINARY 1= '1
> # aa'like-'aa
> # -------------------------
> #
>
> SecRule
> REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_FILENAME|ARGS_NAMES|ARGS|XML:
> /* \
> \
> "(?i)(?i:\d[\"'`???]\s+[\"'`???]\s+\d)|(?:^admin\s*?[\"'`???]|(\/\*)+[\"'`
> ???]+\s?(?:--|#|\/\*|{)?)|(?:[\"'`???]\s*?(x?or|div|like|between|and)[\w\s-
> ]+\s*?[+<>=(),-]\s*?[\d\"'`???])|(?:[\"'`???]\s*?[^\w\s]?=\s*?[\"'`???])|(?
> :[\"'`???]\W*?[+=]+\W*?[\"'`???])|(?:[\"'`???]\s*?[!=|][\d\s!=+-]+.*?[\"'`
> ???(].*?$)|(?:[\"'`???]\s*?[!=|][\d\s!=]+.*?\d+$)|(?:[\"'`???]\s*?like\W+[\
> w\"'`???(])|(?:\sis\s*?0\W)|(?:where\s[\s\w\.,-]+\s=)|(?:[\"'`???][<>~]+[\"
> '`???])" \
> \
> "id:'981244',msg:'Detects basic SQL authentication bypass attempts
> 1/3',logdata:'%{TX.0}',severity:'2',phase:2,capture,block, \
> t:none,t:urlDecodeUni, \
> tag:'WEB_ATTACK/SQLI', \
> setvar:'tx.msg=%{rule.id}-%{rule.msg}', \
> setvar:'tx.%{tx.msg}-WEB_ATTACK/SQLI-%{matched_var_name}=%{tx.0}' \
> setvar:tx.sql_injection_score=+1, \
> setvar:tx.anomaly_score=+%{tx.critical_anomaly_score}"
>
>
>
>
>
>
> This transmission may contain information that is privileged,
> confidential, and/or exempt from disclosure under applicable law. If you
> are not the intended recipient, you are hereby notified that any
> disclosure, copying, distribution, or use of the information contained
> herein (including any reliance thereon) is STRICTLY PROHIBITED. If you
> received this transmission in error, please immediately contact the sender
> and destroy the material in its entirety, whether in electronic or hard
> copy format.
>
> _______________________________________________
> Owasp-modsecurity-core-rule-set mailing list
> Owasp-modsecurity-core-rule-set at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120313/897e5d16/attachment-0001.html>

From jamuse at gmail.com  Wed Mar 14 08:41:00 2012
From: jamuse at gmail.com (Josh Amishav-Zlatin)
Date: Wed, 14 Mar 2012 10:41:00 +0200
Subject: [Owasp-modsecurity-core-rule-set] [Rule Update - Discussion
 Thread] Updated Rule Formatting
In-Reply-To: <CAFoCuZrYZk=Hp1Znm48c5n9Cs2UpxOOCLiNKxB9GqUWREOCF9w@mail.gmail.com>
References: <CB851CEF.45B8F%rbarnett@trustwave.com>
	<CAFoCuZrYZk=Hp1Znm48c5n9Cs2UpxOOCLiNKxB9GqUWREOCF9w@mail.gmail.com>
Message-ID: <CANnPkikG5nBidW1oOmidjQoEVQx+vnGyzqGqRgX6hW8_BrxVqg@mail.gmail.com>

>
> On Tue, Mar 13, 2012 at 4:49 PM, Ryan Barnett <RBarnett at trustwave.com>wrote:
>
>> I am working on updating the current CRS SecRule formatting.  The idea is
>> to make the rules easier to read and understand what is happening, for
>> example to quickly understand the ACTION line data.
>>
>> The format is updated to:
>>
>> 1) Separate the VARIABLE OPERATOR and ACTION sections from each other by
>> using the Apache \ line continuation character.
>> 2) The 1st ACTION line starts with the rule ID.  This makes it easier to
>> find rules of interest.
>> 3) The end of the 1st ACTION line lists any disruptive actions.
>> 4) Transformation functions have their own line
>> 5) Tags have their own line
>> 6) Meta-actions (such as setvars) have their own line
>> 7) Also including example attack payloads that are detected by the
>> OPERATOR to help understand what the regex is looking form
>>
>> Please review/comment on the updated format below.  I would like to start
>> updating the CRS rules to use this format for the 3.0 version.
>>
>>
Hi Ryan,

I like new format. IMHO, we can improve readable a bit further by adding
indentation to all lines that do not start a rule. That especially helps
locate the start of the various rules within a chained rule. For example:

SecRule ARGS test1 "id:123,phase:2,block,chain, \
  setvar:tx.sql_injection_score=+1, \
  setvar:tx.anomaly_score=+%{tx.critical_anomaly_score}"
    SecRule ARGS test2

--
 - Josh
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120314/8742caac/attachment.html>

From RBarnett at trustwave.com  Wed Mar 14 13:33:11 2012
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Wed, 14 Mar 2012 08:33:11 -0500
Subject: [Owasp-modsecurity-core-rule-set] [Rule Update - Discussion
 Thread] Updated Rule Formatting
In-Reply-To: <CANnPkikG5nBidW1oOmidjQoEVQx+vnGyzqGqRgX6hW8_BrxVqg@mail.gmail.com>
Message-ID: <CB861641.45DB6%rbarnett@trustwave.com>

Agreed and we do that already with chained rules within the CRS.

-Ryan

From: Josh Amishav-Zlatin <jamuse at gmail.com<mailto:jamuse at gmail.com>>
Date: Wed, 14 Mar 2012 03:41:00 -0500
To: Ryan Barnett <rbarnett at trustwave.com<mailto:rbarnett at trustwave.com>>
Cc: "owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>" <owasp-modsecurity-core-rule-set at lists.owasp.org<mailto:owasp-modsecurity-core-rule-set at lists.owasp.org>>
Subject: Re: [Owasp-modsecurity-core-rule-set] [Rule Update - Discussion Thread] Updated Rule Formatting

On Tue, Mar 13, 2012 at 4:49 PM, Ryan Barnett <RBarnett at trustwave.com<mailto:RBarnett at trustwave.com>> wrote:
I am working on updating the current CRS SecRule formatting.  The idea is
to make the rules easier to read and understand what is happening, for
example to quickly understand the ACTION line data.

The format is updated to:

1) Separate the VARIABLE OPERATOR and ACTION sections from each other by
using the Apache \ line continuation character.
2) The 1st ACTION line starts with the rule ID.  This makes it easier to
find rules of interest.
3) The end of the 1st ACTION line lists any disruptive actions.
4) Transformation functions have their own line
5) Tags have their own line
6) Meta-actions (such as setvars) have their own line
7) Also including example attack payloads that are detected by the
OPERATOR to help understand what the regex is looking form

Please review/comment on the updated format below.  I would like to start
updating the CRS rules to use this format for the 3.0 version.


Hi Ryan,

I like new format. IMHO, we can improve readable a bit further by adding indentation to all lines that do not start a rule. That especially helps locate the start of the various rules within a chained rule. For example:

SecRule ARGS test1 "id:123,phase:2,block,chain, \
  setvar:tx.sql_injection_score=+1, \
  setvar:tx.anomaly_score=+%{tx.critical_anomaly_score}"
    SecRule ARGS test2

--
 - Josh

________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120314/422970ba/attachment.html>

From RBarnett at trustwave.com  Wed Mar 14 20:11:14 2012
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Wed, 14 Mar 2012 15:11:14 -0500
Subject: [Owasp-modsecurity-core-rule-set] Announcing Release of OWASP
	ModSecurity CRS v2.2.4
Message-ID: <CB8673A2.46178%rbarnett@trustwave.com>

We just released CRS v2.2.4 ? download here - https://sourceforge.net/projects/mod-security/files/modsecurity-crs/0-CURRENT/

--------------------------
Version 2.2.4 - 03/14/2012
--------------------------

Improvements:
- Added Location and Set-Cookie checks to Response Splitting rule ID 950910
- Added a README file to the activated_rules directory
- Consolidate a number of SQL Injection rules into optimized regexs
- Removed multiMatch and replaceComments from SQL Injection rules
- Updated the SQLi regexs for greediness
- Updated the SQLi setvar anomaly score values to use macro expansion
- Remote PARANOID mode rules

Bug Fixes:
- Fixed missing comma before severity action in rules 958291, 958230 and 958231
- Fixed duplicate rule IDs

--
Ryan Barnett
Trustwave SpiderLabs
ModSecurity Project Leader
OWASP ModSecurity CRS Project Leader

________________________________
This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120314/9fca711d/attachment.html>

From benwilliams+owasp at joobworld.com  Thu Mar 15 03:01:24 2012
From: benwilliams+owasp at joobworld.com (Ben WIlliams)
Date: Thu, 15 Mar 2012 16:01:24 +1300
Subject: [Owasp-modsecurity-core-rule-set] brute force rule
Message-ID: <CANfYGQ=djhe_zRW8yNT+oGeMjYvVK3+wyVoZnyvtAAS6z2ghTQ@mail.gmail.com>

Hi,
My brute force rules are set to match on /ucp.php but they also match
on requests to /

ie

SecAction "phase:1,id:'981214',t:none,nolog,pass, \
setvar:'tx.brute_force_protected_urls=/ucp.php', \
setvar:'tx.brute_force_burst_time_slice=90', \
setvar:'tx.brute_force_counter_threshold=7', \
setvar:'tx.brute_force_block_timeout=300'"

SecRule &TX:BRUTE_FORCE_PROTECTED_URLS "@eq 0"
"phase:5,id:'981038',t:none,nolog,pass,skipAfter:END_BRUTE_FORCE_PROTECTION_CHECKS"
SecRule REQUEST_FILENAME "!@within %{tx.brute_force_protected_urls}"
"phase:5,id:'981039',t:none,nolog,pass,skipAfter:END_BRUTE_FORCE_PROTECTION_CHECKS"
SecRule IP:BRUTE_FORCE_BLOCK "@eq 1"
"phase:5,id:'981040',t:none,nolog,pass,skipAfter:END_BRUTE_FORCE_PROTECTION_CHECKS"


Debug log:

[14/Mar/2012:14:00:36 --0700]
[www.example.com/sid#2ae9867c9898][rid#2ae98f136830][/][4] Recipe:
Invoking rule 2ae986593ae8; [file
"/etc/httpd/modsecurity.d/activated_rules/modsecurity_crs_11_brute_force.conf"]
[line "38"] [id "981038"].
[14/Mar/2012:14:00:36 --0700]
[www.example.com/sid#2ae9867c9898][rid#2ae98f136830][/][4]
Transformation completed in 0 usec.
[14/Mar/2012:14:00:36 --0700]
[www.example.com/sid#2ae9867c9898][rid#2ae98f136830][/][4] Executing
operator "eq" with param "0" against &TX:BRUTE_FORCE_PROTECTED_URLS.
[14/Mar/2012:14:00:36 --0700]
[www.example.com/sid#2ae9867c9898][rid#2ae98f136830][/][4] Operator
completed in 1 usec.
[14/Mar/2012:14:00:36 --0700]
[www.example.com/sid#2ae9867c9898][rid#2ae98f136830][/][4] Rule
returned 0.
[14/Mar/2012:14:00:36 --0700]
[www.example.com/sid#2ae9867c9898][rid#2ae98f136830][/][4] Recipe:
Invoking rule 2ae986594568; [file
"/etc/httpd/modsecurity.d/activated_rules/modsecurity_crs_11_brute_force.conf"]
[line "39"] [id "981039"].
[14/Mar/2012:14:00:36 --0700]
[www.example.com/sid#2ae9867c9898][rid#2ae98f136830][/][4]
Transformation completed in 0 usec.
[14/Mar/2012:14:00:36 --0700]
[www.example.com/sid#2ae9867c9898][rid#2ae98f136830][/][4] Executing
operator "!within" with param "%{tx.brute_force_protected_urls}"
against REQUEST_FILENAME.
[14/Mar/2012:14:00:36 --0700]
[www.example.com/sid#2ae9867c9898][rid#2ae98f136830][/][4] Operator
completed in 10 usec.
[14/Mar/2012:14:00:36 --0700]
[www.example.com/sid#2ae9867c9898][rid#2ae98f136830][/][4] Rule
returned 0.
[14/Mar/2012:14:00:36 --0700]
[www.example.com.com/sid#2ae9867c9898][rid#2ae98f136830][/][4] Recipe:
Invoking rule 2ae9865de9e8; [file
"/etc/httpd/modsecurity.d/activated_rules/modsecurity_crs_11_brute_force.conf"]
[line "40"] [id "981040"].

From christovamps at gmail.com  Fri Mar 16 23:41:17 2012
From: christovamps at gmail.com (Christovam Paynes Silva)
Date: Fri, 16 Mar 2012 20:41:17 -0300
Subject: [Owasp-modsecurity-core-rule-set] attack TOP10/A7
Message-ID: <CAFJPc5zOgwOA3gLz_wWZmqiz7EGc0dV60DQCpZz3UrjLOyZmXg@mail.gmail.com>

Hello, I'm from Brazil, and I'm having a hard time locking a type of
attack because
they are different addresses for different ips.
Today I have latest version of mod_security rules and OWASP! Here is an
excerpt from my log, if someone can help me thank ja:



[Fri Mar 16 17:12:52 2012] [error] [client 180.76.5.60] File does not
exist: /var/www/mydomain.com.br/web/ticket

[Fri Mar 16 17:13:11 2012] [error] [client 173.44.37.234] ModSecurity:
Access denied with code 403 (phase 2). Operator EQ matched 0 at
REQUEST_HEADERS. [file
"/etc/apache2/modsecurity/crs/base_rules/modsecurity_crs_21_protocol_anomalies.conf"]
[line "46"] [id "960015"] [rev "2.1.2"] [msg "Request Missing an Accept
Header"] [severity "CRITICAL"] [tag
"PROTOCOL_VIOLATION/MISSING_HEADER_ACCEPT"] [tag "WASCTC/WASC-21"] [tag
"OWASP_TOP_10/A7"] [tag "PCI/6.5.10"] [hostname "server.mydomain.com.br"]
[uri "/ticket/86042"] [unique_id "T2Oe1woBAR8AAH-TA7MAAAAI"]

[Fri Mar 16 17:13:11 2012] [error] [client 173.44.37.234] ModSecurity:
Access denied with code 403 (phase 2). Operator EQ matched 0 at
REQUEST_HEADERS. [file
"/etc/apache2/modsecurity/crs/base_rules/modsecurity_crs_21_protocol_anomalies.conf"]
[line "46"] [id "960015"] [rev "2.1.2"] [msg "Request Missing an Accept
Header"] [severity "CRITICAL"] [tag
"PROTOCOL_VIOLATION/MISSING_HEADER_ACCEPT"] [tag "WASCTC/WASC-21"] [tag
"OWASP_TOP_10/A7"] [tag "PCI/6.5.10"] [hostname "server.mydomain.com.br"]
[uri "/ticket/86042"] [unique_id "T2Oe1woBAR8AABgmy0YAAAAL"]

[Fri Mar 16 17:13:13 2012] [error] [client 188.227.187.62] ModSecurity:
Access denied with code 403 (phase 2). Operator EQ matched 0 at
REQUEST_HEADERS. [file
"/etc/apache2/modsecurity/crs/base_rules/modsecurity_crs_21_protocol_anomalies.conf"]
[line "46"] [id "960015"] [rev "2.1.2"] [msg "Request Missing an Accept
Header"] [severity "CRITICAL"] [tag
"PROTOCOL_VIOLATION/MISSING_HEADER_ACCEPT"] [tag "WASCTC/WASC-21"] [tag
"OWASP_TOP_10/A7"] [tag "PCI/6.5.10"] [hostname "trac.mydomain.com.br"]
[uri "/ticket/newticket"] [unique_id "T2Oe2QoBAR8AAH-PAagAAAAE"]

[Fri Mar 16 17:13:39 2012] [error] [client 46.49.81.17] File does not
exist: /var/www/mydomain.com.br/web/ticket, referer:
http://trac.mydomain.com.br/ticket/1283#comment:1

[Fri Mar 16 17:13:45 2012] [error] [client 195.64.136.82] File does not
exist: /var/www/mydomain.com.br/web/ticket, referer:
http://trac.mydomain.com.br/ticket/1283#comment:1

[Fri Mar 16 17:13:51 2012] [error] [client 46.49.81.17] File does not
exist: /var/www/mydomain.com.br/web/ticket, referer:
http://trac.mydomain.com.br/ticket/1283#comment:1
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-modsecurity-core-rule-set/attachments/20120316/9bf4debd/attachment.html>

From mark at intcom.nl  Mon Mar 19 12:16:29 2012
From: mark at intcom.nl (Mark Boos (IntCom))
Date: Mon, 19 Mar 2012 13:16:29 +0100
Subject: [Owasp-modsecurity-core-rule-set] anomaly score not calculated ?
Message-ID: <NDBBLMJIGLJAFKPADIIJKEBDHLAA.mark@intcom.nl>

Hi,

An introduction: I use ModSecurity for 5 weeks now, on a relatively quiet
internet server. I am not a very experienced ModSecurity user, but the
traditional score installation worked just fine. I hope you forgive me my
shortcomings in knowledge.

I have a problem with the anomaly method: there are warnings and critical
errors in the log files, but it seems no action is being taken after the
maximum score (5) is exceeded.

Installation:
- Debian stable with apache 2.2.16
- libapache-mod-security 2.5.12-1
- crs_2.0.10 rule files (downloaded because the latest and greatest
crs_2.2.3 didnt work either)
*modsecurity_crs_20_protocol_violations.conf
*modsecurity_crs_21_protocol_anomalies.conf
*modsecurity_crs_23_request_limits.conf
*modsecurity_crs_35_bad_robots.conf
*modsecurity_crs_40_generic_attacks.conf
*modsecurity_crs_45_trojans.conf
*modsecurity_crs_49_inbound_blocking.conf
*modsecurity_crs_59_outbound_blocking.conf
*modsecurity_crs_60_correlation.conf
- latest slr
*modsecurity_slr_10_ip_reputation.conf
*modsecurity_slr_46_joomla_attacks.conf

In modsecurity_crs_10_config.conf the anomaly configuration:
----------------------------------------------------------------------
SecDefaultAction "phase:2,pass,log"

SecAction "phase:1,t:none,nolog,pass, \
setvar:tx.critical_anomaly_score=5, \
setvar:tx.error_anomaly_score=4, \
setvar:tx.warning_anomaly_score=3, \
setvar:tx.notice_anomaly_score=2"

SecAction
"phase:1,t:none,nolog,pass,setvar:tx.inbound_anomaly_score_level=5"
SecAction
"phase:1,t:none,nolog,pass,setvar:tx.outbound_anomaly_score_level=4"

SecAction "phase:1,t:none,nolog,pass,setvar:tx.anomaly_score_blocking=on"
----------------------------------------------------------------------

This results in mod-security audit log for example:
----------------------------------------------------------------------
--f3f66479-A--
[15/Mar/2012:13:08:09 +0100] T2HbqX8AAAEAAEXDCtoAAAAG 93.94.***.** 43988
95.142.***.** 80
--f3f66479-B--
GET /translators.html HTTP/1.1
TE: deflate,gzip;q=0.3
Keep-Alive: 300
Connection: Keep-Alive, TE
Host: 95.142.165.25
User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; MSIE 5.5; Windows NT 5.1)
Opera 7.01 [en]

--f3f66479-F--
HTTP/1.1 404 Not Found
Vary: Accept-Encoding
Content-Length: 214
Keep-Alive: timeout=15, max=100
Connection: Keep-Alive
Content-Type: text/html; charset=iso-8859-1

--f3f66479-H--
Message: Warning. Pattern match "^[\d.:]+$" at REQUEST_HEADERS:Host. [file
"/etc/apache2/mod-security/activated_rules/modsecurity_crs_21_protocol_anoma
lies.conf"] [line "97"] [id "960017"] [rev "2.0.10"] [msg "Host header is a
numeric IP address"] [severity "CRITICAL"] [tag
"PROTOCOL_VIOLATION/IP_HOST"] [tag "WASCTC/WASC-21"] [tag "OWASP_TOP_10/A7"]
[tag "PCI/6.5.10"] [tag
"http://technet.microsoft.com/en-us/magazine/2005.01.hackerbasher.aspx"]
Apache-Error: [file "/tmp/buildd/apache2-2.2.16/server/core.c"] [line 3648]
[level 3] File does not exist:
/var/www/vhosts/intcom.nl/httpdocs/translators.html
Stopwatch: 1331813289736227 5847 (554 5505 -)
Producer: ModSecurity for Apache/2.5.12 (http://www.modsecurity.org/); core
ruleset/2.0.10.
Server: Apache/2.2.16 (Debian) PHP/5.3.3-7+squeeze8 with Suhosin-Patch
mod_ssl/2.2.16 OpenSSL/0.9.8o

--f3f66479-K--
SecAction
"phase:1,t:none,nolog,pass,setvar:tx.critical_anomaly_score=5,setvar:tx.erro
r_anomaly_score=4,setvar:tx.warning_anomaly_score=3,setvar:tx.notice_anomaly
_score=2"
SecAction
"phase:1,t:none,nolog,pass,setvar:tx.inbound_anomaly_score_level=5"
SecAction
"phase:1,t:none,nolog,pass,setvar:tx.outbound_anomaly_score_level=4"
SecAction "phase:1,t:none,nolog,pass,setvar:tx.anomaly_score_blocking=on"
SecRule "REQUEST_METHOD" "@rx ^(?:GET|HEAD)$"
"phase:1,log,chain,rev:2.0.10,t:none,block,msg:'GET or HEAD requests with
bodies',severity:2,id:960011,tag:PROTOCOL_VIOLATION/EVASION,tag:WASCTC/WASC-
21,tag:OWASP_TOP_10/A7,tag:PCI/6.5.10,tag:http://www.w3.org/Protocols/rfc261
6/rfc2616-sec4.html#sec4.3"
SecRule "REMOTE_ADDR" "@rx .*"
"phase:1,chain,t:none,log,block,id:2200000,msg:'SLR: Client IP in
Blacklist.',tag:AUTOMATION/MALICIOUS,setvar:tx.ip_blacklist=/%{matched_var}/
"
SecRule "REQUEST_METHOD" "!@rx ^OPTIONS$"
"phase:2,log,chain,rev:2.0.10,t:none,block,msg:'Request Missing an Accept
Header',severity:2,id:960015,tag:PROTOCOL_VIOLATION/MISSING_HEADER_ACCEPT,ta
g:WASCTC/WASC-21,tag:OWASP_TOP_10/A7,tag:PCI/6.5.10"
SecRule "&REQUEST_HEADERS:Content-Type" "@eq 0"
"phase:2,log,chain,rev:2.0.10,t:none,block,msg:'Request Containing Content,
but Missing Content-Type header',id:960904,severity:5"
SecRule "REQUEST_HEADERS:Host" "@rx ^[\\d.:]+$"
"phase:2,log,rev:2.0.10,t:none,block,msg:'Host header is a numeric IP
address',severity:2,id:960017,tag:PROTOCOL_VIOLATION/IP_HOST,tag:WASCTC/WASC
-21,tag:OWASP_TOP_10/A7,tag:PCI/6.5.10,tag:http://technet.microsoft.com/en-u
s/magazine/2005.01.hackerbasher.aspx,setvar:tx.msg=%{rule.msg},setvar:tx.ano
maly_score=+%{tx.notice_anomaly_score},setvar:tx.policy_score=+%{tx.notice_a
nomaly_score},setvar:tx.%{rule.id}-POLICY/IP_HOST-%{matched_var_name}=%{matc
hed_var}'"
SecRule "TX:ANOMALY_SCORE" "@gt 0"
"phase:2,chain,t:none,deny,log,msg:'Inbound Anomaly Score Exceeded (Total
Score: %{TX.ANOMALY_SCORE}, SQLi=%{TX.SQL_INJECTION_SCORE},
XSS=%{TX.XSS_SCORE}): Last Matched Message: %{tx.msg}',logdata:'Last Matched
Data:
%{matched_var}',setvar:tx.inbound_tx_msg=%{tx.msg},setvar:tx.inbound_anomaly
_score=%{tx.anomaly_score}"
SecRule "TX:INBOUND_ANOMALY_SCORE" "@gt 0"
"phase:5,chain,t:none,log,noauditlog,skipAfter:END_CORRELATION,msg:'Inbound
Anomaly Score (Total Inbound Score: %{TX.INBOUND_ANOMALY_SCORE},
SQLi=%{TX.SQL_INJECTION_SCORE}, XSS=%{TX.XSS_SCORE}): %{tx.inbound_tx_msg}'"

--f3f66479-Z--

----------------------------------------------------------------------

It looks like the variables aren't being filled ?

Thank you for your time.

Regards
Mark


From RBarnett at trustwave.com  Mon Mar 19 13:15:08 2012
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Mon, 19 Mar 2012 08:15:08 -0500
Subject: [Owasp-modsecurity-core-rule-set] anomaly score not calculated ?
In-Reply-To: <NDBBLMJIGLJAFKPADIIJKEBDHLAA.mark@intcom.nl>
Message-ID: <CB8CA782.46ABB%rbarnett@trustwave.com>

Mark,

I would suggest that you use the latest CRS version as there are other
bugs that we have fixed.

Looking at the example audit log entry you provided, that message "Host
header is a numeric IP address" only results in a NOTICE level anomaly
score increase - setvar:tx.anomaly_score=+%{tx.notice_anomaly_score}

Here is the complete rule -

SecRule REQUEST_HEADERS:Host "^[\d.:]+$"
"phase:2,rev:'2.0.10',t:none,block,msg:'Host header is a numeric IP
address',
severity:'2',id:'960017',tag:'PROTOCOL_VIOLATION/IP_HOST',tag:'WASCTC/WASC-
21',tag:'OWASP_TOP_10/A7',tag:'PCI/6.5.10',tag:'http://technet.microsoft.co
m/en-us/magazine/2005.01.hackerbasher.aspx',setvar:'tx.msg=%{rule.msg}',set
var:tx.anomaly_score=+%{tx.notice_anomaly_score},setvar:tx.policy_score=+%{
tx.notice_anomaly_score},setvar:tx.%{rule.id}-POLICY/IP_HOST-%{matched_var_
name}=%{matched_var}'"

So, when this transaction gets to the 40 Inbound Blocking file this
ruleset is processed -

# Alert and Block based on Anomaly Scores
#
SecRule TX:ANOMALY_SCORE "@gt 0" \
    "chain,phase:2,t:none,deny,log,msg:'Inbound Anomaly Score Exceeded
(Total Score: %{TX.ANOMALY_SCORE}, SQLi=%{TX.SQL_INJECTION_SCORE},
XSS=%{TX.XSS_SCORE}): Last Matched Message: %{tx.msg}',logdata:'Last
Matched Data:
%{matched_var}',setvar:tx.inbound_tx_msg=%{tx.msg},setvar:tx.inbound_anomal
y_score=%{tx.anomaly_score}"
  SecRule TX:ANOMALY_SCORE "@ge %{tx.inbound_anomaly_score_level}" chain
    SecRule TX:ANOMALY_SCORE_BLOCKING "@streq on" chain
      SecRule TX:/^\d/ "(.*)"


Section K of your audit log shows that the first SecRule matches -

SecRule "TX:ANOMALY_SCORE" "@gt 0"
"phase:2,chain,t:none,deny,log,msg:'Inbound Anomaly Score Exceeded (Total
Score: %{TX.ANOMALY_SCORE}, SQLi=%{TX.SQL_INJECTION_SCORE},
XSS=%{TX.XSS_SCORE}): Last Matched Message: %{tx.msg}',logdata:'Last
Matched
Data:
%{matched_var}',setvar:tx.inbound_tx_msg=%{tx.msg},setvar:tx.inbound_anomal
y
_score=%{tx.anomaly_score}"


But, then it gets to the second SecRule that checks that the anomaly score
if @ge your tx.inbound_anomaly_score_level, it doesn't match.  This is
because the only 1 rule with the NOTICE level matched.  The bottom line is
that this transaction's anomaly score was below your blocking threshold.

Hope this helps,
Ryan



On 3/19/12 8:16 AM, "Mark Boos (IntCom)" <mark at intcom.nl> wrote:

>Hi,
>
>An introduction: I use ModSecurity for 5 weeks now, on a relatively quiet
>internet server. I am not a very experienced ModSecurity user, but the
>traditional score installation worked just fine. I hope you forgive me my
>shortcomings in knowledge.
>
>I have a problem with the anomaly method: there are warnings and critical
>errors in the log files, but it seems no action is being taken after the
>maximum score (5) is exceeded.
>
>Installation:
>- Debian stable with apache 2.2.16
>- libapache-mod-security 2.5.12-1
>- crs_2.0.10 rule files (downloaded because the latest and greatest
>crs_2.2.3 didnt work either)
>*modsecurity_crs_20_protocol_violations.conf
>*modsecurity_crs_21_protocol_anomalies.conf
>*modsecurity_crs_23_request_limits.conf
>*modsecurity_crs_35_bad_robots.conf
>*modsecurity_crs_40_generic_attacks.conf
>*modsecurity_crs_45_trojans.conf
>*modsecurity_crs_49_inbound_blocking.conf
>*modsecurity_crs_59_outbound_blocking.conf
>*modsecurity_crs_60_correlation.conf
>- latest slr
>*modsecurity_slr_10_ip_reputation.conf
>*modsecurity_slr_46_joomla_attacks.conf
>
>In modsecurity_crs_10_config.conf the anomaly configuration:
>----------------------------------------------------------------------
>SecDefaultAction "phase:2,pass,log"
>
>SecAction "phase:1,t:none,nolog,pass, \
>setvar:tx.critical_anomaly_score=5, \
>setvar:tx.error_anomaly_score=4, \
>setvar:tx.warning_anomaly_score=3, \
>setvar:tx.notice_anomaly_score=2"
>
>SecAction
>"phase:1,t:none,nolog,pass,setvar:tx.inbound_anomaly_score_level=5"
>SecAction
>"phase:1,t:none,nolog,pass,setvar:tx.outbound_anomaly_score_level=4"
>
>SecAction "phase:1,t:none,nolog,pass,setvar:tx.anomaly_score_blocking=on"
>----------------------------------------------------------------------
>
>This results in mod-security audit log for example:
>----------------------------------------------------------------------
>--f3f66479-A--
>[15/Mar/2012:13:08:09 +0100] T2HbqX8AAAEAAEXDCtoAAAAG 93.94.***.** 43988
>95.142.***.** 80
>--f3f66479-B--
>GET /translators.html HTTP/1.1
>TE: deflate,gzip;q=0.3
>Keep-Alive: 300
>Connection: Keep-Alive, TE
>Host: 95.142.165.25
>User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; MSIE 5.5; Windows NT 5.1)
>Opera 7.01 [en]
>
>--f3f66479-F--
>HTTP/1.1 404 Not Found
>Vary: Accept-Encoding
>Content-Length: 214
>Keep-Alive: timeout=15, max=100
>Connection: Keep-Alive
>Content-Type: text/html; charset=iso-8859-1
>
>--f3f66479-H--
>Message: Warning. Pattern match "^[\d.:]+$" at REQUEST_HEADERS:Host. [file
>"/etc/apache2/mod-security/activated_rules/modsecurity_crs_21_protocol_ano
>ma
>lies.conf"] [line "97"] [id "960017"] [rev "2.0.10"] [msg "Host header is
>a
>numeric IP address"] [severity "CRITICAL"] [tag
>"PROTOCOL_VIOLATION/IP_HOST"] [tag "WASCTC/WASC-21"] [tag
>"OWASP_TOP_10/A7"]
>[tag "PCI/6.5.10"] [tag
>"http://technet.microsoft.com/en-us/magazine/2005.01.hackerbasher.aspx"]
>Apache-Error: [file "/tmp/buildd/apache2-2.2.16/server/core.c"] [line
>3648]
>[level 3] File does not exist:
>/var/www/vhosts/intcom.nl/httpdocs/translators.html
>Stopwatch: 1331813289736227 5847 (554 5505 -)
>Producer: ModSecurity for Apache/2.5.12 (http://www.modsecurity.org/);
>core
>ruleset/2.0.10.
>Server: Apache/2.2.16 (Debian) PHP/5.3.3-7+squeeze8 with Suhosin-Patch
>mod_ssl/2.2.16 OpenSSL/0.9.8o
>
>--f3f66479-K--
>SecAction
>"phase:1,t:none,nolog,pass,setvar:tx.critical_anomaly_score=5,setvar:tx.er
>ro
>r_anomaly_score=4,setvar:tx.warning_anomaly_score=3,setvar:tx.notice_anoma
>ly
>_score=2"
>SecAction
>"phase:1,t:none,nolog,pass,setvar:tx.inbound_anomaly_score_level=5"
>SecAction
>"phase:1,t:none,nolog,pass,setvar:tx.outbound_anomaly_score_level=4"
>SecAction "phase:1,t:none,nolog,pass,setvar:tx.anomaly_score_blocking=on"
>SecRule "REQUEST_METHOD" "@rx ^(?:GET|HEAD)$"
>"phase:1,log,chain,rev:2.0.10,t:none,block,msg:'GET or HEAD requests with
>bodies',severity:2,id:960011,tag:PROTOCOL_VIOLATION/EVASION,tag:WASCTC/WAS
>C-
>21,tag:OWASP_TOP_10/A7,tag:PCI/6.5.10,tag:http://www.w3.org/Protocols/rfc2
>61
>6/rfc2616-sec4.html#sec4.3"
>SecRule "REMOTE_ADDR" "@rx .*"
>"phase:1,chain,t:none,log,block,id:2200000,msg:'SLR: Client IP in
>Blacklist.',tag:AUTOMATION/MALICIOUS,setvar:tx.ip_blacklist=/%{matched_var
>}/
>"
>SecRule "REQUEST_METHOD" "!@rx ^OPTIONS$"
>"phase:2,log,chain,rev:2.0.10,t:none,block,msg:'Request Missing an Accept
>Header',severity:2,id:960015,tag:PROTOCOL_VIOLATION/MISSING_HEADER_ACCEPT,
>ta
>g:WASCTC/WASC-21,tag:OWASP_TOP_10/A7,tag:PCI/6.5.10"
>SecRule "&REQUEST_HEADERS:Content-Type" "@eq 0"
>"phase:2,log,chain,rev:2.0.10,t:none,block,msg:'Request Containing
>Content,
>but Missing Content-Type header',id:960904,severity:5"
>SecRule "REQUEST_HEADERS:Host" "@rx ^[\\d.:]+$"
>"phase:2,log,rev:2.0.10,t:none,block,msg:'Host header is a numeric IP
>address',severity:2,id:960017,tag:PROTOCOL_VIOLATION/IP_HOST,tag:WASCTC/WA
>SC
>-21,tag:OWASP_TOP_10/A7,tag:PCI/6.5.10,tag:http://technet.microsoft.com/en
>-u
>s/magazine/2005.01.hackerbasher.aspx,setvar:tx.msg=%{rule.msg},setvar:tx.a
>no
>maly_score=+%{tx.notice_anomaly_score},setvar:tx.policy_score=+%{tx.notice
>_a
>nomaly_score},setvar:tx.%{rule.id}-POLICY/IP_HOST-%{matched_var_name}=%{ma
>tc
>hed_var}'"
>SecRule "TX:ANOMALY_SCORE" "@gt 0"
>"phase:2,chain,t:none,deny,log,msg:'Inbound Anomaly Score Exceeded (Total
>Score: %{TX.ANOMALY_SCORE}, SQLi=%{TX.SQL_INJECTION_SCORE},
>XSS=%{TX.XSS_SCORE}): Last Matched Message: %{tx.msg}',logdata:'Last
>Matched
>Data:
>%{matched_var}',setvar:tx.inbound_tx_msg=%{tx.msg},setvar:tx.inbound_anoma
>ly
>_score=%{tx.anomaly_score}"
>SecRule "TX:INBOUND_ANOMALY_SCORE" "@gt 0"
>"phase:5,chain,t:none,log,noauditlog,skipAfter:END_CORRELATION,msg:'Inboun
>d
>Anomaly Score (Total Inbound Score: %{TX.INBOUND_ANOMALY_SCORE},
>SQLi=%{TX.SQL_INJECTION_SCORE}, XSS=%{TX.XSS_SCORE}):
>%{tx.inbound_tx_msg}'"
>
>--f3f66479-Z--
>
>----------------------------------------------------------------------
>
>It looks like the variables aren't being filled ?
>
>Thank you for your time.
>
>Regards
>Mark
>
>_______________________________________________
>Owasp-modsecurity-core-rule-set mailing list
>Owasp-modsecurity-core-rule-set at lists.owasp.org
>https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>


This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.


From mark at intcom.nl  Mon Mar 19 13:33:41 2012
From: mark at intcom.nl (Mark Boos (IntCom))
Date: Mon, 19 Mar 2012 14:33:41 +0100
Subject: [Owasp-modsecurity-core-rule-set] anomaly score not calculated ?
In-Reply-To: <CB8CA782.46ABB%rbarnett@trustwave.com>
Message-ID: <NDBBLMJIGLJAFKPADIIJCEBFHLAA.mark@intcom.nl>

Hi Ryan,

But in section H of that audit log is:

>> [id "960017"] [rev "2.0.10"] [msg "Host header is a numeric IP address"]
[severity "CRITICAL"]

I look for the word CRITICAL, so I thought that it would have score 5 so it
would be above the max anomaly score.

And in K isnt it strange that there are variables reported instead of
numbers ?:

>> msg:'Inbound Anomaly Score Exceeded (Total Score: %{TX.ANOMALY_SCORE},
SQLi=%{TX.SQL_INJECTION_SCORE}, XSS=%{TX.XSS_SCORE}): Last Matched Message:
%{tx.msg}'


Regards
Mark

> -----Oorspronkelijk bericht-----
> Van: Ryan Barnett [mailto:RBarnett at trustwave.com]
> Verzonden: maandag 19 maart 2012 14:15
> Aan: mark at intcom.nl; owasp-modsecurity-core-rule-set at lists.owasp.org
> Onderwerp: Re: [Owasp-modsecurity-core-rule-set] anomaly score not
> calculated ?
>
>
> Mark,
>
> I would suggest that you use the latest CRS version as there are other
> bugs that we have fixed.
>
> Looking at the example audit log entry you provided, that message "Host
> header is a numeric IP address" only results in a NOTICE level anomaly
> score increase - setvar:tx.anomaly_score=+%{tx.notice_anomaly_score}
>
> Here is the complete rule -
>
> SecRule REQUEST_HEADERS:Host "^[\d.:]+$"
> "phase:2,rev:'2.0.10',t:none,block,msg:'Host header is a numeric IP
> address',
> severity:'2',id:'960017',tag:'PROTOCOL_VIOLATION/IP_HOST',tag:'WAS
> CTC/WASC-
> 21',tag:'OWASP_TOP_10/A7',tag:'PCI/6.5.10',tag:'http://technet.mic
> rosoft.co
> m/en-us/magazine/2005.01.hackerbasher.aspx',setvar:'tx.msg=%{rule.
> msg}',set
> var:tx.anomaly_score=+%{tx.notice_anomaly_score},setvar:tx.policy_
> score=+%{
> tx.notice_anomaly_score},setvar:tx.%{rule.id}-POLICY/IP_HOST-%{mat
> ched_var_
> name}=%{matched_var}'"
>
> So, when this transaction gets to the 40 Inbound Blocking file this
> ruleset is processed -
>
> # Alert and Block based on Anomaly Scores
> #
> SecRule TX:ANOMALY_SCORE "@gt 0" \
>     "chain,phase:2,t:none,deny,log,msg:'Inbound Anomaly Score Exceeded
> (Total Score: %{TX.ANOMALY_SCORE}, SQLi=%{TX.SQL_INJECTION_SCORE},
> XSS=%{TX.XSS_SCORE}): Last Matched Message: %{tx.msg}',logdata:'Last
> Matched Data:
> %{matched_var}',setvar:tx.inbound_tx_msg=%{tx.msg},setvar:tx.inbou
> nd_anomal
> y_score=%{tx.anomaly_score}"
>   SecRule TX:ANOMALY_SCORE "@ge %{tx.inbound_anomaly_score_level}" chain
>     SecRule TX:ANOMALY_SCORE_BLOCKING "@streq on" chain
>       SecRule TX:/^\d/ "(.*)"
>
>
> Section K of your audit log shows that the first SecRule matches -
>
> SecRule "TX:ANOMALY_SCORE" "@gt 0"
> "phase:2,chain,t:none,deny,log,msg:'Inbound Anomaly Score Exceeded (Total
> Score: %{TX.ANOMALY_SCORE}, SQLi=%{TX.SQL_INJECTION_SCORE},
> XSS=%{TX.XSS_SCORE}): Last Matched Message: %{tx.msg}',logdata:'Last
> Matched
> Data:
> %{matched_var}',setvar:tx.inbound_tx_msg=%{tx.msg},setvar:tx.inbou
> nd_anomal
> y
> _score=%{tx.anomaly_score}"
>
>
> But, then it gets to the second SecRule that checks that the anomaly score
> if @ge your tx.inbound_anomaly_score_level, it doesn't match.  This is
> because the only 1 rule with the NOTICE level matched.  The bottom line is
> that this transaction's anomaly score was below your blocking threshold.
>
> Hope this helps,
> Ryan
>
>
>
> On 3/19/12 8:16 AM, "Mark Boos (IntCom)" <mark at intcom.nl> wrote:
>
> >Hi,
> >
> >An introduction: I use ModSecurity for 5 weeks now, on a relatively quiet
> >internet server. I am not a very experienced ModSecurity user, but the
> >traditional score installation worked just fine. I hope you forgive me my
> >shortcomings in knowledge.
> >
> >I have a problem with the anomaly method: there are warnings and critical
> >errors in the log files, but it seems no action is being taken after the
> >maximum score (5) is exceeded.
> >
> >Installation:
> >- Debian stable with apache 2.2.16
> >- libapache-mod-security 2.5.12-1
> >- crs_2.0.10 rule files (downloaded because the latest and greatest
> >crs_2.2.3 didnt work either)
> >*modsecurity_crs_20_protocol_violations.conf
> >*modsecurity_crs_21_protocol_anomalies.conf
> >*modsecurity_crs_23_request_limits.conf
> >*modsecurity_crs_35_bad_robots.conf
> >*modsecurity_crs_40_generic_attacks.conf
> >*modsecurity_crs_45_trojans.conf
> >*modsecurity_crs_49_inbound_blocking.conf
> >*modsecurity_crs_59_outbound_blocking.conf
> >*modsecurity_crs_60_correlation.conf
> >- latest slr
> >*modsecurity_slr_10_ip_reputation.conf
> >*modsecurity_slr_46_joomla_attacks.conf
> >
> >In modsecurity_crs_10_config.conf the anomaly configuration:
> >----------------------------------------------------------------------
> >SecDefaultAction "phase:2,pass,log"
> >
> >SecAction "phase:1,t:none,nolog,pass, \
> >setvar:tx.critical_anomaly_score=5, \
> >setvar:tx.error_anomaly_score=4, \
> >setvar:tx.warning_anomaly_score=3, \
> >setvar:tx.notice_anomaly_score=2"
> >
> >SecAction
> >"phase:1,t:none,nolog,pass,setvar:tx.inbound_anomaly_score_level=5"
> >SecAction
> >"phase:1,t:none,nolog,pass,setvar:tx.outbound_anomaly_score_level=4"
> >
> >SecAction "phase:1,t:none,nolog,pass,setvar:tx.anomaly_score_blocking=on"
> >----------------------------------------------------------------------
> >
> >This results in mod-security audit log for example:
> >----------------------------------------------------------------------
> >--f3f66479-A--
> >[15/Mar/2012:13:08:09 +0100] T2HbqX8AAAEAAEXDCtoAAAAG 93.94.***.** 43988
> >95.142.***.** 80
> >--f3f66479-B--
> >GET /translators.html HTTP/1.1
> >TE: deflate,gzip;q=0.3
> >Keep-Alive: 300
> >Connection: Keep-Alive, TE
> >Host: 95.142.165.25
> >User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; MSIE 5.5; Windows NT 5.1)
> >Opera 7.01 [en]
> >
> >--f3f66479-F--
> >HTTP/1.1 404 Not Found
> >Vary: Accept-Encoding
> >Content-Length: 214
> >Keep-Alive: timeout=15, max=100
> >Connection: Keep-Alive
> >Content-Type: text/html; charset=iso-8859-1
> >
> >--f3f66479-H--
> >Message: Warning. Pattern match "^[\d.:]+$" at
> REQUEST_HEADERS:Host. [file
> >"/etc/apache2/mod-security/activated_rules/modsecurity_crs_21_pro
tocol_ano
> >ma
> >lies.conf"] [line "97"] [id "960017"] [rev "2.0.10"] [msg "Host header is
> >a
> >numeric IP address"] [severity "CRITICAL"] [tag
> >"PROTOCOL_VIOLATION/IP_HOST"] [tag "WASCTC/WASC-21"] [tag
> >"OWASP_TOP_10/A7"]
> >[tag "PCI/6.5.10"] [tag
> >"http://technet.microsoft.com/en-us/magazine/2005.01.hackerbasher.aspx"]
> >Apache-Error: [file "/tmp/buildd/apache2-2.2.16/server/core.c"] [line
> >3648]
> >[level 3] File does not exist:
> >/var/www/vhosts/intcom.nl/httpdocs/translators.html
> >Stopwatch: 1331813289736227 5847 (554 5505 -)
> >Producer: ModSecurity for Apache/2.5.12 (http://www.modsecurity.org/);
> >core
> >ruleset/2.0.10.
> >Server: Apache/2.2.16 (Debian) PHP/5.3.3-7+squeeze8 with Suhosin-Patch
> >mod_ssl/2.2.16 OpenSSL/0.9.8o
> >
> >--f3f66479-K--
> >SecAction
> >"phase:1,t:none,nolog,pass,setvar:tx.critical_anomaly_score=5,set
> var:tx.er
> >ro
> >r_anomaly_score=4,setvar:tx.warning_anomaly_score=3,setvar:tx.not
ice_anoma
> >ly
> >_score=2"
> >SecAction
> >"phase:1,t:none,nolog,pass,setvar:tx.inbound_anomaly_score_level=5"
> >SecAction
> >"phase:1,t:none,nolog,pass,setvar:tx.outbound_anomaly_score_level=4"
> >SecAction "phase:1,t:none,nolog,pass,setvar:tx.anomaly_score_blocking=on"
> >SecRule "REQUEST_METHOD" "@rx ^(?:GET|HEAD)$"
> >"phase:1,log,chain,rev:2.0.10,t:none,block,msg:'GET or HEAD requests with
> >bodies',severity:2,id:960011,tag:PROTOCOL_VIOLATION/EVASION,tag:W
> ASCTC/WAS
> >C-
> >21,tag:OWASP_TOP_10/A7,tag:PCI/6.5.10,tag:http://www.w3.org/Proto
> cols/rfc2
> >61
> >6/rfc2616-sec4.html#sec4.3"
> >SecRule "REMOTE_ADDR" "@rx .*"
> >"phase:1,chain,t:none,log,block,id:2200000,msg:'SLR: Client IP in
> >Blacklist.',tag:AUTOMATION/MALICIOUS,setvar:tx.ip_blacklist=/%{ma
> tched_var
> >}/
> >"
> >SecRule "REQUEST_METHOD" "!@rx ^OPTIONS$"
> >"phase:2,log,chain,rev:2.0.10,t:none,block,msg:'Request Missing an Accept
> >Header',severity:2,id:960015,tag:PROTOCOL_VIOLATION/MISSING_HEADE
> R_ACCEPT,
> >ta
> >g:WASCTC/WASC-21,tag:OWASP_TOP_10/A7,tag:PCI/6.5.10"
> >SecRule "&REQUEST_HEADERS:Content-Type" "@eq 0"
> >"phase:2,log,chain,rev:2.0.10,t:none,block,msg:'Request Containing
> >Content,
> >but Missing Content-Type header',id:960904,severity:5"
> >SecRule "REQUEST_HEADERS:Host" "@rx ^[\\d.:]+$"
> >"phase:2,log,rev:2.0.10,t:none,block,msg:'Host header is a numeric IP
> >address',severity:2,id:960017,tag:PROTOCOL_VIOLATION/IP_HOST,tag:
> WASCTC/WA
> >SC
> >-21,tag:OWASP_TOP_10/A7,tag:PCI/6.5.10,tag:http://technet.microso
> ft.com/en
> >-u
> >s/magazine/2005.01.hackerbasher.aspx,setvar:tx.msg=%{rule.msg},se
> tvar:tx.a
> >no
> >maly_score=+%{tx.notice_anomaly_score},setvar:tx.policy_score=+%{
> tx.notice
> >_a
> >nomaly_score},setvar:tx.%{rule.id}-POLICY/IP_HOST-%{matched_var_n
> ame}=%{ma
> >tc
> >hed_var}'"
> >SecRule "TX:ANOMALY_SCORE" "@gt 0"
> >"phase:2,chain,t:none,deny,log,msg:'Inbound Anomaly Score Exceeded (Total
> >Score: %{TX.ANOMALY_SCORE}, SQLi=%{TX.SQL_INJECTION_SCORE},
> >XSS=%{TX.XSS_SCORE}): Last Matched Message: %{tx.msg}',logdata:'Last
> >Matched
> >Data:
> >%{matched_var}',setvar:tx.inbound_tx_msg=%{tx.msg},setvar:tx.inbo
> und_anoma
> >ly
> >_score=%{tx.anomaly_score}"
> >SecRule "TX:INBOUND_ANOMALY_SCORE" "@gt 0"
> >"phase:5,chain,t:none,log,noauditlog,skipAfter:END_CORRELATION,ms
> g:'Inboun
> >d
> >Anomaly Score (Total Inbound Score: %{TX.INBOUND_ANOMALY_SCORE},
> >SQLi=%{TX.SQL_INJECTION_SCORE}, XSS=%{TX.XSS_SCORE}):
> >%{tx.inbound_tx_msg}'"
> >
> >--f3f66479-Z--
> >
> >----------------------------------------------------------------------
> >
> >It looks like the variables aren't being filled ?
> >
> >Thank you for your time.
> >
> >Regards
> >Mark
> >
> >_______________________________________________
> >Owasp-modsecurity-core-rule-set mailing list
> >Owasp-modsecurity-core-rule-set at lists.owasp.org
> >https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
> >
>
>
> This transmission may contain information that is privileged,
> confidential, and/or exempt from disclosure under applicable law.
> If you are not the intended recipient, you are hereby notified
> that any disclosure, copying, distribution, or use of the
> information contained herein (including any reliance thereon) is
> STRICTLY PROHIBITED. If you received this transmission in error,
> please immediately contact the sender and destroy the material in
> its entirety, whether in electronic or hard copy format.
>


From RBarnett at trustwave.com  Mon Mar 19 16:51:12 2012
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Mon, 19 Mar 2012 11:51:12 -0500
Subject: [Owasp-modsecurity-core-rule-set] anomaly score not calculated ?
In-Reply-To: <NDBBLMJIGLJAFKPADIIJCEBFHLAA.mark@intcom.nl>
Message-ID: <CB8CDBDD.46B18%ryan.barnett@owasp.org>

Hey Mark,
You are correct about the severity.  It should NOT be listed as 2
"CRITICAL" - I will fix that.  It is at a NOTICE level.

As for Section K, it lists the rule lines that matched, however unlike the
actual Error or Audit log alert, macros are not expanded here.

-Ryan

On 3/19/12 9:33 AM, "Mark Boos (IntCom)" <mark at intcom.nl> wrote:

>Hi Ryan,
>
>But in section H of that audit log is:
>
>>> [id "960017"] [rev "2.0.10"] [msg "Host header is a numeric IP
>>>address"]
>[severity "CRITICAL"]
>
>I look for the word CRITICAL, so I thought that it would have score 5 so
>it
>would be above the max anomaly score.
>
>And in K isnt it strange that there are variables reported instead of
>numbers ?:
>
>>> msg:'Inbound Anomaly Score Exceeded (Total Score: %{TX.ANOMALY_SCORE},
>SQLi=%{TX.SQL_INJECTION_SCORE}, XSS=%{TX.XSS_SCORE}): Last Matched
>Message:
>%{tx.msg}'
>
>
>Regards
>Mark
>
>> -----Oorspronkelijk bericht-----
>> Van: Ryan Barnett [mailto:RBarnett at trustwave.com]
>> Verzonden: maandag 19 maart 2012 14:15
>> Aan: mark at intcom.nl; owasp-modsecurity-core-rule-set at lists.owasp.org
>> Onderwerp: Re: [Owasp-modsecurity-core-rule-set] anomaly score not
>> calculated ?
>>
>>
>> Mark,
>>
>> I would suggest that you use the latest CRS version as there are other
>> bugs that we have fixed.
>>
>> Looking at the example audit log entry you provided, that message "Host
>> header is a numeric IP address" only results in a NOTICE level anomaly
>> score increase - setvar:tx.anomaly_score=+%{tx.notice_anomaly_score}
>>
>> Here is the complete rule -
>>
>> SecRule REQUEST_HEADERS:Host "^[\d.:]+$"
>> "phase:2,rev:'2.0.10',t:none,block,msg:'Host header is a numeric IP
>> address',
>> severity:'2',id:'960017',tag:'PROTOCOL_VIOLATION/IP_HOST',tag:'WAS
>> CTC/WASC-
>> 21',tag:'OWASP_TOP_10/A7',tag:'PCI/6.5.10',tag:'http://technet.mic
>> rosoft.co
>> m/en-us/magazine/2005.01.hackerbasher.aspx',setvar:'tx.msg=%{rule.
>> msg}',set
>> var:tx.anomaly_score=+%{tx.notice_anomaly_score},setvar:tx.policy_
>> score=+%{
>> tx.notice_anomaly_score},setvar:tx.%{rule.id}-POLICY/IP_HOST-%{mat
>> ched_var_
>> name}=%{matched_var}'"
>>
>> So, when this transaction gets to the 40 Inbound Blocking file this
>> ruleset is processed -
>>
>> # Alert and Block based on Anomaly Scores
>> #
>> SecRule TX:ANOMALY_SCORE "@gt 0" \
>>     "chain,phase:2,t:none,deny,log,msg:'Inbound Anomaly Score Exceeded
>> (Total Score: %{TX.ANOMALY_SCORE}, SQLi=%{TX.SQL_INJECTION_SCORE},
>> XSS=%{TX.XSS_SCORE}): Last Matched Message: %{tx.msg}',logdata:'Last
>> Matched Data:
>> %{matched_var}',setvar:tx.inbound_tx_msg=%{tx.msg},setvar:tx.inbou
>> nd_anomal
>> y_score=%{tx.anomaly_score}"
>>   SecRule TX:ANOMALY_SCORE "@ge %{tx.inbound_anomaly_score_level}" chain
>>     SecRule TX:ANOMALY_SCORE_BLOCKING "@streq on" chain
>>       SecRule TX:/^\d/ "(.*)"
>>
>>
>> Section K of your audit log shows that the first SecRule matches -
>>
>> SecRule "TX:ANOMALY_SCORE" "@gt 0"
>> "phase:2,chain,t:none,deny,log,msg:'Inbound Anomaly Score Exceeded
>>(Total
>> Score: %{TX.ANOMALY_SCORE}, SQLi=%{TX.SQL_INJECTION_SCORE},
>> XSS=%{TX.XSS_SCORE}): Last Matched Message: %{tx.msg}',logdata:'Last
>> Matched
>> Data:
>> %{matched_var}',setvar:tx.inbound_tx_msg=%{tx.msg},setvar:tx.inbou
>> nd_anomal
>> y
>> _score=%{tx.anomaly_score}"
>>
>>
>> But, then it gets to the second SecRule that checks that the anomaly
>>score
>> if @ge your tx.inbound_anomaly_score_level, it doesn't match.  This is
>> because the only 1 rule with the NOTICE level matched.  The bottom line
>>is
>> that this transaction's anomaly score was below your blocking threshold.
>>
>> Hope this helps,
>> Ryan
>>
>>
>>
>> On 3/19/12 8:16 AM, "Mark Boos (IntCom)" <mark at intcom.nl> wrote:
>>
>> >Hi,
>> >
>> >An introduction: I use ModSecurity for 5 weeks now, on a relatively
>>quiet
>> >internet server. I am not a very experienced ModSecurity user, but the
>> >traditional score installation worked just fine. I hope you forgive me
>>my
>> >shortcomings in knowledge.
>> >
>> >I have a problem with the anomaly method: there are warnings and
>>critical
>> >errors in the log files, but it seems no action is being taken after
>>the
>> >maximum score (5) is exceeded.
>> >
>> >Installation:
>> >- Debian stable with apache 2.2.16
>> >- libapache-mod-security 2.5.12-1
>> >- crs_2.0.10 rule files (downloaded because the latest and greatest
>> >crs_2.2.3 didnt work either)
>> >*modsecurity_crs_20_protocol_violations.conf
>> >*modsecurity_crs_21_protocol_anomalies.conf
>> >*modsecurity_crs_23_request_limits.conf
>> >*modsecurity_crs_35_bad_robots.conf
>> >*modsecurity_crs_40_generic_attacks.conf
>> >*modsecurity_crs_45_trojans.conf
>> >*modsecurity_crs_49_inbound_blocking.conf
>> >*modsecurity_crs_59_outbound_blocking.conf
>> >*modsecurity_crs_60_correlation.conf
>> >- latest slr
>> >*modsecurity_slr_10_ip_reputation.conf
>> >*modsecurity_slr_46_joomla_attacks.conf
>> >
>> >In modsecurity_crs_10_config.conf the anomaly configuration:
>> >----------------------------------------------------------------------
>> >SecDefaultAction "phase:2,pass,log"
>> >
>> >SecAction "phase:1,t:none,nolog,pass, \
>> >setvar:tx.critical_anomaly_score=5, \
>> >setvar:tx.error_anomaly_score=4, \
>> >setvar:tx.warning_anomaly_score=3, \
>> >setvar:tx.notice_anomaly_score=2"
>> >
>> >SecAction
>> >"phase:1,t:none,nolog,pass,setvar:tx.inbound_anomaly_score_level=5"
>> >SecAction
>> >"phase:1,t:none,nolog,pass,setvar:tx.outbound_anomaly_score_level=4"
>> >
>> >SecAction
>>"phase:1,t:none,nolog,pass,setvar:tx.anomaly_score_blocking=on"
>> >----------------------------------------------------------------------
>> >
>> >This results in mod-security audit log for example:
>> >----------------------------------------------------------------------
>> >--f3f66479-A--
>> >[15/Mar/2012:13:08:09 +0100] T2HbqX8AAAEAAEXDCtoAAAAG 93.94.***.**
>>43988
>> >95.142.***.** 80
>> >--f3f66479-B--
>> >GET /translators.html HTTP/1.1
>> >TE: deflate,gzip;q=0.3
>> >Keep-Alive: 300
>> >Connection: Keep-Alive, TE
>> >Host: 95.142.165.25
>> >User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; MSIE 5.5; Windows NT
>>5.1)
>> >Opera 7.01 [en]
>> >
>> >--f3f66479-F--
>> >HTTP/1.1 404 Not Found
>> >Vary: Accept-Encoding
>> >Content-Length: 214
>> >Keep-Alive: timeout=15, max=100
>> >Connection: Keep-Alive
>> >Content-Type: text/html; charset=iso-8859-1
>> >
>> >--f3f66479-H--
>> >Message: Warning. Pattern match "^[\d.:]+$" at
>> REQUEST_HEADERS:Host. [file
>> >"/etc/apache2/mod-security/activated_rules/modsecurity_crs_21_pro
>tocol_ano
>> >ma
>> >lies.conf"] [line "97"] [id "960017"] [rev "2.0.10"] [msg "Host header
>>is
>> >a
>> >numeric IP address"] [severity "CRITICAL"] [tag
>> >"PROTOCOL_VIOLATION/IP_HOST"] [tag "WASCTC/WASC-21"] [tag
>> >"OWASP_TOP_10/A7"]
>> >[tag "PCI/6.5.10"] [tag
>>
>>>"http://technet.microsoft.com/en-us/magazine/2005.01.hackerbasher.aspx"]
>> >Apache-Error: [file "/tmp/buildd/apache2-2.2.16/server/core.c"] [line
>> >3648]
>> >[level 3] File does not exist:
>> >/var/www/vhosts/intcom.nl/httpdocs/translators.html
>> >Stopwatch: 1331813289736227 5847 (554 5505 -)
>> >Producer: ModSecurity for Apache/2.5.12 (http://www.modsecurity.org/);
>> >core
>> >ruleset/2.0.10.
>> >Server: Apache/2.2.16 (Debian) PHP/5.3.3-7+squeeze8 with Suhosin-Patch
>> >mod_ssl/2.2.16 OpenSSL/0.9.8o
>> >
>> >--f3f66479-K--
>> >SecAction
>> >"phase:1,t:none,nolog,pass,setvar:tx.critical_anomaly_score=5,set
>> var:tx.er
>> >ro
>> >r_anomaly_score=4,setvar:tx.warning_anomaly_score=3,setvar:tx.not
>ice_anoma
>> >ly
>> >_score=2"
>> >SecAction
>> >"phase:1,t:none,nolog,pass,setvar:tx.inbound_anomaly_score_level=5"
>> >SecAction
>> >"phase:1,t:none,nolog,pass,setvar:tx.outbound_anomaly_score_level=4"
>> >SecAction
>>"phase:1,t:none,nolog,pass,setvar:tx.anomaly_score_blocking=on"
>> >SecRule "REQUEST_METHOD" "@rx ^(?:GET|HEAD)$"
>> >"phase:1,log,chain,rev:2.0.10,t:none,block,msg:'GET or HEAD requests
>>with
>> >bodies',severity:2,id:960011,tag:PROTOCOL_VIOLATION/EVASION,tag:W
>> ASCTC/WAS
>> >C-
>> >21,tag:OWASP_TOP_10/A7,tag:PCI/6.5.10,tag:http://www.w3.org/Proto
>> cols/rfc2
>> >61
>> >6/rfc2616-sec4.html#sec4.3"
>> >SecRule "REMOTE_ADDR" "@rx .*"
>> >"phase:1,chain,t:none,log,block,id:2200000,msg:'SLR: Client IP in
>> >Blacklist.',tag:AUTOMATION/MALICIOUS,setvar:tx.ip_blacklist=/%{ma
>> tched_var
>> >}/
>> >"
>> >SecRule "REQUEST_METHOD" "!@rx ^OPTIONS$"
>> >"phase:2,log,chain,rev:2.0.10,t:none,block,msg:'Request Missing an
>>Accept
>> >Header',severity:2,id:960015,tag:PROTOCOL_VIOLATION/MISSING_HEADE
>> R_ACCEPT,
>> >ta
>> >g:WASCTC/WASC-21,tag:OWASP_TOP_10/A7,tag:PCI/6.5.10"
>> >SecRule "&REQUEST_HEADERS:Content-Type" "@eq 0"
>> >"phase:2,log,chain,rev:2.0.10,t:none,block,msg:'Request Containing
>> >Content,
>> >but Missing Content-Type header',id:960904,severity:5"
>> >SecRule "REQUEST_HEADERS:Host" "@rx ^[\\d.:]+$"
>> >"phase:2,log,rev:2.0.10,t:none,block,msg:'Host header is a numeric IP
>> >address',severity:2,id:960017,tag:PROTOCOL_VIOLATION/IP_HOST,tag:
>> WASCTC/WA
>> >SC
>> >-21,tag:OWASP_TOP_10/A7,tag:PCI/6.5.10,tag:http://technet.microso
>> ft.com/en
>> >-u
>> >s/magazine/2005.01.hackerbasher.aspx,setvar:tx.msg=%{rule.msg},se
>> tvar:tx.a
>> >no
>> >maly_score=+%{tx.notice_anomaly_score},setvar:tx.policy_score=+%{
>> tx.notice
>> >_a
>> >nomaly_score},setvar:tx.%{rule.id}-POLICY/IP_HOST-%{matched_var_n
>> ame}=%{ma
>> >tc
>> >hed_var}'"
>> >SecRule "TX:ANOMALY_SCORE" "@gt 0"
>> >"phase:2,chain,t:none,deny,log,msg:'Inbound Anomaly Score Exceeded
>>(Total
>> >Score: %{TX.ANOMALY_SCORE}, SQLi=%{TX.SQL_INJECTION_SCORE},
>> >XSS=%{TX.XSS_SCORE}): Last Matched Message: %{tx.msg}',logdata:'Last
>> >Matched
>> >Data:
>> >%{matched_var}',setvar:tx.inbound_tx_msg=%{tx.msg},setvar:tx.inbo
>> und_anoma
>> >ly
>> >_score=%{tx.anomaly_score}"
>> >SecRule "TX:INBOUND_ANOMALY_SCORE" "@gt 0"
>> >"phase:5,chain,t:none,log,noauditlog,skipAfter:END_CORRELATION,ms
>> g:'Inboun
>> >d
>> >Anomaly Score (Total Inbound Score: %{TX.INBOUND_ANOMALY_SCORE},
>> >SQLi=%{TX.SQL_INJECTION_SCORE}, XSS=%{TX.XSS_SCORE}):
>> >%{tx.inbound_tx_msg}'"
>> >
>> >--f3f66479-Z--
>> >
>> >----------------------------------------------------------------------
>> >
>> >It looks like the variables aren't being filled ?
>> >
>> >Thank you for your time.
>> >
>> >Regards
>> >Mark
>> >
>> >_______________________________________________
>> >Owasp-modsecurity-core-rule-set mailing list
>> >Owasp-modsecurity-core-rule-set at lists.owasp.org
>>
>>>https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>> >
>>
>>
>> This transmission may contain information that is privileged,
>> confidential, and/or exempt from disclosure under applicable law.
>> If you are not the intended recipient, you are hereby notified
>> that any disclosure, copying, distribution, or use of the
>> information contained herein (including any reliance thereon) is
>> STRICTLY PROHIBITED. If you received this transmission in error,
>> please immediately contact the sender and destroy the material in
>> its entirety, whether in electronic or hard copy format.
>>
>
>_______________________________________________
>Owasp-modsecurity-core-rule-set mailing list
>Owasp-modsecurity-core-rule-set at lists.owasp.org
>https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set


This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.


From RBarnett at trustwave.com  Mon Mar 26 19:58:00 2012
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Mon, 26 Mar 2012 14:58:00 -0500
Subject: [Owasp-modsecurity-core-rule-set] Website GSoC2012 Ideas - OWASP
Message-ID: <1486A596-CDD6-40DB-BB82-C93CCA2A2528@trustwave.com>

OWASP is participating in the Google Summer of Code 2012 Project and I have added some project ideas for the CRS -

GSoC2012 Ideas - OWASP
https://www.owasp.org/index.php/GSoC2012_Ideas#ModSecurity_Core_Rule_Set

If you are a college student or know one, please pass this on for consideration.

Thanks

Ryan

This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.


From tzury.by at reguluslabs.com  Wed Mar 28 06:18:37 2012
From: tzury.by at reguluslabs.com (Tzury Bar Yochay)
Date: Wed, 28 Mar 2012 08:18:37 +0200
Subject: [Owasp-modsecurity-core-rule-set] Should not the following being
	blocked by default?
Message-ID: <CAL9DS1zR-Ti9d-YpV+hFmjGHyGJ3jKazTLmQD4ALVeNxZrvrpg@mail.gmail.com>

Hi,

below is an output of a small program I wrote to test sites protected
by modSecurity
I tried pushing in some SQL injection tests and was surprised to find
out the following just passed through and not being blocked despite
having all default rules active)

test failed: GET --
/index.php?id=1+and+1=(SELECT+1+FROM+information_schema.tables+WHERE+TABLE_SCHEMA="blind_sqli"+AND+table_name+REGEXP+'^[a-z]'+LIMIT+0,1)
{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
instead
test failed: GET --
/index.php?id=1+and+1=(SELECT+1+FROM+information_schema.tables++WHERE+TABLE_SCHEMA="blind_sqli"+AND+table_name+REGEXP+'^[a-n]'+LIMIT+0,1)
{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
instead
test failed: GET --
/index.php?id=1+and+1=(SELECT+1+FROM+information_schema.tables++WHERE+TABLE_SCHEMA="blind_sqli"+AND+table_name+REGEXP+'^[a-g]'+LIMIT+0,1)
{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
instead
test failed: GET --
/index.php?id=1+and+1=(SELECT+1+FROM+information_schema.tables++WHERE+TABLE_SCHEMA="blind_sqli"+AND+table_name+REGEXP+'^[h-n]'+LIMIT+0,1)
{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
instead
test failed: GET --
/index.php?id=1+and+1=(SELECT+1+FROM+information_schema.tables++WHERE+TABLE_SCHEMA="blind_sqli"+AND+table_name+REGEXP+'^[h-l]'+LIMIT+0,1)
{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
instead
test failed: GET --
/index.php?id=1+and+1=(SELECT+1+FROM+information_schema.tables++WHERE+TABLE_SCHEMA="blind_sqli"+AND+table_name+REGEXP+'^m'+LIMIT+0,1)
{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
instead
test failed: GET --
/index.php?id=1+and+1=(SELECT+1+FROM+information_schema.tables++WHERE+TABLE_SCHEMA="blind_sqli"+AND+table_name+REGEXP+'^n'+LIMIT+0,1)+
{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
instead
test failed: GET --
/index.php?id=1+and+1=(SELECT+1+FROM+information_schema.tables++WHERE+TABLE_SCHEMA="blind_sqli"+AND+table_name+REGEXP+'^n'+LIMIT+1,1)+
{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
instead
test failed: GET --
/default.asp?id=1+AND+1=(SELECT+TOP+1+1+FROM+information_schema.tables+WHERE+TABLE_SCHEMA="blind_sqli"+and+table_name+LIKE+'[a-z]%'+)
{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
instead
test failed: GET --
/default.asp?id=1+AND+1=(SELECT+TOP+1+1+FROM+information_schema.tables+WHERE+TABLE_SCHEMA="blind_sqli"+and+table_name+NOT+IN+(+SELECT+TOP+1+table_name+FROM+information_schema.tables)+and+table_name+LIKE+'[a-z]%'+)
{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
instead
test failed: GET --
/index.php?id=1+and+1=(SELECT+1+FROM+users+WHERE+password+REGEXP+'^[a-f]'+AND+ID=1)
{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
instead
test failed: GET --
/index.php?id=1+and+1=(SELECT+1+FROM+users+WHERE+password+REGEXP+'^[0-9]'+AND+ID=1)
{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
instead
test failed: GET --
/index.php?id=1+and+1=(SELECT+1+FROM+users+WHERE+password+REGEXP+'^[0-4]'+AND+ID=1)
{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
instead
test failed: GET --
/index.php?id=1+and+1=(SELECT+1+FROM+users+WHERE+password+REGEXP+'^[5-9]'+AND+ID=1)
{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
instead
test failed: GET --
/index.php?id=1+and+1=(SELECT+1+FROM+users+WHERE+password+REGEXP+'^[5-7]'+AND+ID=1)
{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
instead
test failed: GET --
/index.php?id=1+and+1=(SELECT+1+FROM+users+WHERE+password+REGEXP+'^5'+AND+ID=1)
{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
instead
test failed: GET --
/default.asp?id=1+AND+1=(SELECT+1+FROM+users+WHERE+password+LIKE+'5[a-f]%'+AND+ID=1)
{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
instead
test failed: GET --
/default.asp?id=1+AND+1=(SELECT+1+FROM+users+WHERE+password+LIKE+'5[a-c]%'+AND+ID=1)
{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
instead
test failed: GET --
/default.asp?id=1+AND+1=(SELECT+1+FROM+users+WHERE+password+LIKE+'5[d-f]%'+AND+ID=1)
{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
instead
test failed: GET --
/default.asp?id=1+AND+1=(SELECT+1+FROM+users+WHERE+password+LIKE+'5[d-e]%'+AND+ID=1)
{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
instead
test failed: GET --
/default.asp?id=1+AND+1=(SELECT+1+FROM+users+WHERE+password+LIKE+'5f%'+AND+ID=1)
{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
instead
test failed: GET --
/http://example/article.asp?ID=2+union+all+select+name+from+sysobjects
{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
instead
test failed: GET -- /article.asp?ID=2'+and+1=1 {}. Expected: <class
'requests.exceptions.ConnectionError'>, got 200 instead
test failed: GET -- /article.asp?ID=2'+and+1=0+ {}. Expected: <class
'requests.exceptions.ConnectionError'>, got 200 instead

From RBarnett at trustwave.com  Wed Mar 28 12:33:55 2012
From: RBarnett at trustwave.com (Ryan Barnett)
Date: Wed, 28 Mar 2012 07:33:55 -0500
Subject: [Owasp-modsecurity-core-rule-set] Should not the following
 being blocked by default?
In-Reply-To: <CAL9DS1zR-Ti9d-YpV+hFmjGHyGJ3jKazTLmQD4ALVeNxZrvrpg@mail.gmail.com>
Message-ID: <CB987CCF.488A6%rbarnett@trustwave.com>

What CRS version are you using?
How do you have the SecRuleEngine configured?  Unless it is set to On, you
can't rely upon returned status codes for detection.
How have you activated the rules?  Are you sure you have the
modsecurity_crs_41_sql_injection_attacks.conf file activated?

I tested your first payload against the latest CRS version and it
triggered many SQLi alerts -

[Wed Mar 28 08:30:23 2012] [error] [client 127.0.0.1] ModSecurity:
Warning. Pattern match
"(?i:(\\\\!\\\\=|\\\\&\\\\&|\\\\|\\\\||>>|<<|>=|<=|<>|<=>|xor|rlike|regexp|
isnull)|(?:not\\\\s+between\\\\s+0\\\\s+and)|(?:is\\\\s+null)|(like\\\\s+nu
ll)|(?:(?:^|\\\\W)in[+\\\\s]*\\\\([\\\\s\\\\d\\"]+[^()]*\\\\))|(?:xor|<>|rl
ike(?:\\\\s+binary)?)|(?:regexp\\\\s+binary))" at ARGS:id. [file
"/usr/local/apache/conf/crs/base_rules/modsecurity_crs_41_sql_injection_att
acks.conf"] [line "70"] [id "981319"] [rev "2.2.5"] [msg "SQL Injection
Attack: SQL Operator Detected"] [data "REGEXP"] [severity "CRITICAL"] [tag
"WEB_ATTACK/SQL_INJECTION"] [tag "WASCTC/WASC-19"] [tag "OWASP_TOP_10/A1"]
[tag "OWASP_AppSensor/CIE1"] [tag "PCI/6.5.2"] [hostname "localhost"] [uri
"/index.php"] [unique_id "T3MEX8CoqAEAAWNHI4gAAAAE"]
[Wed Mar 28 08:30:23 2012] [error] [client 127.0.0.1] ModSecurity:
Warning. Pattern match
"(?i:(?:m(?:s(?:ysaccessobjects|msysaces|msysobjects|msysqueries|msysrelati
onships|msysaccessstorage|msysaccessxml|msysmodules|msysmodules2|db)|aster\
\\\.\\\\.sysdatabases|ysql\\\\.db)|s(?:ys(?:\\\\.database_name|aux)|chema(?
:\\\\W*\\\\(|_name)|qlite(_temp)?_master ..." at ARGS:id. [file
"/usr/local/apache/conf/crs/base_rules/modsecurity_crs_41_sql_injection_att
acks.conf"] [line "84"] [id "981320"] [rev "2.2.5"] [msg "SQL Injection
Attack: Common DB Names Detected"] [data "information_schema"] [severity
"CRITICAL"] [tag "WEB_ATTACK/SQL_INJECTION"] [tag "WASCTC/WASC-19"] [tag
"OWASP_TOP_10/A1"] [tag "OWASP_AppSensor/CIE1"] [tag "PCI/6.5.2"]
[hostname "localhost"] [uri "/index.php"] [unique_id
"T3MEX8CoqAEAAWNHI4gAAAAE"]
[Wed Mar 28 08:30:23 2012] [error] [client 127.0.0.1] ModSecurity:
Warning. Operator GE matched 3 at TX:sqli_select_statement_count. [file
"/usr/local/apache/conf/crs/base_rules/modsecurity_crs_41_sql_injection_att
acks.conf"] [line "108"] [id "981317"] [rev "2.2.5"] [msg "SQL SELECT
Statement Anomaly Detection Alert"] [data "4"] [tag
"WEB_ATTACK/SQL_INJECTION"] [tag "WASCTC/WASC-19"] [tag "OWASP_TOP_10/A1"]
[tag "OWASP_AppSensor/CIE1"] [tag "PCI/6.5.2"] [hostname "localhost"] [uri
"/index.php"] [unique_id "T3MEX8CoqAEAAWNHI4gAAAAE"]
[Wed Mar 28 08:30:23 2012] [error] [client 127.0.0.1] ModSecurity:
Warning. Pattern match
"(?i:(?:\\\\b(?:(?:s(?:ys\\\\.(?:user_(?:(?:t(?:ab(?:_column|le)|rigger)|ob
ject|view)s|c(?:onstraints|atalog))|all_tables|tab)|elect\\\\b.{0,40}\\\\b(
?:substring|users?|ascii))|m(?:sys(?:(?:queri|ac)e|relationship|column|obje
ct)s|ysql\\\\.(db|user))|c(?:onstraint ..." at ARGS:id. [file
"/usr/local/apache/conf/crs/base_rules/modsecurity_crs_41_sql_injection_att
acks.conf"] [line "116"] [id "950007"] [rev "2.2.5"] [msg "Blind SQL
Injection Attack"] [data "table_name"] [severity "CRITICAL"] [tag
"WEB_ATTACK/SQL_INJECTION"] [tag "WASCTC/WASC-19"] [tag "OWASP_TOP_10/A1"]
[tag "OWASP_AppSensor/CIE1"] [tag "PCI/6.5.2"] [hostname "localhost"] [uri
"/index.php"] [unique_id "T3MEX8CoqAEAAWNHI4gAAAAE"]
[Wed Mar 28 08:30:23 2012] [error] [client 127.0.0.1] ModSecurity:
Warning. Pattern match
"(?i:(?:(?:s(?:t(?:d(?:dev(_pop|_samp)?)?|r(?:_to_date|cmp))|u(?:b(?:str(?:
ing(_index)?)?|(?:dat|tim)e)|m)|e(?:c(?:_to_time|ond)|ssion_user)|ys(?:tem_
user|date)|ha(1|2)?|oundex|chema|ig?n|pace|qrt)|i(?:s(null|_(free_lock|ipv4
_compat|ipv4_mapped|ipv4|ipv ..." at ARGS:id. [file
"/usr/local/apache/conf/crs/base_rules/modsecurity_crs_41_sql_injection_att
acks.conf"] [line "125"] [id "950001"] [rev "2.2.5"] [msg "SQL Injection
Attack"] [data "SELECT 1 FROM information_schema.tables WHERE"] [severity
"CRITICAL"] [tag "WEB_ATTACK/SQL_INJECTION"] [tag "WASCTC/WASC-19"] [tag
"OWASP_TOP_10/A1"] [tag "OWASP_AppSensor/CIE1"] [tag "PCI/6.5.2"]
[hostname "localhost"] [uri "/index.php"] [unique_id
"T3MEX8CoqAEAAWNHI4gAAAAE"]
[Wed Mar 28 08:30:23 2012] [error] [client 127.0.0.1] ModSecurity:
Warning. Pattern match
"\\\\b(?i:having)\\\\b\\\\s+(\\\\d{1,10}|'[^=]{1,10}')\\\\s*[=<>]|(?i:\\\\b
execute(\\\\s{1,5}[\\\\w\\\\.$]{1,5}\\\\s{0,3})?\\\\()|\\\\bhaving\\\\b
?(?:\\\\d{1,10}|[\\\\'\\"][^=]{1,10}[\\\\'\\"])
?[=<>]+|(?i:\\\\bcreate\\\\s+?table.{0,20}?\\\\()|(?i:\\\\blike\\\\W*?char\
\\\W*?\\\\()|(?i:(?:(select(.*) ..." at ARGS:id. [file
"/usr/local/apache/conf/crs/base_rules/modsecurity_crs_41_sql_injection_att
acks.conf"] [line "131"] [id "959070"] [rev "2.2.5"] [msg "SQL Injection
Attack"] [data "FROM information_schema.tables WHERE
TABLE_SCHEMA=\\x22blind_sqli\\x22 AND table_name REGEXP '^[a-z]' LIMIT"]
[severity "CRITICAL"] [tag "WEB_ATTACK/SQL_INJECTION"] [tag
"WASCTC/WASC-19"] [tag "OWASP_TOP_10/A1"] [tag "OWASP_AppSensor/CIE1"]
[tag "PCI/6.5.2"] [hostname "localhost"] [uri "/index.php"] [unique_id
"T3MEX8CoqAEAAWNHI4gAAAAE"]
[Wed Mar 28 08:30:23 2012] [error] [client 127.0.0.1] ModSecurity:
Warning. Pattern match
"(?i)\\\\b(?i:and)\\\\b\\\\s+(\\\\d{1,10}|'[^=]{1,10}')\\\\s*[=]|\\\\b(?i:a
nd)\\\\b\\\\s+(\\\\d{1,10}|'[^=]{1,10}')\\\\s*[<>]|\\\\band\\\\b
?(?:\\\\d{1,10}|[\\\\'\\"][^=]{1,10}[\\\\'\\"])
?[=<>]+|\\\\b(?i:and)\\\\b\\\\s+(\\\\d{1,10}|'[^=]{1,10}')" at ARGS:id.
[file
"/usr/local/apache/conf/crs/base_rules/modsecurity_crs_41_sql_injection_att
acks.conf"] [line "137"] [id "959072"] [rev "2.2.5"] [msg "SQL Injection
Attack"] [data "and 1="] [severity "CRITICAL"] [tag
"WEB_ATTACK/SQL_INJECTION"] [tag "WASCTC/WASC-19"] [tag "OWASP_TOP_10/A1"]
[tag "OWASP_AppSensor/CIE1"] [tag "PCI/6.5.2"] [hostname "localhost"] [uri
"/index.php"] [unique_id "T3MEX8CoqAEAAWNHI4gAAAAE"]
[Wed Mar 28 08:30:23 2012] [error] [client 127.0.0.1] ModSecurity:
Warning. Pattern match
"(?i:(?:(?:s(?:t(?:d(?:dev(_pop|_samp)?)?|r(?:_to_date|cmp))|u(?:b(?:str(?:
ing(_index)?)?|(?:dat|tim)e)|m)|e(?:c(?:_to_time|ond)|ssion_user)|ys(?:tem_
user|date)|ha(1|2)?|oundex|chema|ig?n|pace|qrt)|i(?:s(null|_(free_lock|ipv4
_compat|ipv4_mapped|ipv4|ipv ..." at ARGS:id. [file
"/usr/local/apache/conf/crs/base_rules/modsecurity_crs_41_sql_injection_att
acks.conf"] [line "144"] [id "959073"] [rev "2.2.5"] [msg "SQL Injection
Attack"] [data "SELECT 1 FROM information_schema.tables WHERE"] [severity
"CRITICAL"] [tag "WEB_ATTACK/SQL_INJECTION"] [tag "WASCTC/WASC-19"] [tag
"OWASP_TOP_10/A1"] [tag "OWASP_AppSensor/CIE1"] [tag "PCI/6.5.2"]
[hostname "localhost"] [uri "/index.php"] [unique_id
"T3MEX8CoqAEAAWNHI4gAAAAE"]
[Wed Mar 28 08:30:23 2012] [error] [client 127.0.0.1] ModSecurity:
Warning. Pattern match "\\\\W{4,}" at ARGS:id. [file
"/usr/local/apache/conf/crs/base_rules/modsecurity_crs_41_sql_injection_att
acks.conf"] [line "155"] [id "960024"] [rev "2.2.5"] [msg "SQL Character
Anomaly Detection Alert - Repetative Non-Word Characters"] [data " '^["]
[hostname "localhost"] [uri "/index.php"] [unique_id
"T3MEX8CoqAEAAWNHI4gAAAAE"]
[Wed Mar 28 08:30:23 2012] [error] [client 127.0.0.1] ModSecurity:
Warning. Pattern match
"([\\\\~\\\\!\\\\@\\\\#\\\\$\\\\%\\\\^\\\\&\\\\*\\\\(\\\\)\\\\-\\\\+\\\\=\\
\\{\\\\}\\\\[\\\\]\\\\|\\\\:\\\\;\\"\\\\'\\\\\\xc2\\xb4\\\\\\xe2\\x80\\x99\
\\\\\xe2\\x80\\x98\\\\`\\\\<\\\\>].*){4,}" at ARGS:id. [file
"/usr/local/apache/conf/crs/base_rules/modsecurity_crs_41_sql_injection_att
acks.conf"] [line "171"] [id "981173"] [rev "2.2.5"] [msg "Restricted SQL
Character Anomaly Detection Alert - Total # of special characters
exceeded"] [data ")"] [hostname "localhost"] [uri "/index.php"] [unique_id
"T3MEX8CoqAEAAWNHI4gAAAAE"]
[Wed Mar 28 08:30:23 2012] [error] [client 127.0.0.1] ModSecurity:
Warning. Pattern match
"(?i:(?:\\\\sexec\\\\s+xp_cmdshell)|(?:[\\"'`\\xc2\\xb4\\xe2\\x80\\x99\\xe2
\\x80\\x98]\\\\s*?!\\\\s*?[\\"'`\\xc2\\xb4\\xe2\\x80\\x99\\xe2\\x80\\x98\\\
\w])|(?:from\\\\W+information_schema\\\\W)|(?:(?:(?:current_)?user|database
|schema|connection_id)\\\\s*?\\\\([^\\\\)]*?)|(?:[\\"'`\\xc2\\xb4\\xe2
..." at ARGS:id. [file
"/usr/local/apache/conf/crs/base_rules/modsecurity_crs_41_sql_injection_att
acks.conf"] [line "219"] [id "981255"] [msg "Detects MSSQL code execution
and information gathering attempts"] [data "FROM information_schema."]
[severity "CRITICAL"] [tag "WEB_ATTACK/SQLI"] [hostname "localhost"] [uri
"/index.php"] [unique_id "T3MEX8CoqAEAAWNHI4gAAAAE"]
[Wed Mar 28 08:30:23 2012] [error] [client 127.0.0.1] ModSecurity:
Warning. Pattern match
"(?i:(?:,.*[)\\\\da-f\\"'`\\xc2\\xb4\\xe2\\x80\\x99\\xe2\\x80\\x98][\\"'`\\
xc2\\xb4\\xe2\\x80\\x99\\xe2\\x80\\x98](?:[\\"'`\\xc2\\xb4\\xe2\\x80\\x99\\
xe2\\x80\\x98].*?[\\"'`\\xc2\\xb4\\xe2\\x80\\x99\\xe2\\x80\\x98]|\\\\Z|[^\\
"'`\\xc2\\xb4\\xe2\\x80\\x99\\xe2\\x80\\x98]+))|(?:\\\\Wselect.+\\\\W*from)
|((?:s ..." at ARGS:id. [file
"/usr/local/apache/conf/crs/base_rules/modsecurity_crs_41_sql_injection_att
acks.conf"] [line "221"] [id "981257"] [msg "Detects MySQL
comment-/space-obfuscated injections and backtick termination"] [data
"(SELECT 1 FROM"] [severity "CRITICAL"] [tag "WEB_ATTACK/SQLI"] [hostname
"localhost"] [uri "/index.php"] [unique_id "T3MEX8CoqAEAAWNHI4gAAAAE"]
[Wed Mar 28 08:30:23 2012] [error] [client 127.0.0.1] ModSecurity:
Warning. Pattern match
"(?i:(?:@.+=\\\\s*?\\\\(\\\\s*?select)|(?:\\\\d+\\\\s*?(x?or|div|like|betwe
en|and)\\\\s*?\\\\d+\\\\s*?[\\\\-+])|(?:\\\\/\\\\w+;?\\\\s+(?:having|and|x?
or|div|like|between|and|select)\\\\W)|(?:\\\\d\\\\s+group\\\\s+by.+\\\\()|(
?:(?:;|#|--)\\\\s*?(?:drop|alter))|(?:(?:;|#|--)\\\\s*?(?:update|i ..." at
ARGS:id. [file
"/usr/local/apache/conf/crs/base_rules/modsecurity_crs_41_sql_injection_att
acks.conf"] [line "223"] [id "981248"] [msg "Detects chained SQL injection
attempts 1/2"] [data "and 1=("] [severity "CRITICAL"] [tag
"WEB_ATTACK/SQLI"] [hostname "localhost"] [uri "/index.php"] [unique_id
"T3MEX8CoqAEAAWNHI4gAAAAE"]
[Wed Mar 28 08:30:23 2012] [error] [client 127.0.0.1] ModSecurity:
Warning. Pattern match
"(?i:(?:union\\\\s*?(?:all|distinct|[(!@]*?)?\\\\s*?[([]*?\\\\s*?select)|(?
:\\\\w+\\\\s+like\\\\s+[\\"'`\\xc2\\xb4\\xe2\\x80\\x99\\xe2\\x80\\x98])|(?:
like\\\\s*?[\\"'`\\xc2\\xb4\\xe2\\x80\\x99\\xe2\\x80\\x98]\\\\%)|(?:[\\"'`\
\xc2\\xb4\\xe2\\x80\\x99\\xe2\\x80\\x98]\\\\s*?like\\\\W*?[\\"'`\\xc2\\xb4\
\xe2 ..." at ARGS:id. [file
"/usr/local/apache/conf/crs/base_rules/modsecurity_crs_41_sql_injection_att
acks.conf"] [line "235"] [id "981245"] [msg "Detects basic SQL
authentication bypass attempts 2/3"] [data "SELECT 1 FROM"] [severity
"CRITICAL"] [tag "WEB_ATTACK/SQLI"] [hostname "localhost"] [uri
"/index.php"] [unique_id "T3MEX8CoqAEAAWNHI4gAAAAE"]
[Wed Mar 28 08:30:23 2012] [error] [client 127.0.0.1] ModSecurity:
Warning. Pattern match
"(?i:(?:[\\"'`\\xc2\\xb4\\xe2\\x80\\x99\\xe2\\x80\\x98]\\\\s*?(x?or|div|lik
e|between|and)\\\\s*?[\\"'`\\xc2\\xb4\\xe2\\x80\\x99\\xe2\\x80\\x98]?\\\\d)
|(?:\\\\\\\\x(?:23|27|3d))|(?:^.?[\\"'`\\xc2\\xb4\\xe2\\x80\\x99\\xe2\\x80\
\x98]$)|(?:(?:^[\\"'`\\xc2\\xb4\\xe2\\x80\\x99\\xe2\\x80\\x98\\\\\\\\]*?(?:
[\\\\ ..." at ARGS:id. [file
"/usr/local/apache/conf/crs/base_rules/modsecurity_crs_41_sql_injection_att
acks.conf"] [line "249"] [id "981242"] [msg "Detects classic SQL injection
probings 1/2"] [data " information_schema"] [severity "CRITICAL"] [tag
"WEB_ATTACK/SQLI"] [hostname "localhost"] [uri "/index.php"] [unique_id
"T3MEX8CoqAEAAWNHI4gAAAAE"]
[Wed Mar 28 08:30:23 2012] [error] [client 127.0.0.1] ModSecurity:
Warning. Pattern match
"(?i:(?:[\\"'`\\xc2\\xb4\\xe2\\x80\\x99\\xe2\\x80\\x98]\\\\s*?\\\\*.+(?:x?o
r|div|like|between|and|id)\\\\W*?[\\"'`\\xc2\\xb4\\xe2\\x80\\x99\\xe2\\x80\
\x98]\\\\d)|(?:\\\\^[\\"'`\\xc2\\xb4\\xe2\\x80\\x99\\xe2\\x80\\x98])|(?:^[\
\\\w\\\\s\\"'`\\xc2\\xb4\\xe2\\x80\\x99\\xe2\\x80\\x98-]+(?<=and\\\\s)(?<=o
r|xor ..." at ARGS:id. [file
"/usr/local/apache/conf/crs/base_rules/modsecurity_crs_41_sql_injection_att
acks.conf"] [line "257"] [id "981243"] [msg "Detects classic SQL injection
probings 2/2"] [data "\\x22 AND table_name REGEXP '^[a-z]' LIMIT 0,1"]
[severity "CRITICAL"] [tag "WEB_ATTACK/SQLI"] [hostname "localhost"] [uri
"/index.php"] [unique_id "T3MEX8CoqAEAAWNHI4gAAAAE"]





On 3/28/12 2:18 AM, "Tzury Bar Yochay" <tzury.by at reguluslabs.com> wrote:

>Hi,
>
>below is an output of a small program I wrote to test sites protected
>by modSecurity
>I tried pushing in some SQL injection tests and was surprised to find
>out the following just passed through and not being blocked despite
>having all default rules active)
>
>test failed: GET --
>/index.php?id=1+and+1=(SELECT+1+FROM+information_schema.tables+WHERE+TABLE
>_SCHEMA="blind_sqli"+AND+table_name+REGEXP+'^[a-z]'+LIMIT+0,1)
>{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
>instead
>test failed: GET --
>/index.php?id=1+and+1=(SELECT+1+FROM+information_schema.tables++WHERE+TABL
>E_SCHEMA="blind_sqli"+AND+table_name+REGEXP+'^[a-n]'+LIMIT+0,1)
>{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
>instead
>test failed: GET --
>/index.php?id=1+and+1=(SELECT+1+FROM+information_schema.tables++WHERE+TABL
>E_SCHEMA="blind_sqli"+AND+table_name+REGEXP+'^[a-g]'+LIMIT+0,1)
>{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
>instead
>test failed: GET --
>/index.php?id=1+and+1=(SELECT+1+FROM+information_schema.tables++WHERE+TABL
>E_SCHEMA="blind_sqli"+AND+table_name+REGEXP+'^[h-n]'+LIMIT+0,1)
>{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
>instead
>test failed: GET --
>/index.php?id=1+and+1=(SELECT+1+FROM+information_schema.tables++WHERE+TABL
>E_SCHEMA="blind_sqli"+AND+table_name+REGEXP+'^[h-l]'+LIMIT+0,1)
>{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
>instead
>test failed: GET --
>/index.php?id=1+and+1=(SELECT+1+FROM+information_schema.tables++WHERE+TABL
>E_SCHEMA="blind_sqli"+AND+table_name+REGEXP+'^m'+LIMIT+0,1)
>{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
>instead
>test failed: GET --
>/index.php?id=1+and+1=(SELECT+1+FROM+information_schema.tables++WHERE+TABL
>E_SCHEMA="blind_sqli"+AND+table_name+REGEXP+'^n'+LIMIT+0,1)+
>{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
>instead
>test failed: GET --
>/index.php?id=1+and+1=(SELECT+1+FROM+information_schema.tables++WHERE+TABL
>E_SCHEMA="blind_sqli"+AND+table_name+REGEXP+'^n'+LIMIT+1,1)+
>{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
>instead
>test failed: GET --
>/default.asp?id=1+AND+1=(SELECT+TOP+1+1+FROM+information_schema.tables+WHE
>RE+TABLE_SCHEMA="blind_sqli"+and+table_name+LIKE+'[a-z]%'+)
>{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
>instead
>test failed: GET --
>/default.asp?id=1+AND+1=(SELECT+TOP+1+1+FROM+information_schema.tables+WHE
>RE+TABLE_SCHEMA="blind_sqli"+and+table_name+NOT+IN+(+SELECT+TOP+1+table_na
>me+FROM+information_schema.tables)+and+table_name+LIKE+'[a-z]%'+)
>{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
>instead
>test failed: GET --
>/index.php?id=1+and+1=(SELECT+1+FROM+users+WHERE+password+REGEXP+'^[a-f]'+
>AND+ID=1)
>{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
>instead
>test failed: GET --
>/index.php?id=1+and+1=(SELECT+1+FROM+users+WHERE+password+REGEXP+'^[0-9]'+
>AND+ID=1)
>{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
>instead
>test failed: GET --
>/index.php?id=1+and+1=(SELECT+1+FROM+users+WHERE+password+REGEXP+'^[0-4]'+
>AND+ID=1)
>{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
>instead
>test failed: GET --
>/index.php?id=1+and+1=(SELECT+1+FROM+users+WHERE+password+REGEXP+'^[5-9]'+
>AND+ID=1)
>{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
>instead
>test failed: GET --
>/index.php?id=1+and+1=(SELECT+1+FROM+users+WHERE+password+REGEXP+'^[5-7]'+
>AND+ID=1)
>{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
>instead
>test failed: GET --
>/index.php?id=1+and+1=(SELECT+1+FROM+users+WHERE+password+REGEXP+'^5'+AND+
>ID=1)
>{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
>instead
>test failed: GET --
>/default.asp?id=1+AND+1=(SELECT+1+FROM+users+WHERE+password+LIKE+'5[a-f]%'
>+AND+ID=1)
>{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
>instead
>test failed: GET --
>/default.asp?id=1+AND+1=(SELECT+1+FROM+users+WHERE+password+LIKE+'5[a-c]%'
>+AND+ID=1)
>{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
>instead
>test failed: GET --
>/default.asp?id=1+AND+1=(SELECT+1+FROM+users+WHERE+password+LIKE+'5[d-f]%'
>+AND+ID=1)
>{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
>instead
>test failed: GET --
>/default.asp?id=1+AND+1=(SELECT+1+FROM+users+WHERE+password+LIKE+'5[d-e]%'
>+AND+ID=1)
>{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
>instead
>test failed: GET --
>/default.asp?id=1+AND+1=(SELECT+1+FROM+users+WHERE+password+LIKE+'5f%'+AND
>+ID=1)
>{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
>instead
>test failed: GET --
>/http://example/article.asp?ID=2+union+all+select+name+from+sysobjects
>{}. Expected: <class 'requests.exceptions.ConnectionError'>, got 200
>instead
>test failed: GET -- /article.asp?ID=2'+and+1=1 {}. Expected: <class
>'requests.exceptions.ConnectionError'>, got 200 instead
>test failed: GET -- /article.asp?ID=2'+and+1=0+ {}. Expected: <class
>'requests.exceptions.ConnectionError'>, got 200 instead
>_______________________________________________
>Owasp-modsecurity-core-rule-set mailing list
>Owasp-modsecurity-core-rule-set at lists.owasp.org
>https://lists.owasp.org/mailman/listinfo/owasp-modsecurity-core-rule-set
>


This transmission may contain information that is privileged, confidential, and/or exempt from disclosure under applicable law. If you are not the intended recipient, you are hereby notified that any disclosure, copying, distribution, or use of the information contained herein (including any reliance thereon) is STRICTLY PROHIBITED. If you received this transmission in error, please immediately contact the sender and destroy the material in its entirety, whether in electronic or hard copy format.


From tzury.by at reguluslabs.com  Wed Mar 28 14:20:38 2012
From: tzury.by at reguluslabs.com (Tzury Bar Yochay)
Date: Wed, 28 Mar 2012 16:20:38 +0200
Subject: [Owasp-modsecurity-core-rule-set] Should not the following
 being blocked by default?
In-Reply-To: <CB987CCF.488A6%rbarnett@trustwave.com>
References: <CAL9DS1zR-Ti9d-YpV+hFmjGHyGJ3jKazTLmQD4ALVeNxZrvrpg@mail.gmail.com>
	<CB987CCF.488A6%rbarnett@trustwave.com>
Message-ID: <CAL9DS1yoD85dW43trburNmKX-JT0-GZmxyFHXL-Dp+8YpWXkbQ@mail.gmail.com>

> What CRS version are you using?
> How do you have the SecRuleEngine configured? ?Unless it is set to On, you
> can't rely upon returned status codes for detection.
> How have you activated the rules? ?Are you sure you have the
> modsecurity_crs_41_sql_injection_attacks.conf file activated?
>
> I tested your first payload against the latest CRS version and it
> triggered many SQLi alerts -

sorry for the fuss, that is totally my fault not being aware of a
broken symbolic linked file.
well, that is an opportunity to check out the crc_2.2.4 on the way.

thanks Ryan and keep up the good work!

From Mike.Owens at state.nm.us  Wed Mar 28 15:27:50 2012
From: Mike.Owens at state.nm.us (Owens, Mike, DoIT)
Date: Wed, 28 Mar 2012 15:27:50 +0000
Subject: [Owasp-modsecurity-core-rule-set] CRS 2.2.4 Rules 981220 and 981222
	Puzzle
Message-ID: <6BCDC45EEA955145BD59DFFC6C4E6DA21F059776@CEXMB001.nmes.lcl>

I have encountered a puzzle involving rules 981220 and 981222. The two rules are testing for the presence of a default charset being sent either in the Content-type response header or a meta tag in the response body. The rules themselves inspect the RESPONSE_CONTENT_TYPE (Apache internal area) rather than the Content-type header per se.

In my audit log, I have a case where the Content-type response header is "text/html; charset=utf-8", but the log entry reports that the RESPONSE_CONTENT_TYPE contains on "text/html". This causes the two rules to fire.

My question is, why does ModSecurity show a difference betweent the Content-type header and the RESPONSE_CONTENT_TYPE area?

Here's a typical audit log entry (identifying data replaced with "***"):

--4b594116-A--
[28/Mar/2012:09:02:46 --0600] T3MoFn8AAAEAACg91mkAAADM *** 30254 ***
--4b594116-B--
GET / HTTP/1.1
User-Agent: Mozilla/4.0 (compatible MSIE 6.0 Windows NT 5.1
Connection: close
Host: ***
Accept: text/html

--4b594116-F--
HTTP/1.1 200 OK
Last-Modified: Tue, 06 Oct 2009 14:45:37 GMT
ETag: "198-4754548896640"
Accept-Ranges: bytes
Content-Length: 408
Connection: close
Content-Type: text/html; charset=utf-8

--4b594116-H--
Message: Warning. Match of "rx (?i:(<meta.*?(content|value)=\"text/html;\\s?charset=|<\\?xml.*?encoding=))" against "RESPONSE_BODY" required. [file "/usr/local/apache/conf/site-conf/modsecurity/activated_rules/modsecurity_crs_55_application_defects.conf"] [line "23"] [id "981220"] [msg "[Watcher Check] No charset was specified in the HTTP Content-Type header nor the HTML content's meta tag."] [data "Content-Type Response Header: text/html"] [tag "WASCTC/WASC-15"] [tag "APP_DEFECT/MISCONFIGURATION"] [tag "http://code.google.com/p/browsersec/wiki/Part2#Content_handling_mechanisms"]
Message: Warning. Match of "rx (<meta.*?(content|value)=\"text/html;\\s?charset=utf-8|<\\?xml.*?encoding=\"utf-8\")" against "RESPONSE_BODY" required. [file "/usr/local/apache/conf/site-conf/modsecurity/activated_rules/modsecurity_crs_55_application_defects.conf"] [line "36"] [id "981222"] [msg "[Watcher Check]  The charset specified was not utf-8 in the HTTP Content-Type header nor the HTML content's meta tag."] [data "Content-Type Response Header: text/html"] [tag "WASCTC/WASC-15"] [tag "MISCONFIGURATION"] [tag "http://websecuritytool.codeplex.com/wikipage?title=Checks#charset-not-utf8"]
Stopwatch: 1332946966251284 24295 (- - -)
Stopwatch2: 1332946966251284 24295; combined=7754, p1=1161, p2=4497, p3=48, p4=298, p5=1545, sr=344, sw=205, l=0, gc=0
Producer: ModSecurity for Apache/2.6.5 (http://www.modsecurity.org/); core ruleset/2.2.4.
Server: 
Sanitised-Request-Headers: "Authorization".

--4b594116-Z--

My setup, in case that helps:

Red Hat Enterprise Linux; kernel 2.6.18-274.el5 #1 SMP Fri Jul 8 17:36:59 EDT 2011 x86_64 x86_64 x86_64 GNU/Linux
Apache 2.4.1
ModSecurity 2.6.5
ModSecurity CRS 2.2.4

--
Michael Owens <mike.owens at state.nm.us>


From joakim at astrocalc.com  Wed Mar 28 17:28:46 2012
From: joakim at astrocalc.com (Joakim Schramm)
Date: Wed, 28 Mar 2012 19:28:46 +0200
Subject: [Owasp-modsecurity-core-rule-set] CRS 2.2.4 Rules freaking out on
	Magento
In-Reply-To: <6BCDC45EEA955145BD59DFFC6C4E6DA21F059776@CEXMB001.nmes.lcl>
References: <6BCDC45EEA955145BD59DFFC6C4E6DA21F059776@CEXMB001.nmes.lcl>
Message-ID: <4F734A4E.6000203@astrocalc.com>

Hi!

I have a site running the Magento (1.6.2) shopping cart web frame and 
just myself accessing root of web triggers freaking 269 lines in the 
apache error log! It was 257 when I found out about it, but checking 
things I noticed there was an update of ModSecurity from 2.6.4 to 2.6.5 
and Rules from 2.2.3 to 2.2.4 but it just seem to have made it worse 
though. Interestingly though the logged error appears to be rather 
different from one version to the next 2.6.4/2.2.3 vs 2.6.5/2.2.4 while 
the web site remains the same.

rules 2.2.3 log can be found here: http://pastebin.com/uxDS7gP5

rules 2.2.4 log here: http://pastebin.com/SkHZXYBD

Nice if someone could explain how this can be, although of course I 
understand the rules have changed between the 2 releases. I also 
understand the reason for the huge amount of lines is because accessing 
the site triggers several request, but ModSec seam to snap at almost 
everything like, including image files, like a wind dog!

/Joakim

