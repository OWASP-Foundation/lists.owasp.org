<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-poland] No i mamy kolejny remote code execution w Struts2 ; )
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-poland%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-poland%5D%20No%20i%20mamy%20kolejny%20remote%20code%20execution%20w%0A%20Struts2%20%3B%20%29&In-Reply-To=%3CCAMopvkPAr_T%3D5h5_xfZJxNXcaEGCUcxNZ1Vn5S2iQ%2BetH8nyfQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000189.html">
   <LINK REL="Next"  HREF="000190.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-poland] No i mamy kolejny remote code execution w Struts2 ; )</H1>
    <B>&#321;ukasz Lenart</B> 
    <A HREF="mailto:owasp-poland%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-poland%5D%20No%20i%20mamy%20kolejny%20remote%20code%20execution%20w%0A%20Struts2%20%3B%20%29&In-Reply-To=%3CCAMopvkPAr_T%3D5h5_xfZJxNXcaEGCUcxNZ1Vn5S2iQ%2BetH8nyfQ%40mail.gmail.com%3E"
       TITLE="[Owasp-poland] No i mamy kolejny remote code execution w Struts2 ; )">lukasz.lenart at googlemail.com
       </A><BR>
    <I>Wed Jan 25 08:02:36 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="000189.html">[Owasp-poland] No i mamy kolejny remote code execution w Struts2 ; )
</A></li>
        <LI>Next message: <A HREF="000190.html">[Owasp-poland] Zaproszenie na konferencj&#281; SEMAFOR 2012
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#191">[ date ]</a>
              <a href="thread.html#191">[ thread ]</a>
              <a href="subject.html#191">[ subject ]</a>
              <a href="author.html#191">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Odbieram to jako drobn&#261; z&#322;o&#347;liwo&#347;&#263; ;-) Jednak ta sama osoba zg&#322;osi&#322;a
nam ten i jeden z poprzednich b&#322;&#281;d&#243;w - bardzo podobny, wi&#281;c sama nie
by&#322;a go w stanie wykry&#263; wcze&#347;niej ;-)

Pozytywem, kt&#243;ry jest dla mnie istotny to wewn&#281;trzna procedura, kt&#243;ra
zosta&#322; przetestowana dwa razy pod rz&#261;d i naprawienie istotnych b&#322;&#281;d&#243;w
bezpiecze&#324;stwa zaj&#281;&#322;o ok 1 miesi&#261;ca na ka&#380;dy bez z&#322;amania wstecznej
komaptybilno&#347;ci. W przypadku ostatniego b&#322;&#281;du zosta&#322;a zmodyfikowana
r&#243;wnie&#380; biblioteka OGNL aby zapobiega&#263; ewaluacji wielu wyra&#380;e&#324;
r&#243;wnocze&#347;nie w jednym wyra&#380;eniu. To nie tylko zmiana akceptowalnych
prarametr&#243;w, cho&#263; dla wi&#281;kszo&#347;ci projekt&#243;w mo&#380;e to by&#263; najprostsze
rozwi&#261;zanie, pozby&#263; si&#281; bia&#322;ych znak&#243;w i nawias&#243;w ;-)


Pozdrawiam
--
&#321;ukasz
Mobile +48 606 323 122
Office +27 11 0838747
<A HREF="http://www.lenart.org.pl/">http://www.lenart.org.pl/</A>
Warszawa JUG conference - Confitura <A HREF="http://confitura.pl/">http://confitura.pl/</A>


W dniu 24 stycznia 2012 17:54 u&#380;ytkownik Slawomir Jasek
&lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-poland">slawek at securing.pl</A>&gt; napisa&#322;:
&gt;<i>
</I>&gt;<i> W&#322;a&#347;nie wysz&#322;a kolejna poprawka do Struts2, na ten sam b&#322;&#261;d o kt&#243;rym
</I>&gt;<i> m&#243;wi&#322;em w prezentacji. Zgodnie z ponurym przeczuciem &#380;e to jeszcze nie
</I>&gt;<i> koniec, niechlubny przyk&#322;ad w dziale &quot;Fix Timelines&quot; dorobi&#322; si&#281; wi&#281;c
</I>&gt;<i> kolejnej poprawki, kt&#243;r&#261; wypada&#322;oby tam oznaczy&#263; &quot;Fix #6&quot; ;)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Co prawda w poprzedniej poprawce dopuszczalne znaki w nazwach parametr&#243;w
</I>&gt;<i> zosta&#322;y ograniczone, jednak ca&#322;y czas mo&#380;liwe jest wstawianie nawias&#243;w
</I>&gt;<i> (). I te znaki zosta&#322;y wykorzystane tym razem.
</I>&gt;<i> Ot&#243;&#380; w OGNL-u kod (aaa)(bbb) oznacza, &#380;e &quot;aaa&quot; zostanie rekursywnie
</I>&gt;<i> zinterpretowane jako wyra&#380;enie (dzi&#281;ki tzw. &quot;expression evaluation&quot;). Co
</I>&gt;<i> prawda nie mo&#380;emy przes&#322;a&#263; wprost w miejsce &quot;aaa&quot; w nazwie parametru
</I>&gt;<i> kodu OGNL - bo blokuj&#261; nas znaki specjalne, mo&#380;emy jednak go ustawi&#263; w
</I>&gt;<i> warto&#347;ci, a nie w nazwie, dodatkowego parametru przes&#322;anego do aplikacji.
</I>&gt;<i>
</I>&gt;<i> Przyk&#322;adowy exploit b&#281;dzie mia&#322; wi&#281;c posta&#263;:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> /myaction?aaa=&lt;kod OGNL&gt;&amp;(aaa)('bbb')=
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> a praktyczne wykonanie dowolnego kodu na serwerze b&#281;dzie si&#281; tylko
</I>&gt;<i> nieznacznie r&#243;&#380;ni&#263; od tego co pokaza&#322;em na filmiku w prezentacji.
</I>&gt;<i> Czyli w warto&#347;ci aaa= przekazujemy payload, kt&#243;ry wykona si&#281; podczas
</I>&gt;<i> ewaluowania jako OGNL nazwy parametru &quot;(aaa)('bbb')&quot;.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Przy okazji - ja w celu sprawdzenia z zewn&#261;trz czy aplikacja jest
</I>&gt;<i> podatna, zamiast wykonywa&#263; inwazyjn&#261; komend&#281; na serwerze, przechwytuj&#281;
</I>&gt;<i> httpResponse w serwlecie, i zmuszam go do zwr&#243;cenia kodu b&#322;&#281;du, np.
</I>&gt;<i> sendError(413). W ten spos&#243;b od razu w przegl&#261;darce wiem czy exploit
</I>&gt;<i> zadzia&#322;a&#322;, a na serwerze nie wykonuj&#281; nic w shellu ;)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Obej&#347;ciem problemu, zamiast bolesnej aktualizacji, mo&#380;e by&#263; odpowiednie
</I>&gt;<i> ustawienie parametru konfiguracyjnego Struts: acceptParamNames. &#379;eby
</I>&gt;<i> obs&#322;u&#380;y&#263; grudniowe podatno&#347;ci nale&#380;y wyrzuci&#263; z niego &quot;bia&#322;e znaki&quot;, a
</I>&gt;<i> teraz jeszcze dodatkowo specjalnie potraktowa&#263; nawiasy. W niekt&#243;rych
</I>&gt;<i> instalacjach mo&#380;e to troch&#281; napsu&#263;, ale da si&#281; problem rozwi&#261;za&#263;.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Poni&#380;ej kr&#243;tka historia jak si&#281; zmienia&#322;y dopuszczalne znaki w nazwie
</I>&gt;<i> parametru:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Struts do 2.3.1 - poprawka wprowadzona w 2010 r. ze wzgl&#281;du na
</I>&gt;<i> CVE-2010-1870:
</I>&gt;<i>
</I>&gt;<i> private String acceptedParamNames = &quot;[a-zA-Z0-9\\.\\]\\[\\(\\)_'\\s]+&quot;;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Struts 2.3.1.1 poprawka 25 grudnia 2011 ze wzgl&#281;du na
</I>&gt;<i> <A HREF="https://www.sec-consult.com/files/20120104-0_Apache_Struts2_Multiple_Critical_Vulnerabilities.txt">https://www.sec-consult.com/files/20120104-0_Apache_Struts2_Multiple_Critical_Vulnerabilities.txt</A>
</I>&gt;<i>
</I>&gt;<i> private String acceptedParamNames = &quot;[a-zA-Z0-9\\.\\]\\[\\(\\)_']+&quot;;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Struts 2.3.1.2 poprawka 22 stycznia 2012 na CVE-2011-3923
</I>&gt;<i>
</I>&gt;<i> private String acceptedParamNames =
</I>&gt;<i> &quot;\\w+((\\.\\w+)|(\\[\\d+\\])|(\\(\\d+\\))|(\\['\\w+'\\])|(\\('\\w+'\\)))*&quot;;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Ciekawe co jeszcze da si&#281; tutaj wykombinowa&#263; i czy b&#281;dzie nast&#281;pny fix ;)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Wi&#281;cej informacji:
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://blog.o0o.nu/2012/01/cve-2011-3923-yet-another-struts2.html">http://blog.o0o.nu/2012/01/cve-2011-3923-yet-another-struts2.html</A>
</I>&gt;<i> <A HREF="https://cwiki.apache.org/confluence/display/WW/S2-009">https://cwiki.apache.org/confluence/display/WW/S2-009</A>
</I>&gt;<i> CVE: CVE-2011-3923
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> pozdrawiam
</I>&gt;<i> S&#322;awek
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Owasp-poland mailing list
</I>&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-poland">Owasp-poland at lists.owasp.org</A>
</I>&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-poland">https://lists.owasp.org/mailman/listinfo/owasp-poland</A>
</I></PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000189.html">[Owasp-poland] No i mamy kolejny remote code execution w Struts2 ; )
</A></li>
	<LI>Next message: <A HREF="000190.html">[Owasp-poland] Zaproszenie na konferencj&#281; SEMAFOR 2012
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#191">[ date ]</a>
              <a href="thread.html#191">[ thread ]</a>
              <a href="subject.html#191">[ subject ]</a>
              <a href="author.html#191">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-poland">More information about the Owasp-poland
mailing list</a><br>
</body></html>
