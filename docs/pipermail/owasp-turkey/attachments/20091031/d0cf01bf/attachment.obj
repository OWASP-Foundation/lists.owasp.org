#!/usr/bin/env python
import string
import httplib,sys
from socket import *
import re
import getopt

print "\n*************************************"
print "*FileHarvester Ver. 0.1               *"
print "*Coded by d3nx                        *"
print "*deniz@biznet.com.tr                  *"
print "*************************************\n\n"

global word
global w
global result
result =[]

def usage():
 print "Usage: theharvester options \n"
 print "       -d: filetype will be extracted\n"
 print "       -l: number of results" 
 print "\nExamples:./fileharvester.py -d mdb -l 500\n" 

def resultcount(w):
                h = httplib.HTTP('www.google.com')
                h.putrequest('GET',"/search?hl=en&btnG=Ara&meta=&aq=f&oq=&q=filetype%3A"+w)
                h.putheader('Host', 'www.google.com')
                h.putheader('User-agent', 'Internet Explorer 9.0 ')
                h.endheaders()
                returncode, returnmsg, headers = h.getreply()
                data=h.getfile().read()
                r1 = re.compile('about <b>[0123456789,]*</b> for')
                result = r1.findall(data)
                for x in result:
                                clean = re.sub(' <b>','',x)
                                clean = re.sub('</b> ','',clean)
                                clean = re.sub('about','',clean)
                                clean = re.sub('for','',clean)
                                clean = re.sub(',','',clean)
                                clean = re.sub('from','',clean)
                return clean

def run(w,i):
        h = httplib.HTTP('www.google.com')
        h.putrequest('GET',"/search?num=100&start="+str(i)+"&hl=en&btnG=Ara&meta=&aq=f&oq=&q=filetype%3A"+w)
        h.putheader('Host', 'www.google.com')
        h.putheader('User-agent', 'Internet Explorer 9.0 ')
        h.endheaders()
        returncode, returnmsg, headers = h.getreply()
        data=h.getfile().read()
        data=re.sub('<b>','',data)
        for e in ('>',':','=','<','/','\\',';'):
                data = string.replace(data,e,' ')
        r1 = re.compile('[a-zA-Z0-9-_]*'+'.'+w)
        res = r1.findall(data) 
        return res 

def test(argv):
        global limit
        limit = 100
        if len(sys.argv) < 4:
                usage() 
                sys.exit()
        try :
               opts, args = getopt.getopt(argv,"l:d:")
 
        except getopt.GetoptError:
                usage()
                sys.exit()

        for opt,arg in opts :
                if opt == '-l' :
                        limit=int(arg)
                elif opt == '-d' :
                        word=arg
        total = int(resultcount(word))
        print "Total results: ",total
        cant = 0
        if total < limit:
                        limit=total
        print "Limit: ",limit
        while cant < limit:
                print "Searching results: " + str(cant) +"\r"
                res = run(word,cant)
                for x in res:
                        if result.count(x) == 0:
                                result.append(x)
                cant+=100

        print "\nFilenames          :"
        print "====================\n"
        t=0
        for x in result:
                x= re.sub('<li class="first">','',x)
                x= re.sub('</li>','',x)
                print x
                t+=1
        print "====================\n"
        print "Total results: ",t

if __name__ == "__main__":
        try: test(sys.argv[1:])
        except KeyboardInterrupt:
                print "Search interrupted by user.."
        except:
                sys.exit()