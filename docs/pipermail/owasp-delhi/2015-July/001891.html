<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [OWASP-Delhi] Anti-CSRF token in cookie and post form
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-delhi%40lists.owasp.org?Subject=Re%3A%20%5BOWASP-Delhi%5D%20Anti-CSRF%20token%20in%20cookie%20and%20post%20form&In-Reply-To=%3CCAG-UC%3D3JNt_gQxrtqSAH08sy86HhJcP3T91f65voGnb6eEAGkw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001889.html">
   <LINK REL="Next"  HREF="001892.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[OWASP-Delhi] Anti-CSRF token in cookie and post form</H1>
    <B>reuben kurien</B> 
    <A HREF="mailto:owasp-delhi%40lists.owasp.org?Subject=Re%3A%20%5BOWASP-Delhi%5D%20Anti-CSRF%20token%20in%20cookie%20and%20post%20form&In-Reply-To=%3CCAG-UC%3D3JNt_gQxrtqSAH08sy86HhJcP3T91f65voGnb6eEAGkw%40mail.gmail.com%3E"
       TITLE="[OWASP-Delhi] Anti-CSRF token in cookie and post form">reubengkurien at gmail.com
       </A><BR>
    <I>Tue Jul  7 18:42:38 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="001889.html">[OWASP-Delhi] Anti-CSRF token in cookie and post form
</A></li>
        <LI>Next message: <A HREF="001892.html">[OWASP-Delhi] Anti-CSRF token in cookie and post form
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1891">[ date ]</a>
              <a href="thread.html#1891">[ thread ]</a>
              <a href="subject.html#1891">[ subject ]</a>
              <a href="author.html#1891">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Vaibhav,

In your case, you only need to match token A with token B in the same
request. Now I understand that you cannot control the token A value in the
cookie, but can control the token B value  in the post form.

Actually you need not control token A. You just need a mechanism to know
what is the value of token A that is currently being sent by the browser to
the server (assuming it is not per request, but per session or worse, valid
for a preset period of time). For this you'll require to be able to execute
Xss on the cookie (i.e., without httponly flag), predict or &quot;fix&quot; the
cookie value. Alternatively, assuming the &quot;secure&quot; flag is not set for this
particular cookie, it may be possible to make the user click on a http url
of the app(using social engineering) which will make the browser send
currently valid cookie values in clear text over the wire. At this point an
attacker who can sniff traffic can obtain the cookie. If your application
is already running on HTTP, then you need not bother with the above methods
since you have greater problems at hand than CSRF. :-)

Now, whether these things are possible in your scenario was not clear to me
from your description. Hope this helps.

Regards,
Reuben
Apologies for not being clear at first place. I'll give it another shot :-)

The application has a Anti-CSRF token checking mechanism in which it is
just checking if the Anti-CSRF token sent in POST request is the same as
present in the cookie value being sent in the same POST request.

Now, since the application is not checking if the Anti-CSRF token presented
in the POST request is the same as what was set earlier, it is viewed as
vulnerable.

For creating a valid CSRF poc, I need to craft a POST request in which the
form has a Anti-CSRF token (may be '123') and I need to send the same
Anti-CSRF token in the cookie value.

Problem with creating this CSRF poc is, that HTML/JS code can not send
 cookies to the server due to the restriction in JavaScript (they are just
auto sent by browser itself).

Any way to create a working exploit?

On Sun, Jul 5, 2015 at 2:22 AM, Pankaj Upadhyay &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-delhi">mr.p.upadhyay at gmail.com</A>&gt;
wrote:

&gt;<i> A lot of web applications keep session-cookie as secure and other cookies
</I>&gt;<i> as it is. If that is the scenario, adversary will be able to sniff the
</I>&gt;<i> cookie and get the CSRF Token.
</I>&gt;<i>
</I>&gt;<i> &quot;Now the problem is that we can not manipulate cookie value with
</I>&gt;<i> Javascript &quot;
</I>&gt;<i>
</I>&gt;<i> I didn't understand the above statement. Are you saying that this cookie
</I>&gt;<i> has Httponly attribute set?
</I>&gt;<i>
</I>&gt;<i> Thanks
</I>&gt;<i> Pankaj
</I>&gt;<i>
</I>&gt;<i> On Saturday, July 4, 2015, Vaibhav Gupta &lt;<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-delhi">vaibhav12jan at gmail.com</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Hello all,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I recently encountered an application which was having its random
</I>&gt;&gt;<i> anti-csrf token in cookie and the same random token was sent in the POST
</I>&gt;&gt;<i> form. If I tamper the cookie and the post form anti-CSRF token with the
</I>&gt;&gt;<i> same value, server will validate my request.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Example:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> POST /account/delete
</I>&gt;&gt;<i> HOST: XYZ
</I>&gt;&gt;<i> Cookie: CSRF_Token=123456
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> account_id=10101&amp;CSRF_Token=123456
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Now the problem is that we can not manipulate cookie value with
</I>&gt;&gt;<i> Javascript and hence cannot fiddle with the anti-csrf token present in
</I>&gt;&gt;<i> cookie. Is there a way to create a working exploit?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Apologies if I am unable to clear the scenario.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks
</I>&gt;&gt;<i> Vaibhav
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Sent from MI3
</I>&gt;<i>
</I>

_______________________________________________
OWASP-Delhi mailing list
<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-delhi">OWASP-Delhi at lists.owasp.org</A>
<A HREF="https://lists.owasp.org/mailman/listinfo/owasp-delhi">https://lists.owasp.org/mailman/listinfo/owasp-delhi</A>
LinkedIn Group: <A HREF="https://www.linkedin.com/groups?gid=89270">https://www.linkedin.com/groups?gid=89270</A>
Twitter: <A HREF="https://twitter.com/OWASPdelhi">https://twitter.com/OWASPdelhi</A>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.owasp.org/pipermail/owasp-delhi/attachments/20150708/ed374253/attachment.html">http://lists.owasp.org/pipermail/owasp-delhi/attachments/20150708/ed374253/attachment.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001889.html">[OWASP-Delhi] Anti-CSRF token in cookie and post form
</A></li>
	<LI>Next message: <A HREF="001892.html">[OWASP-Delhi] Anti-CSRF token in cookie and post form
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1891">[ date ]</a>
              <a href="thread.html#1891">[ thread ]</a>
              <a href="subject.html#1891">[ subject ]</a>
              <a href="author.html#1891">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-delhi">More information about the OWASP-Delhi
mailing list</a><br>
</body></html>
