<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-csrfguard] Issue : &quot;error:request token does not match page	token&quot;
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-csrfguard%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-csrfguard%5D%20Issue%20%3A%20%22error%3Arequest%20token%20does%20not%20match%20page%0A%09token%22&In-Reply-To=%3CCA%2Bo4hff5R5dW%3DxEZhKfMkTzrMgSPOwnf2999iupdamoZe-SvCQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="000346.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-csrfguard] Issue : &quot;error:request token does not match page	token&quot;</H1>
    <B>Byron</B> 
    <A HREF="mailto:owasp-csrfguard%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-csrfguard%5D%20Issue%20%3A%20%22error%3Arequest%20token%20does%20not%20match%20page%0A%09token%22&In-Reply-To=%3CCA%2Bo4hff5R5dW%3DxEZhKfMkTzrMgSPOwnf2999iupdamoZe-SvCQ%40mail.gmail.com%3E"
       TITLE="[Owasp-csrfguard] Issue : &quot;error:request token does not match page	token&quot;">dbyron at gmail.com
       </A><BR>
    <I>Thu May 11 12:05:44 UTC 2017</I>
    <P><UL>
        
        <LI>Next message: <A HREF="000346.html">[Owasp-csrfguard] Issue : &quot;error:request token does not match	page token&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#345">[ date ]</a>
              <a href="thread.html#345">[ thread ]</a>
              <a href="subject.html#345">[ subject ]</a>
              <a href="author.html#345">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

We implemented the OWASP CSRFGuard 3.1.0 solution in a webapplication
running in a Eclipse IDE with liberty profile  and we are having a false
positive CSRF Attack detected when clicking on a &quot;back&quot; button, this button
calls a javascript function that sets the form.action value and executes
the form.submit();

This is the javascript function:
----------------------------------------------------------------------------------------------------------------------
function goToSearch(action) {
var form = document.forms[0];
form.Method.value = 'goToSearch';
form.actionNavigate.value = 'goToSearch';
form.action = action
form.submit();
}
----------------------------------------------------------------------------------------------------------------------


The form.action value when submiting is :
----------------------------------------------------------------------------------------------------------------------
http_//
10.40.206.78:9086/WEBPROYECT/OperationLogAction.do?OWASP_CSRFTOKEN=ZGY3-ETDN-OPT6-PNPX-WWA4-S6P8-TNC6-ZTDP
&quot;
----------------------------------------------------------------------------------------------------------------------


The application works with no CSRF errors in other use cases through
several pages, most of all are querying actions and displaying a table with
records.

There is another &quot;back&quot; button in the last page of the application and
clicking this button there is no CSRF error. This button submits the same
form in the application.

Javascript function:
----------------------------------------------------------------------------------------------------------------------
function goBack() {
var form = document.forms[0];
form.Method.value = 'goBack';
form.actionNavigate.value = 'goBack';
form.submit();
}
----------------------------------------------------------------------------------------------------------------------


This back button is inside this &lt;h:form&gt;:
----------------------------------------------------------------------------------------------------------------------

&lt;html:form action=&quot;DetailLogAction&quot; method=&quot;post&quot;&gt;
                  &lt;input type=&quot;hidden&quot; name=&quot;&lt;csrf:tokenname/&gt;&quot;
 value=&quot;&lt;csrf:tokenvalue uri=&quot;DetailLogAction&quot;/&gt;&quot; /&gt;
----------------------------------------------------------------------------------------------------------------------


And the back button calls the &lt;h:form&gt; in the previous page that has the
following code:
----------------------------------------------------------------------------------------------------------------------
&lt;html:form action=&quot;OperationLogAction&quot; method=&quot;post&quot;&gt;
                  &lt;input type=&quot;hidden&quot; name=&quot;&lt;csrf:tokenname/&gt;&quot;
 value=&quot;&lt;csrf:tokenvalue uri=&quot;OperationLogAction&quot;/&gt;&quot; /&gt;

----------------------------------------------------------------------------------------------------------------------



The next block is the BurpSuite Intercepted POST that is captured:
----------------------------------------------------------------------------------------------------------------------
POST
/WEBPROYECT/OperationLogAction.do?OWASP_CSRFTOKEN=ZGY3-ETDN-OPT6-PNPX-WWA4-S6P8-TNC6-ZTDP
HTTP/1.1
Accept: text/html, application/xhtml+xml, */*
Referer: <A HREF="http://10.40.206.78:9086/WEBPROYECT/DetailLogAction.do">http://10.40.206.78:9086/WEBPROYECT/DetailLogAction.do</A>
Accept-Language: es-ES
User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like
Gecko
Content-Type: application/x-www-form-urlencoded
Host: 10.40.206.78:9086
Content-Length: 260
Pragma: no-cache
Cookie:
JSESSIONID=0000cy9DmOFLqoZQAgsj-9fcAzl:0d1334c5-0c6e-44da-b0c8-369cc6057789
Connection: close

OWASP_CSRFTOKEN=OXG1-DOUN-ZT79-BT9E-TOTJ-CEWV-RV4H-7S0P&amp;stAccion=&amp;stSeleccion=&amp;Method=goToSearch&amp;selectedKey=2017-05-11-02.15.53.345444&amp;cambioSeleccion=false&amp;actionNavigate=goToSearch&amp;goBack=&amp;OWASP_CSRFTOKEN=ZGY3-ETDN-OPT6-PNPX-WWA4-S6P8-TNC6-ZTDP
----------------------------------------------------------------------------------------------------------------------


And this is the error show in the console after the intercept action is
released , showing the false positive:
----------------------------------------------------------------------------------------------------------------------
ADVERTENCIA] isValidRequest 3 -
tokenFromSession:OXG1-DOUN-ZT79-BT9E-TOTJ-CEWV-RV4H-7S0P
[ADVERTENCIA] tokenFromSession:OXG1-DOUN-ZT79-BT9E-TOTJ-CEWV-RV4H-7S0P ,
tokenFromRequest: ZGY3-ETDN-OPT6-PNPX-WWA4-S6P8-TNC6-ZTDP, tokenFromPages
0R3Q-9T8B-63NJ-5F63-V3T4-CXR7-NQKM-L74F , pageTokens:
 {/WEBPROYECT/DetailLogAction.do=ZGY3-ETDN-OPT6-PNPX-WWA4-S6P8-TNC6-ZTDP,
/WEBPROYECT/OperationLogAction.do=0R3Q-9T8B-63NJ-5F63-V3T4-CXR7-NQKM-L74F}
[ADVERTENCIA] potential cross-site request forgery (CSRF) attack thwarted
(user:&lt;anonymous&gt;, ip:10.40.206.78, method:POST,
uri:/WEBPROYECT/OperationLogAction.do, error:request token does not match
page token)
----------------------------------------------------------------------------------------------------------------------


I think that the problem might be going back from one form to a different
one, each form has a different &quot;tokenperpage&quot; asigned.

&#191;Any ideas why the CSRFGuard is giving this false positive.?

Thank you.

Best regards.

----------------------------------------------------------------------------------------------------------------------
More information :

The following are the &quot;csrfguard.properties&quot; and the &quot;web.xml&quot; files:

&quot;csrfguard.properties&quot; configuration:
----------------------------------------------------------------------------------------------------------------------
org.owasp.csrfguard.Enabled = true
org.owasp.csrfguard.ValidateWhenNoSessionExists = true
org.owasp.csrfguard.ProtectedMethods=POST,PUT,DELETE
org.owasp.csrfguard.TokenPerPage=true
org.owasp.csrfguard.TokenPerPagePrecreate=false
org.owasp.csrfguard.Ajax=true
org.owasp.csrfguard.unprotected.Error=../html/CSRF_error.html
org.owasp.csrfguard.action.Log=org.owasp.csrfguard.action.Log
org.owasp.csrfguard.action.Log.Message=potential cross-site request forgery
(CSRF) attack thwarted (user:%user%, ip:%remote_ip%,
method:%request_method%, uri:%request_uri%, error:%exception_message%)
org.owasp.csrfguard.action.Invalidate=org.owasp.csrfguard.action.Invalidate
org.owasp.csrfguard.action.Redirect=org.owasp.csrfguard.action.Redirect
org.owasp.csrfguard.action.Redirect.Page=../html/CSRF_error.html
org.owasp.csrfguard.SessionKey=OWASP_CSRFTOKEN
org.owasp.csrfguard.TokenLength=32
org.owasp.csrfguard.PRNG=SHA1PRNG
org.owasp.csrfguard.PRNG.Provider=SUN
org.owasp.csrfguard.Config.Print = true
org.owasp.csrfguard.JavascriptServlet.sourceFile =
org.owasp.csrfguard.JavascriptServlet.domainStrict = true
org.owasp.csrfguard.JavascriptServlet.cacheControl = private, maxage=28800
org.owasp.csrfguard.JavascriptServlet.refererPattern = .*
org.owasp.csrfguard.JavascriptServlet.refererMatchDomain = true
org.owasp.csrfguard.JavascriptServlet.injectIntoForms = true
org.owasp.csrfguard.JavascriptServlet.injectGetForms = false
org.owasp.csrfguard.JavascriptServlet.injectIntoAttributes = false
org.owasp.csrfguard.JavascriptServlet.xRequestedWith = OWASP CSRFGuard
Project
org.owasp.csrfguard.configOverlay.hierarchy =
classpath:csrfguard.properties, classpath:Owasp.CsrfGuard.overlay.properties
----------------------------------------------------------------------------------------------------------------------

And the web.xml csrf added features:
----------------------------------------------------------------------------------------------------------------------

&lt;!-- CSRF Filter --&gt;
&lt;filter&gt;
 &lt;filter-name&gt;CSRFGuardFilter&lt;/filter-name&gt;
 &lt;filter-class&gt;org.owasp.csrfguard.CsrfGuardFilter&lt;/filter-class&gt;
&lt;/filter&gt;
&lt;filter-mapping&gt;
 &lt;filter-name&gt;CSRFGuardFilter&lt;/filter-name&gt;
 &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
&lt;/filter-mapping&gt;
&lt;!-- CSRF Filter mapping --&gt;
&lt;!-- CSRF Listener--&gt;
&lt;listener&gt;
 &lt;listener-class&gt;
   org.owasp.csrfguard.CsrfGuardServletContextListener
 &lt;/listener-class&gt;
&lt;/listener&gt;
&lt;listener&gt;
 &lt;listener-class&gt;
   org.owasp.csrfguard.CsrfGuardHttpSessionListener
 &lt;/listener-class&gt;
&lt;/listener&gt;
&lt;context-param&gt;
 &lt;param-name&gt;Owasp.CsrfGuard.Config&lt;/param-name&gt;
 &lt;param-value&gt;WEB-INF/csrfguard.properties&lt;/param-value&gt;
&lt;/context-param&gt;
&lt;context-param&gt;
 &lt;param-name&gt;Owasp.CsrfGuard.Config.Print&lt;/param-name&gt;
 &lt;param-value&gt;false&lt;/param-value&gt;
&lt;/context-param&gt;

&lt;!-- CSRF JavaScript Servlet / CSRF Ajax support --&gt;
&lt;servlet&gt;
    &lt;servlet-name&gt;JavaScriptServlet&lt;/servlet-name&gt;
    &lt;servlet-class&gt;
        org.owasp.csrfguard.servlet.JavaScriptServlet
    &lt;/servlet-class&gt;
    &lt;init-param&gt;
        &lt;param-name&gt;source-file&lt;/param-name&gt;
     &lt;param-value&gt;&lt;/param-value&gt;
    &lt;/init-param&gt;
    &lt;init-param&gt;
        &lt;param-name&gt;inject-into-forms&lt;/param-name&gt;
        &lt;param-value&gt;true&lt;/param-value&gt;
    &lt;/init-param&gt;
    &lt;init-param&gt;
        &lt;param-name&gt;inject-into-attributes&lt;/param-name&gt;
        &lt;param-value&gt;false&lt;/param-value&gt;
    &lt;/init-param&gt;
    &lt;init-param&gt;
        &lt;param-name&gt;domain-strict&lt;/param-name&gt;
        &lt;param-value&gt;false&lt;/param-value&gt;
    &lt;/init-param&gt;
    &lt;init-param&gt;
&lt;param-name&gt;x-requested-with&lt;/param-name&gt;
 &lt;param-value&gt;OWASP CSRFGuard Project&lt;/param-value&gt;
&lt;/init-param&gt;
&lt;/servlet&gt;
&lt;!-- CSRF JavaScript Servlet --&gt;
&lt;servlet-mapping&gt;
    &lt;servlet-name&gt;JavaScriptServlet&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/JavaScriptServlet&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;
----------------------------------------------------------------------------------------------------------------------
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.owasp.org/pipermail/owasp-csrfguard/attachments/20170511/f5c35d9a/attachment-0001.html">http://lists.owasp.org/pipermail/owasp-csrfguard/attachments/20170511/f5c35d9a/attachment-0001.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message: <A HREF="000346.html">[Owasp-csrfguard] Issue : &quot;error:request token does not match	page token&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#345">[ date ]</a>
              <a href="thread.html#345">[ thread ]</a>
              <a href="subject.html#345">[ subject ]</a>
              <a href="author.html#345">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-csrfguard">More information about the Owasp-csrfguard
mailing list</a><br>
</body></html>
