From Nicholas.Athie at kcc.usda.gov  Mon May  7 16:25:31 2012
From: Nicholas.Athie at kcc.usda.gov (Athie, Nicholas - FSA, Kansas City, MO)
Date: Mon, 7 May 2012 16:25:31 +0000
Subject: [Owasp-csrfguard] IllegalStateExceptions caused by using the
	Invalidate action
Message-ID: <3BBDB0F64DC86549AC8D097839EA5457DE1159@001FSN2MPN1-022.001f.mgd2.msft.net>

Whenever I try to use the Invalidate Actions, I get an IllegalStateException if I try to modify the anti-CSRF token value to simulate an attack.  It seems that something that is being called by the filter after the execute() method on the actions completes session is still valid.  Is this a bug, or am I not using the invalidate action correctly?

Here is my configuration for using the Invalidate action:

##################################
Begin Owasp.CsrfGuard.properties
##################################

org.owasp.csrfguard.Logger=org.owasp.csrfguard.log.ConsoleLogger

org.owasp.csrfguard.NewTokenLandingPage=/hello-web/index.html

org.owasp.csrfguard.TokenPerPage=true

org.owasp.csrfguard.Rotate=false

org.owasp.csrfguard.Ajax=true

org.owasp.csrfguard.unprotected.css=*.css
org.owasp.csrfguard.unprotected.jpg=*.jpg
org.owasp.csrfguard.unprotected.gif=*.gif
org.owasp.csrfguard.unprotected.png=*.png
org.owasp.csrfguard.unprotected.js=*.js
org.owasp.csrfguard.unprotected.index=/hello-web/index.html
org.owasp.csrfguard.unprotected.default=/hello-web/
org.owasp.csrfguard.unprotected.javascriptServlet=/hello-web/JavaScriptServlet

org.owasp.csrfguard.action.Log=org.owasp.csrfguard.action.Log
org.owasp.csrfguard.action.Log.Message=potential cross-site request forgery (CSRF) attack thwarted (host:%remote_host%, ip:%remote_ip%, uri:%request_uri%, error:%exception_message%)
org.owasp.csrfguard.action.Invalidate=org.owasp.csrfguard.action.Invalidate

org.owasp.csrfguard.TokenName=OWASP_CSRFTOKEN

org.owasp.csrfguard.SessionKey=OWASP_CSRFTOKEN

org.owasp.csrfguard.TokenLength=32

org.owasp.csrfguard.PRNG=SHA1PRNG

##################################
End Owasp.CsrfGuard.properties
##################################


If I attempt to hit the webapp and modify the anti-CSRF token, I get the following stacktrace:


java.lang.IllegalStateException: setAttribute: Session already invalidated
        at org.apache.catalina.session.StandardSession.setAttribute(StandardSession.java:1289)
        at org.apache.catalina.session.StandardSession.setAttribute(StandardSession.java:1254)
        at org.apache.catalina.session.StandardSessionFacade.setAttribute(StandardSessionFacade.java:130)
        at org.owasp.csrfguard.CsrfGuard.isValidRequest(CsrfGuard.java:316)
        at org.owasp.csrfguard.CsrfGuardFilter.doFilter(CsrfGuardFilter.java:57)
        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)
        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)
        at org.jboss.web.tomcat.filters.ReplyHeaderFilter.doFilter(ReplyHeaderFilter.java:96)
        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)
        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)
        at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:230)
        at org.apache.catalina.core.StandardContextValve.__invoke(StandardContextValve.java:175)
        at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java)
        at org.jboss.web.tomcat.security.SecurityAssociationValve.invoke(SecurityAssociationValve.java:182)
        at org.jboss.web.tomcat.security.JaccContextValve.invoke(JaccContextValve.java:84)
        at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:127)
        at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102)
        at org.jboss.web.tomcat.service.jca.CachedConnectionValve.invoke(CachedConnectionValve.java:157)
        at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109)
        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:262)
        at org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:844)
        at org.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.process(Http11Protocol.java:583)
        at org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:446)
        at java.lang.Thread.run(Thread.java:595)


Nick Athie
FSA | AO | SAIC
(816) 823-2889





This electronic message contains information generated by the USDA solely for the intended recipients. Any unauthorized interception of this message or the use or disclosure of the information it contains may violate the law and subject the violator to civil or criminal penalties. If you believe you have received this message in error, please notify the sender and delete the email immediately.


From Yoni.Amir at actimize.com  Thu May 17 08:01:34 2012
From: Yoni.Amir at actimize.com (Yoni Amir)
Date: Thu, 17 May 2012 11:01:34 +0300
Subject: [Owasp-csrfguard] source code for 3.0.0.503 release
Message-ID: <7E0464726BD046488B66D661770F9C2F80D250D8@TLVMBX01.nice.com>

Hi,
On the owasp.org site there is a link to github, but it points to the latest version.
Is there a branch or a tag, or any other means, to obtain the source code exactly for release 3.0.0.503?
Thanks,
Yoni
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-csrfguard/attachments/20120517/cc61c96d/attachment.html>

From afomin at jaspersoft.com  Thu May 17 08:14:53 2012
From: afomin at jaspersoft.com (Anton Fomin)
Date: Thu, 17 May 2012 11:14:53 +0300
Subject: [Owasp-csrfguard] source code for 3.0.0.503 release
In-Reply-To: <7E0464726BD046488B66D661770F9C2F80D250D8@TLVMBX01.nice.com>
References: <7E0464726BD046488B66D661770F9C2F80D250D8@TLVMBX01.nice.com>
Message-ID: <CAGzcv2YpagD-3MdECd4peYcQpZueT9q9t2ytd-fGmOjEXkScsw@mail.gmail.com>

Hi,

I had this problem, there is no revision corresponding to exactly 3.0.0.503.

Thanks,
Anton.

2012/5/17 Yoni Amir <Yoni.Amir at actimize.com>

> Hi,****
>
> On the owasp.org site there is a link to github, but it points to the
> latest version.****
>
> Is there a branch or a tag, or any other means, to obtain the source code
> exactly for release 3.0.0.503?****
>
> Thanks,****
>
> Yoni****
>
> _______________________________________________
> Owasp-csrfguard mailing list
> Owasp-csrfguard at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-csrfguard
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-csrfguard/attachments/20120517/8e57237c/attachment.html>

From mehdibennani at hotmail.com  Thu May 17 15:31:37 2012
From: mehdibennani at hotmail.com (Mehdi Bennani)
Date: Thu, 17 May 2012 11:31:37 -0400
Subject: [Owasp-csrfguard] Double Refresh for every request
Message-ID: <SNT134-W58088A860BD9D732E5FB9FC3190@phx.gbl>


Hi You guys,

I  have just set up CSRF guard to work with my strut2-spring  project. I have 2 issues:

1- For every request, all my resources are requested twice. I.e: all the css, images, etc...are requested twice, once without the OWASP token and once with the token.
In fact, a quick inspection through firebug reveals the following timeline:
- A bunch of GETs are issues (my resources) (without the OWASP token)
  Among them, a GET to OWASP JavaScriptServlet
- Then at some point, a POST to JavaScriptServlet is sent out
- Then a slew of Gets (the same ones as before, i.e: my resources) this time with the ?OWASP_CSRFTOKEN=... appended to each GET

Is this how is it supposed to be working?? I must have configured something wrong....
I mean even I would like to disregard the performance loss related to the double requests, my site is loads funny now, as it loads without the CSS/JS at first (so looks pretty much ugly), then a split of a second later, the site is refreshed and everything is there. It is slow enough that we can notice it.

2- When I login, it fails with a 403. I checked my form submission and it does not seem to contain the OWASP_CSRTOKEN. Hence the 403...

Any help is appreciated,

Here is my config:

org.owasp.csrfguard.Logger=org.owasp.csrfguard.log.ConsoleLogger
org.owasp.csrfguard.TokenPerPage=true
org.owasp.csrfguard.Ajax=true

org.owasp.csrfguard.unprotected.DefaultHome=/localhost/home
org.owasp.csrfguard.unprotected.403=/localhost/403.jsp
org.owasp.csrfguard.unprotected.404=/localhost/404.jsp

org.owasp.csrfguard.action.Log=org.owasp.csrfguard.action.Log
org.owasp.csrfguard.action.Log.Message=potential cross-site request forgery (CSRF) attack thwarted (user:%user%, ip:%remote_ip%, uri:%request_uri%, error:%exception_message%)
org.owasp.csrfguard.action.Redirect=org.owasp.csrfguard.action.Redirect
org.owasp.csrfguard.action.Redirect.Page=/localhost/403.jsp
org.owasp.csrfguard.action.Rotate=org.owasp.csrfguard.action.Rotate

org.owasp.csrfguard.TokenName=OWASP_CSRFTOKEN
org.owasp.csrfguard.SessionKey=OWASP_CSRFTOKEN
org.owasp.csrfguard.TokenLength=32
org.owasp.csrfguard.PRNG=SHA1PRNG

And JavaScriptServlet

   <servlet>
       <servlet-name>JavaScriptServlet</servlet-name>
       <servlet-class>org.owasp.csrfguard.servlet.JavaScriptServlet</servlet-class>
         <init-param>
            <param-name>source-file</param-name>
            <param-value>WEB-INF/Owasp.CsrfGuard.js</param-value>
         </init-param>
         <init-param>
            <param-name>inject-into-forms</param-name>
            <param-value>true</param-value>
         </init-param>
         <init-param>
            <param-name>inject-into-attributes</param-name>
            <param-value>true</param-value>
         </init-param>
         <init-param>
            <param-name>domain-strict</param-name>
            <param-value>false</param-value>
         </init-param>
         <init-param>
            <param-name>referer-pattern</param-name>
            <param-value>.*localhost.*</param-value>
         </init-param>
    </servlet>
    <servlet-mapping>
           <servlet-name>JavaScriptServlet</servlet-name>
           <url-pattern>/JavaScriptServlet</url-pattern>
    </servlet-mapping>

Elextra/ 		 	   		  
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-csrfguard/attachments/20120517/5ffa2440/attachment.html>

