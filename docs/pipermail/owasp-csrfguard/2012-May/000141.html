<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-csrfguard] IllegalStateExceptions caused by using the	Invalidate action
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-csrfguard%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-csrfguard%5D%20IllegalStateExceptions%20caused%20by%20using%20the%0A%09Invalidate%20action&In-Reply-To=%3C3BBDB0F64DC86549AC8D097839EA5457DE1159%40001FSN2MPN1-022.001f.mgd2.msft.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="000142.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-csrfguard] IllegalStateExceptions caused by using the	Invalidate action</H1>
    <B>Athie, Nicholas - FSA, Kansas City, MO</B> 
    <A HREF="mailto:owasp-csrfguard%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-csrfguard%5D%20IllegalStateExceptions%20caused%20by%20using%20the%0A%09Invalidate%20action&In-Reply-To=%3C3BBDB0F64DC86549AC8D097839EA5457DE1159%40001FSN2MPN1-022.001f.mgd2.msft.net%3E"
       TITLE="[Owasp-csrfguard] IllegalStateExceptions caused by using the	Invalidate action">Nicholas.Athie at kcc.usda.gov
       </A><BR>
    <I>Mon May  7 16:25:31 UTC 2012</I>
    <P><UL>
        
        <LI>Next message: <A HREF="000142.html">[Owasp-csrfguard] source code for 3.0.0.503 release
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#141">[ date ]</a>
              <a href="thread.html#141">[ thread ]</a>
              <a href="subject.html#141">[ subject ]</a>
              <a href="author.html#141">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Whenever I try to use the Invalidate Actions, I get an IllegalStateException if I try to modify the anti-CSRF token value to simulate an attack.  It seems that something that is being called by the filter after the execute() method on the actions completes session is still valid.  Is this a bug, or am I not using the invalidate action correctly?

Here is my configuration for using the Invalidate action:

##################################
Begin Owasp.CsrfGuard.properties
##################################

org.owasp.csrfguard.Logger=org.owasp.csrfguard.log.ConsoleLogger

org.owasp.csrfguard.NewTokenLandingPage=/hello-web/index.html

org.owasp.csrfguard.TokenPerPage=true

org.owasp.csrfguard.Rotate=false

org.owasp.csrfguard.Ajax=true

org.owasp.csrfguard.unprotected.css=*.css
org.owasp.csrfguard.unprotected.jpg=*.jpg
org.owasp.csrfguard.unprotected.gif=*.gif
org.owasp.csrfguard.unprotected.png=*.png
org.owasp.csrfguard.unprotected.js=*.js
org.owasp.csrfguard.unprotected.index=/hello-web/index.html
org.owasp.csrfguard.unprotected.default=/hello-web/
org.owasp.csrfguard.unprotected.javascriptServlet=/hello-web/JavaScriptServlet

org.owasp.csrfguard.action.Log=org.owasp.csrfguard.action.Log
org.owasp.csrfguard.action.Log.Message=potential cross-site request forgery (CSRF) attack thwarted (host:%remote_host%, ip:%remote_ip%, uri:%request_uri%, error:%exception_message%)
org.owasp.csrfguard.action.Invalidate=org.owasp.csrfguard.action.Invalidate

org.owasp.csrfguard.TokenName=OWASP_CSRFTOKEN

org.owasp.csrfguard.SessionKey=OWASP_CSRFTOKEN

org.owasp.csrfguard.TokenLength=32

org.owasp.csrfguard.PRNG=SHA1PRNG

##################################
End Owasp.CsrfGuard.properties
##################################


If I attempt to hit the webapp and modify the anti-CSRF token, I get the following stacktrace:


java.lang.IllegalStateException: setAttribute: Session already invalidated
        at org.apache.catalina.session.StandardSession.setAttribute(StandardSession.java:1289)
        at org.apache.catalina.session.StandardSession.setAttribute(StandardSession.java:1254)
        at org.apache.catalina.session.StandardSessionFacade.setAttribute(StandardSessionFacade.java:130)
        at org.owasp.csrfguard.CsrfGuard.isValidRequest(CsrfGuard.java:316)
        at org.owasp.csrfguard.CsrfGuardFilter.doFilter(CsrfGuardFilter.java:57)
        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)
        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)
        at org.jboss.web.tomcat.filters.ReplyHeaderFilter.doFilter(ReplyHeaderFilter.java:96)
        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)
        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)
        at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:230)
        at org.apache.catalina.core.StandardContextValve.__invoke(StandardContextValve.java:175)
        at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java)
        at org.jboss.web.tomcat.security.SecurityAssociationValve.invoke(SecurityAssociationValve.java:182)
        at org.jboss.web.tomcat.security.JaccContextValve.invoke(JaccContextValve.java:84)
        at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:127)
        at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102)
        at org.jboss.web.tomcat.service.jca.CachedConnectionValve.invoke(CachedConnectionValve.java:157)
        at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109)
        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:262)
        at org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:844)
        at org.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.process(Http11Protocol.java:583)
        at org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:446)
        at java.lang.Thread.run(Thread.java:595)


Nick Athie
FSA | AO | SAIC
(816) 823-2889





This electronic message contains information generated by the USDA solely for the intended recipients. Any unauthorized interception of this message or the use or disclosure of the information it contains may violate the law and subject the violator to civil or criminal penalties. If you believe you have received this message in error, please notify the sender and delete the email immediately.

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message: <A HREF="000142.html">[Owasp-csrfguard] source code for 3.0.0.503 release
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#141">[ date ]</a>
              <a href="thread.html#141">[ thread ]</a>
              <a href="subject.html#141">[ subject ]</a>
              <a href="author.html#141">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-csrfguard">More information about the Owasp-csrfguard
mailing list</a><br>
</body></html>
