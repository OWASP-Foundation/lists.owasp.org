From manchandap at yahoo.com  Thu Sep 12 07:30:13 2013
From: manchandap at yahoo.com (P Manchanda)
Date: Thu, 12 Sep 2013 00:30:13 -0700 (PDT)
Subject: [Owasp-csrfguard] CSRFGuard and protecting links of pages sent out
	in emails
Message-ID: <1378971013.34728.YahooMailNeo@web162601.mail.bf1.yahoo.com>



We implemented OWASP's CSRFGuard to protect our pages in the 
web application. For example */myCsrfProtected.jsp. We have injected 
CSRF token at all occurrences of */myCsrfProtected.jsp within the 
application. Everything works fine.
However, we have other use case where the link to this protected page is sent out to users in an email. Think about a link to a report. Now 
when user clicks on this link, the token is missing or invalid and hence the CSRFGuard filter blocks the request assuming this to be a CSRF 
attack. (this is what filter has been implemented for :-) )

Is there any way to handle this use case and allow access to CSRF protected page from outside the application. 

Ideally the GET request should not be protected but being an old application, GET requests are also used to change the server state.

___________________ 
Thks & brgds 
P Manchanda
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-csrfguard/attachments/20130912/692f34a9/attachment.html>

From tom.a.barber at gmail.com  Thu Sep 12 09:19:14 2013
From: tom.a.barber at gmail.com (Tom Barber)
Date: Thu, 12 Sep 2013 10:19:14 +0100
Subject: [Owasp-csrfguard] CSRFGuard and protecting links of pages sent
 out in emails
In-Reply-To: <1378971013.34728.YahooMailNeo@web162601.mail.bf1.yahoo.com>
References: <1378971013.34728.YahooMailNeo@web162601.mail.bf1.yahoo.com>
Message-ID: <CAKrLoaSTU0hXwtC_xECjyfJOCYFtvc4HoaRaWTgGLYTUrwSw5A@mail.gmail.com>

Hi, as far as I know this isn't possible. If your could do this it would be
equally possible to perform a csrf attack. Csrfguard is designed to only
allow requests that originate from the app to be allowed. You could
unprotect specific resources assuming safe to do so.

Thanks.

Tom
On 12 Sep 2013 08:31, "P Manchanda" <manchandap at yahoo.com> wrote:

>
> We implemented OWASP's CSRFGuard to protect our pages in the web
> application. For example */myCsrfProtected.jsp. We have injected CSRF token
> at all occurrences of */myCsrfProtected.jsp within the application.
> Everything works fine.
> However, we have other use case where the link to this protected page is
> sent out to users in an email. Think about a link to a report. Now when
> user clicks on this link, the token is missing or invalid and hence the
> CSRFGuard filter blocks the request assuming this to be a CSRF attack.
> (this is what filter has been implemented for :-) )
>
> Is there any way to handle this use case and allow access to CSRF
> protected page from outside the application.
>
> Ideally the GET request should not be protected but being an old
> application, GET requests are also used to change the server state.
> ___________________
> Thks & brgds
> P Manchanda
>
>
> _______________________________________________
> Owasp-csrfguard mailing list
> Owasp-csrfguard at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-csrfguard
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-csrfguard/attachments/20130912/8557392c/attachment.html>

From shane at shaneargo.net  Thu Sep 12 11:12:52 2013
From: shane at shaneargo.net (Shane Argo)
Date: Thu, 12 Sep 2013 21:12:52 +1000
Subject: [Owasp-csrfguard] CSRFGuard and protecting links of pages sent
 out in emails
In-Reply-To: <CAKrLoaSTU0hXwtC_xECjyfJOCYFtvc4HoaRaWTgGLYTUrwSw5A@mail.gmail.com>
References: <1378971013.34728.YahooMailNeo@web162601.mail.bf1.yahoo.com>
	<CAKrLoaSTU0hXwtC_xECjyfJOCYFtvc4HoaRaWTgGLYTUrwSw5A@mail.gmail.com>
Message-ID: <CAGroUwgmWXn7R2ZYD0Zz9LrNEPGa-TebJbJx0RKpLDSgmZppXw@mail.gmail.com>

Hi,

Am I understanding correctly that the path to the .jsp file which serves
the request you want to be unprotected also serves requests you do want
protected (perhaps, with different request parameters)? Perhaps an example
will clarify my question:

Scenario A:
/path/to/protected.jsp - Requires protection from CSRF attacks.
/path/to/reoprt.jsp - Does not require protection from CSRF attacks.

Scenario B:
/path/to/file.jsp?action=protected - Requires protection from CSRF attacks.
/path/to/file.jsp?action=report - Does not require protection from CSRF
attacks.

Scenario C: (Tom's interpretation - I think)
The resource is the same resource, but sometimes you want it unprotected.


If you are dealing with scenario A, then you can use a property in the
csrfguard.properties file to exclude that path from the filter. For an
example see the "org.owasp.csrfguard.unprotected" properties in the
csrfguard.properties file in test project:
https://github.com/esheri3/OWASP-CSRFGuard/blob/master/csrfguard-test/src/main/webapp/WEB-INF/csrfguard.properties

With scenario B, you will not be so lucky. I don't think there is a way to
achieve this, but I am pretty new to the project myself so perhaps I am
mistaken.

Scenario C, is not and cannot be possible. How you would you know when it
is to be protected and when it's not? And if there is any way to forge a
request that is unprotected, this is what an attacker would do.

Please let us know if you have any further questions. I'd be interested to
hear which scenario you are dealing with.

Cheers,
Shane Argo.






On Thu, Sep 12, 2013 at 7:19 PM, Tom Barber <tom.a.barber at gmail.com> wrote:

> Hi, as far as I know this isn't possible. If your could do this it would
> be equally possible to perform a csrf attack. Csrfguard is designed to only
> allow requests that originate from the app to be allowed. You could
> unprotect specific resources assuming safe to do so.
>
> Thanks.
>
> Tom
> On 12 Sep 2013 08:31, "P Manchanda" <manchandap at yahoo.com> wrote:
>
>>
>> We implemented OWASP's CSRFGuard to protect our pages in the web
>> application. For example */myCsrfProtected.jsp. We have injected CSRF token
>> at all occurrences of */myCsrfProtected.jsp within the application.
>> Everything works fine.
>> However, we have other use case where the link to this protected page is
>> sent out to users in an email. Think about a link to a report. Now when
>> user clicks on this link, the token is missing or invalid and hence the
>> CSRFGuard filter blocks the request assuming this to be a CSRF attack.
>> (this is what filter has been implemented for :-) )
>>
>> Is there any way to handle this use case and allow access to CSRF
>> protected page from outside the application.
>>
>> Ideally the GET request should not be protected but being an old
>> application, GET requests are also used to change the server state.
>> ___________________
>> Thks & brgds
>> P Manchanda
>>
>>
>> _______________________________________________
>> Owasp-csrfguard mailing list
>> Owasp-csrfguard at lists.owasp.org
>> https://lists.owasp.org/mailman/listinfo/owasp-csrfguard
>>
>>
> _______________________________________________
> Owasp-csrfguard mailing list
> Owasp-csrfguard at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-csrfguard
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-csrfguard/attachments/20130912/329bdabb/attachment.html>

From manchandap at yahoo.com  Thu Sep 12 12:29:42 2013
From: manchandap at yahoo.com (P Manchanda)
Date: Thu, 12 Sep 2013 05:29:42 -0700 (PDT)
Subject: [Owasp-csrfguard] CSRFGuard and protecting links of pages sent
	out in emails
In-Reply-To: <CAGroUwgmWXn7R2ZYD0Zz9LrNEPGa-TebJbJx0RKpLDSgmZppXw@mail.gmail.com>
References: <1378971013.34728.YahooMailNeo@web162601.mail.bf1.yahoo.com>
	<CAKrLoaSTU0hXwtC_xECjyfJOCYFtvc4HoaRaWTgGLYTUrwSw5A@mail.gmail.com>
	<CAGroUwgmWXn7R2ZYD0Zz9LrNEPGa-TebJbJx0RKpLDSgmZppXw@mail.gmail.com>
Message-ID: <1378988982.66157.YahooMailNeo@web162605.mail.bf1.yahoo.com>

Thanks Shane,

It is the Scenario B that I am looking to handle:


Scenario B:

/path/to/file.jsp?action=protected - Requires protection from CSRF attacks.
/path/to/file.jsp?action=report - Does not require protection from CSRF attacks.


?
___________________ 
Thks & brgds 
P Manchanda
Mobile: +91-9811210374 



________________________________
 From: Shane Argo <shane at shaneargo.net>
To: Tom Barber <tom.a.barber at gmail.com> 
Cc: P Manchanda <manchandap at yahoo.com>; owasp-csrfguard at lists.owasp.org 
Sent: Thursday, 12 September 2013, 16:42
Subject: Re: [Owasp-csrfguard] CSRFGuard and protecting links of pages sent out in emails
 


Hi,

Am I understanding correctly that the path to the .jsp file which serves the request you want to be unprotected also serves requests you do want protected (perhaps, with different request parameters)? Perhaps an example will clarify my question:


Scenario A:

/path/to/protected.jsp - Requires protection from CSRF attacks.

/path/to/reoprt.jsp - Does not require protection from CSRF attacks.


Scenario B:

/path/to/file.jsp?action=protected - Requires protection from CSRF attacks.

/path/to/file.jsp?action=report - Does not require protection from CSRF attacks.


Scenario C: (Tom's interpretation - I think)

The resource is the same resource, but sometimes you want it unprotected.



If you are dealing with scenario A, then you can use a property in the csrfguard.properties file to exclude that path from the filter. For an example see the "org.owasp.csrfguard.unprotected" properties in the csrfguard.properties file in test project:
https://github.com/esheri3/OWASP-CSRFGuard/blob/master/csrfguard-test/src/main/webapp/WEB-INF/csrfguard.properties


With scenario B, you will not be so lucky. I don't think there is a way to achieve this, but I am pretty new to the project myself so perhaps I am mistaken.


Scenario C, is not and cannot be possible. How you would you know when it is to be protected and when it's not? And if there is any way to forge a request that is unprotected, this is what an attacker would do.


Please let us know if you have any further questions. I'd be interested to hear which scenario you are dealing with.


Cheers,
Shane Argo.








On Thu, Sep 12, 2013 at 7:19 PM, Tom Barber <tom.a.barber at gmail.com> wrote:

Hi, as far as I know this isn't possible. If your could do this it would be equally possible to perform a csrf attack. Csrfguard is designed to only allow requests that originate from the app to be allowed. You could unprotect specific resources assuming safe to do so. 
>Thanks. 
>Tom 
>On 12 Sep 2013 08:31, "P Manchanda" <manchandap at yahoo.com> wrote:
>
>
>>
>>We implemented OWASP's CSRFGuard to protect our pages in the 
web application. For example */myCsrfProtected.jsp. We have injected 
CSRF token at all occurrences of */myCsrfProtected.jsp within the 
application. Everything works fine.
>>However, we have other use case where the link to this protected page is sent out to users in an email. Think about a link to a report. Now 
when user clicks on this link, the token is missing or invalid and hence the CSRFGuard filter blocks the request assuming this to be a CSRF 
attack. (this is what filter has been implemented for :-) )
>>
>>
>>Is there any way to handle this use case and allow access to CSRF protected page from outside the application. 
>>
>>Ideally the GET request should not be protected but being an old application, GET requests are also used to change the server state.
>>
>>___________________ 
>>Thks & brgds 
>>P Manchanda
>>
>>
>>_______________________________________________
>>Owasp-csrfguard mailing list
>>Owasp-csrfguard at lists.owasp.org
>>https://lists.owasp.org/mailman/listinfo/owasp-csrfguard
>>
>>
>_______________________________________________
>Owasp-csrfguard mailing list
>Owasp-csrfguard at lists.owasp.org
>https://lists.owasp.org/mailman/listinfo/owasp-csrfguard
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-csrfguard/attachments/20130912/5e56c139/attachment.html>

From mchyzer at isc.upenn.edu  Thu Sep 12 21:02:51 2013
From: mchyzer at isc.upenn.edu (Chris Hyzer)
Date: Thu, 12 Sep 2013 21:02:51 +0000
Subject: [Owasp-csrfguard] ava.lang.ClassNotFoundException:
 org.owasp.csrfguard.CsrfGuardListener
Message-ID: <04BE669BEE19E54BBDC2A9A2585BB6886CD8A2FF@exch-mbx01.exchange.upenn.edu>

I tried to install CSRF guard, and the instructions here:

https://www.owasp.org/index.php?title=CSRFGuard_3_Installation

Say to put this in the web.xml

<listener>
  <listener-class>org.owasp.csrfguard.CsrfGuardListener</listener-class>
</listener>

I downloaded csrfguard here:

http://mvnrepository.com/artifact/org.owasp/csrfguard/3.0.0

But that class is not in that jar:

java.lang.ClassNotFoundException: org.owasp.csrfguard.CsrfGuardListener

I do see a session listener and a context listener.

Let me know what I should do

Thanks,
Chris
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-csrfguard/attachments/20130912/a78b6390/attachment.html>

From tom.a.barber at gmail.com  Fri Sep 13 10:15:06 2013
From: tom.a.barber at gmail.com (Tom Barber)
Date: Fri, 13 Sep 2013 11:15:06 +0100
Subject: [Owasp-csrfguard] ava.lang.ClassNotFoundException:
	org.owasp.csrfguard.CsrfGuardListener
In-Reply-To: <04BE669BEE19E54BBDC2A9A2585BB6886CD8A2FF@exch-mbx01.exchange.upenn.edu>
References: <04BE669BEE19E54BBDC2A9A2585BB6886CD8A2FF@exch-mbx01.exchange.upenn.edu>
Message-ID: <CAKrLoaTnBucOXprTWZFyBEDUAH8V_AnLKO-64Y6qOQ8JwUaUEw@mail.gmail.com>

Take a look at the example csrfguard-test app on github.  Here is the
web.xml

https://github.com/esheri3/OWASP-CSRFGuard/blob/master/csrfguard-test/src/main/webapp/WEB-INF/web.xml
 On 12 Sep 2013 22:03, "Chris Hyzer" <mchyzer at isc.upenn.edu> wrote:

>  I tried to install CSRF guard, and the instructions here:****
>
> ** **
>
> https://www.owasp.org/index.php?title=CSRFGuard_3_Installation****
>
> ** **
>
> Say to put this in the web.xml****
>
> ** **
>
> <listener>****
>
>   <listener-class>org.owasp.csrfguard.CsrfGuardListener</listener-class>**
> **
>
> </listener>****
>
> ** **
>
> I downloaded csrfguard here:****
>
> ** **
>
> http://mvnrepository.com/artifact/org.owasp/csrfguard/3.0.0****
>
> ** **
>
> But that class is not in that jar:****
>
> ** **
>
> java.lang.ClassNotFoundException: org.owasp.csrfguard.CsrfGuardListener***
> *
>
> ** **
>
> I do see a session listener and a context listener.****
>
> ** **
>
> Let me know what I should do****
>
> ** **
>
> Thanks,****
>
> Chris****
>
> _______________________________________________
> Owasp-csrfguard mailing list
> Owasp-csrfguard at lists.owasp.org
> https://lists.owasp.org/mailman/listinfo/owasp-csrfguard
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-csrfguard/attachments/20130913/2b746fe7/attachment.html>

From mchyzer at isc.upenn.edu  Fri Sep 13 16:34:28 2013
From: mchyzer at isc.upenn.edu (Chris Hyzer)
Date: Fri, 13 Sep 2013 16:34:28 +0000
Subject: [Owasp-csrfguard] dynamic dom manipulation
Message-ID: <04BE669BEE19E54BBDC2A9A2585BB6886CD8A96B@exch-mbx01.exchange.upenn.edu>

Ok, thanks for the previous response from Tom Barber.  Things are working fairly well now, the library is pretty nice.

I have some cases where links or forms do not have the token and throw an error, I think because those links/forms were put on the page dynamically with ajax (after the onload function runs that inits the page).  Are dynamic links/forms handled with csrfguard?  What do I have to do?  Hopefully not have to figure out where these are and use custom tags, it will be very tedious...  maybe a javascript function to call when the dom is changed to add the token where it does not exist already or something like that?  Would be nice if this happened automatically somehow though, don't know how it would work.

Thanks,
Chris

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-csrfguard/attachments/20130913/4229571e/attachment.html>

From mchyzer at isc.upenn.edu  Fri Sep 27 17:45:54 2013
From: mchyzer at isc.upenn.edu (Chris Hyzer)
Date: Fri, 27 Sep 2013 17:45:54 +0000
Subject: [Owasp-csrfguard] are there clustering requirements to csrfguard?
In-Reply-To: <CAKrLoaTnBucOXprTWZFyBEDUAH8V_AnLKO-64Y6qOQ8JwUaUEw@mail.gmail.com>
References: <04BE669BEE19E54BBDC2A9A2585BB6886CD8A2FF@exch-mbx01.exchange.upenn.edu>
	<CAKrLoaTnBucOXprTWZFyBEDUAH8V_AnLKO-64Y6qOQ8JwUaUEw@mail.gmail.com>
Message-ID: <04BE669BEE19E54BBDC2A9A2585BB6886CE41ADF@exch-mbx01.exchange.upenn.edu>

My app doesn't store anything in session, though generally we have stateful session load balancing.  If the cluster of servers removes a node, and a user is moved to another node, will CSRFGuard be able to deal with that, or does it assume that sessions are clustered in the app server?

Thanks,
Chris
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.owasp.org/pipermail/owasp-csrfguard/attachments/20130927/e50e0153/attachment.html>

From pradtke at stanford.edu  Fri Sep 27 18:33:19 2013
From: pradtke at stanford.edu (Patrick Radtke)
Date: Fri, 27 Sep 2013 11:33:19 -0700
Subject: [Owasp-csrfguard] are there clustering requirements to
	csrfguard?
In-Reply-To: <04BE669BEE19E54BBDC2A9A2585BB6886CE41ADF@exch-mbx01.exchange.upenn.edu>
References: <04BE669BEE19E54BBDC2A9A2585BB6886CD8A2FF@exch-mbx01.exchange.upenn.edu>
	<CAKrLoaTnBucOXprTWZFyBEDUAH8V_AnLKO-64Y6qOQ8JwUaUEw@mail.gmail.com>
	<04BE669BEE19E54BBDC2A9A2585BB6886CE41ADF@exch-mbx01.exchange.upenn.edu>
Message-ID: <5245CF6F.3020500@stanford.edu>

On 9/27/13 10:45 AM, Chris Hyzer wrote:
> My app doesn?t store anything in session, though generally we have
> stateful session load balancing.  If the cluster of servers removes a
> node, and a user is moved to another node, will CSRFGuard be able to
> deal with that, or does it assume that sessions are clustered in the app
> server?

I think it will depend on what URL the user is accessing when they are 
switched to another server. CSRFGaurd will create a new set of tokens 
for the user when the user access the new server (as part of the servlet 
session getting created). If the URL is protected with a CSRF token, 
then there will be a CSRF token mismatch error since the token provided 
by the user would have been from the old server. If the URL is not 
protected then everything is fine. Clicking back and accessing cached 
pages would have invalid tokens as well.

We use a filter to try to spot those conditions and send them to more 
informative error page (rather then telling them access denied).


-Patrick


