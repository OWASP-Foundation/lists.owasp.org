<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-csrfguard] Getting csrfguard 3.1 to work with struts 1.1 fowards, has anyone gotten it to work?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-csrfguard%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-csrfguard%5D%20Getting%20csrfguard%203.1%20to%20work%20with%20struts%201.1%0A%20fowards%2C%20has%20anyone%20gotten%20it%20to%20work%3F&In-Reply-To=%3CCO1PR07MB1602E5A11DF8340100B41EA8F700%40CO1PR07MB160.namprd07.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="000335.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-csrfguard] Getting csrfguard 3.1 to work with struts 1.1 fowards, has anyone gotten it to work?</H1>
    <B>[REDACTED]</B> 
    <A HREF="mailto:owasp-csrfguard%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-csrfguard%5D%20Getting%20csrfguard%203.1%20to%20work%20with%20struts%201.1%0A%20fowards%2C%20has%20anyone%20gotten%20it%20to%20work%3F&In-Reply-To=%3CCO1PR07MB1602E5A11DF8340100B41EA8F700%40CO1PR07MB160.namprd07.prod.outlook.com%3E"
       TITLE="[Owasp-csrfguard] Getting csrfguard 3.1 to work with struts 1.1 fowards, has anyone gotten it to work?">[REDACTED]
       </A><BR>
    <I>Mon Aug 10 20:48:33 UTC 2015</I>
    <P><UL>
        
        <LI>Next message: <A HREF="000335.html">[Owasp-csrfguard] Getting csrfguard 3.1 to work with struts 1.1 fowards, has anyone gotten it to work?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#334">[ date ]</a>
              <a href="thread.html#334">[ thread ]</a>
              <a href="subject.html#334">[ subject ]</a>
              <a href="author.html#334">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Folks,
I did some searching on all the archives for struts before posting, I will search for &quot;forward&quot; next
We are trying to add csrfguard 3.1 to a very large, legacy (spaghetti) web app, (actually many, but focusing on 1 for now)
We are using struts 1.1 , weblogic 12.1.3 etc
I'm able to get happy path for a fairly complex CRUD flow with a combo of unprotected urls, as well as turning off token per page and token rotate properties
, which is in essence, just another session token , OWASP_CSRFTOKEN, which is similar to JSESSIONID and struts token and can be forged is similar matter. We need a per page token or rotating token to
After some careful analysis on (what looks like) the latest and greatest source <A HREF="https://github.com/aramrami/OWASP-CSRFGuard">https://github.com/aramrami/OWASP-CSRFGuard</A>
The problem is with the struts forward and flow is as follows:

1.      Initial request using (wonky javascript) and csrfguard taglib
openIwin(&quot;createSomeEntityForward.do?&lt;csrf:token uri=&quot;createSomeEntityForward.do&quot;/&gt;&quot;, &quot;Create Organization&quot;);

2.      CSRFGuard Filter (using token per page ) validates/allows the the 1st request  uri createSomeEntityForward

3.      But when Filter intercepts 2nd forwarded path &quot;/WEB-INF/jsp/.../createEntity.jsp&quot;/&gt; The token in the request is not found in the csrfguard uri/token map so it checks against the session token which fails

4.      I also tried turning off token per page and turned on token rotate, the session token got updated, but the orig request has the now, stale token

5.      If there was some other normal (non csrf) validation, like a missing field, it would be forwarded to yet another page which would also break

Re-writing the webapp is not an option at this time, nor is upgrading to more modern version of struts

Proposed work-around:

1.      We were thinking of writing our own filter to attached token to each outbound request (and using the csrfguard api), to inject (add NV pair to URL if GET or body if POST) and forgoing javascript injection or csrf taglib, since we have hundreds of complex pages).

2.      When the csrfguard filter now picks up the inbound request, it validates each request, regardless if forward

Another workaround:

1.      Somehow get a handle to the orig request, the .do request, then change the CSRFGuard.verifyPageToken() method to check the URI/Token map for both the forwarded URI (.jsp) OR the orig URI (.do) for a match

We are open to other ideas as well?

Here's a snippet of struts-config.xml (names fudged a bit)
             &lt;action path=&quot;/createSomeEntityForward&quot; input=&quot;/WEB-INF/jsp/.../index.jsp&quot; scope=&quot;request&quot; type=&quot;com.........portal.action.SecurityForwardAction&quot; validate=&quot;false&quot;&gt;
                    &lt;forward name=&quot;failure&quot;              path=&quot;/WEB-INF/jsp/.../index.jsp&quot;/&gt;
                    &lt;forward name=&quot;success&quot;              path=&quot;/WEB-INF/jsp/...createEntity.jsp&quot;/&gt;
             &lt;/action&gt;

These are some of the the relevant session attributes
org.apache.struts.action.TOKEN=d408fea028c0094dd0c8d8f978b3ed51
OWASP_CSRFTOKEN=SDOB-M7W9-CSPP-BRHS-Q1L4-05AG-8XDZ-3KNB

Thanks in advance for your time
[REDACTED]

This e-mail is intended solely for the person or entity to which it is addressed and may contain confidential and/or privileged information. Any review, dissemination, copying, printing or other use of this e-mail by persons or entities other than the addressee is prohibited. If you have received this e-mail in error, please contact the sender immediately and delete the material from any computer.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.owasp.org/pipermail/owasp-csrfguard/attachments/20150810/e4be0ac1/attachment.html">http://lists.owasp.org/pipermail/owasp-csrfguard/attachments/20150810/e4be0ac1/attachment.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message: <A HREF="000335.html">[Owasp-csrfguard] Getting csrfguard 3.1 to work with struts 1.1 fowards, has anyone gotten it to work?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#334">[ date ]</a>
              <a href="thread.html#334">[ thread ]</a>
              <a href="subject.html#334">[ subject ]</a>
              <a href="author.html#334">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-csrfguard">More information about the Owasp-csrfguard
mailing list</a><br>
</body></html>
