<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Owasp-csrfguard] Getting csrfguard 3.1 to work with struts 1.1 fowards, has anyone gotten it to work?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-csrfguard%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-csrfguard%5D%20Getting%20csrfguard%203.1%20to%20work%20with%20struts%201.1%0A%20fowards%2C%20has%20anyone%20gotten%20it%20to%20work%3F&In-Reply-To=%3C55C90FBD.7080906%40owasp.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000334.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Owasp-csrfguard] Getting csrfguard 3.1 to work with struts 1.1 fowards, has anyone gotten it to work?</H1>
    <B>Jim Manico</B> 
    <A HREF="mailto:owasp-csrfguard%40lists.owasp.org?Subject=Re%3A%20%5BOwasp-csrfguard%5D%20Getting%20csrfguard%203.1%20to%20work%20with%20struts%201.1%0A%20fowards%2C%20has%20anyone%20gotten%20it%20to%20work%3F&In-Reply-To=%3C55C90FBD.7080906%40owasp.org%3E"
       TITLE="[Owasp-csrfguard] Getting csrfguard 3.1 to work with struts 1.1 fowards, has anyone gotten it to work?">jim.manico at owasp.org
       </A><BR>
    <I>Mon Aug 10 20:55:25 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="000334.html">[Owasp-csrfguard] Getting csrfguard 3.1 to work with struts 1.1 fowards, has anyone gotten it to work?
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#335">[ date ]</a>
              <a href="thread.html#335">[ thread ]</a>
              <a href="subject.html#335">[ subject ]</a>
              <a href="author.html#335">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Struts 1.1 is way past end of life and is no longer being supported in 
any way. The final struts 1.1 release was in _*2008*_. I highly 
recommend you move away from this framework. In a big way. Especially 
when emailing public lists with your work email.

- Jim

On 8/10/15 10:48 AM, [REDACTED] wrote:
&gt;<i>
</I>&gt;<i> Hi Folks,
</I>&gt;<i>
</I>&gt;<i> I did some searching on all the archives for struts before posting, I 
</I>&gt;<i> will search for &#8220;forward&#8221; next
</I>&gt;<i>
</I>&gt;<i> We are trying to add csrfguard 3.1 to a very large, legacy (spaghetti) 
</I>&gt;<i> web app, (actually many, but focusing on 1 for now)
</I>&gt;<i>
</I>&gt;<i> We are using struts 1.1 , weblogic 12.1.3 etc
</I>&gt;<i>
</I>&gt;<i> I&#8217;m able to get happy path for a fairly complex CRUD flow with a combo 
</I>&gt;<i> of unprotected urls, as well as turning off token per page and token 
</I>&gt;<i> rotate properties
</I>&gt;<i>
</I>&gt;<i> , which is in essence, just another session token , OWASP_CSRFTOKEN, 
</I>&gt;<i> which is similar to JSESSIONID and struts token and can be forged is 
</I>&gt;<i> similar matter. We need a per page token or rotating token to
</I>&gt;<i>
</I>&gt;<i> After some careful analysis on (what looks like) the latest and 
</I>&gt;<i> greatest source <A HREF="https://github.com/aramrami/OWASP-CSRFGuard">https://github.com/aramrami/OWASP-CSRFGuard</A>
</I>&gt;<i>
</I>&gt;<i> The problem is with the struts forward and flow is as follows:
</I>&gt;<i>
</I>&gt;<i> 1.Initial request using (wonky javascript) and csrfguard taglib
</I>&gt;<i> openIwin(&quot;createSomeEntityForward.do?&lt;csrf:token 
</I>&gt;<i> uri=&quot;createSomeEntityForward.do&quot;/&gt;&quot;, &quot;Create Organization&quot;);
</I>&gt;<i>
</I>&gt;<i> 2.CSRFGuard Filter (using token per page ) validates/allows the the 
</I>&gt;<i> 1^st request  uri /createSomeEntityForward/
</I>&gt;<i>
</I>&gt;<i> 3.But when Filter intercepts 2nd forwarded path 
</I>&gt;<i> &#8220;//WEB-INF/jsp/&#8230;/createEntity.jsp&quot;//&gt; The token in the request is not 
</I>&gt;<i> found in the csrfguard uri/token map so it checks against the session 
</I>&gt;<i> token which fails
</I>&gt;<i>
</I>&gt;<i> 4.I also tried turning off token per page and turned on token rotate, 
</I>&gt;<i> the session token got updated, but the orig request has the now, stale 
</I>&gt;<i> token
</I>&gt;<i>
</I>&gt;<i> 5.If there was some other normal (non csrf) validation, like a missing 
</I>&gt;<i> field, it would be forwarded to yet another page which would also break
</I>&gt;<i>
</I>&gt;<i> Re-writing the webapp is not an option at this time, nor is upgrading 
</I>&gt;<i> to more modern version of struts
</I>&gt;<i>
</I>&gt;<i> Proposed work-around:
</I>&gt;<i>
</I>&gt;<i> 1.We were thinking of writing our own filter to attached token to each 
</I>&gt;<i> outbound request (and using the csrfguard api), to inject (add NV pair 
</I>&gt;<i> to URL if GET or body if POST) and forgoing javascript injection or 
</I>&gt;<i> csrf taglib, since we have hundreds of complex pages).
</I>&gt;<i>
</I>&gt;<i> 2.When the csrfguard filter now picks up the inbound request, it 
</I>&gt;<i> validates each request, regardless if forward
</I>&gt;<i>
</I>&gt;<i> Another workaround:
</I>&gt;<i>
</I>&gt;<i> 1.Somehow get a handle to the orig request, the .do request, then 
</I>&gt;<i> change the CSRFGuard.verifyPageToken() method to check the URI/Token 
</I>&gt;<i> map for both the forwarded URI (.jsp) OR the orig URI (.do) for a match
</I>&gt;<i>
</I>&gt;<i> We are open to other ideas as well?
</I>&gt;<i>
</I>&gt;<i> Here&#8217;s a snippet of struts-config.xml (names fudged a bit)
</I>&gt;<i>
</I>&gt;<i> &lt;actionpath=/&quot;/createSomeEntityForward&quot;/ 
</I>&gt;<i> input=/&quot;/WEB-INF/jsp/&#8230;/index.jsp&quot;/ scope=/&quot;request&quot;/ 
</I>&gt;<i> type=/&quot;com&#8230;.&#8230;..portal.action.SecurityForwardAction&quot;/ validate=/&quot;false&quot;/&gt;
</I>&gt;<i>
</I>&gt;<i> &lt;forwardname=/&quot;failure&quot;/ path=/&quot;/WEB-INF/jsp/&#8230;/index.jsp&quot;//&gt;
</I>&gt;<i>
</I>&gt;<i> &lt;forwardname=/&quot;success&quot;/ path=/&quot;/WEB-INF/jsp/&#8230;createEntity.jsp&quot;//&gt;
</I>&gt;<i>
</I>&gt;<i> &lt;/action&gt;
</I>&gt;<i>
</I>&gt;<i> These are some of the the relevant session attributes
</I>&gt;<i>
</I>&gt;<i> org.apache.struts.action.TOKEN=d408fea028c0094dd0c8d8f978b3ed51
</I>&gt;<i>
</I>&gt;<i> OWASP_CSRFTOKEN=SDOB-M7W9-CSPP-BRHS-Q1L4-05AG-8XDZ-3KNB
</I>&gt;<i>
</I>&gt;<i> Thanks in advance for your time
</I>&gt;<i>
</I>&gt;<i>[REDACTED]
</I>&gt;<i>
</I>&gt;<i> This e-mail is intended solely for the person or entity to which it is 
</I>&gt;<i> addressed and may contain confidential and/or privileged information. 
</I>&gt;<i> Any review, dissemination, copying, printing or other use of this 
</I>&gt;<i> e-mail by persons or entities other than the addressee is prohibited. 
</I>&gt;<i> If you have received this e-mail in error, please contact the sender 
</I>&gt;<i> immediately and delete the material from any computer.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Owasp-csrfguard mailing list
</I>&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-csrfguard">Owasp-csrfguard at lists.owasp.org</A>
</I>&gt;<i> <A HREF="https://lists.owasp.org/mailman/listinfo/owasp-csrfguard">https://lists.owasp.org/mailman/listinfo/owasp-csrfguard</A>
</I>
-- 
Jim Manico
Global Board Member
OWASP Foundation
<A HREF="https://www.owasp.org">https://www.owasp.org</A>
Join me at AppSecUSA 2015!

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.owasp.org/pipermail/owasp-csrfguard/attachments/20150810/4b9d12c0/attachment-0001.html">http://lists.owasp.org/pipermail/owasp-csrfguard/attachments/20150810/4b9d12c0/attachment-0001.html</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000334.html">[Owasp-csrfguard] Getting csrfguard 3.1 to work with struts 1.1 fowards, has anyone gotten it to work?
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#335">[ date ]</a>
              <a href="thread.html#335">[ thread ]</a>
              <a href="subject.html#335">[ subject ]</a>
              <a href="author.html#335">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.owasp.org/mailman/listinfo/owasp-csrfguard">More information about the Owasp-csrfguard
mailing list</a><br>
</body></html>
