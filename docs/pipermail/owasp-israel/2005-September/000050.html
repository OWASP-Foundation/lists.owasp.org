<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [OWASP-Israel] The IIS 48K request body feature (follow up to Noam's comment)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:owasp-israel%40lists.owasp.org?Subject=%5BOWASP-Israel%5D%20The%20IIS%2048K%20request%20body%20feature%20%28follow%20up%20to%20Noam%27s%20comment%29&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000049.html">
   <LINK REL="Next"  HREF="000051.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[OWASP-Israel] The IIS 48K request body feature (follow up to Noam's comment)</H1>
    <B>Amit Klein (AKsecurity)</B> 
    <A HREF="mailto:owasp-israel%40lists.owasp.org?Subject=%5BOWASP-Israel%5D%20The%20IIS%2048K%20request%20body%20feature%20%28follow%20up%20to%20Noam%27s%20comment%29&In-Reply-To="
       TITLE="[OWASP-Israel] The IIS 48K request body feature (follow up to Noam's comment)">aksecurity at hotpop.com
       </A><BR>
    <I>Thu Sep 22 05:45:24 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000049.html">[OWASP-Israel] 2nd meeting of OWASP IL on September 21st!
</A></li>
        <LI>Next message: <A HREF="000051.html">[OWASP-Israel] Microsoft Israel R&amp;D is seeking to hire a pen-tester
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#50">[ date ]</a>
              <a href="thread.html#50">[ thread ]</a>
              <a href="subject.html#50">[ subject ]</a>
              <a href="author.html#50">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi everybody

Thanks for attending yesterday's OWASP-IL meeting. If you remember, Noam Ben-Yochanan 
commented that IIS/5.x provides with the programmer with a way to consume the request body 
(beyond the 48K usually read), thus disabling the HTTP Request Smuggling caused by this 
anomaly. Today Noam sent me a link that clarifies this (and proves that he was rignt!):

<A HREF="http://support.microsoft.com/default.aspx?scid=kb;en-us;810957">http://support.microsoft.com/default.aspx?scid=kb;en-us;810957</A>

The short story is that IIS reads the body in buffers of 48K (the default value of 
UploadReadAheadSize in the MetaBase registry). It probably always reads the first buffer. 
Now, the HTTP Request Smuggling trick works by sending any Content-Type OTHER THAN 
application/x-www-form-urlencoded. This means that IIS has nobody parsing the data and 
consuming more data, so it stops reading after those 48K, and whatever comes next is 
considered the next request (while MS says it is &quot;by design&quot;, in my opinion this is still a 
bug, and with security implications).

As Noam noted, it is possible to &quot;artificially&quot; consume the data using Request.BinaryRead, 
e.g. something like:

  Dim data
  data = Request.BinaryRead(Request.TotalBytes) 

And by this, restore order.

So a possible solution is to insert the above code in every ASP page.

However, there is a serious downside to this method: if a page accesses Request.BinaryRead, 
it cannot access the Form collection (see the documentation of BinaryRead in 
<A HREF="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/iissdk/html/c84b1f88-1a8a-">http://msdn.microsoft.com/library/default.asp?url=/library/en-us/iissdk/html/c84b1f88-1a8a-</A>
4370-95de-e907f7fdd5e7.asp).

Here's an improved solution. Note that the Content-Type of the request must be anything 
other than application/x-www-form-urlencoded for the attack to work (I understand now that 
this is due to the fact that in application/x-www-form-urlencoded, the IIS ASP.dll consumes 
the request body in fullness). So if a script wants to secure itself, it should check 
whether the Content-Type (accessible via ServerVariables(&quot;HTTP_CONTENT_TYPE&quot;) is 
application/x-www-form-urlencoded.
If it is, then the script can proceed as usual, and access the data through the Form 
collection. If the Content-Type is not &quot;application/x-www-form-urlencoded&quot;, then the script 
should consume the data (as in the above example), and log the event (since this is 
probably an attack). Ideally, the script would terminate the TCP connection, but
I don't know whether a script can terminate the TCP connection in a reliable manner. 
Perhaps sending a &quot;Connection: Close&quot; header can do the trick (or a 400 status code?). 

So the proposed solution would be something like (pardon me for any ASP syntax error):

If (Request.ServerVariables(&quot;HTTP_CONTENT_TYPE&quot;)!=&quot;application/x-www-form-urlencoded&quot;) Then
	' Log a security error condition
	' Consume leftover data
	Dim data
	data = Request.BinaryRead(Request.TotalBytes) 
	' Exit gracefully - do not proceed to normal flow
EndIf

Still, it requires every ASP page to embed this kind of code. I think this makes the 
solution infeasible. Frankly I still call this a bug (be it by design or not) - an ASP page 
should not worry about its content-type or consuming the request body.

Thanks again to Noam!
-Amit



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000049.html">[OWASP-Israel] 2nd meeting of OWASP IL on September 21st!
</A></li>
	<LI>Next message: <A HREF="000051.html">[OWASP-Israel] Microsoft Israel R&amp;D is seeking to hire a pen-tester
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#50">[ date ]</a>
              <a href="thread.html#50">[ thread ]</a>
              <a href="subject.html#50">[ subject ]</a>
              <a href="author.html#50">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.owasp.org/mailman/listinfo/owasp-israel">More information about the Owasp-israel
mailing list</a><br>
</body></html>
